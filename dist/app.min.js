/*
 @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};
$jscomp.polyfill=function(a,b,c,d){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,d):$jscomp.polyfillUnisolated(a,b,c,d))};$jscomp.polyfillUnisolated=function(a,b,c,d){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))return;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,d){var e=a.split(".");a=1===e.length;d=e[0];d=!a&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<e.length-1;f++){var g=e[f];if(!(g in d))return;d=d[g]}e=e[e.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?d[e]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:b}):b!==c&&($jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(e):$jscomp.POLYFILL_PREFIX+e,e=
$jscomp.propertyToPolyfillSymbol[e],$jscomp.defineProperty(d,e,{configurable:!0,writable:!0,value:b})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(a){if(a)return a;var b=function(e,f){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:f})};b.prototype.toString=function(){return this.$jscomp$symbol$id_};var c=0,d=function(e){if(this instanceof d)throw new TypeError("Symbol is not a constructor");return new b("jscomp_symbol_"+(e||"")+"_"+c++,e)};return d},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<b.length;c++){var d=$jscomp.global[b[c]];"function"===typeof d&&"function"!=typeof d.prototype[a]&&$jscomp.defineProperty(d.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return a},"es6",
"es3");$jscomp.iteratorPrototype=function(a){a={next:a};a[Symbol.iterator]=function(){return this};return a};$jscomp.createTemplateTagFirstArg=function(a){return a.raw=a};$jscomp.createTemplateTagFirstArgWithRaw=function(a,b){a.raw=b;return a};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b};
$jscomp.getConstructImplementation=function(){function a(){function c(){}new c;Reflect.construct(c,[],function(){});return new c instanceof c}if($jscomp.TRUST_ES6_POLYFILLS&&"undefined"!=typeof Reflect&&Reflect.construct){if(a())return Reflect.construct;var b=Reflect.construct;return function(c,d,e){c=b(c,d);e&&Reflect.setPrototypeOf(c,e.prototype);return c}}return function(c,d,e){void 0===e&&(e=c);e=$jscomp.objectCreate(e.prototype||Object.prototype);return Function.prototype.apply.call(c,e,d)||
e}};$jscomp.construct={valueOf:$jscomp.getConstructImplementation}.valueOf();$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};$jscomp.setPrototypeOf=$jscomp.TRUST_ES6_POLYFILLS&&"function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;
$jscomp.inherits=function(a,b){a.prototype=$jscomp.objectCreate(b.prototype);a.prototype.constructor=a;if($jscomp.setPrototypeOf){var c=$jscomp.setPrototypeOf;c(a,b)}else for(c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.superClass_=b.prototype};$jscomp.generator={};
$jscomp.generator.ensureIteratorResultIsObject_=function(a){if(!(a instanceof Object))throw new TypeError("Iterator result "+a+" is not an object");};$jscomp.generator.Context=function(){this.isRunning_=!1;this.yieldAllIterator_=null;this.yieldResult=void 0;this.nextAddress=1;this.finallyAddress_=this.catchAddress_=0;this.finallyContexts_=this.abruptCompletion_=null};
$jscomp.generator.Context.prototype.start_=function(){if(this.isRunning_)throw new TypeError("Generator is already running");this.isRunning_=!0};$jscomp.generator.Context.prototype.stop_=function(){this.isRunning_=!1};$jscomp.generator.Context.prototype.jumpToErrorHandler_=function(){this.nextAddress=this.catchAddress_||this.finallyAddress_};$jscomp.generator.Context.prototype.next_=function(a){this.yieldResult=a};
$jscomp.generator.Context.prototype.throw_=function(a){this.abruptCompletion_={exception:a,isException:!0};this.jumpToErrorHandler_()};$jscomp.generator.Context.prototype.return=function(a){this.abruptCompletion_={return:a};this.nextAddress=this.finallyAddress_};$jscomp.generator.Context.prototype.jumpThroughFinallyBlocks=function(a){this.abruptCompletion_={jumpTo:a};this.nextAddress=this.finallyAddress_};$jscomp.generator.Context.prototype.yield=function(a,b){this.nextAddress=b;return{value:a}};
$jscomp.generator.Context.prototype.yieldAll=function(a,b){a=$jscomp.makeIterator(a);var c=a.next();$jscomp.generator.ensureIteratorResultIsObject_(c);if(c.done)this.yieldResult=c.value,this.nextAddress=b;else return this.yieldAllIterator_=a,this.yield(c.value,b)};$jscomp.generator.Context.prototype.jumpTo=function(a){this.nextAddress=a};$jscomp.generator.Context.prototype.jumpToEnd=function(){this.nextAddress=0};
$jscomp.generator.Context.prototype.setCatchFinallyBlocks=function(a,b){this.catchAddress_=a;void 0!=b&&(this.finallyAddress_=b)};$jscomp.generator.Context.prototype.setFinallyBlock=function(a){this.catchAddress_=0;this.finallyAddress_=a||0};$jscomp.generator.Context.prototype.leaveTryBlock=function(a,b){this.nextAddress=a;this.catchAddress_=b||0};
$jscomp.generator.Context.prototype.enterCatchBlock=function(a){this.catchAddress_=a||0;a=this.abruptCompletion_.exception;this.abruptCompletion_=null;return a};$jscomp.generator.Context.prototype.enterFinallyBlock=function(a,b,c){c?this.finallyContexts_[c]=this.abruptCompletion_:this.finallyContexts_=[this.abruptCompletion_];this.catchAddress_=a||0;this.finallyAddress_=b||0};
$jscomp.generator.Context.prototype.leaveFinallyBlock=function(a,b){b=this.finallyContexts_.splice(b||0)[0];if(b=this.abruptCompletion_=this.abruptCompletion_||b){if(b.isException)return this.jumpToErrorHandler_();void 0!=b.jumpTo&&this.finallyAddress_<b.jumpTo?(this.nextAddress=b.jumpTo,this.abruptCompletion_=null):this.nextAddress=this.finallyAddress_}else this.nextAddress=a};$jscomp.generator.Context.prototype.forIn=function(a){return new $jscomp.generator.Context.PropertyIterator(a)};
$jscomp.generator.Context.PropertyIterator=function(a){this.object_=a;this.properties_=[];for(var b in a)this.properties_.push(b);this.properties_.reverse()};$jscomp.generator.Context.PropertyIterator.prototype.getNext=function(){for(;0<this.properties_.length;){var a=this.properties_.pop();if(a in this.object_)return a}return null};$jscomp.generator.Engine_=function(a){this.context_=new $jscomp.generator.Context;this.program_=a};
$jscomp.generator.Engine_.prototype.next_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_.next,a,this.context_.next_);this.context_.next_(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.return_=function(a){this.context_.start_();var b=this.context_.yieldAllIterator_;if(b)return this.yieldAllStep_("return"in b?b["return"]:function(c){return{value:c,done:!0}},a,this.context_.return);this.context_.return(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.throw_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_["throw"],a,this.context_.next_);this.context_.throw_(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.yieldAllStep_=function(a,b,c){try{var d=a.call(this.context_.yieldAllIterator_,b);$jscomp.generator.ensureIteratorResultIsObject_(d);if(!d.done)return this.context_.stop_(),d;var e=d.value}catch(f){return this.context_.yieldAllIterator_=null,this.context_.throw_(f),this.nextStep_()}this.context_.yieldAllIterator_=null;c.call(this.context_,e);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.nextStep_=function(){for(;this.context_.nextAddress;)try{var a=this.program_(this.context_);if(a)return this.context_.stop_(),{value:a.value,done:!1}}catch(b){this.context_.yieldResult=void 0,this.context_.throw_(b)}this.context_.stop_();if(this.context_.abruptCompletion_){a=this.context_.abruptCompletion_;this.context_.abruptCompletion_=null;if(a.isException)throw a.exception;return{value:a.return,done:!0}}return{value:void 0,done:!0}};
$jscomp.generator.Generator_=function(a){this.next=function(b){return a.next_(b)};this.throw=function(b){return a.throw_(b)};this.return=function(b){return a.return_(b)};this[Symbol.iterator]=function(){return this}};$jscomp.generator.createGenerator=function(a,b){b=new $jscomp.generator.Generator_(new $jscomp.generator.Engine_(b));$jscomp.setPrototypeOf&&a.prototype&&$jscomp.setPrototypeOf(b,a.prototype);return b};
$jscomp.asyncExecutePromiseGenerator=function(a){function b(d){return a.next(d)}function c(d){return a.throw(d)}return new Promise(function(d,e){function f(g){g.done?d(g.value):Promise.resolve(g.value).then(b,c).then(f,e)}f(a.next())})};$jscomp.asyncExecutePromiseGeneratorFunction=function(a){return $jscomp.asyncExecutePromiseGenerator(a())};$jscomp.asyncExecutePromiseGeneratorProgram=function(a){return $jscomp.asyncExecutePromiseGenerator(new $jscomp.generator.Generator_(new $jscomp.generator.Engine_(a)))};
$jscomp.polyfill("Reflect",function(a){return a?a:{}},"es6","es3");$jscomp.polyfill("Reflect.construct",function(a){return $jscomp.construct},"es6","es3");$jscomp.polyfill("Reflect.setPrototypeOf",function(a){if(a)return a;if($jscomp.setPrototypeOf){var b=$jscomp.setPrototypeOf;return function(c,d){try{return b(c,d),!0}catch(e){return!1}}}return null},"es6","es5");
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function c(g){return g instanceof e?g:new e(function(h,k){h(g)})}if(a&&(!($jscomp.FORCE_POLYFILL_PROMISE||$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION&&"undefined"===typeof $jscomp.global.PromiseRejectionEvent)||!$jscomp.global.Promise||-1===$jscomp.global.Promise.toString().indexOf("[native code]")))return a;b.prototype.asyncExecute=function(g){if(null==this.batch_){this.batch_=[];var h=this;this.asyncExecuteFunction(function(){h.executeBatch_()})}this.batch_.push(g)};
var d=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(g){d(g,0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var g=this.batch_;this.batch_=[];for(var h=0;h<g.length;++h){var k=g[h];g[h]=null;try{k()}catch(l){this.asyncThrow_(l)}}}this.batch_=null};b.prototype.asyncThrow_=function(g){this.asyncExecuteFunction(function(){throw g;})};var e=function(g){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];this.isRejectionHandled_=!1;var h=this.createResolveAndReject_();
try{g(h.resolve,h.reject)}catch(k){h.reject(k)}};e.prototype.createResolveAndReject_=function(){function g(l){return function(m){k||(k=!0,l.call(h,m))}}var h=this,k=!1;return{resolve:g(this.resolveTo_),reject:g(this.reject_)}};e.prototype.resolveTo_=function(g){if(g===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(g instanceof e)this.settleSameAsPromise_(g);else{a:switch(typeof g){case "object":var h=null!=g;break a;case "function":h=!0;break a;default:h=!1}h?this.resolveToNonPromiseObj_(g):
this.fulfill_(g)}};e.prototype.resolveToNonPromiseObj_=function(g){var h=void 0;try{h=g.then}catch(k){this.reject_(k);return}"function"==typeof h?this.settleSameAsThenable_(h,g):this.fulfill_(g)};e.prototype.reject_=function(g){this.settle_(2,g)};e.prototype.fulfill_=function(g){this.settle_(1,g)};e.prototype.settle_=function(g,h){if(0!=this.state_)throw Error("Cannot settle("+g+", "+h+"): Promise already settled in state"+this.state_);this.state_=g;this.result_=h;2===this.state_&&this.scheduleUnhandledRejectionCheck_();
this.executeOnSettledCallbacks_()};e.prototype.scheduleUnhandledRejectionCheck_=function(){var g=this;d(function(){if(g.notifyUnhandledRejection_()){var h=$jscomp.global.console;"undefined"!==typeof h&&h.error(g.result_)}},1)};e.prototype.notifyUnhandledRejection_=function(){if(this.isRejectionHandled_)return!1;var g=$jscomp.global.CustomEvent,h=$jscomp.global.Event,k=$jscomp.global.dispatchEvent;if("undefined"===typeof k)return!0;"function"===typeof g?g=new g("unhandledrejection",{cancelable:!0}):
"function"===typeof h?g=new h("unhandledrejection",{cancelable:!0}):(g=$jscomp.global.document.createEvent("CustomEvent"),g.initCustomEvent("unhandledrejection",!1,!0,g));g.promise=this;g.reason=this.result_;return k(g)};e.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var g=0;g<this.onSettledCallbacks_.length;++g)f.asyncExecute(this.onSettledCallbacks_[g]);this.onSettledCallbacks_=null}};var f=new b;e.prototype.settleSameAsPromise_=function(g){var h=this.createResolveAndReject_();
g.callWhenSettled_(h.resolve,h.reject)};e.prototype.settleSameAsThenable_=function(g,h){var k=this.createResolveAndReject_();try{g.call(h,k.resolve,k.reject)}catch(l){k.reject(l)}};e.prototype.then=function(g,h){function k(q,p){return"function"==typeof q?function(t){try{l(q(t))}catch(r){m(r)}}:p}var l,m,n=new e(function(q,p){l=q;m=p});this.callWhenSettled_(k(g,l),k(h,m));return n};e.prototype.catch=function(g){return this.then(void 0,g)};e.prototype.callWhenSettled_=function(g,h){function k(){switch(l.state_){case 1:g(l.result_);
break;case 2:h(l.result_);break;default:throw Error("Unexpected state: "+l.state_);}}var l=this;null==this.onSettledCallbacks_?f.asyncExecute(k):this.onSettledCallbacks_.push(k);this.isRejectionHandled_=!0};e.resolve=c;e.reject=function(g){return new e(function(h,k){k(g)})};e.race=function(g){return new e(function(h,k){for(var l=$jscomp.makeIterator(g),m=l.next();!m.done;m=l.next())c(m.value).callWhenSettled_(h,k)})};e.all=function(g){var h=$jscomp.makeIterator(g),k=h.next();return k.done?c([]):new e(function(l,
m){function n(t){return function(r){q[t]=r;p--;0==p&&l(q)}}var q=[],p=0;do q.push(void 0),p++,c(k.value).callWhenSettled_(n(q.length-1),m),k=h.next();while(!k.done)})};return e},"es6","es3");$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.findIndex",function(a){return a?a:function(b,c){return $jscomp.findInternal(this,b,c).i}},"es6","es3");
$jscomp.polyfill("Array.from",function(a){return a?a:function(b,c,d){c=null!=c?c:function(h){return h};var e=[],f="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];if("function"==typeof f){b=f.call(b);for(var g=0;!(f=b.next()).done;)e.push(c.call(d,f.value,g++))}else for(f=b.length,g=0;g<f;g++)e.push(c.call(d,b[g],g));return e}},"es6","es3");
$jscomp.polyfill("Promise.allSettled",function(a){function b(d){return{status:"fulfilled",value:d}}function c(d){return{status:"rejected",reason:d}}return a?a:function(d){var e=this;d=Array.from(d,function(f){return e.resolve(f).then(b,c)});return e.all(d)}},"es_2020","es3");$jscomp.polyfill("Object.is",function(a){return a?a:function(b,c){return b===c?0!==b||1/b===1/c:b!==b&&c!==c}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(b,c){var d=this;d instanceof String&&(d=String(d));var e=d.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=d[c];if(f===b||Object.is(f,b))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(b,c){return-1!==$jscomp.checkStringArgs(this,b,"includes").indexOf(b,c||0)}},"es6","es3");
$jscomp.polyfill("Array.prototype.flat",function(a){return a?a:function(b){b=void 0===b?1:b;for(var c=[],d=0;d<this.length;d++){var e=this[d];Array.isArray(e)&&0<b?(e=Array.prototype.flat.call(e,b-1),c.push.apply(c,e)):c.push(e)}return c}},"es9","es5");$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(b,c){return $jscomp.findInternal(this,b,c).v}},"es6","es3");
$jscomp.polyfill("String.prototype.startsWith",function(a){return a?a:function(b,c){var d=$jscomp.checkStringArgs(this,b,"startsWith");b+="";var e=d.length,f=b.length;c=Math.max(0,Math.min(c|0,d.length));for(var g=0;g<f&&c<e;)if(d[c++]!=b[g++])return!1;return g>=f}},"es6","es3");
$jscomp.iteratorFromArray=function(a,b){a instanceof String&&(a+="");var c=0,d=!1,e={next:function(){if(!d&&c<a.length){var f=c++;return{value:b(f,a[f]),done:!1}}d=!0;return{done:!0,value:void 0}}};e[Symbol.iterator]=function(){return e};return e};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");
$jscomp.polyfill("Array.prototype.fill",function(a){return a?a:function(b,c,d){var e=this.length||0;0>c&&(c=Math.max(0,e+c));if(null==d||d>e)d=e;d=Number(d);0>d&&(d=Math.max(0,e+d));for(c=Number(c||0);c<d;c++)this[c]=b;return this}},"es6","es3");$jscomp.typedArrayFill=function(a){return a?a:Array.prototype.fill};$jscomp.polyfill("Int8Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Uint8Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");
$jscomp.polyfill("Uint8ClampedArray.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Int16Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Uint16Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Int32Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Uint32Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Float32Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");
$jscomp.polyfill("Float64Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Array.prototype.flatMap",function(a){return a?a:function(b,c){for(var d=[],e=0;e<this.length;e++){var f=b.call(c,this[e],e,this);Array.isArray(f)?d.push.apply(d,f):d.push(f)}return d}},"es9","es5");$jscomp.polyfill("String.prototype.trimLeft",function(a){function b(){return this.replace(/^[\s\xa0]+/,"")}return a||b},"es_2019","es3");
$jscomp.polyfill("Math.log10",function(a){return a?a:function(b){return Math.log(b)/Math.LN10}},"es6","es3");$jscomp.polyfill("Math.log2",function(a){return a?a:function(b){return Math.log(b)/Math.LN2}},"es6","es3");$jscomp.polyfill("Math.sign",function(a){return a?a:function(b){b=Number(b);return 0===b||isNaN(b)?b:0<b?1:-1}},"es6","es3");
$jscomp.polyfill("Math.hypot",function(a){return a?a:function(b){if(2>arguments.length)return arguments.length?Math.abs(arguments[0]):0;var c,d,e;for(c=e=0;c<arguments.length;c++)e=Math.max(e,Math.abs(arguments[c]));if(1E100<e||1E-100>e){if(!e)return e;for(c=d=0;c<arguments.length;c++){var f=Number(arguments[c])/e;d+=f*f}return Math.sqrt(d)*e}for(c=d=0;c<arguments.length;c++)f=Number(arguments[c]),d+=f*f;return Math.sqrt(d)}},"es6","es3");
$jscomp.polyfill("String.prototype.repeat",function(a){return a?a:function(b){var c=$jscomp.checkStringArgs(this,null,"repeat");if(0>b||1342177279<b)throw new RangeError("Invalid count value");b|=0;for(var d="";b;)if(b&1&&(d+=c),b>>>=1)c+=c;return d}},"es6","es3");$jscomp.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};$jscomp.polyfill("Object.entries",function(a){return a?a:function(b){var c=[],d;for(d in b)$jscomp.owns(b,d)&&c.push([d,b[d]]);return c}},"es8","es3");
var LOGO_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFUAAAAYCAYAAACLM7HoAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5AgMEyUWOeB/0gAACLlJREFUWMPt2X+wXVV1B/DPOve+H0kTIRAwEMTyU4HXaXGwQxsqooCGmSq1gxRaKzJMq20damNL6bROlc6g+IPpOKUKGEqcUoogIJ1qaVLSaKIoMhYMkR8asBIJCSG/Hi/Jffes/rH3zXuJicMMndGZsN7cee+ds8/ee33Xd631Pfvysv2/W+x94Zbz5+538MV3bXzRYw5k6/6Ue7+EX8ZX8RT7BPN4nIFH8Q3kz9qhnwfbH6in4HMKk9+FazBhitk7sR7/iIMwikvxwM/aoZ8H2x+ox2KWAtpf4xMKkBRgn8G1OBKLFeBf5WVQsVdNnZbeh+CTeD3uwafRk7ufmMQ4FimAzsFCfId919WzL135k6sPisW0XfS17lv8Gy/ZsX2uh8wkQjM5IbszfmIzSxef8ZLX3h9TX18B+ht9z+RRzWTzX7u0F80YNTt6cX+vb1fCx3ArPoN3DkC95fy5ewD7pktWDP7sYJjcSbRtpGiINoaRQS9/SlneF1BLFy/Y9+AyTQgjaOrVdnzD+h2zDp83HdCDcDS+h95LRtQ0jkxj6ZG4C7cZiU/kWLfxQr4ZF2IebsDdsWZy+jzn4u9xCe5nT7aec+kqFazfw3uV0nGHTBgWcTW+iX/tRc+wEdn2iSky544tmtGDKc3xNPJOaWdqzZx5vImJH1R3UputJjoqWNdiBvoV3LV1r4/XqS8o+853SuM0UiuCQurQ70267/NnvmhQu3sBCn+EbdLn8tRux5a8QmHhA3hYaVAuvmvj9OeWYQU+iN9Xmtpua7Ov7U9Gpzt8Nk7FBZl5d0RMKqXmLfgaDLVdGa2234+m2+k20elltmJ0zoB+b8W5Mm8TjdCYmFgrs42IzlBmTjbRaevSJ+NX6r7W43B8BMOTk70/7HaHst5f/+5zFoz/070rRaQFxy+w6vGVQ8MzZ/R6Ezt0hocsfM/9elGIFNHUoO+pSAdZ090L0NPx27jc3OZ5W/KCCugX8UalgX0D/vnKeS6++pkBsP0a/c/gBDw0fd7FETrdodk4DjfhtIg4prLl1TW4j9bhHby16XbPx9zM9gmlpv8Q51W2D4vmI1gt3SGcF9F5Gw6OaF7ALfh3RcU8mdneE9FMVia/HQd1mkZmdiLitVh183+uMjIyateunWesemLVRSKO6E3s+F/8g8zHetEbJS7Bw5ntygroG3GytETYPvB3UGuOx4dxHZbbmktzXjOqNKFlNb1XVTadgMMGwOZJXXliVx7WPII/UOrxB+uc1QIxD4fiTjyLN9Sbr8UWrIsIIi5TFMe3FVl3Iq6S7RBeqMz+Gh7BWhHn4c+xsgb1q+hHNDCG7RHNSYWR+e5KjJuj6WREzMF8rIZdu3a+DZ/Ck0qZOwTXkq+I6OzAK/G3MmdVQD+KTdm247WU7U7/Dv5KqT8tnnV0p9U6oqbLGmzFMH61PjOCL2MXDtdxf2zJ8cqMRXgOv47fnVYKjquMXl0dP7vf27G4MzQ6hieHhkY293o7T8Yf40Nt237pkf9+sh0769gX8EkRh+KxupfP41t13mvwXGbeHhFbBo5ltrNqYA/Dx+ueT8SSzLw3CtOOqtcfJw8l/gI3EtfXUvMjfIE4JrP9H1yPs0VchdfhuqZpbu3nns21W2k0s7JlCF1twnYsUd6mvoU3K/q0qRu9Ek9gAd5lxLhd5mEzHsRpNRADUMfw48x8LiKW48LO0Ohr8Bo80OvtVNc4Ahc2TfOOsbOOhYPr3nbVObI6O7B/wxkRcY9S928lvkm+su7zCtxXfV2ID0fEF+oeT8RWmetEvKHi8KVpL4Z9RRH06/8/xr01qz8QTbOk3y+3lt40JcW6iua8Bh+oTLjFluQoG6Trpm1+dd1gt6bvghJhO7HJLqrjxyka9lpsWTrrSjte2G505qwxPBpN08tsHwnxHH6zpt9N09i8FH9XM0gFcTwiNmXmGJ7JzI2FaAEryPOJ19XMuJ5ciF+szz9U2U1RJkM1AweBXiuaCXJ+IVJuLXo8KK/pW/B0HX86zsH3MSszkfaWgYOa+qBSPz+GvxSOiUcmNbfvmD52DW6uzr4dy3Em7vZ8u83OnI/LcLXSUG6Hp4ZPNzpj1uyait+VKTTjBQzvwWxT8uZZzCM3iHgos/0uNmRaVxxwNLYHXaKLuTgyMzcQX8EdBekMpRRtqqAMk3Oqj5uxpm3bwEmFLDlg4Vzi1U1nmFLr34vb8LyiWj6ulJ4/xe/IHIto1Pq9B1On23qlmfwJFuUpXbFmUp60e1iLDTVSZ+FxYUmeOyKWTLy/OnCTaSK6Euqwmlqrp8hnKS6vcw2YcGsJVNwh8/sRzSh6Ea7AOnwdC0V8UWl423F5RPODoiq9Cp+e2Pb8uhmzDzmhBmFxWTB+oS68iHiqaZo5NSgP17VXVibf0La9tYoqWZGZ10fE8ZUsd2a/f6Om6UbEhbgss/0zEQMJN+Uze2jVNykq4BJVPmEA7G/VKKXy+npDPN3famueiRvxvgrWbvFf34JmT7HCeAV1hDgVEzIfTtmWiOdc4jSl827CGpk/VFDrRMQJSoN5inyOGFPq8CRWT7a9RxudbJrmFKVbD3zcTD5BbCnrx4hyEvcotlUvZxO/prx2P5aZD0VEv643P+WDQa9OOR9HpPwOJpct3rOm7m3LlcK+qKbn9t3wp+UVmI0mbYr1fTYnjRMUbXiffds25Y1peix3Tg9a1J9kI74y/eHBkUOUhvG9+hnYiuljO01Xlka7eiozpqyJRpvtYP29D4C2KY1oT8aVxvijvQ6fnzaVYXvY/g5UxhQmrlVkxG1Sa3YwGuxIxpP0DlxUAfus2hAO9IPq/Z38L1DAXKaUg/fV34ea0hujOBv/oQjh92PZgQ4o+z+l6imAH6LIpMl6bcIUqG299gpFEUx62bB/UL+NqxTJ9CGl6359H+O+rDSvj+7n/gFp+wO1j3+pn922jy/+7jWtsL9sxWJfF/f1benetfLFjDlQ7f8ADW9Ok5ZiUfUAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTktMDktMDZUMjA6NDc6MTYrMDA6MDBF0XDEAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE5LTA5LTA2VDIwOjQ3OjE2KzAwOjAwNIzIeAAAAABJRU5ErkJggg==";
"use strict";
var utils={requestPromise:function(a,b){return new Promise(function(c,d){b&&a.setRequestHeader("Content-Type","application/json; charset=utf-8");a.send(JSON.stringify(b));a.onreadystatechange=function(){if(4===a.readyState)if(200<=a.status&&300>a.status)c(a);else{var e=Error(a.statusText||"Unsuccessful Xhr response");e.request=a;d(e)}}})},memoize:function(a){var b={};return function(){var c=JSON.stringify(arguments);if(b[c])return b[c];var d=a.apply(null,arguments);return b[c]=d}},getUrlSync:function(a){a=ensureFullUrl(a);
var b=new XMLHttpRequest;b.open("GET",a,!1);b.send();if(200===b.status)return b.responseText;throw Error("unable to retrieve "+a);}};utils.getUrlSyncCached=utils.memoize(utils.getUrlSync);utils.defer=function(){var a={};a.promise=new Promise(function(b,c){a.resolve=b;a.reject=c});return a};utils.sleep=function(a){a=void 0===a?0:a;return new Promise(function(b){return setTimeout(b,a)})};
if("undefined"===typeof Map){var Map=function(){this._content={};this.size=0};Map.prototype.set=function(a,b){this._content.hasOwnProperty(a)||this.size++;this._content[a]=b};Map.prototype.get=function(a){return this._content[a]};Map.prototype.delete=function(a){this._content.hasOwnProperty(a)&&this.size--;delete this._content[a]}}Date.now||(Date.now=function(){return(new Date).getTime()});
!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b():"function"==typeof define&&define.amd?define(b):b()}(0,function(){function a(){}function b(m){if(!(this instanceof b))throw new TypeError("Promises must be constructed via new");if("function"!=typeof m)throw new TypeError("not a function");this._state=0;this._handled=!1;this._value=void 0;this._deferreds=[];g(m,this)}function c(m,n){for(;3===m._state;)m=m._value;0!==m._state?(m._handled=!0,b._immediateFn(function(){var q=1===
m._state?n.onFulfilled:n.onRejected;if(null!==q){try{var p=q(m._value)}catch(t){return void e(n.promise,t)}d(n.promise,p)}else(1===m._state?d:e)(n.promise,m._value)})):m._deferreds.push(n)}function d(m,n){try{if(n===m)throw new TypeError("A promise cannot be resolved with itself.");if(n&&("object"==typeof n||"function"==typeof n)){var q=n.then;if(n instanceof b)return m._state=3,m._value=n,void f(m);if("function"==typeof q)return void g(function(p,t){return function(){p.apply(t,arguments)}}(q,n),
m)}m._state=1;m._value=n;f(m)}catch(p){e(m,p)}}function e(m,n){m._state=2;m._value=n;f(m)}function f(m){2===m._state&&0===m._deferreds.length&&b._immediateFn(function(){m._handled||b._unhandledRejectionFn(m._value)});for(var n=0,q=m._deferreds.length;q>n;n++)c(m,m._deferreds[n]);m._deferreds=null}function g(m,n){var q=!1;try{m(function(p){q||(q=!0,d(n,p))},function(p){q||(q=!0,e(n,p))})}catch(p){q||(q=!0,e(n,p))}}var h=function(m){var n=this.constructor;return this.then(function(q){return n.resolve(m()).then(function(){return q})},
function(q){return n.resolve(m()).then(function(){return n.reject(q)})})},k=setTimeout;b.prototype["catch"]=function(m){return this.then(null,m)};b.prototype.then=function(m,n){var q=new this.constructor(a);return c(this,new function(p,t,r){this.onFulfilled="function"==typeof p?p:null;this.onRejected="function"==typeof t?t:null;this.promise=r}(m,n,q)),q};b.prototype["finally"]=h;b.all=function(m){return new b(function(n,q){function p(v,w){try{if(w&&("object"==typeof w||"function"==typeof w)){var x=
w.then;if("function"==typeof x)return void x.call(w,function(y){p(v,y)},q)}t[v]=w;0==--r&&n(t)}catch(y){q(y)}}if(!m||"undefined"==typeof m.length)throw new TypeError("Promise.all accepts an array");var t=Array.prototype.slice.call(m);if(0===t.length)return n([]);for(var r=t.length,u=0;t.length>u;u++)p(u,t[u])})};b.resolve=function(m){return m&&"object"==typeof m&&m.constructor===b?m:new b(function(n){n(m)})};b.reject=function(m){return new b(function(n,q){q(m)})};b.race=function(m){return new b(function(n,
q){for(var p=0,t=m.length;t>p;p++)m[p].then(n,q)})};b._immediateFn="function"==typeof setImmediate&&function(m){setImmediate(m)}||function(m){k(m,0)};b._unhandledRejectionFn=function(m){void 0!==console&&console&&console.warn("Possible Unhandled Promise Rejection:",m)};var l=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("unable to locate global object");}();l.Promise?l.Promise.prototype["finally"]||
(l.Promise.prototype["finally"]=h):l.Promise=b});function ServicesRegistry(a){this.setServicesHosts(a)}ServicesRegistry.prototype.reset=function(){this.defaultHost=DEFAULT_SERVICES_HOST;this.auxServicesHosts=[]};ServicesRegistry.prototype.onInvalidHosts=function(a){console.error("Invalid services hosts detected:",a)};
ServicesRegistry.prototype.fetchHosts=function(){var a=this;return fetch(SERVER_URL+"/api/v2/services-hosts/all/").then(function(b){return b.json()}).then(function(b){return a.setServicesHosts(b)}).catch(function(b){console.error("Unable to fetch hosts: "+b);a.reset()})};
ServicesRegistry.prototype.setServicesHosts=function(a){var b=a.findIndex(function(c){return 0===c.categories.length});-1<b?this.defaultHost=a.splice(b,1).pop():this.defaultHost||(console.error("No default services host found for",a),this.defaultHost=a.splice(0,1).pop());this.auxServicesHosts=a;this.validateHosts()};
ServicesRegistry.prototype.validateHosts=function(){var a=this,b=this,c=[],d=this.allHosts().map(function(e){return fetch(e.url).then(function(f){return f.json()}).catch(function(){return c.push(e)})});Promise.allSettled(d).then(function(){var e=a.allHosts().map(function(g){return g.url}),f=c.filter(function(g){return e.includes(g.url)});if(f.length)b.onInvalidHosts(f)})};ServicesRegistry.prototype.allHosts=function(){return[this.defaultHost].concat(this.auxServicesHosts)};
ServicesRegistry.prototype.getServiceURL=function(a){var b=this,c,d,e,f,g;return $jscomp.asyncExecutePromiseGeneratorProgram(function(h){if(1==h.nextAddress)return c=[],d=b.auxServicesHosts.map(function(k){var l,m,n,q;return $jscomp.asyncExecutePromiseGeneratorProgram(function(p){switch(p.nextAddress){case 1:return l=k,m=l.url,p.setCatchFinallyBlocks(2),p.yield(fetch(m),4);case 4:return n=p.yieldResult,p.yield(n.json(),5);case 5:return q=p.yieldResult.map(function(t){return t.name}),p.return(q.includes(a));
case 2:p.enterCatchBlock(),c.push(m),p.jumpToEnd()}})}),h.yield(Promise.all(d),2);e=h.yieldResult.findIndex(function(k){return k});c.length&&(f='Could not fetch service metadata from "'+c.join(",")+'"',console.error(f));g=-1<e?b.auxServicesHosts[e].url:b.defaultHost.url;return h.return(g+"/"+a)})};ServicesRegistry.prototype.getServiceMetadataFromURLSync=function(a){return JSON.parse(utils.getUrlSync(a))};
ServicesRegistry.prototype.getServiceMetadataFromURL=function(a){var b;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){return 1==c.nextAddress?c.yield(fetch(a),2):3!=c.nextAddress?(b=c.yieldResult,c.yield(b.json(),3)):c.return(c.yieldResult)})};ServicesRegistry.prototype.getServiceMetadata=function(a){var b=this,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){if(1==d.nextAddress)return d.yield(b.getServiceURL(a),2);c=d.yieldResult;return d.return(b.getServiceMetadataFromURL(c))})};
ServicesRegistry.prototype.getServicesMetadata=function(){var a=this,b,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){if(1==d.nextAddress)return b=a.allHosts().map(function(e){var f,g,h,k,l;return $jscomp.asyncExecutePromiseGeneratorProgram(function(m){switch(m.nextAddress){case 1:return f=e,g=f.url,h=f.categories,m.setCatchFinallyBlocks(2),m.yield(fetch(g),4);case 4:return k=m.yieldResult,m.yield(k.json(),5);case 5:return l=m.yieldResult,e!==a.defaultHost&&l.forEach(function(n){return n.url=
g}),h.length&&l.forEach(function(n){0===n.categories.length&&n.categories.push([]);n.categories.map(function(q){return q.unshift(h)})}),m.return(l);case 2:return m.enterCatchBlock(),console.error("Unable to fetch services metadata for "+h+": "+g),m.return([])}})}),d.yield(Promise.all(b),2);c=d.yieldResult.flat();return d.return(c)})};ServicesRegistry.prototype.isRegisteredServiceURL=function(a){return!!this.allHosts().find(function(b){return a.startsWith(b.url)})};
var Services=new ServicesRegistry(SERVICES_HOSTS),morphicVersion="2020-July-23",modules={},useBlurredShadows=!0,ZERO=new Point,BLACK=new Color,WHITE=new Color(255,255,255),CLEAR=new Color(0,0,0,0);Object.freeze(ZERO);Object.freeze(BLACK);Object.freeze(WHITE);
var standardSettings={minimumFontHeight:getMinimumFontHeight(),globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:12,mouseScrollAmount:40,useSliderForInput:!1,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5,showHoles:!1},touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:24,
bubbleHelpFontSize:18,prompterFontName:"sans-serif",prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useSliderForInput:!1,isTouchDevice:!0,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5,showHoles:!1},MorphicPreferences=standardSettings;enableRetinaSupport();function nop(){return null}function localize(a){return a}function isNil(a){return void 0===a||null===a}function contains(a,b){return-1!==a.indexOf(b)}
function detect(a,b){var c,d=a.length;for(c=0;c<d;c+=1)if(b.call(null,a[c]))return a[c];return null}function sizeOf(a){var b=0,c;for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b+=1);return b}function isString(a){return"string"===typeof a||a instanceof String}function isObject(a){return null!==a&&("object"===typeof a||a instanceof Object)}function radians(a){return a*Math.PI/180}function degrees(a){return 180*a/Math.PI}
function fontHeight(a){return 1.2*Math.max(a,MorphicPreferences.minimumFontHeight)}function isWordChar(a){return a.match(/[A-z\u00c0-\u00ff0-9]/)}function isURLChar(a){return a.match(/[A-z0-9./:?&_+%-]/)}function isURL(a){return/^https?:\/\//.test(a)}
function newCanvas(a,b,c){b=b||!1;a=(a||(c?new Point(c.width,c.height):new Point(0,0))).ceil();if(c&&!c.dataset.morphicShare&&(c.isRetinaEnabled||!1)!==b&&a.x===c.width&&a.y===c.height)return c.getContext("2d").clearRect(0,0,c.width,c.height),c;c=document.createElement("canvas");c.width=a.x;c.height=a.y;b&&c.isRetinaEnabled&&(c.isRetinaEnabled=!1);return c}
function copyCanvas(a){if(a&&a.width&&a.height){var b=newCanvas(new Point(a.width,a.height),!a.isRetinaEnabled);b.getContext("2d").drawImage(a,0,0);return b}return a}
function getMinimumFontHeight(){var a=document.createElement("canvas"),b,c;a.width=50;a.height=50;a=a.getContext("2d");a.font="1px serif";var d=a.measureText("I").width;a.fillStyle="black";a.textBaseline="bottom";a.fillText("I",0,50);for(c=0;50>c;c+=1)for(b=0;b<d;b+=1){var e=a.getImageData(b,c,1,1);if(0!==e.data[3])return 50-c+1}return 0}
function getDocumentPositionOf(a){a=a.getBoundingClientRect();return{x:a.left+(window.pageXOffset||document.documentElement.scrollLeft),y:a.top+(window.pageYOffset||document.documentElement.scrollTop)}}
function copy(a){var b;if("object"!==typeof a)return a;var c=a.valueOf();if(a!==c)return new a.constructor(c);if(a instanceof a.constructor&&a.constructor!==Object){c=Object.create(a.constructor.prototype);var d=Object.keys(a);var e=d.length;for(b=0;b<e;b+=1){var f=d[b];a[f]instanceof HTMLCanvasElement&&(a[f].dataset.morphicShare="true");c[f]=a[f]}}else for(f in c={},a)c[f]=a[f];return c}
function enableRetinaSupport(){function a(g){return g.isRetinaEnabled?(d||1)/c:1}var b=document.createElement("canvas").getContext("2d"),c=b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1,d=Math.ceil(window.devicePixelRatio);b=HTMLCanvasElement.prototype;var e=CanvasRenderingContext2D.prototype,f={drawImage:e.drawImage,getImageData:e.getImageData,width:Object.getOwnPropertyDescriptor(b,"width"),height:Object.getOwnPropertyDescriptor(b,
"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(e,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(e,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(e,"shadowBlur")};c===d||Object.keys(f).some(function(g){g=f[g];return g.hasOwnProperty("configurable")&&!g.configurable})||(b._isRetinaEnabled=!0,b._bak=f,Object.defineProperty(b,"isRetinaEnabled",{get:function(){return this._isRetinaEnabled},set:function(g){var h=a(this),k=this.width,l=this.height;this._isRetinaEnabled=
g;a(this)!=h&&(this.width=k,this.height=l)},configurable:!0}),Object.defineProperty(b,"width",{get:function(){return f.width.get.call(this)/a(this)},set:function(g){try{var h=a(this);f.width.set.call(this,g*h);this.getContext("2d").scale(h,h)}catch(k){console.log("Retina Display Support Problem",k),f.width.set.call(this,g)}}}),Object.defineProperty(b,"height",{get:function(){return f.height.get.call(this)/a(this)},set:function(g){var h=a(this);f.height.set.call(this,g*h);this.getContext("2d").scale(h,
h)}}),e.drawImage=function(g){var h=a(g);switch(arguments.length){case 9:var k=arguments[1];var l=arguments[2];var m=arguments[3];var n=arguments[4];var q=arguments[5];var p=arguments[6];var t=arguments[7];var r=arguments[8];break;case 5:l=k=0;m=g.width;n=g.height;q=arguments[1];p=arguments[2];t=arguments[3];r=arguments[4];break;case 3:l=k=0;m=g.width;n=g.height;q=arguments[1];p=arguments[2];t=g.width;r=g.height;break;default:throw Error("Called drawImage() with "+arguments.length+" arguments");}f.drawImage.call(this,
g,k*h,l*h,m*h,n*h,q,p,t,r)},e.getImageData=function(g,h,k,l){var m=a(this.canvas);return f.getImageData.call(this,g*m,h*m,k*m,l*m)},Object.defineProperty(e,"shadowOffsetX",{get:function(){return f.shadowOffsetX.get.call(this)/a(this.canvas)},set:function(g){var h=a(this.canvas);f.shadowOffsetX.set.call(this,g*h)}}),Object.defineProperty(e,"shadowOffsetY",{get:function(){return f.shadowOffsetY.get.call(this)/a(this.canvas)},set:function(g){var h=a(this.canvas);f.shadowOffsetY.set.call(this,g*h)}}),
Object.defineProperty(e,"shadowBlur",{get:function(){return f.shadowBlur.get.call(this)/a(this.canvas)},set:function(g){var h=a(this.canvas);f.shadowBlur.set.call(this,g*h)}}))}
function isRetinaSupported(){var a=document.createElement("canvas").getContext("2d");a=a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1;var b=HTMLCanvasElement.prototype,c=CanvasRenderingContext2D.prototype,d={drawImage:c.drawImage,getImageData:c.getImageData,width:Object.getOwnPropertyDescriptor(b,"width"),height:Object.getOwnPropertyDescriptor(b,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(c,
"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(c,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(c,"shadowBlur")};return a!==window.devicePixelRatio&&!Object.keys(d).some(function(e){e=d[e];return e.hasOwnProperty("configurable")&&!e.configurable})}function isRetinaEnabled(){return HTMLCanvasElement.prototype.hasOwnProperty("_isRetinaEnabled")}
function disableRetinaSupport(){if(isRetinaEnabled()){var a=HTMLCanvasElement.prototype;var b=CanvasRenderingContext2D.prototype;var c=a._bak;Object.defineProperty(a,"width",c.width);Object.defineProperty(a,"height",c.height);b.drawImage=c.drawImage;b.getImageData=c.getImageData;Object.defineProperty(b,"shadowOffsetX",c.shadowOffsetX);Object.defineProperty(b,"shadowOffsetY",c.shadowOffsetY);Object.defineProperty(b,"shadowBlur",c.shadowBlur);delete a._isRetinaEnabled;delete a.isRetinaEnabled;delete a._bak}}
function normalizeCanvas(a,b){if(!a.isRetinaEnabled)return a;var c=newCanvas(new Point(a.width,a.height),!0);c.getContext("2d").drawImage(a,0,0);if(b)return c;a.isRetinaEnabled=!1;a.width=c.width;a.height=c.height;a.getContext("2d").drawImage(c,0,0);return a}
function Animation(a,b,c,d,e,f){this.setter=a;this.getter=b;this.delta=c||0;this.duration=d||0;this.easing=isString(e)?this.easings[e]||this.easings.sinusoidal:e||this.easings.sinusoidal;this.onComplete=f||null;this.destination=this.endTime=null;this.isActive=!1;this.start()}
Animation.prototype.easings={linear:function(a){return a},sinusoidal:function(a){return 1-Math.cos(radians(90*a))},quadratic:function(a){return.5>a?2*a*a:(4-2*a)*a-1},cubic:function(a){return.5>a?4*a*a*a:(a-1)*(2*a-2)*(2*a-2)+1},elastic:function(a){return 0>(a-=.5)?(.01+.01/a)*Math.sin(50*a):(.02-.01/a)*Math.sin(50*a)+1},sine_in:function(a){return 1-Math.sin(radians(90+90*a))},quad_in:function(a){return a*a},cubic_in:function(a){return a*a*a},elastic_in:function(a){return(.04-.04/a)*Math.sin(25*a)+
1},sine_out:function(a){return Math.sin(radians(90*a))},quad_out:function(a){return a*(2-a)},elastic_out:function(a){return.04*a/--a*Math.sin(25*a)}};Animation.prototype.start=function(){this.endTime=Date.now()+this.duration;this.destination=this.getter.call(this)+this.delta;this.isActive=!0};
Animation.prototype.step=function(){if(this.isActive){var a=Date.now();if(a>this.endTime){if(this.setter(this.destination),this.isActive=!1,this.onComplete)this.onComplete()}else this.setter(this.destination-this.delta*this.easing((this.endTime-a)/this.duration))}};function Color(a,b,c,d){this.r=a||0;this.g=b||0;this.b=c||0;this.a=d||(0===d?0:1)}Color.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")"};
Color.prototype.toRGBstring=function(){return"rgb("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+")"};Color.fromString=function(a){a=a.split(/[\(),]/).slice(1,5);return new Color(a[0],a[1],a[2],a[3])};Color.prototype.copy=function(){return new Color(this.r,this.g,this.b,this.a)};Color.prototype.eq=function(a,b){return a&&this.r===a.r&&this.g===a.g&&this.b===a.b&&(b?this.a===a.a:!0)};
Color.prototype.isCloseTo=function(a,b,c){function d(e,f){e-=f;return 0>e?255+e:e}c=2.55*(c||10);return a&&d(this.r,a.r)<c&&d(this.g,a.g)<c&&d(this.b,a.b)<c&&(b?this.a===a.a:!0)};Color.prototype.hsv=function(){var a=this.r/255,b=this.g/255,c=this.b/255;var d=Math.max(a,b,c);var e=Math.min(a,b,c);var f=d;var g=d-e;if(d===e)f=0;else{switch(d){case a:f=(b-c)/g+(b<c?6:0);break;case b:f=(c-a)/g+2;break;case c:f=(a-b)/g+4}f/=6}return[f,0===d?0:g/d,d]};
Color.prototype.set_hsv=function(a,b,c){var d=Math.floor(6*a);var e=6*a-d;a=c*(1-b);var f=c*(1-e*b);b=c*(1-(1-e)*b);switch(d%6){case 0:this.r=c;this.g=b;this.b=a;break;case 1:this.r=f;this.g=c;this.b=a;break;case 2:this.r=a;this.g=c;this.b=b;break;case 3:this.r=a;this.g=f;this.b=c;break;case 4:this.r=b;this.g=a;this.b=c;break;case 5:this.r=c,this.g=a,this.b=f}this.r*=255;this.g*=255;this.b*=255};
Color.prototype.hsl=function(){var a=this.r/255,b=this.g/255,c=this.b/255,d=Math.max(a,b,c),e=Math.min(a,b,c),f,g=(d+e)/2;if(d===e)e=f=0;else{var h=d-e;e=.5<g?h/(2-d-e):h/(d+e);switch(d){case a:f=(b-c)/h+(b<c?6:0);break;case b:f=(c-a)/h+2;break;case c:f=(a-b)/h+4}f/=6}return[f,e,g]};
Color.prototype.set_hsl=function(a,b,c){function d(e,f,g){0>g&&(g+=1);1<g&&--g;return g<1/6?e+6*(f-e)*g:.5>g?f:g<2/3?e+(f-e)*(2/3-g)*6:e}0==b?this.b=this.g=this.r=c:(b=.5>c?c*(1+b):c+b-c*b,c=2*c-b,this.r=d(c,b,a+1/3),this.g=d(c,b,a),this.b=d(c,b,a-1/3));this.r*=255;this.g*=255;this.b*=255};Color.prototype.mixed=function(a,b){a=Math.min(Math.max(a,0),1);var c=1-a;return new Color(this.r*a+b.r*c,this.g*a+b.g*c,this.b*a+b.b*c)};
Color.prototype.darker=function(a){var b=.8333;a&&(b=(100-a)/100);return this.mixed(b,new Color(0,0,0))};Color.prototype.lighter=function(a){var b=.8333;a&&(b=(100-a)/100);return this.mixed(b,WHITE)};Color.prototype.dansDarker=function(){var a=this.hsv(),b=new Color;b.set_hsv(a[0],a[1],Math.max(a[2]-.16,0));return b};Color.prototype.inverted=function(){return new Color(255-this.r,255-this.g,255-this.b)};Color.prototype.solid=function(){return new Color(this.r,this.g,this.b)};
function Point(a,b){this.x=a||0;this.y=b||0}Point.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())};Point.prototype.copy=function(){return new Point(this.x,this.y)};Point.prototype.eq=function(a){return this.x===a.x&&this.y===a.y};Point.prototype.lt=function(a){return this.x<a.x&&this.y<a.y};Point.prototype.gt=function(a){return this.x>a.x&&this.y>a.y};Point.prototype.ge=function(a){return this.x>=a.x&&this.y>=a.y};
Point.prototype.le=function(a){return this.x<=a.x&&this.y<=a.y};Point.prototype.max=function(a){return new Point(Math.max(this.x,a.x),Math.max(this.y,a.y))};Point.prototype.min=function(a){return new Point(Math.min(this.x,a.x),Math.min(this.y,a.y))};Point.prototype.round=function(){return new Point(Math.round(this.x),Math.round(this.y))};Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))};Point.prototype.neg=function(){return new Point(-this.x,-this.y)};
Point.prototype.mirror=function(){return new Point(this.y,this.x)};Point.prototype.floor=function(){return new Point(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))};Point.prototype.ceil=function(){return new Point(Math.ceil(this.x),Math.ceil(this.y))};Point.prototype.add=function(a){return a instanceof Point?new Point(this.x+a.x,this.y+a.y):new Point(this.x+a,this.y+a)};
Point.prototype.subtract=function(a){return a instanceof Point?new Point(this.x-a.x,this.y-a.y):new Point(this.x-a,this.y-a)};Point.prototype.multiplyBy=function(a){return a instanceof Point?new Point(this.x*a.x,this.y*a.y):new Point(this.x*a,this.y*a)};Point.prototype.divideBy=function(a){return a instanceof Point?new Point(this.x/a.x,this.y/a.y):new Point(this.x/a,this.y/a)};
Point.prototype.floorDivideBy=function(a){return a instanceof Point?new Point(Math.floor(this.x/a.x),Math.floor(this.y/a.y)):new Point(Math.floor(this.x/a),Math.floor(this.y/a))};Point.prototype.r=function(){var a=this.multiplyBy(this);return Math.sqrt(a.x+a.y)};Point.prototype.degrees=function(){if(0===this.x)return 0<=this.y?90:270;var a=Math.atan(this.y/this.x);return 0<=this.x?0<=this.y?degrees(a):360+degrees(a):180+degrees(a)};
Point.prototype.theta=function(){if(0===this.x)return 0<=this.y?radians(90):radians(270);var a=Math.atan(this.y/this.x);return 0<=this.x?0<=this.y?a:radians(360)+a:radians(180)+a};Point.prototype.crossProduct=function(a){return this.multiplyBy(a.mirror())};Point.prototype.distanceTo=function(a){return a.subtract(this).r()};Point.prototype.rotate=function(a,b){var c=this.subtract(b);return"right"===a?(new Point(-c.y,c.y)).add(b):"left"===a?(new Point(c.y,-c.y)).add(b):b.subtract(c)};
Point.prototype.flip=function(a,b){return"vertical"===a?new Point(this.x,2*b.y-this.y):new Point(2*b.x-this.x,this.y)};Point.prototype.distanceAngle=function(a,b){270<b?b-=360:-270>b&&(b+=360);if(-90<=b&&90>=b)return b=Math.sin(radians(b))*a,a=Math.sqrt(a*a-b*b),new Point(b+this.x,this.y-a);b=Math.sin(radians(180-b))*a;a=Math.sqrt(a*a-b*b);return new Point(b+this.x,this.y+a)};Point.prototype.scaleBy=function(a){return this.multiplyBy(a)};Point.prototype.translateBy=function(a){return this.add(a)};
Point.prototype.rotateBy=function(a,b){b=b||ZERO;var c=this.subtract(b),d=c.r();a-=c.theta();return new Point(b.x+d*Math.cos(a),b.y-d*Math.sin(a))};Point.prototype.asArray=function(){return[this.x,this.y]};function Rectangle(a,b,c,d){this.init(new Point(a||0,b||0),new Point(c||0,d||0))}Rectangle.prototype.init=function(a,b){this.origin=a;this.corner=b};Rectangle.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"};
Rectangle.prototype.copy=function(){return new Rectangle(this.left(),this.top(),this.right(),this.bottom())};Point.prototype.corner=function(a){return new Rectangle(this.x,this.y,a.x,a.y)};Point.prototype.rectangle=function(a){var b=this.min(a);a=this.max(a);return new Rectangle(b.x,b.y,a.x,a.y)};Point.prototype.extent=function(a){a=this.add(a);return new Rectangle(this.x,this.y,a.x,a.y)};
Rectangle.prototype.setTo=function(a,b,c,d){this.origin=new Point(a||(0===a?0:this.left()),b||(0===b?0:this.top()));this.corner=new Point(c||(0===c?0:this.right()),d||(0===d?0:this.bottom()))};Rectangle.prototype.setExtent=function(a){this.setWidth(a.x);this.setHeight(a.y)};Rectangle.prototype.setWidth=function(a){this.corner.x=this.origin.x+a};Rectangle.prototype.setHeight=function(a){this.corner.y=this.origin.y+a};
Rectangle.prototype.area=function(){var a=this.width();return 0>a?0:Math.max(a*this.height(),0)};Rectangle.prototype.bottom=function(){return this.corner.y};Rectangle.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())};Rectangle.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)};Rectangle.prototype.bottomRight=function(){return this.corner.copy()};Rectangle.prototype.boundingBox=function(){return this};Rectangle.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))};
Rectangle.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]};Rectangle.prototype.extent=function(){return this.corner.subtract(this.origin)};Rectangle.prototype.height=function(){return this.corner.y-this.origin.y};Rectangle.prototype.left=function(){return this.origin.x};Rectangle.prototype.leftCenter=function(){return new Point(this.left(),this.center().y)};Rectangle.prototype.right=function(){return this.corner.x};
Rectangle.prototype.rightCenter=function(){return new Point(this.right(),this.center().y)};Rectangle.prototype.top=function(){return this.origin.y};Rectangle.prototype.topCenter=function(){return new Point(this.center().x,this.top())};Rectangle.prototype.topLeft=function(){return this.origin};Rectangle.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)};Rectangle.prototype.width=function(){return this.corner.x-this.origin.x};Rectangle.prototype.position=function(){return this.origin};
Rectangle.prototype.eq=function(a){return this.origin.eq(a.origin)&&this.corner.eq(a.corner)};Rectangle.prototype.abs=function(){var a=this.origin.abs();var b=this.corner.max(a);return a.corner(b)};Rectangle.prototype.insetBy=function(a){var b=new Rectangle;b.origin=this.origin.add(a);b.corner=this.corner.subtract(a);return b};Rectangle.prototype.expandBy=function(a){var b=new Rectangle;b.origin=this.origin.subtract(a);b.corner=this.corner.add(a);return b};
Rectangle.prototype.growBy=function(a){var b=new Rectangle;b.origin=this.origin.copy();b.corner=this.corner.add(a);return b};Rectangle.prototype.intersect=function(a){var b=new Rectangle;b.origin=this.origin.max(a.origin);b.corner=this.corner.min(a.corner);return b};Rectangle.prototype.merge=function(a){var b=new Rectangle;b.origin=this.origin.min(a.origin);b.corner=this.corner.max(a.corner);return b};Rectangle.prototype.mergeWith=function(a){this.origin=this.origin.min(a.origin);this.corner=this.corner.max(a.corner)};
Rectangle.prototype.round=function(){return this.origin.round().corner(this.corner.round())};Rectangle.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil())};Rectangle.prototype.amountToTranslateWithin=function(a){var b=0,c=0;this.right()>a.right()&&(b=a.right()-this.right());this.bottom()>a.bottom()&&(c=a.bottom()-this.bottom());this.left()+b<a.left()&&(b=a.left()-this.left());this.top()+c<a.top()&&(c=a.top()-this.top());return new Point(b,c)};
Rectangle.prototype.regionsAround=function(a){var b=[];if(!this.intersects(a))return b;a.left()>this.left()&&b.push(new Rectangle(this.left(),this.top(),a.left(),this.bottom()));a.top()>this.top()&&b.push(new Rectangle(this.left(),this.top(),this.right(),a.top()));a.right()<this.right()&&b.push(new Rectangle(a.right(),this.top(),this.right(),this.bottom()));a.bottom()<this.bottom()&&b.push(new Rectangle(this.left(),a.bottom(),this.right(),this.bottom()));return b};
Rectangle.prototype.containsPoint=function(a){return this.origin.le(a)&&a.lt(this.corner)};Rectangle.prototype.containsRectangle=function(a){return a.origin.gt(this.origin)&&a.corner.lt(this.corner)};Rectangle.prototype.intersects=function(a){var b=a.origin;a=a.corner;return a.x>=this.origin.x&&a.y>=this.origin.y&&b.x<=this.corner.x&&b.y<=this.corner.y};
Rectangle.prototype.isNearTo=function(a,b){var c=a.origin;a=a.corner;b=b||0;return a.x+b>=this.origin.x&&a.y+b>=this.origin.y&&c.x-b<=this.corner.x&&c.y-b<=this.corner.y};Rectangle.prototype.scaleBy=function(a){var b=this.origin.multiplyBy(a);a=this.corner.multiplyBy(a);return new Rectangle(b.x,b.y,a.x,a.y)};Rectangle.prototype.translateBy=function(a){var b=this.origin.add(a);a=this.corner.add(a);return new Rectangle(b.x,b.y,a.x,a.y)};
Rectangle.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]};Rectangle.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]};function Node(a,b){this.init(a||null,b||[])}Node.prototype.init=function(a,b){this.parent=a||null;this.children=b||[]};Node.prototype.toString=function(){return"a Node["+this.children.length.toString()+"]"};Node.prototype.addChild=function(a){this.children.push(a);a.parent=this};
Node.prototype.addChildFirst=function(a){this.children.splice(0,null,a);a.parent=this};Node.prototype.removeChild=function(a){a=this.children.indexOf(a);-1!==a&&this.children.splice(a,1)};Node.prototype.root=function(){return null===this.parent?this:this.parent.root()};Node.prototype.depth=function(){return null===this.parent?0:this.parent.depth()+1};Node.prototype.allChildren=function(){var a=[this];this.children.forEach(function(b){a=a.concat(b.allChildren())});return a};
Node.prototype.forAllChildren=function(a){0<this.children.length&&this.children.forEach(function(b){return b.forAllChildren(a)});a.call(null,this)};Node.prototype.anyChild=function(a){var b;if(a.call(null,this))return!0;for(b=0;b<this.children.length;b+=1)if(this.children[b].anyChild(a))return!0;return!1};Node.prototype.allLeafs=function(){var a=[];this.allChildren().forEach(function(b){0===b.children.length&&a.push(b)});return a};
Node.prototype.allParents=function(){var a=[this];null!==this.parent&&(a=a.concat(this.parent.allParents()));return a};Node.prototype.siblings=function(){var a=this;return null===this.parent?[]:this.parent.children.filter(function(b){return b!==a})};Node.prototype.parentThatIsA=function(){var a;for(a=0;a<arguments.length;a+=1)if(this instanceof arguments[a])return this;return this.parent?this.parentThatIsA.apply(this.parent,arguments):null};
Node.prototype.parentThatIsAnyOf=function(a){return this.parentThatIsA.apply(this,a)};Morph.prototype=new Node;Morph.prototype.constructor=Morph;Morph.uber=Node.prototype;Morph.prototype.shadowBlur=4;function Morph(){this.init()}
Morph.prototype.init=function(){Morph.uber.init.call(this);this.isMorph=!0;this.cachedImage=null;this.shouldRerender=this.isCachingImage=!1;this.bounds=new Rectangle(0,0,50,40);this.holes=[];this.color=new Color(80,80,80);this.cachedTexture=this.texture=null;this.alpha=1;this.isVisible=!0;this.noDropShadow=this.isFreeForm=this.acceptsDrops=this.isTemplate=this.isDraggable=!1;this.fullShadowSource=!0;this.fps=0;this.customContextMenu=null;this.lastTime=Date.now();this.onNextStep=null};
Morph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds};Morph.prototype.destroy=function(){null!==this.parent&&(this.fullChanged(),this.parent.removeChild(this))};
Morph.prototype.stepFrame=function(){if(!this.step)return null;var a=Date.now();var b=a-this.lastTime;1>(0<this.fps?1E3/this.fps-b:0)&&(this.lastTime=a,this.onNextStep&&(a=this.onNextStep,this.onNextStep=null,a.call(this)),this.step(),this.children.forEach(function(c){return c.stepFrame()}))};Morph.prototype.nextSteps=function(a){var b=this,c=a||[],d=c.shift();d&&(this.onNextStep=function(){d.call(b);b.nextSteps(c)})};Morph.prototype.step=nop;Morph.prototype.left=function(){return this.bounds.left()};
Morph.prototype.right=function(){return this.bounds.right()};Morph.prototype.top=function(){return this.bounds.top()};Morph.prototype.bottom=function(){return this.bounds.bottom()};Morph.prototype.center=function(){return this.bounds.center()};Morph.prototype.bottomCenter=function(){return this.bounds.bottomCenter()};Morph.prototype.bottomLeft=function(){return this.bounds.bottomLeft()};Morph.prototype.bottomRight=function(){return this.bounds.bottomRight()};Morph.prototype.boundingBox=function(){return this.bounds};
Morph.prototype.corners=function(){return this.bounds.corners()};Morph.prototype.leftCenter=function(){return this.bounds.leftCenter()};Morph.prototype.rightCenter=function(){return this.bounds.rightCenter()};Morph.prototype.topCenter=function(){return this.bounds.topCenter()};Morph.prototype.topLeft=function(){return this.bounds.topLeft()};Morph.prototype.topRight=function(){return this.bounds.topRight()};Morph.prototype.position=function(){return this.bounds.origin};Morph.prototype.extent=function(){return this.bounds.extent()};
Morph.prototype.width=function(){return this.bounds.width()};Morph.prototype.height=function(){return this.bounds.height()};Morph.prototype.fullBounds=function(){var a=this.bounds;this.children.forEach(function(b){b.isVisible&&(a=a.merge(b.fullBounds()))});return a};Morph.prototype.fullBoundsNoShadow=function(){var a=this.bounds;this.children.forEach(function(b){b instanceof ShadowMorph||!b.isVisible||(a=a.merge(b.fullBounds()))});return a};
Morph.prototype.visibleBounds=function(){var a=this.bounds;this.allParents().filter(function(b){return b instanceof FrameMorph}).forEach(function(b){return a=a.intersect(b.bounds)});return a};Morph.prototype.moveBy=function(a){var b=this.children,c=b.length;this.changed();this.bounds=this.bounds.translateBy(a);this.changed();for(c;0<c;--c)b[c-1].moveBy(a)};Morph.prototype.setPosition=function(a){a=a.subtract(this.topLeft());a.eq(ZERO)||this.moveBy(a)};
Morph.prototype.setLeft=function(a){this.setPosition(new Point(a,this.top()))};Morph.prototype.setRight=function(a){this.setPosition(new Point(a-this.width(),this.top()))};Morph.prototype.setTop=function(a){this.setPosition(new Point(this.left(),a))};Morph.prototype.setBottom=function(a){this.setPosition(new Point(this.left(),a-this.height()))};Morph.prototype.setCenter=function(a){this.setPosition(a.subtract(this.extent().floorDivideBy(2)))};Morph.prototype.setFullCenter=function(a){this.setPosition(a.subtract(this.fullBounds().extent().floorDivideBy(2)))};
Morph.prototype.keepWithin=function(a){var b=this.fullBounds().right()-a.right();0<b&&this.moveBy(new Point(-b,0));b=this.fullBounds().left()-a.left();0>b&&this.moveBy(new Point(-b,0));b=this.fullBounds().bottom()-a.bottom();0<b&&this.moveBy(new Point(0,-b));a=this.fullBounds().top()-a.top();0>a&&this.moveBy(new Point(0,-a))};
Morph.prototype.scrollIntoView=function(){var a=this.parentThatIsA(ScrollFrameMorph);if(a){var b=Math.min(this.fullBounds().right()-a.right(),a.contents.right()-a.right());0<b&&a.contents.moveBy(new Point(-b,0));b=this.fullBounds().left()-a.left();0>b&&a.contents.moveBy(new Point(-b,0));b=this.fullBounds().top()-a.top();0>b&&a.contents.moveBy(new Point(0,-b));b=this.fullBounds().bottom()-a.bottom();0<b&&a.contents.moveBy(new Point(0,-b));a.adjustScrollBars()}};
Morph.prototype.setExtent=function(a){a.eq(this.extent())||(this.changed(),this.bounds.setWidth(a.x),this.bounds.setHeight(a.y),this.fixLayout(),this.rerender())};Morph.prototype.setWidth=function(a){this.setExtent(new Point(a||0,this.height()))};Morph.prototype.setHeight=function(a){this.setExtent(new Point(this.width(),a||0))};Morph.prototype.setColor=function(a){a&&!this.color.eq(a)&&(this.color=a,this.rerender())};
Morph.prototype.getImage=function(){if(this.cachedImage&&!this.shouldRerender)return this.cachedImage;var a=newCanvas(this.extent(),!1,this.cachedImage);this.isCachingImage&&(this.cachedImage=a);this.render(a.getContext("2d"));this.shouldRerender=!1;return a};Morph.prototype.render=function(a){a.fillStyle=this.getRenderColor().toString();a.fillRect(0,0,this.width(),this.height());this.cachedTexture?this.renderCachedTexture(a):this.texture&&this.renderTexture(this.texture,a)};
Morph.prototype.getRenderColor=function(){return this.color};Morph.prototype.fixLayout=function(){};Morph.prototype.fixHolesLayout=function(){};Morph.prototype.renderTexture=function(a,b){var c=this;this.cachedTexture=new Image;this.cachedTexture.onload=function(){return c.changed()};this.cachedTexture.src=this.texture=a};
Morph.prototype.renderCachedTexture=function(a){var b=this.cachedTexture,c=Math.floor(this.width()/b.width),d=Math.floor(this.height()/b.height),e,f;a.save();a.globalAlpha=this.alpha;a.beginPath();a.rect(0,0,this.width(),this.height());a.clip();for(f=0;f<=d;f+=1)for(e=0;e<=c;e+=1)a.drawImage(b,e*b.width,f*b.height);a.restore()};
Morph.prototype.drawOn=function(a,b){var c=b.intersect(this.bounds),d=this.position();if(c.extent().gt(ZERO)){a.save();a.globalAlpha=this.alpha;if(this.isCachingImage){b=this.getImage();var e=c.translateBy(d.neg());var f=e.left();var g=e.top();var h=Math.min(e.width(),b.width-f);e=Math.min(e.height(),b.height-g);if(1>h||1>e)return;a.drawImage(b,f,g,h,e,c.left(),c.top(),h,e)}else a.beginPath(),a.rect(c.left(),c.top(),c.width(),c.height()),a.clip(),a.translate(d.x,d.y),this.render(a),MorphicPreferences.showHoles&&
(a.translate(-d.x,-d.y),a.globalAlpha=.25,a.fillStyle="white",this.holes.forEach(function(k){k=k.translateBy(d).intersect(c);a.fillRect(k.left(),k.top(),k.width(),k.height())}));a.restore()}};Morph.prototype.fullDrawOn=function(a,b){this.isVisible&&(this.drawOn(a,b),this.children.forEach(function(c){return c.fullDrawOn(a,b)}))};Morph.prototype.hide=function(){this.isVisible=!1;this.changed()};Morph.prototype.show=function(){this.isVisible=!0;this.changed()};
Morph.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible;this.changed()};Morph.prototype.fullImage=function(){var a=this.fullBounds(),b=newCanvas(a.extent()),c=b.getContext("2d");c.translate(-a.origin.x,-a.origin.y);this.fullDrawOn(c,a);return b};
Morph.prototype.shadowImage=function(a,b){var c=a||new Point(7,7);var d=b||new Color(0,0,0);if(this.fullShadowSource){b=this.fullBounds().extent();var e=this.fullImage()}else b=this.extent(),e=this.getImage();a=newCanvas(b);var f=a.getContext("2d");f.drawImage(e,0,0);f.globalCompositeOperation="destination-out";f.drawImage(e,-c.x,-c.y);c=newCanvas(b);f=c.getContext("2d");f.drawImage(a,0,0);f.globalCompositeOperation="source-atop";f.fillStyle=d.toString();f.fillRect(0,0,b.x,b.y);return c};
Morph.prototype.shadowImageBlurred=function(a,b){a=a||new Point(7,7);var c=this.shadowBlur,d=b||new Color(0,0,0);if(this.fullShadowSource){var e=this.fullBounds().extent().add(2*c);b=this.fullImage()}else e=this.extent().add(2*c),b=this.getImage();e=newCanvas(e);var f=e.getContext("2d");f.shadowOffsetX=a.x;f.shadowOffsetY=a.y;f.shadowBlur=c;f.shadowColor=d.toString();f.drawImage(b,c-a.x,c-a.y);f.shadowOffsetX=0;f.shadowOffsetY=0;f.shadowBlur=0;f.globalCompositeOperation="destination-out";f.drawImage(b,
c-a.x,c-a.y);return e};Morph.prototype.shadow=function(a,b,c){var d=new ShadowMorph;a=a||new Point(7,7);b=b||(0===b?0:.2);var e=this.fullBounds();d.setExtent(e.extent().add(2*this.shadowBlur));useBlurredShadows?(d.cachedImage=this.shadowImageBlurred(a,c),d.alpha=b,d.setPosition(e.origin.add(a).subtract(this.shadowBlur))):(d.cachedImage=this.shadowImage(a,c),d.alpha=b,d.setPosition(e.origin.add(a)));d.shouldRerender=!1;return d};
Morph.prototype.addShadow=function(a,b,c){a=a||new Point(7,7);b=this.shadow(a,b||(0===b?0:.2),c);this.addBack(b);this.fullChanged();return b};Morph.prototype.getShadow=function(){var a=this.children.slice(0).reverse().filter(function(b){return b instanceof ShadowMorph});return 0!==a.length?a[0]:null};Morph.prototype.removeShadow=function(){var a=this.getShadow();null!==a&&(this.fullChanged(),this.removeChild(a))};Morph.prototype.penTrails=function(){return this.getImage()};
Morph.prototype.rerender=function(){this.shouldRerender=!0;this.changed()};Morph.prototype.changed=function(){var a=this.root();a instanceof WorldMorph&&a.broken.push(this.visibleBounds().spread());this.parent&&this.parent.childChanged(this)};Morph.prototype.fullChanged=function(){var a=this.root();a instanceof WorldMorph&&a.broken.push(this.fullBounds().spread())};Morph.prototype.childChanged=function(){this.parent&&this.parent.childChanged(this)};
Morph.prototype.world=function(){var a=this.root();return a instanceof WorldMorph?a:a instanceof HandMorph?a.world:null};Morph.prototype.add=function(a){var b=a.parent;null!==b&&b.removeChild(a);this.addChild(a)};Morph.prototype.addBack=function(a){var b=a.parent;null!==b&&b.removeChild(a);this.addChildFirst(a)};
Morph.prototype.topMorphAt=function(a){var b=this,c,d;if(!this.isVisible)return null;for(c=this.children.length-1;0<=c;--c)if(d=this.children[c].topMorphAt(a))return d;if(this.bounds.containsPoint(a)){if(this.holes.some(function(e){return e.translateBy(b.position()).containsPoint(a)}))return null;if(this.isFreeForm){if(!this.isTransparentAt(a))return this}else return this}return null};
Morph.prototype.topMorphSuchThat=function(a){var b;return a.call(null,this)?(b=detect(this.children.slice(0).reverse(),a))?b.topMorphSuchThat(a):this:null};Morph.prototype.overlappedMorphs=function(){var a=this,b=this.world(),c=this.fullBounds(),d=this.allParents(),e=this.allChildren();return b.allChildren().filter(function(f){return f.isVisible&&f!==a&&f!==b&&!contains(d,f)&&!contains(e,f)&&f.fullBounds().intersects(c)})};
Morph.prototype.getPixelColor=function(a){a=a.subtract(this.bounds.origin);a=this.getImage().getContext("2d").getImageData(a.x,a.y,1,1);return new Color(a.data[0],a.data[1],a.data[2],a.data[3]/255)};Morph.prototype.isTransparentAt=function(a){if(this.bounds.containsPoint(a)){if(this.texture)return!1;a=a.subtract(this.bounds.origin);var b=this.getImage().getContext("2d");a=b.getImageData(Math.floor(a.x),Math.floor(a.y),1,1);return 0===a.data[3]}return!1};
Morph.prototype.copy=function(){var a=copy(this);a.parent=null;a.children=[];a.bounds=this.bounds.copy();return a};Morph.prototype.fullCopy=function(){var a=new Map;var b=this.copyRecordingReferences(a);b.forAllChildren(function(c){return c.updateReferences(a)});return b};Morph.prototype.copyRecordingReferences=function(a){var b=this.copy();a.set(this,b);this.children.forEach(function(c){return b.add(c.copyRecordingReferences(a))});return b};
Morph.prototype.updateReferences=function(a){var b=Object.keys(this),c=b.length,d,e;for(e=0;e<c;e+=1){var f=b[e];(d=this[f])&&d.isMorph&&(d=a.get(d))&&(this[f]=d)}};Morph.prototype.rootForGrab=function(){return this instanceof ShadowMorph?this.parent.rootForGrab():this.parent instanceof ScrollFrameMorph?this.parent:null===this.parent||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||!0===this.isDraggable?this:this.parent.rootForGrab()};
Morph.prototype.isCorrectingOutsideDrag=function(){return!0};Morph.prototype.wantsDropOf=function(a){return a instanceof HandleMorph||a instanceof MenuMorph||a instanceof InspectorMorph?!1:this.acceptsDrops};Morph.prototype.pickUp=function(a){a=a||this.world();this.setPosition(a.hand.position().subtract(this.extent().floorDivideBy(2)));a.hand.grab(this)};Morph.prototype.isPickedUp=function(){return null!==this.parentThatIsA(HandMorph)};
Morph.prototype.situation=function(){return this.parent?{origin:this.parent,position:this.position().subtract(this.parent.position())}:null};Morph.prototype.slideBackTo=function(a,b,c,d){var e=this,f=a.origin.position().add(a.position);this.glideTo(f,b,null,function(){a.origin.add(e);c&&c();e.justDropped&&e.justDropped();a.origin.reactToDropOf&&a.origin.reactToDropOf(e);d&&d()})};
Morph.prototype.glideTo=function(a,b,c,d){var e=this,f=this.world(),g=new Animation(function(h){return e.setLeft(h)},function(){return e.left()},-(this.left()-a.x),b||100,c);f.animations.push(g);f.animations.push(new Animation(function(h){return e.setTop(h)},function(){return e.top()},-(this.top()-a.y),b||100,c,function(){g.setter(g.destination);g.isActive=!1;d()}))};
Morph.prototype.fadeTo=function(a,b,c,d){var e=this,f=this.world(),g=this.alpha;this.children.forEach(function(h){return h.fadeTo(a,b,c)});f.animations.push(new Animation(function(h){e.alpha=h;e.changed()},function(){return e.alpha},a-this.alpha,b||200,c,function(){e.alpha=g;d&&d()}))};Morph.prototype.perish=function(a,b){var c=this;this.fadeTo(0,a||100,null,function(){c.destroy();b&&b()})};Morph.prototype.nop=nop;Morph.prototype.resize=function(){this.world().activeHandle=new HandleMorph(this)};
Morph.prototype.move=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move")};Morph.prototype.moveCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"moveCenter")};Morph.prototype.hint=function(a){var b;(b=a)?a.toString&&(b=a.toString()):b="NULL";a=new MenuMorph(this,b);a.isDraggable=!0;a.popUpCenteredAtHand(this.world())};
Morph.prototype.inform=function(a){var b;(b=a)?a.toString&&(b=a.toString()):b="NULL";a=new MenuMorph(this,b);a.addItem("Ok");a.isDraggable=!0;a.popUpCenteredAtHand(this.world())};
Morph.prototype.prompt=function(a,b,c,d,e,f,g,h,k){k=void 0===k?nop:k;var l;g&&(l=!0);a=new MenuMorph(b||null,a||"",c||null);var m=new StringFieldMorph(d||"",e||100,MorphicPreferences.prompterFontSize,MorphicPreferences.prompterFontName,!1,!1,l);a.items.push(m);if(g||MorphicPreferences.useSliderForInput)e=new SliderMorph(f||0,g,parseFloat(d),Math.floor((g-f)/4),"horizontal"),e.alpha=1,e.color=new Color(225,225,225),e.button.color=a.borderColor,e.button.highlightColor=e.button.color.copy(),e.button.highlightColor.b+=
100,e.button.pressColor=e.button.color.copy(),e.button.pressColor.b+=150,e.setHeight(MorphicPreferences.prompterSliderSize),e.action=h?function(n){m.changed();m.text.text=Math.round(n).toString();m.text.fixLayout();m.text.changed();m.text.edit();k(Math.round(n))}:function(n){m.changed();m.text.text=n.toString();m.text.fixLayout();m.text.changed();k(n)},a.items.push(e);a.addLine(2);a.addItem("Ok",function(){return m.string()});a.addItem("Cancel",function(){k(d);return null});a.isDraggable=!0;a.popUpAtHand(this.world());
m.text.edit()};Morph.prototype.pickColor=function(a,b,c,d){a=new MenuMorph(b||null,a||"",c||null);var e=new ColorPickerMorph(d);a.items.push(e);a.addLine(2);a.addItem("Ok",function(){return e.getChoice()});a.addItem("Cancel",function(){return null});a.isDraggable=!0;a.popUpAtHand(this.world())};
Morph.prototype.inspect=function(a){var b=this.world instanceof Function?this.world():this.root()||this.world,c=this;a&&(c=a);a=new InspectorMorph(c);a.setPosition(b.hand.position());a.keepWithin(b);b.add(a);a.changed()};
Morph.prototype.inspectKeyEvent=function(a){this.inform("Key pressed: "+String.fromCharCode(a.charCode)+"\n------------------------\ncharCode: "+a.charCode.toString()+"\nkeyCode: "+a.keyCode.toString()+"\nkey: "+a.key.toString()+"\nshiftKey: "+a.shiftKey.toString()+"\naltKey: "+a.altKey.toString()+"\nctrlKey: "+a.ctrlKey.toString()+"\ncmdKey: "+a.metaKey.toString())};
Morph.prototype.contextMenu=function(){var a;return this.customContextMenu?this.customContextMenu:(a=this.world instanceof Function?this.world():this.world)&&a.isDevMode?this.parent===a?this.developersMenu():this.hierarchyMenu():this.userMenu()||this.parent&&this.parent.userMenu()};
Morph.prototype.hierarchyMenu=function(){var a=this.allParents(),b=this.world instanceof Function?this.world():this.world,c=new MenuMorph(this,null);a.forEach(function(d){d.developersMenu&&d!==b&&c.addMenu(d.toString().slice(0,50),d.developersMenu())});return c};
Morph.prototype.developersMenu=function(){var a=this,b=this.world instanceof Function?this.world():this.world,c=this.userMenu()||this.parent&&this.parent.userMenu(),d=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);c&&(d.addMenu("user features",c),d.addLine());d.addItem("color...",function(){a.pickColor(d.title+localize("\ncolor:"),a.setColor,a,a.color)},"choose another color \nfor this morph");d.addItem("transparency...",function(){a.prompt(d.title+
localize("\nalpha\nvalue:"),a.setAlphaScaled,a,(100*a.alpha).toString(),null,1,100,!0)},"set this morph's\nalpha value");d.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's extent");d.addLine();d.addItem("duplicate",function(){return a.fullCopy().pickUp(a.world())},"make a copy\nand pick it up");d.addItem("pick up","pickUp","detach and put \ninto the hand");d.addItem("attach...","attach","stick this morph\nto another one");d.addItem("move...","move","show a handle\nwhich can be dragged\nto move this morph");
d.addItem("inspect...","inspect","open a window\non all properties");d.addItem("pic...",function(){return window.open(a.fullImage().toDataURL())},"open a new window\nwith a picture of this morph");d.addLine();this.isDraggable?d.addItem("lock","toggleIsDraggable","make this morph\nunmovable"):d.addItem("unlock","toggleIsDraggable","make this morph\nmovable");d.addItem("hide","hide");d.addItem("delete","destroy");this instanceof WorldMorph||(d.addLine(),d.addItem("World...",function(){return b.contextMenu().popUpAtHand(b)},
"show the\nWorld's menu"));return d};Morph.prototype.userMenu=function(){return null};Morph.prototype.addToDemoMenu=function(a){WorldMorph.prototype.customMorphs.push(a)};Morph.prototype.setAlphaScaled=function(a){"number"===typeof a?this.alpha=Math.min(Math.max(a/100,0),1):(a=parseFloat(a),isNaN(a)||(this.alpha=Math.min(Math.max(a/100,0),1)));this.changed()};
Morph.prototype.attach=function(){var a=this,b=this.overlappedMorphs(),c=new MenuMorph(this,"choose new parent:");b.forEach(function(d){c.addItem(d.toString().slice(0,50),function(){d.add(a);a.isDraggable=!1})});0<b.length&&c.popUpAtHand(this.world())};Morph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable};Morph.prototype.colorSetters=function(){return["color"]};Morph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]};
Morph.prototype.allEntryFields=function(){return this.allChildren().filter(function(a){return a.isEditable&&(a instanceof StringMorph||a instanceof TextMorph)})};Morph.prototype.nextEntryField=function(a){var b=this.allEntryFields();a=b.indexOf(a);return-1!==a&&b.length>a+1?b[a+1]:b[0]};Morph.prototype.previousEntryField=function(a){var b=this.allEntryFields();a=b.indexOf(a);return-1!==a?0<a?b[a-1]:b[b.length-1]:b[0]};Morph.prototype.tab=function(a){this.nextTab?this.nextTab(a):this.parent&&this.parent.tab(a)};
Morph.prototype.backTab=function(a){this.previousTab?this.previousTab(a):this.parent&&this.parent.backTab(a)};Morph.prototype.escalateEvent=function(a,b){for(var c=this.parent;!c[a]&&null!==c.parent;)c=c.parent;if(c[a])c[a](b)};Morph.prototype.evaluateString=function(a){try{var b=eval(a);this.changed()}catch(c){this.inform(c)}return b};Morph.prototype.isTouching=function(a){a=this.overlappingPixels(a);var b;if(!a)return!1;var c=a[0].length;for(b=3;b<c;b+=4)if(a[0][b]&&a[1][b])return!0;return!1};
Morph.prototype.overlappingPixels=function(a){var b=this.fullBounds(),c=a.fullBounds();b=b.intersect(c);if(1>b.width()||1>b.height())return!1;c=this.fullImage();var d=a.fullImage();c.isRetinaEnabled!==d.isRetinaEnabled&&(c=normalizeCanvas(c,!0),d=normalizeCanvas(d,!0));return[c.getContext("2d").getImageData(b.left()-this.left(),b.top()-this.top(),b.width(),b.height()).data,d.getContext("2d").getImageData(b.left()-a.left(),b.top()-a.top(),b.width(),b.height()).data]};ShadowMorph.prototype=new Morph;
ShadowMorph.prototype.constructor=ShadowMorph;ShadowMorph.uber=Morph.prototype;function ShadowMorph(){this.init()}ShadowMorph.prototype.init=function(){ShadowMorph.uber.init.call(this);this.isCachingImage=!0};ShadowMorph.prototype.topMorphAt=function(){return null};HandleMorph.prototype=new Morph;HandleMorph.prototype.constructor=HandleMorph;HandleMorph.uber=Morph.prototype;function HandleMorph(a,b,c,d,e,f){this.init(a,b,c,d,e,f)}
HandleMorph.prototype.init=function(a,b,c,d,e,f){var g=MorphicPreferences.handleSize;this.target=a||null;this.minExtent=new Point(b||0,c||0);this.inset=new Point(d||0,e||d||0);this.type=f||"resize";this.isHighlighted=!1;HandleMorph.uber.init.call(this);this.color=WHITE;this.isDraggable=!1;"movePivot"===this.type&&(g*=2);this.setExtent(new Point(g,g));this.fixLayout()};
HandleMorph.prototype.fixLayout=function(){this.target&&("moveCenter"===this.type?this.setCenter(this.target.center()):"movePivot"===this.type?this.setCenter(this.target.rotationCenter()):this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset))),this.target.add(this),this.target.changed())};
HandleMorph.prototype.render=function(a){"movePivot"===this.type?this.isHighlighted?this.renderCrosshairsOn(a,.5):this.renderCrosshairsOn(a,.6):this.isHighlighted?this.renderHandleOn(a,new Color(100,100,255),WHITE):this.renderHandleOn(a,this.color,new Color(100,100,100))};
HandleMorph.prototype.renderCrosshairsOn=function(a,b){var c=this.width()/2;a.fillStyle="rgba(255, 255, 255, 0.5)";a.beginPath();a.arc(c,c,.9*c,radians(0),radians(360),!1);a.fill();a.strokeStyle="black";a.lineWidth=1;a.beginPath();a.arc(c,c,c*b,radians(0),radians(360),!1);a.stroke();a.moveTo(0,c);a.lineTo(this.width(),c);a.stroke();a.moveTo(c,0);a.lineTo(c,this.height());a.stroke()};
HandleMorph.prototype.renderHandleOn=function(a,b,c){var d=0===this.type.indexOf("move"),e=new Point(0,this.height()),f=new Point(this.width(),0),g;a.lineWidth=1;a.lineCap="round";a.strokeStyle=b.toString();if(d){b=e.copy();var h=f.copy();for(g=0;g<=this.height();g+=6)b.y=e.y-g,h.y=f.y-g,a.beginPath(),a.moveTo(b.x,b.y),a.lineTo(h.x,h.y),a.closePath(),a.stroke()}b=e.copy();h=f.copy();for(g=0;g<=this.width();g+=6)b.x=e.x+g,h.x=f.x+g,a.beginPath(),a.moveTo(b.x,b.y),a.lineTo(h.x,h.y),a.closePath(),a.stroke();
a.strokeStyle=c.toString();if(d)for(b=e.copy(),h=f.copy(),g=-2;g<=this.height();g+=6)b.y=e.y-g,h.y=f.y-g,a.beginPath(),a.moveTo(b.x,b.y),a.lineTo(h.x,h.y),a.closePath(),a.stroke();b=e.copy();h=f.copy();for(g=2;g<=this.width();g+=6)b.x=e.x+g,h.x=f.x+g,a.beginPath(),a.moveTo(b.x,b.y),a.lineTo(h.x,h.y),a.closePath(),a.stroke()};HandleMorph.prototype.step=null;
HandleMorph.prototype.mouseDownLeft=function(a){var b=this,c=this.root();if(!this.target)return null;var d=0===this.type.indexOf("move")?a.subtract(this.center()):a.subtract(this.bounds.origin);this.step=function(){if(c.hand.mouseButton){var e=c.hand.bounds.origin.copy().subtract(d);"resize"===b.type?(e=e.add(b.extent().add(b.inset)).subtract(b.target.bounds.origin),e=e.max(b.minExtent),b.target.setExtent(e),b.setPosition(b.target.bottomRight().subtract(b.extent().add(b.inset)))):"moveCenter"===b.type?
b.target.setCenter(e):"movePivot"===b.type?(b.target.setPivot(e),b.setCenter(b.target.rotationCenter())):b.target.setPosition(e.subtract(b.target.extent()).add(b.extent()))}else b.step=null};this.target.step||(this.target.step=nop)};HandleMorph.prototype.rootForGrab=function(){return this};HandleMorph.prototype.mouseEnter=function(){this.isHighlighted=!0;this.changed()};HandleMorph.prototype.mouseLeave=function(){this.isHighlighted=!1;this.changed()};
HandleMorph.prototype.attach=function(){var a=this,b=this.overlappedMorphs(),c=new MenuMorph(this,"choose target:");b.forEach(function(d){c.addItem(d.toString().slice(0,50),function(){a.isDraggable=!1;a.target=d;a.fixLayout()})});0<b.length&&c.popUpAtHand(this.world())};PenMorph.prototype=new Morph;PenMorph.prototype.constructor=PenMorph;PenMorph.uber=Morph.prototype;function PenMorph(){this.init()}
PenMorph.prototype.init=function(){var a=4*MorphicPreferences.handleSize;this.isWarped=!1;this.heading=0;this.isDown=!0;this.size=1;this.penPoint="tip";this.penBounds=null;HandleMorph.uber.init.call(this);this.setExtent(new Point(a,a))};PenMorph.prototype.changed=function(){this.isWarped||PenMorph.uber.changed.call(this)};
PenMorph.prototype.render=function(a,b){var c=b||this.heading;var d=this.width()/2;b=this.center().subtract(this.bounds.origin);if("tip"===this.penPoint){var e=b.distanceAngle(.75*d,c-180);var f=b.distanceAngle(d,c+195);d=b.distanceAngle(d,c-195)}else e=b.distanceAngle(.75*d,c),f=b.distanceAngle(.33*d,c+230),d=b.distanceAngle(.33*d,c-230);this.penBounds=new Rectangle(Math.min(b.x,e.x,f.x,d.x),Math.min(b.y,e.y,f.y,d.y),Math.max(b.x,e.x,f.x,d.x),Math.max(b.y,e.y,f.y,d.y));a.fillStyle=this.color.toString();
a.beginPath();a.moveTo(b.x,b.y);a.lineTo(f.x,f.y);a.lineTo(e.x,e.y);a.lineTo(d.x,d.y);a.closePath();a.strokeStyle="white";a.lineWidth=3;a.stroke();a.strokeStyle="black";a.lineWidth=1;a.stroke();a.fill()};PenMorph.prototype.setHeading=function(a){this.heading=(+a%360+360)%360;this.fixLayout();this.rerender()};PenMorph.prototype.numericalSetters=function(){return"setLeft setTop setWidth setHeight setAlphaScaled setHeading".split(" ")};
PenMorph.prototype.developersMenu=function(){var a=PenMorph.uber.developersMenu.call(this);a.addLine();a.addItem("set rotation","setRotation","interactively turn this morph\nusing a dial widget");return a};
PenMorph.prototype.setRotation=function(){var a=this;var b=this.name||this.constructor.name;10<b.length&&(b=b.slice(0,9)+"...");b=new MenuMorph(this,b);var c=new DialMorph(null,null,this.heading);c.rootForGrab=function(){return c};c.target=this;c.action="setHeading";b.items.push(c);b.addLine();b.addItem("(90) right",function(){return a.setHeading(90)});b.addItem("(-90) left",function(){return a.setHeading(-90)});b.addItem("(0) up",function(){return a.setHeading(0)});b.addItem("(180) down",function(){return a.setHeading(180)});
b.isDraggable=!0;b.popUpAtHand(this.world())};PenMorph.prototype.drawLine=function(a,b){var c=this.parent.penTrails().getContext("2d"),d=a.subtract(this.parent.bounds.origin),e=b.subtract(this.parent.bounds.origin);this.isDown&&(c.lineWidth=this.size,c.strokeStyle=this.color.toString(),c.lineCap="round",c.lineJoin="round",c.beginPath(),c.moveTo(d.x,d.y),c.lineTo(e.x,e.y),c.stroke(),!1===this.isWarped&&this.world().broken.push(a.rectangle(b).expandBy(Math.max(this.size/2,1)).intersect(this.parent.visibleBounds()).spread()))};
PenMorph.prototype.turn=function(a){this.setHeading(this.heading+parseFloat(a))};PenMorph.prototype.forward=function(a){var b=this.center();a=parseFloat(a);a=0<=a?this.position().distanceAngle(a,this.heading):this.position().distanceAngle(Math.abs(a),this.heading-180);this.setPosition(a);this.drawLine(b,this.center())};PenMorph.prototype.down=function(){this.isDown=!0};PenMorph.prototype.up=function(){this.isDown=!1};PenMorph.prototype.clear=function(){this.parent.rerender()};
PenMorph.prototype.startWarp=function(){this.isWarped=!0};PenMorph.prototype.endWarp=function(){this.isWarped=!1;this.parent.changed()};PenMorph.prototype.warp=function(a){this.startWarp();a.call(this);this.endWarp()};PenMorph.prototype.warpOp=function(a,b){this.startWarp();this[a].apply(this,b);this.endWarp()};PenMorph.prototype.warpSierpinski=function(a,b){this.warpOp("sierpinski",[a,b])};
PenMorph.prototype.sierpinski=function(a,b){var c;if(a>b)for(c=0;3>c;c+=1)this.sierpinski(.5*a,b),this.turn(120),this.forward(a)};PenMorph.prototype.warpTree=function(a,b,c){this.warpOp("tree",[a,b,c])};PenMorph.prototype.tree=function(a,b,c){0<a&&(this.size=a,this.forward(b),this.turn(c),this.tree(a-1,.75*b,c),this.turn(-2*c),this.tree(a-1,.75*b,c),this.turn(c),this.forward(-b))};ColorPaletteMorph.prototype=new Morph;ColorPaletteMorph.prototype.constructor=ColorPaletteMorph;
ColorPaletteMorph.uber=Morph.prototype;function ColorPaletteMorph(a,b){this.init(a||null,b||new Point(80,50))}ColorPaletteMorph.prototype.init=function(a,b){ColorPaletteMorph.uber.init.call(this);this.isCachingImage=!0;this.target=a;this.targetSetter="color";this.setExtent(b);this.choice=null};
ColorPaletteMorph.prototype.render=function(a){var b=this.extent(),c,d;this.choice=BLACK;for(c=0;c<=b.x;c+=1){var e=360*c/b.x;for(d=0;d<=b.y;d+=1){var f=100-d/b.y*100;a.fillStyle="hsl("+e+",100%,"+f+"%)";a.fillRect(c,d,1,1)}}};ColorPaletteMorph.prototype.mouseMove=function(a){this.choice=this.getPixelColor(a);this.updateTarget()};ColorPaletteMorph.prototype.mouseDownLeft=function(a){this.choice=this.getPixelColor(a);this.updateTarget()};
ColorPaletteMorph.prototype.updateTarget=function(){if(this.target instanceof Morph&&null!==this.choice)if(this.target[this.targetSetter]instanceof Function)this.target[this.targetSetter](this.choice);else this.target[this.targetSetter]=this.choice,this.target.rerender()};
ColorPaletteMorph.prototype.developersMenu=function(){var a=ColorPaletteMorph.uber.developersMenu.call(this);a.addLine();a.addItem("set target","setTarget","choose another morph\nwhose color property\n will be controlled by this one");return a};
ColorPaletteMorph.prototype.setTarget=function(){var a=this,b=this.overlappedMorphs(),c=new MenuMorph(this,"choose target:");b.push(this.world());b.forEach(function(d){c.addItem(d.toString().slice(0,50),function(){a.target=d;a.setTargetSetter()})});1===b.length?(this.target=b[0],this.setTargetSetter()):0<b.length&&c.popUpAtHand(this.world())};
ColorPaletteMorph.prototype.setTargetSetter=function(){var a=this,b=this.target.colorSetters(),c=new MenuMorph(this,"choose target property:");b.forEach(function(d){c.addItem(d,function(){return a.targetSetter=d})});1===b.length?this.targetSetter=b[0]:0<b.length&&c.popUpAtHand(this.world())};GrayPaletteMorph.prototype=new ColorPaletteMorph;GrayPaletteMorph.prototype.constructor=GrayPaletteMorph;GrayPaletteMorph.uber=ColorPaletteMorph.prototype;
function GrayPaletteMorph(a,b){this.init(a||null,b||new Point(80,10))}GrayPaletteMorph.prototype.render=function(a){var b=this.extent();this.choice=BLACK;var c=a.createLinearGradient(0,0,b.x,b.y);c.addColorStop(0,"black");c.addColorStop(1,"white");a.fillStyle=c;a.fillRect(0,0,b.x,b.y)};ColorPickerMorph.prototype=new Morph;ColorPickerMorph.prototype.constructor=ColorPickerMorph;ColorPickerMorph.uber=Morph.prototype;function ColorPickerMorph(a){this.init(a||WHITE)}
ColorPickerMorph.prototype.init=function(a){this.choice=a;ColorPickerMorph.uber.init.call(this);this.color=WHITE;this.setExtent(new Point(80,80))};
ColorPickerMorph.prototype.fixLayout=function(){this.children.forEach(function(c){return c.destroy()});this.children=[];this.feedback=new Morph;this.feedback.color=this.choice;this.feedback.setExtent(new Point(20,20));var a=new ColorPaletteMorph(this.feedback,new Point(this.width(),50));var b=new GrayPaletteMorph(this.feedback,new Point(this.width(),5));a.setPosition(this.bounds.origin);this.add(a);b.setPosition(a.bottomLeft());this.add(b);a=b.left()+Math.floor((b.width()-this.feedback.width())/2);
b=b.bottom()+Math.floor((this.bottom()-b.bottom()-this.feedback.height())/2);this.feedback.setPosition(new Point(a,b));this.add(this.feedback)};ColorPickerMorph.prototype.getChoice=function(){return this.feedback.color};ColorPickerMorph.prototype.rootForGrab=function(){return this};BlinkerMorph.prototype=new Morph;BlinkerMorph.prototype.constructor=BlinkerMorph;BlinkerMorph.uber=Morph.prototype;function BlinkerMorph(a){this.init(a)}
BlinkerMorph.prototype.init=function(a){BlinkerMorph.uber.init.call(this);this.color=new Color(0,0,0);this.fps=a||2};BlinkerMorph.prototype.step=function(){this.toggleVisibility()};CursorMorph.prototype=new BlinkerMorph;CursorMorph.prototype.constructor=CursorMorph;CursorMorph.uber=BlinkerMorph.prototype;CursorMorph.prototype.viewPadding=1;function CursorMorph(a,b){this.init(a,b)}
CursorMorph.prototype.init=function(a,b){this.keyDownEventUsed=!1;this.target=a;this.originalContents=this.target.text;this.originalAlignment=this.target.alignment;this.slot=this.target.text.length;this.textarea=b;CursorMorph.uber.init.call(this);a=fontHeight(this.target.fontSize);this.setExtent(new Point(Math.max(Math.floor(a/20),1),a));this.target instanceof TextMorph&&"left"!==this.target.alignment&&this.target.setAlignmentToLeft();this.textarea.value=this.target.text;this.textarea.style.fontSize=
this.target.fontSize+"px";this.gotoSlot(this.slot);this.updateTextAreaPosition();this.syncTextareaSelectionWith(this.target)};
CursorMorph.prototype.processKeyDown=function(a){var b=a.key,c=a.shiftKey,d=this.target instanceof StringMorph;if(!isNil(this.target.receiver)&&(a.ctrlKey||a.metaKey)){if("d"===b){a.preventDefault();this.target.doIt();return}if("i"===b){a.preventDefault();this.target.inspectIt();return}if("p"===b){a.preventDefault();this.target.showIt();return}}"Tab"===b||"U+0009"===b?(c?this.target.backTab(this.target):this.target.tab(this.target),a.preventDefault(),this.target.escalateEvent("reactToEdit",this.target)):
"Escape"===b?this.cancel():"Enter"===b&&(d||c)?this.accept():("ArrowDown"===b&&(c=this.target.downFrom(this.slot),this.textarea.setSelectionRange(c,c),a.preventDefault()),"ArrowUp"===b&&(c=this.target.upFrom(this.slot),this.textarea.setSelectionRange(c,c),a.preventDefault()),this.target.escalateEvent("reactToKeystroke",a))};
CursorMorph.prototype.processKeyUp=function(a){a=this.textarea;var b=this.target;a.selectionStart===a.selectionEnd?(b.startMark=null,b.endMark=null):"backward"===a.selectionDirection?(b.startMark=a.selectionEnd,b.endMark=a.selectionStart):(b.startMark=a.selectionStart,b.endMark=a.selectionEnd);b.fixLayout();b.rerender();this.gotoSlot(a.selectionEnd)};
CursorMorph.prototype.processInput=function(a){var b=this.target,c=this.textarea;if(b.isNumeric){var d=c.value;var e=0;var f="",g,h;for(g=0;g<d.length;g+=1){var k=d.charAt(g);if(h="0"<=k&&"9">=k||0===g&&"-"===k||"."===k&&0===e)f+=k,"."===k&&(e+=1)}d=f}else d=c.value;d.length<c.value.length&&(c.value=d,e=Math.min(c.selectionStart,d.length),c.selectionEnd=e,c.selectionStart=e);b.text=d;c.selectionStart===c.selectionEnd?(b.startMark=null,b.endMark=null):"backward"===c.selectionDirection?(b.startMark=
c.selectionEnd,b.endMark=c.selectionStart):(b.startMark=c.selectionStart,b.endMark=c.selectionEnd);b.changed();b.fixLayout();b.rerender();this.gotoSlot(c.selectionStart);this.updateTextAreaPosition();this.target.escalateEvent("reactToInput",a)};CursorMorph.prototype.updateTextAreaPosition=function(){var a=getDocumentPositionOf(this.target.world().worldCanvas);a=this.target.bounds.origin.add(new Point(a.x,a.y));this.textarea.style.top=Math.ceil(a.y)+"px";this.textarea.style.left=Math.ceil(a.x)+"px"};
CursorMorph.prototype.syncTextareaSelectionWith=function(a){var b=a.startMark;a=a.endMark;b===a?this.textarea.setSelectionRange(this.slot,this.slot,"none"):b<a?this.textarea.setSelectionRange(b,a,"forward"):this.textarea.setSelectionRange(a,b,"backward");this.textarea.focus()};
CursorMorph.prototype.gotoSlot=function(a){var b=this.target.text.length,c=this.target.slotPosition(a);this.slot=0>a?0:a>b?b:a;this.parent&&this.target.isScrollable&&(a=this.parent.right()-this.viewPadding,b=this.parent.left()+this.viewPadding,c.x>a&&(this.target.setLeft(this.target.left()+a-c.x),c.x=a),c.x<b&&(b=Math.min(this.parent.left(),b),this.target.setLeft(this.target.left()+b-c.x),c.x=b),this.target.right()<a&&a-this.target.width()<b&&(c.x+=a-this.target.right(),this.target.setRight(a)));
this.show();this.setPosition(c);this.parent&&this.parent.parent instanceof ScrollFrameMorph&&this.target.isScrollable&&this.parent.parent.scrollCursorIntoView(this)};CursorMorph.prototype.gotoPos=function(a){this.gotoSlot(this.target.slotAt(a));this.show()};
CursorMorph.prototype.updateSelection=function(a){a?isNil(this.target.endMark)&&isNil(this.target.startMark)?(this.target.startMark=this.slot,this.target.endMark=this.slot):this.target.endMark!==this.slot&&(this.target.endMark=this.slot,this.target.changed()):this.target.clearSelection()};CursorMorph.prototype.accept=function(){var a=this.root();a&&a.stopEditing();this.escalateEvent("accept",this)};
CursorMorph.prototype.cancel=function(){var a=this.root();this.undo();a&&a.stopEditing();this.escalateEvent("cancel",this)};CursorMorph.prototype.undo=function(){this.target.text=this.originalContents;this.target.changed();this.target.fixLayout();this.target.changed();this.gotoSlot(0)};CursorMorph.prototype.destroy=function(){this.target.alignment!==this.originalAlignment&&(this.target.alignment=this.originalAlignment,this.target.changed());CursorMorph.uber.destroy.call(this);this.target.world().resetKeyboardHandler()};
BoxMorph.prototype=new Morph;BoxMorph.prototype.constructor=BoxMorph;BoxMorph.uber=Morph.prototype;function BoxMorph(a,b,c){this.init(a,b,c)}BoxMorph.prototype.init=function(a,b,c){this.edge=a||4;this.border=b||(0===b?0:2);this.borderColor=c||BLACK;BoxMorph.uber.init.call(this)};
BoxMorph.prototype.render=function(a){0===this.edge&&0===this.border?BoxMorph.uber.render.call(this,a):(a.fillStyle=this.color.toString(),a.beginPath(),this.outlinePath(a,Math.max(this.edge-this.border,0),this.border),a.closePath(),a.fill(),0<this.border&&(a.lineWidth=this.border,a.strokeStyle=this.borderColor.toString(),a.beginPath(),this.outlinePath(a,this.edge,this.border/2),a.closePath(),a.stroke()))};
BoxMorph.prototype.outlinePath=function(a,b,c){var d=this.width(),e=this.height();b=Math.min(b,(Math.min(d,e)-c)/2);c=b+c;a.arc(c,c,b,radians(-180),radians(-90),!1);a.arc(d-c,c,b,radians(-90),radians(-0),!1);a.arc(d-c,e-c,b,radians(0),radians(90),!1);a.arc(c,e-c,b,radians(90),radians(180),!1)};
BoxMorph.prototype.developersMenu=function(){var a=this,b=BoxMorph.uber.developersMenu.call(this);b.addLine();b.addItem("border width...",function(){a.prompt(b.title+"\nborder\nwidth:",a.setBorderWidth,a,a.border.toString(),null,0,100,!0)},"set the border's\nline size");b.addItem("border color...",function(){a.pickColor(b.title+"\nborder color:",a.setBorderColor,a,a.borderColor)},"set the border's\nline color");b.addItem("corner size...",function(){a.prompt(b.title+"\ncorner\nsize:",a.setCornerSize,
a,a.edge.toString(),null,0,100,!0)},"set the corner's\nradius");return b};BoxMorph.prototype.setBorderWidth=function(a){"number"===typeof a?this.border=Math.max(a,0):(a=parseFloat(a),isNaN(a)||(this.border=Math.max(a,0)));this.changed()};BoxMorph.prototype.setBorderColor=function(a){a&&(this.borderColor=a,this.changed())};BoxMorph.prototype.setCornerSize=function(a){"number"===typeof a?this.edge=Math.max(a,0):(a=parseFloat(a),isNaN(a)||(this.edge=Math.max(a,0)));this.changed()};
BoxMorph.prototype.colorSetters=function(){return["color","borderColor"]};BoxMorph.prototype.numericalSetters=function(){var a=BoxMorph.uber.numericalSetters.call(this);a.push("setBorderWidth","setCornerSize");return a};SpeechBubbleMorph.prototype=new BoxMorph;SpeechBubbleMorph.prototype.constructor=SpeechBubbleMorph;SpeechBubbleMorph.uber=BoxMorph.prototype;function SpeechBubbleMorph(a,b,c,d,e,f,g,h){this.init(a,b,c,d,e,f,g,h)}
SpeechBubbleMorph.prototype.init=function(a,b,c,d,e,f,g,h){this.isPointingRight=!0;this.contents=a||"";this.padding=f||0;this.isThought=g||!1;this.isClickable=!1;SpeechBubbleMorph.uber.init.call(this,c||6,d||(0===d?0:1),e||new Color(140,140,140));this.hasShadow=!0!==h;this.noDropShadow=!0;this.fullShadowSource=!1;this.color=b||new Color(230,230,230);this.fixLayout()};
SpeechBubbleMorph.prototype.popUp=function(a,b,c){this.fixLayout();this.setPosition(b.subtract(new Point(0,this.height())));this.keepWithin(a);a.add(this);this.fullChanged();a.hand.destroyTemporaries();a.hand.temporaries.push(this);c?this.isClickable=!0:this.mouseEnter=this.destroy};
SpeechBubbleMorph.prototype.fixLayout=function(){this.contentsMorph&&this.contentsMorph.destroy();this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?this.contentsMorph=new TextMorph(this.contents,MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.setExtent(new Point(this.contents.width,this.contents.height)),this.contentsMorph.cachedImage=this.contents):this.contentsMorph=
new TextMorph(this.contents.toString(),MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center");this.add(this.contentsMorph);this.bounds.setExtent(new Point(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge),this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2));this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)));this.hasShadow&&(this.removeShadow(),this.addShadow(new Point(2,2),80))};
SpeechBubbleMorph.prototype.outlinePath=function(a,b,c){function d(h,k,l){a.moveTo(h+l,k);a.arc(h,k,l,radians(0),radians(360))}var e=b+c,f=this.width(),g=this.height();a.arc(e,e,b,radians(-180),radians(-90),!1);a.arc(f-e,e,b,radians(-90),radians(-0),!1);a.arc(f-e,g-e-b,b,radians(0),radians(90),!1);this.isThought||(this.isPointingRight?(a.lineTo(e+b,g-e),a.lineTo(b/2+c,g-c)):(a.lineTo(f-(b/2+c),g-c),a.lineTo(f-(e+b),g-e)));a.arc(e,g-e-b,b,radians(90),radians(180),!1);!0===this.isThought&&(a.lineTo(c,
e),this.isPointingRight?(e=b/4,d(e+c,g-e-c,e),e=b/3.2,d(2*e+c,g-e-2*c,e),e=b/2.8,d(3*e+2*c,g-e-4*c,e)):(e=b/4,d(f-(e+c),g-e-c,e),e=b/3.2,d(f-(2*e+c),g-e-2*c,e),e=b/2.8,d(f-(3*e+2*c),g-e-4*c,e)))};
SpeechBubbleMorph.prototype.shadowImage=function(a,b){var c=a||new Point(7,7);var d=b||new Color(0,0,0);b=this.extent();var e=this.getImage();a=newCanvas(b);var f=a.getContext("2d");f.drawImage(e,0,0);f.globalCompositeOperation="destination-out";f.drawImage(e,-c.x,-c.y);c=newCanvas(b);f=c.getContext("2d");f.drawImage(a,0,0);f.globalCompositeOperation="source-atop";f.fillStyle=d.toString();f.fillRect(0,0,b.x,b.y);return c};
SpeechBubbleMorph.prototype.shadowImageBlurred=function(a,b){a=a||new Point(7,7);var c=this.shadowBlur,d=b||new Color(0,0,0);var e=this.extent().add(2*c);b=this.getImage();e=newCanvas(e);var f=e.getContext("2d");f.shadowOffsetX=a.x;f.shadowOffsetY=a.y;f.shadowBlur=c;f.shadowColor=d.toString();f.drawImage(b,c-a.x,c-a.y);f.shadowOffsetX=0;f.shadowOffsetY=0;f.shadowBlur=0;f.globalCompositeOperation="destination-out";f.drawImage(b,c-a.x,c-a.y);return e};DialMorph.prototype=new Morph;
DialMorph.prototype.constructor=DialMorph;DialMorph.uber=Morph.prototype;function DialMorph(a,b,c,d,e){this.init(a,b,c,d,e)}DialMorph.prototype.init=function(a,b,c,d,e){this.action=this.target=null;this.min=a||0;this.max=b||360;this.value=Math.max(this.min,(c||0)%this.max);this.tick=d||15;this.fillColor=null;DialMorph.uber.init.call(this);this.color=new Color(230,230,230);this.setRadius(e||4*MorphicPreferences.menuFontSize)};
DialMorph.prototype.setRadius=function(a){this.radius=a;this.setExtent(new Point(2*this.radius,2*this.radius))};DialMorph.prototype.setValue=function(a,b,c){var d=this.max-this.min;this.value=this.min+(+(a||0)%d+d)%d;b&&(this.value=this.value<this.tick?this.min:this.value-this.value%this.tick%this.value);this.changed();c||this.updateTarget()};
DialMorph.prototype.getValueOf=function(a){var b=this.max-this.min,c=this.center(),d=a.x-c.x;a=c.y-a.y;return((.001>Math.abs(d)?0>a?90:270:Math.round((0<=d?0:180)-57.2957795131*Math.atan(a/d)))+90)/360*b+this.min};DialMorph.prototype.setExtent=function(a){a=Math.min(a.x,a.y);this.radius=a/2;DialMorph.uber.setExtent.call(this,new Point(a,a))};
DialMorph.prototype.render=function(a){var b,c=this.color.lighter().toString(),d=this.max-this.min,e=d/this.tick,f=.75*this.radius,g=.85*f,h=.95*f;a.fillStyle=c;a.beginPath();a.arc(this.radius,this.radius,f+Math.min(1,this.radius-f),0,2*Math.PI,!1);a.closePath();a.fill();a.fillStyle=this.color.toString();a.beginPath();a.arc(this.radius,this.radius,f,0,2*Math.PI,!1);a.closePath();a.fill();var k=2*(this.value-this.min)*Math.PI/d-Math.PI/2;a.fillStyle=(this.fillColor||this.color.darker()).toString();
a.beginPath();a.arc(this.radius,this.radius,f,Math.PI/-2,k,!1);a.lineTo(this.radius,this.radius);a.closePath();a.fill();a.strokeStyle=(new Color(35,35,35)).toString();a.lineWidth=1;for(b=0;b<e;b+=1){k=2*(b-3)*Math.PI/e-Math.PI/2;a.beginPath();var l=this.radius+Math.cos(k)*g;var m=this.radius+Math.sin(k)*g;var n=this.radius+Math.cos(k)*h;var q=this.radius+Math.sin(k)*h;a.moveTo(l,m);a.lineTo(n,q);a.stroke()}g=.05*f;a.fillStyle="black";a.beginPath();a.arc(this.radius,this.radius,g,0,2*Math.PI,!1);a.closePath();
a.fill();a.strokeStyle="black";a.lineWidth=1;k=2*(this.value-this.min)*Math.PI/d-Math.PI/2;h=.8*f;l=this.radius+Math.cos(k)*g;m=this.radius+Math.sin(k)*g;n=this.radius+Math.cos(k)*h;q=this.radius+Math.sin(k)*h;a.beginPath();a.moveTo(l,m);a.lineTo(n,q);a.stroke();g*=2;n=this.radius+Math.cos(k)*(h+g);q=this.radius+Math.sin(k)*(h+g);a.fillStyle="black";a.beginPath();a.arc(n,q,g,0,2*Math.PI,!1);a.closePath();a.stroke();k=2*(this.value-this.min)*Math.PI/d-Math.PI/2;l=this.radius+Math.cos(k)*f;m=this.radius+
Math.sin(k)*f;n=this.radius+Math.cos(k)*(this.radius-1);q=this.radius+Math.sin(k)*(this.radius-1);a.beginPath();a.moveTo(l,m);a.lineTo(n,q);a.lineWidth=3;a.strokeStyle=c;a.stroke();a.lineWidth=1;a.strokeStyle="black";a.stroke();k=radians(degrees(k)-4);l=this.radius+Math.cos(k)*this.radius*.9;m=this.radius+Math.sin(k)*this.radius*.9;a.beginPath();a.moveTo(l,m);k=radians(degrees(k)+8);l=this.radius+Math.cos(k)*this.radius*.9;m=this.radius+Math.sin(k)*this.radius*.9;a.lineTo(l,m);a.lineTo(n,q);a.closePath();
a.lineWidth=3;a.strokeStyle=c;a.stroke();a.lineWidth=1;a.strokeStyle="black";a.stroke();a.fill()};DialMorph.prototype.step=null;DialMorph.prototype.mouseDownLeft=function(a){var b=this,c=this.root();this.step=function(){c.hand.mouseButton?b.setValue(b.getValueOf(c.hand.bounds.origin),16!==c.currentKey):b.step=null}};
DialMorph.prototype.developersMenu=function(){var a=DialMorph.uber.developersMenu.call(this);a.addLine();a.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one");return a};
DialMorph.prototype.setTarget=function(){var a=this,b=this.overlappedMorphs(),c=new MenuMorph(this,"choose target:");b.push(this.world());b.forEach(function(d){c.addItem(d.toString().slice(0,50),function(){a.target=d;a.setTargetSetter()})});1===b.length?(this.target=b[0],this.setTargetSetter()):0<b.length&&c.popUpAtHand(this.world())};
DialMorph.prototype.setTargetSetter=function(){var a=this,b=this.target.numericalSetters(),c=new MenuMorph(this,"choose target property:");b.forEach(function(d){c.addItem(d,function(){return a.action=d})});1===b.length?this.action=b[0]:0<b.length&&c.popUpAtHand(this.world())};DialMorph.prototype.updateTarget=function(){if(this.action)if("function"===typeof this.action)this.action.call(this.target,this.value);else this.target[this.action](this.value)};CircleBoxMorph.prototype=new Morph;
CircleBoxMorph.prototype.constructor=CircleBoxMorph;CircleBoxMorph.uber=Morph.prototype;function CircleBoxMorph(a){this.init(a||"vertical")}CircleBoxMorph.prototype.init=function(a){CircleBoxMorph.uber.init.call(this);this.orientation=a;this.autoOrient=!0;this.setExtent(new Point(20,100))};CircleBoxMorph.prototype.autoOrientation=function(){this.height()>this.width()?this.orientation="vertical":this.orientation="horizontal"};
CircleBoxMorph.prototype.render=function(a){var b=this.width(),c=this.height();this.autoOrient&&this.autoOrientation();if("vertical"===this.orientation){var d=b/2;a.beginPath();a.arc(d,d,d,radians(180),radians(0),!1);a.lineTo(b,c-d);a.arc(d,c-d,d,radians(0),radians(180),!1)}else d=c/2,a.beginPath(),a.arc(d,d,d,radians(90),radians(-90),!1),a.lineTo(b-d,0),a.arc(b-d,d,d,radians(-90),radians(90),!1);a.closePath();a.fillStyle=this.color.toString();a.fill()};
CircleBoxMorph.prototype.developersMenu=function(){var a=CircleBoxMorph.uber.developersMenu.call(this);a.addLine();"vertical"===this.orientation?a.addItem("horizontal...","toggleOrientation","toggle the\norientation"):a.addItem("vertical...","toggleOrientation","toggle the\norientation");return a};
CircleBoxMorph.prototype.toggleOrientation=function(){var a=this.center();this.changed();this.orientation="vertical"===this.orientation?"horizontal":"vertical";this.setExtent(new Point(this.height(),this.width()));this.setCenter(a)};SliderButtonMorph.prototype=new CircleBoxMorph;SliderButtonMorph.prototype.constructor=SliderButtonMorph;SliderButtonMorph.uber=CircleBoxMorph.prototype;function SliderButtonMorph(a){this.init(a)}
SliderButtonMorph.prototype.init=function(a){this.color=new Color(80,80,80);this.highlightColor=new Color(90,90,140);this.pressColor=new Color(80,80,160);this.userState="normal";this.is3D=!1;this.hasMiddleDip=!0;SliderButtonMorph.uber.init.call(this,a)};SliderButtonMorph.prototype.autoOrientation=nop;
SliderButtonMorph.prototype.render=function(a){var b=this.color;"highlight"===this.userState?this.color=this.highlightColor:"pressed"===this.userState&&(this.color=this.pressColor);SliderButtonMorph.uber.render.call(this,a);!this.is3D&&MorphicPreferences.isFlat||this.renderEdges(a);this.color=b};
SliderButtonMorph.prototype.renderEdges=function(a){var b=this.width(),c=this.height();a.lineJoin="round";a.lineCap="round";if("vertical"===this.orientation){a.lineWidth=b/3;var d=a.createLinearGradient(0,0,a.lineWidth,0);d.addColorStop(0,"white");d.addColorStop(1,this.color.toString());a.strokeStyle=d;a.beginPath();a.moveTo(.5*a.lineWidth,b/2);a.lineTo(.5*a.lineWidth,c-b/2);a.stroke();d=a.createLinearGradient(b-a.lineWidth,0,b,0);d.addColorStop(0,this.color.toString());d.addColorStop(1,"black");
a.strokeStyle=d;a.beginPath();a.moveTo(b-.5*a.lineWidth,b/2);a.lineTo(b-.5*a.lineWidth,c-b/2);a.stroke();if(this.hasMiddleDip){d=a.createLinearGradient(a.lineWidth,0,b-a.lineWidth,0);var e=b/4;d.addColorStop(0,"black");d.addColorStop(.35,this.color.toString());d.addColorStop(.65,this.color.toString());d.addColorStop(1,"white");a.fillStyle=d;a.beginPath();a.arc(b/2,c/2,e,radians(0),radians(360),!1);a.closePath();a.fill()}}else"horizontal"===this.orientation&&(a.lineWidth=c/3,d=a.createLinearGradient(0,
0,0,a.lineWidth),d.addColorStop(0,"white"),d.addColorStop(1,this.color.toString()),a.strokeStyle=d,a.beginPath(),a.moveTo(c/2,.5*a.lineWidth),a.lineTo(b-c/2,.5*a.lineWidth),a.stroke(),d=a.createLinearGradient(0,c-a.lineWidth,0,c),d.addColorStop(0,this.color.toString()),d.addColorStop(1,"black"),a.strokeStyle=d,a.beginPath(),a.moveTo(c/2,c-.5*a.lineWidth),a.lineTo(b-c/2,c-.5*a.lineWidth),a.stroke(),this.hasMiddleDip&&(d=a.createLinearGradient(0,a.lineWidth,0,c-a.lineWidth),e=c/4,d.addColorStop(0,"black"),
d.addColorStop(.35,this.color.toString()),d.addColorStop(.65,this.color.toString()),d.addColorStop(1,"white"),a.fillStyle=d,a.beginPath(),a.arc(this.width()/2,this.height()/2,e,radians(0),radians(360),!1),a.closePath(),a.fill()))};SliderButtonMorph.prototype.mouseEnter=function(){this.userState="highlight";this.rerender()};SliderButtonMorph.prototype.mouseLeave=function(){this.userState="normal";this.rerender()};
SliderButtonMorph.prototype.mouseDownLeft=function(a){this.userState="pressed";this.rerender();this.escalateEvent("mouseDownLeft",a)};SliderButtonMorph.prototype.mouseClickLeft=function(){this.userState="highlight";this.rerender()};SliderButtonMorph.prototype.mouseMove=function(){nop()};SliderMorph.prototype=new CircleBoxMorph;SliderMorph.prototype.constructor=SliderMorph;SliderMorph.uber=CircleBoxMorph.prototype;
function SliderMorph(a,b,c,d,e,f){this.init(a||0,b||100,c||0,d||10,e||"vertical",f)}
SliderMorph.prototype.init=function(a,b,c,d,e,f){this.action=this.target=null;this.start=a;this.stop=b;this.value=c;this.size=d;this.offset=null;this.button=new SliderButtonMorph;this.button.isDraggable=!1;this.button.color=new Color(200,200,200);this.button.highlightColor=new Color(210,210,255);this.button.pressColor=new Color(180,180,255);this.tickMarks=[];SliderMorph.uber.init.call(this,e);this.add(this.button);this.alpha=.3;this.color=f||new Color(0,0,0);this.setExtent(new Point(20,100));this.fixLayout()};
SliderMorph.prototype.autoOrientation=nop;SliderMorph.prototype.rangeSize=function(){return this.stop-this.start};SliderMorph.prototype.ratio=function(){return this.size/(this.rangeSize()+1)};SliderMorph.prototype.unitSize=function(a){if("vertical"===this.orientation)return a=a||this.button.height(),(this.height()-a)/this.rangeSize();a=a||this.button.width();return(this.width()-a)/this.rangeSize()};
SliderMorph.prototype.fixLayout=function(){this.button.orientation=this.orientation;if("vertical"===this.orientation){var a=this.width()-2;var b=Math.max(a,Math.round(this.height()*this.ratio()));this.button.setExtent(new Point(a,b));a=1;b=Math.max(Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height()),0)}else b=this.height()-2,a=Math.max(b,Math.round(this.width()*this.ratio())),this.button.setExtent(new Point(a,b)),b=1,a=Math.max(Math.min(Math.round((this.value-
this.start)*this.unitSize()),this.width()-this.button.width()),0);this.button.setPosition((new Point(a,b)).add(this.bounds.origin));for(var c=this.tickMarks.length;c--;)a=this.tickMarks[c],"vertical"===this.orientation?(b=Math.min(Math.round((a.value-this.start)*this.unitSize(a.size)),this.height()-a.size-this.width()/2),b=Math.max(this.width()/2,b),a.setWidth(this.width()),a.setHeight(a.size),a.setPosition(new Point(this.left(),b+this.top()))):(b=Math.min(Math.round((a.value-this.start)*this.unitSize(a.size)),
this.width()-a.size-this.height()/2),b=Math.max(this.height()/2,b),a.setWidth(a.size),a.setHeight(this.height()),a.setPosition(new Point(b+this.left(),this.top())))};SliderMorph.prototype.updateValue=function(){var a="vertical"===this.orientation?this.button.top()-this.top():this.button.left()-this.left();this.value=Math.round(a/this.unitSize()+this.start);this.updateTarget()};
SliderMorph.prototype.updateTarget=function(){if(this.action)if("function"===typeof this.action)this.action.call(this.target,this.value);else this.target[this.action](this.value)};SliderMorph.prototype.addTick=function(a,b,c){var d=new Morph;c=c||2;b=b||this.color.darker();d.value=a;d.color=b;d.size=c;this.addBack(d);this.tickMarks.push(d);return d};SliderMorph.prototype.clearTicks=function(){for(var a=this.tickMarks.length;a--;)this.tickMarks[a].destroy();this.tickMarks=[];this.changed()};
SliderMorph.prototype.developersMenu=function(){var a=this,b=SliderMorph.uber.developersMenu.call(this);b.addItem("show value...","showValue","display a dialog box\nshowing the selected number");b.addItem("floor...",function(){a.prompt(b.title+"\nfloor:",a.setStart,a,a.start.toString(),null,0,a.stop-a.size,!0)},"set the minimum value\nwhich can be selected");b.addItem("ceiling...",function(){a.prompt(b.title+"\nceiling:",a.setStop,a,a.stop.toString(),null,a.start+a.size,100*a.size,!0)},"set the maximum value\nwhich can be selected");
b.addItem("button size...",function(){a.prompt(b.title+"\nbutton size:",a.setSize,a,a.size.toString(),null,1,a.stop-a.start,!0)},"set the range\ncovered by\nthe slider button");b.addLine();b.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one");return b};SliderMorph.prototype.showValue=function(){this.inform(this.value)};SliderMorph.prototype.userSetStart=function(a){this.start=Math.max(a,this.stop)};
SliderMorph.prototype.setStart=function(a,b){"number"===typeof a?this.start=Math.min(a,this.stop-this.size):(a=parseFloat(a),isNaN(a)||(this.start=Math.min(a,this.stop-this.size)));this.value=Math.max(this.value,this.start);b||this.updateTarget();this.fixLayout();this.rerender()};
SliderMorph.prototype.setStop=function(a,b){"number"===typeof a?this.stop=Math.max(a,this.start+this.size):(a=parseFloat(a),isNaN(a)||(this.stop=Math.max(a,this.start+this.size)));this.value=Math.min(this.value,this.stop);b||this.updateTarget();this.fixLayout();this.rerender()};
SliderMorph.prototype.setSize=function(a,b){"number"===typeof a?this.size=Math.min(Math.max(a,1),this.stop-this.start):(a=parseFloat(a),isNaN(a)||(this.size=Math.min(Math.max(a,1),this.stop-this.start)));this.value=Math.min(this.value,this.stop-this.size);b||this.updateTarget();this.fixLayout();this.rerender()};
SliderMorph.prototype.setTarget=function(){var a=this,b=this.overlappedMorphs(),c=new MenuMorph(this,"choose target:");b.push(this.world());b.forEach(function(d){c.addItem(d.toString().slice(0,50),function(){a.target=d;a.setTargetSetter()})});1===b.length?(this.target=b[0],this.setTargetSetter()):0<b.length&&c.popUpAtHand(this.world())};
SliderMorph.prototype.setTargetSetter=function(){var a=this,b=this.target.numericalSetters(),c=new MenuMorph(this,"choose target property:");b.forEach(function(d){c.addItem(d,function(){return a.action=d})});1===b.length?this.action=b[0]:0<b.length&&c.popUpAtHand(this.world())};SliderMorph.prototype.numericalSetters=function(){var a=SliderMorph.uber.numericalSetters.call(this);a.push("setStart","setStop","setSize");return a};SliderMorph.prototype.step=null;
SliderMorph.prototype.mouseDownLeft=function(a){var b=this;this.button.bounds.containsPoint(a)?this.offset=a.subtract(this.button.bounds.origin):this.offset=new Point;var c=this.root();this.step=function(){if(c.hand.mouseButton){var d=c.hand.bounds.origin;if("vertical"===b.orientation){var e=b.button.bounds.origin.x;var f=Math.max(Math.min(d.y-b.offset.y,b.bottom()-b.button.height()),b.top())}else f=b.button.bounds.origin.y,e=Math.max(Math.min(d.x-b.offset.x,b.right()-b.button.width()),b.left());
b.button.setPosition(new Point(e,f));b.updateValue()}else b.step=null}};MouseSensorMorph.prototype=new BoxMorph;MouseSensorMorph.prototype.constructor=MouseSensorMorph;MouseSensorMorph.uber=BoxMorph.prototype;function MouseSensorMorph(a,b,c){this.init(a,b,c)}MouseSensorMorph.prototype.init=function(a,b,c){MouseSensorMorph.uber.init.call(this);this.edge=a||4;this.border=b||2;this.color=WHITE;this.borderColor=c||BLACK;this.isTouched=!1;this.upStep=.05;this.downStep=.02};
MouseSensorMorph.prototype.touch=function(){var a=this;this.isTouched||(this.isTouched=!0,this.alpha=.6,this.step=function(){a.isTouched?1>a.alpha&&(a.alpha+=a.upStep):a.alpha>a.downStep?a.alpha-=a.downStep:(a.alpha=0,a.step=null);a.changed()})};MouseSensorMorph.prototype.unTouch=function(){this.isTouched=!1};MouseSensorMorph.prototype.mouseEnter=function(){this.touch()};MouseSensorMorph.prototype.mouseLeave=function(){this.unTouch()};MouseSensorMorph.prototype.mouseDownLeft=function(){this.touch()};
MouseSensorMorph.prototype.mouseClickLeft=function(){this.unTouch()};InspectorMorph.prototype=new BoxMorph;InspectorMorph.prototype.constructor=InspectorMorph;InspectorMorph.uber=BoxMorph.prototype;function InspectorMorph(a){this.init(a)}
InspectorMorph.prototype.init=function(a){this.target=a;this.currentProperty=null;this.showing="attributes";this.hasUserEditedDetails=this.markOwnProperties=!1;InspectorMorph.uber.init.call(this);this.isDraggable=!0;this.border=1;this.edge=MorphicPreferences.isFlat?1:5;this.color=new Color(60,60,60);this.borderColor=new Color(95,95,95);this.fps=25;this.resizer=this.buttonEdit=this.buttonSubset=this.buttonClose=this.buttonInspect=this.work=this.detail=this.list=this.label=null;this.target&&this.buildPanes();
this.setExtent(new Point(20*MorphicPreferences.handleSize,40*MorphicPreferences.handleSize/3))};InspectorMorph.prototype.setTarget=function(a){this.target=a;this.currentProperty=null;this.buildPanes()};
InspectorMorph.prototype.updateCurrentSelection=function(){var a=this.list.selected;var b=this.detail.contents.children[0];var c=this.root();c&&c.keyboardFocus instanceof CursorMorph&&c.keyboardFocus.target===b?this.hasUserEditedDetails=!0:isNil(a)||this.hasUserEditedDetails||(this.currentProperty=a=this.target[a],a=isNil(a)?"NULL":isString(a)?a:a.toString(),b.text!==a&&(b=new TextMorph(a),b.isEditable=!0,b.enableSelecting(),b.setReceiver(this.target),this.detail.setContents(b)))};
InspectorMorph.prototype.buildPanes=function(){var a=this,b=[],c;this.children.forEach(function(d){d!==a.work&&d.destroy()});this.children=[];this.label=new TextMorph(this.target.toString());this.label.fontSize=MorphicPreferences.menuFontSize;this.label.isBold=!0;this.label.color=WHITE;this.add(this.label);for(c in this.target)c&&b.push(c);"attributes"===this.showing?b=b.filter(function(d){return"function"!==typeof a.target[d]}):"methods"===this.showing&&(b=b.filter(function(d){return"function"===
typeof a.target[d]}));this.list=new ListMorph(this.target instanceof Array?b:b.sort(),null,this.markOwnProperties?[[new Color(0,0,180),function(d){return Object.prototype.hasOwnProperty.call(a.target,d)}]]:null,function(){if(isObject(a.currentProperty)){var d=a.world();var e=new InspectorMorph(a.currentProperty);e.setPosition(d.hand.position());e.keepWithin(d);d.add(e);e.changed()}});this.list.action=function(){a.hasUserEditedDetails=!1;a.updateCurrentSelection()};this.list.hBar.alpha=.6;this.list.vBar.alpha=
.6;this.list.contents.step=null;this.add(this.list);this.detail=new ScrollFrameMorph;this.detail.acceptsDrops=!1;this.detail.contents.acceptsDrops=!1;this.detail.isTextLineWrapping=!0;this.detail.color=WHITE;this.detail.hBar.alpha=.6;this.detail.vBar.alpha=.6;b=new TextMorph("");b.isEditable=!0;b.enableSelecting();b.setReceiver(this.target);this.detail.setContents(b);this.add(this.detail);null===this.work&&(this.work=new ScrollFrameMorph,this.work.acceptsDrops=!1,this.work.contents.acceptsDrops=!1,
this.work.isTextLineWrapping=!0,this.work.color=WHITE,this.work.hBar.alpha=.6,this.work.vBar.alpha=.6,b=new TextMorph(""),b.isEditable=!0,b.enableSelecting(),b.setReceiver(this.target),this.work.setContents(b));this.add(this.work);this.buttonSubset=new TriggerMorph;this.buttonSubset.labelString="show...";this.buttonSubset.createLabel();this.buttonSubset.action=function(){var d=new MenuMorph;d.addItem("attributes",function(){a.showing="attributes";a.buildPanes()});d.addItem("methods",function(){a.showing=
"methods";a.buildPanes()});d.addItem("all",function(){a.showing="all";a.buildPanes()});d.addLine();d.addItem(a.markOwnProperties?"un-mark own":"mark own",function(){a.markOwnProperties=!a.markOwnProperties;a.buildPanes()},"highlight\n'own' properties");d.popUpAtHand(a.world())};this.add(this.buttonSubset);this.buttonInspect=new TriggerMorph;this.buttonInspect.labelString="inspect...";this.buttonInspect.createLabel();this.buttonInspect.action=function(){var d,e;if(isObject(a.currentProperty)){var f=
new MenuMorph;f.addItem("in new inspector...",function(){d=a.world();e=new InspectorMorph(a.currentProperty);e.setPosition(d.hand.position());e.keepWithin(d);d.add(e);e.changed()});f.addItem("here...",function(){return a.setTarget(a.currentProperty)});f.popUpAtHand(a.world())}else a.inform((null===a.currentProperty?"null":typeof a.currentProperty)+"\nis not inspectable")};this.add(this.buttonInspect);this.buttonEdit=new TriggerMorph;this.buttonEdit.labelString="edit...";this.buttonEdit.createLabel();
this.buttonEdit.action=function(){var d=new MenuMorph(a);d.addItem("save","save","accept changes");d.addLine();d.addItem("add property...","addProperty");d.addItem("rename...","renameProperty");d.addItem("remove...","removeProperty");d.popUpAtHand(a.world())};this.add(this.buttonEdit);this.buttonClose=new TriggerMorph;this.buttonClose.labelString="close";this.buttonClose.createLabel();this.buttonClose.action=function(){return a.destroy()};this.add(this.buttonClose);this.resizer=new HandleMorph(this,
150,100,this.edge,this.edge);this.fixLayout()};
InspectorMorph.prototype.fixLayout=function(){var a=this.left()+this.edge;var b=this.top()+this.edge;var c=this.right()-this.edge;c-=a;this.label.setPosition(new Point(a,b));this.label.setWidth(c);this.label.height()>this.height()-50&&this.bounds.setHeight(this.label.height()+50);b=this.label.bottom()+2;c=Math.min(Math.floor(this.width()/3),this.list.listContents.width());c-=this.edge;var d=this.bottom()-2*this.edge-MorphicPreferences.handleSize-b;this.list.setPosition(new Point(a,b));this.list.setExtent(new Point(c,
d));a=this.list.right()+this.edge;c=this.right()-this.edge;c-=a;this.detail.setPosition(new Point(a,b));this.detail.setExtent(new Point(c,2*d/3-this.edge));b=this.detail.bottom()+this.edge;this.work.setPosition(new Point(a,b));this.work.setExtent(new Point(c,d/3));a=this.list.left();b=this.list.bottom()+this.edge;c=this.list.width();d=MorphicPreferences.handleSize;this.buttonSubset.setPosition(new Point(a,b));this.buttonSubset.setExtent(new Point(c,d));a=this.detail.left();c=this.detail.width()-this.edge-
MorphicPreferences.handleSize;c=c/3-this.edge/3;this.buttonInspect.setPosition(new Point(a,b));this.buttonInspect.setExtent(new Point(c,d));a=this.buttonInspect.right()+this.edge;this.buttonEdit.setPosition(new Point(a,b));this.buttonEdit.setExtent(new Point(c,d));a=this.buttonEdit.right()+this.edge;c=this.detail.right()-this.edge-MorphicPreferences.handleSize;c-=a;this.buttonClose.setPosition(new Point(a,b));this.buttonClose.setExtent(new Point(c,d));this.resizer.fixLayout()};
InspectorMorph.prototype.save=function(){var a=this.detail.contents.children[0].text.toString(),b=this.list.selected;try{this.target.evaluateString("this."+b+" = "+a),this.hasUserEditedDetails=!1,this.target.changed()}catch(c){this.inform(c)}};InspectorMorph.prototype.addProperty=function(){var a=this;this.prompt("new property name:",function(b){b&&(a.target[b]=null,a.buildPanes(),a.target.changed())},this,"property")};
InspectorMorph.prototype.renameProperty=function(){var a=this,b=this.list.selected;this.prompt("property name:",function(c){try{delete a.target[b],a.target[c]=a.currentProperty}catch(d){a.inform(d)}a.buildPanes();a.target.changed()},this,b)};InspectorMorph.prototype.removeProperty=function(){var a=this.list.selected;try{delete this.target[a],this.currentProperty=null,this.buildPanes(),this.target.changed()}catch(b){this.inform(b)}};
InspectorMorph.prototype.step=function(){this.updateCurrentSelection();var a=this.target.toString();this.label.text!==a&&(this.label.text=a,this.fixLayout())};InspectorMorph.prototype.updateReferences=function(a){var b=this.list.activeIndex();InspectorMorph.uber.updateReferences.call(this,a);this.buildPanes();this.list.activateIndex(b)};MenuMorph.prototype=new BoxMorph;MenuMorph.prototype.constructor=MenuMorph;MenuMorph.uber=BoxMorph.prototype;function MenuMorph(a,b,c,d){this.init(a,b,c,d)}
MenuMorph.prototype.init=function(a,b,c,d){this.target=a;this.title=b||null;this.environment=c||null;this.fontSize=d||null;this.items=[];this.world=this.label=null;this.hasFocus=this.isListContents=!1;this.submenu=this.selection=null;MenuMorph.uber.init.call(this);this.isDraggable=!1;this.noDropShadow=!0;this.fullShadowSource=!1;this.edge=this.border=null};MenuMorph.prototype.addItem=function(a,b,c,d,e,f,g,h,k){this.items.push([k?a||"close":localize(a||"close"),b||nop,c,d,e||!1,f||!1,g,h,k])};
MenuMorph.prototype.addMenu=function(a,b,c,d){this.addPair(a,b,isNil(c)?"\u25ba":c,null,d)};MenuMorph.prototype.addPair=function(a,b,c,d,e){this.addItem(a,b,d,null,null,null,null,c,e)};MenuMorph.prototype.addLine=function(a){this.items.push([0,a||1])};
MenuMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy();var a=new TextMorph(localize(this.title),this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,!0,!1,"center");a.alignment="center";a.color=WHITE;a.backgroundColor=this.borderColor;a.fixLayout();this.label=new BoxMorph(3,0);MorphicPreferences.isFlat&&(this.label.edge=0);this.label.color=this.borderColor;this.label.borderColor=this.borderColor;this.label.setExtent(a.extent().add(4));this.label.add(a);
this.label.text=a};
MenuMorph.prototype.createItems=function(){var a=this,b,c=!1;this.children.forEach(function(g){return g.destroy()});this.children=[];this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2);this.color=WHITE;this.borderColor=new Color(60,60,60);this.setExtent(new Point(0,0));var d=2;var e=this.left()+4;this.isListContents||(this.title?(this.createLabel(),this.label.setPosition(this.bounds.origin.add(4)),this.add(this.label),d=this.label.bottom()):d=this.top()+
4);d+=1;this.items.forEach(function(g){c=!1;g instanceof StringFieldMorph||g instanceof ColorPickerMorph||g instanceof SliderMorph||g instanceof DialMorph?b=g:0===g[0]?(c=!0,b=new Morph,b.color=a.borderColor,b.setHeight(g[1])):b=new MenuItemMorph(a.target,g[1],g[0],a.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,a.environment,g[2],g[3],g[4],g[5],g[6],g[7]);c&&(d+=1);b.setPosition(new Point(e,d));a.add(b);d+=b.height();c&&(d+=1)});var f=this.fullBounds();this.setExtent(f.extent().add(4));
this.adjustWidths()};
MenuMorph.prototype.maxWidth=function(){var a=0;this.parent instanceof FrameMorph&&this.parent.scrollFrame instanceof ScrollFrameMorph&&(a=this.parent.scrollFrame.width());this.children.forEach(function(b){if(b instanceof MenuItemMorph)a=Math.max(a,b.label.width()+8+(b.shortcut?b.shortcut.width()+4:0));else if(b instanceof StringFieldMorph||b instanceof ColorPickerMorph||b instanceof SliderMorph||b instanceof DialMorph)a=Math.max(a,b.width())});this.label&&(a=Math.max(a,this.label.width()));return a};
MenuMorph.prototype.adjustWidths=function(){var a=this,b=this.maxWidth();this.children.forEach(function(c){c instanceof DialMorph||c.setWidth(b);c.fixLayout();c===a.label&&c.text.setPosition(c.center().subtract(c.text.extent().floorDivideBy(2)))})};
MenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(a){a instanceof MenuItemMorph?"normal"!==a.userState&&(a.userState="normal",a.rerender()):a instanceof ScrollFrameMorph&&a.contents.children.forEach(function(b){b instanceof MenuItemMorph&&"normal"!==b.userState&&(b.userState="normal",b.rerender())})})};
MenuMorph.prototype.popup=function(a,b){this.createItems();this.setPosition(b);this.addShadow(new Point(2,2),80);this.keepWithin(a);this.bottom()>a.bottom()&&(this.removeShadow(),b=this.scroll(),this.bounds.corner.y=a.bottom()-2,this.addShadow(new Point(2,2),80),b.setHeight(a.bottom()-b.top()-6),b.adjustScrollBars());a.activeMenu&&a.activeMenu.destroy();1>this.items.length&&!this.title||(a.add(this),a.activeMenu=this,this.world=a,this.fullChanged())};
MenuMorph.prototype.scroll=function(){var a=new ScrollFrameMorph,b=this.label?1:0,c=this.children[b];a.setPosition(c.position());this.children.slice(b).forEach(function(d){return a.addContents(d)});this.add(a);a.setWidth(c.width());return a};MenuMorph.prototype.popUpAtHand=function(a){a=a||this.world;this.popup(a,a.hand.position())};MenuMorph.prototype.popUpCenteredAtHand=function(a){a=a||this.world;this.fixLayout();this.popup(a,a.hand.position().subtract(this.extent().floorDivideBy(2)))};
MenuMorph.prototype.popUpCenteredInWorld=function(a){a=a||this.world;this.fixLayout();this.popup(a,a.center().subtract(this.extent().floorDivideBy(2)))};MenuMorph.prototype.closeRootMenu=function(){this.parent instanceof MenuMorph?(this.destroy(),this.parent.closeRootMenu()):this.destroy()};MenuMorph.prototype.closeSubmenu=function(){if(this.submenu){var a=this.world.activeMenu===this.submenu;this.submenu.destroy();this.submenu=null;this.unselectAllItems();a&&(this.world.activeMenu=this)}};
MenuMorph.prototype.getFocus=function(){this.world.keyboardFocus=this;this.selection=null;this.selectFirst();this.hasFocus=!0};MenuMorph.prototype.processKeyDown=function(a){switch(a.keyCode){case 13:case 32:this.selection&&(this.selection.mouseClickLeft(),this.submenu&&this.submenu.getFocus());break;case 27:return this.destroy();case 37:return this.leaveSubmenu();case 38:return this.selectUp();case 39:return this.enterSubmenu();case 40:return this.selectDown();default:nop()}};
MenuMorph.prototype.processKeyUp=function(a){nop(a)};MenuMorph.prototype.processKeyPress=function(a){nop(a)};MenuMorph.prototype.selectFirst=function(){var a;var b=(b=detect(this.children,function(c){return c instanceof ScrollFrameMorph}))?b.contents.children:this.children;for(a=0;a<b.length;a+=1)if(b[a]instanceof MenuItemMorph){this.select(b[a]);break}};
MenuMorph.prototype.selectUp=function(){var a=detect(this.children,function(c){return c instanceof ScrollFrameMorph});a=(a?a.contents.children:this.children).filter(function(c){return c instanceof MenuItemMorph});if(this.selection){var b=a.indexOf(this.selection)-1;0>b&&(b=a.length-1);this.select(a[b])}else a.length&&this.select(a[0])};
MenuMorph.prototype.selectDown=function(){var a=detect(this.children,function(c){return c instanceof ScrollFrameMorph});a=(a?a.contents.children:this.children).filter(function(c){return c instanceof MenuItemMorph});if(this.selection){var b=a.indexOf(this.selection)+1;b>=a.length&&(b=0);this.select(a[b])}else a.length&&this.select(a[0])};MenuMorph.prototype.enterSubmenu=function(){this.selection&&this.selection.action instanceof MenuMorph&&(this.selection.popUpSubmenu(),this.submenu&&this.submenu.getFocus())};
MenuMorph.prototype.leaveSubmenu=function(){var a=this.world.activeMenu===this,b=this.parent;this.parent instanceof MenuMorph&&(b.submenu=null,b.hasFocus=!0,this.destroy(),a&&(b.world.keyboardFocus=b,b.world.activeMenu=b))};MenuMorph.prototype.select=function(a){this.unselectAllItems();a.userState="highlight";a.rerender();a.scrollIntoView();this.selection=a};
MenuMorph.prototype.destroy=function(){this.hasFocus&&(this.world.keyboardFocus=null);this.isListContents||this.world.activeMenu!==this||(this.world.activeMenu=null);MenuMorph.uber.destroy.call(this)};StringMorph.prototype=new Morph;StringMorph.prototype.constructor=StringMorph;StringMorph.uber=Morph.prototype;StringMorph.prototype.measureCtx=newCanvas().getContext("2d");function StringMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}
StringMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l){this.text=a||(""===a?"":"StringMorph");this.fontSize=b||12;this.fontName=l||MorphicPreferences.globalFontFamily;this.fontStyle=c||"sans-serif";this.isBold=d||!1;this.isItalic=e||!1;this.enableLinks=this.isEditable=!1;this.isNumeric=f||!1;this.isPassword=!1;this.shadowOffset=g||ZERO;this.shadowColor=h||null;this.isShowingBlanks=!1;this.blanksColor=new Color(180,140,140);this.isScrollable=!0;this.currentlySelecting=!1;this.endMark=this.startMark=
0;this.markedTextColor=WHITE;this.markedBackgoundColor=new Color(60,60,120);StringMorph.uber.init.call(this,!0);this.color=k||new Color(0,0,0);this.fixLayout()};StringMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'};StringMorph.prototype.password=function(a,b){var c="",d;for(d=0;d<b;d+=1)c+=a;return c};
StringMorph.prototype.font=function(){var a="";this.isBold&&(a+="bold ");this.isItalic&&(a+="italic ");return a+this.fontSize+"px "+(this.fontName?this.fontName+", ":"")+this.fontStyle};StringMorph.prototype.getShadowRenderColor=function(){return this.shadowColor};
StringMorph.prototype.fixLayout=function(a){var b=this.shadowOffset||ZERO;var c=this.isPassword?this.password("*",this.text.length):this.text;this.measureCtx.font=this.font();c=Math.max(this.measureCtx.measureText(c).width+Math.abs(b.x),1);this.bounds.corner=this.bounds.origin.add(new Point(c,fontHeight(this.fontSize)+Math.abs(b.y)));!a&&this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};
StringMorph.prototype.render=function(a){var b=this.shadowOffset||ZERO;var c=this.getShadowRenderColor();var d=this.isPassword?this.password("*",this.text.length):this.text;a.font=this.font();a.textAlign="left";a.textBaseline="bottom";if(c){var e=Math.max(b.x,0);var f=Math.max(b.y,0);a.fillStyle=c.toString();a.fillText(d,e,fontHeight(this.fontSize)+f)}e=Math.abs(Math.min(b.x,0));f=Math.abs(Math.min(b.y,0));a.fillStyle=this.getRenderColor().toString();this.isShowingBlanks?this.renderWithBlanks(a,e,
fontHeight(this.fontSize)+f):a.fillText(d,e,fontHeight(this.fontSize)+f);c=Math.min(this.startMark,this.endMark);for(b=Math.max(this.startMark,this.endMark);c<b;c+=1){var g=this.slotPosition(c).subtract(this.position());var h=d.charAt(c);a.fillStyle=this.markedBackgoundColor.toString();a.fillRect(g.x,g.y,a.measureText(h).width+1+e,fontHeight(this.fontSize)+f);a.fillStyle=this.markedTextColor.toString();a.fillText(h,g.x,fontHeight(this.fontSize)+g.y)}};
StringMorph.prototype.renderWithBlanks=function(a,b,c){var d=this,e=a.measureText(" ").width,f=this.blanksColor.toString(),g=c-this.height()/2,h=this.text.split(" "),k=b||0,l=!0;h.forEach(function(m){l||(a.fillStyle=f,a.beginPath(),a.arc(k+e/2,g,e/2,radians(0),radians(360)),a.fill(),k+=e);l=!1;""!==m&&(a.fillStyle=d.getRenderColor().toString(),a.fillText(m,k,c),k+=a.measureText(m).width)})};
StringMorph.prototype.slotPosition=function(a){var b=this.isPassword?this.password("*",this.text.length):this.text;a=Math.min(Math.max(a,0),b.length);this.measureCtx.font=this.font();this.pos=a;return new Point(this.left()+this.measureCtx.measureText(b.slice(0,a)).width,this.top())};
StringMorph.prototype.slotAt=function(a){var b=this.isPassword?this.password("*",this.text.length):this.text,c=0,d=0;for(this.measureCtx.font=this.font();a.x-this.left()>d;)if(d+=this.measureCtx.measureText(b[c]).width,c+=1,c===b.length&&this.measureCtx.measureText(b).width-this.measureCtx.measureText(b[c-1]).width/2<a.x-this.left())return c;return a.x-this.left()>d-this.measureCtx.measureText(b[c-1]).width/2?c:c-1};StringMorph.prototype.upFrom=function(a){return a};
StringMorph.prototype.downFrom=function(a){return a};StringMorph.prototype.startOfLine=function(){return 0};StringMorph.prototype.endOfLine=function(){return this.text.length};StringMorph.prototype.previousWordFrom=function(a){for(--a;0<a&&!isWordChar(this.text[a]);)--a;for(;0<a&&isWordChar(this.text[a-1]);)--a;return a};StringMorph.prototype.nextWordFrom=function(a){for(;a<this.endOfLine()&&!isWordChar(this.text[a]);)a+=1;for(;a<this.endOfLine()&&isWordChar(this.text[a]);)a+=1;return a};
StringMorph.prototype.rawHeight=function(){return this.height()/1.2};
StringMorph.prototype.developersMenu=function(){var a=this,b=StringMorph.uber.developersMenu.call(this);b.addLine();b.addItem("edit","edit");b.addItem("font size...",function(){a.prompt(b.title+"\nfont\nsize:",a.setFontSize,a,a.fontSize.toString(),null,6,500,!0)},"set this String's\nfont point size");"serif"!==this.fontStyle&&b.addItem("serif","setSerif");"sans-serif"!==this.fontStyle&&b.addItem("sans-serif","setSansSerif");this.isBold?b.addItem("normal weight","toggleWeight"):b.addItem("bold","toggleWeight");
this.isItalic?b.addItem("normal style","toggleItalic"):b.addItem("italic","toggleItalic");this.isShowingBlanks?b.addItem("hide blanks","toggleShowBlanks"):b.addItem("show blanks","toggleShowBlanks");this.isPassword?b.addItem("show characters","toggleIsPassword"):b.addItem("hide characters","toggleIsPassword");return b};StringMorph.prototype.toggleIsDraggable=function(){(this.isDraggable=!this.isDraggable)?this.disableSelecting():this.enableSelecting()};
StringMorph.prototype.toggleShowBlanks=function(){this.isShowingBlanks=!this.isShowingBlanks;this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold;this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic;this.changed();this.fixLayout();this.rerender()};
StringMorph.prototype.toggleIsPassword=function(){this.isPassword=!this.isPassword;this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.setSerif=function(){this.fontStyle="serif";this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif";this.changed();this.fixLayout();this.rerender()};
StringMorph.prototype.setFontSize=function(a){"number"===typeof a?this.fontSize=Math.round(Math.min(Math.max(a,4),500)):(a=parseFloat(a),isNaN(a)||(this.fontSize=Math.round(Math.min(Math.max(a,4),500))));this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.setText=function(a){this.text=Math.round(a).toString();this.changed();this.fixLayout();this.rerender()};StringMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]};
StringMorph.prototype.edit=function(){this.root().edit(this)};StringMorph.prototype.selection=function(){return this.text.slice(Math.min(this.startMark,this.endMark),Math.max(this.startMark,this.endMark))};StringMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)};StringMorph.prototype.clearSelection=function(){!this.currentlySelecting&&isNil(this.startMark)&&isNil(this.endMark)||(this.currentlySelecting=!1,this.endMark=this.startMark=null,this.changed())};
StringMorph.prototype.deleteSelection=function(){var a=this.text;var b=Math.min(this.startMark,this.endMark);var c=Math.max(this.startMark,this.endMark);this.text=a.slice(0,b)+a.slice(c);this.changed();this.clearSelection()};StringMorph.prototype.selectAll=function(){if(this.isEditable){this.startMark=0;var a=this.root().cursor;this.endMark=this.text.length;a&&(a.gotoSlot(this.text.length),a.syncTextareaSelectionWith(this));this.fixLayout();this.rerender()}};
StringMorph.prototype.mouseDownLeft=function(a){16===this.world().currentKey?this.shiftClick(a):this.isEditable?this.clearSelection():this.escalateEvent("mouseDownLeft",a)};StringMorph.prototype.shiftClick=function(a){var b=this.root().cursor;b&&(this.startMark||(this.startMark=b.slot),b.gotoPos(a),this.endMark=b.slot,b.syncTextareaSelectionWith(this),this.changed());this.currentlySelecting=!1;this.escalateEvent("mouseDownLeft",a)};
StringMorph.prototype.mouseClickLeft=function(a){var b;if(this.isEditable)this.currentlySelecting||this.edit(),(b=this.root().cursor)&&b.gotoPos(a),this.currentlySelecting=!0;else{var c=this.slotAt(a);c===this.text.length&&--c;for(b=c;1<b&&isURLChar(this.text[b-1]);)--b;for(;c<this.text.length-1&&isURLChar(this.text[c+1]);)c+=1;b=this.text.substring(b,c+1);isURL(b)?window.open(b,"_blank"):this.escalateEvent("mouseClickLeft",a)}};
StringMorph.prototype.mouseDoubleClick=function(a){var b=this.slotAt(a);this.isEditable?(this.edit(),b===this.text.length&&--b,this.text[b]&&isWordChar(this.text[b])?this.selectWordAt(b):this.text[b]?this.selectBetweenWordsAt(b):this.selectAll(),this.root().cursor.syncTextareaSelectionWith(this)):this.escalateEvent("mouseDoubleClick",a)};
StringMorph.prototype.selectWordAt=function(a){var b=this.root().cursor;0===a||isWordChar(this.text[a-1])?(b.gotoSlot(this.previousWordFrom(a)),this.startMark=b.slot,this.endMark=this.nextWordFrom(b.slot)):(b.gotoSlot(a),this.startMark=a,this.endMark=this.nextWordFrom(a));this.changed()};
StringMorph.prototype.selectBetweenWordsAt=function(a){var b=this.root().cursor;b.gotoSlot(this.nextWordFrom(this.previousWordFrom(a)));for(this.endMark=this.startMark=b.slot;this.endMark<this.text.length&&!isWordChar(this.text[this.endMark]);)this.endMark+=1;this.changed()};
StringMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(a){var b=this.root().cursor;b=b?b.target===this:!1;16===this.world().currentKey?this.shiftClick(a):(this.clearSelection(),this.isEditable&&!this.isDraggable&&(this.edit(),this.root().cursor.gotoPos(a),this.endMark=this.startMark=this.slotAt(a),this.currentlySelecting=!0,this.root().cursor.syncTextareaSelectionWith(this),b||this.escalateEvent("mouseDownLeft",a)))};this.mouseMove=function(a){this.isEditable&&this.currentlySelecting&&
!this.isDraggable&&(a=this.slotAt(a),a!==this.endMark&&(this.endMark=a,this.root().cursor.syncTextareaSelectionWith(this),this.changed()))}};StringMorph.prototype.disableSelecting=function(){this.mouseDownLeft=StringMorph.prototype.mouseDownLeft;delete this.mouseMove};TextMorph.prototype=new Morph;TextMorph.prototype.constructor=TextMorph;TextMorph.uber=Morph.prototype;TextMorph.prototype.measureCtx=StringMorph.prototype.measureCtx;
function TextMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}
TextMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l){this.text=a||(""===a?a:"TextMorph");this.words=[];this.lines=[];this.lineSlots=[];this.fontSize=b||12;this.fontName=h||MorphicPreferences.globalFontFamily;this.fontStyle=c||"sans-serif";this.isBold=d||!1;this.isItalic=e||!1;this.alignment=f||"left";this.shadowOffset=k||ZERO;this.shadowColor=l||null;this.maxWidth=g||0;this.maxLineWidth=0;this.backgroundColor=null;this.enableLinks=this.isEditable=!1;this.receiver=null;this.isScrollable=!0;this.currentlySelecting=
!1;this.endMark=this.startMark=0;this.markedTextColor=WHITE;this.markedBackgoundColor=new Color(60,60,120);TextMorph.uber.init.call(this);this.color=new Color(0,0,0);this.fixLayout()};TextMorph.prototype.toString=function(){return'a TextMorph("'+this.text.slice(0,30)+'...")'};TextMorph.prototype.font=StringMorph.prototype.font;
TextMorph.prototype.parse=function(){var a=this,b=this.text.split("\n"),c=this.measureCtx,d="",e,f,g=0;c.font=this.font();this.maxLineWidth=0;this.lines=[];this.lineSlots=[0];this.words=[];b.forEach(function(h){a.words=a.words.concat(h.split(" "));a.words.push("\n")});this.words.forEach(function(h){"\n"===h?(a.lines.push(d),a.lineSlots.push(g),a.maxLineWidth=Math.max(a.maxLineWidth,c.measureText(d).width),d=""):(0<a.maxWidth?(e=d+h+" ",f=c.measureText(e).width,f>a.maxWidth?(a.lines.push(d),a.lineSlots.push(g),
a.maxLineWidth=Math.max(a.maxLineWidth,c.measureText(d).width),d=h+" "):d=e):d=d+h+" ",g+=h.length+1)})};TextMorph.prototype.fixLayout=function(){this.parse();var a=Math.abs(this.shadowOffset.x);var b=Math.abs(this.shadowOffset.y);b=this.lines.length*(fontHeight(this.fontSize)+b);this.bounds=0===this.maxWidth?this.bounds.origin.extent(new Point(this.maxLineWidth+a,b)):this.bounds.origin.extent(new Point(this.maxWidth+a,b));this.parent&&this.parent.layoutChanged&&this.parent.layoutChanged()};
TextMorph.prototype.render=function(a){var b=Math.abs(this.shadowOffset.x),c=Math.abs(this.shadowOffset.y),d=this.getShadowRenderColor();a.font=this.font();a.textAlign="left";a.textBaseline="bottom";this.backgroundColor&&(a.fillStyle=this.backgroundColor.toString(),a.fillRect(0,0,this.width(),this.height()));if(d){var e=Math.max(this.shadowOffset.x,0);var f=Math.max(this.shadowOffset.y,0);a.fillStyle=d.toString();for(d=0;d<this.lines.length;d+=1){var g=this.lines[d];var h=a.measureText(g).width+b;
h="right"===this.alignment?this.width()-h:"center"===this.alignment?(this.width()-h)/2:0;var k=(d+1)*(fontHeight(this.fontSize)+c)-c;a.fillText(g,h+e,k+f)}}e=Math.abs(Math.min(this.shadowOffset.x,0));f=Math.abs(Math.min(this.shadowOffset.y,0));a.fillStyle=this.getRenderColor().toString();for(d=0;d<this.lines.length;d+=1)g=this.lines[d],h=a.measureText(g).width+b,h="right"===this.alignment?this.width()-h:"center"===this.alignment?(this.width()-h)/2:0,k=(d+1)*(fontHeight(this.fontSize)+c)-c,a.fillText(g,
h+e,k+f);d=Math.min(this.startMark,this.endMark);for(b=Math.max(this.startMark,this.endMark);d<b;d+=1)c=this.slotPosition(d).subtract(this.position()),e=this.text.charAt(d),a.fillStyle=this.markedBackgoundColor.toString(),a.fillRect(c.x,c.y,a.measureText(e).width+1,fontHeight(this.fontSize)),a.fillStyle=this.markedTextColor.toString(),a.fillText(e,c.x,c.y+fontHeight(this.fontSize))};TextMorph.prototype.getShadowRenderColor=StringMorph.prototype.getShadowRenderColor;
TextMorph.prototype.setExtent=function(a){this.maxWidth=Math.max(a.x,0);this.changed();this.fixLayout();this.rerender()};TextMorph.prototype.columnRow=function(a){var b,c;for(b=0;b<this.lines.length;b+=1){var d=this.lineSlots[b];for(c=0;c<this.lines[b].length;c+=1){if(d===a)return new Point(c,b);d+=1}}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)};
TextMorph.prototype.slotPosition=function(a){a=this.columnRow(a);var b=this.measureCtx,c=Math.abs(this.shadowOffset.y);b.font=this.font();c=a.y*(fontHeight(this.fontSize)+c);a=b.measureText(this.lines[a.y].slice(0,a.x)).width;return new Point(this.left()+a,this.top()+c)};
TextMorph.prototype.slotAt=function(a){var b=0,c=0,d;var e=Math.abs(this.shadowOffset.y);for(var f=this.measureCtx;a.y-this.top()>(fontHeight(this.fontSize)+e)*b;)b+=1;b=Math.max(b,1);f.font=this.font();e=f.measureText(this.lines[b-1]).width;e="right"===this.alignment?this.width()-e:"center"===this.alignment?(this.width()-e)/2:0;for(d=this.lines[b-1].length;c<d-2&&a.x-this.left()>e;)e+=f.measureText(this.lines[b-1][c]).width,c+=1;return a.x-this.left()>e-f.measureText(this.lines[b-1][c]).width/2?
this.lineSlots[Math.max(b-1,0)]+c:this.lineSlots[Math.max(b-1,0)]+c-1};TextMorph.prototype.upFrom=function(a){var b=this.columnRow(a);if(1>b.y)return a;a=this.lines[b.y-1];return a.length<b.x-1?this.lineSlots[b.y-1]+a.length:this.lineSlots[b.y-1]+b.x};TextMorph.prototype.downFrom=function(a){var b=this.columnRow(a);if(b.y>this.lines.length-2)return a;a=this.lines[b.y+1];return a.length<b.x-1?this.lineSlots[b.y+1]+a.length:this.lineSlots[b.y+1]+b.x};TextMorph.prototype.startOfLine=function(a){return this.lineSlots[this.columnRow(a).y]};
TextMorph.prototype.endOfLine=function(a){return this.startOfLine(a)+this.lines[this.columnRow(a).y].length-1};TextMorph.prototype.previousWordFrom=StringMorph.prototype.previousWordFrom;TextMorph.prototype.nextWordFrom=StringMorph.prototype.nextWordFrom;TextMorph.prototype.edit=StringMorph.prototype.edit;TextMorph.prototype.selection=StringMorph.prototype.selection;TextMorph.prototype.selectionStartSlot=StringMorph.prototype.selectionStartSlot;TextMorph.prototype.clearSelection=StringMorph.prototype.clearSelection;
TextMorph.prototype.deleteSelection=StringMorph.prototype.deleteSelection;TextMorph.prototype.selectAll=StringMorph.prototype.selectAll;TextMorph.prototype.mouseDownLeft=StringMorph.prototype.mouseDownLeft;TextMorph.prototype.shiftClick=StringMorph.prototype.shiftClick;TextMorph.prototype.mouseClickLeft=StringMorph.prototype.mouseClickLeft;TextMorph.prototype.mouseDoubleClick=StringMorph.prototype.mouseDoubleClick;TextMorph.prototype.selectWordAt=StringMorph.prototype.selectWordAt;
TextMorph.prototype.selectBetweenWordsAt=StringMorph.prototype.selectBetweenWordsAt;TextMorph.prototype.enableSelecting=StringMorph.prototype.enableSelecting;TextMorph.prototype.disableSelecting=StringMorph.prototype.disableSelecting;TextMorph.prototype.selectAllAndEdit=function(){this.edit();this.selectAll()};
TextMorph.prototype.developersMenu=function(){var a=this,b=TextMorph.uber.developersMenu.call(this);b.addLine();b.addItem("edit","edit");b.addItem("font size...",function(){a.prompt(b.title+"\nfont\nsize:",a.setFontSize,a,a.fontSize.toString(),null,6,100,!0)},"set this Text's\nfont point size");"left"!==this.alignment&&b.addItem("align left","setAlignmentToLeft");"right"!==this.alignment&&b.addItem("align right","setAlignmentToRight");"center"!==this.alignment&&b.addItem("align center","setAlignmentToCenter");
b.addLine();"serif"!==this.fontStyle&&b.addItem("serif","setSerif");"sans-serif"!==this.fontStyle&&b.addItem("sans-serif","setSansSerif");this.isBold?b.addItem("normal weight","toggleWeight"):b.addItem("bold","toggleWeight");this.isItalic?b.addItem("normal style","toggleItalic"):b.addItem("italic","toggleItalic");return b};TextMorph.prototype.setAlignmentToLeft=function(){this.alignment="left";this.rerender()};TextMorph.prototype.setAlignmentToRight=function(){this.alignment="right";this.rerender()};
TextMorph.prototype.setAlignmentToCenter=function(){this.alignment="center";this.rerender()};TextMorph.prototype.toggleIsDraggable=StringMorph.prototype.toggleIsDraggable;TextMorph.prototype.toggleWeight=StringMorph.prototype.toggleWeight;TextMorph.prototype.toggleItalic=StringMorph.prototype.toggleItalic;TextMorph.prototype.setSerif=StringMorph.prototype.setSerif;TextMorph.prototype.setSansSerif=StringMorph.prototype.setSansSerif;TextMorph.prototype.setText=StringMorph.prototype.setText;
TextMorph.prototype.setFontSize=StringMorph.prototype.setFontSize;TextMorph.prototype.numericalSetters=StringMorph.prototype.numericalSetters;
TextMorph.prototype.evaluationMenu=function(){var a=new MenuMorph(this,null);a.addItem("do it","doIt","evaluate the\nselected expression");a.addItem("show it","showIt","evaluate the\nselected expression\nand show the result");a.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result");a.addLine();a.addItem("select all","selectAllAndEdit");return a};TextMorph.prototype.setReceiver=function(a){this.receiver=a;this.customContextMenu=this.evaluationMenu()};
TextMorph.prototype.doIt=function(){this.receiver.evaluateString(this.selection());this.edit()};TextMorph.prototype.showIt=function(){var a=this.receiver.evaluateString(this.selection());null!==a&&this.inform(a)};TextMorph.prototype.inspectIt=function(){var a=this.receiver.evaluateString(this.selection()),b=this.world();isObject(a)&&(a=new InspectorMorph(a),a.setPosition(b.hand.position()),a.keepWithin(b),b.add(a),a.changed())};TriggerMorph.prototype=new Morph;TriggerMorph.prototype.constructor=TriggerMorph;
TriggerMorph.uber=Morph.prototype;function TriggerMorph(a,b,c,d,e,f,g,h,k,l,m){this.init(a,b,c,d,e,f,g,h,k,l,m)}
TriggerMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l,m){this.target=a||null;this.action=b||null;this.doubleClickAction=m||null;this.environment=f||null;this.labelString=c||" ";this.label=null;this.hint=g||null;this.schedule=null;this.fontSize=d||MorphicPreferences.menuFontSize;this.fontStyle=e||"sans-serif";this.highlightColor=new Color(192,192,192);this.pressColor=new Color(128,128,128);this.labelColor=h||new Color(0,0,0);this.labelBold=k||!1;this.labelItalic=l||!1;this.userState="normal";TriggerMorph.uber.init.call(this);
this.color=WHITE;this.createLabel()};TriggerMorph.prototype.render=function(a){var b=this.color;"highlight"===this.userState?this.color=this.highlightColor:"pressed"===this.userState&&(this.color=this.pressColor);TriggerMorph.uber.render.call(this,a);this.color=b};
TriggerMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy();this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic,!1,null,null,this.labelColor);this.fixLayout();this.add(this.label)};TriggerMorph.prototype.fixLayout=function(){this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2)))};
TriggerMorph.prototype.trigger=function(){this.schedule&&(this.schedule.isActive=!1);if("function"===typeof this.target)"function"===typeof this.action?this.target.call(this.environment,this.action.call(),this):this.target.call(this.environment,this.action,this);else if("function"===typeof this.action)this.action.call(this.target);else this.target[this.action]()};
TriggerMorph.prototype.triggerDoubleClick=function(){if(this.doubleClickAction)if(this.schedule&&(this.schedule.isActive=!1),"function"===typeof this.target)"function"===typeof this.doubleClickAction?this.target.call(this.environment,this.doubleClickAction.call(),this):this.target.call(this.environment,this.doubleClickAction,this);else if("function"===typeof this.doubleClickAction)this.doubleClickAction.call(this.target);else this.target[this.doubleClickAction]()};
TriggerMorph.prototype.mouseEnter=function(){var a=this.hint instanceof Function?this.hint():this.hint;this.userState="highlight";this.rerender();a&&this.bubbleHelp(a)};TriggerMorph.prototype.mouseLeave=function(){this.userState="normal";this.rerender();this.schedule&&(this.schedule.isActive=!1);this.hint&&this.world().hand.destroyTemporaries()};TriggerMorph.prototype.mouseDownLeft=function(){this.userState="pressed";this.rerender()};
TriggerMorph.prototype.mouseClickLeft=function(){this.userState="highlight";this.rerender();this.trigger()};TriggerMorph.prototype.mouseDoubleClick=function(){this.triggerDoubleClick()};TriggerMorph.prototype.rootForGrab=function(){return this.isDraggable?TriggerMorph.uber.rootForGrab.call(this):null};TriggerMorph.prototype.bubbleHelp=function(a){var b=this,c=this.world();this.schedule=new Animation(nop,nop,0,500,nop,function(){return b.popUpbubbleHelp(a)});c.animations.push(this.schedule)};
TriggerMorph.prototype.popUpbubbleHelp=function(a){(new SpeechBubbleMorph(localize(a),null,null,1)).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))};MenuItemMorph.prototype=new TriggerMorph;MenuItemMorph.prototype.constructor=MenuItemMorph;MenuItemMorph.uber=TriggerMorph.prototype;function MenuItemMorph(a,b,c,d,e,f,g,h,k,l,m,n){this.shortcutString=n||null;this.shortcut=null;this.init(a,b,c,d,e,f,g,h,k,l,m)}
MenuItemMorph.prototype.createLabel=function(){this.label&&this.label.destroy();this.label=this.createLabelPart(this.labelString);this.add(this.label);var a=this.label.width();var b=this.label.height();this.shortcut&&this.shortcut.destroy();this.shortcutString&&(this.shortcut=this.createLabelPart(this.shortcutString),a+=this.shortcut.width()+4,b=Math.max(b,this.shortcut.height()),this.add(this.shortcut));this.setExtent(new Point(a+8,b))};
MenuItemMorph.prototype.fixLayout=function(){var a=this.center();this.label.setCenter(a);this.label.setLeft(this.left()+4);this.shortcut&&(this.shortcut.setCenter(a),this.shortcut.setRight(this.right()-4))};
MenuItemMorph.prototype.createLabelPart=function(a){if(isString(a))return this.createLabelString(a);if(a instanceof Array){var b=new Morph;b.alpha=0;var c=this.createIcon(a[0]);b.add(c);a=this.createLabelString(a[1]);b.add(a);a.setCenter(c.center());a.setLeft(c.right()+4);b.bounds=c.bounds.merge(a.bounds);b.rerender();return b}return this.createIcon(a)};
MenuItemMorph.prototype.createIcon=function(a){if(a instanceof Morph)return a.fullCopy();var b=new Morph;b.isCachingImage=!0;b.cachedImage=a;b.bounds.setWidth(a.width);b.bounds.setHeight(a.height);return b};MenuItemMorph.prototype.createLabelString=function(a){a=new TextMorph(a,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic);a.setColor(this.labelColor);return a};
MenuItemMorph.prototype.mouseEnter=function(){var a=this.parentThatIsA(MenuMorph);this.isShowingSubmenu()||(a&&a.closeSubmenu(),this.isListItem()||(this.userState="highlight",this.rerender()),this.action instanceof MenuMorph?this.delaySubmenu():this.hint&&this.bubbleHelp(this.hint))};MenuItemMorph.prototype.mouseLeave=function(){this.isListItem()||(this.isShowingSubmenu()?this.userState="highlight":this.userState="normal",this.rerender());this.schedule&&(this.schedule.isActive=!1);this.hint&&this.world().hand.destroyTemporaries()};
MenuItemMorph.prototype.mouseDownLeft=function(a){this.isListItem()&&(this.parentThatIsA(MenuMorph).unselectAllItems(),this.escalateEvent("mouseDownLeft",a));this.userState="pressed";this.rerender()};MenuItemMorph.prototype.mouseMove=function(){this.isListItem()&&this.escalateEvent("mouseMove")};MenuItemMorph.prototype.mouseClickLeft=function(){this.action instanceof MenuMorph?this.popUpSubmenu():(this.isListItem()||(this.parentThatIsA(MenuMorph).closeRootMenu(),this.world().activeMenu=null),this.trigger())};
MenuItemMorph.prototype.isListItem=function(){var a=this.parentThatIsA(MenuMorph);return a?a.isListContents:!1};MenuItemMorph.prototype.isSelectedListItem=function(){return this.isListItem()?"pressed"===this.userState:!1};MenuItemMorph.prototype.isShowingSubmenu=function(){var a=this.parentThatIsA(MenuMorph);return a&&this.action instanceof MenuMorph?a.submenu===this.action:!1};
MenuItemMorph.prototype.delaySubmenu=function(){var a=this,b=this.world();this.schedule=new Animation(nop,nop,0,500,nop,function(){return a.popUpSubmenu()});b.animations.push(this.schedule)};
MenuItemMorph.prototype.popUpSubmenu=function(){var a=this.parentThatIsA(MenuMorph),b=this.world();if(this.action instanceof MenuMorph&&(this.action.createItems(),this.action.setPosition(this.topRight().subtract(new Point(0,5))),this.action.addShadow(new Point(2,2),80),this.action.keepWithin(this.world()),!(1>this.action.items.length)||this.action.title)){if(this.action.bottom()>b.bottom()){this.action.removeShadow();var c=this.action.scroll();this.action.bounds.corner.y=b.bottom()-2;this.action.addShadow(new Point(2,
2),80);c.setHeight(b.bottom()-c.top()-6);c.adjustScrollBars()}a.add(this.action);a.submenu=this.action;a.submenu.world=a.world;this.action.fullChanged()}};FrameMorph.prototype=new Morph;FrameMorph.prototype.constructor=FrameMorph;FrameMorph.uber=Morph.prototype;function FrameMorph(a){this.init(a)}FrameMorph.prototype.init=function(a){this.scrollFrame=a||null;FrameMorph.uber.init.call(this);this.color=new Color(255,250,245);this.acceptsDrops=!0;this.scrollFrame&&(this.isDraggable=!1,this.alpha=0)};
FrameMorph.prototype.fullBounds=function(){var a=this.getShadow();return null!==a?this.bounds.merge(a.bounds):this.bounds};FrameMorph.prototype.fullImage=function(){return this.getImage()};FrameMorph.prototype.fullDrawOn=function(a,b){var c;if(this.isVisible){var d=this.bounds.intersect(b);d.extent().gt(ZERO)&&(this.drawOn(a,d),this.children.forEach(function(e){e instanceof ShadowMorph?c=e:e.fullDrawOn(a,d)}),c&&c.drawOn(a,b))}};
FrameMorph.prototype.topMorphAt=function(a){var b,c;if(!this.isVisible||!this.bounds.containsPoint(a))return null;for(b=this.children.length-1;0<=b;--b)if(c=this.children[b].topMorphAt(a))return c;return this.isFreeForm?this.isTransparentAt(a)?null:this:this};FrameMorph.prototype.submorphBounds=function(){var a=null;0<this.children.length&&(a=this.children[0].bounds,this.children.forEach(function(b){a=a.merge(b.fullBounds())}));return a};
FrameMorph.prototype.keepInScrollFrame=function(){if(null===this.scrollFrame)return null;this.left()>this.scrollFrame.left()&&this.moveBy(new Point(this.scrollFrame.left()-this.left(),0));this.right()<this.scrollFrame.right()&&this.moveBy(new Point(this.scrollFrame.right()-this.right(),0));this.top()>this.scrollFrame.top()&&this.moveBy(new Point(0,this.scrollFrame.top()-this.top()));this.bottom()<this.scrollFrame.bottom()&&this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))};
FrameMorph.prototype.adjustBounds=function(){var a=this;if(null!==this.scrollFrame){var b=(b=this.submorphBounds())&&!this.scrollFrame.isTextLineWrapping?b.expandBy(this.scrollFrame.padding).growBy(this.scrollFrame.growth).merge(this.scrollFrame.bounds):this.scrollFrame.bounds.copy();this.bounds.eq(b)||(this.bounds=b,this.keepInScrollFrame());this.scrollFrame.isTextLineWrapping&&this.children.forEach(function(c){c instanceof TextMorph&&(c.setWidth(a.width()),a.setHeight(Math.max(c.height(),a.scrollFrame.height())))});
this.scrollFrame.adjustScrollBars()}};FrameMorph.prototype.reactToDropOf=function(){this.adjustBounds()};FrameMorph.prototype.reactToGrabOf=function(){this.adjustBounds()};FrameMorph.prototype.developersMenu=function(){var a=FrameMorph.uber.developersMenu.call(this);0<this.children.length&&(a.addLine(),a.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"));return a};FrameMorph.prototype.keepAllSubmorphsWithin=function(){var a=this;this.children.forEach(function(b){return b.keepWithin(a)})};
ScrollFrameMorph.prototype=new FrameMorph;ScrollFrameMorph.prototype.constructor=ScrollFrameMorph;ScrollFrameMorph.uber=FrameMorph.prototype;function ScrollFrameMorph(a,b,c){this.init(a,b,c)}
ScrollFrameMorph.prototype.init=function(a,b,c){var d=this;ScrollFrameMorph.uber.init.call(this);this.scrollBarSize=b||MorphicPreferences.scrollBarSize;this.autoScrollTrigger=null;this.hasVelocity=this.isScrollingByDragging=this.enableAutoScrolling=!0;this.growth=this.padding=0;this.isTextLineWrapping=!1;this.contents=a||new FrameMorph(this);this.add(this.contents);this.hBar=new SliderMorph(null,null,null,null,"horizontal",c);this.hBar.setHeight(this.scrollBarSize);this.hBar.action=function(e){d.contents.setPosition(new Point(d.left()-
e,d.contents.position().y))};this.hBar.isDraggable=!1;this.add(this.hBar);this.vBar=new SliderMorph(null,null,null,null,"vertical",c);this.vBar.setWidth(this.scrollBarSize);this.vBar.action=function(e){d.contents.setPosition(new Point(d.contents.position().x,d.top()-e))};this.vBar.isDraggable=!1;this.add(this.vBar);this.toolBar=null};
ScrollFrameMorph.prototype.adjustScrollBars=function(){var a=this.width()-this.scrollBarSize,b=this.height()-this.scrollBarSize;this.changed();this.contents.width()>this.width()?(this.hBar.show(),this.hBar.width()!==a&&this.hBar.setWidth(a),this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height())),this.hBar.start=0,this.hBar.stop=this.contents.width()-this.width()+this.scrollBarSize,this.hBar.size=this.width()/this.contents.width()*this.hBar.stop,this.hBar.value=this.left()-this.contents.left(),
this.hBar.fixLayout()):this.hBar.hide();this.contents.height()>this.height()?(this.vBar.show(),this.vBar.height()!==b&&this.vBar.setHeight(b),this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top())),this.vBar.start=0,this.vBar.stop=this.contents.height()-this.height()+this.scrollBarSize,this.vBar.size=this.height()/this.contents.height()*this.vBar.stop,this.vBar.value=this.top()-this.contents.top(),this.vBar.fixLayout()):this.vBar.hide();this.adjustToolBar()};
ScrollFrameMorph.prototype.adjustToolBar=function(){this.toolBar&&(this.toolBar.setTop(this.top()+3),this.toolBar.setRight((this.vBar.isVisible?this.vBar.left():this.right())-3))};ScrollFrameMorph.prototype.addContents=function(a){this.contents.add(a);this.contents.adjustBounds()};ScrollFrameMorph.prototype.setContents=function(a){this.contents.children.forEach(function(b){return b.destroy()});this.contents.children=[];a.setPosition(this.position().add(this.padding+2));this.addContents(a)};
ScrollFrameMorph.prototype.setExtent=function(a){this.isTextLineWrapping&&this.contents.setPosition(this.position().copy());ScrollFrameMorph.uber.setExtent.call(this,a);this.contents.adjustBounds()};ScrollFrameMorph.prototype.scrollX=function(a){var b=this.contents.left(),c=this.left(),d=this.contents.width(),e=this.right();this.vBar.isVisible&&(e-=this.scrollBarSize);a=b+a;a+d<e&&(a=e-d);a>c&&(a=c);a!==b&&this.contents.setLeft(a)};
ScrollFrameMorph.prototype.scrollY=function(a){var b=this.contents.top(),c=this.top(),d=this.contents.height(),e=this.bottom();this.hBar.isVisible&&(e-=this.scrollBarSize);a=b+a;a+d<e&&(a=e-d);a>c&&(a=c);a!==b&&this.contents.setTop(a)};ScrollFrameMorph.prototype.step=nop;
ScrollFrameMorph.prototype.mouseDownLeft=function(a){var b=this;if(!this.isScrollingByDragging)return null;var c=this.root().hand,d=a,e=0,f=0;this.step=function(){if(c.mouseButton&&0===c.children.length&&b.bounds.containsPoint(c.bounds.origin)){if(c.grabPosition&&c.grabPosition.distanceTo(c.position())<=MorphicPreferences.grabThreshold)return null;var g=c.bounds.origin;e=g.x-d.x;0!==e&&b.scrollX(e);f=g.y-d.y;0!==f&&b.scrollY(f);d=g}else b.hasVelocity?.5>Math.abs(e)&&.5>Math.abs(f)?b.step=nop:(e*=
.8,b.scrollX(Math.round(e)),f*=.8,b.scrollY(Math.round(f))):b.step=nop;b.adjustScrollBars()}};ScrollFrameMorph.prototype.startAutoScrolling=function(){var a=this,b=3*MorphicPreferences.scrollBarSize,c=this.world(),d,e;if(!c)return null;var f=c.hand;this.autoScrollTrigger||(this.autoScrollTrigger=Date.now());this.step=function(){e=f.bounds.origin;d=a.bounds.insetBy(b);a.bounds.containsPoint(e)&&!d.containsPoint(e)&&0<f.children.length?a.autoScroll(e):(a.step=nop,a.autoScrollTrigger=null)}};
ScrollFrameMorph.prototype.autoScroll=function(a){if(500>Date.now()-this.autoScrollTrigger)return null;var b=3*MorphicPreferences.scrollBarSize;var c=this.topLeft().extent(new Point(this.width(),b));c.containsPoint(a)&&this.scrollY(b-(a.y-this.top()));c=this.topLeft().extent(new Point(b,this.height()));c.containsPoint(a)&&this.scrollX(b-(a.x-this.left()));c=(new Point(this.right()-b,this.top())).extent(new Point(b,this.height()));c.containsPoint(a)&&this.scrollX(-(b-(this.right()-a.x)));c=(new Point(this.left(),
this.bottom()-b)).extent(new Point(this.width(),b));c.containsPoint(a)&&this.scrollY(-(b-(this.bottom()-a.y)));this.adjustScrollBars()};
ScrollFrameMorph.prototype.scrollCursorIntoView=function(a){var b=a.target,c=b.position().subtract(this.contents.position()),d=this.top()+this.padding,e=this.bottom()-this.padding;this.contents.setExtent(b.extent().add(c).add(this.padding));a.top()<d?(this.contents.setTop(this.contents.top()+d-a.top()),a.setTop(d)):a.bottom()>e&&(this.contents.setBottom(this.contents.bottom()+e-a.bottom()),a.setBottom(e));this.adjustScrollBars()};
ScrollFrameMorph.prototype.mouseScroll=function(a,b){a&&this.scrollY(a*MorphicPreferences.mouseScrollAmount);b&&this.scrollX(b*MorphicPreferences.mouseScrollAmount);this.adjustScrollBars()};
ScrollFrameMorph.prototype.updateReferences=function(a){var b=this;ScrollFrameMorph.uber.updateReferences.call(this,a);this.hBar&&(this.hBar.action=function(c){b.contents.setPosition(new Point(b.left()-c,b.contents.position().y))});this.vBar&&(this.vBar.action=function(c){b.contents.setPosition(new Point(b.contents.position().x,b.top()-c))})};
ScrollFrameMorph.prototype.developersMenu=function(){var a=ScrollFrameMorph.uber.developersMenu.call(this);this.isTextLineWrapping?a.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff"):a.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping");return a};ScrollFrameMorph.prototype.toggleTextLineWrapping=function(){this.isTextLineWrapping=!this.isTextLineWrapping};ListMorph.prototype=new ScrollFrameMorph;
ListMorph.prototype.constructor=ListMorph;ListMorph.uber=ScrollFrameMorph.prototype;function ListMorph(a,b,c,d,e){this.init(a||[],b||function(f){return isString(f)?f:f.toSource?f.toSource():f.toString()},c||[],d,e)}
ListMorph.prototype.init=function(a,b,c,d,e){ListMorph.uber.init.call(this);this.contents.acceptsDrops=!1;this.color=WHITE;this.hBar.alpha=.6;this.vBar.alpha=.6;this.elements=a||[];this.labelGetter=b;this.format=c;this.action=this.active=this.selected=this.listContents=null;this.doubleClickAction=d||null;this.separator=e||"";this.acceptsDrops=!1;this.buildListContents()};
ListMorph.prototype.buildListContents=function(){var a=this;this.listContents&&this.listContents.destroy();this.listContents=new MenuMorph(this.select,null,this);0===this.elements.length&&(this.elements=["(empty)"]);this.elements.forEach(function(b){var c=null,d=!1,e=!1;a.format.forEach(function(g){g[1].call(null,b)&&("bold"===g[0]?d=!0:"italic"===g[0]?e=!0:c=g[0])});var f=a.labelGetter(b);f===a.separator?a.listContents.addLine():a.listContents.addItem(f,b,null,c,d,e,a.doubleClickAction)});this.listContents.isListContents=
!0;this.listContents.createItems();this.listContents.setPosition(this.contents.position());this.addContents(this.listContents)};ListMorph.prototype.select=function(a,b){isNil(a)||(this.selected=a,this.active=b,this.action&&this.action.call(null,a))};
ListMorph.prototype.setExtent=function(a){var b=this.listContents.bounds,c=this.bounds.origin.copy().corner(this.bounds.origin.add(a));c.right()>b.right()&&c.width()<=b.width()&&this.listContents.setRight(c.right());c.bottom()>b.bottom()&&c.height()<=b.height()&&this.listContents.setBottom(c.bottom());ListMorph.uber.setExtent.call(this,a)};ListMorph.prototype.activeIndex=function(){return this.listContents.children.indexOf(this.active)};
ListMorph.prototype.activateIndex=function(a){if(a=this.listContents.children[a])a.userState="pressed",a.rerender(),a.trigger()};StringFieldMorph.prototype=new FrameMorph;StringFieldMorph.prototype.constructor=StringFieldMorph;StringFieldMorph.uber=FrameMorph.prototype;function StringFieldMorph(a,b,c,d,e,f,g){this.init(a||"",b||100,c||12,d||"sans-serif",e||!1,f||!1,g)}
StringFieldMorph.prototype.init=function(a,b,c,d,e,f,g){this.defaultContents=a;this.minWidth=b;this.fontSize=c;this.fontStyle=d;this.isBold=e;this.isItalic=f;this.isNumeric=g||!1;this.text=null;StringFieldMorph.uber.init.call(this);this.color=WHITE;this.isEditable=!0;this.acceptsDrops=!1;this.createText()};
StringFieldMorph.prototype.createText=function(){var a=this.text?this.string():this.defaultContents;this.text=null;this.children.forEach(function(b){return b.destroy()});this.children=[];this.text=new StringMorph(a,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric);this.text.isNumeric=this.isNumeric;this.text.setPosition(this.bounds.origin.copy());this.text.isEditable=this.isEditable;this.text.isDraggable=!1;this.text.enableSelecting();this.setExtent(new Point(Math.max(this.width(),
this.minWidth),this.text.height()));this.add(this.text)};StringFieldMorph.prototype.string=function(){return this.text.text};StringFieldMorph.prototype.mouseClickLeft=function(a){this.isEditable?this.text.edit():this.escalateEvent("mouseClickLeft",a)};BouncerMorph.prototype=new Morph;BouncerMorph.prototype.constructor=BouncerMorph;BouncerMorph.uber=Morph.prototype;function BouncerMorph(){this.init()}
BouncerMorph.prototype.init=function(a,b){BouncerMorph.uber.init.call(this);this.fps=50;this.isStopped=!1;this.type=a||"vertical";this.direction="vertical"===this.type?"down":"right";this.speed=b||1};BouncerMorph.prototype.moveUp=function(){this.moveBy(new Point(0,-this.speed))};BouncerMorph.prototype.moveDown=function(){this.moveBy(new Point(0,this.speed))};BouncerMorph.prototype.moveRight=function(){this.moveBy(new Point(this.speed,0))};
BouncerMorph.prototype.moveLeft=function(){this.moveBy(new Point(-this.speed,0))};
BouncerMorph.prototype.step=function(){this.isStopped||("vertical"===this.type?("down"===this.direction?this.moveDown():this.moveUp(),this.fullBounds().top()<this.parent.top()&&"up"===this.direction&&(this.direction="down"),this.fullBounds().bottom()>this.parent.bottom()&&"down"===this.direction&&(this.direction="up")):"horizontal"===this.type&&("right"===this.direction?this.moveRight():this.moveLeft(),this.fullBounds().left()<this.parent.left()&&"left"===this.direction&&(this.direction="right"),
this.fullBounds().right()>this.parent.right()&&"right"===this.direction&&(this.direction="left")))};HandMorph.prototype=new Morph;HandMorph.prototype.constructor=HandMorph;HandMorph.uber=Morph.prototype;function HandMorph(a){this.init(a)}
HandMorph.prototype.init=function(a){HandMorph.uber.init.call(this,!0);this.bounds=new Rectangle;this.world=a;this.mouseButton=null;this.mouseOverList=[];this.mouseOverBounds=[];this.grabOrigin=this.grabPosition=this.morphToGrab=null;this.temporaries=[];this.touchHoldTimeout=null;this.contextMenuEnabled=!1;this.cachedFullBounds=this.cachedFullImage=null};HandMorph.prototype.changed=function(){if(null!==this.world){var a=this.cachedFullBounds||this.fullBounds();a.extent().eq(ZERO)||this.world.broken.push(a.spread())}};
HandMorph.prototype.moveBy=function(a){var b=this.children,c=b.length;this.changed();this.bounds=this.bounds.translateBy(a);this.cachedFullBounds&&(this.cachedFullBounds=this.cachedFullBounds.translateBy(a));this.changed();for(c;0<c;--c)b[c-1].moveBy(a)};HandMorph.prototype.fullChanged=HandMorph.prototype.changed;
HandMorph.prototype.fullDrawOn=function(a,b){if(this.cachedFullBounds){b=b.intersect(this.cachedFullBounds);var c=this.cachedFullBounds.origin;if(b.extent().gt(ZERO)){a.save();a.globalAlpha=this.alpha;var d=this.cachedFullImage;var e=b.translateBy(c.neg());var f=e.left();var g=e.top();c=Math.min(e.width(),d.width-f);e=Math.min(e.height(),d.height-g);1>c||1>e||(a.drawImage(d,f,g,c,e,b.left(),b.top(),c,e),a.restore())}}else HandMorph.uber.fullDrawOn.call(this,a,b)};
HandMorph.prototype.morphAtPointer=function(){return this.world.topMorphAt(this.bounds.origin)||this.world};HandMorph.prototype.allMorphsAtPointer=function(){var a=this;return this.world.allChildren().filter(function(b){return b.isVisible&&b.visibleBounds().containsPoint(a.bounds.origin)&&!b.holes.some(function(c){return c.translateBy(b.position()).containsPoint(a.bounds.origin)})})};HandMorph.prototype.dropTargetFor=function(a){for(var b=this.morphAtPointer();!b.wantsDropOf(a);)b=b.parent;return b};
HandMorph.prototype.grab=function(a){var b=a.parent;if(a instanceof WorldMorph)return null;0===this.children.length&&(this.world.stopEditing(),this.grabOrigin=a.situation(),a.noDropShadow||a.addShadow(),a.prepareToBeGrabbed&&a.prepareToBeGrabbed(this),this.add(a),this.cachedFullImage=a.fullImage(),this.cachedFullBounds=a.fullBounds(),this.changed(),b&&b.reactToGrabOf&&b.reactToGrabOf(a))};
HandMorph.prototype.drop=function(){this.alpha=1;if(0!==this.children.length){var a=this.children[0];var b=this.dropTargetFor(a);b=b.selectForEdit?b.selectForEdit():b;this.changed();b.add(a);a.changed();this.cachedFullBounds=this.cachedFullImage=null;a.noDropShadow||a.removeShadow();this.children=[];this.setExtent(new Point);a.justDropped&&a.justDropped(this);b.reactToDropOf&&b.reactToDropOf(a,this)}};
HandMorph.prototype.processMouseDown=function(a){var b=getDocumentPositionOf(this.world.worldCanvas);a.pageX&&this.setPosition(new Point(a.pageX-b.x,a.pageY-b.y));this.destroyTemporaries();this.contextMenuEnabled=!0;this.grabPosition=this.morphToGrab=null;if(0!==this.children.length)this.drop(),this.mouseButton=null;else{b=this.morphAtPointer();this.world.activeMenu&&(contains(b.allParents(),this.world.activeMenu)?clearInterval(this.touchHoldTimeout):this.world.activeMenu.destroy());this.world.activeHandle&&
b!==this.world.activeHandle&&this.world.activeHandle.destroy();this.world.cursor&&b!==this.world.cursor.target&&this.world.stopEditing();b.mouseMove||(this.morphToGrab=b.rootForGrab(),this.grabPosition=this.bounds.origin.copy());2===a.button||a.ctrlKey?(this.mouseButton="right",a="mouseDownRight"):(this.mouseButton="left",a="mouseDownLeft");for(;!b[a];)b=b.parent;b[a](this.bounds.origin)}};
HandMorph.prototype.processTouchStart=function(a){var b=this;MorphicPreferences.isTouchDevice=!0;clearInterval(this.touchHoldTimeout);1===a.touches.length&&(this.touchHoldTimeout=setInterval(function(){b.processMouseDown({button:2});b.processMouseUp({button:2});a.preventDefault();clearInterval(b.touchHoldTimeout)},400),this.processMouseMove(a.touches[0]),this.processMouseDown({button:0}),a.preventDefault())};
HandMorph.prototype.processTouchMove=function(a){MorphicPreferences.isTouchDevice=!0;1===a.touches.length&&(this.processMouseMove(a.touches[0]),clearInterval(this.touchHoldTimeout))};HandMorph.prototype.processTouchEnd=function(a){MorphicPreferences.isTouchDevice=!0;clearInterval(this.touchHoldTimeout);nop(a);this.processMouseUp({button:0})};
HandMorph.prototype.processMouseUp=function(){var a=this.morphAtPointer(),b;this.destroyTemporaries();if(0!==this.children.length)this.drop();else{if("left"===this.mouseButton)var c="mouseClickLeft";else if(c="mouseClickRight",this.mouseButton&&this.contextMenuEnabled){var d=a;for(b=d.contextMenu();!b&&d.parent;)d=d.parent,b=d.contextMenu();b&&b.popUpAtHand(this.world)}for(;!a[c];)a=a.parent;a[c](this.bounds.origin)}this.mouseButton=null};
HandMorph.prototype.processDoubleClick=function(){var a=this.morphAtPointer();this.destroyTemporaries();if(0!==this.children.length)this.drop();else{for(;a&&!a.mouseDoubleClick;)a=a.parent;a&&a.mouseDoubleClick(this.bounds.origin)}this.mouseButton=null};
HandMorph.prototype.processMouseMove=function(a){var b=this,c=getDocumentPositionOf(this.world.worldCanvas);a=new Point(a.pageX-c.x,a.pageY-c.y);this.setPosition(a);var d=this.morphAtPointer().allParents();var e=d.filter(function(g){return g.isVisible&&g.visibleBounds().containsPoint(b.bounds.origin)&&!g.holes.some(function(h){return h.translateBy(g.position()).containsPoint(b.bounds.origin)})});if(!this.children.length&&this.mouseButton){var f=this.morphAtPointer();c=f.rootForGrab();f.mouseMove&&
(f.mouseMove(a,this.mouseButton),"right"===this.mouseButton&&(this.contextMenuEnabled=!1));"left"===this.mouseButton&&this.morphToGrab&&this.grabPosition.distanceTo(this.bounds.origin)>MorphicPreferences.grabThreshold&&(this.setPosition(this.grabPosition),this.morphToGrab.isDraggable?(c=this.morphToGrab.selectForEdit?this.morphToGrab.selectForEdit():this.morphToGrab,this.grab(c)):this.morphToGrab.isTemplate&&(this.world.stopEditing(),c=this.morphToGrab.fullCopy(),c.isTemplate=!1,c.isDraggable=!0,
c.reactToTemplateCopy&&c.reactToTemplateCopy(),this.grab(c),this.grabOrigin=this.morphToGrab.situation()),this.setPosition(a))}this.mouseOverBounds.forEach(function(g){contains(e,g)||g.mouseLeaveBounds&&g.mouseLeaveBounds(b.children[0])});e.forEach(function(g){contains(b.mouseOverBounds,g)||g.mouseEnterBounds&&g.mouseEnterBounds(b.children[0])});this.mouseOverList.forEach(function(g){contains(d,g)||(g.mouseLeave&&g.mouseLeave(),g.mouseLeaveDragging&&b.mouseButton&&g.mouseLeaveDragging(b.children[0]))});
d.forEach(function(g){contains(b.mouseOverList,g)||(g.mouseEnter&&g.mouseEnter(),g.mouseEnterDragging&&b.mouseButton&&g.mouseEnterDragging(b.children[0]));0<b.children.length&&g instanceof ScrollFrameMorph&&g.enableAutoScrolling&&g.contents.allChildren().some(function(h){return h.wantsDropOf(b.children[0])})&&(g.bounds.insetBy(3*MorphicPreferences.scrollBarSize).containsPoint(b.bounds.origin)||g.startAutoScrolling())});this.mouseOverList=d;this.mouseOverBounds=e};
HandMorph.prototype.processMouseScroll=function(a){for(var b=this.morphAtPointer();b&&!b.mouseScroll;)b=b.parent;b&&b.mouseScroll(a.detail/-3||(Object.prototype.hasOwnProperty.call(a,"wheelDeltaY")?a.wheelDeltaY/120:a.wheelDelta/120),a.wheelDeltaX/120||0)};
HandMorph.prototype.processDrop=function(a){function b(r){for(var u=new Image,v=new FileReader;!m.droppedSVG;)m=m.parent;u.onload=function(){return m.droppedSVG(u,r.name)};v=new FileReader;v.onloadend=function(w){return u.src=w.target.result};v.readAsDataURL(r)}function c(r){for(var u=new Image,v=new FileReader;!m.droppedImage;)m=m.parent;u.onload=function(){q=newCanvas(new Point(u.width,u.height),!0);q.getContext("2d").drawImage(u,0,0);m.droppedImage(q,r.name)};v=new FileReader;v.onloadend=function(w){return u.src=
w.target.result};v.readAsDataURL(r)}function d(r){for(var u=new Audio,v=new FileReader;!m.droppedAudio;)m=m.parent;v.onloadend=function(w){u.src=w.target.result;m.droppedAudio(u,r.name)};v.readAsDataURL(r)}function e(r){for(var u=new FileReader;!m.droppedText;)m=m.parent;u.onloadend=function(v){m.droppedText(v.target.result,r.name,r.type)};u.readAsText(r)}function f(r){for(var u=new FileReader;!m.droppedBinary;)m=m.parent;u.onloadend=function(v){m.droppedBinary(v.target.result,r.name)};u.readAsArrayBuffer(r)}
function g(r,u){var v=new XMLHttpRequest;v.open("GET",r);v.onreadystatechange=function(){if(4===v.readyState)if(v.responseText)u(v.responseText);else throw Error("unable to retrieve "+r);};v.send()}function h(r){var u="";var v=r.indexOf('<img src="');if(-1===v)return null;for(v+=10;v<r.length;v+=1){var w=r[v];if('"'===w)return u;u=u.concat(w)}return null}var k=a instanceof FileList?a:a.target.files||a.dataTransfer.files,l=a.dataTransfer?a.dataTransfer.getData("URL"):null;a=a.dataTransfer?a.dataTransfer.getData("Text/HTML"):
null;var m=this.morphAtPointer(),n=new Image,q,p;if(0<k.length)for(p=0;p<k.length;p+=1){a=k[p];var t=a.name.slice(a.name.lastIndexOf(".")+1).toLowerCase();-1===a.type.indexOf("svg")||MorphicPreferences.rasterizeSVGs?0===a.type.indexOf("image")?c(a):0===a.type.indexOf("audio")||-1<a.type.indexOf("ogg")?d(a):0===a.type.indexOf("text")||contains(["txt","csv","json"],t)?e(a):f(a):b(a)}else if(l)if(t=l.slice(l.lastIndexOf(".")+1).toLowerCase(),contains(["gif","png","jpg","jpeg","bmp"],t)){for(;!m.droppedImage;)m=
m.parent;n=new Image;n.onload=function(){q=newCanvas(new Point(n.width,n.height),!0);q.getContext("2d").drawImage(n,0,0);m.droppedImage(q)};n.src=l}else{if("svg"===t&&!MorphicPreferences.rasterizeSVGs){for(;!m.droppedSVG;)m=m.parent;g(l,function(r){var u=new Image;u.onload=function(){m.droppedSVG(u,l.slice(l.lastIndexOf("/")+1,l.lastIndexOf(".")))};u.src="data:image/svg+xml;utf8,"+encodeURIComponent(r)})}}else if(a){for(;!m.droppedImage;)m=m.parent;n=new Image;n.onload=function(){q=newCanvas(new Point(n.width,
n.height),!0);q.getContext("2d").drawImage(n,0,0);m.droppedImage(q)};if(k=h(a))n.src=k}};HandMorph.prototype.destroyTemporaries=function(){var a=this;this.temporaries.forEach(function(b){b.isClickable&&b.bounds.containsPoint(a.position())||(b.destroy(),a.temporaries.splice(a.temporaries.indexOf(b),1))})};WorldMorph.prototype=new FrameMorph;WorldMorph.prototype.constructor=WorldMorph;WorldMorph.uber=FrameMorph.prototype;WorldMorph.prototype.customMorphs=[];function WorldMorph(a,b){this.init(a,b)}
WorldMorph.prototype.init=function(a,b){WorldMorph.uber.init.call(this);this.color=new Color(205,205,205);this.alpha=1;this.bounds=new Rectangle(0,0,a.width,a.height);this.isVisible=!0;this.isDraggable=!1;this.currentKey=null;this.worldCanvas=a;for(this.stamp=Date.now();this.stamp===Date.now();)nop();this.stamp=Date.now();this.useFillPage=b;void 0===this.useFillPage&&(this.useFillPage=!0);this.isDevMode=!1;this.broken=[];this.animations=[];this.hand=new HandMorph(this);this.activeHandle=this.activeMenu=
this.lastEditedText=this.cursor=this.keyboardFocus=this.keyboardHandler=null;this.initKeyboardHandler();this.resetKeyboardHandler();this.initEventListeners()};WorldMorph.prototype.fullDrawOn=function(a,b){WorldMorph.uber.fullDrawOn.call(this,a,b);this.hand.fullDrawOn(a,b)};WorldMorph.prototype.updateBroken=function(){var a=this,b=this.worldCanvas.getContext("2d");this.condenseDamages();this.broken.forEach(function(c){c.extent().gt(ZERO)&&a.fullDrawOn(b,c)});this.broken=[]};
WorldMorph.prototype.stepAnimations=function(){this.animations.forEach(function(a){return a.step()});this.animations=this.animations.filter(function(a){return a.isActive})};
WorldMorph.prototype.condenseDamages=function(){function a(c){var d=[],e=c.length,f=function(l){return l.isNearTo(k,20)},g,h;for(h=0;h<e;h+=1){var k=c[h];(g=detect(d,f))?g.mergeWith(k):d.push(k)}return d}function b(c){var d=c[0].origin.x,e=c[0].origin.y,f=c[0].corner.x,g=c[0].corner.y,h=c.length,k;for(k=1;k<h;k+=1){var l=c[k];d=Math.min(d,l.origin.x);e=Math.min(e,l.origin.y);f=Math.max(f,l.corner.x);g=Math.max(g,l.corner.y)}return new Rectangle(d,e,f,g)}this.broken=1E3<this.broken.length?[b(this.broken)]:
a(this.broken)};WorldMorph.prototype.doOneCycle=function(){this.stepFrame();this.stepAnimations();this.updateBroken()};
WorldMorph.prototype.fillPage=function(){var a=this,b=window.innerHeight,c=window.innerWidth;this.worldCanvas.style.position="absolute";this.worldCanvas.style.left="0px";this.worldCanvas.style.right="0px";this.worldCanvas.style.width="100%";this.worldCanvas.style.height="100%";document.documentElement.scrollTop&&(b=document.documentElement.clientHeight);document.documentElement.scrollLeft&&(c=document.documentElement.clientWidth);this.worldCanvas.width!==c&&(this.worldCanvas.width=c,this.setWidth(c));
this.worldCanvas.height!==b&&(this.worldCanvas.height=b,this.setHeight(b));this.children.forEach(function(d){d.reactToWorldResize&&d.reactToWorldResize(a.bounds.copy())})};WorldMorph.prototype.getGlobalPixelColor=function(a){a=this.worldCanvas.getContext("2d").getImageData(a.x,a.y,1,1).data;return new Color(a[0],a[1],a[2])};
WorldMorph.prototype.initKeyboardHandler=function(){var a=document.getElementById("morphic_keyboard");a?this.keyboardHandler=a:(a=document.createElement("textarea"),a.setAttribute("id","morphic_keyboard"),a.setAttribute("style","caret-color:transparent;"),a.style.position="absolute",a.style.overflow="hidden",a.style.border="none",a.style.resize="none",a.wrap="off",a.world=this,a.style.zIndex=-1,a.autofocus=!0,document.body.appendChild(a),this.keyboardHandler=a,a.addEventListener("keydown",function(b){a.world.currentKey=
b.keyCode;a.world.activeMenu&&!a.world.activeMenu.hasFocus&&(a.world.stopEditing(),a.world.activeMenu.getFocus());a.world.keyboardFocus&&a.world.keyboardFocus.processKeyDown&&a.world.keyboardFocus.processKeyDown(b);9===b.keyCode&&(a.world.keyboardFocus&&a.world.keyboardFocus.processKeyPress&&a.world.keyboardFocus.processKeyPress(b),b.preventDefault());(b.ctrlKey||b.metaKey)&&"dfips".includes(b.key)&&b.preventDefault()},!0),a.addEventListener("keyup",function(b){a.world.currentKey=null;a.world.keyboardFocus&&
a.world.keyboardFocus.processKeyUp&&a.world.keyboardFocus.processKeyUp(b);b.preventDefault()},!1),a.addEventListener("keypress",function(b){a.world.keyboardFocus&&a.world.keyboardFocus.processKeyPress&&(a.world.keyboardFocus.processKeyPress(b),b.preventDefault())},!1),a.addEventListener("input",function(b){a.world.keyboardFocus&&a.world.keyboardFocus.processInput?(a.world.currentKey=null,a.world.keyboardFocus.processInput(b)):a.world.keyboardHandler.value="";b.preventDefault()},!1))};
WorldMorph.prototype.resetKeyboardHandler=function(a){var b=getDocumentPositionOf(this.worldCanvas);a||(this.keyboardHandler.value="");this.keyboardHandler.style.top=Math.ceil(b.y)+"px";this.keyboardHandler.style.left=Math.ceil(b.x)+"px"};
WorldMorph.prototype.initEventListeners=function(){var a=this,b=this.worldCanvas;this.useFillPage?this.fillPage():this.changed();b.addEventListener("mousedown",function(c){c.preventDefault();a.keyboardHandler.world=a;a.resetKeyboardHandler(!0);a.onNextStep||(a.keyboardHandler.blur(),a.onNextStep=function(){return a.keyboardHandler.focus()});a.hand.processMouseDown(c)},!0);b.addEventListener("touchstart",function(c){return a.hand.processTouchStart(c)},!1);b.addEventListener("mouseup",function(c){c.preventDefault();
a.hand.processMouseUp(c)},!1);b.addEventListener("dblclick",function(c){c.preventDefault();a.hand.processDoubleClick(c)},!1);b.addEventListener("touchend",function(c){return a.hand.processTouchEnd(c)},!1);b.addEventListener("mousemove",function(c){return a.hand.processMouseMove(c)},!1);b.addEventListener("touchmove",function(c){return a.hand.processTouchMove(c)},{passive:!0});b.addEventListener("contextmenu",function(c){return c.preventDefault()},!0);b.addEventListener("mousewheel",function(c){a.hand.processMouseScroll(c);
c.preventDefault()},!1);b.addEventListener("DOMMouseScroll",function(c){a.hand.processMouseScroll(c);c.preventDefault()},!1);window.addEventListener("dragover",function(c){return c.preventDefault()},!0);window.addEventListener("drop",function(c){a.hand.processDrop(c);c.preventDefault()},!1);window.addEventListener("resize",function(){a.useFillPage&&a.fillPage()},!1);window.onbeforeunload=function(c){if(c=c||window.event)c.returnValue="Are you sure you want to leave?";return"Are you sure you want to leave?"}};
WorldMorph.prototype.mouseDownLeft=nop;WorldMorph.prototype.mouseClickLeft=nop;WorldMorph.prototype.mouseDownRight=nop;WorldMorph.prototype.mouseClickRight=nop;WorldMorph.prototype.wantsDropOf=function(){return this.acceptsDrops};WorldMorph.prototype.droppedImage=function(){return null};WorldMorph.prototype.droppedSVG=function(){return null};WorldMorph.prototype.nextTab=function(a){var b=this.nextEntryField(a);b&&(a.clearSelection(),b.selectAll(),b.edit())};
WorldMorph.prototype.previousTab=function(a){var b=this.previousEntryField(a);b&&(a.clearSelection(),b.selectAll(),b.edit())};
WorldMorph.prototype.contextMenu=function(){var a=this;var b=this.isDevMode?new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]):new MenuMorph(this,"Morphic");this.isDevMode&&(b.addItem("demo...","userCreateMorph","sample morphs"),b.addLine(),b.addItem("hide all...","hideAll"),b.addItem("show all...","showAllHiddens"),b.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"),b.addItem("inspect...","inspect","open a window on\nall properties"),
b.addItem("screenshot...",function(){return window.open(a.fullImage().toDataURL())},"open a new window\nwith a picture of this morph"),b.addLine(),b.addItem("restore display","changed","redraw the\nscreen once"),b.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizing"),useBlurredShadows?b.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers"):b.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers"),
b.addItem("color...",function(){a.pickColor(b.title+localize("\ncolor:"),a.setColor,a,a.color)},"choose the World's\nbackground color"),MorphicPreferences===standardSettings?b.addItem("touch screen settings","togglePreferences","bigger menu fonts\nand sliders"):b.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders"),MorphicPreferences.showHoles?b.addItem("hide holes","toggleHolesDisplay","debug untouchable regions"):b.addItem("show holes","toggleHolesDisplay","debug untouchable regions"),
b.addLine());this.isDevMode?b.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus"):b.addItem("development mode...","toggleDevMode");b.addItem("about morphic.js...","about");return b};
WorldMorph.prototype.userCreateMorph=function(){function a(f){f=f.fullCopy();f.isDraggable=!0;f.pickUp(c)}var b=this,c=this,d;var e=new MenuMorph(this,"make a morph");e.addItem("rectangle",function(){return a(new Morph)});e.addItem("box",function(){return a(new BoxMorph)});e.addItem("circle box",function(){return a(new CircleBoxMorph)});e.addLine();e.addItem("slider",function(){return a(new SliderMorph)});e.addItem("dial",function(){d=new DialMorph;d.pickUp(b)});e.addItem("frame",function(){d=new FrameMorph;
d.setExtent(new Point(350,250));a(d)});e.addItem("scroll frame",function(){d=new ScrollFrameMorph;d.contents.acceptsDrops=!0;d.contents.adjustBounds();d.setExtent(new Point(350,250));a(d)});e.addItem("handle",function(){return a(new HandleMorph)});e.addLine();e.addItem("string",function(){d=new StringMorph("Hello, World!");d.isEditable=!0;a(d)});e.addItem("text",function(){d=new TextMorph("Ich wei\u00df nicht, was soll es bedeuten, dass ich so traurig bin, ein M\u00e4rchen aus uralten Zeiten, das kommt mir nicht aus dem Sinn. Die Luft ist k\u00fchl und es dunkelt, und ruhig flie\u00dft der Rhein; der Gipfel des Berges funkelt im Abendsonnenschein. Die sch\u00f6nste Jungfrau sitzet dort oben wunderbar, ihr gold'nes Geschmeide blitzet, sie k\u00e4mmt ihr goldenes Haar, sie k\u00e4mmt es mit goldenem Kamme, und singt ein Lied dabei; das hat eine wundersame, gewalt'ge Melodei. Den Schiffer im kleinen Schiffe, ergreift es mit wildem Weh; er schaut nicht die Felsenriffe, er schaut nur hinauf in die H\u00f6h'. Ich glaube, die Wellen verschlingen am Ende Schiffer und Kahn, und das hat mit ihrem Singen, die Loreley getan.");
d.isEditable=!0;d.maxWidth=300;d.fixLayout();a(d)});e.addItem("speech bubble",function(){d=new SpeechBubbleMorph("Hello, World!");a(d)});e.addLine();e.addItem("gray scale palette",function(){return a(new GrayPaletteMorph)});e.addItem("color palette",function(){return a(new ColorPaletteMorph)});e.addItem("color picker",function(){return a(new ColorPickerMorph)});e.addLine();e.addItem("sensor demo",function(){d=new MouseSensorMorph;d.setColor(new Color(230,200,100));d.edge=35;d.border=15;d.borderColor=
new Color(200,100,50);d.alpha=.2;d.setExtent(new Point(100,100));a(d)});e.addItem("animation demo",function(){var f=new BouncerMorph;f.setPosition(new Point(50,20));f.setExtent(new Point(300,200));f.alpha=.9;f.speed=3;var g=new BouncerMorph;g.setColor(new Color(50,50,50));g.setPosition(new Point(80,80));g.setExtent(new Point(80,250));g.type="horizontal";g.direction="right";g.alpha=.9;g.speed=5;var h=new BouncerMorph;h.setColor(new Color(20,20,20));h.setPosition(new Point(90,140));h.setExtent(new Point(40,
30));h.type="horizontal";h.direction="right";h.speed=3;var k=new BouncerMorph;k.setColor(new Color(200,20,20));k.setPosition(new Point(90,140));k.setExtent(new Point(20,20));k.type="vertical";k.direction="up";k.speed=8;var l=new BouncerMorph;l.setColor(new Color(20,200,20));l.setPosition(new Point(120,140));l.setExtent(new Point(20,20));l.type="vertical";l.direction="down";l.speed=4;g.add(k);g.add(h);f.add(l);f.add(g);a(f)});e.addItem("pen",function(){return a(new PenMorph)});this.customMorphs.length&&
(e.addLine(),this.customMorphs.forEach(function(f){if(f instanceof Array){var g=new MenuMorph;f[1].forEach(function(h){return g.addItem(h,function(){return a(h instanceof Array?h[0]:h)})});e.addMenu(f[0],g)}else e.addItem(f.toString(),function(){return a(f)})}));e.popUpAtHand(this)};WorldMorph.prototype.toggleDevMode=function(){this.isDevMode=!this.isDevMode};WorldMorph.prototype.hideAll=function(){this.children.forEach(function(a){return a.hide()})};
WorldMorph.prototype.showAllHiddens=function(){this.forAllChildren(function(a){a.isVisible||a.show()})};WorldMorph.prototype.about=function(){var a="",b;for(b in modules)Object.prototype.hasOwnProperty.call(modules,b)&&(a+="\n"+b+" ("+modules[b]+")");""!==a&&(a="\n\nmodules:\n\nmorphic ("+morphicVersion+")"+a);this.inform("morphic.js\n\na lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\n\nwritten by Jens M\u00f6nig\njens@moenig.org"+a)};
WorldMorph.prototype.edit=function(a){if(this.lastEditedText!==a){isNil(this.lastEditedText)||this.stopEditing();if(!a.isEditable)return null;this.cursor&&this.cursor.destroy();this.worldCanvas.focus();this.keyboardHandler.focus();this.keyboardFocus=this.cursor=new CursorMorph(a,this.keyboardHandler);a.parent.add(this.cursor);MorphicPreferences.useSliderForInput&&(a.parentThatIsA(MenuMorph)||this.slide(a));this.lastEditedText!==a&&a.escalateEvent("freshTextEdit",a);this.lastEditedText=a}};
WorldMorph.prototype.slide=function(a){var b=parseFloat(a.text);isNaN(b)&&(b=0);var c=new MenuMorph;b=new SliderMorph(b-25,b+25,b,10,"horizontal");b.alpha=1;b.color=new Color(225,225,225);b.button.color=c.borderColor;b.button.highlightColor=b.button.color.copy();b.button.highlightColor.b+=100;b.button.pressColor=b.button.color.copy();b.button.pressColor.b+=150;b.setExtent(new Point(10*MorphicPreferences.scrollBarSize,MorphicPreferences.menuFontSize));b.action=function(d){a.changed();a.text=Math.round(d).toString();
a.fixLayout();a.rerender();a.escalateEvent("reactToSliderEdit",a)};c.items.push(b);c.popup(this,a.bottomLeft().add(new Point(0,5)))};WorldMorph.prototype.stopEditing=function(){this.cursor&&(this.cursor.target.escalateEvent("reactToEdit",this.cursor.target),this.cursor.target.clearSelection(),this.cursor.destroy(),this.cursor=null);this.keyboardFocus&&this.keyboardFocus.stopEditing&&this.keyboardFocus.stopEditing();this.lastEditedText=this.keyboardFocus=null};
WorldMorph.prototype.toggleBlurredShadows=function(){useBlurredShadows=!useBlurredShadows};WorldMorph.prototype.togglePreferences=function(){MorphicPreferences=MorphicPreferences===standardSettings?touchScreenSettings:standardSettings};WorldMorph.prototype.toggleHolesDisplay=function(){MorphicPreferences.showHoles=!MorphicPreferences.showHoles;this.rerender()};
(function(a){function b(g){this.name=g}var c=function(){this.ide=null;this.registry=[];this.pendingExtensions=[]};c.prototype.initialize=function(g){var h=this;this.ide=g;this.pendingExtensions.forEach(function(k){return h.load(k)});this.pendingExtensions=[]};c.prototype.load=function(g){var h=this;g=new g(this.ide);if(!this.isLoaded(g.name)){try{this.validate(g)}catch(k){this.ide.showMessage('Unable to load extension "'+g.name+'": '+k.message);return}this.registry.push(g);this.ide.controlBar.extensionsButton.show();
g.getCategories().forEach(function(k){return h.registerCategory(k)});this.ide.createCategories();this.ide.createCorralBar();this.ide.fixLayout();SpriteMorph.prototype.initBlocks()}};c.prototype.register=function(g){this.isReady()?this.load(g):this.pendingExtensions.push(g)};c.prototype.isReady=function(){return!!this.ide};c.prototype.validate=function(g){var h=this,k=g.getPalette();g.getBlocks().forEach(function(l){if(SpriteMorph.prototype[l.name]||StageMorph.prototype[l.name]||Process.prototype[l.name])throw Error('Cannot override existing "'+
l.name+'" block');h.findWatcherReceivers(k,l.name).forEach(function(m){if(!l.receivers.includes(m))throw Error('Cannot add a watcher toggle for "'+l.spec+'" on '+m.name+'. Did you forget to add ".for('+(m.name+')" when defining the block?'));})})};c.prototype.isLoaded=function(g){return this.registry.find(function(h){return h.name===g})};c.prototype.registerCategory=function(g){var h=g.name;g=g.color;SpriteMorph.prototype.categories.splice(SpriteMorph.prototype.categories.length-3,0,h);SpriteMorph.prototype.blockColor[h]=
g};c.prototype.getPaletteContents=function(g,h){return this.registry.flatMap(function(k){return k.getPalette()}).filter(function(k){return k.isVisible(g,h)}).flatMap(function(k){return k.contents})};c.prototype.findWatcherReceivers=function(g,h){return g.filter(function(k){return k.contents.find(function(l){return"watcher"===l.type&&l.name===h})}).map(function(k){return k.targetObject}).reduce(function(k,l){k.includes(l)||k.push(l);return k},[])};c.prototype.initBlocks=function(){var g=this,h=this.registry.flatMap(function(l){return l.getBlocks()}),
k=this.registry.flatMap(function(l){return l.getPalette()});h.forEach(function(l){SpriteMorph.prototype.blocks[l.name]={type:l.type,category:l.category,spec:l.spec};var m=g.findWatcherReceivers(k,l.name);m.forEach(function(n){if(!l.receivers.includes(n))throw Error("Cannot add a watcher toggle for "+l.spec+" on "+n.name+'. Did you forget to add ".for('+(n.name+')" when defining the block?'));});0===m.length&&m.push(Process);m.forEach(function(n){return n.prototype[l.name]=l.impl})})};b.prototype.getMenu=
function(){return null};b.prototype.getCategories=function(){return[]};b.prototype.getBlocks=function(){return[]};b.prototype.getPalette=function(){return[]};var d=function(g,h,k){this.category=g;this.contents=h;this.targetObject=k};d.prototype.isVisible=function(g,h){return this.category===h&&(!this.targetObject||g instanceof this.targetObject)};var e=function(g,h,k,l,m,n){m=void 0===m?[]:m;this.name=g;this.type=h;this.category=k;this.spec=l;this.defaults=m;this.impl=n;this.receivers=[]};e.prototype.for=
function(g){for(var h=[],k=0;k<arguments.length;++k)h[k-0]=arguments[k];this.receivers=h;return this};var f=function(g){this.name=g;this.type="block"};f.prototype.withWatcherToggle=function(){this.type="watcher";return this};b.PaletteCategory=d;b.Palette={};b.Palette.Block=f;b.Palette.Space={name:"-",type:"space"};b.Palette.BigSpace={name:"=",type:"space"};b.Block=e;b.Category=function(g,h){h=void 0===h?new Color(120,120,120):h;this.name=g;this.color=h};a.Extension=b;a.ExtensionRegistry=c;a.NetsBloxExtensions=
new c})(this);modules.locale="2020-August-05";var SnapTranslator=new Localizer;function localize(a){return SnapTranslator.translate(a)}function Localizer(a,b){this.language=a||"en";this.dict=b||{}}Localizer.prototype.translate=function(a){return Object.prototype.hasOwnProperty.call(this.dict[this.language],a)?this.dict[this.language][a]:a};Localizer.prototype.languages=function(){var a,b=[];for(a in this.dict)Object.prototype.hasOwnProperty.call(this.dict,a)&&b.push(a);return b.sort()};
Localizer.prototype.languageName=function(a){return this.dict[a].language_name||a};Localizer.prototype.credits=function(){var a=this,b="";this.languages().forEach(function(c){b=b+"\n"+a.languageName(c)+" ("+c+") - "+a.dict[c].language_translator+" - "+a.dict[c].last_changed});return b};
Localizer.prototype.unload=function(){var a=this,b,c=["language_name","language_translator","last_changed"];this.languages().forEach(function(d){var e;if("en"!==d)for(e in b=a.dict[d],b)Object.prototype.hasOwnProperty.call(b,e)&&!contains(c,e)&&delete b[e]})};
SnapTranslator.dict.en={language_name:"English",language_translator:"Jens M\u00f6nig","translator_e-mail":"jens@moenig.org",last_changed:"2020-07-09",__shout__go__:"green flag clicked",any:"random","length of %s":"length of text %s","file menu import hint":"load an exported project file\nor block library, a costume\nor a sound","settings menu prefer empty slots hint":"check to focus on empty slots\nwhen dragging & dropping reporters","costumes tab help":"import a picture from another web page or from\na file on your computer by dropping it here\n",
"block deletion dialog text":"Are you sure you want to delete this\ncustom block and all its instances?","download to disk text":"This item could not be opened in a new tab.\nIt has been saved to your browser's downloads folder.","unable to export text":"This item could not be exported from Snap!.\nIt's likely that your project may contain a lot of media (sounds and images) or that you are using an older browser.Please try using a recent version of Chrome, Firefox, or Safari."};
SnapTranslator.dict.de={language_name:"Deutsch",language_translator:"Jens M\u00f6nig, Jadga H\u00fcgle","translator_e-mail":"jens@moenig.org, jadga.huegle@sap.com",last_changed:"2020-07-24"};SnapTranslator.dict.it={language_name:"Italiano",language_translator:"Stefano Federici, Alberto Firpo, Massimo Ghisalberti","translator_e-mail":"s_federici@yahoo.com, albertofirpo12@gmail.com, zairik@gmail.com",last_changed:"2016-05-10"};
SnapTranslator.dict.ja={language_name:"\u65e5\u672c\u8a9e",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2020-07-03"};SnapTranslator.dict.ja_HIRA={language_name:"\u306b\u307b\u3093\u3054",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2018-10-23"};SnapTranslator.dict.ko={language_name:"\ud55c\uad6d\uc5b4",language_translator:"Yunjae Jang","translator_e-mail":"janggoons@gmail.com",last_changed:"2015-01-21"};
SnapTranslator.dict.pt={language_name:"Portugu\u00eas",language_translator:"Manuel Menezes de Sequeira","translator_e-mail":"mmsequeira@gmail.com",last_changed:"2020-08-03"};SnapTranslator.dict.cs={language_name:"\u010cesky",language_translator:"Michal Moc, Jan Tomsa","translator_e-mail":"info@iguru.eu, jan.tomsa.1976@gmail.com",last_changed:"2015-11-16"};
SnapTranslator.dict.zh_CN={language_name:"\u7b80\u4f53\u4e2d\u6587",language_translator:"\u4e94\u767e\u5200/\u9093\u6c5f\u534e/\u66f9\u5112\u6797","translator_e-mail":"ubertao@qq.com/djh@rhjxx.cn",last_changed:"2020-07-03"};SnapTranslator.dict.eo={language_name:"Esperanto",language_translator:"Sebastian Cyprych","translator_e-mail":"sebacyp(heliko)gmail(punkto)com",last_changed:"2017-10-01"};
SnapTranslator.dict.fr={language_name:"Fran\u00e7ais",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2019-06-25"};SnapTranslator.dict.si={language_name:"Sloven\u0161\u010dina",language_translator:"Sasa Divjak, Gorazd Breskvar","translator_e-mail":"sasa.divjak@fri.uni-lj.si",last_changed:"2016-04-22"};
SnapTranslator.dict.ru={language_name:"\u0420\u0443\u0441\u0441\u043a\u0438\u0439",language_translator:"Svetlana Ptashnaya, \u041f\u0440\u043e\u0441\u043a\u0443\u0440\u043d\u0451\u0432 \u0410\u0440\u0442\u0451\u043c","translator_e-mail":"svetlanap@berkeley.edu, tema@school830.ru",last_changed:"2018-02-05"};
SnapTranslator.dict.es={language_name:"Espa\u00f1ol",language_translator:"V\u00edctor Manuel Muratalla Morales / Cristi\u00e1n Rizzi Iribarren / Alfonso Ruzafa","translator_e-mail":"victor.muratalla@yahoo.com / rizzi.cristian@gmail.com",last_changed:"2019-06-25"};SnapTranslator.dict.nl={language_name:"Nederlands",language_translator:"Sjoerd Dirk Meijer, Frank Sierens, Jan-Gerard van der Toorn","translator_e-mail":"sjoerddirk@fromScratchEd.nl, frank.sierens@telenet.be, jg.2019@xs4all.nl",last_changed:"2017-09-01"};
SnapTranslator.dict.pl={language_name:"Polski",language_translator:"Witek Kranas & deKrain","translator_e-mail":"witek@oeiizk.waw.pl",last_changed:"2017-11-09"};SnapTranslator.dict.zh_TW={language_name:"\u7e41\u9ad4\u4e2d\u6587",language_translator:"cch","translator_e-mail":"cchuang2009@gmail.com",last_changed:"2013-8-14"};SnapTranslator.dict.no={language_name:"Norsk",language_translator:"Olav A Marschall","translator_e-mail":"mattebananer@gmail.com",last_changed:"2013-09-16"};
SnapTranslator.dict.dk={language_name:"Dansk",language_translator:"FAB, Pelle Hjek","translator_e-mail":"fab@nielsen.mail.dk, hjek@mail.com",last_changed:"2016-11-16"};SnapTranslator.dict.el={language_name:"\u0395\u03bb\u03bb\u03b7\u03bd\u03b9\u03ba\u03ac",language_translator:"Ino Samaras , Alexandros Prekates","translator_e-mail":"ino.samaras@berkeley.edu , aprekates@sch.gr",last_changed:"2019-01-28"};
SnapTranslator.dict.ca={language_name:"Catal\u00e0",language_translator:"Bernat Romagosa Carrasquer, Joan Guill\u00e9n i Pelegay","translator_e-mail":"bernat@snap4arduino.rocks, jguille2@xtec.cat",last_changed:"2020-08-02"};SnapTranslator.dict.ca_VA={language_name:"Catal\u00e0 - Valenci\u00e0",language_translator:"Bernat Romagosa Carrasquer, Joan Guill\u00e9n i Pelegay, Pilar Embid","translator_e-mail":"bernat@snap4arduino.rocks, jguille2@xtec.cat, embid_mar@gva.es",last_changed:"2018-02-08"};
SnapTranslator.dict.fi={language_name:"suomi",language_translator:"Jouni K. Sepp\u00e4nen","translator_e-mail":"jks@iki.fi",last_changed:"2014-04-18"};SnapTranslator.dict.sv={language_name:"svenska",language_translator:"Erik A. Olsson","translator_e-mail":"eolsson@gmail.com",last_changed:"2016-06-09"};SnapTranslator.dict.pt_BR={language_name:"Portugu\u00eas do Brasil",language_translator:"Aldo von Wangenheim","translator_e-mail":"awangenh@inf.ufsc.br",last_changed:"2014-04-20"};
SnapTranslator.dict.bn={language_name:"\u09ac\u09be\u0982\u09b2\u09be",language_translator:"Dr. Mokter Hossain, Radman Siddiki","translator_e-mail":"mokter@gmail.com, radman.siddiki@outlook.com",last_changed:"2020-07-04"};SnapTranslator.dict.kn={language_name:"\u0c95\u0ca8\u0ccd\u0ca8\u0ca1",language_translator:"Vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2014-12-02"};
SnapTranslator.dict.ml={language_name:"Malayalam",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"};SnapTranslator.dict.ta={language_name:"Tamil",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"};SnapTranslator.dict.te={language_name:"Telagu",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"};
SnapTranslator.dict.tr={language_name:"T\u00fcrk\u00e7e",language_translator:"Hakan Atas - www.3drobolab.com, Turgut G\u00fcneysu","translator_e-mail":"hakanatas@gmail.com, tguneysu@msn.com, mustafaipekbayrak@gmail.com",last_changed:"2019-01-22"};SnapTranslator.dict.hu={language_name:"Magyar",language_translator:"Mak\u00e1ny Gy\u00f6rgy","translator_e-mail":"makany.gyorgy@gmail.com",last_changed:"2015-07-27"};
SnapTranslator.dict.ia={language_name:"Interlingua",language_translator:"Ken Dickey","translator_e-mail":"Ken.Dickey@whidbey.com",last_changed:"2015-08-09"};SnapTranslator.dict.hr={language_name:"Hrvatski",language_translator:"\u017deljko Hrvoj","translator_e-mail":"zeljko.hrvoj@zg.t-com.hr",last_changed:"2017-08-15"};SnapTranslator.dict.bg={language_name:"\u0411\u044a\u043b\u0433\u0430\u0440\u0441\u043a\u0438",language_translator:"Ivan Savov","translator_e-mail":"ivan.savov@gmail.com",last_changed:"2015-11-16"};
SnapTranslator.dict.ro={language_name:"Rom\u00e2n",language_translator:"Cristian Macarascu","translator_e-mail":"",last_changed:"2015-10-24"};SnapTranslator.dict.ar={language_name:"\u0627\u0644\u0639\u0631\u0628\u064a\u0629",language_translator:"\u0637\u0627\u0631\u0642 \u062c\u0644\u0627\u0644","translator_e-mail":"tarekgalal46@hotmail.com",last_changed:"2016-02-24"};
SnapTranslator.dict.id={language_name:"Bahasa Indonesia",language_translator:"Alexander Raphael Liu, Emmanuella Rumanti","translator_e-mail":"raphaxander@gmail.com",last_changed:"2019-01-21"};SnapTranslator.dict.et={language_name:"Eesti",language_translator:"Hasso Tepper","translator_e-mail":"hasso.tepper@gmail.com",last_changed:"2016-05-03"};SnapTranslator.dict.gl={language_name:"Galego",language_translator:"tecnoloxia <2016>,Miguel A. Bouzada <2019>","translator_e-mail":"mbouzada@gmail.com",last_changed:"2019-07-29"};
SnapTranslator.dict.eu={language_name:"Euskara",language_translator:"Asier Iturralde Sarasola","translator_e-mail":"aiturralde@iametza.eus",last_changed:"2018-06-26"};SnapTranslator.dict.ua={language_name:"\u0423\u043a\u0440\u0430\u0457\u043d\u0441\u044c\u043a\u0430",language_translator:"Serhiy Kryzhanovsky","translator_e-mail":"kseryj@gmail.com",last_changed:"2018-08-21"};
SnapTranslator.dict.sk={language_name:"Sloven\u010dina",language_translator:"Peter Luka\u010dovi\u010d","translator_e-mail":"peter_lukacovic@outlook.com",last_changed:"2019-12-10"};SnapTranslator.dict.he={language_name:"\u05e2\u05d1\u05e8\u05d9\u05ea",language_translator:"\u05d9\u05d5\u05e1\u05d9 \u05db\u05d4\u05df","translator_e-mail":"cohenyossi81@gmail.com",last_changed:"2020-04-21"};modules.symbols="2020-July-21";SymbolMorph.prototype=new Morph;SymbolMorph.prototype.constructor=SymbolMorph;
SymbolMorph.uber=Morph.prototype;SymbolMorph.prototype.names="square pointRight stepForward gears gearBig file fullScreen grow normalScreen shrink smallStage normalStage turtle turtleOutline stage pause flag octagon cloud cloudGradient cloudOutline turnRight turnLeft turnAround storage poster flash brush tick checkedBox rectangle rectangleSolid circle circleSolid ellipse line cross crosshairs paintbucket eraser pipette speechBubble speechBubbleOutline loop turnBack turnForward arrowUp arrowUpOutline arrowUpThin arrowUpDownThin arrowLeft arrowLeftOutline arrowLeftThin arrowLeftRightThin arrowDown arrowDownOutline arrowDownThin arrowRight arrowRightOutline arrowRightThin robot magnifyingGlass magnifierOutline selection polygon closedBrush notes camera location footprints keyboard keyboardFilled globe globeBig list flipVertical flipHorizontal mail encircledCircle netsbloxLogo queue jumpForward jumpBackward stepBackward puzzlePiece".split(" ");
function SymbolMorph(a,b,c,d,e){this.init(a,b,c,d,e)}SymbolMorph.prototype.init=function(a,b,c,d,e){this.isProtectedLabel=!1;this.isReadOnly=!0;this.name=a||"square";this.size=b||50;this.shadowOffset=d||ZERO;this.shadowColor=e||null;SymbolMorph.uber.init.call(this);this.color=c||BLACK;this.fixLayout();this.rerender()};SymbolMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+': "'+this.name+'" '+this.bounds};
SymbolMorph.prototype.setLabelColor=function(a,b,c){this.shadowOffset=c||new Point;this.shadowColor=b;this.setColor(a)};SymbolMorph.prototype.getShadowRenderColor=function(){return this.shadowColor};SymbolMorph.prototype.setExtent=function(a){this.size!==a.y&&(this.changed(),this.size=a.y,this.fixLayout(),this.rerender())};SymbolMorph.prototype.fixLayout=function(){this.bounds.setWidth(this.symbolWidth()+Math.abs(this.shadowOffset.x));this.bounds.setHeight(this.size+Math.abs(this.shadowOffset.y))};
SymbolMorph.prototype.render=function(a){var b=0>this.shadowOffset.x?0:this.shadowOffset.x,c=0>this.shadowOffset.y?0:this.shadowOffset.y,d=0>this.shadowOffset.x?Math.abs(this.shadowOffset.x):0,e=0>this.shadowOffset.y?Math.abs(this.shadowOffset.y):0;this.shadowColor&&(a.save(),a.translate(b,c),this.renderShape(a,this.getShadowRenderColor()),a.restore());a.save();a.translate(d,e);this.renderShape(a,this.getRenderColor());a.restore()};
SymbolMorph.prototype.renderShape=function(a,b){switch(this.name){case "square":this.renderSymbolStop(a,b);break;case "pointRight":this.renderSymbolPointRight(a,b);break;case "stepForward":this.renderSymbolStepForward(a,b);break;case "gears":this.renderSymbolGears(a,b);break;case "gearBig":this.renderSymbolGearBig(a,b);break;case "file":this.renderSymbolFile(a,b);break;case "fullScreen":this.renderSymbolFullScreen(a,b);break;case "grow":this.renderSymbolGrow(a,b);break;case "normalScreen":this.renderSymbolNormalScreen(a,
b);break;case "smallStage":this.renderSymbolSmallStage(a,b);break;case "normalStage":this.renderSymbolNormalStage(a,b);break;case "shrink":this.renderSymbolShrink(a,b);break;case "turtle":this.renderSymbolTurtle(a,b);break;case "turtleOutline":this.renderSymbolTurtleOutline(a,b);break;case "stage":this.renderSymbolStop(a,b);break;case "pause":this.renderSymbolPause(a,b);break;case "flag":this.renderSymbolFlag(a,b);break;case "octagon":this.renderSymbolOctagon(a,b);break;case "cloud":this.renderSymbolCloud(a,
b);break;case "cloudGradient":this.renderSymbolCloudGradient(a,b);break;case "cloudOutline":this.renderSymbolCloudOutline(a,b);break;case "turnRight":this.renderSymbolTurnRight(a,b);break;case "turnLeft":this.renderSymbolTurnLeft(a,b);break;case "turnAround":this.renderSymbolTurnAround(a,b);break;case "storage":this.renderSymbolStorage(a,b);break;case "poster":this.renderSymbolPoster(a,b);break;case "flash":this.renderSymbolFlash(a,b);break;case "brush":this.renderSymbolBrush(a,b);break;case "tick":this.renderSymbolTick(a,
b);break;case "checkedBox":this.renderSymbolCheckedBox(a,b);break;case "rectangle":this.renderSymbolRectangle(a,b);break;case "rectangleSolid":this.renderSymbolRectangleSolid(a,b);break;case "circle":this.renderSymbolCircle(a,b);break;case "circleSolid":this.renderSymbolCircleSolid(a,b);break;case "ellipse":this.renderSymbolCircle(a,b);break;case "line":this.renderSymbolLine(a,b);break;case "cross":this.renderSymbolCross(a,b);break;case "crosshairs":this.renderSymbolCrosshairs(a,b);break;case "paintbucket":this.renderSymbolPaintbucket(a,
b);break;case "eraser":this.renderSymbolEraser(a,b);break;case "pipette":this.renderSymbolPipette(a,b);break;case "speechBubble":this.renderSymbolSpeechBubble(a,b);break;case "speechBubbleOutline":this.renderSymbolSpeechBubbleOutline(a,b);break;case "loop":this.renderSymbolLoop(a,b);break;case "turnBack":this.renderSymbolTurnBack(a,b);break;case "turnForward":this.renderSymbolTurnForward(a,b);break;case "arrowUp":this.renderSymbolArrowUp(a,b);break;case "arrowUpOutline":this.renderSymbolArrowUpOutline(a,
b);break;case "arrowUpThin":this.renderSymbolArrowUpThin(a,b);break;case "arrowUpDownThin":this.renderSymbolArrowUpDownThin(a,b);break;case "arrowLeft":this.renderSymbolArrowLeft(a,b);break;case "arrowLeftOutline":this.renderSymbolArrowLeftOutline(a,b);break;case "arrowLeftThin":this.renderSymbolArrowLeftThin(a,b);break;case "arrowLeftRightThin":this.renderSymbolArrowLeftRightThin(a,b);break;case "arrowDown":this.renderSymbolArrowDown(a,b);break;case "arrowDownOutline":this.renderSymbolArrowDownOutline(a,
b);break;case "arrowDownThin":this.renderSymbolArrowDownThin(a,b);break;case "arrowRight":this.renderSymbolArrowRight(a,b);break;case "arrowRightOutline":this.renderSymbolArrowRightOutline(a,b);break;case "arrowRightThin":this.renderSymbolArrowRightThin(a,b);break;case "robot":this.renderSymbolRobot(a,b);break;case "magnifyingGlass":this.renderSymbolMagnifyingGlass(a,b);break;case "magnifierOutline":this.renderSymbolMagnifierOutline(a,b);break;case "selection":this.renderSymbolSelection(a,b);break;
case "polygon":this.renderSymbolOctagonOutline(a,b);break;case "closedBrush":this.renderSymbolClosedBrushPath(a,b);break;case "notes":this.renderSymbolNotes(a,b);break;case "camera":this.renderSymbolCamera(a,b);break;case "location":this.renderSymbolLocation(a,b);break;case "footprints":this.renderSymbolFootprints(a,b);break;case "keyboard":this.renderSymbolKeyboard(a,b);break;case "keyboardFilled":this.renderSymbolKeyboardFilled(a,b);break;case "globe":this.renderSymbolGlobe(a,b);break;case "globeBig":this.renderSymbolGlobeBig(a,
b);break;case "list":this.renderSymbolList(a,b);break;case "flipVertical":this.renderSymbolFlipVertical(a,b);break;case "flipHorizontal":this.renderSymbolFlipHorizontal(a,b);break;case "mail":this.renderSymbolMail(a,b);break;case "encircledCircle":this.renderSymbolEncircledCircle(a,b);break;case "netsbloxLogo":this.renderSymbolNetsBloxLogo(a,b);break;case "queue":this.renderSymbolQueue(a,b);break;case "jumpForward":this.renderSymbolJumpForward(a,b);break;case "jumpBackward":this.renderSymbolJumpBackward(a,
b);break;case "stepBackward":this.renderSymbolStepBackward(a,b);break;case "puzzlePiece":this.renderSymbolPuzzlePiece(a,b);break;default:throw Error('unknown symbol name: "'+this.name+'"');}};
SymbolMorph.prototype.symbolWidth=function(){var a=this.size;switch(this.name){case "pointRight":return Math.sqrt(a*a-Math.pow(a/2,2));case "location":return.6*a;case "flash":case "file":case "list":return.8*a;case "smallStage":case "normalStage":return 1.2*a;case "turtle":case "turtleOutline":case "stage":return 1.3*a;case "cloud":case "cloudGradient":case "cloudOutline":case "turnBack":case "turnForward":case "keyboard":case "keyboardFilled":return 1.6*a;case "turnRight":case "turnLeft":return a/
3*2;case "loop":return 2*a;default:return a}};SymbolMorph.prototype.renderSymbolStop=function(a,b){a.fillStyle=b.toString();a.fillRect(0,0,this.symbolWidth(),this.size)};SymbolMorph.prototype.renderSymbolPointRight=function(a,b){a.fillStyle=b.toString();a.beginPath();a.moveTo(0,0);a.lineTo(this.symbolWidth(),Math.round(this.size/2));a.lineTo(0,this.size);a.lineTo(0,0);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolStepForward=function(a,b){var c=this.symbolWidth(),d=this.size;a.fillStyle=b.toString();a.beginPath();a.moveTo(0,0);a.lineTo(.75*c,Math.round(d/2));a.lineTo(0,d);a.lineTo(0,0);a.closePath();a.fill();a.fillRect(.75*c,0,.25*c,d)};
SymbolMorph.prototype.renderSymbolGears=function(a,b){var c=this.symbolWidth(),d=c/2;a.fillStyle=b.toString();a.beginPath();a.moveTo(c,d);for(b=0;8>b;b+=1)a.arc(d,d,d,radians(45*b+22.5),radians(45*b+30.5)),a.arc(d,d,.7*d,radians(45*b-10+45),radians(45*b+55)),a.arc(d,d,d,radians(45*(b+1)-8+22.5),radians(45*(b+1)+22.5));a.lineTo(c,d);a.arc(d,d,.3*d,radians(0),radians(360));a.clip("evenodd");a.fillRect(0,0,c,c)};
SymbolMorph.prototype.renderSymbolGearBig=function(a,b){var c=this.symbolWidth(),d=c/2;a.fillStyle=b.toString();a.beginPath();a.moveTo(c,d);for(b=0;10>b;b+=1)a.arc(d,d,d,radians(36*b),radians(36*b+7)),a.arc(d,d,.8*d,radians(36*b-8+18),radians(36*b+26)),a.arc(d,d,d,radians(36*(b+1)-7),radians(36*(b+1)));a.lineTo(c,d);a.arc(d,d,.6*d,radians(0),radians(360));a.arc(d,d,.2*d,radians(0),radians(360));a.clip("evenodd");a.fillRect(0,0,c,c)};
SymbolMorph.prototype.renderSymbolFile=function(a,b){var c=this.size,d=this.symbolWidth(),e=Math.min(d,c)/2;a.fillStyle=b.toString();a.beginPath();a.moveTo(0,0);a.lineTo(e,0);a.lineTo(e,e);a.lineTo(d,e);a.lineTo(d,c);a.lineTo(0,c);a.closePath();a.fill();a.fillStyle=b.darker(25).toString();a.beginPath();a.moveTo(e,0);a.lineTo(d,e);a.lineTo(e,e);a.lineTo(e,0);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolFullScreen=function(a,b){var c=this.size,d=this.symbolWidth(),e=d/2,f=d/20,g=d/2;a.strokeStyle=b.toString();a.lineWidth=d/5;a.beginPath();a.moveTo(e-f,e+f);a.lineTo(2*f,c-2*f);a.stroke();a.strokeStyle=b.toString();a.lineWidth=d/5;a.beginPath();a.moveTo(e+f,e-f);a.lineTo(c-2*f,2*f);a.stroke();a.fillStyle=b.toString();a.beginPath();a.moveTo(0,c);a.lineTo(0,c-g);a.lineTo(g,c);a.closePath();a.fill();a.fillStyle=b.toString();a.beginPath();a.moveTo(c,0);a.lineTo(c-g,0);
a.lineTo(c,g);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolGrow=function(a,b){function c(){a.strokeStyle=b.toString();a.lineWidth=e/7;a.beginPath();a.moveTo(f-3*g,f+3*g);a.lineTo(2*g,d-2*g);a.stroke();a.strokeStyle=b.toString();a.lineWidth=e/7;a.beginPath();a.moveTo(f+3*g,f-3*g);a.lineTo(d-2*g,2*g);a.stroke();a.fillStyle=b.toString();a.beginPath();a.moveTo(0,d);a.lineTo(0,d-h);a.lineTo(h,d);a.closePath();a.fill();a.fillStyle=b.toString();a.beginPath();a.moveTo(d,0);a.lineTo(d-h,0);a.lineTo(d,h);a.closePath();a.fill()}var d=
this.size,e=this.symbolWidth(),f=e/2,g=e/20,h=e/3;c();a.translate(this.size,0);a.rotate(radians(90));c()};
SymbolMorph.prototype.renderSymbolNormalScreen=function(a,b){var c=this.size,d=this.symbolWidth(),e=d/2,f=d/20;a.strokeStyle=b.toString();a.lineWidth=d/5;a.beginPath();a.moveTo(e-3*f,e+3*f);a.lineTo(f,c-f);a.stroke();a.strokeStyle=b.toString();a.lineWidth=d/5;a.beginPath();a.moveTo(e+3*f,e-3*f);a.lineTo(c-f,f);a.stroke();a.fillStyle=b.toString();a.beginPath();a.moveTo(e+f,e-f);a.lineTo(d,e-f);a.lineTo(e+f,0);a.closePath();a.fill();a.fillStyle=b.toString();a.beginPath();a.moveTo(e-f,e+f);a.lineTo(0,
e+f);a.lineTo(e-f,d);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolShrink=function(a,b){function c(){a.strokeStyle=b.toString();a.lineWidth=e/8;a.beginPath();a.moveTo(f-3*g,f+3*g);a.lineTo(g,d-g);a.stroke();a.strokeStyle=b.toString();a.lineWidth=e/8;a.beginPath();a.moveTo(f+3*g,f-3*g);a.lineTo(d-g,g);a.stroke();a.fillStyle=b.toString();a.beginPath();a.moveTo(f+2*g,f-2*g);a.lineTo(e-g,f-2*g);a.lineTo(f+2*g,0+g);a.closePath();a.fill();a.fillStyle=b.toString();a.beginPath();a.moveTo(f-2*g,f+2*g);a.lineTo(0+g,f+2*g);a.lineTo(f-2*g,e-
g);a.closePath();a.fill()}var d=this.size,e=this.symbolWidth(),f=e/2,g=e/20;c();a.translate(this.size,0);a.rotate(radians(90));c()};SymbolMorph.prototype.renderSymbolSmallStage=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/2,f=d/2;a.fillStyle=b.darker(50).toString();a.fillRect(0,0,c,d);a.fillStyle=b.toString();a.fillRect(e,0,e,f)};
SymbolMorph.prototype.renderSymbolNormalStage=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/2,f=d/2;a.fillStyle=b.toString();a.fillRect(0,0,c,d);a.fillStyle=b.darker(50).toString();a.fillRect(e,0,e,f)};SymbolMorph.prototype.renderSymbolTurtle=function(a,b){var c=this.symbolWidth(),d=this.size;a.fillStyle=b.toString();a.beginPath();a.moveTo(0,0);a.lineTo(c,d/2);a.lineTo(0,d);a.lineTo(d/2,d/2);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolTurtleOutline=function(a,b){var c=this.symbolWidth(),d=this.size;a.strokeStyle=b.toString();a.beginPath();a.moveTo(0,0);a.lineTo(c,d/2);a.lineTo(0,d);a.lineTo(d/2,d/2);a.closePath();a.stroke()};SymbolMorph.prototype.renderSymbolPause=function(a,b){var c=this.symbolWidth()/5,d=this.size;a.fillStyle=b.toString();a.fillRect(0,0,2*c,d);a.fillRect(3*c,0,2*c,d)};
SymbolMorph.prototype.renderSymbolFlag=function(a,b){var c=this.symbolWidth(),d=this.size,e=Math.max(c/12,1);a.lineWidth=e;a.strokeStyle=b.toString();a.beginPath();a.moveTo(e/2,0);a.lineTo(e/2,d);a.stroke();a.lineWidth=d/2;a.beginPath();a.moveTo(0,d/4);a.bezierCurveTo(.8*c,d/4,.1*c,.5*d,c,.5*d);a.stroke()};
SymbolMorph.prototype.renderSymbolOctagon=function(a,b){var c=this.symbolWidth(),d=(c-.383*c)/2;a.fillStyle=b.toString();a.beginPath();a.moveTo(d,0);a.lineTo(c-d,0);a.lineTo(c,d);a.lineTo(c,c-d);a.lineTo(c-d,c);a.lineTo(d,c);a.lineTo(0,c-d);a.lineTo(0,d);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolCloud=function(a,b){var c=this.symbolWidth(),d=this.size,e=2*d/5,f=d/4,g=3*d/10,h=d/5;a.fillStyle=b.toString();a.beginPath();a.arc(f,d-f,f,radians(90),radians(259),!1);a.arc(c/20*5,d/9*4,h,radians(165),radians(300),!1);a.arc(c/20*11,e,e,radians(200),radians(357),!1);a.arc(c-g,d-g,g,radians(269),radians(90),!1);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolCloudGradient=function(a,b){var c=this.symbolWidth(),d=this.size,e=2*d/5,f=d/4,g=3*d/10,h=d/5;var k=a.createRadialGradient(0,0,0,0,0,c);k.addColorStop(0,b.lighter(25).toString());k.addColorStop(1,b.darker(25).toString());a.fillStyle=k;a.beginPath();a.arc(f,d-f,f,radians(90),radians(259),!1);a.arc(c/20*5,d/9*4,h,radians(165),radians(300),!1);a.arc(c/20*11,e,e,radians(200),radians(357),!1);a.arc(c-g,d-g,g,radians(269),radians(90),!1);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolCloudOutline=function(a,b){var c=this.symbolWidth(),d=this.size,e=2*d/5,f=d/4,g=3*d/10,h=d/5;a.strokeStyle=b.toString();a.beginPath();a.arc(f+1,d-f-1,f,radians(90),radians(180),!1);a.arc(c/20*5,d/9*4,h,radians(150),radians(300),!1);a.arc(c/20*11,e+1,e,radians(210),radians(335),!1);a.arc(c-g-1,d-g-1,g,radians(280),radians(90),!1);a.closePath();a.stroke()};
SymbolMorph.prototype.renderSymbolTurnRight=function(a,b){var c=this.symbolWidth(),d=Math.max(c/10,1),e=c/2;a.lineWidth=d;a.strokeStyle=b.toString();a.beginPath();a.arc(e,2*e,e-d/2,radians(0),radians(-90),!1);a.stroke();a.fillStyle=b.toString();a.beginPath();a.moveTo(c,e);a.lineTo(e,0);a.lineTo(e,2*e);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolTurnLeft=function(a,b){var c=this.symbolWidth(),d=Math.max(c/10,1);c/=2;a.lineWidth=d;a.strokeStyle=b.toString();a.beginPath();a.arc(c,2*c,c-d/2,radians(180),radians(-90),!0);a.stroke();a.fillStyle=b.toString();a.beginPath();a.moveTo(0,c);a.lineTo(c,0);a.lineTo(c,2*c);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolTurnAround=function(a,b){var c=this.symbolWidth(),d=Math.max(c/10,1);c/=2;a.lineWidth=d;a.strokeStyle=b.toString();a.beginPath();a.arc(c,c,c-d/2,radians(-45),radians(225),!1);a.stroke();a.fillStyle=b.toString();a.beginPath();a.moveTo(0,.1*c);a.lineTo(.8*c,0);a.lineTo(.7*c,.7*c);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolStorage=function(a,b){function c(h){a.fillStyle=b.toString();a.beginPath();a.arc(d/2,h-e,f,radians(60),radians(120),!1);a.lineTo(0,h-2*g);a.arc(d/2,h-e-2*g,f,radians(120),radians(60),!0);a.closePath();a.fill();a.fillStyle=b.darker(25).toString();a.beginPath();a.arc(d/2,h+6*g+1,f,radians(-120),radians(-60),!1);a.stroke()}var d=this.symbolWidth(),e=this.size,f=e,g=e/11;a.strokeStyle=b.toString();c(e);c(e-3*g);c(e-6*g)};
SymbolMorph.prototype.renderSymbolPoster=function(a,b){var c=this.symbolWidth(),d=this.size,e=.75*d,f=d/5;a.fillStyle=b.toString();a.strokeStyle=b.toString();a.lineWidth=c/15;a.beginPath();a.moveTo(c/2,d/3);a.lineTo(c/6,d);a.stroke();a.beginPath();a.moveTo(c/2,d/3);a.lineTo(c/2,d);a.stroke();a.beginPath();a.moveTo(c/2,d/3);a.lineTo(5*c/6,d);a.stroke();a.beginPath();a.moveTo(0,0);a.lineTo(c,0);a.lineTo(c,e-f);a.lineTo(c-f,e-f);a.lineTo(c-f,e);a.lineTo(0,e);a.closePath();a.fill();a.fillStyle=b.darker(25).toString();
a.beginPath();a.moveTo(c,e-f);a.lineTo(c-f,e-f);a.lineTo(c-f,e);a.closePath();a.fill()};SymbolMorph.prototype.renderSymbolFlash=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/3,f=d/3,g=f/3;a.fillStyle=b.toString();a.beginPath();a.moveTo(e,0);a.lineTo(0,f);a.lineTo(e,f);a.lineTo(0,2*f);a.lineTo(e,2*f);a.lineTo(0,d);a.lineTo(c,2*f-g);a.lineTo(2*e,2*f-g);a.lineTo(c,f-g);a.lineTo(2*e,f-g);a.lineTo(c,0);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolBrush=function(a,b){var c=this.symbolWidth(),d=this.size,e=Math.max(c/30,.5);a.fillStyle=b.toString();a.lineWidth=2*e;a.beginPath();a.moveTo(c/8*3,d/2);a.quadraticCurveTo(0,d/2,e,d-e);a.quadraticCurveTo(c/2,d,c/2,d/8*5);a.closePath();a.fill();a.lineJoin="round";a.lineCap="round";a.strokeStyle=b.toString();a.moveTo(c/8*3,d/2);a.lineTo(.75*c,e);a.quadraticCurveTo(c,0,c-e,.25*d);a.stroke();a.moveTo(c/2,d/8*5);a.lineTo(c-e,.25*d);a.stroke()};
SymbolMorph.prototype.renderSymbolTick=function(a,b){var c=this.symbolWidth(),d=this.size;a.fillStyle=b.toString();a.beginPath();a.moveTo(.2*c,.5*d);a.lineTo(.5*c,d);a.lineTo(.8*c,.3*d);a.lineTo(c,0);a.lineTo(.65*c,.2*d);a.lineTo(.5*c,.65*d);a.closePath();a.fill()};SymbolMorph.prototype.renderSymbolCheckedBox=function(a,b){this.renderSymbolRectangle(a,b);this.renderSymbolTick(a,b)};
SymbolMorph.prototype.renderSymbolRectangle=function(a,b){var c=this.symbolWidth(),d=this.size,e=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*e;a.beginPath();a.moveTo(e,e);a.lineTo(c-e,e);a.lineTo(c-e,d-e);a.lineTo(e,d-e);a.closePath();a.stroke()};SymbolMorph.prototype.renderSymbolRectangleSolid=function(a,b){var c=this.symbolWidth(),d=this.size;a.fillStyle=b.toString();a.beginPath();a.moveTo(0,0);a.lineTo(c,0);a.lineTo(c,d);a.lineTo(0,d);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolCircle=function(a,b){var c=this.symbolWidth(),d=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*d;a.beginPath();a.arc(c/2,c/2,c/2-d,radians(0),radians(360),!1);a.stroke()};SymbolMorph.prototype.renderSymbolCircleSolid=function(a,b){var c=this.symbolWidth();a.fillStyle=b.toString();a.beginPath();a.arc(c/2,c/2,c/2,radians(0),radians(360),!1);a.fill()};
SymbolMorph.prototype.renderSymbolLine=function(a,b){var c=this.symbolWidth(),d=this.size,e=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*e;a.lineCap="round";a.beginPath();a.moveTo(e,e);a.lineTo(c-e,d-e);a.stroke()};SymbolMorph.prototype.renderSymbolCross=function(a,b){var c=this.symbolWidth(),d=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*d;a.lineCap="round";a.beginPath();a.moveTo(d,c/2);a.lineTo(c-d,c/2);a.stroke();a.beginPath();a.moveTo(c/2,d);a.lineTo(c/2,c-d);a.stroke()};
SymbolMorph.prototype.renderSymbolCrosshairs=function(a,b){var c=this.symbolWidth(),d=this.size;a.strokeStyle=b.toString();a.lineWidth=1;a.beginPath();a.moveTo(.5,d/2);a.lineTo(c-.5,d/2);a.stroke();a.beginPath();a.moveTo(c/2,.5);a.lineTo(c/2,d-.5);a.stroke();a.beginPath();a.moveTo(c/2,d/2);a.arc(c/2,c/2,c/3-.5,radians(0),radians(360),!1);a.stroke()};
SymbolMorph.prototype.renderSymbolPaintbucket=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/5,f=Math.max(c/30,.5);a.strokeStyle=b.toString();a.lineWidth=2*f;a.beginPath();a.moveTo(2*e,e);a.lineTo(4*e,3*e);a.lineTo(3*e,4*e);a.quadraticCurveTo(2*e,d,e,4*e);a.quadraticCurveTo(0,3*e,e,2*e);a.closePath();a.stroke();a.lineWidth=f;a.moveTo(2*e,2.5*e);a.arc(2*e,2.5*e,f,radians(0),radians(360),!1);a.stroke();a.moveTo(2*e,2.5*e);a.lineTo(2*e,e/2+f);a.stroke();a.arc(1.5*e,e/2+f,e/2,radians(0),radians(180),
!0);a.stroke();a.moveTo(e,e/2+f);a.lineTo(e,2*e);a.stroke();a.fillStyle=b.toString();a.beginPath();a.moveTo(3.5*e,3.5*e);a.quadraticCurveTo(c,3.5*e,c-f,d);a.lineTo(c,d);a.quadraticCurveTo(c,2*e,2.5*e,1.5*e);a.lineTo(4*e,3*e);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolEraser=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/4,f=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*f;a.beginPath();a.moveTo(3*e,f);a.lineTo(f,3*e);a.quadraticCurveTo(e,d,2*e,3*e);a.lineTo(c-f,e);a.closePath();a.stroke();a.fillStyle=b.toString();a.beginPath();a.moveTo(3*e,0);a.lineTo(1.5*e,1.5*e);a.lineTo(2.5*e,2.5*e);a.lineTo(c,e);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolPipette=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/4,f=e/2;c=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*c;a.beginPath();a.moveTo(c,d-c);a.quadraticCurveTo(f,d-f,f,d-e);a.lineTo(2*e,1.5*e);a.stroke();a.beginPath();a.moveTo(c,d-c);a.quadraticCurveTo(f,d-f,e,d-f);a.lineTo(2.5*e,2*e);a.stroke();a.fillStyle=b.toString();a.arc(3*e,e,e-c,radians(0),radians(360),!1);a.fill();a.beginPath();a.moveTo(2*e,e);a.lineTo(3*e,2*e);a.stroke()};
SymbolMorph.prototype.renderSymbolSpeechBubble=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/3,f=Math.max(c/20,.5);a.fillStyle=b.toString();a.lineWidth=2*f;a.beginPath();a.moveTo(e,2*e);a.quadraticCurveTo(f,2*e,f,e);a.quadraticCurveTo(f,f,e,f);a.lineTo(2*e,f);a.quadraticCurveTo(c-f,f,c-f,e);a.quadraticCurveTo(c-f,2*e,2*e,2*e);a.lineTo(e/2,d-f);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolSpeechBubbleOutline=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/3,f=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*f;a.beginPath();a.moveTo(e,2*e);a.quadraticCurveTo(f,2*e,f,e);a.quadraticCurveTo(f,f,e,f);a.lineTo(2*e,f);a.quadraticCurveTo(c-f,f,c-f,e);a.quadraticCurveTo(c-f,2*e,2*e,2*e);a.lineTo(e/2,d-f);a.closePath();a.stroke()};
SymbolMorph.prototype.renderSymbolLoop=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/2,f=e/2,g=d/2,h=Math.max(d/10,.5);a.lineWidth=2*h;a.strokeStyle=b.toString();a.beginPath();a.moveTo(0,d-h);a.lineTo(e,d-h);a.arc(e,g,g-h,radians(90),radians(0),!0);a.stroke();a.fillStyle=b.toString();a.beginPath();a.moveTo(3*f-h,0);a.lineTo(e-h,g);a.lineTo(c,g);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolTurnBack=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/2,f=d/2;c=Math.max(c/20,.5);a.fillStyle=b.toString();a.lineWidth=2*c;a.beginPath();a.moveTo(0,f);a.lineTo(e,0);a.lineTo(e,d);a.closePath();a.fill();a.lineWidth=3*c;a.strokeStyle=b.toString();a.beginPath();a.arc(e,d,f,radians(0),radians(-90),!0);a.stroke()};
SymbolMorph.prototype.renderSymbolTurnForward=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/2,f=d/2,g=Math.max(c/20,.5);a.fillStyle=b.toString();a.lineWidth=2*g;a.beginPath();a.moveTo(c,f);a.lineTo(e,0);a.lineTo(e,d);a.closePath();a.fill();a.lineWidth=3*g;a.strokeStyle=b.toString();a.beginPath();a.arc(e,d,f,radians(-180),radians(-90),!1);a.stroke()};
SymbolMorph.prototype.renderSymbolArrowUp=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/2,f=Math.max(c/20,.5);a.fillStyle=b.toString();a.lineWidth=2*f;a.beginPath();a.moveTo(f,e);a.lineTo(e,f);a.lineTo(c-f,e);a.lineTo(.65*c,e);a.lineTo(.65*c,d-f);a.lineTo(.35*c,d-f);a.lineTo(.35*c,e);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolArrowUpOutline=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/2,f=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*f;a.beginPath();a.moveTo(f,e);a.lineTo(e,f);a.lineTo(c-f,e);a.lineTo(.65*c,e);a.lineTo(.65*c,d-f);a.lineTo(.35*c,d-f);a.lineTo(.35*c,e);a.closePath();a.stroke()};
SymbolMorph.prototype.renderSymbolArrowUpThin=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/3,f=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*f;a.beginPath();a.moveTo(c-e,e);a.lineTo(c/2,2*f);a.lineTo(e,e);a.moveTo(c/2,2*f);a.lineTo(c/2,d-f);a.stroke()};
SymbolMorph.prototype.renderSymbolArrowUpDownThin=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/3,f=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*f;a.beginPath();a.moveTo(c-e,e);a.lineTo(c/2,2*f);a.lineTo(e,e);a.moveTo(c-e,d-e);a.lineTo(c/2,d-2*f);a.lineTo(e,d-e);a.moveTo(c/2,2*f);a.lineTo(c/2,d-2*f);a.stroke()};SymbolMorph.prototype.renderSymbolArrowDown=function(a,b){var c=this.symbolWidth();a.save();a.translate(c,c);a.rotate(radians(180));this.renderSymbolArrowUp(a,b);a.restore()};
SymbolMorph.prototype.renderSymbolArrowDownOutline=function(a,b){var c=this.symbolWidth();a.save();a.translate(c,c);a.rotate(radians(180));this.renderSymbolArrowUpOutline(a,b);a.restore()};SymbolMorph.prototype.renderSymbolArrowDownThin=function(a,b){var c=this.symbolWidth();a.save();a.translate(c,c);a.rotate(radians(180));this.renderSymbolArrowUpThin(a,b);a.restore()};
SymbolMorph.prototype.renderSymbolArrowLeft=function(a,b){var c=this.symbolWidth();a.save();a.translate(0,c);a.rotate(radians(-90));this.renderSymbolArrowUp(a,b);a.restore()};SymbolMorph.prototype.renderSymbolArrowLeftOutline=function(a,b){var c=this.symbolWidth();a.save();a.translate(0,c);a.rotate(radians(-90));this.renderSymbolArrowUpOutline(a,b);a.restore()};
SymbolMorph.prototype.renderSymbolArrowLeftThin=function(a,b){var c=this.symbolWidth();a.save();a.translate(0,c);a.rotate(radians(-90));this.renderSymbolArrowUpThin(a,b);a.restore()};SymbolMorph.prototype.renderSymbolArrowLeftRightThin=function(a,b){var c=this.symbolWidth();a.save();a.translate(0,c);a.rotate(radians(-90));this.renderSymbolArrowUpDownThin(a,b);a.restore()};
SymbolMorph.prototype.renderSymbolArrowRight=function(a,b){var c=this.symbolWidth();a.save();a.translate(c,0);a.rotate(radians(90));this.renderSymbolArrowUp(a,b);a.restore()};SymbolMorph.prototype.renderSymbolArrowRightOutline=function(a,b){var c=this.symbolWidth();a.save();a.translate(c,0);a.rotate(radians(90));this.renderSymbolArrowUpOutline(a,b);a.restore()};
SymbolMorph.prototype.renderSymbolArrowRightThin=function(a,b){var c=this.symbolWidth();a.save();a.translate(c,0);a.rotate(radians(90));this.renderSymbolArrowUpThin(a,b);a.restore()};
SymbolMorph.prototype.renderSymbolRobot=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/6,f=e/2,g=Math.max(c/20,.5);a.fillStyle=b.toString();a.beginPath();a.moveTo(e+g,e);a.lineTo(2*e,e);a.lineTo(2.5*e,1.5*e);a.lineTo(3.5*e,1.5*e);a.lineTo(4*e,e);a.lineTo(5*e-g,e);a.lineTo(4*e,3*e);a.lineTo(4*e,4*e-g);a.lineTo(2*e,4*e-g);a.lineTo(2*e,3*e);a.closePath();a.fill();a.beginPath();a.moveTo(2.75*e,e+g);a.lineTo(2.4*e,e);a.lineTo(2.2*e,0);a.lineTo(3.8*e,0);a.lineTo(3.6*e,e);a.lineTo(3.25*e,e+g);a.closePath();
a.fill();a.beginPath();a.moveTo(2.5*e,4*e);a.lineTo(e,4*e);a.lineTo(f+g,d);a.lineTo(2*e,d);a.closePath();a.fill();a.beginPath();a.moveTo(3.5*e,4*e);a.lineTo(5*e,4*e);a.lineTo(c-(f+g),d);a.lineTo(4*e,d);a.closePath();a.fill();a.beginPath();a.moveTo(e,e);a.lineTo(g,1.5*e);a.lineTo(g,3.25*e);a.lineTo(1.5*e,3.5*e);a.closePath();a.fill();a.beginPath();a.moveTo(5*e,e);a.lineTo(c-g,1.5*e);a.lineTo(c-g,3.25*e);a.lineTo(4.5*e,3.5*e);a.closePath();a.fill()};
SymbolMorph.prototype.renderSymbolMagnifyingGlass=function(a,b){var c=this.symbolWidth(),d=this.size,e=.3*c,f=2*c/3-Math.sqrt(e),g=d/3+Math.sqrt(e),h=Math.max(c/5,.5);a.strokeStyle=b.toString();c=a.createRadialGradient(f,g,0,f+e,g+e,c);c.addColorStop(0,b.inverted().lighter(50).toString());c.addColorStop(1,b.inverted().darker(25).toString());a.fillStyle=c;a.beginPath();a.arc(f,g,e,radians(0),radians(360),!1);a.fill();a.lineWidth=h/2;a.beginPath();a.arc(f,g,e,radians(0),radians(360),!1);a.stroke();
a.lineWidth=h;a.beginPath();a.moveTo(h/2,d-h/2);a.lineTo(f-Math.sqrt(e+h),g+Math.sqrt(e+h));a.closePath();a.stroke()};
SymbolMorph.prototype.renderSymbolMagnifierOutline=function(a,b){var c=this.symbolWidth(),d=this.size,e=.3*c,f=2*c/3-Math.sqrt(e),g=d/3+Math.sqrt(e);c=Math.max(c/5,.5);a.strokeStyle=b.toString();a.lineWidth=.5*c;a.beginPath();a.arc(f,g,e,radians(0),radians(360),!1);a.stroke();a.lineWidth=c;a.beginPath();a.moveTo(c/2,d-c/2);a.lineTo(f-Math.sqrt(e+c),g+Math.sqrt(e+c));a.closePath();a.stroke()};
SymbolMorph.prototype.renderSymbolSelection=function(a,b){var c=this.symbolWidth(),d=this.size;a.save();a.setLineDash([3]);this.renderSymbolRectangle(a,b);a.restore();a.save();a.fillStyle=b.toString();a.translate(.7*c,.4*d);a.scale(.5,.5);a.rotate(radians(135));this.renderSymbolArrowDownOutline(a,b);a.fill();a.restore()};
SymbolMorph.prototype.renderSymbolOctagonOutline=function(a,b){var c=this.symbolWidth(),d=(c-.383*c)/2,e=Math.max(c/20,.5);a.strokeStyle=b.toString();a.lineWidth=2*e;a.beginPath();a.moveTo(d,e);a.lineTo(c-d,e);a.lineTo(c-e,d);a.lineTo(c-e,c-d);a.lineTo(c-d,c-e);a.lineTo(d,c-e);a.lineTo(e,c-d);a.lineTo(e,d);a.closePath();a.stroke()};SymbolMorph.prototype.renderSymbolClosedBrushPath=SymbolMorph.prototype.renderSymbolCloudOutline;
SymbolMorph.prototype.renderSymbolNotes=function(a,b){var c=this.symbolWidth(),d=c/6,e=Math.max(d/3,1);a.strokeStyle=b.toString();a.fillStyle=b.toString();a.beginPath();a.arc(d,c-d,d,radians(0),radians(360),!1);a.fill();a.beginPath();a.arc(c-d,c-2*d,d,radians(0),radians(360),!1);a.fill();a.beginPath();a.moveTo(2*d-e,d);a.lineTo(c,0);a.lineTo(c,d);a.lineTo(2*d-e,2*d);a.closePath();a.fill();a.lineWidth=e;a.beginPath();a.moveTo(2*d-e/2,c-d);a.lineTo(2*d-e/2,d+e);a.stroke();a.beginPath();a.moveTo(c-e/
2,c-2*d);a.lineTo(c-e/2,e);a.stroke()};SymbolMorph.prototype.renderSymbolCamera=function(a,b){var c=this.symbolWidth(),d=this.size,e=.16*c,f=Math.max(c/20,.5);a.lineWidth=2*f;a.fillStyle=b.toString();a.beginPath();a.moveTo(f,5*d/6);a.lineTo(c-f,5*d/6);a.lineTo(c-f,d/4);a.lineTo(3*c/4,d/4);a.lineTo(5*c/8,f);a.lineTo(3*c/8,f);a.lineTo(c/4,d/4);a.lineTo(f,d/4);a.lineTo(f,5*d/6);a.arc(c/2,d/2,e,radians(0),radians(360),!1);a.clip();a.fillRect(0,0,c,d)};
SymbolMorph.prototype.renderSymbolLocation=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/2;a.fillStyle=b.toString();a.beginPath();a.moveTo(0,e);a.arc(e,e,e,radians(-180),radians(0),!1);a.lineTo(e,d);a.lineTo(0,e);a.arc(e,e,.5*e,radians(0),radians(360),!1);a.clip("evenodd");a.fillRect(0,0,c,d)};
SymbolMorph.prototype.renderSymbolFootprints=function(a,b){var c=this.symbolWidth(),d=c/10,e=1.5*d;a.fillStyle=b.toString();a.beginPath();a.arc(e,e,e,radians(-200),radians(0),!1);a.lineTo(2*e,5.5*d);a.lineTo(d,6*d);a.closePath();a.fill();a.beginPath();a.arc(2.25*d,6.75*d,d,radians(-40),radians(-170),!1);a.closePath();a.fill();a.beginPath();a.arc(c-e,4.5*d,e,radians(-180),radians(20),!1);a.lineTo(c-d,8.5*d);a.lineTo(c-2*e,8*d);a.closePath();a.fill();a.beginPath();a.arc(c-2.25*d,9*d,d,radians(0),radians(-150),
!1);a.closePath();a.fill()};SymbolMorph.prototype.renderSymbolKeyboard=function(a,b){var c=this.size,d=c/10;c/=5;var e;a.fillStyle=b.toString();for(b=0;2>b;b+=1)for(e=0;5>e;e+=1)a.fillRect((d+c)*e+d,(d+c)*b+d,c,c);a.fillRect(4*d,7*d,4*c,c)};
SymbolMorph.prototype.renderSymbolKeyboardFilled=function(a,b){var c=this.symbolWidth(),d=this.size,e=d/10,f=d/5,g;a.fillStyle=b.toString();a.beginPath();a.rect(0,0,c,d);for(b=0;2>b;b+=1)for(g=0;5>g;g+=1)a.rect((e+f)*g+e,(e+f)*b+e,f,f);a.rect(4*e,7*e,4*f,f);a.clip("evenodd");a.fillRect(0,0,c,d)};SymbolMorph.prototype.renderSymbolGlobeBig=function(a,b){this.renderSymbolGlobe(a,b,!0)};
SymbolMorph.prototype.renderSymbolGlobe=function(a,b,c){var d=this.symbolWidth(),e=Math.max(d/30,.5);a.strokeStyle=b.toString();a.lineWidth=2*e;a.beginPath();a.arc(d/2,d/2,d/2-e,radians(0),radians(360),!1);a.stroke();c&&(a.moveTo(3*e,.3*d),a.lineTo(d-3*e,.3*d),a.stroke(),a.moveTo(3*e,.7*d),a.lineTo(d-3*e,.7*d),a.stroke());a.beginPath();a.moveTo(e,d/2);a.lineTo(d-e,d/2);a.stroke();a.beginPath();a.moveTo(d/2,e/2);a.arcTo(0,d/2,d/2,d,.75*d);a.stroke();a.beginPath();a.moveTo(d/2,e/2);a.arcTo(d,d/2,d/
2,d,.75*d);a.stroke()};SymbolMorph.prototype.renderSymbolList=function(a,b){var c=this.symbolWidth(),d=this.size,e=d/10,f=d/5;a.fillStyle=b.toString();a.beginPath();a.rect(0,0,c,d);for(b=0;4>b;b+=1)a.rect(e,(e+f)*b+e,c-f,f);a.clip("evenodd");a.fillRect(0,0,c,d)};
SymbolMorph.prototype.renderSymbolFlipHorizontal=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/2,f=c/15;a.strokeStyle=b.toString();a.lineWidth=c/15;a.beginPath();a.moveTo(0+f,d-f/2);a.lineTo(e-1.2*f,d-f/2);a.lineTo(e-1.2*f,2*f);a.closePath();a.stroke();a.fillStyle=b.toString();a.lineWidth=c/15;a.beginPath();a.moveTo(c-f,d-f/2);a.lineTo(e+1.2*f,d-f/2);a.lineTo(e+1.2*f,2*f);a.closePath();a.stroke();a.fill()};
SymbolMorph.prototype.renderSymbolFlipVertical=function(a,b){a.translate(0,this.size);a.rotate(radians(-90));this.renderSymbolFlipHorizontal(a,b)};
SymbolMorph.prototype.renderSymbolNetsBloxLogo=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/14,f=c-2*e;a.beginPath();a.arc(c/2,d/2,2*e,radians(180),radians(270));a.strokeStyle=b.toString();a.beginPath();a.arc(c/2,d/2,e,0,radians(360));a.stroke();a.beginPath();a.arc(c/2,d/2,2*e,0,radians(90));a.stroke();a.beginPath();a.arc(c/2,d/2,3*e,0,radians(90));a.stroke();a.beginPath();a.arc(c/2,d/2,2*e,radians(180),radians(270));a.stroke();a.beginPath();a.arc(c/2,d/2,3*e,radians(180),radians(270));
a.stroke();b=-60;var g=e;d/=2;f/=2;for(c=f-2*e-c/48;300>b;){var h=g,k=d,l=radians(b),m=c*Math.cos(l),n=c*Math.sin(l),q=e*Math.cos(l)+h,p=e*Math.sin(l)+k;a.beginPath();a.arc(h,k,e,l,l+2*Math.PI);a.moveTo(q,p);a.lineTo(h+m,k+n);a.stroke();g+=f*Math.cos(radians(b));d+=f*Math.sin(radians(b));b+=60}};
SymbolMorph.prototype.renderSymbolQueue=function(a,b){var c=this.symbolWidth()/5,d=c/2,e=3*c,f=1*d+e/2,g=d;a.fillStyle=b.toString();var h=function(k){k+=c;var l=e/2;a.fillStyle=b.toString();a.beginPath();a.moveTo(k,f);a.lineTo(k+-1*c,f+l/2);a.lineTo(k+-1*c,f-l/2);a.fill()};h(g);g+=c+d;a.fillRect(g,d,c,e);g+=c+d;a.fillRect(g,d,c,e);h(g+(c+d))};
SymbolMorph.prototype.renderSymbolMail=function(a,b){var c=this.symbolWidth(),d=this.size;a.lineWidth=Math.max(c/12,1);a.fillStyle=b.toString();a.strokeStyle=b.darker(50).toString();a.fillRect(0,0,c,d);a.rect(0,0,c,d);a.moveTo(0,0);a.lineTo(c/2,2*d/3);a.lineTo(c,0);a.stroke()};
SymbolMorph.prototype.renderSymbolEncircledCircle=function(a,b){var c=this.symbolWidth(),d=Math.max(c/30,.5);a.strokeStyle=b.toString();a.fillStyle=b.toString();a.beginPath();a.arc(c/2,c/2,c/4,radians(0),radians(360),!1);a.fill();a.beginPath();a.lineWidth=2*d;a.arc(c/2,c/2,c/2-d,radians(0),radians(360),!1);a.stroke()};
SymbolMorph.prototype.renderSymbolJumpForward=function(a,b){var c=3/7*this.symbolWidth(),d=4/7*this.size,e=1.5/7*this.size,f=1/7*this.symbolWidth();a.fillStyle=b.toString();a.beginPath();a.moveTo(0,e);a.lineTo(c,e+Math.round(d/2));a.lineTo(0,e+d);a.lineTo(0,e);a.closePath();a.fill();a.beginPath();a.moveTo(c,e);a.lineTo(2*c,e+Math.round(d/2));a.lineTo(c,e+d);a.lineTo(c,e);a.closePath();a.fill();a.fillRect(2*c,e,f,d)};
SymbolMorph.prototype.renderSymbolJumpBackward=function(a,b){var c=3/7*this.symbolWidth(),d=4/7*this.size,e=1.5/7*this.size,f=1/7*this.symbolWidth();a.fillStyle=b.toString();a.beginPath();a.moveTo(f+c,e);a.lineTo(f,e+Math.round(d/2));a.lineTo(f+c,e+d);a.lineTo(f+c,e);a.closePath();a.fill();a.beginPath();a.moveTo(f+2*c,e);a.lineTo(f+c,e+Math.round(d/2));a.lineTo(f+2*c,e+d);a.lineTo(f+2*c,e);a.closePath();a.fill();a.fillRect(0,e,f,d)};
SymbolMorph.prototype.renderSymbolStepForward=function(a,b){var c=this.symbolWidth(),d=this.size;a.fillStyle=b.toString();a.beginPath();a.moveTo(0,0);a.lineTo(.75*c,Math.round(d/2));a.lineTo(0,d);a.lineTo(0,0);a.closePath();a.fill();a.fillRect(.75*c,0,.25*c,d)};
SymbolMorph.prototype.renderSymbolStepBackward=function(a,b){var c=this.symbolWidth(),d=this.size;a.fillStyle=b.toString();a.beginPath();a.moveTo(.25*c,Math.round(d/2));a.lineTo(c,0);a.lineTo(c,d);a.lineTo(.25*c,Math.round(d/2));a.closePath();a.fill();a.fillRect(0,0,.25*c,d)};
SymbolMorph.prototype.renderSymbolPuzzlePiece=function(a,b){var c=this.symbolWidth(),d=this.size,e=c/8,f=Math.min(c,d)/6;a.fillStyle=b.toString();a.beginPath();b=c-f;c=(c-f)/2;var g=(d-f)/2+f;a.arc(e,e+f,e,Math.PI,1.5*Math.PI);a.arc(c,f,f,Math.PI,0);a.arc(b-e,f+e,e,1.5*Math.PI,0);a.arc(b,g,f,1.5*Math.PI,.5*Math.PI);a.arc(b-e,d-e,e,0,.5*Math.PI);a.arc(c,d,f,0,Math.PI,!0);a.arc(e,d-e,e,.5*Math.PI,Math.PI);a.arc(0,g,f,.5*Math.PI,3*Math.PI/2,!0);a.closePath();a.fill()};modules.widgets="2020-July-27";
PushButtonMorph.prototype=new TriggerMorph;PushButtonMorph.prototype.constructor=PushButtonMorph;PushButtonMorph.uber=TriggerMorph.prototype;PushButtonMorph.prototype.fontSize=10;PushButtonMorph.prototype.fontStyle="sans-serif";PushButtonMorph.prototype.labelColor=BLACK;PushButtonMorph.prototype.disabledColor=new Color(75,75,75);PushButtonMorph.prototype.labelShadowColor=WHITE;PushButtonMorph.prototype.labelShadowOffset=new Point(1,1);PushButtonMorph.prototype.color=new Color(220,220,220);
PushButtonMorph.prototype.pressColor=new Color(115,180,240);PushButtonMorph.prototype.highlightColor=PushButtonMorph.prototype.pressColor.lighter(50);PushButtonMorph.prototype.outlineColor=new Color(30,30,30);PushButtonMorph.prototype.outlineGradient=!1;PushButtonMorph.prototype.contrast=60;PushButtonMorph.prototype.edge=2;PushButtonMorph.prototype.corner=5;PushButtonMorph.prototype.outline=1;PushButtonMorph.prototype.padding=3;function PushButtonMorph(a,b,c,d,e){this.init(a,b,c,d,e)}
PushButtonMorph.prototype.init=function(a,b,c,d,e){this.is3D=!1;this.target=a||null;this.action=b||null;this.environment=d||null;this.labelString=c||null;this.label=null;this.labelMinExtent=ZERO;this.hint=e||null;this.isDisabled=!1;TriggerMorph.uber.init.call(this);this.enabledColor=PushButtonMorph.prototype.labelColor;this.disabledColor=PushButtonMorph.prototype.disabledColor;this.color=PushButtonMorph.prototype.color;this.createLabel();this.fixLayout();this.rerender()};
PushButtonMorph.prototype.fixLayout=function(){if(null!==this.label){this.updateLabelColors();var a=2*this.padding+2*this.outline+2*this.edge;this.bounds.setWidth(Math.max(this.label.width(),this.labelMinExtent.x)+a);this.bounds.setHeight(Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+a);this.label.setCenter(this.center())}};PushButtonMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this);this.label&&this.label.setCenter(this.center().add(1))};
PushButtonMorph.prototype.mouseClickLeft=function(){this.isDisabled||(PushButtonMorph.uber.mouseClickLeft.call(this),this.label&&this.label.setCenter(this.center()))};PushButtonMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this);this.label&&this.label.setCenter(this.center())};
PushButtonMorph.prototype.render=function(a){"highlight"===this.userState?(this.drawOutline(a),this.drawBackground(a,this.highlightColor),this.drawEdges(a,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast))):"pressed"===this.userState?(this.drawOutline(a),this.drawBackground(a,this.pressColor),this.drawEdges(a,this.pressColor,this.pressColor.darker(this.contrast),this.pressColor.lighter(this.contrast))):(this.drawOutline(a),this.drawBackground(a,
this.color),this.drawEdges(a,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)))};
PushButtonMorph.prototype.drawOutline=function(a){var b=MorphicPreferences.isFlat&&!this.is3D;if(!this.outline||b)return null;if(this.outlineGradient){var c=a.createLinearGradient(0,0,0,this.height());c.addColorStop(0,this.outlineColor.darker().toString());c.addColorStop(1,"white")}else c=this.outlineColor.toString();a.fillStyle=c;a.beginPath();this.outlinePath(a,b?0:this.corner,0);a.closePath();a.fill()};
PushButtonMorph.prototype.drawBackground=function(a,b){var c=MorphicPreferences.isFlat&&!this.is3D;a.fillStyle=b.toString();a.beginPath();this.outlinePath(a,c?0:Math.max(this.corner-this.outline,0),this.outline);a.closePath();a.fill();a.lineWidth=this.outline};
PushButtonMorph.prototype.drawEdges=function(a,b,c,d){if(!MorphicPreferences.isFlat||this.is3D){var e=Math.max(this.corner,this.outline+this.edge),f=this.width(),g=this.height();var h=a.createLinearGradient(0,this.outline,0,this.outline+this.edge);h.addColorStop(0,c.toString());h.addColorStop(1,b.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.moveTo(e,this.outline+this.edge/2);a.lineTo(f-e,this.outline+this.edge/2);a.stroke();h=a.createRadialGradient(this.corner,
this.corner,Math.max(this.corner-this.outline-this.edge,0),this.corner,this.corner,Math.max(this.corner-this.outline,0));h.addColorStop(0,b.toString());h.addColorStop(1,c.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.arc(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(180),radians(270),!1);a.stroke();h=a.createLinearGradient(this.outline,0,this.outline+this.edge,0);h.addColorStop(0,c.toString());h.addColorStop(1,b.toString());
a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.moveTo(this.outline+this.edge/2,e);a.lineTo(this.outline+this.edge/2,g-e);a.stroke();h=a.createLinearGradient(0,g-this.outline,0,g-this.outline-this.edge);h.addColorStop(0,d.toString());h.addColorStop(1,b.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.moveTo(e,g-this.outline-this.edge/2);a.lineTo(f-e,g-this.outline-this.edge/2);a.stroke();h=a.createRadialGradient(f-this.corner,g-this.corner,
Math.max(this.corner-this.outline-this.edge,0),f-this.corner,g-this.corner,Math.max(this.corner-this.outline,0));h.addColorStop(0,b.toString());h.addColorStop(1,d.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.arc(f-this.corner,g-this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(0),radians(90),!1);a.stroke();h=a.createLinearGradient(f-this.outline,0,f-this.outline-this.edge,0);h.addColorStop(0,d.toString());h.addColorStop(1,b.toString());a.strokeStyle=
h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.moveTo(f-this.outline-this.edge/2,e);a.lineTo(f-this.outline-this.edge/2,g-e);a.stroke()}};PushButtonMorph.prototype.outlinePath=BoxMorph.prototype.outlinePath;
PushButtonMorph.prototype.createLabel=function(){var a=!MorphicPreferences.isFlat||this.is3D;null!==this.label&&this.label.destroy();this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),a&&(this.label.shadowOffset=this.labelShadowOffset,this.label.shadowColor=this.labelShadowColor),this.label.color=this.labelColor):this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,a?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor);
this.add(this.label)};PushButtonMorph.prototype.trigger=function(){this.isDisabled||PushButtonMorph.uber.trigger.call(this)};PushButtonMorph.prototype.mouseDownLeft=function(){this.isDisabled||PushButtonMorph.uber.mouseDownLeft.call(this)};PushButtonMorph.prototype.mouseClickLeft=function(){this.isDisabled||PushButtonMorph.uber.mouseClickLeft.call(this)};PushButtonMorph.prototype.isEnabled=function(){return!this.isDisabled};
PushButtonMorph.prototype.updateLabelColors=function(){var a=!MorphicPreferences.isFlat||this.is3D;this.label&&(this.label.color=this.labelColor,this.label.fontSize=this.fontSize,a&&(this.label.shadowOffset=this.labelShadowOffset,this.label.shadowColor=this.labelShadowColor),this.label.fixLayout(!0))};PushButtonMorph.prototype.disable=function(){this.isDisabled=!0;this.forAllChildren(function(a){return a.alpha=.3});this.rerender()};
PushButtonMorph.prototype.enable=function(){this.isDisabled=!1;this.forAllChildren(function(a){return a.alpha=1});this.rerender()};ToggleButtonMorph.prototype=new PushButtonMorph;ToggleButtonMorph.prototype.constructor=ToggleButtonMorph;ToggleButtonMorph.uber=PushButtonMorph.prototype;ToggleButtonMorph.prototype.contrast=30;ToggleButtonMorph.prototype.labelPressColor=null;function ToggleButtonMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}
ToggleButtonMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l){this.state=!1;this.query=e||function(){return!0};this.minWidth=h||null;this.hasPreview=k||!1;this.isPicture=l||!1;this.hasNeutralBackground=!1;this.trueStateLabel=null;ToggleButtonMorph.uber.init.call(this,b,c,d,f,g);a&&(this.color=a[0],this.highlightColor=a[1],this.pressColor=a[2]);this.refresh();this.rerender()};
ToggleButtonMorph.prototype.mouseEnter=function(){var a=this.hint instanceof Function?this.hint():this.hint;if(!this.state||this.hasNeutralBackground)this.userState="highlight",this.rerender();a&&this.bubbleHelp(a)};ToggleButtonMorph.prototype.mouseLeave=function(){if(!this.state||this.hasNeutralBackground)this.userState="normal",this.rerender();this.schedule&&(this.schedule.isActive=!1);this.hint&&this.world().hand.destroyTemporaries()};
ToggleButtonMorph.prototype.mouseDownLeft=function(){this.state||(this.userState="pressed",this.rerender())};ToggleButtonMorph.prototype.mouseClickLeft=function(){this.state||(this.userState="highlight",this.rerender());this.trigger()};ToggleButtonMorph.prototype.trigger=function(){ToggleButtonMorph.uber.trigger.call(this);this.refresh()};
ToggleButtonMorph.prototype.refresh=function(){(this.state="function"===typeof this.query?this.query.call(this.target):this.target[this.query]())?(this.userState="pressed",this.labelPressColor&&this.label.setColor(this.labelPressColor),this.trueStateLabel&&(this.label.hide(),this.trueStateLabel.show())):(this.userState="normal",this.labelPressColor&&this.label.setColor(this.labelColor),this.trueStateLabel&&(this.label.show(),this.trueStateLabel.hide()));this.rerender()};
ToggleButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var a=2*this.padding+2*this.outline+2*this.edge;this.updateLabelColors();var b=Math.max(this.label.width(),this.labelMinExtent.x);this.bounds.setWidth(this.minWidth?Math.max(this.minWidth,b)+a:b+a);this.bounds.setHeight(Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+a);this.label.setCenter(this.center());this.trueStateLabel&&this.trueStateLabel.setCenter(this.center());
this.minWidth&&this.label.setLeft(this.left()+this.outline+this.edge+this.corner+this.padding)}};
ToggleButtonMorph.prototype.render=function(a){switch(this.userState){case "highlight":this.drawOutline(a);this.drawBackground(a,this.highlightColor);this.drawEdges(a,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast));break;case "pressed":this.drawOutline(a);this.drawBackground(a,this.getPressRenderColor());this.drawEdges(a,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40));break;default:this.drawOutline(a),this.drawBackground(a,
this.color),this.drawEdges(a,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast))}};ToggleButtonMorph.prototype.getPressRenderColor=function(){return this.pressColor};
ToggleButtonMorph.prototype.drawEdges=function(a,b,c,d){ToggleButtonMorph.uber.drawEdges.call(this,a,b,c,d);this.hasPreview&&(MorphicPreferences.isFlat&&!this.is3D?(a.fillStyle=this.pressColor.toString(),a.fillRect(this.outline,this.outline,this.corner,this.height()-2*this.outline)):(b=a.createLinearGradient(0,0,this.corner,0),b.addColorStop(0,this.pressColor.lighter(40).toString()),b.addColorStop(1,this.pressColor.darker(40).toString()),a.fillStyle=b,a.beginPath(),this.previewPath(a,Math.max(this.corner-
this.outline,0),this.outline),a.closePath(),a.fill()))};ToggleButtonMorph.prototype.previewPath=function(a,b,c){c=b+c;var d=this.height();a.arc(c,c,b,radians(-180),radians(-90),!1);a.arc(c,d-c,b,radians(90),radians(180),!1)};
ToggleButtonMorph.prototype.createLabel=function(){var a=!MorphicPreferences.isFlat||this.is3D;null!==this.label&&this.label.destroy();null!==this.trueStateLabel&&this.trueStateLabel.destroy();this.labelString instanceof Array&&2===this.labelString.length?this.labelString[0]instanceof SymbolMorph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy(),this.isPicture||(this.label.shadowOffset=a?this.labelShadowOffset:ZERO,this.label.shadowColor=this.labelShadowColor,
this.label.color=this.labelColor,this.label.fixLayout(),this.label.rerender(),this.trueStateLabel.shadowOffset=a?this.labelShadowOffset:ZERO,this.trueStateLabel.shadowColor=this.labelShadowColor,this.trueStateLabel.color=this.labelColor,this.trueStateLabel.fixLayout(),this.trueStateLabel.rerender())):this.labelString[0]instanceof Morph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy()):(this.label=new StringMorph(localize(this.labelString[0]),this.fontSize,
this.fontStyle,!0,!1,!1,a?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.trueStateLabel=new StringMorph(localize(this.labelString[1]),this.fontSize,this.fontStyle,!0,!1,!1,a?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor)):this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),this.isPicture||(this.label.shadowOffset=a?this.labelShadowOffset:ZERO,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.fixLayout(),
this.label.rerender())):this.label=this.labelString instanceof Morph?this.labelString.fullCopy():new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,a?this.labelShadowOffset:ZERO,this.labelShadowColor,this.labelColor);this.add(this.label);this.trueStateLabel&&this.add(this.trueStateLabel)};
ToggleButtonMorph.prototype.updateLabelColors=function(){var a=!MorphicPreferences.isFlat||this.is3D;ToggleButtonMorph.uber.updateLabelColors.call(this);this.trueStateLabel&&(this.trueStateLabel.color=this.labelColor,a&&(this.trueStateLabel.shadowOffset=this.labelShadowOffset,this.trueStateLabel.shadowColor=this.labelShadowColor),this.trueStateLabel.fixLayout(!0))};TabMorph.prototype=new ToggleButtonMorph;TabMorph.prototype.constructor=TabMorph;TabMorph.uber=ToggleButtonMorph.prototype;
function TabMorph(a,b,c,d,e,f,g){this.init(a,b,c,d,e,f,g)}TabMorph.prototype.fixLayout=function(){null!==this.label&&(this.updateLabelColors(),this.setExtent(new Point(this.label.width()+2*this.padding+3*this.corner+2*this.edge,(this.label instanceof StringMorph?this.label.rawHeight():this.label.height())+2*this.padding+this.edge)),this.label.setCenter(this.center()))};TabMorph.prototype.refresh=function(){this.state&&this.parent&&this.parent.add(this);TabMorph.uber.refresh.call(this)};
TabMorph.prototype.drawBackground=function(a,b){var c=this.width(),d=this.height(),e=this.corner;a.fillStyle=b.toString();a.beginPath();a.moveTo(0,d);a.bezierCurveTo(e,d,e,0,2*e,0);a.lineTo(c-2*e,0);a.bezierCurveTo(c-e,0,c-e,d,c,d);a.closePath();a.fill()};TabMorph.prototype.drawOutline=function(){nop()};
TabMorph.prototype.drawEdges=function(a,b,c,d){if(!MorphicPreferences.isFlat||this.is3D){var e=this.width(),f=this.height(),g=this.corner,h=this.edge,k=h/2;nop(b);b=a.createLinearGradient(0,0,e,0);b.addColorStop(0,c.toString());b.addColorStop(1,d.toString());a.strokeStyle=b;a.lineCap="round";a.lineWidth=h;a.beginPath();a.moveTo(0,f+k);a.bezierCurveTo(g,f,g,0,2*g,k);a.lineTo(e-2*g,k);a.bezierCurveTo(e-g,0,e-g,f,e,f+k);a.stroke()}};ToggleMorph.prototype=new PushButtonMorph;
ToggleMorph.prototype.constructor=ToggleMorph;ToggleMorph.uber=PushButtonMorph.prototype;function ToggleMorph(a,b,c,d,e,f,g,h,k){this.init(a,b,c,d,e,f,g,h,k)}
ToggleMorph.prototype.init=function(a,b,c,d,e,f,g,h,k){this.padding=1;a=a||"checkbox";this.corner="checkbox"===a?0:fontHeight(this.fontSize)/2+this.outline+this.padding;this.state=!1;this.query=e||function(){return!0};this.tick=null;this.captionString=d||null;this.labelAlignment="right";this.element=h||null;this.builder=k||null;this.toggleElement=null;ToggleMorph.uber.init.call(this,b,c,"checkbox"===a?"\u2713":"\u25cf",f,g);this.fixLayout();this.refresh()};
ToggleMorph.prototype.fixLayout=function(){var a=2*this.padding+2*this.outline;null!==this.tick&&(this.bounds.setHeight(this.tick.rawHeight()+a),this.bounds.setWidth(this.tick.width()+a),this.bounds.setWidth(Math.max(this.width(),this.height())),this.bounds.setHeight(Math.max(this.width(),this.height())),this.tick.setCenter(this.center()));this.state?this.tick.show():this.tick.hide();if(this.toggleElement&&"right"===this.labelAlignment){var b=this.top()+(this.height()-this.toggleElement.height())/
2;this.toggleElement.setPosition(new Point(this.right()+a,b))}null!==this.label&&(b=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.toggleElement?this.toggleElement instanceof ToggleElementMorph?this.toggleElement.right():this.toggleElement.right()+a:this.right()+a,b)):this.label.setPosition(new Point(this.left()-this.label.width()-a,b)))};
ToggleMorph.prototype.createLabel=function(){var a=!MorphicPreferences.isFlat||this.is3D;null===this.label&&this.captionString&&(this.label=new TextMorph(localize(this.captionString),this.fontSize,this.fontStyle,!0),this.add(this.label));null===this.tick&&(this.tick=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,a?new Point(1,1):null,new Color(240,240,240)),this.add(this.tick));null===this.toggleElement&&this.element&&(this.element instanceof Morph?this.toggleElement=
new ToggleElementMorph(this.target,this.action,this.element,this.query,this.environment,this.hint,this.builder):this.element instanceof HTMLCanvasElement&&(this.toggleElement=new Morph,this.toggleElement.isCachingImage=!0,this.toggleElement.bounds.setExtent(new Point(this.element.width,this.element.height)),this.toggleElement.cachedImage=this.element),this.add(this.toggleElement))};ToggleMorph.prototype.trigger=function(){ToggleMorph.uber.trigger.call(this);this.refresh()};
ToggleMorph.prototype.refresh=function(){(this.state="function"===typeof this.query?this.query.call(this.target):this.target[this.query]())?this.tick.show():this.tick.hide();this.toggleElement&&this.toggleElement.refresh&&this.toggleElement.refresh()};ToggleMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this);this.tick&&this.tick.setCenter(this.center().add(1))};
ToggleMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this);this.tick&&this.tick.setCenter(this.center())};ToggleMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this);this.tick&&this.tick.setCenter(this.center())};ToggleElementMorph.prototype=new TriggerMorph;ToggleElementMorph.prototype.constructor=ToggleElementMorph;ToggleElementMorph.uber=TriggerMorph.prototype;ToggleElementMorph.prototype.contrast=50;
ToggleElementMorph.prototype.shadowOffset=new Point(2,2);ToggleElementMorph.prototype.shadowAlpha=.6;ToggleElementMorph.prototype.fontSize=10;ToggleElementMorph.prototype.inactiveColor=new Color(180,180,180);function ToggleElementMorph(a,b,c,d,e,f,g,h){this.init(a,b,c,d,e,f,g,h)}
ToggleElementMorph.prototype.init=function(a,b,c,d,e,f,g,h){this.target=a||null;this.action=b||null;this.element=c;this.query=d||function(){return!0};this.environment=e||null;this.hint=f||null;this.builder=g||"nop";this.captionString=h||null;this.labelAlignment="right";this.state=!1;TriggerMorph.uber.init.call(this);this.color=c.color;this.createLabel()};
ToggleElementMorph.prototype.render=function(a){var b=this,c=!MorphicPreferences.isFlat||this.is3D,d=function(){c&&b.element.addShadow(b.shadowOffset,"normal"===b.userState?0:b.shadowAlpha)};this.color=this.element.color;this.element.removeShadow();this.element[this.builder]();"pressed"!==this.userState&&(this.element.removeShadow(),this.element.setColor(this.inactiveColor),this.element[this.builder](this.contrast),"highlight"===this.userState&&(this.element.removeShadow(),this.element.setColor(this.color.lighter(this.contrast)),
this.element[this.builder](this.contrast)));this.element.doWithAlpha?a.drawImage(this.element.doWithAlpha(1,function(){d();return b.element.fullImage()}),0,0):(d(),a.drawImage(this.element.fullImage(),0,0));this.element.removeShadow();this.element.setColor(this.color);this.element[this.builder]()};ToggleElementMorph.prototype.setColor=function(a){this.element.setColor(a);this.fixLayout();this.refresh()};
ToggleElementMorph.prototype.fixLayout=function(){this.element.fixLayout();this.bounds.setExtent(this.element.fullBounds().extent().add(2*this.shadowBlur))};
ToggleElementMorph.prototype.createLabel=function(){if(this.captionString){this.label=new StringMorph(this.captionString,this.fontSize,this.fontStyle,!0);this.add(this.label);var a=this.top()+(this.height()-this.label.height())/2;"right"===this.labelAlignment?this.label.setPosition(new Point(this.right(),a)):this.label.setPosition(new Point(this.left()-this.label.width(),a))}};ToggleElementMorph.prototype.trigger=ToggleButtonMorph.prototype.trigger;ToggleElementMorph.prototype.refresh=ToggleButtonMorph.prototype.refresh;
ToggleElementMorph.prototype.mouseEnter=ToggleButtonMorph.prototype.mouseEnter;ToggleElementMorph.prototype.mouseLeave=ToggleButtonMorph.prototype.mouseLeave;ToggleElementMorph.prototype.mouseDownLeft=ToggleButtonMorph.prototype.mouseDownLeft;ToggleElementMorph.prototype.mouseClickLeft=ToggleButtonMorph.prototype.mouseClickLeft;DialogBoxMorph.prototype=new Morph;DialogBoxMorph.prototype.constructor=DialogBoxMorph;DialogBoxMorph.uber=Morph.prototype;DialogBoxMorph.prototype.fontSize=12;
DialogBoxMorph.prototype.titleFontSize=14;DialogBoxMorph.prototype.fontStyle="sans-serif";DialogBoxMorph.prototype.color=PushButtonMorph.prototype.color;DialogBoxMorph.prototype.titleTextColor=WHITE;DialogBoxMorph.prototype.titleBarColor=PushButtonMorph.prototype.pressColor;DialogBoxMorph.prototype.contrast=40;DialogBoxMorph.prototype.corner=12;DialogBoxMorph.prototype.padding=14;DialogBoxMorph.prototype.titlePadding=6;DialogBoxMorph.prototype.buttonContrast=50;
DialogBoxMorph.prototype.buttonFontSize=12;DialogBoxMorph.prototype.buttonCorner=12;DialogBoxMorph.prototype.buttonEdge=6;DialogBoxMorph.prototype.buttonPadding=0;DialogBoxMorph.prototype.buttonOutline=3;DialogBoxMorph.prototype.buttonOutlineColor=PushButtonMorph.prototype.color;DialogBoxMorph.prototype.buttonOutlineGradient=!0;DialogBoxMorph.prototype.instances={};function DialogBoxMorph(a,b,c){this.init(a,b,c)}
DialogBoxMorph.prototype.init=function(a,b,c){this.is3D=!1;this.target=a||null;this.action=b||null;this.environment=c||null;this.buttons=this.body=this.head=this.label=this.labelString=this.key=null;DialogBoxMorph.uber.init.call(this);this.noDropShadow=this.isDraggable=!0;this.fullShadowSource=!1;this.color=PushButtonMorph.prototype.color;this.createLabel();this.createButtons();this.setExtent(new Point(300,150))};
DialogBoxMorph.prototype.inform=function(a,b,c,d){var e=new TextMorph(b,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE);this.key||(this.key="inform"+a+b);e.enableLinks=!0;this.labelString=a;this.createLabel();d&&this.setPicture(d);b&&this.addBody(e);this.addButton("ok","OK");this.fixLayout();this.popUp(c)};
DialogBoxMorph.prototype.askYesNo=function(a,b,c,d){var e=new TextMorph(b,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE);this.key||(this.key="decide"+a+b);this.labelString=a;this.createLabel();d&&this.setPicture(d);this.addBody(e);this.addButton("ok","Yes");this.addButton("cancel","No");this.fixLayout();this.popUp(c)};
DialogBoxMorph.prototype.prompt=function(a,b,c,d,e,f,g,h,k,l,m){var n=Math.pow(10,void 0===m?2:m),q=new InputFieldMorph(b,g||!1,e||null,e?f||!1:!1);q.setWidth(250);if(g){if(d){var p=new AlignmentMorph("column",this.padding);d.setPosition(p.position());p.add(d)}if(!isNil(h)&&!isNil(k)){var t=new SliderMorph(h*n,k*n,parseFloat(b)*n,(k-h)/10*n,"horizontal");t.alpha=1;t.color=this.color.lighter(50);t.setHeight(.7*q.height());t.setWidth(q.width());t.action=function(r){l&&l(r/n);q.setContents(r/n);q.edit()};
p||(p=new AlignmentMorph("column",this.padding));p.add(t)}p&&(p.fixLayout(),this.setPicture(p),p.fixLayout())}else d&&this.setPicture(d);this.reactToChoice=function(r){t&&(t.value=r*n,t.fixLayout(),t.rerender());l&&l(r)};q.reactToInput=function(){var r=q.getValue();t&&(r=Math.max(r,h),t.value=r*n,t.fixLayout(),t.rerender());l&&l(r)};this.labelString=a;this.createLabel();this.key||(this.key="prompt"+a+b);this.addBody(q);q.fixLayout();this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();
this.popUp(c)};
DialogBoxMorph.prototype.promptCode=function(a,b,c,d,e){var f=new ScrollFrameMorph,g=new TextMorph(b||""),h=new AlignmentMorph("column",this.padding),k=d?Math.max(d.width,400):400;this.getInput=function(){return g.text};f.padding=6;f.setWidth(k);f.acceptsDrops=!1;f.contents.acceptsDrops=!1;g.fontName="monospace";g.fontStyle="monospace";g.fontSize=11;g.setPosition(f.topLeft().add(f.padding));g.enableSelecting();g.isEditable=!0;f.setHeight(k/4);f.fixLayout=nop;f.edge=InputFieldMorph.prototype.edge;f.fontSize=
InputFieldMorph.prototype.fontSize;f.typeInPadding=InputFieldMorph.prototype.typeInPadding;f.contrast=InputFieldMorph.prototype.contrast;f.render=InputFieldMorph.prototype.render;f.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;f.addContents(g);g.fixLayout();d&&this.setPicture(d);this.labelString=a;this.createLabel();this.key||(this.key="promptCode"+a+b);h.setColor(this.color);h.add(f);e&&h.add(new TextMorph(localize(e),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,
1),WHITE));h.fixLayout();this.addBody(h);this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();this.popUp(c);g.edit()};
DialogBoxMorph.prototype.promptVector=function(a,b,c,d,e,f,g,h){function k(r){return new TextMorph(localize(r),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE)}var l=new AlignmentMorph("row",4),m=new InputFieldMorph(b.x.toString(),!0),n=new InputFieldMorph(b.y.toString(),!0);b=new AlignmentMorph("column",2);var q=new AlignmentMorph("column",2),p=new AlignmentMorph("column",2),t=new AlignmentMorph("column",this.padding);p.alignment="left";p.setColor(this.color);t.setColor(this.color);
b.alignment="left";b.setColor(this.color);q.alignment="left";q.setColor(this.color);b.add(k(d));b.add(m);q.add(k(e));q.add(n);l.add(b);l.add(q);p.add(l);h&&t.add(k(h));t.add(p);l.fixLayout();b.fixLayout();q.fixLayout();p.fixLayout();t.fixLayout();this.labelString=a;this.createLabel();g&&this.setPicture(g);this.addBody(t);this.addButton("ok","OK");c instanceof Point&&this.addButton(function(){m.setContents(c.x.toString());n.setContents(c.y.toString())},"Default");this.addButton("cancel","Cancel");
this.fixLayout();this.edit=function(){m.edit()};this.getInput=function(){return new Point(m.getValue(),n.getValue())};this.key||(this.key="vector"+a);this.popUp(f)};
DialogBoxMorph.prototype.promptCredentials=function(a,b,c,d,e,f,g,h,k,l){function m(F){return new TextMorph(localize(F),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE)}function n(F,Q){F=new PushButtonMorph(D,function(){return window.open(Q)},"  "+localize(F)+"  ");F.fontSize=10;F.corner=D.buttonCorner;F.edge=D.buttonEdge;F.outline=D.buttonOutline;F.outlineColor=D.buttonOutlineColor;F.outlineGradient=D.buttonOutlineGradient;F.padding=D.buttonPadding;F.contrast=D.buttonContrast;
F.fixLayout();return F}function q(){function F(M,N){N=new SpeechBubbleMorph(localize(N));N.isPointingRight=!1;N.fixLayout();N.popUp(h,M.leftCenter().subtract(new Point(N.width()+2,0)));M.edit&&M.edit()}var Q=t.getValue();if("login"===b)var R=[p,r];else if("signup"===b)R=[p,G,O,t,r,u];else if("changePassword"===b)R=[v,r,u];else if("resetPassword"===b||"resendVerification"===b)R=[p];if(R=detect(R,function(M){return!M.getValue()}))return F(R,"please fill out\nthis field"),!1;if("signup"===b){if(-1<p.getValue().indexOf("@"))return F(p,
"User name cannot contain\nany @ symbols"),!1;if(4>p.getValue().length)return F(p,"User name must be four\ncharacters or longer"),!1;if(-1<Q.indexOf(" ")||-1===Q.indexOf("@")||-1===Q.indexOf(".")||5>Q.length)return F(t,"please provide a valid\nemail address"),!1}if("changePassword"===b||"signup"===b){if(6>r.getValue().length)return F(r,"password must be six\ncharacters or longer"),!1;if(r.getValue()!==u.getValue())return F(u,"passwords do\nnot match"),!1}return"signup"!==b||w?!0:(F(z,"please agree to\nthe TOS"),
!1)}var p=new InputFieldMorph,t=new InputFieldMorph,r=new InputFieldMorph,u=new InputFieldMorph,v=new InputFieldMorph,w=!1,x=new AlignmentMorph("row",4),y=new AlignmentMorph("column",2),B=new AlignmentMorph("column",2),A=new AlignmentMorph("column",2),C=new AlignmentMorph("row",4),E=new AlignmentMorph("column",this.padding),I={},J=(new Date).getFullYear(),K=J-20,D=this;var G=new InputFieldMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],
July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);for(J;J>K;--J)I[J.toString()+" "]=J;I[K+" "+localize("or before")]="< "+J;var O=new InputFieldMorph(null,!1,I,!0);A.alignment="left";A.setColor(this.color);E.setColor(this.color);y.alignment="left";y.setColor(this.color);B.alignment="left";B.setColor(this.color);p.setWidth(200);G.setWidth(100);O.contents().minWidth=80;O.setWidth(80);t.setWidth(200);r.setWidth(200);u.setWidth(200);
v.setWidth(200);r.contents().text.toggleIsPassword();u.contents().text.toggleIsPassword();v.contents().text.toggleIsPassword();"login"===b&&(A.add(m("User name:")),A.add(p));if("signup"===b){A.add(m("User name:"));A.add(p);y.add(m("Birth date:"));y.add(G);B.add(m("year:"));B.add(O);x.add(y);x.add(B);A.add(x);var P=m("foo");A.add(P);A.add(t);A.add(m("Password:"));A.add(r);A.add(m("Repeat Password:"));A.add(u)}"login"===b&&(A.add(m("Password:")),A.add(r));"changePassword"===b&&(A.add(m("Old password:")),
A.add(v),A.add(m("New password:")),A.add(r),A.add(m("Repeat new password:")),A.add(u));if("resetPassword"===b||"resendVerification"===b)A.add(m("User name:")),A.add(p);l&&E.add(m(l));E.add(A);(c||e)&&E.add(C);c&&C.add(n(d,c));e&&C.add(n(f,e));if(g){var z=new ToggleMorph("checkbox",this,function(){return w=!w},g,function(){return w});z.edge=this.buttonEdge/2;z.outline=this.buttonOutline/2;z.outlineColor=this.buttonOutlineColor;z.outlineGradient=this.buttonOutlineGradient;z.contrast=this.buttonContrast;
z.fixLayout();E.add(z)}x.fixLayout();y.fixLayout();B.fixLayout();A.fixLayout();C.fixLayout();E.fixLayout();this.labelString=a;this.createLabel();k&&this.setPicture(k);this.addBody(E);this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();this.accept=function(){q()&&DialogBoxMorph.prototype.accept.call(D)};this.edit=function(){"changePassword"===b?v.edit():p.edit()};this.getInput=function(){return{username:p.getValue(),email:t.getValue(),oldpassword:v.getValue(),password:r.getValue(),
passwordRepeat:u.getValue(),choice:w}};this.reactToChoice=function(){if("signup"===b){P.changed();var F=P,Q=(new Date).getFullYear()+(new Date).getMonth()/12,R=+O.getValue()||0,M=G.getValue();M instanceof Array&&(M=M[0]);isNaN(R)&&(R=0);M="January February March April May June July August September October November December".split(" ").indexOf(M);isNaN(M)&&(M=0);F.text=13>=Q-(R+M/12)?"E-mail address of parent or guardian:":"E-mail address:";P.text=localize(P.text);P.fixLayout();P.rerender()}};this.reactToChoice();
this.key||(this.key="credentials"+a+b);this.popUp(h)};DialogBoxMorph.prototype.accept=function(){if(this.action)if("function"===typeof this.target)"function"===typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action);else if("function"===typeof this.action)this.action.call(this.target,this.getInput());else this.target[this.action](this.getInput());this.destroy()};DialogBoxMorph.prototype.withKey=function(a){this.key=a;return this};
DialogBoxMorph.prototype.popUp=function(a){a&&(this.key&&(this.instances[a.stamp]?this.instances[a.stamp][this.key]&&this.instances[a.stamp][this.key].destroy():this.instances[a.stamp]={},this.instances[a.stamp][this.key]=this),a.add(this),a.keyboardFocus=this,this.setCenter(a.center()),this.edit())};DialogBoxMorph.prototype.destroy=function(){DialogBoxMorph.uber.destroy.call(this);this.key&&delete this.instances[this.key]};DialogBoxMorph.prototype.ok=function(){this.accept()};
DialogBoxMorph.prototype.cancel=function(){this.destroy()};DialogBoxMorph.prototype.edit=function(){this.children.forEach(function(a){a.edit&&a.edit()})};DialogBoxMorph.prototype.getInput=function(){return this.body instanceof InputFieldMorph?this.body.getValue():null};DialogBoxMorph.prototype.justDropped=function(a){a.world.keyboardFocus=this;this.edit()};DialogBoxMorph.prototype.destroy=function(){var a=this.world();a.keyboardFocus=null;a.hand.destroyTemporaries();DialogBoxMorph.uber.destroy.call(this)};
DialogBoxMorph.prototype.normalizeSpaces=function(a){var b="",c,d=!1;for(c=0;c<a.length;c+=1){var e=a[c];" "===e?d&&(b+=e,d=!1):(b+=e,d=!0)}return b.trim()};
DialogBoxMorph.prototype.createLabel=function(){var a=!MorphicPreferences.isFlat||this.is3D;this.label&&this.label.destroy();this.labelString&&(this.label=new StringMorph(localize(this.labelString),this.titleFontSize,this.fontStyle,!0,!1,!1,a?new Point(2,1):null,this.titleBarColor.darker(this.contrast)),this.label.color=this.titleTextColor,this.label.fixLayout(),this.add(this.label))};
DialogBoxMorph.prototype.createButtons=function(){this.buttons&&this.buttons.destroy();this.buttons=new AlignmentMorph("row",this.padding);this.add(this.buttons)};
DialogBoxMorph.prototype.addButton=function(a,b){a=new PushButtonMorph(this,a||"ok","  "+localize(b||"OK")+"  ");a.fontSize=this.buttonFontSize;a.corner=this.buttonCorner;a.edge=this.buttonEdge;a.outline=this.buttonOutline;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.padding=this.buttonPadding;a.contrast=this.buttonContrast;a.fixLayout();this.buttons.add(a);return a};
DialogBoxMorph.prototype.setPicture=function(a){if(a instanceof Morph)var b=a;else b=new Morph,b.isCachingImage=!0,b.cachedImage=a,b.bounds.setWidth(a.width),b.bounds.setHeight(a.height);this.addHead(b)};DialogBoxMorph.prototype.addHead=function(a){this.head&&this.head.destroy();this.head=a;this.add(this.head)};DialogBoxMorph.prototype.addBody=function(a){this.body&&this.body.destroy();this.body=a;this.add(this.body)};
DialogBoxMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;this.head&&(this.head.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.bounds.setWidth(this.head.width()+2*this.padding),this.bounds.setHeight(this.head.height()+2*this.padding+a));if(this.body)if(this.head){this.body.setPosition(this.head.bottomLeft().add(new Point(0,this.padding)));this.bounds.setWidth(Math.max(this.width(),this.body.width()+2*this.padding));this.bounds.setHeight(this.height()+
this.body.height()+this.padding);var b=this.width();this.head.setLeft(this.left()+Math.round((b-this.head.width())/2));this.body.setLeft(this.left()+Math.round((b-this.body.width())/2))}else this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.bounds.setWidth(this.body.width()+2*this.padding),this.bounds.setHeight(this.body.height()+2*this.padding+a);this.label&&(this.bounds.setWidth(Math.max(this.width(),this.label.width()+2*this.padding)),this.label.setCenter(this.center()),
this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.bounds.setHeight(this.height()+this.buttons.height()+this.padding),this.bounds.setWidth(Math.max(this.width(),this.buttons.width()+2*this.padding)),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding));this.removeShadow();this.addShadow()};DialogBoxMorph.prototype.processKeyPress=nop;
DialogBoxMorph.prototype.processKeyDown=function(a){switch(a.keyCode){case 13:this.ok();break;case 27:this.cancel();break;default:nop()}};
DialogBoxMorph.prototype.render=function(a){var b=this.width(),c=this.height(),d=Math.floor(fontHeight(this.titleFontSize)+2*this.titlePadding),e=this.corner/2,f;if(f=MorphicPreferences.isFlat&&!this.is3D)a.fillStyle=this.titleBarColor.toString();else{var g=a.createLinearGradient(0,0,0,d);g.addColorStop(0,this.titleBarColor.lighter(this.contrast/2).toString());g.addColorStop(1,this.titleBarColor.darker(this.contrast).toString());a.fillStyle=g}a.beginPath();this.outlinePathTitle(a,f?0:this.corner);
a.closePath();a.fill();a.fillStyle=this.color.toString();a.beginPath();this.outlinePathBody(a,f?0:this.corner);a.closePath();a.fill();f||(g=a.createLinearGradient(0,c-this.corner,0,c),g.addColorStop(0,this.color.toString()),g.addColorStop(1,this.color.darker(this.contrast.toString())),a.lineWidth=this.corner,a.lineCap="round",a.strokeStyle=g,a.beginPath(),a.moveTo(this.corner,c-e),a.lineTo(this.corner+1,c-e),a.stroke(),g=a.createLinearGradient(0,c-this.corner,0,c),g.addColorStop(0,this.color.toString()),
g.addColorStop(1,this.color.darker(this.contrast.toString())),a.lineWidth=this.corner,a.lineCap="butt",a.strokeStyle=g,a.beginPath(),a.moveTo(this.corner,c-e),a.lineTo(b-this.corner,c-e),a.stroke(),g=a.createLinearGradient(b-this.corner,0,b,0),g.addColorStop(0,this.color.toString()),g.addColorStop(1,this.color.darker(this.contrast).toString()),a.lineWidth=this.corner,a.lineCap="butt",a.strokeStyle=g,a.beginPath(),a.moveTo(b-e,d),a.lineTo(b-e,c-this.corner),a.stroke(),b-=this.corner,f=c-this.corner,
g=a.createRadialGradient(b,f,0,b,f,this.corner),g.addColorStop(0,this.color.toString()),g.addColorStop(1,this.color.darker(this.contrast.toString())),a.lineCap="butt",a.strokeStyle=g,a.beginPath(),a.arc(b,f,e,radians(90),radians(0),!0),a.stroke(),g=a.createLinearGradient(0,0,this.corner,0),g.addColorStop(0,this.color.lighter(this.contrast).toString()),g.addColorStop(1,this.color.toString()),a.lineCap="butt",a.strokeStyle=g,a.beginPath(),a.moveTo(e,d),a.lineTo(e,c-2*this.corner),a.stroke(),g=a.createLinearGradient(0,
0,this.corner,0),g.addColorStop(0,this.color.lighter(this.contrast).toString()),g.addColorStop(1,this.color.toString()),a.lineCap="round",a.strokeStyle=g,a.beginPath(),a.moveTo(e,c-2*this.corner),a.lineTo(e,c-this.corner-e),a.stroke())};DialogBoxMorph.prototype.outlinePathTitle=function(a,b){var c=this.width(),d=Math.ceil(fontHeight(this.titleFontSize))+2*this.titlePadding;a.arc(b,b,b,radians(-180),radians(-90),!1);a.arc(c-b,b,b,radians(-90),radians(-0),!1);a.lineTo(c,d);a.lineTo(0,d)};
DialogBoxMorph.prototype.outlinePathBody=function(a,b){var c=this.width(),d=this.height(),e=Math.floor(fontHeight(this.titleFontSize))+2*this.titlePadding;a.moveTo(0,e);a.lineTo(c,e);a.arc(c-b,d-b,b,radians(0),radians(90),!1);a.arc(b,d-b,b,radians(90),radians(180),!1)};AlignmentMorph.prototype=new Morph;AlignmentMorph.prototype.constructor=AlignmentMorph;AlignmentMorph.uber=Morph.prototype;function AlignmentMorph(a,b){this.init(a,b)}
AlignmentMorph.prototype.init=function(a,b){this.orientation=a||"row";this.alignment="center";this.padding=b||0;this.respectHiddens=!1;AlignmentMorph.uber.init.call(this)};AlignmentMorph.prototype.render=function(a){nop(a)};
AlignmentMorph.prototype.fixLayout=function(){var a=this,b=null,c;if(0===this.children.length)return null;this.children.forEach(function(d){var e=d.fullBounds();if(d.isVisible||a.respectHiddens){if(b){var f=b.fullBounds();"row"===a.orientation?d.setPosition(f.topRight().add(new Point(a.padding,(f.height()-e.height())/2))):d.setPosition(f.bottomLeft().add(new Point("center"===a.alignment?(f.width()-e.width())/2:0,a.padding)));e=d.fullBounds();c=c.merge(e)}else c=e;b=d}});this.bounds=c};
InputFieldMorph.prototype=new Morph;InputFieldMorph.prototype.constructor=InputFieldMorph;InputFieldMorph.uber=Morph.prototype;InputFieldMorph.prototype.edge=2;InputFieldMorph.prototype.fontSize=12;InputFieldMorph.prototype.typeInPadding=2;InputFieldMorph.prototype.contrast=65;function InputFieldMorph(a,b,c,d){this.init(a,b,c,d)}
InputFieldMorph.prototype.init=function(a,b,c,d){a=new StringFieldMorph(a||"",null,null,null,null,null,b||!1);var e=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));this.choices=c||null;this.isReadOnly=d||!1;this.isNumeric=b||!1;a.alpha=0;a.fontSize=this.fontSize;a.fixLayout();this.oldContentsExtent=a.extent();InputFieldMorph.uber.init.call(this);this.color=WHITE;this.add(a);this.add(e);a.isDraggable=!1;this.fixLayout()};
InputFieldMorph.prototype.contents=function(){return detect(this.children,function(a){return a instanceof StringFieldMorph})};InputFieldMorph.prototype.arrow=function(){return detect(this.children,function(a){return a instanceof ArrowMorph})};InputFieldMorph.prototype.setChoice=function(a){this.setContents(a);this.escalateEvent("reactToChoice",a)};
InputFieldMorph.prototype.setContents=function(a){var b=this.contents();b.text.text=a;if(void 0===a)return null;null===a?b.text.text="":a.toString&&(b.text.text=a.toString());b.text.fixLayout();b.changed();b.fixLayout();b.rerender()};InputFieldMorph.prototype.edit=function(){var a=this.contents();a.text.edit();a.text.selectAll()};
InputFieldMorph.prototype.setIsNumeric=function(a){this.isNumeric=a;this.contents().isNumeric=a;this.contents().text.isNumeric=a;a=this.getValue();this.isNumeric&&(a=parseFloat(a),isNaN(a)&&(a=null));this.setContents(a)};
InputFieldMorph.prototype.dropDownMenu=function(){var a=this.choices,b,c=new MenuMorph(this.setChoice,null,this,this.fontSize);a instanceof Function?a=a.call(this):isString(a)&&(a=this[a]());if(!a)return null;c.addItem(" ",null);if(a instanceof Array)a.forEach(function(d){return c.addItem(d[0],d[1])});else for(b in a)Object.prototype.hasOwnProperty.call(a,b)&&("~"===b[0]?c.addLine():c.addItem(b,a[b]));if(0<c.items.length)c.popUpAtHand(this.world());else return null};
InputFieldMorph.prototype.fixLayout=function(){var a=this.contents(),b=this.arrow();if(!a)return null;a.isNumeric=this.isNumeric;a.isEditable=!this.isReadOnly;this.choices?(b.setSize(this.fontSize),b.show()):(b.setSize(0),b.hide());this.bounds.setHeight(a.height()+2*this.edge+2*this.typeInPadding);this.bounds.setWidth(Math.max(a.minWidth+2*this.edge+2*this.typeInPadding,this.width()));a.setWidth(this.width()-this.edge-this.typeInPadding-(this.choices?b.width()+this.typeInPadding:0));a.setPosition((new Point(this.edge,
this.edge)).add(this.typeInPadding).add(this.position()));b.setPosition(new Point(this.right()-b.width()-this.edge,a.top()))};InputFieldMorph.prototype.mouseClickLeft=function(a){this.arrow().bounds.containsPoint(a)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.escalateEvent("mouseClickLeft",a)};InputFieldMorph.prototype.getValue=function(){var a=this.contents();if(this.isNumeric){var b=parseFloat(a.text);if(!isNaN(b))return b}return this.normalizeSpaces(a.string())};
InputFieldMorph.prototype.normalizeSpaces=DialogBoxMorph.prototype.normalizeSpaces;
InputFieldMorph.prototype.render=function(a){if(this.parent){this.parent.color.eq(WHITE)?this.color=this.parent.color.darker(.1*this.contrast):this.color=this.parent.color.lighter(.75*this.contrast);var b=this.parent.color}else b=new Color(120,120,120);a.fillStyle=this.color.toString();this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();a.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge);
this.drawRectBorder(a)};
InputFieldMorph.prototype.drawRectBorder=function(a){var b=.5*this.edge;if(!MorphicPreferences.isFlat||this.is3D){a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.shadowOffsetY=b;a.shadowBlur=4*this.edge;a.shadowColor=this.cachedClrDark;var c=a.createLinearGradient(0,0,0,this.edge);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,b);a.lineTo(this.width()-this.edge-b,b);a.stroke();a.shadowOffsetY=0;c=a.createLinearGradient(0,
0,this.edge,0);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(b,this.edge);a.lineTo(b,this.height()-this.edge-b);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;c=a.createLinearGradient(0,this.height()-this.edge,0,this.height());c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,this.height()-b);a.lineTo(this.width()-this.edge,this.height()-b);a.stroke();
c=a.createLinearGradient(this.width()-this.edge,0,this.width(),0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.width()-b,this.edge);a.lineTo(this.width()-b,this.height()-this.edge);a.stroke()}};PianoMenuMorph.prototype=new MenuMorph;PianoMenuMorph.prototype.constructor=PianoMenuMorph;PianoMenuMorph.uber=MenuMorph.prototype;function PianoMenuMorph(a,b,c,d){this.init(a,b,c,d)}
PianoMenuMorph.prototype.init=function(a,b,c,d){var e;this.soundType=d;PianoMenuMorph.uber.init.call(this,a,null,b,c);a={"C (48)":48,"D (50)":50,"C# (49)":49,"E (52)":52,"Eb (51)":51,"F (53)":53,"G (55)":55,"F# (54)":54,"A (57)":57,"G# (56)":56,"B (59)":59,"Bb (58)":58,"C (60)":60,"D (62)":62,"C# (61)":61,"E (64)":64,"Eb (63)":63,"F (65)":65,"G (67)":67,"F# (66)":66,"A (69)":69,"G# (68)":68,"B (71)":71,"Bb (70)":70,"C (72)":72};for(e in a)Object.prototype.hasOwnProperty.call(a,e)&&this.addItem(e,
a[e])};
PianoMenuMorph.prototype.createItems=function(){var a=this,b,c,d,e,f,g,h;this.children.forEach(function(q){return q.destroy()});this.children=[];this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2);this.color=WHITE;this.borderColor=new Color(60,60,60);this.bounds.setExtent(ZERO);var k=this.left()+1;var l=this.top()+1.5*this.fontSize+2;var m=new StringMorph("",this.fontSize);this.items.forEach(function(q){c=" "!==q[0][1];d=new BoxMorph(1,1);c?(e=
BLACK,f=a.fontSize,g=2.5*a.fontSize,h=new Point(k+2-2*a.fontSize,l)):(e=WHITE,f=1.5*a.fontSize,g=4*a.fontSize,h=new Point(k+1,l),k+=f-1);d.setColor(e);d.setWidth(f);d.setHeight(g);b=new PianoKeyMorph(a.target,q[1],[d,q[0]],a.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,a.environment,q[2],q[3],q[4],q[5],q[6],m);b.setPosition(h);a.add(b)});var n=this.fullBounds();m.setPosition(new Point(n.width()/2-this.fontSize,2));this.add(m);n=this.fullBounds();this.bounds.setExtent(n.extent().add(2))};
PianoMenuMorph.prototype.select=function(a){this.unselectAllItems();a.mouseEnter();this.selection=a;this.world.keyboardFocus=this;this.hasFocus=!0};PianoMenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(a){a instanceof MenuItemMorph&&a.mouseLeave()});this.changed()};PianoMenuMorph.prototype.selectKey=function(a){var b;isNil(a)||((b=detect(this.children,function(c){return c.action===a}))?this.select(b):this.selectKey(48))};
PianoMenuMorph.prototype.processKeyDown=function(a){switch(a.keyCode){case 13:case 32:this.selection&&this.selection.mouseClickLeft();break;case 27:return this.destroy();case 37:case 40:case 189:return this.selectDown();case 38:case 39:case 187:case 220:return this.selectUp();default:switch(a.key){case "C":return this.selectKey(48);case "c":return this.selectKey(60);case "D":return this.selectKey(50);case "d":return this.selectKey(62);case "E":return this.selectKey(52);case "e":return this.selectKey(64);
case "F":return this.selectKey(53);case "f":return this.selectKey(65);case "G":return this.selectKey(55);case "g":return this.selectKey(67);case "A":return this.selectKey(57);case "a":return this.selectKey(69);case "B":case "H":return this.selectKey(59);case "b":case "h":return this.selectKey(71);default:nop()}}};PianoMenuMorph.prototype.selectUp=function(){var a=48;this.selection&&(a=this.selection.action+1,72<a&&(a=48));this.selectKey(a)};
PianoMenuMorph.prototype.selectDown=function(){var a=48;this.selection&&(a=this.selection.action-1,48>a&&(a=72));this.selectKey(a)};PianoMenuMorph.prototype.destroy=function(){this.children.forEach(function(a){a.note&&a.note.stop()});PianoMenuMorph.uber.destroy.call(this)};PianoKeyMorph.prototype=new MenuItemMorph;PianoKeyMorph.prototype.constructor=PianoKeyMorph;PianoKeyMorph.uber=MenuItemMorph.prototype;
function PianoKeyMorph(a,b,c,d,e,f,g,h,k,l,m,n){this.init(a,b,c,d,e,f,g,h,k,l,m,n);this.feedback=n}PianoKeyMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l,m,n){this.note=new Note(b);PianoKeyMorph.uber.init.call(this,a,b,c,d,e,f,g,h,k,l,m,n)};
PianoKeyMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy();this.label=new Morph;var a=this.createIcon(this.labelString[0]);this.label.add(a);this.bounds.setExtent(a.extent());this.label.bounds=this.position().extent(this.label.extent());this.label.bounds.setExtent(ZERO);this.add(this.label)};
PianoKeyMorph.prototype.mouseEnter=function(){var a=this,b=this.parentThatIsA(PianoMenuMorph),c=b?b.soundType:1;b&&(b.unselectAllItems(),b.selection=this,b.world.keyboardFocus=b,b.hasFocus=!0);this.label.children[0].hide();this.userState="highlight";this.rerender();this.feedback.text=this.labelString[1];this.feedback.fixLayout();this.note.play(c);setTimeout(function(){return a.note.stop(!0)},400)};
PianoKeyMorph.prototype.mouseLeave=function(){this.note.stop(!0);this.label.children[0].show();this.userState="normal";this.rerender()};modules.blocks="2020-August-08";SyntaxElementMorph.prototype=new Morph;SyntaxElementMorph.prototype.constructor=SyntaxElementMorph;SyntaxElementMorph.uber=Morph.prototype;SyntaxElementMorph.prototype.contrast=65;
SyntaxElementMorph.prototype.setScale=function(a){this.scale=a=Math.min(Math.max(a,1),25);this.corner=3*a;this.rounding=9*a;this.edge=a;this.flatEdge=.5*a;this.jag=5*a;this.inset=6*a;this.hatHeight=12*a;this.hatWidth=70*a;this.rfBorder=3*a;this.minWidth=0;this.dent=8*a;this.bottomPadding=3*a;this.cSlotPadding=4*a;this.typeInPadding=a;this.labelPadding=4*a;this.labelFontName="Verdana";this.labelFontStyle="sans-serif";this.fontSize=10*a;this.embossing=new Point(-1*Math.max(a/2,1),-1*Math.max(a/2,1));
this.labelWidth=450*a;this.dynamicInputLabels=this.labelWordWrap=!0;this.feedbackMinHeight=5;this.minSnapDistance=20;this.reporterDropFeedbackPadding=10*a;this.labelContrast=25;this.activeHighlight=new Color(153,255,213);this.errorHighlight=new Color(173,15,0);this.activeBlur=20;this.activeBorder=4;this.rfColor=new Color(120,120,120)};SyntaxElementMorph.prototype.setScale(1);SyntaxElementMorph.prototype.isCachingInputs=!1;SyntaxElementMorph.prototype.alpha=1;
function SyntaxElementMorph(){this.init()}SyntaxElementMorph.prototype.init=function(){this.cachedNormalColor=this.cachedClrDark=this.cachedClrBright=this.cachedClr=null;this.isStatic=!1;SyntaxElementMorph.uber.init.call(this);this.defaults=[];this.cachedInputs=null;delete this.alpha};SyntaxElementMorph.prototype.parts=function(){var a=null;this.nextBlock&&(a=this.nextBlock());return this.children.filter(function(b){return b!==a&&!(b instanceof ShadowMorph)&&!(b instanceof BlockHighlightMorph)})};
SyntaxElementMorph.prototype.inputs=function(){if(isNil(this.cachedInputs)||!this.isCachingInputs)this.cachedInputs=this.parts().filter(function(a){return a instanceof SyntaxElementMorph});return this.cachedInputs};
SyntaxElementMorph.prototype.debugCachedInputs=function(){var a,b;isNil(this.cachedInputs)||(a=this.parts().filter(function(c){return c instanceof SyntaxElementMorph}));if(this.cachedInputs.length!==a.length)throw Error("cached inputs size do not match: "+this.constructor.name);for(b=0;b<a.length;b+=1)if(this.cachedInputs[b]!==a[b])throw Error("cached input does not match: "+this.constructor.name+" #"+b+" "+this.cachedInputs[b].constructor.name+" != "+a[b].constructor.name);};
SyntaxElementMorph.prototype.allInputs=function(){var a=this;return this.allChildren().slice(0).reverse().filter(function(b){return b instanceof ArgMorph||b instanceof ReporterBlockMorph&&b!==a})};SyntaxElementMorph.prototype.allEmptySlots=function(){var a=[];this instanceof RingMorph||"reportJSFunction"===this.selector||this.children.forEach(function(b){b.isEmptySlot&&b.isEmptySlot()?a.push(b):b.allEmptySlots&&(a=a.concat(b.allEmptySlots()))});return a};
SyntaxElementMorph.prototype.tagExitBlocks=function(a,b){"doReport"===this.selector?this.partOfCustomCommand=b:"doStopThis"===this.selector?this.exitTag=a:this instanceof RingMorph||this.children.forEach(function(c){c.tagExitBlocks&&c.tagExitBlocks(a,b)})};
SyntaxElementMorph.prototype.replaceInput=function(a,b){var c=this.parentThatIsA(ScriptsMorph),d=b,e=this.children.indexOf(a),f=0;-1===e&&b instanceof MultiArgMorph&&this.children.forEach(function(g){g instanceof ArgLabelMorph&&g.argMorph()===a&&(e=f);f+=1});a.cachedSlotSpec&&(a.cachedSlotSpec=null);b.cachedSlotSpec&&(b.cachedSlotSpec=null);this.changed();b.parent&&b.parent.removeChild(b);a instanceof MultiArgMorph&&(a.inputs().forEach(function(g){return a.replaceInput(g,new InputSlotMorph)}),this.dynamicInputLabels&&
(d=new ArgLabelMorph(b)));d.parent=this;this.children[e]=d;a instanceof ReporterBlockMorph&&c&&(!(a instanceof RingMorph)||a instanceof RingMorph&&a.contents())&&(c.add(a),a.moveBy(d.extent()),a.fixBlockColor());d instanceof MultiArgMorph||d instanceof ArgLabelMorph||d.constructor===CommandSlotMorph?(d.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):this.fixLayout();this.cachedInputs=null};
SyntaxElementMorph.prototype.revertToDefaultInput=function(a,b){var c=this.parts().indexOf(a),d=this.inputs().indexOf(a),e=new InputSlotMorph,f=this.parts().filter(function(g){return g instanceof StructInputSlotMorph}).reduce(function(g,h){return g+h.fields.length},0);c=-1!==c?c-f:c;-1!==c&&(this instanceof BlockMorph?(e=this.labelPart(this.parseSpec(this.blockSpec)[c]),this.isCustomBlock&&(c=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec),e instanceof InputSlotMorph&&
e.setChoices.apply(e,c.inputOptionsOfIdx(d)),(e instanceof InputSlotMorph||e instanceof BooleanSlotMorph)&&e.setContents(c.defaultValueOfInputIdx(d)))):this instanceof MultiArgMorph?e=this.labelPart(this.slotSpec):this instanceof ReporterSlotMorph&&(e=this.emptySlot()));c=SnapActions.getFieldValue(this,d);void 0!==c?e.setContents(c):b||-1===d||(e instanceof MultiArgMorph?(e.setContents(this.defaults),e.defaults=this.defaults):isNil(this.defaults[d])||e.setContents(this.defaults[d]));(e.icon||e instanceof
BooleanSlotMorph)&&e.fixLayout();this.replaceInput(a,e);e instanceof MultiArgMorph?e.refresh():e instanceof RingMorph&&e.fixBlockColor();this.cachedInputs=null};SyntaxElementMorph.prototype.isLocked=function(){return this.isStatic};SyntaxElementMorph.prototype.topBlock=function(){return this.parent&&this.parent.topBlock?this.parent.topBlock():this};
SyntaxElementMorph.prototype.getVarNamesDict=function(){var a=this.parentThatIsA(BlockMorph),b=[],c=StageMorph.prototype.enableInheritance;if(!a)return{};var d=a.scriptTarget();a.allParents().forEach(function(f){f instanceof PrototypeHatBlockMorph?(b.push.apply(b,f.variableNames()),b.push.apply(b,f.inputs()[0].inputFragmentNames())):f instanceof BlockMorph&&f.inputs().forEach(function(g){g.allChildren().forEach(function(h){h instanceof TemplateSlotMorph?b.push(h.contents()):h instanceof MultiArgMorph&&
h.children.forEach(function(k){k instanceof TemplateSlotMorph&&b.push(k.contents())})})})});if(d){var e=d.variables.allNamesDict();b.forEach(function(f){return e[f]=f});"doSetVar"===a.selector&&(e["~"]=null,e.my=[{anchor:["anchor"],name:["name"],"temporary?":["temporary?"],"dangling?":["dangling?"],"draggable?":["draggable?"],"rotation style":["rotation style"],"rotation x":["rotation x"],"rotation y":["rotation y"]}],c&&(e.my[0].parent=["parent"]),16===this.world().currentKey&&(e.my[0]["~"]=null,
e.my[0]["microphone modifier"]=["microphone modifier"]));return e}return{}};
SyntaxElementMorph.prototype.refactorVarInStack=function(a,b,c){this instanceof RingMorph&&contains(this.inputNames(),a)||!c&&this.definesScriptVariable(a)||("reportGetVar"===this.selector&&this.blockSpec===a&&(this.setSpec(b),this.fullChanged(),this.fixLabelColor()),"getVarNamesDict"===this.choices&&this.contents().text===a&&this.setContents(b),this instanceof CustomCommandBlockMorph&&this.definition.body&&isNil(this.definition.declarations.get(a))&&!contains(this.definition.variableNames,a)&&this.definition.body.expression.refactorVarInStack(a,
b),this.inputs().forEach(function(d){return d.refactorVarInStack(a,b)}),this.nextBlock&&(c=this.nextBlock())&&c.refactorVarInStack(a,b))};SyntaxElementMorph.prototype.definesScriptVariable=function(a){return("doDeclareVariables"===this.selector||this.blockSpec&&this.blockSpec.match("%upvar"))&&detect(this.inputs()[0].allInputs(),function(b){return"reportGetVar"===b.selector&&b.blockSpec===a})};
SyntaxElementMorph.prototype.selectForEdit=function(){var a=this.parentThatIsA(ScriptsMorph),b=this.parentThatIsA(IDE_Morph);b=b?b.currentSprite:null;return a&&b&&b.inheritsAttribute("scripts")?(this.selectionID=!0,b.shadowAttribute("scripts"),a=detect(b.scripts.allChildren(),function(c){return c.selectionID}),delete this.selectionID,delete a.selectionID,a):this};
SyntaxElementMorph.prototype.reactToGrabOf=function(a){var b=this.topBlock();a instanceof CommandBlockMorph&&(a=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph))&&a.fixLayout();b&&(b.allComments().forEach(function(c){return c.align(b)}),b.getHighlight()&&b.addHighlight(b.removeHighlight()))};SyntaxElementMorph.prototype.bright=function(){return this.color.lighter(this.contrast).toString()};SyntaxElementMorph.prototype.dark=function(){return this.color.darker(this.contrast).toString()};
SyntaxElementMorph.prototype.setColor=function(a){if(a&&!this.color.eq(a)){var b=this.parentThatIsA(BlockMorph);this.color=a;this.children.forEach(function(c){b&&(c instanceof StringMorph||c instanceof SymbolMorph)?(c.shadowColor=b.color.darker(b.labelContrast),c.rerender()):c instanceof CommandSlotMorph&&c.setColor(a)});this.rerender()}};
SyntaxElementMorph.prototype.setLabelColor=function(a,b,c){this.children.forEach(function(d){d instanceof StringMorph&&!d.isProtectedLabel?(d.shadowOffset=c||d.shadowOffset,d.shadowColor=b||d.shadowColor,d.setColor(a)):d instanceof MultiArgMorph||d instanceof ArgLabelMorph||d instanceof SymbolMorph&&!d.isProtectedLabel||d instanceof InputSlotMorph&&d.isReadOnly?d.setLabelColor(a,b,c):d.isLoop&&d.loop().setLabelColor(a,b,c)})};
SyntaxElementMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.setColor(this.activeHighlight))};SyntaxElementMorph.prototype.unflash=function(){if(this.cachedNormalColor){var a=this.cachedNormalColor;this.cachedNormalColor=null;this.setColor(a)}};SyntaxElementMorph.prototype.doWithAlpha=function(a,b){var c=SyntaxElementMorph.prototype.alpha;SyntaxElementMorph.prototype.alpha=a;a=b();SyntaxElementMorph.prototype.alpha=c;return a};
SyntaxElementMorph.prototype.fixBlockColor=function(a,b){this.children.forEach(function(c){c instanceof SyntaxElementMorph&&c.fixBlockColor(a,b)})};
SyntaxElementMorph.prototype.labelPart=function(a){if("%"===a[0]&&1<a.length&&("reportGetVar"!==this.selector||"%turtleOutline"===a&&this.isObjInputFragment())){if(5<a.length&&"%mult"===a.slice(0,5)){var b=new MultiArgMorph(a.slice(5));b.addInput();return b}if(5<a.length&&"%hint"===a.slice(0,5))return b=new HintInputSlotMorph("",a.slice(5));if(6<a.length&&"%mhint"===a.slice(0,6))return b=a.slice(6),b=new MultiHintArgMorph(b,null,0),b.isStatic=!0,b.canBeEmpty=!1,b;switch(a){case "%imgsource":b=new InputSlotMorph(null,
!1,{"pen trails":["pen trails"],"stage image":["stage image"]},!0);b.setContents(["pen trails"]);break;case "%inputs":b=new MultiArgMorph("%s","with inputs");b.isStatic=!1;b.canBeEmpty=!1;break;case "%scriptVars":b=new MultiArgMorph("%t",null,1,a);b.canBeEmpty=!1;break;case "%blockVars":b=new MultiArgMorph("%t","block variables",0,a);b.canBeEmpty=!1;break;case "%parms":b=new MultiArgMorph("%t","Input Names:",0,a);b.canBeEmpty=!1;break;case "%ringparms":b=new MultiArgMorph("%t","input names:",0,a);
break;case "%cmdRing":b=new RingMorph;b.color=SpriteMorph.prototype.blockColor.other;b.selector="reifyScript";b.setSpec("%rc %ringparms");b.isDraggable=!0;break;case "%repRing":b=new RingMorph;b.color=SpriteMorph.prototype.blockColor.other;b.selector="reifyReporter";b.setSpec("%rr %ringparms");b.isDraggable=!0;b.isStatic=!0;break;case "%predRing":b=new RingMorph(!0);b.color=SpriteMorph.prototype.blockColor.other;b.selector="reifyPredicate";b.setSpec("%rp %ringparms");b.isDraggable=!0;b.isStatic=!0;
break;case "%words":b=new MultiArgMorph("%s",null,0);b.addInput();b.addInput();break;case "%lists":b=new MultiArgMorph("%l",null,0);b.addInput();b.addInput();break;case "%exp":b=new MultiArgMorph("%s",null,0);b.addInput();b.isStatic=!0;b.canBeEmpty=!1;break;case "%br":b=new Morph;b.setExtent(ZERO);b.isBlockLabelBreak=!0;b.getSpec=function(){return"%br"};break;case "%inputName":b=new ReporterBlockMorph;b.category="variables";b.color=SpriteMorph.prototype.blockColor.variables;b.setSpec(localize("Input name"));
break;case "%s":b=new InputSlotMorph;break;case "%anyUE":b=new InputSlotMorph;b.isUnevaluated=!0;break;case "%txt":b=new InputSlotMorph;b.minWidth=1.7*b.height();b.fixLayout();break;case "%mlt":b=new TextSlotMorph;b.fixLayout();break;case "%code":b=new TextSlotMorph;b.contents().fontName="monospace";b.contents().fontStyle="monospace";b.fixLayout();break;case "%obj":b=new ArgMorph("object");break;case "%n":b=new InputSlotMorph(null,!0);break;case "%dir":b=new InputSlotMorph(null,!0,{"\u00a7_dir":null,
"(90) right":90,"(-90) left":-90,"(0) up":"0","(180) down":180,random:["random"]});b.setContents(90);break;case "%note":b=new InputSlotMorph(null,!0,"pianoKeyboardMenu",!1);break;case "%inst":b=new InputSlotMorph(null,!0,{"(1) sine":1,"(2) square":2,"(3) sawtooth":3,"(4) triangle":4});b.setContents(1);break;case "%audio":b=new InputSlotMorph(null,!1,"audioMenu",!0);break;case "%aa":b=new InputSlotMorph(null,!1,{name:["name"],duration:["duration"],length:["length"],"number of channels":["number of channels"],
"sample rate":["sample rate"],samples:["samples"]},!0);break;case "%img":b=new InputSlotMorph(null,!1,{name:["name"],width:["width"],height:["height"],pixels:["pixels"]},!0);break;case "%rate":b=new InputSlotMorph(null,!0,{"22.05 kHz":22050,"44.1 kHz":44100,"88.2 kHz":88200,"96 kHz":96E3});b.setContents(1);break;case "%audio":b=new InputSlotMorph(null,!1,"audioMenu",!0);break;case "%aa":b=new InputSlotMorph(null,!1,{name:["name"],duration:["duration"],length:["length"],"number of channels":["number of channels"],
"sample rate":["sample rate"],samples:["samples"]},!0);break;case "%img":b=new InputSlotMorph(null,!1,{name:["name"],width:["width"],height:["height"],pixels:["pixels"]},!0);break;case "%rate":b=new InputSlotMorph(null,!0,{"22.05 kHz":22050,"44.1 kHz":44100,"88.2 kHz":88200,"96 kHz":96E3});b.setContents(1);break;case "%month":b=new InputSlotMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],
October:["October"],November:["November"],December:["December"]},!0);break;case "%interaction":b=new InputSlotMorph(null,!1,{clicked:["clicked"],pressed:["pressed"],dropped:["dropped"],"mouse-entered":["mouse-entered"],"mouse-departed":["mouse-departed"],"scrolled-up":["scrolled-up"],"scrolled-down":["scrolled-down"],stopped:["stopped"]},!0);b.isStatic=!0;break;case "%dates":b=new InputSlotMorph(null,!1,{year:["year"],month:["month"],date:["date"],"day of week":["day of week"],hour:["hour"],minute:["minute"],
second:["second"],"time in milliseconds":["time in milliseconds"]},!0);b.setContents(["date"]);break;case "%delim":b=new InputSlotMorph(null,!1,{letter:["letter"],word:["word"],line:["line"],tab:["tab"],cr:["cr"],csv:["csv"],json:["json"]},!1);break;case "%ida":b=new InputSlotMorph(null,!0,{1:1,last:["last"],"~":null,all:["all"]});b.setContents(1);break;case "%idx":b=new InputSlotMorph(null,!0,{1:1,last:["last"],any:["any"]});b.setContents(1);break;case "%dim":b=new InputSlotMorph(null,!0,{current:["current"]});
break;case "%rel":b=new InputSlotMorph(null,!1,{distance:["distance"],direction:["direction"]},!0);break;case "%loc":b=new InputSlotMorph(null,!1,"locationMenu",!0);break;case "%spr":b=new InputSlotMorph(null,!1,"objectsMenu",!0);break;case "%self":b=new InputSlotMorph(null,!1,"objectsMenuWithSelf",!0);break;case "%col":b=new InputSlotMorph(null,!1,"collidablesMenu",!0);break;case "%dst":b=new InputSlotMorph(null,!1,"distancesMenu",!0);break;case "%cln":b=new InputSlotMorph(null,!1,"clonablesMenu",
!0);break;case "%get":b=new InputSlotMorph(null,!1,"gettablesMenu",!0);b.isStatic=!0;break;case "%cst":b=new InputSlotMorph(null,!1,"costumesMenu",!0);break;case "%eff":b=new InputSlotMorph(null,!1,{color:["color"],saturation:["saturation"],brightness:["brightness"],ghost:["ghost"],fisheye:["fisheye"],whirl:["whirl"],pixelate:["pixelate"],mosaic:["mosaic"],negative:["negative"]},!0);b.setContents(["ghost"]);break;case "%snd":b=new InputSlotMorph(null,!1,"soundsMenu",!0);break;case "%key":b=new InputSlotMorph(null,
!1,{"any key":["any key"],"up arrow":["up arrow"],"down arrow":["down arrow"],"right arrow":["right arrow"],"left arrow":["left arrow"],space:["space"],"+":["+"],"-":["-"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"]},!0);b.setContents(["space"]);break;case "%keyHat":b=
this.labelPart("%key");b.isStatic=!0;break;case "%msgType":b=new InputSlotMorph(null,!1,"messageTypes",!0);break;case "%msgOutput":b=new MessageOutputSlotMorph;break;case "%msgInput":b=new MessageInputSlotMorph;break;case "%roles":b=new InputSlotMorph(null,!1,"roleNames");break;case "%serviceNames":b=new InputSlotMorph(null,!1,"serviceNames",!0);b.isStatic=!0;break;case "%rpcActions":b=new InputSlotMorph(null,!1,"rpcActions",!0);break;case "%rpcMethod":b=new RPCInputSlotMorph;break;case "%msg":b=
new InputSlotMorph(null,!1,"messagesMenu",!0);break;case "%msgHat":b=new InputSlotMorph(null,!1,"messagesReceivedMenu",!0);b.isStatic=!0;break;case "%att":b=new InputSlotMorph(null,!1,"attributesMenu",!0);break;case "%fun":b=new InputSlotMorph(null,!1,{abs:["abs"],neg:["neg"],ceiling:["ceiling"],floor:["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],log:["log"],lg:["lg"],"e^":["e^"],"10^":["10^"],"2^":["2^"],id:["id"]},!0);b.setContents(["sqrt"]);
break;case "%layer":b=new InputSlotMorph(null,!1,{front:["front"],back:["back"]},!0);b.setContents(["front"]);break;case "%hsva":b=new InputSlotMorph(null,!1,{hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"]},!0);b.setContents(["hue"]);break;case "%pen":b=new InputSlotMorph(null,!1,{size:["size"],hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"]},!0);b.setContents(["hue"]);break;case "%asp":b=new InputSlotMorph(null,
!1,{hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"],"r-g-b-a":["r-g-b-a"],"~":null,sprites:["sprites"]},!0);b.setContents(["hue"]);break;case "%txtfun":b=new InputSlotMorph(null,!1,{"encode URI":["encode URI"],"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],"hex sha512 hash":["hex sha512 hash"]},!0);b.setContents(["encode URI"]);
break;case "%stopChoices":b=new InputSlotMorph(null,!1,{all:["all"],"this script":["this script"],"this block":["this block"],"all but this script":["all but this script"],"other scripts in sprite":["other scripts in sprite"]},!0);b.setContents(["all"]);b.isStatic=!0;break;case "%setting":b=new InputSlotMorph(null,!1,{"turbo mode":["turbo mode"],"flat line ends":["flat line ends"],"log pen vectors":["log pen vectors"],"video capture":["video capture"],"mirror video":["mirror video"]},!0);b.setContents(["turbo mode"]);
b.isStatic=!0;break;case "%typ":b=new InputSlotMorph(null,!1,"typesMenu",!0);b.setContents(["number"]);break;case "%mapValue":b=new InputSlotMorph(null,!1,{String:["String"],Number:["Number"],"true":["true"],"false":["false"]},!0);b.setContents(["String"]);b.isStatic=!0;break;case "%var":b=new InputSlotMorph(null,!1,"getVarNamesDict",!0);b.isStatic=!0;break;case "%shd":b=new InputSlotMorph(null,!1,"shadowedVariablesMenu",!0);break;case "%lst":b=new InputSlotMorph(null,!1,{list1:"list1",list2:"list2",
list3:"list3"},!0);break;case "%codeKind":b=new InputSlotMorph(null,!1,{code:["code"],header:["header"]},!0);b.setContents(["code"]);break;case "%l":b=new ArgMorph("list");break;case "%b":b=new BooleanSlotMorph;break;case "%boolUE":b=new BooleanSlotMorph;b.isUnevaluated=!0;break;case "%bool":b=new BooleanSlotMorph(!0);b.isStatic=!0;break;case "%cmd":b=new CommandSlotMorph;break;case "%rc":b=new RingCommandSlotMorph;b.isStatic=!0;break;case "%rr":b=new RingReporterSlotMorph;b.isStatic=!0;break;case "%rp":b=
new RingReporterSlotMorph(!0);b.isStatic=!0;break;case "%c":b=new CSlotMorph;b.isStatic=!0;break;case "%cs":b=new CSlotMorph;break;case "%ca":b=new CSlotMorph;b.isLoop=!0;b.add(this.labelPart("%loopArrow"));break;case "%cl":b=new CSlotMorph;b.isStatic=!0;b.isLambda=!0;break;case "%cla":b=new CSlotMorph;b.isStatic=!0;b.isLambda=!0;b.isLoop=!0;b.add(this.labelPart("%loopArrow"));break;case "%loop":b=new CSlotMorph;b.isStatic=!0;b.isLoop=!0;b.add(this.labelPart("%loopArrow"));break;case "%loopArrow":b=
new BlockSymbolMorph("loop");b.size=.7*this.fontSize;b.color=WHITE;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;b.isFading=!0;b.fixLayout();break;case "%clr":b=new ColorSlotMorph;b.isStatic=!0;break;case "%t":b=new TemplateSlotMorph("a");break;case "%upvar":b=new TemplateSlotMorph("\u2191");break;case "%f":b=new FunctionSlotMorph;break;case "%r":b=new ReporterSlotMorph;break;case "%p":b=new ReporterSlotMorph(!0);break;case "%codeListPart":b=
new InputSlotMorph(null,!1,{list:["list"],item:["item"],delimiter:["delimiter"]},!0);break;case "%codeListKind":b=new InputSlotMorph(null,!1,{collection:["collection"],variables:["variables"],parameters:["parameters"]},!0);break;case "%turtle":b=new BlockSymbolMorph("turtle");b.size=1.2*this.fontSize;b.color=WHITE;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;b.fixLayout();break;case "%turtleOutline":b=new BlockSymbolMorph("turtleOutline");
b.size=this.fontSize;b.color=WHITE;b.isProtectedLabel=!0;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;b.fixLayout();break;case "%clockwise":b=new BlockSymbolMorph("turnRight");b.size=1.5*this.fontSize;b.color=WHITE;b.isProtectedLabel=!1;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;b.fixLayout();break;case "%counterclockwise":b=new BlockSymbolMorph("turnLeft");b.size=
1.5*this.fontSize;b.color=WHITE;b.isProtectedLabel=!1;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;b.fixLayout();break;case "%greenflag":b=new BlockSymbolMorph("flag");b.size=1.5*this.fontSize;b.color=new Color(0,200,0);b.isProtectedLabel=!0;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;b.fixLayout();break;case "%stop":b=new BlockSymbolMorph("octagon");b.size=1.5*
this.fontSize;b.color=new Color(200,0,0);b.isProtectedLabel=!0;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;b.fixLayout();break;case "%pause":b=new BlockSymbolMorph("pause");b.size=this.fontSize;b.color=new Color(255,220,0);b.isProtectedLabel=!0;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;b.fixLayout();break;case "%blitz":b=new BlockSymbolMorph("flash");b.size=this.fontSize;
b.color=WHITE;b.isProtectedLabel=!1;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;b.fixLayout();break;case "%list":b=new BlockSymbolMorph("list");b.size=this.fontSize;b.color=WHITE;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing;b.fixLayout();break;case "%vid":b=new InputSlotMorph(null,!1,{snap:["snap"],motion:["motion"],direction:["direction"]},!0);b.setContents(["motion"]);
break;case "%on":b=new InputSlotMorph(null,!1,{"this sprite":["this sprite"],stage:["stage"]},!0);break;case "%self":b=new InputSlotMorph(null,!1,"objectsMenuWithSelf",!0);break;case "%vid":b=new InputSlotMorph(null,!1,{snap:["snap"],motion:["motion"],direction:["direction"]},!0);b.setContents(["motion"]);break;default:nop()}}else"$"===a[0]&&1<a.length&&"reportGetVar"!==this.selector?(a=a.slice(1).split("-"),contains(SymbolMorph.prototype.names,a[0])?(b=new BlockSymbolMorph(a[0]),b.size=this.fontSize*
(+a[1]||1.2)):(b=new StringMorph(a[0]),b.fontName=this.labelFontName,b.fontStyle=this.labelFontStyle,b.fontSize=this.fontSize*(+a[1]||1)),b.color=new Color(0===+a[2]?0:+a[2]||255,0===+a[3]?0:+a[3]||255,0===+a[4]?0:+a[4]||255),b.isProtectedLabel=2<a.length,b.shadowColor=this.color.darker(this.labelContrast),b.shadowOffset=MorphicPreferences.isFlat?ZERO:this.embossing,b.fixLayout()):b=new BlockLabelMorph(a,this.fontSize,this.labelFontStyle,!0,!1,!1,MorphicPreferences.isFlat?ZERO:this.embossing,this.color.darker(this.labelContrast),
WHITE,this.labelFontName);return b};SyntaxElementMorph.prototype.isObjInputFragment=function(){return"reportGetVar"===this.selector&&"%t"===this.getSlotSpec()&&"%obj"===this.parent.fragment.type};
SyntaxElementMorph.prototype.fixLayout=function(){var a=this,b,c=this.parts(),d=this.position(),e=0,f=0,g=0,h=this.minWidth,k=[],l=[],m=this.isPrototype?1:Math.floor(fontHeight(this.fontSize)/3),n=this instanceof BlockMorph&&this.hasLocationPin()?this.methodIconExtent().x+m:0,q=!1,p=!1;h=this instanceof MultiArgMorph&&"%cs"!==this.slotSpec?h+this.arrows().width():this instanceof ReporterBlockMorph?h+(2*this.rounding+2*this.edge):h+(4*this.corner+2*this.edge+3*this.inset+this.dent);this.nextBlock&&
(b=this.nextBlock());c.forEach(function(v){v instanceof CSlotMorph||"%cs"===v.slotSpec?0<k.length?(l.push(k),l.push([v]),k=[],e=0):l.push([v]):v instanceof BlockHighlightMorph?nop():(v.isVisible&&(e+=v.fullBounds().width()+m),(e>a.labelWidth||v.isBlockLabelBreak)&&0<k.length&&(l.push(k),k=[],e=v.fullBounds().width()+m),k.push(v),v.isBlockLabelBreak&&(e=0))});0<k.length&&l.push(k);if(this instanceof CommandBlockMorph){var t=this.top()+this.corner+this.edge;this instanceof HatBlockMorph&&(t+=this.hatHeight)}else if(this instanceof
ReporterBlockMorph)t=this.top()+2*this.edge;else if(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)t=this.top(),"%cs"===this.slotSpec&&0<this.inputs().length&&(t-=this.rounding);l.forEach(function(v){q&&(p=!0,q=!1);e=a.left()+n+a.edge+a.labelPadding;if(a instanceof RingMorph)e=a.left()+m;else if(a.isPredicate)e=a.left()+n+a.rounding;else if(a instanceof MultiArgMorph||a instanceof ArgLabelMorph)e=a.left();t+=f;f=0;v.forEach(function(w){w.isLoop&&(q=!0);w instanceof CSlotMorph?(e-=a.labelPadding,
a.isPredicate&&(e=a.left()+n+a.rounding),w.setColor(a.color),w.setPosition(new Point(e,t)),f=w.height()):w instanceof MultiArgMorph&&"%cs"===w.slotSpec?(a.isPredicate&&(e+=a.corner),w.setPosition(new Point(e,t)),f=w.height()):(w.setPosition(new Point(e,t)),w.isBlockLabelBreak||("%c"===w.slotSpec||"%loop"===w.slotSpec?e+=w.width():w.isVisible&&(e+=w.fullBounds().width()+m)),g=Math.max(g,e),f=Math.max(f,w instanceof StringMorph?w.rawHeight():w.height()))});p&&(e+=1.5*a.fontSize,g=Math.max(g,e),p=!1);
v.forEach(function(w){w.moveBy(new Point(0,Math.floor((f-w.height())/2)))})});t+=f;if(this.children.some(function(v){return v instanceof CSlotMorph})){var r=this.bottomPadding;this instanceof ReporterBlockMorph&&!this.isPredicate&&(r=Math.max(this.bottomPadding,this.rounding-this.bottomPadding));t+=r}if(this instanceof CommandBlockMorph)var u=t-this.top()+2*this.corner;else if(this instanceof ReporterBlockMorph)u=t-this.top()+2*this.edge;else if(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)u=
t-this.top();this.isPredicate?h=Math.max(h,g-this.left()+this.rounding):this instanceof MultiArgMorph&&"%cs"!==this.slotSpec||this instanceof ArgLabelMorph?h=Math.max(h,g-this.left()-m):(h=Math.max(h,g-this.left()+this.labelPadding-this.edge),c[c.length-1]instanceof MultiArgMorph&&1===l.length&&(h-=m),this instanceof HatBlockMorph&&(h=Math.max(h,1.5*this.hatWidth)));this.bounds.setWidth(h);this.bounds.setHeight(u);this.holes=[];c.forEach(function(v){var w=0;if(v instanceof CSlotMorph||"%cs"===v.slotSpec)a.isPredicate?
(v.bounds.setWidth(h-n-a.rounding-a.inset-a.corner),w=a.corner):(v.bounds.setWidth(h-a.edge-n),w=a.corner+a.edge),v.fixLoopLayout&&v.fixLoopLayout();"%cs"===v.slotSpec&&v.inputs().forEach(function(x){return x.bounds.setWidth(v.right()-x.left()-w)});v.fixHolesLayout();a.holes.push.apply(a.holes,v.holes.map(function(x){return x.translateBy(v.position().subtract(d))}))});b&&b.setPosition(new Point(this.left(),this.bottom()-this.corner));if(this instanceof BlockMorph&&this.parent&&this.parent.fixLayout&&
(this.parent.fixLayout(),this.parent.changed(),this.parent instanceof SyntaxElementMorph))return;this.fixHighlight()};SyntaxElementMorph.prototype.fixHighlight=function(){var a=this.topBlock();a.getHighlight&&a.getHighlight()&&a.addHighlight(a.removeHighlight())};SyntaxElementMorph.prototype.methodIconExtent=function(){var a=1.2*this.fontSize;return this.hasLocationPin()?new Point(.66*a,a):new Point(0,0)};SyntaxElementMorph.prototype.evaluate=function(){return null};
SyntaxElementMorph.prototype.isEmptySlot=function(){return!1};
SyntaxElementMorph.prototype.showBubble=function(a,b,c){var d=!1,e=this.parentThatIsA(IDE_Morph),f=this,g=this.rightCenter().add(new Point(2,0)),h=this.parentThatIsA(ScrollFrameMorph),k=this.world();if(void 0===a||!k)return null;if(a instanceof ListWatcherMorph){var l=a;l.update(!0);l.step=a.update;l.isDraggable=!1;l.expand(this.parentThatIsA(ScrollFrameMorph).extent());d=!0}else if(a instanceof TableFrameMorph)l=a,l.isDraggable=!1,l.expand(this.parentThatIsA(ScrollFrameMorph).extent()),d=!0;else if(a instanceof
Morph)if(isSnapObject(a)){var m=a.thumbnail(new Point(40,40));l=new Morph;l.isCachingImage=!0;l.bounds.setWidth(m.width);l.bounds.setHeight(m.height);l.cachedImage=m;l.version=a.version;l.step=function(){this.version!==a.version&&(this.cachedImage=m=a.thumbnail(new Point(40,40)),this.version=a.version,this.changed())}}else m=a.fullImage(),l=new Morph,l.isCachingImage=!0,l.bounds.setWidth(m.width),l.bounds.setHeight(m.height),l.cachedImage=m;else a instanceof Costume?(m=a.thumbnail(new Point(40,40)),
l=new Morph,l=new Morph,l.isCachingImage=!0,l.bounds.setWidth(m.width),l.bounds.setHeight(m.height),l.cachedImage=m):a instanceof Sound?l=new SymbolMorph("notes",30):a instanceof Context?(m=a.image(),l=new Morph,l.isCachingImage=!0,l.bounds.setWidth(m.width),l.bounds.setHeight(m.height),l.cachedImage=m):"boolean"===typeof a?l=SpriteMorph.prototype.booleanMorph.call(null,a):isString(a)?(l=500<a.length?a.slice(0,500)+"...":a,l=new TextMorph(l,this.fontSize)):null===a?l=new TextMorph("",this.fontSize):
0===a?l=new TextMorph("0",this.fontSize):a.toString&&(l=new TextMorph(a.toString(),this.fontSize));e&&e.currentSprite!==c&&(c instanceof StageMorph?f=e.corral.stageIcon:c?(c.isTemporary&&(c=detect(c.allExemplars(),function(n){return!n.isTemporary})),f=detect(e.corral.frame.contents.children,function(n){return n.object===c})):c=e,g=f.center());l=new SpeechBubbleMorph(l,null,Math.max(this.rounding-2,6),0);l.popUp(k,g,d);b&&this.exportPictureWithResult(l);f instanceof SpriteIconMorph?l.keepWithin(e.corral):
h&&l.keepWithin(h)};SyntaxElementMorph.prototype.exportPictureWithResult=function(a){var b=this.parentThatIsA(IDE_Morph)||this.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph),c=this.fullImage();a=a.fullImage();var d=newCanvas(new Point(c.width+a.width+2,c.height+Math.max(0,a.height-c.height))),e=d.getContext("2d");e.drawImage(c,0,d.height-c.height);e.drawImage(a,c.width+2,0);b.saveCanvasAs(d,(b.projectName||localize("untitled"))+" "+localize("script pic"))};
SyntaxElementMorph.prototype.mappedCode=function(a){var b=this.evaluate();return b instanceof BlockMorph?b.mappedCode(a):b};BlockLabelMorph.prototype=new StringMorph;BlockLabelMorph.prototype.constructor=BlockLabelMorph;BlockLabelMorph.uber=StringMorph.prototype;function BlockLabelMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}
BlockLabelMorph.prototype.getRenderColor=function(){var a=this.parentThatIsA(BlockMorph);return MorphicPreferences.isFlat?.5<a.alpha?this.color:a.color.solid().darker(Math.max(200*a.alpha,.1)):.5<a.alpha?this.color:a.color.solid().lighter(Math.max(200*a.alpha,.1))};BlockLabelMorph.prototype.getShadowRenderColor=function(){return.5<this.parentThatIsA(BlockMorph).alpha?this.shadowColor:CLEAR};BlockSymbolMorph.prototype=new SymbolMorph;BlockSymbolMorph.prototype.constructor=BlockSymbolMorph;
BlockSymbolMorph.uber=SymbolMorph.prototype;function BlockSymbolMorph(a,b,c,d,e){this.init(a,b,c,d,e)}
BlockSymbolMorph.prototype.getRenderColor=function(){var a=this.parentThatIsA(BlockMorph);return MorphicPreferences.isFlat?this.isFading?this.color.mixed(a.alpha,WHITE):this.color.eq(WHITE)||this.color.eq(BLACK)?.5<this.parent.alpha?this.color:a.color.solid().darker(Math.max(200*a.alpha,.1)):this.color:this.isFading?this.color.mixed(a.alpha,SpriteMorph.prototype.paletteColor):this.color.eq(BLACK)?.5<a.alpha?this.color:a.color.solid().lighter(Math.max(200*a.alpha,.1)):this.color.eq(WHITE)?.5<this.parent.alpha?
this.color:a.color.solid().lighter(Math.max(200*a.alpha,.1)):this.color};BlockSymbolMorph.prototype.getShadowRenderColor=function(){return.5<this.parent.alpha?this.shadowColor:CLEAR};BlockMorph.prototype=new SyntaxElementMorph;BlockMorph.prototype.constructor=BlockMorph;BlockMorph.uber=SyntaxElementMorph.prototype;BlockMorph.prototype.isCachingInputs=!0;BlockMorph.prototype.zebraContrast=40;BlockMorph.prototype.snapSound=null;
BlockMorph.prototype.toggleSnapSound=function(){null!==this.snapSound?this.snapSound=null:(BlockMorph.prototype.snapSound=document.createElement("audio"),BlockMorph.prototype.snapSound.src="src/click.wav");CommentMorph.prototype.snapSound=BlockMorph.prototype.snapSound};function BlockMorph(){this.init()}
BlockMorph.prototype.init=function(){this.selector=this.id=null;this.blockSpec="";this.category=this.instantiationSpec=this.comment=null;this.isCorpse=!1;BlockMorph.uber.init.call(this);this.color=new Color(102,102,102);this.cachedInputs=null};BlockMorph.prototype.scriptTarget=function(){var a=this.parentThatIsA(ScriptsMorph);if(a)return a.scriptTarget();if(a=this.parentThatIsA(IDE_Morph))return a.currentSprite;throw Error("script target cannot be found for orphaned block");};
BlockMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'};BlockMorph.prototype.parseSpec=function(a){var b=[],c="";var d=isString(a)?a.split(" "):[];0===d.length&&(d=[a]);if(this.labelWordWrap)return d;d.forEach(function(e){"%"===e[0]&&1<e.length?(""!==c&&(b.push(c),c=""),b.push(e)):c=""!==c?c+(" "+e):e});""!==c&&b.push(c);return b};
BlockMorph.prototype.setSpec=function(a,b){var c=this,d,e=-1;a&&(this.parts().forEach(function(f){return f.destroy()}),this.isPrototype&&this.add(this.placeHolder()),this.parseSpec(a).forEach(function(f,g,h){"%"===f[0]&&"%br"!==f&&(e+=1);d=c.labelPart(f);isNil(d)||(c.add(d),d instanceof CommandSlotMorph||d instanceof StringMorph||(d.fixLayout(),d.rerender()),d instanceof RingMorph&&d.fixBlockColor(),(d instanceof MultiArgMorph||d.constructor===CommandSlotMorph||d.constructor===RingCommandSlotMorph)&&
d.fixLayout(),c.isPrototype&&c.add(c.placeHolder()),d instanceof InputSlotMorph&&c.isCustomBlock&&d.setChoices.apply(d,(b||c.definition).inputOptionsOfIdx(e)))}),this.blockSpec=a,this.fixLayout(),this.rerender(),this.cachedInputs=null)};BlockMorph.prototype.userSetSpec=function(a){var b=this.topBlock();b.fullChanged();this.setSpec(a);b.fullChanged()};
BlockMorph.prototype.buildSpec=function(){var a=this;this.blockSpec="";this.parts().forEach(function(b){a.blockSpec=b instanceof StringMorph?a.blockSpec+b.text:b instanceof ArgMorph?a.blockSpec+b.getSpec():b.isBlockLabelBreak?a.blockSpec+b.getSpec():a.blockSpec+"[undefined]";a.blockSpec+=" "});this.blockSpec=this.blockSpec.trim()};
BlockMorph.prototype.rebuild=function(a){this.setSpec(this.blockSpec);a&&this.inputs().forEach(function(b){b instanceof ReporterBlockMorph&&(b.setColor(b.color.lighter(a)),b.setSpec(b.blockSpec))})};
BlockMorph.prototype.userMenu=function(){function a(p,t,r,u,v){d.addItem([r?new SymbolMorph("checkedBox",.75*MorphicPreferences.menuFontSize):new SymbolMorph("rectangle",.75*MorphicPreferences.menuFontSize),localize(p)],t,r?u:v)}function b(){var p=f.fullCopy();p.addShadow();(new DialogBoxMorph(f,function(t){SnapActions.setBlockSpec(this,t)},f)).prompt("Variable name",f.blockSpec,e,p.doWithAlpha(1,function(){return p.fullImage()}),InputSlotMorph.prototype.getVarNamesDict.call(f))}var c=this,d=new MenuMorph(this),
e=this.world(),f=this,g=16===e.currentKey,h=this.activeProcess(),k=this.topBlock(),l=h&&h.context&&h.context.outerContext?h.context.outerContext.variables.names():[],m;d.addItem("help...","showHelp");if(this.isTemplate){if(this.parent instanceof SyntaxElementMorph)"reportGetVar"===this.selector&&(d.addLine(),d.addItem("rename...",function(){return c.refactorThisVar(!0)},"rename only\nthis reporter"),d.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable"));else{if("reportGetVar"===
this.selector){var n=this.scriptTarget();this.isInheritedVariable(!1)?a("inherited",function(){return n.toggleInheritedVariable(c.blockSpec)},!0,"uncheck to\ndisinherit",null):(this.isInheritedVariable(!0)&&a("inherited",function(){return n.toggleInheritedVariable(c.blockSpec)},!1,null,localize("check to inherit\nfrom")+" "+n.exemplar.name),a("transient","toggleTransientVariable",this.isTransientVariable(),"uncheck to save contents\nin the project","check to prevent contents\nfrom being saved"),d.addLine(),
d.addItem("rename...",function(){return c.refactorThisVar(!0)},"rename only\nthis reporter"),d.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable"))}else"evaluateCustomBlock"!==this.selector&&d.addItem("hide","hidePrimitive");StageMorph.prototype.enableInheritance&&(n=this.scriptTarget(),(m={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getCostumeIdx:"costume #",getVolume:"volume",getPan:"balance",reportShown:"shown?",getPenDown:"pen down?"}[this.selector])&&
n&&n.exemplar&&(d.addLine(),a("inherited",function(){return n.toggleInheritanceForAttribute(m)},n.inheritsAttribute(m),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+n.exemplar.name)));StageMorph.prototype.enableCodeMapping&&(d.addLine(),d.addItem("header mapping...","mapToHeader"),d.addItem("code mapping...","mapToCode"))}return d}d.addLine();if("reportGetVar"===this.selector)d.addItem("rename...",b,"rename only\nthis reporter");else if(SpriteMorph.prototype.blockAlternatives[this.selector])d.addItem("relabel...",
function(){return c.relabel(SpriteMorph.prototype.blockAlternatives[c.selector])});else if(this.isCustomBlock&&this.alternatives){var q=this.alternatives();0<q.length&&d.addItem("relabel...",function(){return c.relabel(q)})}contains(["reportMap","reportKeep","reportFindFirst","reportCombine"],this.selector)?(q={reportMap:"reportAtomicMap",reportKeep:"reportAtomicKeep",reportFindFirst:"reportAtomicFindFirst",reportCombine:"reportAtomicCombine"},d.addItem("compile",function(){return c.setSelector(q[c.selector])},
"experimental!\nmake this reporter fast and uninterruptable\nCAUTION: Errors in the ring\ncan break your Snap! session!")):contains(["reportAtomicMap","reportAtomicKeep","reportAtomicFindFirst","reportAtomicCombine"],this.selector)?(q={reportAtomicMap:"reportMap",reportAtomicKeep:"reportKeep",reportAtomicFindFirst:"reportFindFirst",reportAtomicCombine:"reportCombine"},d.addItem("uncompile",function(){return c.setSelector(q[c.selector])})):contains(["reportPenTrailsAsCostume","reportPentrailsAsSVG"],
this.selector)&&(q={reportPenTrailsAsCostume:"reportPentrailsAsSVG",reportPentrailsAsSVG:"reportPenTrailsAsCostume"},d.addItem(localize(SpriteMorph.prototype.blocks[q[this.selector]].spec),function(){c.setSelector(q[c.selector]);c.changed()}));d.addItem("duplicate",function(){var p=c.fullCopy(),t=c.parentThatIsA(IDE_Morph),r=c.parentThatIsA(BlockEditorMorph);p.id=null;p.pickUp(e);!t&&r&&(t=r.target.parentThatIsA(IDE_Morph));t&&(e.hand.grabOrigin={origin:t.palette,position:t.palette.center()})},"make a copy\nand pick it up");
this instanceof CommandBlockMorph&&this.nextBlock()&&d.addItem((h?this.fullCopy():this).thumbnail(.5,60),function(){var p=c.fullCopy(),t=p.nextBlock(),r=c.parentThatIsA(IDE_Morph),u=c.parentThatIsA(BlockEditorMorph);t&&t.destroy();p.id=null;p.pickUp(e);!r&&u&&(r=u.target.parentThatIsA(IDE_Morph));r&&(e.hand.grabOrigin={origin:r.palette,position:r.palette.center()})},"only duplicate this block");d.addItem("delete",function(){this.id?SnapActions.removeBlock(this,!0):this.userDestroy()});d.addItem("script pic...",
function(){var p=c.parentThatIsA(IDE_Morph)||c.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph);p.saveCanvasAs(k.scriptPic(),(p.projectName||localize("untitled"))+" "+localize("script pic"))},"save a picture\nof this script");k instanceof ReporterBlockMorph&&d.addItem("result pic...",function(){return k.exportResultPic()},"save a picture of both\nthis script and its result");g&&d.addItem("download script",function(){var p=c.parentThatIsA(IDE_Morph),t=c.parentThatIsA(BlockEditorMorph);
!p&&t&&(p=t.target.parentThatIsA(IDE_Morph));p&&p.saveXMLAs(p.serializer.serialize(c),c.selector+" script",!1)},"download this script\nas an XML file",new Color(100,0,0));if(h)return l.length&&(d.addLine(),l.forEach(function(p){return d.addItem(p+"...",function(){return h.doShowVar(p)})})),h.homeContext.variables.names().forEach(function(p){contains(l,p)||d.addItem(p+"...",function(){return h.doShowVar(p)})}),d;if(this.parent.parentThatIsA(RingMorph))return d.addLine(),d.addItem("unringify",function(){SnapActions.unringify(this)}),
k=this.topBlock(),!(this instanceof ReporterBlockMorph)&&k instanceof HatBlockMorph||d.addItem("ringify",function(){SnapActions.ringify(this)}),d;contains("doBroadcast doSend doBroadcastAndWait receiveMessage receiveOnClone receiveGo".split(" "),this.selector)&&(d.addLine(),d.addItem(0===this.selector.indexOf("receive")?"senders...":"receivers...","showMessageUsers"));if(this.parent instanceof ReporterSlotMorph||this.parent instanceof CommandSlotMorph||this instanceof HatBlockMorph||this instanceof
CommandBlockMorph&&k instanceof HatBlockMorph)return d;d.addLine();d.addItem("ringify",function(){SnapActions.ringify(this)});StageMorph.prototype.enableCodeMapping&&(d.addLine(),d.addItem("header mapping...","mapToHeader"),d.addItem("code mapping...","mapToCode"));return d};
BlockMorph.prototype.showMessageUsers=function(){var a=this,b=this.parentThatIsA(IDE_Morph).corral,c=0===this.selector.indexOf("receive")?"allSendersOf":"allHatBlocksFor",d=this.inputs(),e;"receiveGo"===this.selector?e="__shout__go__":"receiveOnClone"===this.selector?e="__clone__init__":d[0]instanceof InputSlotMorph&&(e=d[0].evaluate());if("doSend"===this.selector&&d[1]instanceof InputSlotMorph)var f=this.inputs()[1].evaluate();else 0===this.selector.indexOf("receive")&&(f=this.scriptTarget().name);
""!==e&&b.frame.contents.children.concat(b.stageIcon).forEach(function(g){g.object&&("doSend"!==a.selector||f===g.object.name)&&0<g.object[c](e,f).length&&g.flash()})};BlockMorph.prototype.developersMenu=function(){var a=this,b=BlockMorph.uber.developersMenu.call(this);b.addLine();b.addItem("delete block","deleteBlock");b.addItem("spec...",function(){return(new DialogBoxMorph(a,function(c){SnapActions.setBlockSpec(this,c)},a)).prompt(b.title+"\nspec",a.blockSpec,a.world())});return b};
BlockMorph.prototype.hidePrimitive=function(){var a=this.parentThatIsA(IDE_Morph);if(a){StageMorph.prototype.hiddenPrimitives[this.selector]=!0;var b={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category;"lists"===b&&(b="variables");a.flushBlocksCache(b);a.refreshPalette()}};
BlockMorph.prototype.isInheritedVariable=function(a){return this.isTemplate&&"reportGetVar"===this.selector&&this.parent instanceof FrameMorph?contains(this.scriptTarget().inheritedVariableNames(a),this.blockSpec):!1};BlockMorph.prototype.isTransientVariable=function(){var a=this.scriptTarget().variables.silentFind(this.blockSpec);return a?a.vars[this.blockSpec].isTransient:!1};
BlockMorph.prototype.toggleTransientVariable=function(){var a=this.scriptTarget().variables.silentFind(this.blockSpec);a&&(a.vars[this.blockSpec].isTransient=!a.vars[this.blockSpec].isTransient)};
BlockMorph.prototype.deleteBlock=function(){var a=this.parentThatIsA(ScriptsMorph),b=this.nextBlock?this.nextBlock():null,c,d;a&&(b&&a.add(b),this.inputs().forEach(function(e){e instanceof BlockMorph&&a.add(e)}));this instanceof ReporterBlockMorph&&(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)?this.parent.revertToDefaultInput(this):this.parent&&this.parent.fixLayout?c=this.parentThatIsA(ArgMorph):d=!0;this.destroy();d&&(this.isCorpse=
!0);c&&c.fixLayout()};
BlockMorph.prototype.ringify=function(){var a=this.selectForEdit();if(a!==this)return this.ringify.call(a);a=new RingMorph;var b=this.topBlock();var c=b.fullBounds().center();if(null===this.parent)return null;b.fullChanged();if(this.parent instanceof SyntaxElementMorph)if(this instanceof ReporterBlockMorph)this.parent.replaceInput(this,a,!0),a.embed(this,null,!0);else{if(b){if(b instanceof HatBlockMorph)return;b.parent.add(a);a.embed(b);a.setCenter(c)}}else this.parent.add(a),a.embed(this),a.setCenter(c);
this.fixBlockColor(null,!0);b.fullChanged();return a};
BlockMorph.prototype.unringify=function(){var a=this.selectForEdit();if(a!==this)return this.unringify.call(a);a=this.parent.parentThatIsA(RingMorph);var b=this.topBlock();var c=this.parentThatIsA(ScriptsMorph);if(null===a)return null;var d=a.contents();var e=a.center();b.fullChanged();a.parent instanceof SyntaxElementMorph?d instanceof ReporterBlockMorph?a.parent.replaceInput(a,d):c&&(c.add(d),d.setFullCenter(e),d.moveBy(20),a.parent.revertToDefaultInput(a)):(a.parent.add(d),d.setFullCenter(e),a.destroy());
this.fixBlockColor(null,!0);b.fullChanged();return a};
BlockMorph.prototype.relabel=function(a){var b=this,c=this.selectForEdit();if(c!==this)return this.relabel.call(c,a);var d=new MenuMorph(this);var e=this.inputs();a.forEach(function(f){if(f instanceof Array){var g=f[0];f=-f[1]}else g=f,f=0;var h=SpriteMorph.prototype.blockForSelector(g,!0);h.restoreInputs(e,f);h.fixBlockColor(null,!0);h.addShadow(new Point(3,3));d.addItem(h.doWithAlpha(1,function(){return h.fullImage()}),function(){return SnapActions.setSelector(b,g)})});d.popup(this.world(),this.bottomLeft().subtract(new Point(8,
this instanceof CommandBlockMorph?this.corner:0)))};
BlockMorph.prototype.setSelector=function(a,b){b=void 0===b?0:b;var c=this.inputs(),d=this.parentThatIsA(ScriptsMorph);var e=SpriteMorph.prototype.blocks[a];this.setCategory(e.category);this.selector=a;this.setSpec(localize(e.spec));this.defaults=e.defaults||[];a=this.inputs();if(a[0]instanceof MultiArgMorph)a[0].setContents(this.defaults),a[0].defaults=this.defaults;else for(e=0;e<this.defaults.length;e+=1)null!==this.defaults[e]&&a[e].setContents&&a[e].setContents(this.defaults[e]);b=this.restoreInputs(c,
-b);this.fixLabelColor();d&&b.length&&b.forEach(function(f){f.moveBy(10);d.add(f)})};
BlockMorph.prototype.restoreInputs=function(a,b){var c=this;b=void 0===b?0:b;var d,e,f=[];for(e=0;e<b;e+=1){var g=a[e];g instanceof ReporterBlockMorph?f.push(g):g instanceof CommandSlotMorph&&(d=g.nestedBlock())&&f.push(d)}this.inputs().forEach(function(h){g=a[b];g instanceof RingMorph?g.contents()&&c.replaceInput(h,g.fullCopy()):g instanceof ReporterBlockMorph?h instanceof TemplateSlotMorph||h.isStatic?f.push(g):c.replaceInput(h,g.fullCopy()):g&&h instanceof InputSlotMorph?g.contents&&(h.setContents(g.contents().text),
g.constant&&(h.constant=g.constant)):g instanceof CSlotMorph&&h instanceof CSlotMorph&&(d=g.nestedBlock())&&h.nestedBlock(d.fullCopy());b+=1});for(b;b<a.length;b+=1)g=a[b],g instanceof ReporterBlockMorph?f.push(g):g instanceof CommandSlotMorph&&(d=g.nestedBlock())&&f.push(d);this.cachedInputs=null;return f};
BlockMorph.prototype.showHelp=function(){var a=this,b=this.parentThatIsA(IDE_Morph),c,d=new Image,e,f;var g=this.isCustomBlock?this.isGlobal?this.definition.helpSpec():this.scriptTarget().getMethod(this.blockSpec).helpSpec():this.selector;b||(c=this.parentThatIsA(BlockEditorMorph))&&(b=c.target.parentThatIsA(IDE_Morph));d.onload=function(){k=newCanvas(new Point(d.width,d.height),!0);f=k.getContext("2d");f.drawImage(d,0,0);(new DialogBoxMorph).inform("Help",null,a.world(),k)};if(this.isCustomBlock&&
(c=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec),e=c.comment)){var h=c.blockInstance();h.refreshDefaults(c);e=e.fullCopy();e.contents.parse();var k="";e.contents.lines.forEach(function(l){return k=k+"\n"+l});(new DialogBoxMorph).inform("Help",k.substr(1),a.world(),h.doWithAlpha(1,function(){h.addShadow();return h.fullImage()}));return}d.src=b.resourceURL("help",g+".png")};
BlockMorph.prototype.mapToHeader=function(){var a=this,b="reify"===this.selector.substr(0,5)?"reify":this.selector,c=this.codeDefinitionHeader();c.addShadow(new Point(3,3));var d=c.doWithAlpha(1,function(){return c.fullImage()});var e=this.isCustomBlock?"Enter code that corresponds to the block's definition. Use the formal parameter\nnames as shown and <body> to reference the definition body's generated text code.":"Enter code that corresponds to the block's definition. Choose your own\nformal parameter names (ignoring the ones shown).";
(new DialogBoxMorph(this,function(f){"evaluateCustomBlock"===b?a.definition.codeHeader=f:StageMorph.prototype.codeHeaders[b]=f},this)).promptCode("Header mapping","evaluateCustomBlock"===b?this.definition.codeHeader||"":StageMorph.prototype.codeHeaders[b]||"",this.world(),d,e)};
BlockMorph.prototype.mapToCode=function(){var a=this,b="reify"===this.selector.substr(0,5)?"reify":this.selector,c=this.codeMappingHeader();c.addShadow(new Point(3,3));var d=c.doWithAlpha(1,function(){return c.fullImage()});(new DialogBoxMorph(this,function(e){"evaluateCustomBlock"===b?a.definition.codeMapping=e:StageMorph.prototype.codeMappings[b]=e},this)).promptCode("Code mapping","evaluateCustomBlock"===b?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[b]||"",this.world(),d,
"Enter code that corresponds to the block's operation (usually a single\nfunction invocation). Use <#n> to reference actual arguments as shown.")};BlockMorph.prototype.mapHeader=function(a,b){b=b||"reify"===this.selector.substr(0,5)?"reify":this.selector;a&&(this.isCustomBlock?this.definition.codeHeader=a:StageMorph.prototype.codeHeaders[b]=a)};
BlockMorph.prototype.mapCode=function(a,b){b=b||"reify"===this.selector.substr(0,5)?"reify":this.selector;a&&(this.isCustomBlock?this.definition.codeMapping=a:StageMorph.prototype.codeMappings[b]=a)};
BlockMorph.prototype.mappedCode=function(a){var b="reify"===this.selector.substr(0,5)?"reify":this.selector,c=1,d=this.isCustomBlock?this.definition.spec:b,e=a||{},f=[];var g="reportGetVar"===b?this.blockSpec:this.isCustomBlock?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[b]||"";if("reportGetVar"!==b&&!e.hasOwnProperty(d))if(e[d]=null,this.isCustomBlock){b=this.definition.codeHeader||"";if(-1!==b.indexOf("<body")){var h="";this.definition.body&&(h=this.definition.body.expression.mappedCode(e));
var k=h.split("\n");var l=b.split("\n");l.forEach(function(q,p){var t="";0===q.trimLeft().indexOf("<body")&&(t=q.indexOf("<body"),t=q.slice(0,t));l[p]=q.replace(/<body>/,k.join("\n"+t));l[p]=l[p].replace(/<body>/g,k.join("\n"))});b=l.join("\n")}e[d]=b}else e[d]=StageMorph.prototype.codeHeaders[d];var m=g.split("\n");this.inputs().forEach(function(q){return f.push(q.mappedCode(e).toString())});f.forEach(function(q){var p=q.split("\n"),t="<#"+c+">",r=new RegExp(t,"g");m.forEach(function(u,v){var w=
"";0===u.trimLeft().indexOf(t)&&(w=u.indexOf(t),w=u.slice(0,w));m[v]=u.replace(new RegExp(t),p.join("\n"+w));m[v]=m[v].replace(r,p.join("\n"))});c+=1});g=m.join("\n");this.nextBlock&&this.nextBlock()&&(g+="\n"+this.nextBlock().mappedCode(e));if(!a){var n=[];Object.keys(e).forEach(function(q){e[q]&&n.push(e[q])});if(n.length)return n.join("\n\n")+"\n\n"+g}return g};
BlockMorph.prototype.codeDefinitionHeader=function(){var a=this.isCustomBlock?new PrototypeHatBlockMorph(this.definition):SpriteMorph.prototype.blockForSelector(this.selector),b=new HatBlockMorph,c=1;if(this.isCustomBlock)return a;a.inputs().forEach(function(d){var e=new TemplateSlotMorph("#"+c);a.replaceInput(d,e);c+=1});a.isPrototype=!0;b.setCategory("control");b.setSpec("%s");b.replaceInput(b.inputs()[0],a);"control"===this.category&&b.alternateBlockColor();return b};
BlockMorph.prototype.codeMappingHeader=function(){var a=this.isCustomBlock?this.definition.blockInstance():SpriteMorph.prototype.blockForSelector(this.selector),b=new HatBlockMorph,c=1;a.inputs().forEach(function(d){var e=new TemplateSlotMorph("<#"+c+">");a.replaceInput(d,e);c+=1});a.isPrototype=!0;b.setCategory("control");b.setSpec("%s");b.replaceInput(b.inputs()[0],a);"control"===this.category&&b.alternateBlockColor();return b};
BlockMorph.prototype.refactorThisVar=function(a){var b=this.scriptTarget(),c=this.instantiationSpec||this.blockSpec,d=this.fullCopy();d.addShadow();(new DialogBoxMorph(this,function(e){this.parent instanceof SyntaxElementMorph?this.parentThatIsA(BlockEditorMorph)?this.doRefactorBlockParameter(c,e,a):this.parentThatIsA(RingMorph)?this.doRefactorRingParameter(c,e,a):this.doRefactorScriptVar(c,e,a):b.hasSpriteVariable(c)?this.doRefactorSpriteVar(c,e,a):this.doRefactorGlobalVar(c,e,a)},this)).prompt("Variable name",
c,this.world(),d.doWithAlpha(1,function(){return d.fullImage()}),InputSlotMorph.prototype.getVarNamesDict.call(this))};BlockMorph.prototype.varExistsError=function(a,b){a.inform("Variable exists","A variable with this name already exists "+(b||"in this context")+".")};
BlockMorph.prototype.doRefactorBlockParameter=function(a,b,c){var d=this.parentThatIsA(BlockInputFragmentMorph),e=d.fragment.copy(),f=d.parent,g=this.parentThatIsA(BlockEditorMorph),h=g.body.contents;f.anyChild(function(k){return k.blockSpec===b})?this.varExistsError(g.target.parentThatIsA(IDE_Morph)):(e.labelString=b,d.updateBlockLabel(e),c||h.children.forEach(function(k){return k.refactorVarInStack(a,b)}))};
BlockMorph.prototype.doRefactorRingParameter=function(a,b,c){var d=this.parentThatIsA(RingMorph),e=d.contents(),f=this.topBlock();contains(d.inputNames(),b)?this.varExistsError(this.parentThatIsA(IDE_Morph)):(f.fullChanged(),this.setSpec(b),c||e&&e.refactorVarInStack(a,b),f.fullChanged())};
BlockMorph.prototype.doRefactorScriptVar=function(a,b,c){var d=this.parentThatIsA(CommandBlockMorph);d.definesScriptVariable(b)?(a=this.scriptTarget(),a=a.parentThatIsA(IDE_Morph),this.varExistsError(a)):(this.userSetSpec(b),c||d.refactorVarInStack(a,b,!0))};
BlockMorph.prototype.doRefactorSpriteVar=function(a,b,c){var d=this.scriptTarget(),e=d.parentThatIsA(IDE_Morph),f=d.findVariableWatcher(a);if(d.hasSpriteVariable(b))this.varExistsError(e);else if(isNil(e.globalVariables.vars[b])){var g=d.variables.getVar(a);d.deleteVariable(a);d.addVariable(b,!1);d.variables.setVar(b,g);f&&f.isVisible&&(g=d.toggleVariableWatcher(b,!1),g.setPosition(f.position()));c||(d.refactorVariableInstances(a,b,!1),d.customBlocks.forEach(function(h){return h.body.expression.refactorVarInStack(a,
b)}));e.flushBlocksCache("variables");e.refreshPalette()}else this.varExistsError(e,"as a global variable")};
BlockMorph.prototype.doRefactorGlobalVar=function(a,b,c){var d=this.scriptTarget(),e=d.parentThatIsA(IDE_Morph),f=e?e.stage:null,g=d.findVariableWatcher(a);if(isNil(e.globalVariables.vars[b]))if(detect(f.children,function(k){return k instanceof SpriteMorph&&k.hasSpriteVariable(b)}))this.varExistsError(e,"as a sprite local variable");else{var h=e.globalVariables.getVar(a);f.deleteVariable(a);f.addVariable(b,!0);e.globalVariables.setVar(b,h);g&&g.isVisible&&(d=d.toggleVariableWatcher(b,!0),d.setPosition(g.position()));
c||(f.refactorVariableInstances(a,b,!0),f.globalBlocks.forEach(function(k){k.body&&k.body.expression.refactorVarInStack(a,b)}),f.forAllChildren(function(k){k instanceof SpriteMorph&&(k.refactorVariableInstances(a,b,!0),k.customBlocks.forEach(function(l){return l.body.expression.refactorVarInStack(a,b)}))}));e.flushBlocksCache("variables");e.refreshPalette()}else this.varExistsError(e)};
BlockMorph.prototype.thumbnail=function(a,b){var c=this.nextBlock();c&&(c.isVisible=!1);var d=this.fullBounds().extent();var e=newCanvas(new Point(b?Math.min(d.x*a,b):d.x*a,d.y*a));var f=e.getContext("2d");f.scale(a,a);f.drawImage(this.fullImage(),0,0);b&&d.x*a>b&&(b=f.createLinearGradient(e.width/a-12,0,e.width/a,0),b.addColorStop(0,"transparent"),b.addColorStop(1,"black"),f.globalCompositeOperation="destination-out",f.fillStyle=b,f.fillRect(e.width/a-12,0,e.width/a,e.height/a));c&&(c.isVisible=
!0);return e};BlockMorph.prototype.scriptPic=function(){var a=this.fullImage(),b=this.stackFullBounds(),c=newCanvas(b.extent()),d=c.getContext("2d");this.allComments().forEach(function(e){return d.drawImage(e.fullImage(),e.fullBounds().left()-b.left(),e.top()-b.top())});d.drawImage(a,0,0);return c};
BlockMorph.prototype.fullImage=function(){var a=this;if(1===this.alpha)return BlockMorph.uber.fullImage.call(this);this.forAllChildren(function(f){f instanceof BlockMorph&&f.mouseLeaveBounds()});var b=BlockMorph.uber.fullImage.call(this);var c=this.doWithAlpha(1,function(){return BlockMorph.uber.fullImage.call(a)});var d=newCanvas(this.fullBounds().extent());var e=d.getContext("2d");e.fillStyle=ScriptsMorph.prototype.getRenderColor().toString();e.fillRect(0,0,d.width,d.height);e.globalCompositeOperation=
"destination-in";e.drawImage(c,0,0);e.globalCompositeOperation="source-over";e.drawImage(b,0,0);return d};BlockMorph.prototype.clearAlpha=function(){this.forAllChildren(function(a){a instanceof BlockMorph&&delete a.alpha})};
BlockMorph.prototype.render=function(a){this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();MorphicPreferences.isFlat?(a.fillStyle=this.cachedClrDark,a.beginPath(),this.outlinePath(a,0),a.closePath(),a.fill(),a.fillStyle=this.cachedClr,a.beginPath(),this.outlinePath(a,this.flatEdge),a.closePath(),a.fill()):(a.fillStyle=this.cachedClr,a.beginPath(),this.outlinePath(a,0),a.closePath(),a.fill(),this.drawEdges(a));this.hasLocationPin()&&this.drawMethodIcon(a)};
BlockMorph.prototype.drawMethodIcon=function(a){var b=this.methodIconExtent(),c=b.y;b=b.x/2;var d=this.edge+this.labelPadding,e=this.edge,f=this.color===SpriteMorph.prototype.blockColor[this.category];this.isPredicate&&(d=this.rounding);this instanceof CommandBlockMorph&&(e+=this.corner);a.fillStyle=f?this.cachedClrBright:this.cachedClrDark;a.beginPath();a.arc(d+b,e+b,b,radians(-210),radians(30),!1);a.lineTo(d+b,e+c);a.closePath();a.fill();a.fillStyle=this.cachedClr;a.beginPath();a.arc(d+b,e+b,.4*
b,radians(0),radians(360),!1);a.closePath();a.fill()};BlockMorph.prototype.cSlots=function(){var a=[];this.parts().forEach(function(b){b instanceof CSlotMorph?a.push(b):b instanceof MultiArgMorph&&b.parts().forEach(function(c){c instanceof CSlotMorph&&a.push(c)})});return a};BlockMorph.prototype.hasLocationPin=function(){return this.isCustomBlock&&!this.isGlobal||this.isLocalVarTemplate};
BlockMorph.prototype.addHighlight=function(a){var b=!this.isVisible;b&&this.show();1>SyntaxElementMorph.prototype.alpha&&this.clearAlpha();a=this.highlight(a?a.color:this.activeHighlight,this.activeBlur,this.activeBorder);this.addBack(a);this.fullChanged();b&&this.hide();return a};
BlockMorph.prototype.addErrorHighlight=function(){var a=!this.isVisible;a&&this.show();this.removeHighlight();var b=this.highlight(this.errorHighlight,this.activeBlur,this.activeBorder);this.addBack(b);this.fullChanged();a&&this.hide();return b};BlockMorph.prototype.removeHighlight=function(){var a=this.getHighlight();null!==a&&(this.fullChanged(),this.removeChild(a));return a};BlockMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()};
BlockMorph.prototype.highlight=function(a,b,c){var d=new BlockHighlightMorph,e=this.fullBounds(),f=useBlurredShadows&&!MorphicPreferences.isFlat?b:c;d.bounds.setExtent(e.extent().add(2*f));d.holes=[d.bounds];d.color=a;d.cachedImage=useBlurredShadows&&!MorphicPreferences.isFlat?this.highlightImageBlurred(a,b):this.highlightImage(a,c);d.setPosition(e.origin.subtract(new Point(f,f)));return d};
BlockMorph.prototype.highlightImage=function(a,b){var c=this,d;var e=this.fullBounds().extent();this.doWithAlpha(1,function(){return d=c.fullImage()});var f=newCanvas(e.add(2*b));var g=f.getContext("2d");g.drawImage(d,0,0);g.drawImage(d,b,0);g.drawImage(d,2*b,0);g.drawImage(d,2*b,b);g.drawImage(d,2*b,2*b);g.drawImage(d,b,2*b);g.drawImage(d,0,2*b);g.drawImage(d,0,b);g.globalCompositeOperation="destination-out";g.drawImage(d,b,b);b=newCanvas(e.add(2*b));g=b.getContext("2d");g.drawImage(f,0,0);g.globalCompositeOperation=
"source-atop";g.fillStyle=a.toString();g.fillRect(0,0,b.width,b.height);return b};BlockMorph.prototype.highlightImageBlurred=function(a,b){var c=this,d;var e=this.fullBounds().extent();this.doWithAlpha(1,function(){return d=c.fullImage()});e=newCanvas(e.add(2*b));var f=e.getContext("2d");f.shadowBlur=b;f.shadowColor=a.toString();f.drawImage(d,b,b);f.shadowBlur=0;f.globalCompositeOperation="destination-out";f.drawImage(d,b,b);return e};
BlockMorph.prototype.getHighlight=function(){var a=this.children.slice(0).reverse().filter(function(b){return b instanceof BlockHighlightMorph});return 0!==a.length?a[0]:null};BlockMorph.prototype.outline=function(a,b){var c=new BlockHighlightMorph,d=this.fullBounds();c.bounds.setExtent(d.extent().add(2*b));c.color=a;c.cachedImage=this.highlightImage(a,b);c.setPosition(d.origin.subtract(new Point(b,b)));return c};
BlockMorph.prototype.getCategoryColor=function(a){return SpriteMorph.prototype.blockColor[a]||SpriteMorph.prototype.blockColor.other};
BlockMorph.prototype.fixBlockColor=function(a,b){var c;if(this.zebraContrast||b){if(!this.zebraContrast&&b)return this.forceNormalColoring(!0);!a&&this.parent&&(this.isPrototype?a=null:this instanceof ReporterBlockMorph?a=this.parent.parentThatIsA(BlockMorph):(c=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph))&&(a=c.parentThatIsA(BlockMorph)));a?a.category===this.category?a.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(this.getCategoryColor(this.category))&&
this.alternateBlockColor():(a=this.getCategoryColor(this.category),this.color.eq(a)||this.alternateBlockColor());b&&this.fixChildrensBlockColor(!0)}};BlockMorph.prototype.forceNormalColoring=function(){var a=this.getCategoryColor(this.category);this.setColor(a);this.setLabelColor(WHITE,a.darker(this.labelContrast),MorphicPreferences.isFlat?ZERO:this.embossing);this.fixChildrensBlockColor(!0)};
BlockMorph.prototype.alternateBlockColor=function(){var a=this.getCategoryColor(this.category);this.color.eq(a)?this.setColor(0>this.zebraContrast?a.darker(Math.abs(this.zebraContrast)):a.lighter(this.zebraContrast),this.hasLabels()):this.setColor(a,this.hasLabels());this.fixLabelColor();this.fixChildrensBlockColor(!0)};BlockMorph.prototype.ghost=function(){this.setColor(this.getCategoryColor(this.category).lighter(35))};
BlockMorph.prototype.fixLabelColor=function(){if(0<this.zebraContrast&&this.category){var a=this.getCategoryColor(this.category);this.color.eq(a)?this.setLabelColor(WHITE,a.darker(this.labelContrast),MorphicPreferences.isFlat?null:this.embossing):this.setLabelColor(BLACK,a.lighter(this.zebraContrast).lighter(2*this.labelContrast),MorphicPreferences.isFlat?null:this.embossing.neg())}};
BlockMorph.prototype.fixChildrensBlockColor=function(a){var b=this;this.children.forEach(function(c){c instanceof CommandBlockMorph?c.fixBlockColor(null,a):c instanceof SyntaxElementMorph&&(c.fixBlockColor(b,a),c instanceof BooleanSlotMorph&&c.fixLayout())})};BlockMorph.prototype.setCategory=function(a){this.category=a;this.fixBlockColor()};BlockMorph.prototype.hasLabels=function(){return this.children.some(function(a){return a instanceof StringMorph})};
BlockMorph.prototype.copy=function(){var a=BlockMorph.uber.copy.call(this);a.id=this.id;return a};
BlockMorph.prototype.fullCopy=function(){var a=BlockMorph.uber.fullCopy.call(this);a.removeHighlight();a.isDraggable=!0;this.instantiationSpec&&a.setSpec(this.instantiationSpec);a.allChildren().filter(function(b){b instanceof SyntaxElementMorph&&(b.cachedInputs=null,b.isCustomBlock&&b.initializeVariables());return!isNil(b.comment)}).forEach(function(b){var c=b.comment.fullCopy();b.comment=c;c.block=b});a.cachedInputs=null;return a};
BlockMorph.prototype.reactToTemplateCopy=function(){this.isLocalVarTemplate&&(this.isLocalVarTemplate=null,this.fixLayout());this.forceNormalColoring()};BlockMorph.prototype.hasBlockVars=function(){return this.anyChild(function(a){return a.isCustomBlock&&a.isGlobal&&a.definition.variableNames.length})};BlockMorph.prototype.pickUp=function(a){a=a||this.world();this.setPosition(a.hand.position().subtract(this.rounding));a.hand.grab(this)};
BlockMorph.prototype.mouseClickLeft=function(){var a=this.topBlock(),b=a.scriptTarget(),c;if(16===this.world().currentKey&&!this.isTemplate)return this.selectForEdit().focus();if(!(a instanceof PrototypeHatBlockMorph)&&b&&(c=b.parentThatIsA(StageMorph))){var d=c.threads.findProcess(a);if("receiveSocketMessage"!==a.selector||d)c.threads.toggleProcess(a,b),a.id&&SnapActions.startScript(a,d)}};
BlockMorph.prototype.focus=function(){var a=this.parentThatIsA(ScriptsMorph),b=this.world();if(a&&ScriptsMorph.prototype.enableKeyboard){a.focus&&a.focus.stopEditing();b.stopEditing();var c=new ScriptFocusMorph(a,this);a.focus=c;c.getFocus(b);this instanceof HatBlockMorph&&c.nextCommand()}};BlockMorph.prototype.activeProcess=function(){var a=this.topBlock(),b=a.scriptTarget(),c;return a instanceof PrototypeHatBlockMorph?null:b&&(c=b.parentThatIsA(StageMorph))?c.threads.findProcess(a,b):null};
BlockMorph.prototype.mouseEnterBounds=function(a){!a&&1>this.alpha&&(this.alpha=Math.min(this.alpha+.2,1),this.rerender())};BlockMorph.prototype.mouseLeaveBounds=function(a){1>SyntaxElementMorph.prototype.alpha&&(delete this.alpha,this.rerender())};BlockMorph.prototype.rootForGrab=function(){return this};BlockMorph.prototype.wantsDropOf=function(a){return(a instanceof ArgMorph||a instanceof StringMorph||a instanceof TextMorph)&&!this.isTemplate};
BlockMorph.prototype.reactToDropOf=function(a){a.isDraggable=!1;a.fixLayout();this.fixLayout();this.buildSpec()};BlockMorph.prototype.situation=function(){if(!(this.parent instanceof TemplateSlotMorph)){var a=this.parentThatIsA(ScriptsMorph);if(a)return{origin:this.parent,position:this.position().subtract(a.position())}}return BlockMorph.uber.situation.call(this)};
BlockMorph.prototype.prepareToBeGrabbed=function(a){var b=this,c=a?a.world:this.world();this.allInputs().forEach(function(d){return delete d.bindingID});this.allComments().forEach(function(d){return d.startFollowing(b,c)})};BlockMorph.prototype.justDropped=function(){delete this.alpha;this.allComments().forEach(function(a){return a.stopFollowing()})};BlockMorph.prototype.allComments=function(){return this.allChildren().filter(function(a){return!isNil(a.comment)}).map(function(a){return a.comment})};
BlockMorph.prototype.destroy=function(a){a?isNil(this.comment)||this.comment.destroy():this.allComments().forEach(function(b){return b.destroy()});BlockMorph.uber.destroy.call(this)};BlockMorph.prototype.stackHeight=function(){var a=this.fullBounds(),b=Math.max(this.allComments().map(function(c){return c.bottom()}))||this.bottom();return Math.max(a.bottom(),b)-a.top()};
BlockMorph.prototype.stackFullBounds=function(){var a=this.fullBounds();this.allComments().forEach(function(b){return a.mergeWith(b.bounds)});return a};BlockMorph.prototype.stackWidth=function(){var a=this.fullBounds(),b=Math.max(this.allComments().map(function(c){return c.right()}))||this.right();return Math.max(a.right(),b)-a.left()};BlockMorph.prototype.snapTarget=function(){return null};
BlockMorph.prototype.snap=function(){var a=this.topBlock(),b;a.allComments().forEach(function(c){return c.align(a)});this.getHighlight()&&this!==a&&this.removeHighlight();a.getHighlight()&&a.addHighlight(a.removeHighlight());"receiveCondition"===this.selector&&(b=a.scriptTarget())&&(b=b.parentThatIsA(StageMorph))&&(b.enableCustomHatBlocks=!0,b.threads.pauseCustomHatBlocks=!1,(b=b.parentThatIsA(IDE_Morph))&&b.controlBar.stopButton.refresh())};CommandBlockMorph.prototype=new BlockMorph;
CommandBlockMorph.prototype.constructor=CommandBlockMorph;CommandBlockMorph.uber=BlockMorph.prototype;function CommandBlockMorph(){this.init()}CommandBlockMorph.prototype.init=function(){CommandBlockMorph.uber.init.call(this);this.bounds.setExtent((new Point(60,24)).multiplyBy(this.scale));this.fixLayout();this.rerender();this.partOfCustomCommand=!1;this.exitTag=null};CommandBlockMorph.prototype.blockSequence=function(){var a=this.nextBlock(),b=[this];a&&(b=b.concat(a.blockSequence()));return b};
CommandBlockMorph.prototype.bottomBlock=function(){return this.nextBlock()?this.nextBlock().bottomBlock():this};CommandBlockMorph.prototype.nextBlock=function(a){if(a){var b=this.nextBlock(),c=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph);this.add(a);b&&a.bottomBlock().nextBlock(b);a.setPosition(new Point(this.left(),this.bottom()-this.corner));c&&c.fixLayout()}else return detect(this.children,function(d){return d instanceof CommandBlockMorph&&!d.isPrototype})};
CommandBlockMorph.prototype.topAttachPoint=function(){return new Point(this.dentCenter(),this.top())};CommandBlockMorph.prototype.bottomAttachPoint=function(){return new Point(this.dentCenter(),this.bottom())};CommandBlockMorph.prototype.wrapAttachPoint=function(){var a=detect(this.inputs(),function(b){return b instanceof CSlotMorph});return a&&!a.nestedBlock()?new Point(a.left()+2*a.inset+a.corner,a.top()+2*a.corner):null};
CommandBlockMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset};CommandBlockMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent};
CommandBlockMorph.prototype.attachTargets=function(){var a=[];if(!(this instanceof HatBlockMorph)){var b=this.topAttachPoint();this.parent instanceof SyntaxElementMorph||a.push({point:b,element:this,loc:"top",type:"block"});!ScriptsMorph.prototype.enableNestedAutoWrapping&&this.parentThatIsA(CommandSlotMorph)||a.push({point:b,element:this,loc:"wrap",type:"block"})}this.isStop()||a.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"});return a};
CommandBlockMorph.prototype.allAttachTargets=function(a){var b=this,c=[];if(this instanceof HatBlockMorph&&a.rejectsHats)return c;(a||this.parent).children.filter(function(d){return d!==b&&d instanceof SyntaxElementMorph&&!d.isTemplate}).forEach(function(d){return d.forAllChildren(function(e){e.attachTargets&&e.attachTargets().forEach(function(f){return c.push(f)})})});return c};
CommandBlockMorph.prototype.closestAttachTarget=function(a){a=a||this.parent;var b=this.bottomBlock(),c=null,d=Math.max(2*this.corner+this.dent,this.minSnapDistance),e,f=[],g=1E3,h;this instanceof HatBlockMorph||(f.push({point:this.topAttachPoint(),loc:"top"}),(h=this.wrapAttachPoint())&&f.push({point:h,loc:"wrap"}));b.isStop()||f.push({point:b.bottomAttachPoint(),loc:"bottom"});this.allAttachTargets(a).forEach(function(k){return f.forEach(function(l){if("wrap"===l.loc&&"wrap"===k.loc||l.loc!==k.loc&&
"wrap"!==l.loc&&"wrap"!==k.loc)e=l.point.distanceTo(k.point),e<d&&e<g&&(g=e,c=k)})});return c};CommandBlockMorph.prototype.snapTarget=function(){return this.closestAttachTarget()};
CommandBlockMorph.prototype.snap=function(a){var b=this.parentThatIsA(ScriptsMorph);if(null===a)this.fixBlockColor(),CommandBlockMorph.uber.snap.call(this);else{b.lastDropTarget=a;if("bottom"===a.loc){if("slot"===a.type?(this.removeHighlight(),a.element.nestedBlock(this)):a.element.nextBlock(this),this.isStop()&&(a=this.nextBlock()))b.add(a),a.moveBy(this.extent().floorDivideBy(2)),(a=this.parentThatIsA(CommandSlotMorph,ReporterSlotMorph))&&a.fixLayout()}else if("top"===a.loc)a.element.removeHighlight(),
b=this.bottomBlock().bottom()-this.bottom(),this.setBottom(a.element.top()+this.corner-b),this.setLeft(a.element.left()),this.bottomBlock().nextBlock(a.element);else if("wrap"===a.loc){var c=detect(this.inputs(),function(d){return d instanceof CSlotMorph});b=a.element.parent;this.moveBy(a.point.subtract(c.slotAttachPoint()));c.nestedBlock(a.element);b instanceof CommandBlockMorph?b.nextBlock(this):b instanceof CommandSlotMorph?b.nestedBlock(this):b instanceof RingReporterSlotMorph&&(b.add(this),b.fixLayout());
a.element.blockSequence().forEach(function(d){return d.fixBlockColor()})}this.fixBlockColor();CommandBlockMorph.uber.snap.call(this);this.snapSound&&this.snapSound.play()}};CommandBlockMorph.prototype.prepareToBeGrabbed=function(a){var b=this.position();this.parent instanceof RingReporterSlotMorph&&(this.parent.revertToDefaultInput(this),this.setPosition(b));CommandBlockMorph.uber.prepareToBeGrabbed.call(this,a)};
CommandBlockMorph.prototype.isStop=function(){if("doStopThis"===this.selector){var a=this.inputs()[0].evaluate();return a instanceof Array&&12>a[0].length}return-1<["doForever","doReport","removeClone"].indexOf(this.selector)};
CommandBlockMorph.prototype.userDestroy=function(){var a=this.selectForEdit();if(a!==this)return this.userDestroy.call(a);if(this.nextBlock())this.userDestroyJustThis();else{a=this.parentThatIsA(IDE_Morph);var b=this.parentThatIsA(SyntaxElementMorph),c=this.parentThatIsA(CSlotMorph);this.prepareToBeGrabbed();a?a.removeBlock(this):this.destroy();c&&c.fixLayout();b&&b.reactToGrabOf(this)}};
CommandBlockMorph.prototype.userDestroyJustThis=function(){var a=this.parentThatIsA(ScriptsMorph),b=this.parentThatIsA(IDE_Morph),c=this.parentThatIsA(CommandSlotMorph,RingReporterSlotMorph),d,e=this.nextBlock(),f=this.parentThatIsA(SyntaxElementMorph),g=this.parentThatIsA(CSlotMorph,RingReporterSlotMorph);this.topBlock().fullChanged();this.parent&&(d=this.parent.parentThatIsA(CommandBlockMorph));if(d&&d.nextBlock()===this)var h=d;else c&&c.nestedBlock()===this&&(h=c,this.prepareToBeGrabbed());b?
b.removeBlock(this,!0):this.destroy(!0);e?h instanceof CommandSlotMorph||h instanceof RingReporterSlotMorph?h.nestedBlock(e):h instanceof CommandBlockMorph?h.nextBlock(e):a.add(e):g&&g.fixLayout();f&&f.reactToGrabOf(this)};
CommandBlockMorph.prototype.outlinePath=function(a,b){var c=2*this.corner+this.inset,d=this.height()-this.corner,e=this.height()-2*this.corner,f=Math.max(this.corner-b,0),g=this.position();a.arc(this.corner,this.corner,f,radians(-180),radians(-90),!1);a.lineTo(this.corner+this.inset,b);a.lineTo(c,this.corner+b);a.lineTo(c+this.dent,this.corner+b);a.lineTo(3*this.corner+this.inset+this.dent,b);a.lineTo(this.width()-this.corner,b);a.arc(this.width()-this.corner,this.corner,f,radians(-90),radians(-0),
!1);this.cSlots().forEach(function(h){h.outlinePath(a,b,h.position().subtract(g))});a.arc(this.width()-this.corner,e,f,radians(0),radians(90),!1);this.isStop()||(a.lineTo(this.width()-this.corner,d-b),a.lineTo(3*this.corner+this.inset+this.dent,d-b),a.lineTo(c+this.dent,d+this.corner-b),a.lineTo(c,d+this.corner-b),a.lineTo(this.corner+this.inset,d-b));a.arc(this.corner,e,f,radians(90),radians(180),!1)};
CommandBlockMorph.prototype.drawEdges=function(a){this.drawTopDentEdge(a,0,0);this.drawBottomDentEdge(a,0,this.height()-this.corner);this.drawLeftEdge(a);this.drawRightEdge(a);this.drawTopLeftEdge(a);this.drawBottomRightEdge(a)};
CommandBlockMorph.prototype.drawTopDentEdge=function(a,b,c){var d=.5*this.edge,e=b+2*this.corner+this.inset;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var f=a.createLinearGradient(0,c,0,c+this.edge);f.addColorStop(0,this.cachedClrBright);f.addColorStop(1,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(this.corner,c+d);a.lineTo(b+this.corner+this.inset,c+d);a.stroke();a.strokeStyle=f;a.beginPath();a.moveTo(b+3*this.corner+this.inset+this.dent+d,c+d);a.lineTo(this.width()-this.corner,
c+d);a.stroke();f=b+this.corner+this.inset;f=a.createLinearGradient(f-this.edge,c+this.edge,f,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(b+this.corner+this.inset,c+d);a.lineTo(e,c+this.corner+d);a.stroke();b=a.createLinearGradient(0,c+this.corner,0,c+this.corner+this.edge);b.addColorStop(0,this.cachedClrBright);b.addColorStop(1,this.cachedClr);a.strokeStyle=b;a.beginPath();a.moveTo(e,c+this.corner+d);a.lineTo(e+this.dent,c+this.corner+
d);a.stroke()};
CommandBlockMorph.prototype.drawBottomDentEdge=function(a,b,c){var d=.5*this.edge,e=b+2*this.corner+this.inset;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var f=a.createLinearGradient(0,c-this.edge,0,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(this.corner,c-d);this.isStop()?a.lineTo(this.width()-this.corner,c-d):a.lineTo(b+this.corner+this.inset-d,c-d);a.stroke();if(this.isStop())return null;var g=a.createLinearGradient(0,c+
this.corner-this.edge,0,c+this.corner);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(e+d,c+this.corner-d);a.lineTo(e+this.dent,c+this.corner-d);a.stroke();g=a.createLinearGradient(b+e+this.dent-this.edge,c+this.corner-this.edge,b+e+this.dent,c+this.corner);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(b+e+this.dent,c+this.corner-d);a.lineTo(b+3*this.corner+this.inset+this.dent,
c-d);a.stroke();a.strokeStyle=f;a.beginPath();a.moveTo(b+3*this.corner+this.inset+this.dent,c-d);a.lineTo(this.width()-this.corner,c-d);a.stroke()};CommandBlockMorph.prototype.drawFlatBottomDentEdge=function(a){this.isStop()||(a.fillStyle=this.color.darker(this.contrast/2).toString(),a.beginPath(),this.drawDent(a,0,this.height()-this.corner),a.closePath(),a.fill())};
CommandBlockMorph.prototype.drawLeftEdge=function(a){var b=.5*this.edge,c=a.createLinearGradient(0,0,this.edge,0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.moveTo(b,this.corner);a.lineTo(b,this.height()-2*this.corner-b);a.stroke()};
CommandBlockMorph.prototype.drawRightEdge=function(a){var b=.5*this.edge,c=this.cSlots(),d=this.top(),e=this.width(),f;var g=a.createLinearGradient(e-this.edge,0,e,0);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=g;c.length?(a.beginPath(),a.moveTo(e-b,this.corner+b),c.forEach(function(h){f=h.top()-d;a.lineTo(e-b,f);a.stroke();a.beginPath();a.moveTo(e-b,f+h.height())})):(a.beginPath(),a.moveTo(e-b,this.corner+
b));a.lineTo(e-b,this.height()-2*this.corner);a.stroke()};CommandBlockMorph.prototype.drawTopLeftEdge=function(a){var b=.5*this.edge;var c=a.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.arc(this.corner,this.corner,this.corner-b,radians(-180),radians(-90),!1);a.stroke()};
CommandBlockMorph.prototype.drawBottomRightEdge=function(a){var b=.5*this.edge,c=this.width()-this.corner,d=this.height()-2*this.corner;var e=a.createRadialGradient(c,d,this.corner,c,d,this.corner-this.edge);e.addColorStop(0,this.cachedClrDark);e.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=e;a.beginPath();a.arc(c,d,this.corner-b,radians(90),radians(0),!0);a.stroke()};HatBlockMorph.prototype=new CommandBlockMorph;
HatBlockMorph.prototype.constructor=HatBlockMorph;HatBlockMorph.uber=CommandBlockMorph.prototype;function HatBlockMorph(){this.init()}HatBlockMorph.prototype.init=function(){HatBlockMorph.uber.init.call(this);this.bounds.setExtent((new Point(120,36)).multiplyBy(this.scale));this.fixLayout();this.rerender()};HatBlockMorph.prototype.readout=function(){return detect(this.children,function(a){return a instanceof SpeechBubbleMorph})};
HatBlockMorph.prototype.clearMessages=function(){this.parentThatIsA(IDE_Morph).sockets.getMessageQueue(this).empty();this.updateReadout()};
HatBlockMorph.prototype.updateReadout=function(){var a=this,b=this.world(),c=new Color(242,119,68);if(b){var d=this.parentThatIsA(IDE_Morph);d&&(this.msgCount=(d=d.sockets.getMessageQueue(this))?d.contents.length:0,d=this.readout(),1>this.msgCount?d&&d.destroy():(d?(d.changed(),d.contents=this.msgCount.toString(),d.fixLayout(),d.rerender()):(d=new SpeechBubbleMorph(this.msgCount.toString(),c,null,null,c.darker(),null,1),d.mouseClickLeft=function(){var e=new DialogBoxMorph;e.askYesNo("Clear Message Queue",
"Do you want to clear the message queue for this block?",b);e.ok=function(){a.clearMessages();this.destroy()}},this.add(d)),c=this.position().add(new Point(this.width(),0)).add(new Point(5,-10)),d.setPosition(c)))}};HatBlockMorph.prototype.blockSequence=function(){var a=HatBlockMorph.uber.blockSequence.call(this);a.shift();return a};
HatBlockMorph.prototype.outlinePath=function(a,b){var c=2*this.corner+this.inset,d=this.height()-this.corner,e=this.height()-2*this.corner,f=Math.max(this.corner-b,0),g=this.hatWidth,h=this.hatHeight,k=(4*h*h+g*g)/(8*h),l=degrees(4*Math.atan(2*h/g))/2,m=Math.min(1.7*g,this.width()-this.corner);a.moveTo(b,h+this.corner);a.arc(g/2,k,k,radians(-l-90),radians(-90),!1);a.bezierCurveTo(g,0,g,h,m,h);a.arc(this.width()-this.corner,h+this.corner,f,radians(-90),radians(-0),!1);a.arc(this.width()-this.corner,
e,f,radians(0),radians(90),!1);this.isStop()||(a.lineTo(this.width()-this.corner,d-b),a.lineTo(3*this.corner+this.inset+this.dent,d-b),a.lineTo(c+this.dent,d+this.corner-b),a.lineTo(c,d+this.corner-b),a.lineTo(this.corner+this.inset,d-b));a.arc(this.corner,e,f,radians(90),radians(180),!1)};
HatBlockMorph.prototype.drawLeftEdge=function(a){var b=.5*this.edge,c=a.createLinearGradient(0,0,this.edge,0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.moveTo(b,this.hatHeight+b);a.lineTo(b,this.height()-2*this.corner-b);a.stroke()};
HatBlockMorph.prototype.drawRightEdge=function(a){var b=.5*this.edge,c=this.width();var d=a.createLinearGradient(c-this.edge,0,c,0);d.addColorStop(0,this.cachedClr);d.addColorStop(1,this.cachedClrDark);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.moveTo(c-b,this.corner+this.hatHeight+b);a.lineTo(c-b,this.height()-2*this.corner);a.stroke()};HatBlockMorph.prototype.drawTopDentEdge=nop;
HatBlockMorph.prototype.drawTopLeftEdge=function(a){var b=.5*this.edge,c=this.hatWidth,d=this.hatHeight,e=(4*d*d+c*c)/(8*d),f=degrees(4*Math.atan(2*d/c))/2,g=Math.min(1.7*c,this.width()-this.corner);var h=a.createRadialGradient(c/2,e,e-this.edge,c/2,e,e);h.addColorStop(1,this.cachedClrBright);h.addColorStop(0,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=h;a.beginPath();a.arc(Math.round(c/2),e,e-b,radians(-f-90),radians(-90),!1);a.moveTo(c/2,b);a.bezierCurveTo(c,
b,c,d+b,g,d+b);a.lineTo(this.width()-this.corner,d+b);a.stroke()};ReporterBlockMorph.prototype=new BlockMorph;ReporterBlockMorph.prototype.constructor=ReporterBlockMorph;ReporterBlockMorph.uber=BlockMorph.prototype;function ReporterBlockMorph(a){this.init(a)}
ReporterBlockMorph.prototype.init=function(a){ReporterBlockMorph.uber.init.call(this);this.isPredicate=a||!1;this.bounds.setExtent((new Point(50,22)).multiplyBy(this.scale));this.fixLayout();this.rerender();this.isLocalVarTemplate=this.cachedSlotSpec=null};ReporterBlockMorph.prototype.snapTarget=function(a){return this.parent.closestInput(this,a)};
ReporterBlockMorph.prototype.snap=function(a){var b=this.parent,c;this.cachedSlotSpec=null;if(!(b instanceof ScriptsMorph))return null;null!==a&&(a instanceof CommandSlotMorph&&(c=a.nestedBlock())&&(c=c.fullCopy(),b.add(c),c.moveBy(c.extent()),c.fixBlockColor()),a.parent.replaceInput(a,this),this.snapSound&&this.snapSound.play());this.fixBlockColor();ReporterBlockMorph.uber.snap.call(this)};
ReporterBlockMorph.prototype.prepareToBeGrabbed=function(a){var b=this.position();if(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)this.parent.revertToDefaultInput(this),this.setPosition(b);ReporterBlockMorph.uber.prepareToBeGrabbed.call(this,a);a&&(a.alpha=1>this.alpha?1:.85);this.cachedSlotSpec=null};ReporterBlockMorph.prototype.blockSequence=function(){return this};
ReporterBlockMorph.prototype.isUnevaluated=function(){var a=this.getSlotSpec();return"%anyUE"===a||"%boolUE"===a||"%f"===a};ReporterBlockMorph.prototype.isLocked=function(){return this.isStatic||"%t"===this.getSlotSpec()};ReporterBlockMorph.prototype.getSlotSpec=function(){this.cachedSlotSpec||(this.cachedSlotSpec=this.determineSlotSpec());return this.cachedSlotSpec};
ReporterBlockMorph.prototype.determineSlotSpec=function(){if(this.parent instanceof BlockMorph){var a=this.parent.parts().filter(function(b){return!(b instanceof BlockHighlightMorph)});a=a.indexOf(this);if(-1!==a&&this.parent.blockSpec)return this.parseSpec(this.parent.blockSpec)[a]}return this.parent instanceof MultiArgMorph?this.parent.slotSpec:this.parent instanceof TemplateSlotMorph?this.parent.getSpec():null};
ReporterBlockMorph.prototype.mouseClickLeft=function(a){if(this.parent instanceof BlockInputFragmentMorph)return this.parent.mouseClickLeft();if(this.parent instanceof TemplateSlotMorph){var b=this.parent.parent.parent;a=this.parent.parent&&this.parent.parent.parent&&this.parent.parent.parent instanceof RingMorph?"Input name":"%blockVars"===this.parent.parent.elementSpec?"Block variable name":"Script variable name";(new DialogBoxMorph(this,function(c){b.id?SnapActions.setBlockSpec(this,c):this.userSetSpec(c)},
this)).prompt(a,this.blockSpec,this.world())}else ReporterBlockMorph.uber.mouseClickLeft.call(this,a)};ReporterBlockMorph.prototype.exportResultPic=function(){var a=this.topBlock(),b=a.scriptTarget(),c;a===this&&b&&(c=b.parentThatIsA(StageMorph))&&(c.threads.stopProcess(a),c.threads.startProcess(a,b,!1,!0))};
ReporterBlockMorph.prototype.userDestroy=function(){var a=this.selectForEdit();if(a!==this)return this.userDestroy.call(a);a=this.world();if(a)var b=a.hand;this.topBlock().fullChanged();this.prepareToBeGrabbed(b);this.destroy()};ReporterBlockMorph.prototype.outlinePath=function(a,b){this.isPredicate?this.outlinePathDiamond(a,b):this.outlinePathOval(a,b)};
ReporterBlockMorph.prototype.outlinePathOval=function(a,b){var c=this.height(),d=Math.min(this.rounding,c/2),e=Math.max(d-b,0),f=this.width(),g=this.position();a.arc(d,d,e,radians(-180),radians(-90),!1);a.arc(f-d,d,e,radians(-90),radians(-0),!1);this.cSlots().forEach(function(h){h.outlinePath(a,b,h.position().subtract(g))});a.arc(f-d,c-d,e,radians(0),radians(90),!1);a.arc(d,c-d,e,radians(90),radians(180),!1);a.lineTo(d-e,d)};
ReporterBlockMorph.prototype.outlinePathDiamond=function(a,b){var c=this.width(),d=this.height(),e=Math.floor(d/2),f=this.rounding,g=c-f,h=this.position(),k=this.cSlots();a.moveTo(b,e);a.lineTo(f,b);a.lineTo(g-b,b);k.length?this.cSlots().forEach(function(l){l.outlinePath(a,b,l.position().subtract(h))}):a.lineTo(c-b,e);a.lineTo(g-b,d-b);a.lineTo(f,d-b)};ReporterBlockMorph.prototype.drawEdges=function(a){this.isPredicate?this.drawEdgesDiamond(a):this.drawEdgesOval(a)};
ReporterBlockMorph.prototype.drawEdgesOval=function(a){var b=this.height(),c=Math.max(Math.min(this.rounding,b/2),this.edge),d=this.width(),e=this.edge/2,f,g=this.top(),h=this.cSlots();a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var k=a.createRadialGradient(c,b-c,c-this.edge,c,b-c,c+this.edge);k.addColorStop(0,this.cachedClr);k.addColorStop(1,this.cachedClrBright);a.strokeStyle=k;a.beginPath();a.arc(c,b-c,c-e,radians(90),radians(180),!1);a.stroke();k=a.createRadialGradient(d-c,c,c-
this.edge,d-c,c,c+this.edge);k.addColorStop(0,this.cachedClr);k.addColorStop(1,this.cachedClrDark);a.strokeStyle=k;a.beginPath();a.arc(d-c,c,c-e,radians(-90),radians(0),!1);a.stroke();k=a.createLinearGradient(0,0,0,this.edge);k.addColorStop(0,this.cachedClrBright);k.addColorStop(1,this.cachedClr);a.strokeStyle=k;a.beginPath();a.moveTo(c-e,e);a.lineTo(d-c+e,e);a.stroke();k=a.createRadialGradient(c,c,c-this.edge,c,c,c);k.addColorStop(0,this.cachedClr);k.addColorStop(1,this.cachedClrBright);a.strokeStyle=
k;a.beginPath();a.arc(c,c,c-e,radians(180),radians(270),!1);a.stroke();k=a.createRadialGradient(d-c,b-c,c-this.edge,d-c,b-c,c);k.addColorStop(0,this.cachedClr);k.addColorStop(1,this.cachedClrDark);a.strokeStyle=k;a.beginPath();a.arc(d-c,b-c,c-e,radians(0),radians(90),!1);a.stroke();k=a.createLinearGradient(0,b-this.edge,0,b);k.addColorStop(0,this.cachedClr);k.addColorStop(1,this.cachedClrDark);a.strokeStyle=k;a.beginPath();a.moveTo(c-e,b-e);a.lineTo(d-c+e,b-e);a.stroke();k=a.createLinearGradient(0,
0,this.edge,0);k.addColorStop(0,this.cachedClrBright);k.addColorStop(1,this.cachedClr);a.strokeStyle=k;a.beginPath();a.moveTo(e,c);a.lineTo(e,b-c);a.stroke();k=a.createLinearGradient(d-this.edge,0,d,0);k.addColorStop(0,this.cachedClr);k.addColorStop(1,this.cachedClrDark);a.strokeStyle=k;h.length?(a.beginPath(),a.moveTo(d-e,c+e),h.forEach(function(l){f=l.top()-g;a.lineTo(d-e,f);a.stroke();a.beginPath();a.moveTo(d-e,f+l.height())})):(a.beginPath(),a.moveTo(d-e,c+e));a.lineTo(d-e,b-c);a.stroke()};
ReporterBlockMorph.prototype.drawEdgesDiamond=function(a){var b=this.width(),c=this.height(),d=Math.floor(c/2),e=this.rounding,f=this.edge/2,g=this.cSlots(),h=this.top(),k;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var l=a.createLinearGradient(-e,0,e,0);l.addColorStop(1,this.cachedClr);l.addColorStop(0,this.cachedClrBright);a.strokeStyle=l;a.beginPath();a.moveTo(f,d);a.lineTo(e,c-f);a.closePath();a.stroke();l=a.createLinearGradient(0,0,e,0);l.addColorStop(0,this.cachedClrBright);l.addColorStop(1,
this.cachedClr);a.strokeStyle=l;a.beginPath();a.moveTo(f,d);a.lineTo(e,f);a.closePath();a.stroke();l=a.createLinearGradient(0,0,0,this.edge);l.addColorStop(0,this.cachedClrBright);l.addColorStop(1,this.cachedClr);a.strokeStyle=l;a.beginPath();a.moveTo(e,f);g.length?(a.lineTo(b-e-f,f),a.closePath(),a.stroke(),l=a.createLinearGradient(b-e-this.edge,0,b-e,0),l.addColorStop(0,this.cachedClr),l.addColorStop(1,this.cachedClrDark),a.lineWidth=this.edge,a.lineJoin="round",a.lineCap="round",a.strokeStyle=
l,a.beginPath(),a.moveTo(b-e-f,this.edge+f),g.forEach(function(m){k=m.top()-h;a.lineTo(b-e-f,k);a.stroke();a.beginPath();a.moveTo(b-e-f,k+m.height())}),a.lineTo(b-e-f,c-f)):(a.lineTo(b-e,f),a.closePath(),a.stroke(),l=a.createLinearGradient(b-e,0,b+e,0),l.addColorStop(0,this.cachedClr),l.addColorStop(1,this.cachedClrDark),a.strokeStyle=l,a.beginPath(),a.moveTo(b-f,d),a.lineTo(b-e,f),a.closePath(),a.stroke(),l=a.createLinearGradient(b-e,0,b,0),l.addColorStop(0,this.cachedClr),l.addColorStop(1,this.cachedClrDark),
a.strokeStyle=l,a.beginPath(),a.moveTo(b-e,c-f),a.lineTo(b-f,d),a.closePath());a.stroke();l=a.createLinearGradient(0,c-this.edge,0,c);l.addColorStop(0,this.cachedClr);l.addColorStop(1,this.cachedClrDark);a.strokeStyle=l;a.beginPath();a.moveTo(e+f,c-f);a.lineTo(b-e-f,c-f);a.closePath();a.stroke()};RingMorph.prototype=new ReporterBlockMorph;RingMorph.prototype.constructor=RingMorph;RingMorph.uber=ReporterBlockMorph.prototype;RingMorph.prototype.isCachingInputs=!1;function RingMorph(){this.init()}
RingMorph.prototype.init=function(){RingMorph.uber.init.call(this);this.category="other";this.contrast=RingMorph.prototype.contrast;this.setExtent(new Point(200,80))};
RingMorph.prototype.render=function(a){var b=this.inputs()[0],c=this.position();this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();MorphicPreferences.isFlat?(a.fillStyle=this.cachedClrDark,a.beginPath(),this.outlinePath(a,0),b.outlinePath(a,b.position().subtract(c)),a.clip("evenodd"),a.fillRect(0,0,this.width(),this.height()),a.fillStyle=this.cachedClr,a.beginPath(),this.outlinePath(a,this.flatEdge),b.outlinePath(a,b.position().subtract(c)),a.clip("evenodd"),
a.fillRect(0,0,this.width(),this.height())):(a.fillStyle=this.cachedClr,a.beginPath(),this.outlinePath(a,0),b.outlinePath(a,b.position().subtract(c)),a.clip("evenodd"),a.fillRect(0,0,this.width(),this.height()),this.drawEdges(a))};RingMorph.prototype.rootForGrab=function(){return this.isDraggable?this:BlockMorph.uber.rootForGrab.call(this)};
RingMorph.prototype.embed=function(a,b,c){this.color=SpriteMorph.prototype.blockColor.other;this.isDraggable=!0;if(a instanceof CommandBlockMorph){this.isStatic=!1;this.setSpec("%rc %ringparms");this.selector="reifyScript";var d=this.parts()[0];d.nestedBlock(a)}else a.isPredicate?(this.isStatic=!0,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate",d=this.parts()[0],d.replaceInput(d.contents(),a)):a instanceof BooleanSlotMorph?(this.isStatic=!1,this.setSpec("%rp %ringparms"),this.selector=
"reifyPredicate",d=this.parts()[0],d.replaceInput(d.contents(),a)):(this.isStatic=!1,this.setSpec("%rr %ringparms"),this.selector="reifyReporter",d=this.parts()[0],d.replaceInput(d.contents(),a,c));d=this.parts()[1];b&&b.forEach(function(e){return d.addInput(e)});this.fixBlockColor(null,!0)};
RingMorph.prototype.vanishForSimilar=function(){var a=this.parts()[0].nestedBlock();if(!(a&&this.parent instanceof SyntaxElementMorph)||this.parent instanceof RingReporterSlotMorph||this.parent instanceof RingCommandSlotMorph)return null;("reportGetVar"===a.selector&&!contains(this.inputNames(),a.blockSpec)||"reportJSFunction"===a.selector||"reportAttributeOf"===a.selector||"reportCompiled"===a.selector||a instanceof RingMorph)&&this.parent.replaceInput(this,a)};RingMorph.prototype.contents=function(){return this.parts()[0].nestedBlock()};
RingMorph.prototype.inputNames=function(){return this.parts()[1].evaluate()};RingMorph.prototype.dataType=function(){switch(this.selector){case "reifyScript":return"command";case "reifyPredicate":return"predicate";default:return"reporter"}};RingMorph.prototype.fixBlockColor=function(a,b){var c=this.parts()[0];RingMorph.uber.fixBlockColor.call(this,a,b);c.fixLayout()};ScriptsMorph.prototype=new FrameMorph;ScriptsMorph.prototype.constructor=ScriptsMorph;ScriptsMorph.prototype.undoCategory="scripts";
ScriptsMorph.uber=FrameMorph.prototype;ScriptsMorph.prototype.cleanUpMargin=20;ScriptsMorph.prototype.cleanUpSpacing=15;ScriptsMorph.prototype.isPreferringEmptySlots=!0;ScriptsMorph.prototype.enableKeyboard=!0;ScriptsMorph.prototype.enableNestedAutoWrapping=!0;ScriptsMorph.prototype.feedbackColor=WHITE;function ScriptsMorph(){this.init()}
ScriptsMorph.prototype.init=function(){this.feedbackMorph=new BoxMorph;this.rejectsHats=!1;this.focus=null;ScriptsMorph.uber.init.call(this);this.setColor(new Color(70,70,70))};
ScriptsMorph.prototype.fullCopy=function(){var a=new ScriptsMorph,b=this.position(),c;this.focus&&this.focus.stopEditing();this.children.forEach(function(d){d.block||(c=d.fullCopy(),a.add(c),c.setPosition(d.position().subtract(b)),c instanceof BlockMorph&&c.allComments().forEach(function(e){return e.align(c)}))});a.adjustBounds();return a};
ScriptsMorph.prototype.render=function(a){a.fillStyle=this.getRenderColor().toString();a.fillRect(0,0,this.width(),this.height());this.cachedTexture?this.renderCachedTexture(a):this.texture&&this.renderTexture(this.texture,a)};ScriptsMorph.prototype.getRenderColor=function(){return MorphicPreferences.isFlat||.85<SyntaxElementMorph.prototype.alpha?this.color:this.color.mixed(Math.max(SyntaxElementMorph.prototype.alpha-.15,0),SpriteMorph.prototype.paletteColor)};
ScriptsMorph.prototype.renderCachedTexture=function(a){.8<SyntaxElementMorph.prototype.alpha&&ScriptsMorph.uber.renderCachedTexture.call(this,a)};
ScriptsMorph.prototype.step=function(){var a=this.world(),b=a.hand;this.feedbackMorph.parent&&(this.feedbackMorph.destroy(),this.feedbackMorph.parent=null);this.focus&&(!a.keyboardFocus||a.keyboardFocus instanceof StageMorph)&&this.focus.getFocus(a);if(0===b.children.length||!this.bounds.containsPoint(b.bounds.origin))return null;a=b.children[0];if(!(a instanceof BlockMorph||a instanceof CommentMorph)||!contains(b.morphAtPointer().allParents(),this))return null;a instanceof CommentMorph?this.showCommentDropFeedback(a,
b):a instanceof ReporterBlockMorph?this.showReporterDropFeedback(a,b):this.showCommandDropFeedback(a)};
ScriptsMorph.prototype.showReporterDropFeedback=function(a,b){b=this.closestInput(a,b);if(null===b)return null;this.feedbackMorph.bounds=b.fullBounds().expandBy(Math.max(2*a.edge,a.reporterDropFeedbackPadding));this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding;this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.add(this.feedbackMorph);b instanceof MultiArgMorph?(this.feedbackMorph.color=SpriteMorph.prototype.blockColor.lists.copy(),this.feedbackMorph.borderColor=
SpriteMorph.prototype.blockColor.lists):(this.feedbackMorph.color=this.feedbackColor.copy(),this.feedbackMorph.borderColor=this.feedbackColor);this.feedbackMorph.color.a=.5;this.feedbackMorph.rerender()};
ScriptsMorph.prototype.showCommandDropFeedback=function(a){var b=a.closestAttachTarget(this);if(!b)return null;"wrap"===b.loc?this.showCSlotWrapFeedback(a,b.element):(this.add(this.feedbackMorph),this.feedbackMorph.border=0,this.feedbackMorph.edge=0,this.feedbackMorph.alpha=1,this.feedbackMorph.bounds.setWidth(b.element.width()),this.feedbackMorph.bounds.setHeight(Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight)),this.feedbackMorph.color=this.feedbackColor,
a=b.point.y,"bottom"===b.loc&&("block"===b.type?b.element.nextBlock()&&(a-=SyntaxElementMorph.prototype.corner):"slot"===b.type&&b.element.nestedBlock()&&(a-=SyntaxElementMorph.prototype.corner)),this.feedbackMorph.setPosition(new Point(b.element.left(),a)))};
ScriptsMorph.prototype.showCommentDropFeedback=function(a,b){b=this.closestBlock(a,b);if(!b)return null;this.feedbackMorph.bounds=b.bounds.expandBy(Math.max(2*BlockMorph.prototype.edge,BlockMorph.prototype.reporterDropFeedbackPadding));this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding;this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.add(this.feedbackMorph);this.feedbackMorph.color=a.color.copy();this.feedbackMorph.color.a=.25;this.feedbackMorph.borderColor=
a.titleBar.color;this.feedbackMorph.rerender()};ScriptsMorph.prototype.showCSlotWrapFeedback=function(a,b){this.feedbackMorph.bounds=b.fullBounds().expandBy(BlockMorph.prototype.corner);this.feedbackMorph.edge=SyntaxElementMorph.prototype.corner;this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.add(this.feedbackMorph);a=a.color.lighter(40);this.feedbackMorph.color=a.copy();this.feedbackMorph.color.a=.1;this.feedbackMorph.borderColor=a;this.feedbackMorph.rerender()};
ScriptsMorph.prototype.closestInput=function(a,b){function c(k,l){return k instanceof MultiArgMorph?l?k.arrows().bounds.containsPoint(l):k.arrows().bounds.intersects(d):!0}var d=a.fullBoundsNoShadow(),e=this.children.filter(function(k){return k instanceof BlockMorph&&k.fullBounds().intersects(d)}),f=a.allInputs();var g=[];e.forEach(function(k){return g=g.concat(k.allInputs())});if(0===g.length)return null;if(this.isPreferringEmptySlots){if(b){var h=b.position();if(e=detect(g,function(k){return(k instanceof
InputSlotMorph||k instanceof ArgMorph&&!(k instanceof CommandSlotMorph)&&!(k instanceof MultiArgMorph)||k instanceof RingMorph&&!k.contents()||k.isEmptySlot())&&!k.isLocked()&&k.bounds.containsPoint(h)&&!contains(f,k)}))return e}if(e=detect(g,function(k){return(k instanceof InputSlotMorph||k instanceof ArgMorph||k instanceof RingMorph&&!k.contents()||k.isEmptySlot())&&!k.isLocked()&&k.bounds.intersects(d)&&!contains(f,k)&&c(k,h)}))return e}return b&&(h=b.position(),e=detect(g,function(k){return k!==
a&&!k.isLocked()&&k.bounds.containsPoint(h)&&!(k.parent instanceof PrototypeHatBlockMorph)&&!contains(f,k)&&c(k,h)}))?e:detect(g,function(k){return k!==a&&!k.isLocked()&&k.fullBounds().intersects(d)&&!(k.parent instanceof PrototypeHatBlockMorph)&&!contains(f,k)&&c(k)})};
ScriptsMorph.prototype.closestBlock=function(a,b){var c=a.bounds;a=this.children.filter(function(f){return f instanceof BlockMorph&&f.fullBounds().intersects(c)});var d=[];a.forEach(function(f){d=d.concat(f.allChildren().slice(0).reverse().filter(function(g){return g instanceof BlockMorph&&!g.isTemplate}))});if(0===d.length)return null;if(b){var e=b.position();if(b=detect(d,function(f){return!f.comment&&!f.isPrototype&&f.bounds.containsPoint(e)}))return b}return detect(d,function(f){return!f.comment&&
!f.isPrototype&&f.bounds.intersects(c)})};
ScriptsMorph.prototype.userMenu=function(){function a(g,h,k,l,m){c.addItem([k?new SymbolMorph("checkedBox",.75*MorphicPreferences.menuFontSize):new SymbolMorph("rectangle",.75*MorphicPreferences.menuFontSize),localize(g)],h,k?l:m)}var b=this,c=new MenuMorph(this),d=this.parentThatIsA(IDE_Morph),e,f=this.scriptTarget();d||(e=this.parentThatIsA(BlockEditorMorph))&&(d=e.target.parentThatIsA(IDE_Morph));SnapUndo.canUndo(f)&&c.addItem([new SymbolMorph("turnBack",MorphicPreferences.menuFontSize),localize("undo")],
function(){SnapUndo.undo(f)},localize("undo the last edit"));SnapUndo.canRedo(f)&&c.addItem([new SymbolMorph("turnForward",MorphicPreferences.menuFontSize),localize("redo")],function(){SnapUndo.redo(f)},localize("redo the last edit"));(SnapUndo.canUndo(f)||SnapUndo.canRedo(f))&&c.addLine();c.addItem("clean up","cleanUp","arrange scripts\nvertically");c.addItem("add comment","addComment");c.addItem("scripts pic...","exportScriptsPicture","save a picture\nof all scripts");d&&(c.addLine(),!e&&f.exemplar&&
a("inherited",function(){return f.toggleInheritanceForAttribute("scripts")},f.inheritsAttribute("scripts"),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+f.exemplar.name),c.addItem("make a block...",function(){return(new BlockDialogMorph(null,function(g){""!==g.spec&&SnapActions.addCustomBlock(g,f).then(function(h){(new BlockEditorMorph(h,f)).popUp()})},b)).prompt("Make a block",null,b.world())}));return c};
ScriptsMorph.prototype.cleanUp=function(){var a=this.selectForEdit(),b=a.topLeft(),c=a.cleanUpMargin;a.children.sort(function(f,g){return f instanceof PrototypeHatBlockMorph?0:f.top()-g.top()});var d=this.children.map(function(f){return f.id}),e=this.children.map(function(f){if(!(f instanceof CommentMorph&&f.block))return point=b.add(new Point(a.cleanUpMargin,c)),c+=f.stackHeight()+a.cleanUpSpacing,point});SnapActions.setBlocksPositions(d,e);a.parent&&a.setPosition(a.parent.topLeft());a.adjustBounds()};
ScriptsMorph.prototype.exportScriptsPicture=function(){var a=this.scriptsPicture(),b=this.world().children[0];a&&b.saveCanvasAs(a,(b.projectName||localize("untitled"))+" "+localize("script pic"))};
ScriptsMorph.prototype.scriptsPicture=function(){if(0!==this.children.length){var a=this.children[0].fullBounds();this.children.forEach(function(d){d.isVisible&&(a=a.merge(d.fullBounds()))});var b=newCanvas(a.extent());var c=b.getContext("2d");this.children.forEach(function(d){var e=d.fullBounds().origin;d.isVisible&&c.drawImage(d.fullImage(),e.x-a.origin.x,e.y-a.origin.y)});return b}};
ScriptsMorph.prototype.addComment=function(){var a=this.parentThatIsA(IDE_Morph),b=this.parentThatIsA(BlockEditorMorph),c=this.world();(new CommentMorph).pickUp(c);!a&&b&&(a=b.target.parentThatIsA(IDE_Morph));a&&(c.hand.grabOrigin={origin:a.palette,position:a.palette.center()})};ScriptsMorph.prototype.undoOwnerId=function(){try{var a=this.parentThatIsA(BlockEditorMorph);return(a?a.definition:this.scriptTarget()).id+"/"+this.undoCategory}catch(b){return null}};
ScriptsMorph.prototype.addToolbar=function(){var a=this,b=new AlignmentMorph,c=new Color(140,140,140);b.respectHiddens=!0;b.undoButton=new PushButtonMorph(this,function(){SnapUndo.undo(this.undoOwnerId())},new SymbolMorph("turnBack",12));b.undoButton.alpha=.2;b.undoButton.padding=4;b.undoButton.labelShadowColor=c;b.undoButton.edge=0;b.undoButton.fixLayout();b.add(b.undoButton);b.redoButton=new PushButtonMorph(this,function(){return SnapUndo.redo(a.undoOwnerId())},new SymbolMorph("turnForward",12));
b.redoButton.alpha=.2;b.redoButton.padding=4;b.redoButton.labelShadowColor=c;b.redoButton.edge=0;b.redoButton.fixLayout();b.add(b.redoButton);b.keyboardButton=new ToggleButtonMorph(null,this,"toggleKeyboardEntry",[new SymbolMorph("keyboard",12),new SymbolMorph("keyboardFilled",12)],function(){return!isNil(a.focus)});b.keyboardButton.alpha=.2;b.keyboardButton.padding=4;b.keyboardButton.edge=0;b.keyboardButton.hint="use the keyboard\nto enter blocks";b.keyboardButton.labelShadowColor=c;b.keyboardButton.fixLayout();
b.add(b.keyboardButton);return b};
ScriptsMorph.prototype.updateToolbar=function(){var a=this.parentThatIsA(ScrollFrameMorph),b=!1;if(a){var c=this.undoOwnerId();a.toolBar||(a.toolBar=this.addToolbar(),a.add(a.toolBar),b=!0);this.enableKeyboard?(a.toolBar.keyboardButton.show(),a.toolBar.keyboardButton.refresh()):a.toolBar.keyboardButton.hide();c&&SnapUndo.canUndo(c)?a.toolBar.undoButton.isEnabled()||(a.toolBar.undoButton.enable(),b=!0):a.toolBar.undoButton.isEnabled()&&(a.toolBar.undoButton.disable(),b=!0);c&&SnapUndo.canRedo(c)?a.toolBar.redoButton.isEnabled()||
(a.toolBar.redoButton.enable(),a.toolBar.undoButton.mouseLeave(),b=!0):a.toolBar.redoButton.isEnabled()&&(a.toolBar.redoButton.disable(),b=!0);a.toolBar.undoButton.isVisible&&a.toolBar.redoButton.isVisible||(a.toolBar.undoButton.show(),a.toolBar.redoButton.show(),b=!0);if(b||!a.toolBar.isVisible)a.toolBar.isVisible=!0,a.toolBar.fixLayout();a.adjustToolBar()}};ScriptsMorph.prototype.hideToolbar=function(){var a=this.parentThatIsA(ScrollFrameMorph);a&&a.toolBar&&(a.toolBar.isVisible=!1,a.toolBar.changed())};
ScriptsMorph.prototype.sortedElements=function(){var a=this.children.filter(function(b){return b instanceof CommentMorph?!b.block:!0});a.sort(function(b,c){return b instanceof PrototypeHatBlockMorph?0:b.top()-c.top()});return a};ScriptsMorph.prototype.fixMultiArgs=function(){this.forAllChildren(function(a){a instanceof MultiArgMorph&&a.fixLayout()})};ScriptsMorph.prototype.wantsDropOf=function(a){return a instanceof HatBlockMorph?!this.rejectsHats:a instanceof SyntaxElementMorph||a instanceof CommentMorph};
ScriptsMorph.prototype.reactToDropOf=function(a,b){if(a instanceof BlockMorph||a instanceof CommentMorph){var c=a.snapTarget(b);c?this.moveBlock(a,c,b):a.id?b&&this.setBlockPosition(a,b):this.addBlock(a)}this.adjustBounds()};
ScriptsMorph.prototype.moveBlock=function(a,b,c){var d=c&&c.grabOrigin.origin,e=d&&c.grabOrigin.position.add(d.position());if(d!==this&&d instanceof ScriptsMorph)return d=a.fullCopy(),SnapActions.isCollaborating()&&a.setPosition(e),d.id=null,c.grabOrigin.origin.add(a),SnapActions.moveBlock(d,b,e).then(function(){a.setPosition(e);return SnapActions.removeBlock(a)});e=d instanceof ScriptsMorph?e:null;SnapActions.moveBlock(a,b,e)};
ScriptsMorph.prototype.addBlock=function(a){var b=this.parentThatIsA(BlockEditorMorph)||this.scriptTarget();SnapActions.addBlock(a,b,a.position());a.destroy()};
ScriptsMorph.prototype.setBlockPosition=function(a,b){var c=a.position();var d=b.grabOrigin.position.add(b.grabOrigin.origin.position());var e=function(){a.setPosition(d)};if(b){b=b.grabOrigin.origin.parentThatIsA(ScriptsMorph);if(b!==this)return b.add(a),e=a.fullCopy(),b=this.parentThatIsA(BlockEditorMorph)||this.scriptTarget(),SnapActions.addBlock(e,b,c).then(function(){return SnapActions.removeBlock(a)});SnapActions.isReadOnly()&&e()}return SnapActions.setBlockPosition(a,c).catch(e)};
ScriptsMorph.prototype.mouseClickLeft=function(a){if(16===this.world().currentKey)return this.edit(a);this.focus&&this.focus.stopEditing();this.escalateEvent("mouseClickLeft",a)};ScriptsMorph.prototype.selectForEdit=function(){var a=this.parentThatIsA(IDE_Morph);return(a=a?a.currentSprite:null)&&a.inheritsAttribute("scripts")?(this.feedbackMorph.destroy(),a.shadowAttribute("scripts"),a.scripts):this};
ScriptsMorph.prototype.edit=function(a){var b=this.world();this.focus&&this.focus.stopEditing();b.stopEditing();if(ScriptsMorph.prototype.enableKeyboard){var c=this.selectForEdit();c.focus=new ScriptFocusMorph(c,c,a);c.focus.getFocus(b)}};
ScriptsMorph.prototype.toggleKeyboardEntry=function(){var a=this.world();if(this.focus)this.focus.stopEditing();else if(a.stopEditing(),ScriptsMorph.prototype.enableKeyboard){var b=this.selectForEdit();b.focus=new ScriptFocusMorph(b,b,b.position());b.focus.getFocus(a);a=b.focus.sortedScripts();a.length?(b.focus.element=a[0],b.focus.element instanceof HatBlockMorph&&b.focus.nextCommand()):b.focus.moveBy(new Point(50,50));b.focus.fixLayout()}};
ScriptsMorph.prototype.scriptTarget=function(){var a=this.parentThatIsA(IDE_Morph);if(a)return a.currentSprite;if(a=this.parentThatIsA(BlockEditorMorph))return a.target;throw Error("script target cannot be found for orphaned scripts");};ArgMorph.prototype=new SyntaxElementMorph;ArgMorph.prototype.constructor=ArgMorph;ArgMorph.uber=SyntaxElementMorph.prototype;function ArgMorph(a){this.init(a)}
ArgMorph.prototype.init=function(a){this.type=a||null;this.icon=null;ArgMorph.uber.init.call(this);this.color=new Color(0,17,173);this.createIcon();"list"===a&&(this.alpha=1)};ArgMorph.prototype.executeOnSliderEdit=!1;
ArgMorph.prototype.reactToSliderEdit=function(){var a,b;if(this.executeOnSliderEdit&&(a=this.parentThatIsA(BlockMorph))){a=a.topBlock();var c=a.scriptTarget();a instanceof PrototypeHatBlockMorph||!c||((b=c.parentThatIsA(StageMorph))&&(b.isThreadSafe||Process.prototype.enableSingleStepping)?b.threads.startProcess(a,c,b.isThreadSafe):a.mouseClickLeft())}};ArgMorph.prototype.justDropped=function(){this instanceof CommandSlotMorph||(this.fixLayout(),this.rerender())};ArgMorph.prototype.getSpec=function(){return"%s"};
ArgMorph.prototype.createIcon=function(){switch(this.type){case "list":this.icon=this.labelPart("%list");this.add(this.icon);break;case "object":this.icon=this.labelPart("%turtle");this.add(this.icon);break;default:nop()}};ArgMorph.prototype.fixLayout=function(){this.icon?(this.icon.setPosition(this.position()),this.bounds.setExtent(this.icon.extent())):ArgMorph.uber.fixLayout.call(this)};
ArgMorph.prototype.render=function(a){var b;if(this.icon){if(b=this.parentThatIsA(BlockMorph))this.icon.shadowColor=b.color.darker(this.labelContrast);switch(this.type){case "list":this.color=new Color(255,140,0);break;default:return}}ArgMorph.uber.render.call(this,a)};ArgMorph.prototype.isEmptySlot=function(){return null!==this.type};CommandSlotMorph.prototype=new ArgMorph;CommandSlotMorph.prototype.constructor=CommandSlotMorph;CommandSlotMorph.uber=ArgMorph.prototype;
function CommandSlotMorph(){this.init()}CommandSlotMorph.prototype.init=function(){CommandSlotMorph.uber.init.call(this);this.color=new Color(0,17,173);this.setExtent(new Point(230,4*this.corner+this.cSlotPadding))};CommandSlotMorph.prototype.getSpec=function(){return"%cmd"};CommandSlotMorph.prototype.topBlock=function(){return this.parent.topBlock?this.parent.topBlock():this.nestedBlock()};
CommandSlotMorph.prototype.nestedBlock=function(a){if(a){var b=this.nestedBlock();this.add(a);b&&a.bottomBlock().nextBlock(b);this.fixLayout()}else return detect(this.children,function(c){return c instanceof CommandBlockMorph})};CommandSlotMorph.prototype.slotAttachPoint=function(){return new Point(this.dentCenter(),this.top()+2*this.corner)};CommandSlotMorph.prototype.dentLeft=function(){return this.left()+this.corner+2*this.inset};
CommandSlotMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent};CommandSlotMorph.prototype.attachTargets=function(){var a=[];a.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"});return a};
CommandSlotMorph.prototype.fixLayout=function(){var a=this.nestedBlock();this.parent&&(this.color.eq(this.parent.color)||this.setColor(this.parent.color));a?(a.setPosition(new Point(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder)),this.bounds.setWidth(a.fullBounds().width()+2*(this.edge+this.rfBorder)),this.bounds.setHeight(a.fullBounds().height()+this.edge+2*this.rfBorder-(this.corner-this.edge))):(this.bounds.setHeight(4*this.corner),this.bounds.setWidth(4*this.corner+this.inset+
this.dent));this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};CommandSlotMorph.prototype.evaluate=function(){return this.nestedBlock()};CommandSlotMorph.prototype.isEmptySlot=function(){return!this.isStatic&&null===this.nestedBlock()};
CommandSlotMorph.prototype.attach=function(){var a=this,b=this.overlappedMorphs(),c=new MenuMorph(this,"choose new parent:");b.forEach(function(d){return c.addItem(d.toString().slice(0,50),function(){d.add(a);a.isDraggable=!1;d.fixLayout&&d.fixLayout()})});0<b.length&&c.popUpAtHand(this.world())};
CommandSlotMorph.prototype.render=function(a){this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();a.fillStyle=this.cachedClr;a.fillRect(0,0,this.width(),this.height());a.fillStyle=this.rfColor.toString();this.drawFlat(a);MorphicPreferences.isFlat||this.drawEdges(a)};
CommandSlotMorph.prototype.drawFlat=function(a){var b=null!==this.nestedBlock(),c=b?this.inset:this.inset/2,d=b?this.dent:this.dent/2,e=2*this.corner+c,f=this.edge;b=b?this.rfBorder:0;var g=this.height()-this.corner-f;a.beginPath();a.arc(this.corner+f,this.corner+f,this.corner,radians(-180),radians(-90),!1);a.lineTo(this.corner+c+f+2*b,f);a.lineTo(e+f+2*b,this.corner+f);a.lineTo(e+f+2*b+(d-2*b),this.corner+f);a.lineTo(e+f+2*b+(d-2*b)+this.corner,f);a.lineTo(this.width()-this.corner-f,f);a.arc(this.width()-
this.corner-f,this.corner+f,this.corner,radians(-90),radians(-0),!1);a.arc(this.width()-this.corner-f,g,this.corner,radians(0),radians(90),!1);a.arc(this.corner+f,g,this.corner,radians(90),radians(180),!1);a.closePath();a.fill()};
CommandSlotMorph.prototype.drawEdges=function(a){var b=null!==this.nestedBlock(),c=b?this.inset:this.inset/2,d=b?this.dent:this.dent/2,e=2*this.corner+c,f=this.edge;b=b?this.rfBorder:0;var g=.5*this.edge;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var h=a.createLinearGradient(0,this.height(),0,this.height()-this.edge);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrBright);a.strokeStyle=h;a.beginPath();a.moveTo(this.corner+f,this.height()-g);a.lineTo(this.width()-this.corner-
f,this.height()-g);a.stroke();h=a.createRadialGradient(this.width()-(this.corner+f),this.height()-(this.corner+f),this.corner,this.width()-(this.corner+f),this.height()-(this.corner+f),this.corner+f);h.addColorStop(0,this.cachedClrBright);h.addColorStop(1,this.cachedClr);a.strokeStyle=h;a.beginPath();a.arc(this.width()-(this.corner+f),this.height()-(this.corner+f),this.corner+g,radians(0),radians(90),!1);a.stroke();h=a.createLinearGradient(this.width(),0,this.width()-this.edge,0);h.addColorStop(0,
this.cachedClr);h.addColorStop(1,this.cachedClrBright);a.strokeStyle=h;a.beginPath();a.moveTo(this.width()-g,this.height()-this.corner-this.edge);a.lineTo(this.width()-g,f+this.corner);a.stroke();a.shadowOffsetY=g;a.shadowBlur=this.edge;a.shadowColor=this.rfColor.darker(80).toString();h=a.createLinearGradient(0,0,f,0);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrDark);a.strokeStyle=h;a.beginPath();a.moveTo(g,f+this.corner);a.lineTo(g,this.height()-f-this.corner);a.stroke();h=a.createRadialGradient(this.corner+
f,this.corner+f,this.corner,this.corner+f,this.corner+f,this.corner+f);h.addColorStop(0,this.cachedClrDark);h.addColorStop(1,this.cachedClr);a.strokeStyle=h;a.beginPath();a.arc(this.corner+f,this.corner+f,this.corner+g,radians(-180),radians(-90),!1);a.stroke();h=a.createLinearGradient(0,0,0,this.edge);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrDark);a.strokeStyle=h;a.beginPath();a.moveTo(this.corner+f,g);a.lineTo(this.corner+c+f+2*b-g,g);a.stroke();c=a.createLinearGradient(0,
this.corner,0,this.corner+f);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(e+f+2*b+g,this.corner+g);a.lineTo(e+f+2*b+(d-2*b),this.corner+g);a.stroke();c=a.createLinearGradient(e+f+2*b+(d-2*b)-g,this.corner,e+f+2*b+(d-2*b)+.7*g,this.corner+g+.7*g);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(e+f+2*b+(d-2*b),this.corner+g);a.lineTo(e+f+2*b+(d-2*b)+this.corner,g);a.stroke();
a.strokeStyle=h;a.beginPath();a.moveTo(e+f+2*b+(d-2*b)+this.corner,g);a.lineTo(this.width()-this.corner-f,g);a.stroke()};RingCommandSlotMorph.prototype=new CommandSlotMorph;RingCommandSlotMorph.prototype.constructor=RingCommandSlotMorph;RingCommandSlotMorph.uber=CommandSlotMorph.prototype;RingCommandSlotMorph.prototype.rfBorder=0;RingCommandSlotMorph.prototype.edge=RingMorph.prototype.edge;function RingCommandSlotMorph(){this.init()}
RingCommandSlotMorph.prototype.init=function(){RingCommandSlotMorph.uber.init.call(this);this.color=new Color(0,17,173);this.contrast=RingMorph.prototype.contrast};RingCommandSlotMorph.prototype.getSpec=function(){return"%rc"};RingCommandSlotMorph.prototype.render=function(a){MorphicPreferences.isFlat||(this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),a.fillStyle=this.cachedClr,this.drawEdges(a))};
RingCommandSlotMorph.prototype.outlinePath=function(a,b){var c=b.x;b=b.y;var d=null!==this.nestedBlock(),e=d?this.inset:this.inset/2,f=d?this.dent:this.dent/2,g=2*this.corner+e,h=this.edge,k=this.width(),l=this.height();d=d?this.rfBorder:0;l=l-this.corner-h;a.arc(this.corner+h+c,this.corner+h+b,this.corner,radians(-180),radians(-90),!1);a.lineTo(this.corner+e+h+2*d+c,h+b);a.lineTo(g+h+2*d+c,this.corner+h+b);a.lineTo(g+h+2*d+(f-2*d)+c,this.corner+h+b);a.lineTo(g+h+2*d+(f-2*d)+this.corner+c,h+b);a.lineTo(this.width()-
this.corner-h+c,h+b);a.arc(k-this.corner-h+c,this.corner+h+b,this.corner,radians(-90),radians(-0),!1);a.arc(this.width()-this.corner-h+c,l+b,this.corner,radians(0),radians(90),!1);a.arc(this.corner+h+c,l+b,this.corner,radians(90),radians(180),!1);a.lineTo(this.corner+h+c-this.corner,this.corner+h+b)};CSlotMorph.prototype=new CommandSlotMorph;CSlotMorph.prototype.constructor=CSlotMorph;CSlotMorph.uber=CommandSlotMorph.prototype;function CSlotMorph(){this.init()}
CSlotMorph.prototype.init=function(){CommandSlotMorph.uber.init.call(this);this.isLoop=this.isLambda=!1;this.color=new Color(0,17,173);this.setExtent(new Point(230,4*this.corner+this.cSlotPadding))};CSlotMorph.prototype.getSpec=function(){return this.isLoop?"%loop":"%c"};
CSlotMorph.prototype.mappedCode=function(a){var b=(StageMorph.prototype.codeMappings.reify||"<#1>").split("\n"),c=this.nestedBlock(),d=(c?c.mappedCode(a):"").toString().split("\n"),e=/<#1>/g;b.forEach(function(f,g){var h="";0===f.trimLeft().indexOf("<#1>")&&(h=f.indexOf("<#1>"),h=f.slice(0,h));b[g]=f.replace(/<#1>/,d.join("\n"+h));b[g]=b[g].replace(e,d.join("\n"))});return b.join("\n")};
CSlotMorph.prototype.fixLayout=function(){var a=this.nestedBlock();a?(a.setPosition(new Point(this.left()+this.inset,this.top()+this.corner)),this.bounds.setHeight(a.fullBounds().height()+this.corner),this.bounds.setWidth(a.fullBounds().width()+2*this.cSlotPadding)):(this.bounds.setHeight(4*this.corner+this.cSlotPadding),this.bounds.setWidth(4*this.corner+2*this.inset+this.dent+2*this.cSlotPadding));this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};
CSlotMorph.prototype.fixLoopLayout=function(){var a;this.isLoop&&(a=this.loop())&&(a.setRight(this.right()-this.corner),a.setBottom(this.bottom()+this.cSlotPadding+this.edge))};CSlotMorph.prototype.loop=function(){return this.isLoop?detect(this.children,function(a){return a instanceof SymbolMorph}):null};CSlotMorph.prototype.fixHolesLayout=function(){this.holes=[new Rectangle(this.inset,this.corner,this.width(),this.height()-this.corner)]};
CSlotMorph.prototype.isLocked=function(){return this.isStatic||this.parent instanceof MultiArgMorph};CSlotMorph.prototype.render=function(a){MorphicPreferences.isFlat||(this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),a.fillStyle=this.cachedClr,this.drawTopRightEdge(a),this.drawTopEdge(a,this.inset,this.corner),this.drawTopLeftEdge(a),this.drawBottomEdge(a),this.drawRightEdge(a))};
CSlotMorph.prototype.outlinePath=function(a,b,c){var d=c.x;c=c.y;var e=Math.max(this.corner-b,0);a.lineTo(this.width()+d-b,c);a.arc(this.width()-this.corner+d,c,e,radians(90),radians(0),!0);a.lineTo(this.width()-this.corner+d,this.corner+c-b);a.lineTo(2*this.inset+3*this.corner+this.dent+d,this.corner+c-b);a.lineTo(2*this.inset+2*this.corner+this.dent+d,2*this.corner+c-b);a.lineTo(2*this.inset+2*this.corner+d,2*this.corner+c-b);a.lineTo(2*this.inset+this.corner+d,this.corner+c-b);a.lineTo(this.inset+
this.corner+d,this.corner+c-b);a.arc(this.inset+this.corner+d,2*this.corner+c,this.corner+b,radians(270),radians(180),!0);a.lineTo(this.inset+d-b,this.height()-2*this.corner+c);a.arc(this.inset+this.corner+d,this.height()-2*this.corner+c,this.corner+b,radians(180),radians(90),!0);a.lineTo(this.width()-this.corner+d,this.height()-this.corner+c+b);a.arc(this.width()-this.corner+d,this.height()+c,e,radians(-90),radians(-0),!1)};
CSlotMorph.prototype.drawTopRightEdge=function(a){var b=.5*this.edge,c=this.width()-this.corner;var d=a.createRadialGradient(c,0,this.corner,c,0,this.corner-this.edge);d.addColorStop(0,this.cachedClrDark);d.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.arc(c,0,this.corner-b,radians(90),radians(0),!0);a.stroke()};
CSlotMorph.prototype.drawTopEdge=function(a,b,c){var d=.5*this.edge,e=b+2*this.corner+this.inset;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var f=a.createLinearGradient(0,c-this.edge,0,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(b+this.corner,c-d);a.lineTo(b+this.corner+this.inset-d,c-d);a.stroke();var g=a.createLinearGradient(0,c+this.corner-this.edge,0,c+this.corner);g.addColorStop(0,this.cachedClr);g.addColorStop(1,
this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(e+d,c+this.corner-d);a.lineTo(e+this.dent,c+this.corner-d);a.stroke();e=a.createLinearGradient(b+this.inset+2*this.corner+this.dent-d,c+this.corner-d-d,b+this.inset+2*this.corner+this.dent+.7*d,c+this.corner-d+.7*d);e.addColorStop(0,this.cachedClr);e.addColorStop(1,this.cachedClrDark);a.strokeStyle=e;a.beginPath();a.moveTo(b+this.inset+2*this.corner+this.dent,c+this.corner-d);a.lineTo(b+3*this.corner+this.inset+this.dent,c-d);a.stroke();a.strokeStyle=
f;a.beginPath();a.moveTo(b+3*this.corner+this.inset+this.dent,c-d);a.lineTo(this.width()-this.corner,c-d);a.stroke()};
CSlotMorph.prototype.drawTopLeftEdge=function(a){var b=.5*this.edge;var c=a.createRadialGradient(this.corner+this.inset,2*this.corner,this.corner,this.corner+this.inset,2*this.corner,this.corner+this.edge);c.addColorStop(0,this.cachedClrDark);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.arc(this.corner+this.inset,2*this.corner,this.corner+b,radians(-180),radians(-90),!1);a.stroke()};
CSlotMorph.prototype.drawRightEdge=function(a){var b=.5*this.edge,c=this.inset;var d=a.createLinearGradient(c-this.edge,0,c,0);d.addColorStop(0,this.cachedClr);d.addColorStop(1,this.cachedClrDark);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.moveTo(c-b,2*this.corner);a.lineTo(c-b,this.height()-2*this.corner);a.stroke()};
CSlotMorph.prototype.drawBottomEdge=function(a){var b=.5*this.edge;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var c=a.createRadialGradient(this.corner+this.inset,this.height()-2*this.corner,this.corner,this.corner+this.inset,this.height()-2*this.corner,this.corner+this.edge);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.arc(this.corner+this.inset,this.height()-2*this.corner,this.corner+b,radians(180),radians(90),!0);a.stroke();
c=a.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.inset+this.corner,this.height()-this.corner+b);a.lineTo(this.width()-this.corner,this.height()-this.corner+b);a.stroke()};InputSlotMorph.prototype=new ArgMorph;InputSlotMorph.prototype.constructor=InputSlotMorph;InputSlotMorph.uber=ArgMorph.prototype;
function InputSlotMorph(a,b,c,d){this.init(a,b,c,d)}
InputSlotMorph.prototype.init=function(a,b,c,d){var e=new InputSlotStringMorph(""),f=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1),BLACK,!0);e.fontSize=this.fontSize;e.isShowingBlanks=!0;this.selectedBlock=null;this.isUnevaluated=!1;this.choices=c||null;this.oldContentsExtent=e.extent();this.isNumeric=b||!1;this.isReadOnly=d||!1;this.minWidth=0;this.constant=null;InputSlotMorph.uber.init.call(this,null,!0);this.color=WHITE;this.add(e);this.add(f);e.isEditable=!0;e.isDraggable=!1;
e.enableSelecting();this.setContents(a)};InputSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%n":"%s"};InputSlotMorph.prototype.contents=function(){return detect(this.children,function(a){return a instanceof StringMorph})};InputSlotMorph.prototype.arrow=function(){return detect(this.children,function(a){return a instanceof ArrowMorph})};InputSlotMorph.prototype.getConstantDisplayName=function(a){return"serviceNames"===this.choices?a.split("/").pop():a};
InputSlotMorph.prototype.setContents=function(a){var b=this.contents(),c=a,d=c instanceof Array;this.selectedBlock&&(this.selectedBlock=null);if(d)c=localize(this.getConstantDisplayName(c[0])),b.isItalic=!this.isReadOnly;else if(c instanceof BlockMorph)this.selectedBlock=c,c="";else if(b.isItalic=!1,!isNil(this.choices)&&this.choices[c]instanceof Array)return this.setContents(this.choices[c]);b.text=c;isNil(c)?b.text="":c.toString&&(b.text=c.toString());this.isReadOnly&&!MorphicPreferences.isFlat&&
(b.shadowOffset=new Point(1,1));b.fixLayout();this.constant=d?a:null;this.lastValue=a;this.isReadOnly&&this.parent instanceof BlockMorph&&this.parent.fixLabelColor()};InputSlotMorph.prototype.userSetContents=function(a){this.selectForEdit().updateFieldValue(a)};
InputSlotMorph.prototype.dropDownMenu=function(a){var b=this,c,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){if(1==e.nextAddress)return c=b.world().hand.position(),e.yield(b.menuFromDict(b.choices,null,a),2);d=e.yieldResult;if(!d)return e.return();0<d.items.length&&(a?(d.popup(b.world(),b.bottomLeft()),d.getFocus()):d.popup(b.world(),c));e.jumpToEnd()})};
InputSlotMorph.prototype.menuFromDict=function(a,b,c){function d(w){l.setContents(w);l.reactToSliderEdit()}function e(w){return function(){return w.fullImage()}}var f=this,g,h,k,l,m,n,q,p,t,r,u,v;return $jscomp.asyncExecutePromiseGeneratorProgram(function(w){switch(w.nextAddress){case 1:l=f;m=new MenuMorph(f.userSetContents,null,f,f.fontSize);if(a instanceof Function)return w.yield(a.call(f),6);if(!isString(a)){w.jumpTo(3);break}return w.yield(f[a](c),5);case 5:a=w.yieldResult;if(!a)return w.return();
w.jumpTo(3);break;case 6:a=w.yieldResult;case 3:b||m.addItem(" ",null),n=w.forIn(a);case 7:if(null==(g=n.getNext())){w.jumpTo(9);break}if(!Object.prototype.hasOwnProperty.call(a,g)){w.jumpTo(7);break}if("~"===g[0]){m.addLine();w.jumpTo(7);break}if(0===g.indexOf("\u00a7_def")){m.addItem(f.doWithAlpha(1,e(a[g])),a[g]);w.jumpTo(7);break}if(0===g.indexOf("\u00a7_dir")){h=new DialMorph;h.rootForGrab=function(){return this};h.target=f;h.action=d;h.fillColor=f.parent.color;h.setRadius(3*f.fontSize);h.setValue(+f.evaluate(),
!1,!0);m.addLine();m.items.push(h);m.addLine();w.jumpTo(7);break}if(0===g.indexOf("\u00a7_")){16===f.world().currentKey&&m.addItem(g.slice(2),a[g],null,null,null,!0,null,null,!(a[g]instanceof Array)&&"function"!==typeof a[g]);w.jumpTo(7);break}if("__shout__go__"===g){k=new SymbolMorph("flag");k.size=1.5*f.fontSize;k.setColor(new Color(0,200,0));k.fixLayout();m.addItem(k,["__shout__go__"]);w.jumpTo(7);break}if(a[g]instanceof Object&&!(a[g]instanceof Array)&&"function"!==typeof a[g])return r=m,u=r.addMenu,
v=g,w.yield(f.menuFromDict(a[g],!0),20);if(!(a[g]instanceof Array&&a[g][0]instanceof Object&&"function"!==typeof a[g][0])){m.addItem(g,a[g],null,null,null,null,null,null,!(a[g]instanceof Array)&&"function"!==typeof a[g]);w.jumpTo(7);break}q=m;p=q.addMenu;t=g;return w.yield(f.menuFromDict(a[g][0],!0),19);case 19:p.call(q,t,w.yieldResult,null,!1);w.jumpTo(7);break;case 20:u.call(r,v,w.yieldResult,null,!0);w.jumpTo(7);break;case 9:return w.return(m)}})};
InputSlotMorph.prototype.messageTypesMenu=function(){for(var a=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph).messageTypes.names(),b={},c=a.length;c--;)b[a[c]]=a[c];return b};InputSlotMorph.prototype.messageTypes=function(){for(var a=this.parentThatIsA(IDE_Morph).stage.messageTypes.names(),b={},c=a.length;c--;)b[a[c]]=a[c];return b};
InputSlotMorph.prototype.roleNames=function(){for(var a=this.root().children[0],b=a.room.getRoleNames(),c={},d=b.length;d--;)a.projectName!==b[d]&&(c[b[d]]=b[d]);c["others in room"]=["others in room"];c["everyone in room"]=["everyone in room"];return c};InputSlotMorph.prototype.getURL=function(a){try{return utils.getUrlSync(a)}catch(b){return""}};
InputSlotMorph.prototype.rpcActions=function(){var a=this.parent.inputs()[0],b={},c;a&&(c=a.evaluate());if(c)for(a=Object.keys(JSON.parse(this.getURL("/rpc/"+c))),c=a.length;c--;)b[a[c]]=a[c];return b};
InputSlotMorph.prototype.messagesMenu=function(){var a=this,b={},c=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),d=[];c.children.concat(c).forEach(function(e){isSnapObject(e)&&(d=d.concat(e.allMessageNames()))});d.sort().forEach(function(e){return b[e]=e});16===this.world().currentKey&&(b.__shout__go__=["__shout__go__"]);0<d.length&&(b["~"]=null);b["new..."]=function(){return(new DialogBoxMorph(a,a.updateFieldValue,a)).prompt("Message name",null,a.world())};return b};
InputSlotMorph.prototype.messagesReceivedMenu=function(){var a=this,b={"any message":["any message"]},c=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),d=[];c.children.concat(c).forEach(function(e){isSnapObject(e)&&(d=d.concat(e.allMessageNames()))});d.sort().forEach(function(e){"__shout__go__"!==e&&(b[e]=e)});b["~"]=null;b["new..."]=function(){return(new DialogBoxMorph(a,a.updateFieldValue,a)).prompt("Message name",null,a.world())};return b};
InputSlotMorph.prototype.collidablesMenu=function(){var a={"mouse-pointer":["mouse-pointer"],edge:["edge"],"pen trails":["pen trails"]},b=this.parentThatIsA(BlockMorph).scriptTarget(),c=[];b.parentThatIsA(StageMorph).children.forEach(function(d){d instanceof SpriteMorph&&!d.isTemporary&&d.name!==b.name&&(c=c.concat(d.name))});0<c.length&&(a["~"]=null,c.forEach(function(d){return a[d]=d}));return a};
InputSlotMorph.prototype.locationMenu=function(){var a={"mouse-pointer":["mouse-pointer"],myself:["myself"]},b=this.parentThatIsA(BlockMorph).scriptTarget(),c=[];b.parentThatIsA(StageMorph).children.forEach(function(d){d instanceof SpriteMorph&&!d.isTemporary&&d.name!==b.name&&(c=c.concat(d.name))});0<c.length&&(a["~"]=null,c.forEach(function(d){return a[d]=d}));return a};
InputSlotMorph.prototype.distancesMenu=function(){var a=this.parentThatIsA(BlockMorph),b={},c=this.parentThatIsA(BlockMorph).scriptTarget(),d=c.parentThatIsA(StageMorph),e=[];a&&"reportRelationTo"!==a.selector&&(b["random position"]=["random position"]);b["mouse-pointer"]=["mouse-pointer"];b.center=["center"];d.children.forEach(function(f){f instanceof SpriteMorph&&!f.isTemporary&&f.name!==c.name&&(e=e.concat(f.name))});0<e.length&&(b["~"]=null,e.forEach(function(f){return b[f]=f}));return b};
InputSlotMorph.prototype.clonablesMenu=function(){var a={},b=this.parentThatIsA(BlockMorph).scriptTarget(),c=b.parentThatIsA(StageMorph),d=[];b instanceof SpriteMorph&&(a.myself=["myself"]);c.children.forEach(function(e){e instanceof SpriteMorph&&!e.isTemporary&&(d=d.concat(e.name))});0<d.length&&(a["~"]=null,d.forEach(function(e){return a[e]=e}));return a};InputSlotMorph.prototype.objectsMenuWithSelf=function(){return this.objectsMenu(!0)};
InputSlotMorph.prototype.objectsMenu=function(a){var b=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),c={},d=[];a&&(c.myself=["myself"]);c[b.name]=b.name;b.children.forEach(function(e){e instanceof SpriteMorph&&!e.isTemporary&&d.push(e.name)});0<d.length&&(c["~"]=null,d.forEach(function(e){return c[e]=e}));return c};
InputSlotMorph.prototype.typesMenu=function(){var a={number:["number"],text:["text"],Boolean:["Boolean"],list:["list"]};SpriteMorph.prototype.enableFirstClass&&(a.sprite=["sprite"]);a.costume=["costume"];a.sound=["sound"];a.command=["command"];a.reporter=["reporter"];a.predicate=["predicate"];return a};
InputSlotMorph.prototype.gettablesMenu=function(){var a={},b=SpriteMorph.prototype.enableNesting,c=StageMorph.prototype.enableInheritance;a.neighbors=["neighbors"];a.self=["self"];a["other sprites"]=["other sprites"];a.clones=["clones"];a["other clones"]=["other clones"];b&&(a.parts=["parts"],a.anchor=["anchor"]);a.stage=["stage"];c&&(a.children=["children"],a.parent=["parent"],a["temporary?"]=["temporary?"]);a.name=["name"];a.costume=["costume"];a.costumes=["costumes"];a.sounds=["sounds"];a["dangling?"]=
["dangling?"];a["draggable?"]=["draggable?"];a.width=["width"];a.height=["height"];a.left=["left"];a.right=["right"];a.top=["top"];a.bottom=["bottom"];a["rotation style"]=["rotation style"];a["rotation x"]=["rotation x"];a["rotation y"]=["rotation y"];a["center x"]=["center x"];a["center y"]=["center y"];return a};
InputSlotMorph.prototype.attributesMenu=function(){var a=this.parentThatIsA(BlockMorph),b=a.inputs()[1].evaluate(),c=a.scriptTarget().parentThatIsA(StageMorph),d={};a=[];c=b===c.name?c:detect(c.children,function(e){return e.name===b});if(!c)return d;d=c instanceof SpriteMorph?{"x position":["x position"],"y position":["y position"],direction:["direction"],"costume #":["costume #"],"costume name":["costume name"],size:["size"],width:["width"],height:["height"],left:["left"],right:["right"],top:["top"],
bottom:["bottom"],volume:["volume"],balance:["balance"]}:{"costume #":["costume #"],"costume name":["costume name"],volume:["volume"],balance:["balance"],width:["width"],height:["height"],left:["left"],right:["right"],top:["top"],bottom:["bottom"]};a=c.variables.names();0<a.length&&(d["~"]=null,a.forEach(function(e){return d[e]=e}));c.allBlocks(!0).forEach(function(e,f){return d["\u00a7_def"+f]=e.blockInstance(!0)});return d};
InputSlotMorph.prototype.costumesMenu=function(){var a=this.parentThatIsA(BlockMorph),b=a.scriptTarget(),c=[];var d=b instanceof SpriteMorph?{Turtle:["Turtle"]}:{Empty:["Empty"]};"doSwitchToCostume"!==a.selector&&(d.current=["current"]);b.costumes.asArray().forEach(function(e){return c=c.concat(e.name)});0<c.length&&(d["~"]=null,c.forEach(function(e){return d[e]=e}));return d};
InputSlotMorph.prototype.soundsMenu=function(){var a=[],b={};this.parentThatIsA(BlockMorph).scriptTarget().sounds.asArray().forEach(function(c){return a=a.concat(c.name)});0<a.length&&a.sort().forEach(function(c){return b[c]=c});return b};
InputSlotMorph.prototype.shadowedVariablesMenu=function(){var a=this.parentThatIsA(BlockMorph),b={};if(!a)return b;var c=a.scriptTarget();this.parentThatIsA(RingMorph)||"receiveOnClone"===this.topBlock().selector?(a=c.variables.names(),a.forEach(function(d){return b[d]=d}),a=c.attributes,a.forEach(function(d){return b[d]=[d]})):c&&c.exemplar&&(a=c.inheritedVariableNames(!0),a.forEach(function(d){return b[d]=d}),a=c.shadowedAttributes(),a.forEach(function(d){return b[d]=[d]}));return b};
InputSlotMorph.prototype.pianoKeyboardMenu=function(){var a;if(a=this.parentThatIsA(BlockMorph))var b=a.scriptTarget().instrument;a=new PianoMenuMorph(this.setContents,this,this.fontSize,b);a.popup(this.world(),new Point(this.right()-a.width()/2,this.bottom()));a.selectKey(+this.evaluate())};InputSlotMorph.prototype.directionDialMenu=function(){return{"\u00a7_dir":null}};
InputSlotMorph.prototype.audioMenu=function(){var a={volume:["volume"],note:["note"],frequency:["frequency"],samples:["samples"],"sample rate":["sample rate"],spectrum:["spectrum"],resolution:["resolution"]};16===this.world().currentKey&&(a["~"]=null,a.modifier=["modifier"],a.output=["output"]);return a};
InputSlotMorph.prototype.setChoices=function(a,b){var c=this.contents();this.choices=a;this.isReadOnly=b||!1;this.parent instanceof BlockMorph&&(this.parent.fixLabelColor(),b||(c.shadowOffset=ZERO,c.shadowColor=null,c.setColor(BLACK)));this.fixLayout()};InputSlotMorph.prototype.shadowedVariablesMenu=function(){var a=this.parentThatIsA(BlockMorph),b={};if(!a)return b;(a=a.receiver())&&a.inheritedVariableNames(!0).forEach(function(c){b[c]=c});return b};InputSlotMorph.prototype.directionDialMenu=function(){return{"\u00a7_dir":null}};
InputSlotMorph.prototype.audioMenu=function(){var a={volume:["volume"],note:["note"],frequency:["frequency"],samples:["samples"],"sample rate":["sample rate"],spectrum:["spectrum"],resolution:["resolution"]};16===this.world().currentKey&&(a["~"]=null,a.modifier=["modifier"],a.output=["output"]);return a};
InputSlotMorph.prototype.fixLayout=function(){var a=this.contents(),b=this.arrow(),c=this.topBlock();a.isNumeric=this.isNumeric;a.isEditable=!this.isReadOnly;this.isReadOnly?(a.disableSelecting(),a.color=WHITE):(a.enableSelecting(),a.color=BLACK);this.choices?(b.setSize(this.fontSize),b.show()):b.hide();var d=b.isVisible?b.width():0;if(this.selectedBlock){var e=this.selectedBlock.height()+2*this.edge;var f=this.selectedBlock.width()+d+2*this.edge+2*this.typeInPadding}else e=a.height()+2*this.edge,
f=this.isNumeric?a.width()+Math.floor(.5*d)+e+2*this.typeInPadding:Math.max(a.width()+d+2*this.edge+2*this.typeInPadding,a.rawHeight?a.rawHeight()+d:fontHeight(a.fontSize)/1.3+d,this.minWidth);this.bounds.setExtent(new Point(f,e));this.isNumeric?a.setPosition((new Point(Math.floor(e/2),this.edge)).add(new Point(this.typeInPadding,0)).add(this.position())):a.setPosition((new Point(this.edge,this.edge)).add(new Point(this.typeInPadding,0)).add(this.position()));b.isVisible&&b.setPosition(new Point(this.right()-
d-this.edge,a.top()));this.parent&&this.parent.fixLayout&&(c.fullChanged(),this.parent.fixLayout(),c.fullChanged())};InputSlotMorph.prototype.mouseDownLeft=function(a){this.isReadOnly||this.arrow().bounds.containsPoint(a)?this.escalateEvent("mouseDownLeft",a):this.selectForEdit().contents().edit()};InputSlotMorph.prototype.mouseClickLeft=function(a){this.arrow().bounds.containsPoint(a)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.contents().edit()};
InputSlotMorph.prototype.reactToKeystroke=function(){if(this.constant){var a=this.contents();this.constant=null;a.isItalic=!1;a.rerender()}};InputSlotMorph.prototype.updateFieldValue=function(a){var b=this.parentThatIsA(BlockMorph);a=void 0!==a?a:this.contents().text;if(b.id)return this.setContents(this.lastValue),SnapActions.setField(this,a)};InputSlotMorph.prototype.reactToEdit=function(){this.updateFieldValue();this.contents().clearSelection()};
InputSlotMorph.prototype.freshTextEdit=function(a){this.onNextStep=function(){return a.selectAll()}};InputSlotMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(!StageMorph.prototype.enableCodeMapping)return this.parent.userMenu();this.isNumeric?a.addItem("code number mapping...","mapNumberToCode"):a.addItem("code string mapping...","mapStringToCode");return a};
InputSlotMorph.prototype.mapStringToCode=function(){(new DialogBoxMorph(this,function(a){return StageMorph.prototype.codeMappings.string=a},this)).promptCode("Code mapping - String <#1>",StageMorph.prototype.codeMappings.string||"",this.world())};InputSlotMorph.prototype.mapNumberToCode=function(){(new DialogBoxMorph(this,function(a){return StageMorph.prototype.codeMappings.number=a},this)).promptCode("Code mapping - Number <#1>",StageMorph.prototype.codeMappings.number||"",this.world())};
InputSlotMorph.prototype.mappedCode=function(){var a=this.parentThatIsA(BlockMorph),b=this.evaluate();if(this.isNumeric)return a=StageMorph.prototype.codeMappings.number||"<#1>",a.replace(/<#1>/g,b);if(!isNaN(parseFloat(b))||!isString(b)||a&&contains(["doSetVar","doChangeVar","doShowVar","doHideVar"],a.selector))return b;a=StageMorph.prototype.codeMappings.string||"<#1>";return a.replace(/<#1>/g,b)};
InputSlotMorph.prototype.evaluate=function(){if(this.selectedBlock)return this.selectedBlock;if(this.constant)return this.constant;var a=this.contents();if(this.isNumeric){var b=parseFloat(a.text||"0");if(!isNaN(b))return b}return a.text};InputSlotMorph.prototype.isEmptySlot=function(){return""===this.contents().text&&!this.selectedBlock};InputSlotMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.color=this.activeHighlight,this.rerender())};
InputSlotMorph.prototype.unflash=function(){if(this.cachedNormalColor){var a=this.cachedNormalColor;this.cachedNormalColor=null;this.color=a;this.rerender()}};
InputSlotMorph.prototype.render=function(a){var b=this;var c=this.cachedNormalColor?this.color:this.parent?this.parent.color:new Color(120,120,120);a.fillStyle=this.color.toString();this.isReadOnly&&!this.cachedNormalColor&&(a.fillStyle=c.darker().toString());this.cachedClr=c.toString();this.cachedClrBright=c.lighter(this.contrast).toString();this.cachedClrDark=c.darker(this.contrast).toString();this.isNumeric?(c=Math.max((this.height()-2*this.edge)/2,0),a.beginPath(),a.arc(c+this.edge,c+this.edge,
c,radians(90),radians(-90),!1),a.arc(this.width()-c-this.edge,c+this.edge,c,radians(-90),radians(90),!1),a.closePath(),a.fill(),MorphicPreferences.isFlat||this.drawRoundBorder(a)):(a.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(a));this.selectedBlock&&a.drawImage(this.doWithAlpha(1,function(){return b.selectedBlock.fullImage()}),this.edge+this.typeInPadding,this.edge)};
InputSlotMorph.prototype.drawRectBorder=function(a){var b=.5*this.edge;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.shadowOffsetY=b;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var c=a.createLinearGradient(0,0,0,this.edge);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,b);a.lineTo(this.width()-this.edge-b,b);a.stroke();a.shadowOffsetY=0;c=a.createLinearGradient(0,0,this.edge,0);c.addColorStop(0,
this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(b,this.edge);a.lineTo(b,this.height()-this.edge-b);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;c=a.createLinearGradient(0,this.height()-this.edge,0,this.height());c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,this.height()-b);a.lineTo(this.width()-this.edge,this.height()-b);a.stroke();c=a.createLinearGradient(this.width()-
this.edge,0,this.width(),0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.width()-b,this.edge);a.lineTo(this.width()-b,this.height()-this.edge);a.stroke()};
InputSlotMorph.prototype.drawRoundBorder=function(a){var b=.5*this.edge,c=Math.max((this.height()-2*this.edge)/2,0);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var d=c+this.edge;var e=this.width()-c-this.edge;if(e>d){a.shadowOffsetX=b;a.shadowOffsetY=b;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var f=a.createLinearGradient(0,0,0,this.edge);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(d,b);a.lineTo(e,
b);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0}f=a.createLinearGradient(0,this.height()-this.edge,0,this.height());f.addColorStop(0,this.cachedClrBright);f.addColorStop(1,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(c+this.edge,this.height()-b);a.lineTo(this.width()-c-this.edge,this.height()-b);a.stroke();c=Math.max(this.height()/2,this.edge);a.shadowOffsetX=b;a.shadowOffsetY=b;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();f=a.createRadialGradient(c,
c,c-this.edge,c,c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(c,c,c-b,radians(180),radians(270),!1);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;f=a.createRadialGradient(this.width()-c,c,c-this.edge,this.width()-c,c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.arc(this.width()-c,c,c-b,radians(0),radians(90),!1);a.stroke()};InputSlotStringMorph.prototype=new StringMorph;
InputSlotStringMorph.prototype.constructor=InputSlotStringMorph;InputSlotStringMorph.uber=StringMorph.prototype;function InputSlotStringMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}InputSlotStringMorph.prototype.getRenderColor=function(){return MorphicPreferences.isFlat?this.isEditable?this.color:.5<this.parent.alpha?this.color:BLACK:.25<this.parent.alpha?this.color:WHITE};InputSlotStringMorph.prototype.getShadowRenderColor=function(){return.25<this.parent.alpha?this.shadowColor:CLEAR};
InputSlotTextMorph.prototype=new TextMorph;InputSlotTextMorph.prototype.constructor=InputSlotTextMorph;InputSlotTextMorph.uber=StringMorph.prototype;function InputSlotTextMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}InputSlotTextMorph.prototype.getRenderColor=InputSlotStringMorph.prototype.getRenderColor;InputSlotTextMorph.prototype.getShadowRenderColor=InputSlotStringMorph.prototype.getShadowRenderColor;TemplateSlotMorph.prototype=new ArgMorph;
TemplateSlotMorph.prototype.constructor=TemplateSlotMorph;TemplateSlotMorph.uber=ArgMorph.prototype;function TemplateSlotMorph(a){this.init(a)}
TemplateSlotMorph.prototype.init=function(a){var b=new ReporterBlockMorph;this.labelString=a||"";b.isDraggable=!1;b.isTemplate=!0;void 0!==modules.objects?(b.color=SpriteMorph.prototype.blockColor.variables,b.category="variables"):(b.color=new Color(243,118,29),b.category=null);b.setSpec(this.labelString);b.selector="reportGetVar";TemplateSlotMorph.uber.init.call(this);this.add(b);this.fixLayout();this.isDraggable=!1;this.isStatic=!0};TemplateSlotMorph.prototype.getSpec=function(){return"%t"};
TemplateSlotMorph.prototype.template=function(){return this.children[0]};TemplateSlotMorph.prototype.contents=function(){return this.template().blockSpec};TemplateSlotMorph.prototype.setContents=function(a){var b=this.template();b.setSpec(a);b.fixBlockColor();b.fixLabelColor()};TemplateSlotMorph.prototype.evaluate=function(){return this.contents()};
TemplateSlotMorph.prototype.fixLayout=function(){var a=this.template();this.bounds.setExtent(a.extent().add(2*this.edge+2));a.setPosition(this.position().add(this.edge+1));this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};TemplateSlotMorph.prototype.wantsDropOf=function(a){return"reportGetVar"===a.selector};TemplateSlotMorph.prototype.reactToDropOf=function(a){"reportGetVar"===a.selector&&a.destroy()};
TemplateSlotMorph.prototype.render=function(a){this.parent instanceof Morph&&(this.color=this.parent.color.copy());BlockMorph.prototype.render.call(this,a)};TemplateSlotMorph.prototype.outlinePath=ReporterBlockMorph.prototype.outlinePathOval;TemplateSlotMorph.prototype.outlinePath=ReporterBlockMorph.prototype.outlinePathOval;TemplateSlotMorph.prototype.drawEdges=ReporterBlockMorph.prototype.drawEdgesOval;TemplateSlotMorph.prototype.hasLocationPin=function(){return!1};
TemplateSlotMorph.prototype.cSlots=function(){return[]};TemplateSlotMorph.prototype.flash=function(){this.template().flash()};TemplateSlotMorph.prototype.unflash=function(){this.template().unflash()};BooleanSlotMorph.prototype=new ArgMorph;BooleanSlotMorph.prototype.constructor=BooleanSlotMorph;BooleanSlotMorph.uber=ArgMorph.prototype;BooleanSlotMorph.prototype.isTernary=!1;function BooleanSlotMorph(a){this.init(a)}
BooleanSlotMorph.prototype.init=function(a){this.value="boolean"===typeof a?a:null;this.isUnevaluated=!1;this.progress=0;BooleanSlotMorph.uber.init.call(this);this.alpha=1;this.fixLayout()};BooleanSlotMorph.prototype.getSpec=function(){return this.isUnevaluated?"%boolUE":"%b"};BooleanSlotMorph.prototype.evaluate=function(){return this.value};BooleanSlotMorph.prototype.isEmptySlot=function(){return null===this.value};
BooleanSlotMorph.prototype.isBinary=function(){return!this.isTernary&&isNil(this.parentThatIsA(RingMorph))&&!isNil(this.parentThatIsA(ScriptsMorph))};BooleanSlotMorph.prototype.setContents=function(a){this.value="boolean"===typeof a?a:null;this.rerender()};
BooleanSlotMorph.prototype.toggleValue=function(){var a=this,b=this.selectForEdit();if(b!==this)return this.toggleValue.call(b);b=this.parentThatIsA(IDE_Morph);this.value=this.nextValue();b&&!b.isAnimating?this.rerender():(this.progress=3,this.rerender(),this.nextSteps([function(){a.progress=2;a.rerender()},function(){a.progress=1;a.rerender()},function(){a.progress=0;a.rerender()}]))};
BooleanSlotMorph.prototype.nextValue=function(){if(this.isStatic||this.isBinary())return!this.value;switch(this.value){case !0:return!1;case !1:return null;default:return!0}};BooleanSlotMorph.prototype.mouseClickLeft=function(){this.parentThatIsA(BlockMorph).id?SnapActions.toggleBoolean(this,this.value):this.toggleValue()};BooleanSlotMorph.prototype.mouseEnter=function(){this.isStatic||(null===this.nextValue()?this.progress=-1:this.progress=1,this.rerender())};
BooleanSlotMorph.prototype.mouseLeave=function(){this.isStatic||(this.progress=0,this.rerender())};BooleanSlotMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(!StageMorph.prototype.enableCodeMapping)return this.parent.userMenu();!0===this.evaluate()?a.addItem("code true mapping...","mapTrueToCode"):a.addItem("code false mapping...","mapFalseToCode");return a};
BooleanSlotMorph.prototype.mapTrueToCode=function(){(new DialogBoxMorph(this,function(a){return StageMorph.prototype.codeMappings["true"]=a},this)).promptCode("Code mapping - true",StageMorph.prototype.codeMappings["true"]||"true",this.world())};BooleanSlotMorph.prototype.mapFalseToCode=function(){(new DialogBoxMorph(this,function(a){return StageMorph.prototype.codeMappings["false"]=a},this)).promptCode("Code mapping - false",StageMorph.prototype.codeMappings["false"]||"false",this.world())};
BooleanSlotMorph.prototype.mappedCode=function(){return!0===this.evaluate()?StageMorph.prototype.codeMappings.boolTrue||"true":StageMorph.prototype.codeMappings.boolFalse||"false"};BooleanSlotMorph.prototype.fixLayout=function(){if(this.isStatic){var a=this.textLabelExtent();var b=a.y+3*this.edge;this.bounds.setWidth(a.x+1.5*b+2*this.edge);this.bounds.setHeight(b)}else this.bounds.setWidth(2*(this.fontSize+2*this.edge)),this.bounds.setHeight(this.fontSize+2*this.edge)};
BooleanSlotMorph.prototype.render=function(a){this.cachedNormalColor||(this.color=this.parent?this.parent.color:new Color(200,200,200));this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.drawDiamond(a,this.progress);this.drawLabel(a);this.drawKnob(a,this.progress)};
BooleanSlotMorph.prototype.drawDiamond=function(a,b){var c=this.width(),d=this.height(),e=d/2,f=c/2,g=this.edge/2;if(this.cachedNormalColor)a.fillStyle=this.color.toString();else if(0>b)a.fillStyle=this.color.darker(25).toString();else switch(this.value){case !0:a.fillStyle="rgb(0, 200, 0)";break;case !1:a.fillStyle="rgb(200, 0, 0)";break;default:a.fillStyle=this.color.darker(25).toString()}0<b&&!this.isEmptySlot()?(a.fillStyle="rgb(0, 200, 0)",a.beginPath(),a.moveTo(0,e),a.lineTo(e,0),a.lineTo(f,
0),a.lineTo(f,d),a.lineTo(e,d),a.closePath(),a.fill(),a.fillStyle="rgb(200, 0, 0)",a.beginPath(),a.moveTo(f,0),a.lineTo(c-e,0),a.lineTo(c,e),a.lineTo(c-e,d),a.lineTo(f,d)):(a.beginPath(),a.moveTo(0,e),a.lineTo(e,0),a.lineTo(c-e,0),a.lineTo(c,e),a.lineTo(c-e,d),a.lineTo(e,d));a.closePath();a.fill();MorphicPreferences.isFlat||(a.lineWidth=this.edge,a.lineJoin="round",a.lineCap="round",a.shadowOffsetX=g,a.shadowBlur=g,a.shadowColor="black",b=a.createLinearGradient(0,e,.6*this.edge,e+.6*this.edge),b.addColorStop(1,
this.cachedClrDark),b.addColorStop(0,this.cachedClr),a.strokeStyle=b,a.beginPath(),a.moveTo(g,e),a.lineTo(e,g),a.closePath(),a.stroke(),a.shadowOffsetX=0,a.shadowOffsetY=g,a.shadowBlur=this.edge,b=a.createLinearGradient(0,0,0,this.edge),b.addColorStop(1,this.cachedClrDark),b.addColorStop(0,this.cachedClr),a.strokeStyle=b,a.beginPath(),a.moveTo(e,g),a.lineTo(c-e,g),a.closePath(),a.stroke(),a.shadowOffsetY=0,a.shadowBlur=0,b=a.createLinearGradient(c-e-.6*this.edge,d-.6*this.edge,c-e,d),b.addColorStop(1,
this.cachedClr),b.addColorStop(0,this.cachedClrBright),a.strokeStyle=b,a.beginPath(),a.moveTo(c-e,d-g),a.lineTo(c-g,e),a.closePath(),a.stroke(),b=a.createLinearGradient(0,d-this.edge,0,d),b.addColorStop(1,this.cachedClr),b.addColorStop(0,this.cachedClrBright),a.strokeStyle=b,a.beginPath(),a.moveTo(e,d-g),a.lineTo(c-e-g,d-g),a.closePath(),a.stroke())};
BooleanSlotMorph.prototype.drawLabel=function(a){var b=this.width(),c=this.height()/2-this.edge,d=c/2,e=this.edge/2,f=this.height()/2;this.isEmptySlot()||0>this.progress||(this.isStatic?(b=this.textLabelExtent(),f=this.height()-(this.height()-b.y)/2,c=this.value?this.height()/2:this.width()-this.height()/2-b.x,a.save(),MorphicPreferences.isFlat||(a.shadowOffsetX=-e,a.shadowOffsetY=-e,a.shadowBlur=e,a.shadowColor=this.value?"rgb(0, 100, 0)":"rgb(100, 0, 0)"),a.font=(new StringMorph(null,this.fontSize,
null,!0)).font(),a.textAlign="left",a.textBaseline="bottom",a.fillStyle="rgb(255, 255, 255",a.fillText(localize(this.value?"true":"false"),c,f),a.restore()):(c=c+2*this.edge+e,MorphicPreferences.isFlat||(a.shadowOffsetX=-e,a.shadowOffsetY=-e,a.shadowBlur=e,a.shadowColor="rgb(0, 100, 0)"),a.strokeStyle="white",a.lineWidth=this.edge+e,a.lineCap="round",a.lineJoin="miter",a.beginPath(),a.moveTo(c-d,f),a.lineTo(c,f+d),a.lineTo(c+d,d+this.edge),a.stroke(),c=b-f-2*this.edge,MorphicPreferences.isFlat||(a.shadowOffsetX=
-e,a.shadowOffsetY=-e,a.shadowBlur=e,a.shadowColor="rgb(100, 0, 0)"),a.strokeStyle="white",a.lineWidth=this.edge,a.lineCap="butt",a.beginPath(),a.moveTo(c-d,f-d),a.lineTo(c+d,f+d),a.moveTo(c-d,f+d),a.lineTo(c+d,f-d),a.stroke()))};
BooleanSlotMorph.prototype.drawKnob=function(a,b){var c=this.width(),d=this.height()/2,e=this.edge/2,f=(this.width()-this.height())/4*Math.max(0,b||0),g=PushButtonMorph.prototype.outline/2,h=PushButtonMorph.prototype.outlineColor,k=PushButtonMorph.prototype.color,l=PushButtonMorph.prototype.contrast,m=k.lighter(l);l=k.darker(l);switch(this.value){case !1:c=d+f;MorphicPreferences.isFlat||(a.shadowOffsetX=e,a.shadowOffsetY=0,a.shadowBlur=e,a.shadowColor="black");0>b&&(a.globalAlpha=.6);break;case !0:c=
c-d-f;MorphicPreferences.isFlat||(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0);break;default:if(!b)return;c=d;MorphicPreferences.isFlat||(a.shadowOffsetX=e,a.shadowOffsetY=0,a.shadowBlur=e,a.shadowColor="black");a.globalAlpha=.6}a.fillStyle=k.toString();a.beginPath();a.arc(c,d,d,radians(0),radians(360));a.closePath();a.fill();MorphicPreferences.isFlat||(a.shadowOffsetX=0,a.shadowBlur=0,a.shadowColor="black",a.lineWidth=g,a.strokeStyle=h.toString(),a.beginPath(),a.arc(c,d,d-g/2,radians(0),radians(360)),
a.stroke(),b=a.createRadialGradient(c,d,d-g-this.edge,c,d,d-g),b.addColorStop(1,m.toString()),b.addColorStop(0,k.toString()),a.strokeStyle=b,a.lineCap="round",a.lineWidth=this.edge,a.beginPath(),a.arc(c,d,d-g-this.edge/2,radians(180),radians(270),!1),a.stroke(),b=a.createRadialGradient(c,d,d-g-this.edge,c,d,d-g),b.addColorStop(1,l.toString()),b.addColorStop(0,k.toString()),a.strokeStyle=b,a.lineCap="round",a.lineWidth=this.edge,a.beginPath(),a.arc(c,d,d-g-this.edge/2,radians(0),radians(90),!1),a.stroke());
a.globalAlpha=1};BooleanSlotMorph.prototype.textLabelExtent=function(){var a=new StringMorph(localize("true"),this.fontSize,null,!0);var b=new StringMorph(localize("false"),this.fontSize,null,!0);return new Point(Math.max(a.width(),b.width()),a.height())};ArrowMorph.prototype=new Morph;ArrowMorph.prototype.constructor=ArrowMorph;ArrowMorph.uber=Morph.prototype;function ArrowMorph(a,b,c,d,e){this.init(a,b,c,d,e)}
ArrowMorph.prototype.init=function(a,b,c,d,e){this.direction=a||"down";this.size=b||(0===b?0:50);this.padding=c||0;this.isBlockLabel=e||!1;ArrowMorph.uber.init.call(this);this.color=d||BLACK;this.bounds.setWidth(this.size);this.bounds.setHeight(this.size);this.rerender()};ArrowMorph.prototype.setSize=function(a){var b=Math.max(a,1);this.size=a;this.changed();this.bounds.setWidth(b);this.bounds.setHeight(b);this.rerender()};
ArrowMorph.prototype.render=function(a){var b=this.padding,c=this.height(),d=Math.floor(c/2),e=this.width(),f=Math.floor(e/2);a.fillStyle=this.getRenderColor().toString();a.beginPath();"down"===this.direction?(a.moveTo(b,d),a.lineTo(e-b,d),a.lineTo(f,c-b)):"up"===this.direction?(a.moveTo(b,d),a.lineTo(e-b,d),a.lineTo(f,b)):("left"===this.direction?(a.moveTo(b,d),a.lineTo(f,b)):(a.moveTo(f,b),a.lineTo(e-b,d)),a.lineTo(f,c-b));a.closePath();a.fill()};
ArrowMorph.prototype.getRenderColor=function(){return this.isBlockLabel?MorphicPreferences.isFlat?this.color:.5<SyntaxElementMorph.prototype.alpha?this.color:WHITE:this.color};TextSlotMorph.prototype=new InputSlotMorph;TextSlotMorph.prototype.constructor=TextSlotMorph;TextSlotMorph.uber=InputSlotMorph.prototype;function TextSlotMorph(a,b,c,d){this.init(a,b,c,d)}
TextSlotMorph.prototype.init=function(a,b,c,d){var e=new InputSlotTextMorph(""),f=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1),BLACK,!0);e.fontSize=this.fontSize;e.fixLayout();this.isUnevaluated=!1;this.choices=c||null;this.oldContentsExtent=e.extent();this.isNumeric=b||!1;this.isReadOnly=d||!1;this.minWidth=0;this.constant=null;InputSlotMorph.uber.init.call(this,null,null,null,null,!0);this.color=WHITE;this.add(e);this.add(f);e.isEditable=!0;e.isDraggable=!1;e.enableSelecting();
this.setContents(a)};TextSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%mln":"%mlt"};TextSlotMorph.prototype.contents=function(){return detect(this.children,function(a){return a instanceof TextMorph})};TextSlotMorph.prototype.layoutChanged=function(){this.fixLayout()};
SymbolMorph.prototype.drawSymbolQueue=function(a,b){var c=a.getContext("2d"),d=a.width/5,e=d/2,f=3*d,g=1*e+f/2,h=e;c.fillStyle=b.toString();var k=function(l){l+=d;var m=f/2;c.fillStyle=b.toString();c.beginPath();c.moveTo(l,g);c.lineTo(l+-1*d,g+m/2);c.lineTo(l+-1*d,g-m/2);c.fill()};k(h);h+=d+e;c.fillRect(h,e,d,f);h+=d+e;c.fillRect(h,e,d,f);k(h+(d+e));return a};
SymbolMorph.prototype.drawSymbolFootprints=function(a,b){var c=a.getContext("2d"),d=a.width,e=d/10,f=1.5*e;c.fillStyle=b.toString();c.beginPath();c.arc(f,f,f,radians(-200),radians(0),!1);c.lineTo(2*f,5.5*e);c.lineTo(e,6*e);c.closePath();c.fill();c.beginPath();c.arc(2.25*e,6.75*e,e,radians(-40),radians(-170),!1);c.closePath();c.fill();c.beginPath();c.arc(d-f,4.5*e,f,radians(-180),radians(20),!1);c.lineTo(d-e,8.5*e);c.lineTo(d-2*f,8*e);c.closePath();c.fill();c.beginPath();c.arc(d-2.25*e,9*e,e,radians(0),
radians(-150),!1);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolNetsBloxLogo=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=d/14,g=d-2*f;c.beginPath();c.arc(d/2,e/2,2*f,radians(180),radians(270));c.strokeStyle=b.toString();c.beginPath();c.arc(d/2,e/2,f,0,radians(360));c.stroke();c.beginPath();c.arc(d/2,e/2,2*f,0,radians(90));c.stroke();c.beginPath();c.arc(d/2,e/2,3*f,0,radians(90));c.stroke();c.beginPath();c.arc(d/2,e/2,2*f,radians(180),radians(270));c.stroke();c.beginPath();c.arc(d/2,e/2,3*f,radians(180),radians(270));
c.stroke();b=-60;var h=f;e/=2;g/=2;for(d=g-2*f-d/48;300>b;){var k=h,l=e,m=radians(b),n=d*Math.cos(m),q=d*Math.sin(m),p=f*Math.cos(m)+k,t=f*Math.sin(m)+l;c.beginPath();c.arc(k,l,f,m,m+2*Math.PI);c.moveTo(p,t);c.lineTo(k+n,l+q);c.stroke();h+=g*Math.cos(radians(b));e+=g*Math.sin(radians(b));b+=60}return a};ColorSlotMorph.prototype=new ArgMorph;ColorSlotMorph.prototype.constructor=ColorSlotMorph;ColorSlotMorph.uber=ArgMorph.prototype;function ColorSlotMorph(a){this.init(a)}
ColorSlotMorph.prototype.init=function(a){ColorSlotMorph.uber.init.call(this);this.alpha=1;this.setColor(a||new Color(145,26,68))};ColorSlotMorph.prototype.getSpec=function(){return"%clr"};
ColorSlotMorph.prototype.getUserColor=function(){var a=this,b=this.world(),c=b.hand,d=this.color,e=getDocumentPositionOf(b.worldCanvas),f=c.processMouseMove,g=c.processMouseDown,h=c.processMouseUp,k=new ColorPaletteMorph(null,new Point(16*this.fontSize,10*this.fontSize));b.add(k);k.setPosition(this.bottomLeft().add(new Point(0,this.edge)));c.processMouseMove=function(l){var m=b.getGlobalPixelColor(c.position());c.setPosition(new Point(l.pageX-e.x,l.pageY-e.y));m.a&&a.setColor(m)};c.processMouseDown=
nop;c.processMouseUp=function(){a.parentThatIsA(ScriptsMorph)?SnapActions.setColorField(a,a.color).catch(function(){a.setColor(d)}):a.setColor(a.color);k.destroy();c.processMouseMove=f;c.processMouseDown=g;c.processMouseUp=h}};ColorSlotMorph.prototype.mouseClickLeft=function(){this.selectForEdit().getUserColor()};ColorSlotMorph.prototype.evaluate=function(){return this.color};
ColorSlotMorph.prototype.fixLayout=function(){var a=this.fontSize+2*this.edge+2*this.typeInPadding;this.bounds.setWidth(a);this.bounds.setHeight(a)};
ColorSlotMorph.prototype.render=function(a){var b=this.parent?this.parent.color:new Color(120,120,120);a.fillStyle=this.color.toString();this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();a.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge);MorphicPreferences.isFlat||this.drawRectBorder(a)};ColorSlotMorph.prototype.drawRectBorder=InputSlotMorph.prototype.drawRectBorder;
BlockHighlightMorph.prototype=new Morph;BlockHighlightMorph.prototype.constructor=BlockHighlightMorph;BlockHighlightMorph.uber=Morph.prototype;function BlockHighlightMorph(){this.threadCount=0;this.init()}BlockHighlightMorph.prototype.init=function(){BlockHighlightMorph.uber.init.call(this);this.isCachingImage=!0};BlockHighlightMorph.prototype.readout=function(){return this.children.length?this.children[0]:null};
BlockHighlightMorph.prototype.updateReadout=function(){var a=this.readout(),b=useBlurredShadows&&!MorphicPreferences.isFlat?.4*SyntaxElementMorph.prototype.activeBlur:-2*SyntaxElementMorph.prototype.activeBorder;2>this.threadCount?a&&a.destroy():(a?(a.changed(),a.contents=this.threadCount.toString(),a.fixLayout(),a.rerender()):(a=new SpeechBubbleMorph(this.threadCount.toString(),this.color,null,null,this.color.darker(),null,1,!0),this.add(a)),a.setPosition(this.position().add(b)))};
MultiArgMorph.prototype=new ArgMorph;MultiArgMorph.prototype.constructor=MultiArgMorph;MultiArgMorph.uber=ArgMorph.prototype;function MultiArgMorph(a,b,c,d,e,f,g,h,k){this.init(a,b,c,d,e,f,g,h,k)}
MultiArgMorph.prototype.init=function(a,b,c,d,e,f,g,h,k){var l=new FrameMorph;this.slotSpec=a||"%s";this.labelText=localize(b||"");this.minInputs=c||0;this.elementSpec=d||null;this.labelColor=f||null;this.shadowColor=g||null;this.shadowOffset=h||null;this.canBeEmpty=!0;MultiArgMorph.uber.init.call(this);this.alpha=!1===k?1:0;l.alpha=!1===k?1:0;if(this.labelText||"%cs"===this.slotSpec)a=this.labelPart(this.labelText),this.add(a),a.hide();a=new ArrowMorph("left",this.fontSize,Math.max(Math.floor(this.fontSize/
6),1),e,!0);e=new ArrowMorph("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),e,!0);l.add(a);l.add(e);l.rerender();l.acceptsDrops=!1;this.add(l);for(l=0;l<this.minInputs;l+=1)this.addInput()};MultiArgMorph.prototype.label=function(){return this.labelText?this.children[0]:null};MultiArgMorph.prototype.arrows=function(){return this.children[this.children.length-1]};MultiArgMorph.prototype.getSpec=function(){return"%mult"+this.slotSpec};
MultiArgMorph.prototype.setContents=function(a){var b=this.inputs(),c;for(c=0;c<a.length;c+=1)null!==a[c]&&b[c]&&b[c].setContents(a[c])};MultiArgMorph.prototype.hide=function(){this.isVisible=!1;this.changed()};MultiArgMorph.prototype.show=function(){this.isVisible=!0;this.changed()};MultiArgMorph.prototype.setLabelColor=function(a,b,c){this.textColor=a;this.shadowColor=b;this.shadowOffset=c;MultiArgMorph.uber.setLabelColor.call(this,a,b,c)};
MultiArgMorph.prototype.fixLayout=function(){"%t"===this.slotSpec&&(this.isStatic=!0);if(this.parent){var a=this.label();this.color=this.parent.color;this.arrows().color=this.color;if(a){var b=this.shadowColor||this.parent.color.darker(this.labelContrast);var c=this.shadowOffset||(a?a.shadowOffset:null);a.shadowColor.eq(b)||(a.shadowColor=b,a.shadowOffset=c,a.fixLayout(),a.rerender())}}this.fixArrowsLayout();MultiArgMorph.uber.fixLayout.call(this);this.parent&&this.parent.fixLayout()};
MultiArgMorph.prototype.fixArrowsLayout=function(){var a=this.label(),b=this.arrows(),c=b.children[0],d=b.children[1],e=this.inputs().length,f=new Point(d.width()/2,d.height());e<this.minInputs+1?(a&&a.hide(),c.hide(),d.setPosition(b.position().subtract(new Point(f.x,0))),b.setExtent(f)):this.is3ArgRingInHOF()&&2<e?(d.hide(),b.setExtent(f)):(a&&a.show(),c.show(),d.show(),d.setPosition(c.topCenter()),b.bounds.corner=d.bottomRight().copy());b.rerender()};
MultiArgMorph.prototype.fixHolesLayout=function(){var a=this;this.holes=[];if("%cs"===this.slotSpec){var b=this.position();this.inputs().forEach(function(c){c instanceof CSlotMorph&&(c.fixHolesLayout(),a.holes.push(c.holes[0].translateBy(c.position().subtract(b))))})}};MultiArgMorph.prototype.refresh=function(){this.inputs().forEach(function(a){a.fixLayout();a.rerender()})};
MultiArgMorph.prototype.addInput=function(a){var b=this.labelPart(this.slotSpec),c=this.children.length-1;if(a)b.setContents(a);else if("%scriptVars"===this.elementSpec||"%blockVars"===this.elementSpec){var d="";a=c;for("%scriptVars"===this.elementSpec&&(a+=1);0<a;)d=String.fromCharCode(97+(a-1)%26)+d,a=Math.floor((a-1)/26);b.setContents(d)}else contains(["%parms","%ringparms"],this.elementSpec)&&(this.is3ArgRingInHOF()&&4>c?b.setContents([localize("value"),localize("index"),localize("list")][c-1]):
b.setContents("#"+c));b.parent=this;this.children.splice(c,0,b);b.fixLayout();this.fixLayout();return b};MultiArgMorph.prototype.removeInput=function(){var a;if(1<this.children.length){var b=this.children[this.children.length-2];this.removeChild(b);!(b instanceof BlockMorph)||b instanceof RingMorph&&!b.contents()||(a=this.parentThatIsA(ScriptsMorph))&&a.add(b)}this.fixLayout()};
MultiArgMorph.prototype.is3ArgRingInHOF=function(){var a=this.parent;if(a){var b=a.parent;if(b instanceof ReporterBlockMorph)return b.inputs()[0]===a&&contains("reportMap reportAtomicMap reportKeep reportAtomicKeep reportFindFirst reportAtomicFindFirst".split(" "),b.selector)}return!1};
MultiArgMorph.prototype.mouseClickLeft=function(a){var b=this.parentThatIsA(MessageDefinitionBlock);if(this.parentThatIsA(ScriptsMorph)||b){var c=this.selectForEdit(),d=c.arrows(),e=d.children[0],f=d.children[1];d=16===c.world().currentKey?3:1;if(f.bounds.containsPoint(a)){if(f.isVisible)if(b)for(a=0;a<d;a++)this.addInput();else SnapActions.addListInput(c,d)}else if(e.bounds.containsPoint(a)){if(e.isVisible)if(d=Math.min(d,this.inputs().length-this.minInputs),b)for(a=0;a<d;a++)this.removeInput();
else SnapActions.removeListInput(c,d)}else c.escalateEvent("mouseClickLeft",a)}else this.escalateEvent("mouseClickLeft",a)};
MultiArgMorph.prototype.userMenu=function(){var a=this,b=new MenuMorph(this),c=this.parentThatIsA(BlockMorph),d="";if(!StageMorph.prototype.enableCodeMapping)return this.parent.userMenu();c&&(c instanceof RingMorph?d="parms_":"doDeclareVariables"===c.selector&&(d="tempvars_"));b.addItem("code list mapping...",function(){return a.mapCodeList(d)});b.addItem("code item mapping...",function(){return a.mapCodeItem(d)});b.addItem("code delimiter mapping...",function(){return a.mapCodeDelimiter(d)});return b};
MultiArgMorph.prototype.mapCodeDelimiter=function(a){this.mapToCode(a+"delim","list item delimiter")};MultiArgMorph.prototype.mapCodeList=function(a){this.mapToCode(a+"list","list contents <#1>")};MultiArgMorph.prototype.mapCodeItem=function(a){this.mapToCode(a+"item","list item <#1>")};MultiArgMorph.prototype.mapToCode=function(a,b){(new DialogBoxMorph(this,function(c){return StageMorph.prototype.codeMappings[a]=c},this)).promptCode("Code mapping - "+b,StageMorph.prototype.codeMappings[a]||"",this.world())};
MultiArgMorph.prototype.mappedCode=function(a){var b=this.parentThatIsA(BlockMorph),c="",d="",e=0,f=[];b&&(b instanceof RingMorph?c="parms_":"doDeclareVariables"===b.selector&&(c="tempvars_"));b=StageMorph.prototype.codeMappings[c+"list"]||"<#1>";var g=StageMorph.prototype.codeMappings[c+"item"]||"<#1>";var h=StageMorph.prototype.codeMappings[c+"delim"]||" ";this.inputs().forEach(function(k){return f.push(g.replace(/<#1>/g,k.mappedCode(a)))});f.forEach(function(k){e&&(d+=h);d+=k;e+=1});return b=b.replace(/<#1>/g,
d)};MultiArgMorph.prototype.evaluate=function(){var a=[];this.inputs().forEach(function(b){return a.push(b.evaluate())});return a};MultiArgMorph.prototype.isEmptySlot=function(){return this.canBeEmpty?0===this.inputs().length:!1};ArgLabelMorph.prototype=new ArgMorph;ArgLabelMorph.prototype.constructor=ArgLabelMorph;ArgLabelMorph.uber=ArgMorph.prototype;function ArgLabelMorph(a,b){this.init(a,b)}
ArgLabelMorph.prototype.init=function(a,b){this.labelText=localize(b||"input list:");ArgLabelMorph.uber.init.call(this);this.isStatic=!0;this.alpha=0;b=this.labelPart(this.labelText);this.add(b);this.add(a)};ArgLabelMorph.prototype.label=function(){return this.children[0]};ArgLabelMorph.prototype.argMorph=function(){return this.children[1]};
ArgLabelMorph.prototype.fixLayout=function(){var a=this.label();if(this.parent){this.color=this.parent.color;var b=a.shadowOffset||ZERO;var c=0>b.x?this.parent.color.darker(this.labelContrast):this.parent.color.lighter(this.labelContrast);""===this.labelText||a.shadowColor.eq(c)||(a.shadowColor=c,a.shadowOffset=b,a.rerender())}ArgLabelMorph.uber.fixLayout.call(this);this.parent&&this.parent.fixLayout()};ArgLabelMorph.prototype.refresh=function(){this.inputs().forEach(function(a){a.fixLayout();a.rerender()})};
ArgLabelMorph.prototype.setLabelColor=function(a,b,c){if(""!==this.labelText){var d=this.label();d.color=a;d.shadowColor=b;d.shadowOffset=c;d.rerender()}};ArgLabelMorph.prototype.reactToGrabOf=function(){this.parent instanceof SyntaxElementMorph&&this.parent.revertToDefaultInput(this)};ArgLabelMorph.prototype.evaluate=function(){return this.argMorph().evaluate()};ArgLabelMorph.prototype.isEmptySlot=function(){return!1};FunctionSlotMorph.prototype=new ArgMorph;
FunctionSlotMorph.prototype.constructor=FunctionSlotMorph;FunctionSlotMorph.uber=ArgMorph.prototype;function FunctionSlotMorph(a){this.init(a)}FunctionSlotMorph.prototype.init=function(a){FunctionSlotMorph.uber.init.call(this);this.isPredicate=a||!1;this.color=this.rfColor};FunctionSlotMorph.prototype.getSpec=function(){return"%f"};
FunctionSlotMorph.prototype.render=function(a){var b=this.parent?this.parent.color:new Color(120,120,120);this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();this.isPredicate?this.drawDiamond(a):this.drawRounded(a)};
FunctionSlotMorph.prototype.drawRounded=function(a){var b=this.height(),c=Math.min(this.rounding,b/2),d=this.width(),e=this.edge/2;a.fillStyle=this.color.toString();a.beginPath();a.arc(c,c,c,radians(-180),radians(-90),!1);a.arc(d-c,c,c,radians(-90),radians(-0),!1);a.arc(d-c,b-c,c,radians(0),radians(90),!1);a.arc(c,b-c,c,radians(90),radians(180),!1);a.closePath();a.fill();if(!MorphicPreferences.isFlat){a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=this.cachedClr;a.beginPath();
a.arc(c,b-c,c-e,radians(90),radians(180),!1);a.stroke();a.strokeStyle=this.cachedClr;a.beginPath();a.arc(d-c,c,c-e,radians(-90),radians(0),!1);a.stroke();a.shadowOffsetX=e;a.shadowOffsetY=e;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var f=a.createLinearGradient(0,0,0,this.edge);f.addColorStop(1,this.cachedClrDark);f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,e);a.lineTo(d-c+e,e);a.stroke();f=a.createRadialGradient(c,c,c-this.edge,c,c,c);f.addColorStop(1,
this.cachedClr);f.addColorStop(0,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(c,c,c-e,radians(180),radians(270),!1);a.stroke();f=a.createLinearGradient(0,0,this.edge,0);f.addColorStop(1,this.cachedClrDark);f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(e,c);a.lineTo(e,b-c);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;f=a.createRadialGradient(d-c,b-c,c-this.edge,d-c,b-c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=
f;a.beginPath();a.arc(d-c,b-c,c-e,radians(0),radians(90),!1);a.stroke();f=a.createLinearGradient(0,b-this.edge,0,b);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,b-e);a.lineTo(d-c+e,b-e);a.stroke();f=a.createLinearGradient(d-this.edge,0,d,0);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(d-e,c+e);a.lineTo(d-e,b-c);a.stroke()}};
FunctionSlotMorph.prototype.drawDiamond=function(a){var b=this.width(),c=this.height(),d=Math.floor(c/2),e=Math.min(this.rounding,d),f=this.edge/2;a.fillStyle=this.color.toString();a.beginPath();a.moveTo(0,d);a.lineTo(e,0);a.lineTo(b-e,0);a.lineTo(b,d);a.lineTo(b-e,c);a.lineTo(e,c);a.closePath();a.fill();if(!MorphicPreferences.isFlat){a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=this.cachedClr;a.beginPath();a.moveTo(f,d);a.lineTo(e,c-f);a.stroke();a.strokeStyle=this.cachedClr;
a.beginPath();a.moveTo(b-f,d);a.lineTo(b-e,f);a.stroke();a.shadowOffsetX=f;a.shadowOffsetY=f;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var g=a.createLinearGradient(0,0,e,0);g.addColorStop(1,this.cachedClrDark);g.addColorStop(0,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(f,d);a.lineTo(e,f);a.stroke();g=a.createLinearGradient(0,0,0,this.edge);g.addColorStop(1,this.cachedClrDark);g.addColorStop(0,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(e,f);a.lineTo(b-
e,f);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;g=a.createLinearGradient(b-e,0,b,0);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=g;a.beginPath();a.moveTo(b-e,c-f);a.lineTo(b-f,d);a.stroke();g=a.createLinearGradient(0,c-this.edge,0,c);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=g;a.beginPath();a.moveTo(e+f,c-f);a.lineTo(b-e-f,c-f);a.stroke()}};ReporterSlotMorph.prototype=new FunctionSlotMorph;
ReporterSlotMorph.prototype.constructor=ReporterSlotMorph;ReporterSlotMorph.uber=FunctionSlotMorph.prototype;function ReporterSlotMorph(a){this.init(a)}ReporterSlotMorph.prototype.init=function(a){ReporterSlotMorph.uber.init.call(this,a,!0);this.add(this.emptySlot());this.fixLayout()};
ReporterSlotMorph.prototype.emptySlot=function(){var a=new ArgMorph,b=2*this.rfBorder+2*this.edge;a.color=this.rfColor;a.alpha=0;a.bounds.setExtent(new Point(2*(this.fontSize+2*this.edge)-b,this.fontSize+2*this.edge-b));return a};ReporterSlotMorph.prototype.getSpec=function(){return"%r"};ReporterSlotMorph.prototype.contents=function(){return this.children[0]};ReporterSlotMorph.prototype.nestedBlock=function(){var a=this.contents();return a instanceof ReporterBlockMorph?a:null};
ReporterSlotMorph.prototype.evaluate=function(){return this.nestedBlock()};ReporterSlotMorph.prototype.isEmptySlot=function(){return null===this.nestedBlock()};ReporterSlotMorph.prototype.fixLayout=function(){var a=this.contents();this.bounds.setExtent(a.extent().add(2*this.edge+2*this.rfBorder));a.setCenter(this.center());this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};RingReporterSlotMorph.prototype=new ReporterSlotMorph;RingReporterSlotMorph.prototype.constructor=RingReporterSlotMorph;
RingReporterSlotMorph.uber=ReporterSlotMorph.prototype;RingReporterSlotMorph.prototype.rfBorder=RingCommandSlotMorph.prototype.rfBorder;RingReporterSlotMorph.prototype.edge=RingCommandSlotMorph.prototype.edge;RingReporterSlotMorph.prototype.enableCommandDrops=!0;function RingReporterSlotMorph(a){this.init(a)}RingReporterSlotMorph.prototype.init=function(a){RingReporterSlotMorph.uber.init.call(this,a,!0);this.contrast=RingMorph.prototype.contrast};RingReporterSlotMorph.prototype.getSpec=function(){return"%rr"};
RingReporterSlotMorph.prototype.replaceInput=function(a,b,c){RingReporterSlotMorph.uber.replaceInput.call(this,a,b);this.parent instanceof RingMorph&&!c&&this.parent.vanishForSimilar()};RingReporterSlotMorph.prototype.slotAttachPoint=CommandSlotMorph.prototype.slotAttachPoint;RingReporterSlotMorph.prototype.dentLeft=CommandSlotMorph.prototype.dentLeft;RingReporterSlotMorph.prototype.dentCenter=CommandSlotMorph.prototype.dentCenter;
RingReporterSlotMorph.prototype.attachTargets=function(){return!RingReporterSlotMorph.prototype.enableCommandDrops||this.contents()instanceof ReporterBlockMorph?[]:CommandSlotMorph.prototype.attachTargets.call(this)};RingReporterSlotMorph.prototype.nestedBlock=function(a){if(a){var b=this.nestedBlock();this.replaceInput(this.children[0],a);b&&a.bottomBlock().nextBlock(b);this.fixLayout()}else return detect(this.children,function(c){return c instanceof BlockMorph})};
RingReporterSlotMorph.prototype.fixLayout=function(){this.contents()instanceof CommandBlockMorph?CommandSlotMorph.prototype.fixLayout.call(this):RingReporterSlotMorph.uber.fixLayout.call(this)};RingReporterSlotMorph.prototype.render=function(a){MorphicPreferences.isFlat||(this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),a.fillStyle=this.cachedClr,this.isPredicate?this.drawEdgesDiamond(a):this.drawEdgesOval(a))};
RingReporterSlotMorph.prototype.outlinePath=function(a,b){this.isPredicate?this.outlinePathDiamond(a,b):this.outlinePathOval(a,b)};
RingReporterSlotMorph.prototype.outlinePathOval=function(a,b){var c=b.x;b=b.y;var d=this.width(),e=this.height(),f=Math.min(this.rounding,e/2);a.arc(f+this.edge+c,f+this.edge+b,f,radians(-180),radians(-90),!1);a.arc(d-f-this.edge+c,f+this.edge+b,f,radians(-90),radians(-0),!1);a.arc(d-f-this.edge+c,e-f-this.edge+b,f,radians(0),radians(90),!1);a.arc(f+this.edge+c,e-f-this.edge+b,f,radians(90),radians(180),!1);a.lineTo(this.edge+c,f+this.edge+b)};
RingReporterSlotMorph.prototype.drawEdgesOval=function(a){var b=this.height(),c=Math.min(this.rounding,b/2),d=this.width(),e=this.edge/2;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=this.cachedClr;a.beginPath();a.arc(c,b-c,c-e,radians(90),radians(180),!1);a.stroke();a.strokeStyle=this.cachedClr;a.beginPath();a.arc(d-c,c,c-e,radians(-90),radians(0),!1);a.stroke();a.shadowOffsetX=e;a.shadowOffsetY=e;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var f=
a.createLinearGradient(0,0,0,this.edge);f.addColorStop(1,this.cachedClrDark);f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,e);a.lineTo(d-c+e,e);a.stroke();f=a.createRadialGradient(c,c,c-this.edge,c,c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(c,c,c-e,radians(180),radians(270),!1);a.stroke();f=a.createLinearGradient(0,0,this.edge,0);f.addColorStop(1,this.cachedClrDark);f.addColorStop(0,this.cachedClr);a.strokeStyle=
f;a.beginPath();a.moveTo(e,c);a.lineTo(e,b-c);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;f=a.createRadialGradient(d-c,b-c,c-this.edge,d-c,b-c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.arc(d-c,b-c,c-e,radians(0),radians(90),!1);a.stroke();f=a.createLinearGradient(0,b-this.edge,0,b);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,b-e);a.lineTo(d-c+e,
b-e);a.stroke();f=a.createLinearGradient(d-this.edge,0,d,0);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(d-e,c+e);a.lineTo(d-e,b-c);a.stroke()};
RingReporterSlotMorph.prototype.outlinePathDiamond=function(a,b){var c=b.x;b=b.y;var d=this.width(),e=this.height(),f=Math.floor(e/2),g=Math.min(this.rounding,f);a.moveTo(c+this.edge,f+b);a.lineTo(g+this.edge+c,this.edge+b);a.lineTo(d-g-this.edge+c,this.edge+b);a.lineTo(d-this.edge+c,f+b);a.lineTo(d-g-this.edge+c,e-this.edge+b);a.lineTo(g+this.edge+c,e-this.edge+b);a.lineTo(c+this.edge,f+b)};
RingReporterSlotMorph.prototype.drawEdgesDiamond=function(a){var b=this.width(),c=this.height(),d=Math.floor(c/2),e=Math.min(this.rounding,d),f=this.edge/2;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=this.cachedClr;a.beginPath();a.moveTo(f,d);a.lineTo(e,c-f);a.stroke();a.strokeStyle=this.cachedClr;a.beginPath();a.moveTo(b-f,d);a.lineTo(b-e,f);a.stroke();a.shadowOffsetX=f;a.shadowOffsetY=f;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var g=a.createLinearGradient(0,
0,e,0);g.addColorStop(1,this.cachedClrDark);g.addColorStop(0,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(f,d);a.lineTo(e,f);a.stroke();g=a.createLinearGradient(0,0,0,this.edge);g.addColorStop(1,this.cachedClrDark);g.addColorStop(0,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(e,f);a.lineTo(b-e,f);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;g=a.createLinearGradient(b-e,0,b,0);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=
g;a.beginPath();a.moveTo(b-e,c-f);a.lineTo(b-f,d);a.stroke();g=a.createLinearGradient(0,c-this.edge,0,c);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=g;a.beginPath();a.moveTo(e+f,c-f);a.lineTo(b-e-f,c-f);a.stroke()};CommentMorph.prototype=new BoxMorph;CommentMorph.prototype.constructor=CommentMorph;CommentMorph.uber=BoxMorph.prototype;
CommentMorph.prototype.refreshScale=function(){CommentMorph.prototype.fontSize=SyntaxElementMorph.prototype.fontSize;CommentMorph.prototype.padding=5*SyntaxElementMorph.prototype.scale;CommentMorph.prototype.rounding=8*SyntaxElementMorph.prototype.scale};CommentMorph.prototype.refreshScale();function CommentMorph(a){this.init(a)}
CommentMorph.prototype.init=function(a){var b=this,c=SyntaxElementMorph.prototype.scale;this.stickyOffset=this.block=null;this.isCollapsed=!1;this.titleBar=new BoxMorph(this.rounding,c,new Color(255,255,180));this.titleBar.color=new Color(255,255,180);this.titleBar.setHeight(fontHeight(this.fontSize)+this.padding);this.title=null;this.arrow=new ArrowMorph("down",this.fontSize);this.arrow.mouseClickLeft=function(){return b.toggleExpand()};this.contents=new TextMorph(a||localize("add comment here..."),
this.fontSize);this.lastValue=this.contents.text;this.contents.isEditable=!0;this.contents.enableSelecting();this.contents.maxWidth=90*c;this.contents.fixLayout();this.handle=new HandleMorph(this.contents,80,2*this.fontSize,-2,-2);this.handle.setExtent(new Point(11*c,11*c));this.anchor=null;CommentMorph.uber.init.call(this,this.rounding,c,new Color(255,255,180));this.color=new Color(255,255,220);this.isDraggable=!0;this.add(this.titleBar);this.add(this.arrow);this.add(this.contents);this.add(this.handle);
this.fixLayout()};CommentMorph.prototype.reactToEdit=function(a){a=a.text;a!==this.lastValue&&(this.contents.text=this.lastValue,this.contents.rerender(),this.contents.changed(),this.layoutChanged(),SnapActions.setCommentText(this,a))};CommentMorph.prototype.fullCopy=function(){var a=new CommentMorph(this.contents.text);a.isCollapsed=this.isCollapsed;a.setTextWidth(this.textWidth());a.id=this.id;this.selectionID&&(a.selectionID=!0);return a};
CommentMorph.prototype.setTextWidth=function(a){this.contents.maxWidth=a;this.contents.fixLayout();this.fixLayout()};CommentMorph.prototype.textWidth=function(){return this.contents.maxWidth};CommentMorph.prototype.text=function(){return this.contents.text};CommentMorph.prototype.toggleExpand=function(){this.isCollapsed=!this.isCollapsed;this.fixLayout();this.align();this.isCollapsed||this.comeToFront()};CommentMorph.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())};
CommentMorph.prototype.mouseClickLeft=function(){this.comeToFront()};CommentMorph.prototype.layoutChanged=function(){this.fixLayout();this.align();this.comeToFront()};
CommentMorph.prototype.fixLayout=function(){var a=this,b=this.contents.width()+2*this.padding;this.title&&(this.title.destroy(),this.title=null);if(this.isCollapsed){this.contents.hide();this.title=new FrameMorph;this.title.alpha=0;this.title.acceptsDrops=!1;var c=new StringMorph(this.contents.text,this.fontSize,null,!0);c.rootForGrab=function(){return a};this.title.add(c);this.title.setHeight(c.height());this.title.setWidth(b-this.arrow.width()-2*this.padding-this.rounding);this.add(this.title)}else this.contents.show();
this.titleBar.setWidth(b);this.contents.setLeft(this.titleBar.left()+this.padding);this.contents.setTop(this.titleBar.bottom()+this.padding);this.arrow.direction=this.isCollapsed?"right":"down";this.arrow.rerender();this.arrow.setCenter(this.titleBar.center());this.arrow.setLeft(this.titleBar.left()+this.padding);this.title&&this.title.setPosition(this.arrow.topRight().add(new Point(this.padding,0)));this.changed();this.bounds.setHeight(this.titleBar.height()+(this.isCollapsed?0:this.padding+this.contents.height()+
this.padding));this.bounds.setWidth(this.titleBar.width());this.rerender();this.handle.fixLayout()};
CommentMorph.prototype.userMenu=function(){var a=this,b=new MenuMorph(this);b.addItem("duplicate",function(){var c=a.fullCopy(),d=a.parentThatIsA(IDE_Morph),e=a.parentThatIsA(BlockEditorMorph),f=a.world();c.id=null;c.pickUp(f);!d&&e&&(d=e.target.parentThatIsA(IDE_Morph));d&&(f.hand.grabOrigin={origin:d.palette,position:d.palette.center()})},"make a copy\nand pick it up");b.addItem("delete",function(){this.id?SnapActions.removeBlock(this):this.destroy()});b.addItem("comment pic...",function(){var c=
a.parentThatIsA(IDE_Morph);c.saveCanvasAs(a.fullImage(),(c.projectName||localize("untitled"))+" "+localize("comment pic"))},"save a picture\nof this comment");return b};CommentMorph.prototype.userDestroy=function(){this.selectForEdit().destroy()};CommentMorph.prototype.hide=function(){this.isVisible=!1;this.changed()};CommentMorph.prototype.show=function(){this.isVisible=!0;this.changed()};
CommentMorph.prototype.prepareToBeGrabbed=function(a){this.block&&(this.block=this.block.comment=null);this.anchor&&(this.anchor.destroy(),this.anchor=null,this.removeShadow(),this.addShadow())};CommentMorph.prototype.snapTarget=function(a){return this.parent.closestBlock(this,a)};CommentMorph.prototype.selectForEdit=SyntaxElementMorph.prototype.selectForEdit;
CommentMorph.prototype.snap=function(a){if(!(this.parent instanceof ScriptsMorph))return null;null!==a&&(a.comment=this,this.block=a,this.snapSound&&this.snapSound.play());this.align()};
CommentMorph.prototype.align=function(a,b){if(this.block){var c=a||this.block.topBlock();a=c.parentThatIsA(ScriptsMorph);this.setTop(this.block.top()+this.block.corner);var d=this.top();var e=this.bottom();c=c.allChildren().filter(function(f){return f instanceof BlockMorph&&f.bottom()>d&&f.top()<e});c=Math.max.apply(null,c.map(function(f){return f.right()}));this.setLeft(c+5);!b&&a&&a.addBack(this);this.anchor||(this.anchor=new Morph,this.anchor.color=this.titleBar.color);this.anchor.setPosition(new Point(this.block.right(),
this.top()+this.edge));this.anchor.bounds.corner=new Point(this.left(),this.top()+this.edge+1);this.anchor.rerender();this.addBack(this.anchor)}};CommentMorph.prototype.startFollowing=function(a,b){var c=this;this.align(a);b.add(this);this.addShadow();this.stickyOffset=this.position().subtract(this.block.position());this.step=function(){c.block?c.setPosition(c.block.position().add(c.stickyOffset)):c.stopFollowing()}};CommentMorph.prototype.stopFollowing=function(){this.removeShadow();delete this.step};
CommentMorph.prototype.destroy=function(){this.block&&(this.block.comment=null);CommentMorph.uber.destroy.call(this)};CommentMorph.prototype.stackHeight=function(){return this.height()};ScriptFocusMorph.prototype=new BoxMorph;ScriptFocusMorph.prototype.constructor=ScriptFocusMorph;ScriptFocusMorph.uber=BoxMorph.prototype;function ScriptFocusMorph(a,b,c){this.init(a,b,c)}
ScriptFocusMorph.prototype.init=function(a,b,c){this.editor=a;this.element=b;this.atEnd=!1;ScriptFocusMorph.uber.init.call(this);this.element instanceof ScriptsMorph&&this.setPosition(c)};ScriptFocusMorph.prototype.getFocus=function(a){a||(a=this.world());a&&a.keyboardFocus!==this&&a.stopEditing();a.keyboardFocus=this;this.fixLayout();this.editor.updateToolbar()};
ScriptFocusMorph.prototype.fixLayout=function(){this.changed();this.element instanceof CommandBlockMorph||this.element instanceof CommandSlotMorph||this.element instanceof ScriptsMorph?this.manifestStatement():this.manifestExpression();this.editor.add(this);this.scrollIntoView();this.changed()};
ScriptFocusMorph.prototype.manifestStatement=function(){var a=this.element instanceof ScriptsMorph,b=this.element.top();this.edge=this.border=0;this.alpha=1;this.color=this.editor.feedbackColor;this.bounds.setExtent(new Point(a?SyntaxElementMorph.prototype.hatWidth:this.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight)));this.element instanceof CommandSlotMorph?b+=SyntaxElementMorph.prototype.corner:this.atEnd&&(b=this.element.bottom());a||
this.setPosition(new Point(this.element.left(),b));this.fps=2;this.show();this.step=function(){this.toggleVisibility()}};
ScriptFocusMorph.prototype.manifestExpression=function(){this.edge=SyntaxElementMorph.prototype.rounding;this.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.color=this.editor.feedbackColor.copy();this.color.a=.5;this.borderColor=this.editor.feedbackColor;this.bounds=this.element.fullBounds().expandBy(Math.max(2*SyntaxElementMorph.prototype.edge,SyntaxElementMorph.prototype.reporterDropFeedbackPadding));this.rerender();delete this.fps;delete this.step;this.show()};
ScriptFocusMorph.prototype.trigger=function(){var a=this.element,b=this;if(a instanceof MultiArgMorph)a.arrows().children[1].isVisible&&SnapActions.addListInput(a).then(function(){b.fixLayout()});else if(a.parent instanceof TemplateSlotMorph)a.mouseClickLeft();else if(a instanceof BooleanSlotMorph)SnapActions.toggleBoolean(a,a.value);else if(a instanceof InputSlotMorph){var c=a.updateFieldValue;a.updateFieldValue=function(){var d=c.apply(this,arguments);d&&d.then(function(){b.fixLayout()});this.updateFieldValue=
c};a.isReadOnly?a.choices&&(a.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):(delete this.fps,delete this.step,this.hide(),this.world().onNextStep=function(){a.contents().edit();a.contents().selectAll()})}};ScriptFocusMorph.prototype.menu=function(){var a=this.element;a instanceof InputSlotMorph&&a.choices?(a.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):this.insertVariableGetter()};
ScriptFocusMorph.prototype.deleteLastElement=function(){var a=this.element,b=this,c;if(a.parent instanceof ScriptsMorph){if(this.atEnd||a instanceof ReporterBlockMorph){SnapActions.removeBlock(a).then(function(){b.element=b.editor;b.atEnd=!1;b.editor.adjustBounds();b.fixLayout()});return}}else if(a instanceof MultiArgMorph)a.arrows().children[0].isVisible&&(c=SnapActions.removeListInput(a));else if(a instanceof BooleanSlotMorph)a.isStatic||(c=SnapActions.toggleBoolean(a,!1));else if(a instanceof ReporterBlockMorph){if(!a.isTemplate){SnapActions.removeBlock(a).then(function(){b.lastElement();
b.editor.adjustBounds();b.fixLayout()});return}}else if(a instanceof CommandBlockMorph){if(this.atEnd){var d=a.parent;SnapActions.removeBlock(a,!0).then(function(){b.element=d;b.editor.adjustBounds();b.fixLayout()});return}a.parent instanceof CommandBlockMorph&&(c=SnapActions.removeBlock(a.parent,!0))}c&&c.then(function(){b.editor.adjustBounds();b.fixLayout()})};
ScriptFocusMorph.prototype.insertBlock=ScriptFocusMorph.prototype.fillInBlock=function(a){var b=this,c,d,e;a.isTemplate=!1;a.isDraggable=!0;if(this.element instanceof ScriptsMorph){if(a instanceof CommandBlockMorph)if(a.isStop())var f=this.topLeft();else{f=new Point(this.left(),this.top()-a.height());var g=!0}else f=new Point(this.left(),this.center().y+a.height()/2);a=SnapActions.addBlock(a,this.editor.scriptTarget(),f)}else if(this.element instanceof CommandBlockMorph){if(this.atEnd)var h={point:this.element.bottomAttachPoint(),
element:this.element,loc:"bottom",type:"block"};else f=this.element.parent,f instanceof ScriptsMorph?h={point:this.element.topAttachPoint(),element:this.element,loc:"top",type:"block"}:f instanceof CommandSlotMorph?f.nestedBlock(a):f instanceof RingReporterSlotMorph?(a.nextBlock(f.nestedBlock()),f.add(a),f.fixLayout()):f instanceof CommandBlockMorph&&(h={point:f.bottomAttachPoint(),element:f,loc:"bottom",type:"block"});a=SnapActions.moveBlock(a,h)}else this.element instanceof CommandSlotMorph?(h=
{point:this.element.slotAttachPoint(),element:this.element,loc:"bottom",type:"slot"},g=!0,a=SnapActions.moveBlock(a,h)):(f=this.element.parent,f instanceof ScriptsMorph?a=SnapActions.replaceBlock(this.element,a):(g=!0,a=SnapActions.moveBlock(a,this.element)));a.then(function(k){g&&(b.atEnd=!0);"receiveCondition"===k.selector&&(e=b.editor.scriptTarget())&&(c=e.parentThatIsA(StageMorph))&&(c.enableCustomHatBlocks=!0,c.threads.pauseCustomHatBlocks=!1,(d=c.parentThatIsA(IDE_Morph))&&d.controlBar.stopButton.refresh());
b.element=k;b.fixLayout();k.inputs&&k.inputs().length&&(b.element=k,b.atEnd=!1,b.nextElement())})};
ScriptFocusMorph.prototype.insertVariableGetter=function(){var a=this,b=this.blockTypes(),c=new MenuMorph;b&&contains(b,"reporter")&&(b=InputSlotMorph.prototype.getVarNamesDict.call(this.element),Object.keys(b).forEach(function(d){var e=SpriteMorph.prototype.variableBlock(d);e.addShadow(new Point(3,3));c.addItem(e,function(){e.removeShadow();a.insertBlock(e)})}),0<c.items.length&&(c.popup(this.world(),this.element.bottomLeft()),c.getFocus()))};
ScriptFocusMorph.prototype.stopEditing=function(){this.editor.focus=null;this.editor.updateToolbar();this.world().keyboardFocus=null;this.destroy()};
ScriptFocusMorph.prototype.lastElement=function(){var a=this.items();if(a.length){if(this.atEnd)this.element=a[a.length-1],this.atEnd=!1;else{var b=a.indexOf(this.element)-1;0>b&&(b=a.length-1);this.element=a[b]}this.element instanceof CommandSlotMorph&&this.element.nestedBlock()?this.lastElement():this.element instanceof HatBlockMorph&&(1<a.length?this.lastElement():this.atEnd=!0);this.fixLayout()}else this.shiftScript(new Point(-50,0))};
ScriptFocusMorph.prototype.nextElement=function(){var a=this.items();if(a.length){var b=a.indexOf(this.element)+1;b>=a.length&&(b=0);this.atEnd=!1;this.element=a[b];if(this.element instanceof CommandSlotMorph){if(a=this.element.nestedBlock())this.element=a}else this.element instanceof HatBlockMorph&&(1===a.length?this.atEnd=!0:this.nextElement());this.fixLayout()}else this.shiftScript(new Point(50,0))};
ScriptFocusMorph.prototype.lastCommand=function(){var a=this.element.parentThatIsA(CommandBlockMorph),b;if(a){if(this.element instanceof CommandBlockMorph)if(this.atEnd)this.atEnd=!1;else if(b=a.parent.parentThatIsA(CommandBlockMorph))this.element=b;else{if(b=a.topBlock().bottomBlock())this.element=b,this.atEnd=!0}else this.element=a,this.atEnd=!1;this.element instanceof HatBlockMorph&&!this.atEnd&&this.lastCommand();this.fixLayout()}else this.element instanceof ScriptsMorph&&this.shiftScript(new Point(0,
-50))};
ScriptFocusMorph.prototype.nextCommand=function(){var a=this.element,b;if(a instanceof ScriptsMorph)this.shiftScript(new Point(0,50));else{for(;!(a instanceof CommandBlockMorph);)if(a=a.parent,a instanceof ScriptsMorph)return;if(this.atEnd)if(b=a.parentThatIsA(CommandSlotMorph))this.element=b.parentThatIsA(CommandBlockMorph),this.atEnd=!1,this.nextCommand();else{if(a=a.topBlock().parentThatIsA(CommandBlockMorph))this.element=a,this.atEnd=!1,this.element instanceof HatBlockMorph&&this.nextCommand()}else(b=a.nextBlock())?
this.element=b:(this.element=a,this.atEnd=!0);this.fixLayout()}};ScriptFocusMorph.prototype.nextScript=function(){var a=this.sortedScripts();if(!(1>a.length)){this.element instanceof ScriptsMorph&&(this.element=a[0]);var b=a.indexOf(this.element.topBlock())+1;b>=a.length&&(b=0);this.element=a[b];this.element.scrollIntoView();this.atEnd=!1;if(this.element instanceof HatBlockMorph)return this.nextElement();this.fixLayout()}};
ScriptFocusMorph.prototype.lastScript=function(){var a=this.sortedScripts();if(!(1>a.length)){this.element instanceof ScriptsMorph&&(this.element=a[0]);var b=a.indexOf(this.element.topBlock())-1;0>b&&(b=a.length-1);this.element=a[b];this.element.scrollIntoView();this.atEnd=!1;if(this.element instanceof HatBlockMorph)return this.nextElement();this.fixLayout()}};
ScriptFocusMorph.prototype.shiftScript=function(a){var b=this,c;this.element instanceof ScriptsMorph?(this.moveBy(a),this.editor.adjustBounds(),this.fixLayout()):!(c=this.element.topBlock())||c instanceof PrototypeHatBlockMorph||(a=c.topLeft().add(a),SnapActions.setBlockPosition(c,a).then(function(){b.editor.adjustBounds();b.fixLayout()}))};
ScriptFocusMorph.prototype.newScript=function(){var a=this.position();this.element instanceof ScriptsMorph||(a=this.element.topBlock().fullBounds().bottomLeft().add(new Point(0,50)));this.setPosition(a);this.element=this.editor;this.editor.adjustBounds();this.fixLayout()};ScriptFocusMorph.prototype.runScript=function(){this.element instanceof ScriptsMorph||this.element.topBlock().mouseClickLeft()};
ScriptFocusMorph.prototype.items=function(){return this.element instanceof ScriptsMorph?[]:this.element.topBlock().allChildren().filter(function(a){return a instanceof SyntaxElementMorph&&!(a instanceof TemplateSlotMorph)&&(!a.isStatic||a.choices||a instanceof BooleanSlotMorph||a instanceof RingMorph||a instanceof MultiArgMorph||a instanceof CommandSlotMorph)})};
ScriptFocusMorph.prototype.sortedScripts=function(){var a=this.editor.children.filter(function(b){return b instanceof BlockMorph});a.sort(function(b,c){return b instanceof PrototypeHatBlockMorph?0:b.top()-c.top()});return a};
ScriptFocusMorph.prototype.blockTypes=function(){return this.element.isTemplate?null:this.element instanceof ScriptsMorph?["hat","command","reporter","predicate","ring"]:this.element instanceof HatBlockMorph||this.element instanceof CommandSlotMorph?["command"]:this.element instanceof CommandBlockMorph?this.atEnd&&this.element.isStop()?null:this.element.parent instanceof ScriptsMorph?["hat","command"]:["command"]:this.element instanceof ReporterBlockMorph?"%n"===this.element.getSlotSpec()?["reporter"]:
["reporter","predicate","ring"]:"%n"===this.element.getSpec()?["reporter"]:this.element.isStatic?null:["reporter","predicate","ring"]};ScriptFocusMorph.prototype.processKeyDown=function(a){this.processKeyEvent(a,this.reactToKeyEvent)};ScriptFocusMorph.prototype.processKeyUp=function(a){nop(a)};ScriptFocusMorph.prototype.processKeyPress=function(a){nop(a)};
ScriptFocusMorph.prototype.processKeyEvent=function(a,b){this.world().hand.destroyTemporaries();switch(a.keyCode){case 8:var c="backspace";break;case 9:c="tab";break;case 13:c="enter";break;case 16:case 17:case 18:return;case 27:c="esc";break;case 32:c="space";break;case 37:c="left arrow";break;case 39:c="right arrow";break;case 38:c="up arrow";break;case 40:c="down arrow";break;default:c=String.fromCharCode(a.keyCode||a.charCode)}b.call(this,(a.ctrlKey||a.metaKey?"ctrl ":"")+(a.shiftKey?"shift ":
"")+c)};
ScriptFocusMorph.prototype.reactToKeyEvent=function(a){var b;switch(a.toLowerCase()){case "esc":return this.stopEditing();case "enter":return this.trigger();case "shift enter":return this.newScript();case "ctrl shift enter":return this.runScript();case "space":return this.menu();case "left arrow":return this.lastElement();case "shift left arrow":return this.shiftScript(new Point(-50,0));case "right arrow":return this.nextElement();case "shift right arrow":return this.shiftScript(new Point(50,0));
case "up arrow":return this.lastCommand();case "shift up arrow":return this.shiftScript(new Point(0,-50));case "down arrow":return this.nextCommand();case "shift down arrow":return this.shiftScript(new Point(0,50));case "tab":return this.nextScript();case "shift tab":return this.lastScript();case "backspace":return this.deleteLastElement();case "ctrl z":return SnapUndo.undo(this.editor.owner);case "ctrl y":case "ctrl shift z":return SnapUndo.redo(this.editor.owner);case "ctrl [":break;default:var c=
this.blockTypes();this.element instanceof ScriptsMorph||!c||!contains(c,"reporter")||(b=Object.keys(this.element.getVarNamesDict()));c&&(delete this.fps,delete this.step,this.show(),this.editor.scriptTarget().searchBlocks(a,c,b,this))}};function sortDict(a){for(var b=Object.keys(a).sort(),c={},d=0;d<b.length;d++)a[b[d]]instanceof Object&&!Array.isArray(a[b[d]])?c[b[d]]=sortDict(a[b[d]]):c[b[d]]=a[b[d]];return c}BlockMorph.prototype._showHelp=BlockMorph.prototype.showHelp;
BlockMorph.prototype.showHelp=function(){var a=this,b,c,d,e,f,g,h,k,l,m,n,q,p,t,r,u;return $jscomp.asyncExecutePromiseGeneratorProgram(function(v){switch(v.nextAddress){case 1:if(!a.isServiceBlock())return v.return(a._showHelp());b=a;f=a.inputs();g=f[0].evaluate();h=f[1].evaluate()[0];k=!!f[0].constant;return""!==g?k?v.yield(Services.getServiceMetadataFromURL(g),8):v.yield(Services.getServiceMetadata(g),7):v.yield(Services.getServicesMetadata(),4);case 4:m=v.yieldResult;l=m.slice(0,3).map(function(w){return w.name});
c="Get information from different providers, save information and more. \nTo get more help select one of the services: "+l.join(", ")+" ...";v.jumpTo(3);break;case 7:n=v.yieldResult;v.jumpTo(6);break;case 8:n=v.yieldResult;case 6:m=n;if(""!==h){m=m.rpcs[h];c=m.description;q=$jscomp.makeIterator(m.args.filter(function(w){return w.description}));for(p=q.next();!p.done;p=q.next())t=p.value,r=t.optional?"[optional]":"",c+="\n"+t.name+": "+t.description+" "+r;u=m.categories&&m.categories.length?m.categories[0]:
"index";c+="\n\nDocumentation can be found at:\n"+SERVER_URL+"/docs/services/"+g+"/"+u+".html#"+g+"."+h}else c=m.description,c+="\n\nDocumentation can be found at:\n"+SERVER_URL+"/docs/services/"+g+"/index.html";c||(c="Description not available");case 3:d=a.fullCopy(),d instanceof CommandBlockMorph&&(e=d.nextBlock())&&e.destroy(),d.inputs().slice(2).forEach(function(w){w instanceof HintInputSlotMorph?w.setContents(""):w.userDestroy()}),d.addShadow(),(new DialogBoxMorph).inform("Help",c,b.world(),
d.fullImage()),v.jumpToEnd()}})};BlockMorph.prototype.isServiceBlock=function(){return contains(["getJSFromRPCStruct","doRunRPC"],this.selector)};MultiHintArgMorph.prototype=new MultiArgMorph;MultiHintArgMorph.prototype.constructor=MultiHintArgMorph;MultiHintArgMorph.uber=MultiArgMorph.prototype;MultiHintArgMorph.prototype.executeOnSliderEdit=!1;function MultiHintArgMorph(a,b,c,d,e,f,g,h,k){this.init(a,b,c,d,e,f,g,h,k)}
MultiHintArgMorph.prototype.init=function(a,b,c,d,e,f,g,h,k){this.hintText=a||"";MultiHintArgMorph.uber.init.call(this,"%s",b,c,d,e,f,g,h,k);0===this.inputs().length&&this.addInput()};MultiHintArgMorph.prototype.addInput=function(){var a=this.labelPart("%hint"+this.hintText),b=this.children.length-1;a.parent=this;this.children.splice(b,0,a);a.rerender();this.fixLayout()};StructInputSlotMorph.prototype=new InputSlotMorph;StructInputSlotMorph.prototype.constructor=StructInputSlotMorph;
StructInputSlotMorph.uber=InputSlotMorph.prototype;StructInputSlotMorph.prototype.executeOnSliderEdit=!1;function StructInputSlotMorph(a,b,c,d,e){this.fields=[];this.fieldContent=[];this.getFieldNames="string"===typeof d?this[d]:d||nop;InputSlotMorph.call(this,a,b,c,e);this.isStatic=!0}StructInputSlotMorph.prototype.evaluate=function(){return[StructInputSlotMorph.uber.evaluate.call(this),this.fields]};
StructInputSlotMorph.prototype.setContents=function(a,b){b=b||[];InputSlotMorph.prototype.setContents.call(this,a);if(this.parent){var c=this.parent.children,d=c.indexOf(this),e=this.fields.length+d+1;c=c[--e];var f=[],g=this.parentThatIsA(ScriptsMorph),h=this.parent.inputs(),k=h.indexOf(this);for(e=0;e<this.fieldContent.length;e++)c=h[k+1+e],f.push(c),this.parent.removeChild(c),this.parent.removeChild(this.fieldContent[e]);this.fields=this.getFieldNames(a);this.fields||(this.fields=b.map(function(){return"???"}));
g&&f.filter(function(l){return l instanceof BlockMorph}).forEach(g.add.bind(g));this.fieldContent=[];for(e=0;e<this.fields.length;e++)a=d+e+1,c=this.getFieldValue(this.fields[e],b[e]),this.parent.children.splice(a,0,c),c.parent=this.parent,c.rerender(),this.fieldContent.push(c);h=this.parent.inputs();for(e=this.fields.length;e<b.length&&e<h.length;e++)h[e].setContents(b[e]);this.fixLayout();this.rerender();this.parent.cachedInputs=null;this.parent.fixLayout();this.parent.changed()}};
StructInputSlotMorph.prototype.getFieldValue=function(a,b){return b&&"string"!==typeof b?b:new HintInputSlotMorph(b||"",a)};
InputSlotMorph.prototype.serviceNames=function(){var a,b,c,d,e,f,g,h,k,l;return $jscomp.asyncExecutePromiseGeneratorProgram(function(m){if(1==m.nextAddress)return m.yield(Services.getServicesMetadata(),2);a=m.yieldResult;c={};for(g=a.length;g--;)if(f=a[g].name,h=a[g].url,a[g].categories.length)for(k=a[g].categories.length;k--;){d=a[g].categories[k];e=c;for(l=0;l<d.length;l++)e[d[l]]||(e[d[l]]={}),e=e[d[l]];e[f]=h?[h+"/"+f]:f}else c[f]=h?[h+"/"+f]:f;c=sortDict(c);if(b=SnapCloud.username&&c.Community&&
c.Community[SnapCloud.username])e={},e[SnapCloud.username]=c.Community[SnapCloud.username],Object.keys(c.Community).forEach(function(n){n!==SnapCloud.username&&(e[n]=c.Community[n])}),c.Community=e;return m.return(c)})};RPCInputSlotMorph.prototype=new StructInputSlotMorph;RPCInputSlotMorph.prototype.constructor=RPCInputSlotMorph;RPCInputSlotMorph.uber=StructInputSlotMorph.prototype;
function RPCInputSlotMorph(){StructInputSlotMorph.call(this,null,!1,"methodSignature",function(a){if(!this.fieldsFor||!this.fieldsFor[a])if(this.methodSignature(),!this.fieldsFor){this.fieldsFor={};var b='Service "'+this.getServiceName()+'" is not available';world.children[0].showMessage&&world.children[0].showMessage(b)}if(this.fieldsFor[a])return this.fieldsFor[a].args.map(function(c){return c.name})},!0)}
RPCInputSlotMorph.prototype.getServiceInputSlot=function(){var a=this.parent.inputs();var b=a.indexOf(this);return a[b-1]};RPCInputSlotMorph.prototype.getServiceName=function(){var a=this.getServiceInputSlot();return a?a.constant?$jscomp.makeIterator(a.evaluate()).next().value.split("/").pop():a.evaluate():null};RPCInputSlotMorph.prototype.getServiceMetadata=function(){var a=this.getServiceInputSlot();a=a.constant?a.evaluate()[0]:Services.defaultHost.url+"/"+a.evaluate();return Services.getServiceMetadataFromURLSync(a)};
RPCInputSlotMorph.prototype.methodSignature=function(){function a(g,h){h.reduce(function(k,l){k[l]||(k[l]={});return k[l]},c)[g]=g}var b=this,c={},d=this.getServiceName();if(d){try{var e=this.getServiceMetadata();this.fieldsFor=e.rpcs;var f=Object.keys(this.fieldsFor);this.isCurrentRPCSupported=!0}catch(g){this.isCurrentRPCSupported=!1,f=this.parentThatIsA(BlockMorph),f.showBubble(localize('Service "'+d+'" is not available')),f=[]}f.forEach(function(g){var h=b.fieldsFor[g],k=void 0===h.categories?
[]:h.categories;h.deprecated||(k.length?k.forEach(function(l){return a(g,l)}):a(g,[]))})}return sortDict(c)};RPCInputSlotMorph.prototype.evaluate=function(){if(!this.isCurrentRPCSupported){var a=InputSlotMorph.prototype.evaluate.call(this);a=this.getFieldNames(a);this.isCurrentRPCSupported&&(this.fields=a)}return RPCInputSlotMorph.uber.evaluate.call(this)};HintInputSlotMorph.prototype=new InputSlotMorph;HintInputSlotMorph.prototype.constructor=HintInputSlotMorph;HintInputSlotMorph.uber=InputSlotMorph.prototype;
function HintInputSlotMorph(a,b,c){var d=this;this.hintText=b;this.empty=!0;InputSlotMorph.call(this,a,c);this.contents().mouseClickLeft=function(){d.isEmptySlot()&&(this.text="");StringMorph.prototype.mouseClickLeft.apply(this,arguments)}}HintInputSlotMorph.prototype.evaluate=function(){return this.isEmptySlot()?this.isNumeric?0:"":InputSlotMorph.prototype.evaluate.call(this)};
HintInputSlotMorph.prototype.setContents=function(a){var b=BLACK,c=this.contents();InputSlotMorph.prototype.setContents.apply(this,arguments);this.empty=""===a;this.isEmptySlot()&&(c.text=this.hintText,b=new Color(100,100,100));c.fixLayout();c.color=b;c.rerender()};HintInputSlotMorph.prototype.changed=function(){var a=this.contents();a&&(this.empty=a.text===this.hintText);return InputSlotMorph.prototype.changed.call(this)};HintInputSlotMorph.prototype.isEmptySlot=function(){return this.empty};
var addStructReplaceSupport=function(a){return function(b){for(var c,d=-1,e=this.inputs(),f=e.indexOf(b),g=e.length;g--;)e[g]instanceof StructInputSlotMorph&&(d=g,c=e[g]);c&&d<f&&c.fields.length>=f-d?(c=c.getFieldValue(c.fields[f-d-1]),this.replaceInput(b,c),this.cachedInputs=null):a.apply(this,arguments)}};ReporterBlockMorph.prototype.revertToDefaultInput=addStructReplaceSupport(ReporterBlockMorph.prototype.revertToDefaultInput);CommandBlockMorph.prototype.revertToDefaultInput=addStructReplaceSupport(CommandBlockMorph.prototype.revertToDefaultInput);
modules.threads="2020-August-05";var NONNUMBERS=[!0,!1,""];(function(){for(var a=9;13>=a;a+=1)NONNUMBERS.push(String.fromCharCode(a));NONNUMBERS.push(String.fromCharCode(160))})();
function snapEquals(a,b){if(a instanceof List||b instanceof List)return a instanceof List&&b instanceof List?a.equalTo(b):!1;var c=+a,d=+b;if(isNaN(c)||isNaN(d)||[a,b].some(function(e){return contains(NONNUMBERS,e)||isString(e)&&-1<e.indexOf(" ")}))c=a,d=b;return isString(c)&&isString(d)?c.toLowerCase()===d.toLowerCase():c===d}
function invoke(a,b,c,d,e,f,g,h){var k=new Process;d=d?Date.now()+d:null;if(a instanceof Context)c&&(a=k.reportContextFor(c)),k.initializeFor(a,b||new List);else if(a instanceof BlockMorph){k.topBlock=a;if(c)k.homeContext=new Context,k.homeContext.receiver=c,c.variables&&(k.homeContext.variables.parentFrame=c.variables);else throw Error("expecting a receiver but getting "+c);k.context=new Context(null,a.blockSequence(),k.homeContext)}else{if(a.evaluate)return a.evaluate();if(a instanceof Function)return a.apply(c,
b.asArray().concat(g));throw Error("expecting a block or ring but getting "+a);}f&&(k.isCatchingErrors=!1);for(;k.isRunning();){if(d&&Date.now()>d)throw Error(localize(e||"a synchronous Snap! script has timed out"));k.runStep(d)}return h?k.homeContext:k.homeContext.inputs[0]}function ThreadManager(){this.processes=[];this.wantsToPause=!1}ThreadManager.prototype.pauseCustomHatBlocks=!1;
ThreadManager.prototype.toggleProcess=function(a,b){var c=this.findProcess(a,b);if(c)c.stop();else return this.startProcess(a,b,null,null,null,!0)};
ThreadManager.prototype.startProcess=function(a,b,c,d,e,f,g,h,k){a=a.topBlock();var l=this.findProcess(a,b);if(l){if(c)return l;l.stop();l.canBroadcast=!0;this.removeTerminatedProcesses()}var m=new Process(a,b,e,f);m.exportResult=d;m.isClicked=f||!1;m.isAtomic=h||!1;k instanceof VariableFrame&&Object.keys(k.vars).forEach(function(n){return m.context.outerContext.variables.vars[n]=k.vars[n]});(b=a.getHighlight())?(b.threadCount=this.processesForBlock(a).length+1,b.updateReadout()):a.addHighlight();
this.processes.push(m);g&&m.runStep();return m};ThreadManager.prototype.stopAll=function(a){this.processes.forEach(function(b){b!==a&&b.stop()})};ThreadManager.prototype.stopAllForReceiver=function(a,b){this.processes.forEach(function(c){c.homeContext.receiver===a&&c!==b&&(c.stop(),a.isTemporary&&(c.isDead=!0))})};ThreadManager.prototype.stopAllForBlock=function(a){this.processesForBlock(a,!0).forEach(function(b){return b.stop()})};
ThreadManager.prototype.stopProcess=function(a,b){(a=this.findProcess(a,b))&&a.stop()};ThreadManager.prototype.pauseAll=function(a){this.processes.forEach(function(b){return b.pause()});a&&a.pauseAllActiveSounds()};ThreadManager.prototype.isPaused=function(){return null!==detect(this.processes,function(a){return a.isPaused})};ThreadManager.prototype.resumeAll=function(a){this.processes.forEach(function(b){return b.resume()});a&&a.resumeAllActiveSounds()};
ThreadManager.prototype.step=function(){var a;if(Process.prototype.enableSingleStepping&&(this.processes.forEach(function(b){b.isInterrupted?(b.runStep(),a=!0):b.lastYield=Date.now()}),this.wantsToPause=.5<Process.prototype.flashTime,a)){this.wantsToPause&&this.pauseAll();return}this.processes.forEach(function(b){b.homeContext.receiver.isPickedUp()||b.isDead||b.runStep()});this.removeTerminatedProcesses()};
ThreadManager.prototype.removeTerminatedProcesses=function(){var a=this,b=[],c;this.processes.forEach(function(d){if(!d.isRunning()&&!d.errorFlag||d.isDead){if(d.topBlock instanceof BlockMorph)if(d.unflash(),c=a.processesForBlock(d.topBlock).length){var e=d.topBlock.getHighlight()||d.topBlock.addHighlight();e.threadCount=c;e.updateReadout()}else d.topBlock.removeHighlight();d.prompter&&(d.prompter.destroy(),d.homeContext.receiver.stopTalking&&d.homeContext.receiver.stopTalking());if(d.topBlock instanceof
ReporterBlockMorph||d.isShowingResult)if(e=d.homeContext.inputs[0],d.onComplete instanceof Function)d.onComplete(e);else e instanceof List?d.topBlock.showBubble(e.isTable()?new TableFrameMorph(new TableMorph(e,10)):new ListWatcherMorph(e),d.exportResult,d.receiver):d.topBlock.showBubble(e,d.exportResult,d.receiver);else if(d.onComplete instanceof Function)d.onComplete()}else b.push(d)});this.processes=b};
ThreadManager.prototype.findProcess=function(a,b){var c=a.topBlock();return detect(this.processes,function(d){return d.topBlock===c&&d.receiver===b})};ThreadManager.prototype.processesForBlock=function(a,b){var c=b?a:a.topBlock();return this.processes.filter(function(d){return d.topBlock===c&&d.isRunning()&&!d.isDead})};
ThreadManager.prototype.doWhen=function(a,b,c){if(!this.pauseCustomHatBlocks&&a&&!this.findProcess(a,b)){var d=a.inputs()[0],e;a.removeHighlight()&&(e=a.world())&&e.hand.destroyTemporaries();if(!c){try{var f=invoke(d,null,b,50,"the predicate takes\ntoo long for a\ncustom hat block",!0,null,!0)}catch(g){a.addErrorHighlight(),a.showBubble(g.name+"\n"+g.message)}(!0===f||f&&f.inputs&&!0===f.inputs[0])&&this.startProcess(a,b,null,null,null,null,!0,null,f.variables)}}};
ThreadManager.prototype.toggleSingleStepping=function(){Process.prototype.enableSingleStepping=!Process.prototype.enableSingleStepping;Process.prototype.enableSingleStepping||this.processes.forEach(function(a){a.isPaused||a.unflash()})};Process.prototype={};Process.prototype.constructor=Process;Process.prototype.timeout=500;Process.prototype.isCatchingErrors=!0;Process.prototype.enableHyperOps=!0;Process.prototype.enableLiveCoding=!1;Process.prototype.enableSingleStepping=!1;
Process.prototype.enableCompiling=!1;Process.prototype.flashTime=0;
function Process(a,b,c,d){this.topBlock=a||null;this.instrument=(this.receiver=b||(a?a.scriptTarget():null))?this.receiver.instrument:null;this.errorFlag=this.isShowingResult=this.isClicked=this.isDead=this.readyToTerminate=this.readyToYield=!1;this.context=null;this.homeContext=new Context(null,null,null,this.receiver);this.lastYield=Date.now();this.isFirstStep=!0;this.isAtomic=!1;this.rpcRequest=this.httpRequest=this.prompter=null;this.isPaused=!1;this.pauseOffset=null;this.frameCount=0;this.exportResult=
!1;this.onComplete=c||null;this.procedureCount=0;this.flashingContext=null;this.isInterrupted=!1;this.canBroadcast=!0;a&&(this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,a.blockSequence(),this.homeContext),d&&this.pushContext("doYield"))}Process.prototype.isRunning=function(){return!this.readyToTerminate&&(this.context||this.isPaused)};
Process.prototype.runStep=function(a){if(this.isPaused)return this.pauseStep();for(this.isInterrupted=this.readyToYield=!1;!this.readyToYield&&!this.isInterrupted&&this.context&&Date.now()-this.lastYield<this.timeout;){if(this.isPaused)return this.pauseStep();if(a&&Date.now()>a){this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp();return}this.evaluateContext()}this.lastYield=Date.now();this.isFirstStep=!1;this.isAtomic&&this.homeContext.receiver&&
this.homeContext.receiver.endWarp&&(this.homeContext.receiver.endWarp(),this.homeContext.receiver.startWarp());if(this.readyToTerminate){for(;this.context;)this.popContext();this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()}};Process.prototype.stop=function(){this.readyToTerminate=this.readyToYield=!0;this.errorFlag=!1;this.context&&this.context.stopMusic();this.canBroadcast=!1};
Process.prototype.pause=function(){this.readyToTerminate||(this.isPaused=!0,this.flashPausedContext(),this.context&&this.context.startTime&&(this.pauseOffset=Date.now()-this.context.startTime))};Process.prototype.resume=function(){this.enableSingleStepping||this.unflash();this.isPaused=!1;this.pauseOffset=null};Process.prototype.pauseStep=function(){this.lastYield=Date.now();this.context&&this.context.startTime&&(this.context.startTime=this.lastYield-this.pauseOffset)};
Process.prototype.evaluateContext=function(){var a=this.context.expression;this.frameCount+=1;"exit"===this.context.tag&&this.expectReport();if(a instanceof Array)return this.evaluateSequence(a);if(a instanceof MultiArgMorph)return this.evaluateMultiSlot(a,a.inputs().length);if(a instanceof ArgLabelMorph)return this.evaluateArgLabel(a);if(a instanceof ArgMorph||a.bindingID)return this.evaluateInput(a);if(a instanceof BlockMorph)return this.evaluateBlock(a,a.inputs().length);if(isString(a))return this[a].apply(this,
this.context.inputs);a instanceof Variable&&this.returnValueToParentContext(a.value);this.popContext()};
Process.prototype.evaluateBlock=function(a,b){var c=a.selector;if("reportOr"===c||"reportAnd"===c||"reportIfElse"===c||"doReport"===c)if(this.isCatchingErrors)try{return this[c](a)}catch(f){this.handleError(f,a)}else return this[c](a);var d=this.context.receiver||this.receiver;var e=this.context.inputs;if(b>e.length)this.evaluateNextInput(a);else if(!this.flashContext())if(this[c]&&(d=this),this.isCatchingErrors)try{this.returnValueToParentContext(d[c].apply(d,e)),this.popContext()}catch(f){this.handleError(f,
a)}else this.returnValueToParentContext(d[c].apply(d,e)),this.popContext()};Process.prototype.reportOr=function(a){var b=this.context.inputs;1>b.length?this.evaluateNextInput(a):1===b.length?b[0]?this.flashContext()||(this.returnValueToParentContext(!0),this.popContext()):this.evaluateNextInput(a):this.flashContext()||(this.returnValueToParentContext(!0===b[1]),this.popContext())};
Process.prototype.reportAnd=function(a){var b=this.context.inputs;1>b.length?this.evaluateNextInput(a):1===b.length?b[0]?this.evaluateNextInput(a):this.flashContext()||(this.returnValueToParentContext(!1),this.popContext()):this.flashContext()||(this.returnValueToParentContext(!0===b[1]),this.popContext())};
Process.prototype.doReport=function(a){var b=this.context.outerContext;if(!this.flashContext()){this.isClicked&&a.topBlock()===this.topBlock&&(this.isShowingResult=!0);if(a.partOfCustomCommand)this.doStopCustomBlock(),this.popContext();else{for(;this.context&&"exit"!==this.context.tag;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.context&&("expectReport"===this.context.expression?this.popContext():this.context.tag=null)}this.pushContext(a.inputs()[0],b);this.context.isCustomCommand=
a.partOfCustomCommand}};Process.prototype.evaluateMultiSlot=function(a,b){var c=this.context.inputs;if(a.bindingID){if(this.isCatchingErrors)try{var d=this.context.variables.getVar(a.bindingID)}catch(e){this.handleError(e,a)}else d=this.context.variables.getVar(a.bindingID);this.returnValueToParentContext(d);this.popContext()}else b>c.length?this.evaluateNextInput(a):(this.returnValueToParentContext(new List(c)),this.popContext())};
Process.prototype.evaluateArgLabel=function(a){var b=this.context.inputs;1>b.length?this.evaluateNextInput(a):(this.returnValueToParentContext(b[0]),this.popContext())};
Process.prototype.evaluateInput=function(a){if(!this.flashContext()){if(a.bindingID)if(this.isCatchingErrors)try{var b=this.context.variables.getVar(a.bindingID)}catch(c){this.handleError(c,a)}else b=this.context.variables.getVar(a.bindingID);else(b=a.evaluate())&&(a.constructor===CommandSlotMorph||a.constructor===ReporterSlotMorph||a instanceof CSlotMorph&&(!a.isStatic||a.isLambda))&&(b=this.reify(b,new List));this.returnValueToParentContext(b);this.popContext()}};
Process.prototype.evaluateSequence=function(a){var b=this.context.pc,c=this.context.outerContext,d=this.context.isCustomBlock;b===a.length-1?(this.context=new Context(this.context.parentContext,a[b],this.context.outerContext,this.context.receiver),this.context.isCustomBlock=d):b>=a.length?this.popContext():(this.context.pc+=1,this.pushContext(a[b],c))};
Process.prototype.evaluateNextInput=function(a){var b=this.context.inputs.length;a=a.inputs()[b];b=this.context.expression.selector;var c=this.context.outerContext;a.isUnevaluated?!0===a.isUnevaluated||a.isUnevaluated()?"reify"===b||"reportScript"===b?this.context.addInput(a):this.context.addInput(this.reify(a,new List)):this.pushContext(a,c):this.pushContext(a,c)};Process.prototype.doYield=function(){this.popContext();this.isAtomic||(this.readyToYield=!0)};Process.prototype.expectReport=function(){this.handleError(Error("reporter didn't report"))};
Process.prototype.handleError=function(a,b){var c=b;this.stop();this.errorFlag=!0;this.topBlock.addErrorHighlight();if(isNil(c)||isNil(c.world()))c=this.topBlock;c.showBubble((c===b?"":"Inside: ")+a.name+"\n"+a.message,this.exportResult,this.receiver)};Process.prototype.errorObsolete=function(){throw Error("a custom block definition is missing");};
Process.prototype.reify=function(a,b,c){var d=new Context(null,null,this.context?this.context.outerContext:null),e=0;a?(d.expression=this.enableLiveCoding||this.enableSingleStepping?a:a.fullCopy(),d.expression.show(),c||b.length()||(d.expression.allEmptySlots().forEach(function(f){e+=1;f.bindingID=f instanceof MultiArgMorph?Symbol.for("arguments"):e}),d.emptySlots=e)):d.expression=this.enableLiveCoding||this.enableSingleStepping?[this.context.expression]:[this.context.expression.fullCopy()];d.inputs=
b.asArray();d.receiver=this.context?this.context.receiver:this.receiver;d.origin=d.receiver;return d};Process.prototype.reportScript=function(a,b){return this.reify(b,a)};Process.prototype.reifyScript=function(a,b){return this.reify(a,b)};Process.prototype.reifyReporter=function(a,b){return this.reify(a,b)};Process.prototype.reifyPredicate=function(a,b){return this.reify(a,b)};Process.prototype.reportJSFunction=function(a,b){return Function.apply(null,a.asArray().concat([b]))};
Process.prototype.doRun=function(a,b){return this.evaluate(a,b,!0)};
Process.prototype.evaluate=function(a,b,c){if(!a)return this.returnValueToParentContext(null);if(a instanceof Function)return a.apply(this.blockReceiver(),b.asArray().concat([this]));if(a.isContinuation)return this.runContinuation(a,b);if(!(a instanceof Context))throw Error("expecting a ring but getting "+a);var d=new Context(null,null,a.outerContext),e=this.context.parentContext,f=b.asArray();d.receiver||(d.receiver=a.receiver);var g=new Context(this.context.parentContext,a.expression,d,a.receiver);
g.isCustomCommand=c;this.context.parentContext=g;a.expression instanceof ReporterBlockMorph&&(this.readyToYield=Date.now()-this.lastYield>this.timeout);d.variables.addVar(Symbol.for("arguments"),b);if(0<f.length){for(b=0;b<a.inputs.length;b+=1){var h=0;isNil(f[b])||(h=f[b]);d.variables.addVar(a.inputs[b],h)}if(0===a.inputs.length)if(1===f.length)if(a.emptySlots)for(b=1;b<=a.emptySlots;b+=1)d.variables.addVar(b,f[0]);else a=a.expression,a instanceof Array&&1===a.length&&a[0].selector&&"reifyReporter"===
a[0].selector&&!a[0].contents()&&(g.expression=new Variable(f[0]));else if(f.length===a.emptySlots)for(b=1;b<=f.length;b+=1)d.variables.addVar(b,f[b-1]);else if(1!==a.emptySlots)throw Error(localize("expecting")+" "+a.emptySlots+" "+localize("input(s), but getting")+" "+f.length);}g.expression instanceof CommandBlockMorph&&(g.expression=g.expression.blockSequence(),c||(e?e.tag="exit":(c=new Context(g.parentContext,"expectReport",d,d.receiver),c.tag="exit",g.parentContext=c)))};
Process.prototype.fork=function(a,b){if(!this.readyToTerminate){var c=new Process,d=this.homeContext.receiver.parentThatIsA(StageMorph);c.instrument=this.instrument;c.receiver=this.receiver;c.initializeFor(a,b);d.threads.processes.push(c)}};
Process.prototype.initializeFor=function(a,b){if(a.isContinuation)throw Error("continuations cannot be forked");if(!(a instanceof Context))throw Error("expecting a ring but getting "+a);var c=new Context(null,null,a.outerContext),d=new Context(null,a.expression,c),e=b.asArray();this.context=a.receiver;c.variables.addVar(Symbol.for("arguments"),b);if(0<e.length){for(b=0;b<a.inputs.length;b+=1){var f=0;isNil(e[b])||(f=e[b]);c.variables.addVar(a.inputs[b],f)}if(0===a.inputs.length)if(1===e.length)for(b=
1;b<=a.emptySlots;b+=1)c.variables.addVar(b,e[0]);else if(e.length===a.emptySlots)for(b=1;b<=e.length;b+=1)c.variables.addVar(b,e[b-1]);else if(1!==a.emptySlots)throw Error(localize("expecting")+" "+a.emptySlots+" "+localize("input(s), but getting")+" "+e.length);}d.expression instanceof CommandBlockMorph&&(d.expression=d.expression.blockSequence());this.homeContext=new Context;this.homeContext.receiver=a.outerContext.receiver;this.topBlock=a.expression;this.context=d};
Process.prototype.doStopBlock=function(){var a=this.context.expression.exitTag;if(isNil(a))return this.doStopCustomBlock();for(;this.context&&(isNil(this.context.tag)||this.context.tag>a);)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.pushContext()};Process.prototype.doStopCustomBlock=function(){for(;this.context&&!this.context.isCustomBlock;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext()};
Process.prototype.doCallCC=function(a,b){this.evaluate(a,new List([this.context.continuation(b)]),!b)};Process.prototype.reportCallCC=function(a){this.doCallCC(a,!0)};Process.prototype.runContinuation=function(a,b){b=b.asArray();"expectReport"===a.expression&&b.length?(this.stop(),this.homeContext.inputs[0]=b[0]):(this.context.parentContext=a.copyForContinuationCall(),1===b.length&&this.context.parentContext.outerContext.variables.addVar(1,b[0]))};
Process.prototype.evaluateCustomBlock=function(){var a=this.context.parentContext,b=this.context.expression,c=b.isGlobal?b.definition:this.blockReceiver().getMethod(b.semanticSpec),d=c.body,e=c.declarations,f=(new List(this.context.inputs)).asArray(),g;if(!d)return null;this.procedureCount+=1;var h=new Context;h.receiver=this.context.receiver;h.variables.parentFrame=b.variables;c.variableNames.length?b.variables.parentFrame=h.receiver?h.receiver.variables:null:h.variables.parentFrame=h.receiver?h.receiver.variables:
null;b=new Context(this.context.parentContext,d.expression,h,h.receiver);b.isCustomBlock=!0;this.context.parentContext=b;if(0<f.length)for(g=0;g<d.inputs.length;g+=1){var k=0;isNil(f[g])||(k=f[g]);h.variables.addVar(d.inputs[g],k);"%upvar"===e.get(d.inputs[g])[0]&&(this.context.outerContext.variables.vars[k]=h.variables.vars[d.inputs[g]])}"command"!==c.type?(a?a.tag="exit":(a=new Context(b.parentContext,"expectReport",h,h.receiver),a.tag="exit",b.parentContext=a),this.readyToYield=Date.now()-this.lastYield>
this.timeout):(b.expression.tagExitBlocks(this.procedureCount,!0),a&&!a.tag&&(a.tag=this.procedureCount),!this.isAtomic&&c.isDirectlyRecursive()&&(this.readyToYield=!0));b.expression=b.expression.blockSequence()};Process.prototype.doDeclareVariables=function(a){var b=this.context.outerContext.variables;a.asArray().forEach(function(c){return b.addVar(c)})};
Process.prototype.doSetVar=function(a,b){var c=this.context.variables;a instanceof Context?"reportGetVar"===a.expression.selector?a.variables.setVar(a.expression.blockSpec,b,this.blockReceiver()):this.doSet(a,b):a instanceof Array?this.doSet(a,b):c.setVar(a,b,this.blockReceiver())};
Process.prototype.doChangeVar=function(a,b){var c=this.context.variables;a instanceof Context&&"reportGetVar"===a.expression.selector?a.variables.changeVar(a.expression.blockSpec,b,this.blockReceiver()):c.changeVar(a,b,this.blockReceiver())};Process.prototype.reportGetVar=function(){return this.context.variables.getVar(this.context.expression.blockSpec)};
Process.prototype.doShowVar=function(a){var b=(this.context||this.homeContext).variables,c,d,e=a;if(e instanceof Context)if("reportGetVar"===e.expression.selector)e=e.expression.blockSpec;else{this.doChangePrimitiveVisibility(e.expression,!1);return}if(this.homeContext.receiver&&(c=this.homeContext.receiver.parentThatIsA(StageMorph))&&(d=b.silentFind(e))){b=detect(c.children,function(g){return g instanceof WatcherMorph&&g.target===d&&g.getter===e});if(null!==b)b.show(),b.fixLayout();else{b=(b=contains(this.homeContext.receiver.globalVariables().names(),
a))||d.owner?e:e+" "+localize("(temporary)");b=new WatcherMorph(b,SpriteMorph.prototype.blockColor.variables,d,e);b.setPosition(c.position().add(10));var f=c.watchers(b.left());0<f.length&&b.setTop(f[f.length-1].bottom());c.add(b);b.fixLayout();b.rerender()}c.refreshVariableWatcher(a)}};
Process.prototype.doHideVar=function(a){var b=this.context.variables,c,d=a;if(d instanceof Context)if("reportGetVar"===d.expression.selector)d=d.expression.blockSpec;else{this.doChangePrimitiveVisibility(d.expression,!0);return}if(!d)this.doRemoveTemporaries();else if(this.homeContext.receiver&&(c=this.homeContext.receiver.parentThatIsA(StageMorph))){var e=b.find(d);b=detect(c.children,function(f){return f instanceof WatcherMorph&&f.target===e&&f.getter===d});null!==b&&(b.isTemporary()?b.destroy():
b.hide());c.refreshVariableWatcher(a)}};Process.prototype.doRemoveTemporaries=function(){var a;this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))&&a.watchers().forEach(function(b){b.isTemporary()&&b.destroy()})};
Process.prototype.doChangePrimitiveVisibility=function(a,b){var c=this.homeContext.receiver.parentThatIsA(IDE_Morph);c&&"evaluateCustomBlock"!==a.selector&&(b?StageMorph.prototype.hiddenPrimitives[a.selector]=!0:delete StageMorph.prototype.hiddenPrimitives[a.selector],a={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category,"lists"===a&&(a="variables"),c.flushBlocksCache(a),c.refreshPalette())};
Process.prototype.doDeleteAttr=function(a){var b=this.blockReceiver();if(a instanceof Context)if("reportGetVar"===a.expression.selector)a=a.expression.blockSpec;else{a={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",size:"size"}[a.expression.selector];isNil(a)||b.inheritAttribute(a);return}if(a instanceof Array)return b.inheritAttribute(this.inputOption(a));contains(b.inheritedVariableNames(!0),a)&&b.deleteVariable(a)};
Process.prototype.doTellTo=function(a,b,c){this.doRun(this.reportAttributeOf(b,a),c)};Process.prototype.reportAskFor=function(a,b,c){this.evaluate(this.reportAttributeOf(b,a),c)};Process.prototype.reportNewList=function(a){return a};Process.prototype.reportCONS=function(a,b){this.assertType(b,"list");return(new List).cons(a,b)};Process.prototype.reportCDR=function(a){this.assertType(a,"list");return a.cdr()};
Process.prototype.doAddToList=function(a,b){this.assertType(b,"list");b.type&&(this.assertType(a,b.type),b=this.shadowListAttribute(b));b.add(a)};Process.prototype.doDeleteFromList=function(a,b){var c=a;this.assertType(b,"list");b.type&&(b=this.shadowListAttribute(b));if("all"===this.inputOption(a))return b.clear();if(""===a)return null;if("last"===this.inputOption(a))c=b.length();else if(isNaN(+this.inputOption(a)))return null;b.remove(c)};
Process.prototype.doInsertInList=function(a,b,c){var d=b;this.assertType(c,"list");c.type&&(this.assertType(a,c.type),c=this.shadowListAttribute(c));if(""===b)return null;"any"===this.inputOption(b)&&(d=this.reportBasicRandom(1,c.length()+1));"last"===this.inputOption(b)&&(d=c.length()+1);c.add(a,d)};
Process.prototype.doReplaceInList=function(a,b,c){var d=a;this.assertType(b,"list");b.type&&(this.assertType(c,b.type),b=this.shadowListAttribute(b));if(""===a)return null;"any"===this.inputOption(a)&&(d=this.reportBasicRandom(1,b.length()));"last"===this.inputOption(a)&&(d=b.length());b.put(c,d)};
Process.prototype.shadowListAttribute=function(a){if("costume"===a.type||"sound"===a.type){var b=this.blockReceiver();a===b.costumes?(b.shadowAttribute("costumes"),a=b.costumes):a===b.sounds&&(b.shadowAttribute("sounds"),a=b.sounds)}return a};
Process.prototype.reportListItem=function(a,b){this.assertType(b,"list");if(""===a)return"";if("any"===this.inputOption(a))return b.at(this.reportBasicRandom(1,b.length()));if("last"===this.inputOption(a))return b.at(b.length());var c=this.rank(a);return 0<c&&this.enableHyperOps?1===c?a.isEmpty()?b.map(function(d){return d}):a.map(function(d){return b.at(d)}):this.reportItems(a,b):b.at(a)};
Process.prototype.reportItems=function(a,b){function c(e,f,g){return 1===e?g:c(e-1,f.cdr(),d(f.at(1)||new List,g))}function d(e,f){return function(g){return e.isEmpty()?g.map(function(h){return f(h)}):e.map(function(h){return f(g.at(h))})}}return c(this.rank(b),a.cdr(),function(e){return function(f){return e.isEmpty()?f.map(function(g){return g}):e.map(function(g){return f.at(g)})}}(a.at(1)))(b)};Process.prototype.reportListLength=function(a){this.assertType(a,"list");return a.length()};
Process.prototype.reportListIndex=function(a,b){this.assertType(b,"list");return b.indexOf(a)};Process.prototype.reportListContainsItem=function(a,b){this.assertType(a,"list");return a.contains(b)};Process.prototype.reportListIsEmpty=function(a){this.assertType(a,"list");return a.isEmpty()};Process.prototype.doShowTable=function(a){this.assertType(a,"list");(new TableDialogMorph(a)).popUp(this.blockReceiver().world())};
Process.prototype.reportNumbers=function(a,b){var c=this;return this.enableHyperOps?this.hyperDyadic(function(d,e){return c.reportBasicNumbers(d,e)},a,b):this.reportLinkedNumbers(a,b)};Process.prototype.reportBasicNumbers=function(a,b){var c;a=+a;var d=+b;b=a;this.assertType(a,"number");this.assertType(d,"number");if(d>a)for(d=Math.floor(d-a),a=Array(d),c=0;c<=d;c+=1)a[c]=b,b+=1;else for(d=Math.floor(a-d),a=Array(d),c=0;c<=d;c+=1)a[c]=b,--b;return new List(a)};
Process.prototype.reportConcatenatedLists=function(a){var b,c;this.assertType(a,"list");if(a.isEmpty())return a;var d=a.at(1);this.assertType(d,"list");if(d.isLinked)return this.concatenateLinkedLists(a);d=[];var e=a.length();for(b=1;b<=e;b+=1){var f=a.at(b);this.assertType(f,"list");var g=f.length();for(c=1;c<=g;c+=1)d.push(f.at(c))}return new List(d)};
Process.prototype.concatenateLinkedLists=function(a){if(a.isEmpty())return a;var b=a.at(1);this.assertType(b,"list");return 1===a.length()?b:b.isEmpty()?this.concatenateLinkedLists(a.cdr()):a.cons(b.at(1),this.concatenateLinkedLists(a.cons(b.cdr(),a.cdr())))};
Process.prototype.reportLinkedNumbers=function(a,b){null===this.context.accumulator&&(this.assertType(a,"number"),this.assertType(b,"number"),this.context.accumulator={target:new List,end:null,idx:+a,step:+b>+a?1:-1},this.context.accumulator.target.isLinked=!0,this.context.accumulator.end=this.context.accumulator.target);a=this.context.accumulator;(1===a.step?a.idx>+b:a.idx<+b)?(a.end.rest=new List,this.returnValueToParentContext(a.target.cdr())):(a.end.rest=a.target.cons(a.idx),a.end=a.end.rest,
a.idx+=a.step,this.pushContext())};Process.prototype.doIf=function(){var a=this.context.inputs,b=this.context.outerContext,c=this.context.isCustomBlock;this.popContext();a[0]&&a[1]&&(this.pushContext(a[1].blockSequence(),b),this.context.isCustomBlock=c);this.pushContext()};
Process.prototype.doIfElse=function(){var a=this.context.inputs,b=this.context.outerContext,c=this.context.isCustomBlock;this.popContext();a[0]?a[1]&&this.pushContext(a[1].blockSequence(),b):a[2]?this.pushContext(a[2].blockSequence(),b):this.pushContext("doYield");this.context&&(this.context.isCustomBlock=c);this.pushContext()};
Process.prototype.reportIfElse=function(a){var b=this.context.inputs;1>b.length?this.evaluateNextInput(a):1<b.length?this.flashContext()||(this.returnValueToParentContext(b.pop()),this.popContext()):(b[0]||b.push(null),this.evaluateNextInput(a))};Process.prototype.doStop=function(){this.stop()};
Process.prototype.doStopAll=function(){var a;if(this.homeContext.receiver){if(a=this.homeContext.receiver.parentThatIsA(StageMorph))a.threads.pauseCustomHatBlocks=a.enableCustomHatBlocks?!a.threads.pauseCustomHatBlocks:!1,a.stopAllActiveSounds(),a.threads.resumeAll(a),a.keysPressed={},a.runStopScripts(),a.threads.stopAll(),a.projectionSource&&a.stopProjection(),a.children.forEach(function(b){b.stopTalking&&b.stopTalking()}),a.removeAllClones();if(a=a.parentThatIsA(IDE_Morph))a.controlBar.pauseButton.refresh(),
a.controlBar.stopButton.refresh()}};Process.prototype.doStopThis=function(a){switch(this.inputOption(a)){case "all":this.doStopAll();break;case "this script":this.doStop();break;case "this block":this.doStopBlock();break;default:this.doStopOthers(a)}};
Process.prototype.doStopOthers=function(a){var b;if(this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(StageMorph)))switch(this.inputOption(a)){case "all but this script":b.threads.stopAll(this);break;case "other scripts in sprite":b.threads.stopAllForReceiver(this.homeContext.receiver,this);break;default:nop()}};
Process.prototype.doWarp=function(a){var b=this.context.outerContext,c=this.context.isCustomBlock,d;this.popContext();a&&(this.homeContext.receiver&&(this.homeContext.receiver.startWarp&&this.homeContext.receiver.startWarp(),d=this.homeContext.receiver.parentThatIsA(StageMorph))&&(d.fps=0),this.pushContext("popContext"),this.context&&(this.context.isCustomBlock=c),this.isAtomic||this.pushContext("doStopWarping"),this.pushContext(a.blockSequence(),b),this.isAtomic=!0);this.pushContext()};
Process.prototype.doStopWarping=function(){var a;this.popContext();this.isAtomic=!1;this.homeContext.receiver&&(this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp(),a=this.homeContext.receiver.parentThatIsA(StageMorph))&&(a.fps=a.frameRate)};Process.prototype.reportIsFastTracking=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(IDE_Morph))?a.stage.isFastTracked:!1};
Process.prototype.doSetGlobalFlag=function(a,b){var c=this.homeContext.receiver.parentThatIsA(StageMorph);a=this.inputOption(a);this.assertType(b,"Boolean");switch(a){case "turbo mode":this.doSetFastTracking(b);break;case "flat line ends":SpriteMorph.prototype.useFlatLineEnds=b;break;case "log pen vectors":StageMorph.prototype.enablePenLogging=b;break;case "video capture":b?this.startVideo(c):c.stopProjection();break;case "mirror video":c.mirrorVideo=b}};
Process.prototype.reportGlobalFlag=function(a){var b=this.homeContext.receiver.parentThatIsA(StageMorph);a=this.inputOption(a);switch(a){case "turbo mode":return this.reportIsFastTracking();case "flat line ends":return SpriteMorph.prototype.useFlatLineEnds;case "log pen vectors":return StageMorph.prototype.enablePenLogging;case "video capture":return!isNil(b.projectionSource)&&0<b.projectionLayer().getContext("2d").getImageData(0,0,1,1).data[3];case "mirror video":return b.mirrorVideo;default:return""}};
Process.prototype.doSetFastTracking=function(a){var b;this.reportIsA(a,"Boolean")&&this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(IDE_Morph))&&(a?b.startFastTracking():b.stopFastTracking())};Process.prototype.doPauseAll=function(){var a;this.homeContext.receiver&&((a=this.homeContext.receiver.parentThatIsA(StageMorph))&&a.threads.pauseAll(a),(a=a.parentThatIsA(IDE_Morph))&&a.controlBar.pauseButton.refresh())};
Process.prototype.doForever=function(a){this.context.inputs=[];this.pushContext("doYield");a&&this.pushContext(a.blockSequence());this.pushContext()};Process.prototype.doRepeat=function(a,b){var c=this.context.expression,d=this.context.outerContext,e=this.context.isCustomBlock;if(1>a)return null;this.popContext();this.pushContext(c,d);this.context.isCustomBlock=e;this.context.addInput(a-1);this.pushContext("doYield");b&&this.pushContext(b.blockSequence());this.pushContext()};
Process.prototype.doUntil=function(a,b){if(a)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[];this.pushContext("doYield");b&&this.pushContext(b.blockSequence());this.pushContext()};Process.prototype.doWaitUntil=function(a){if(a)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[];this.pushContext("doYield");this.pushContext()};
Process.prototype.doForEach=function(a,b,c){null===this.context.accumulator&&(this.assertType(b,"list"),this.context.accumulator={source:b,remaining:b.length(),idx:0});0!==this.context.accumulator.remaining&&(--this.context.accumulator.remaining,this.context.accumulator.source.isLinked?(b=this.context.accumulator.source.at(1),this.context.accumulator.source=this.context.accumulator.source.cdr()):(this.context.accumulator.idx+=1,b=this.context.accumulator.source.at(this.context.accumulator.idx)),this.pushContext("doYield"),
this.pushContext(),this.context.outerContext.variables.addVar(a),this.context.outerContext.variables.setVar(a,b),this.evaluate(c,new List([b]),!0))};
Process.prototype.doFor=function(a,b,c,d){var e=this.context.outerContext.variables,f=this.context.accumulator;null===f?(this.assertType(b,"number"),this.assertType(c,"number"),f=this.context.accumulator={test:+b<+c?function(){return e.getVar(a)>+c}:function(){return e.getVar(a)<+c},step:+b<+c?1:-1,parms:new List},e.addVar(a),e.setVar(a,Math.floor(+b))):e.changeVar(a,f.step);f.test()||(this.pushContext("doYield"),this.pushContext(),this.evaluate(d,f.parms,!0))};
Process.prototype.reportMap=function(a,b){if(b.isLinked){null===this.context.accumulator?(this.assertType(b,"list"),this.context.accumulator={source:b,idx:1,target:new List,end:null,remaining:b.length()},this.context.accumulator.target.isLinked=!0,this.context.accumulator.end=this.context.accumulator.target):2<this.context.inputs.length&&(this.context.accumulator.end.rest=b.cons(this.context.inputs.pop()),this.context.accumulator.end=this.context.accumulator.end.rest,this.context.accumulator.idx+=
1,--this.context.accumulator.remaining);if(0===this.context.accumulator.remaining){this.context.accumulator.end.rest=b.cons(this.context.inputs[2]).cdr();this.returnValueToParentContext(this.context.accumulator.target.cdr());return}var c=this.context.accumulator.idx;var d=this.context.accumulator.source.at(1);this.context.accumulator.source=this.context.accumulator.source.cdr()}else{null===this.context.accumulator?(this.assertType(b,"list"),this.context.accumulator=[]):2<this.context.inputs.length&&
this.context.accumulator.push(this.context.inputs.pop());if(this.context.accumulator.length===b.length()){this.returnValueToParentContext(new List(this.context.accumulator));return}c=this.context.accumulator.length+1;d=b.at(c)}this.pushContext();d=[d];1<a.inputs.length&&d.push(c);2<a.inputs.length&&d.push(b);this.evaluate(a,new List(d))};
Process.prototype.reportKeep=function(a,b){if(b.isLinked){null===this.context.accumulator?(this.assertType(b,"list"),this.context.accumulator={source:b,idx:1,target:new List,end:null,remaining:b.length()},this.context.accumulator.target.isLinked=!0,this.context.accumulator.end=this.context.accumulator.target):2<this.context.inputs.length&&(!0===this.context.inputs.pop()&&(this.context.accumulator.end.rest=b.cons(this.context.accumulator.source.at(1)),this.context.accumulator.end=this.context.accumulator.end.rest),
--this.context.accumulator.remaining,this.context.accumulator.idx+=1,this.context.accumulator.source=this.context.accumulator.source.cdr());if(0===this.context.accumulator.remaining){this.context.accumulator.end.rest=new List;this.returnValueToParentContext(this.context.accumulator.target.cdr());return}var c=this.context.accumulator.idx;var d=this.context.accumulator.source.at(1)}else{null===this.context.accumulator?(this.assertType(b,"list"),this.context.accumulator={idx:0,target:[]}):2<this.context.inputs.length&&
!0===this.context.inputs.pop()&&this.context.accumulator.target.push(b.at(this.context.accumulator.idx));if(this.context.accumulator.idx===b.length()){this.returnValueToParentContext(new List(this.context.accumulator.target));return}this.context.accumulator.idx+=1;c=this.context.accumulator.idx;d=b.at(c)}this.pushContext();d=[d];1<a.inputs.length&&d.push(c);2<a.inputs.length&&d.push(b);this.evaluate(a,new List(d))};
Process.prototype.reportFindFirst=function(a,b){if(b.isLinked){if(null===this.context.accumulator)this.assertType(b,"list"),this.context.accumulator={source:b,idx:1,remaining:b.length()};else if(2<this.context.inputs.length){if(!0===this.context.inputs.pop()){this.returnValueToParentContext(this.context.accumulator.source.at(1));return}--this.context.accumulator.remaining;this.context.accumulator.idx+=1;this.context.accumulator.source=this.context.accumulator.source.cdr()}if(0===this.context.accumulator.remaining){this.returnValueToParentContext("");
return}var c=this.context.accumulator.idx;var d=this.context.accumulator.source.at(1)}else{if(null===this.context.accumulator)this.assertType(b,"list"),this.context.accumulator={idx:0,current:null};else if(2<this.context.inputs.length&&!0===this.context.inputs.pop()){this.returnValueToParentContext(this.context.accumulator.current);return}if(this.context.accumulator.idx===b.length()){this.returnValueToParentContext("");return}this.context.accumulator.idx+=1;c=this.context.accumulator.idx;d=b.at(c);
this.context.accumulator.current=d}this.pushContext();d=[d];1<a.inputs.length&&d.push(c);2<a.inputs.length&&d.push(b);this.evaluate(a,new List(d))};
Process.prototype.reportCombine=function(a,b){this.assertType(a,"list");if(2>a.length())this.returnValueToParentContext(a.length()?a.at(1):0);else{if(a.isLinked){null===this.context.accumulator?this.context.accumulator={source:a.cdr(),idx:1,target:a.at(1),remaining:a.length()-1}:2<this.context.inputs.length&&(this.context.accumulator.target=this.context.inputs.pop(),--this.context.accumulator.remaining,this.context.accumulator.idx+=1,this.context.accumulator.source=this.context.accumulator.source.cdr());
if(0===this.context.accumulator.remaining){this.returnValueToParentContext(this.context.accumulator.target);return}var c=this.context.accumulator.source.at(1)}else{null===this.context.accumulator?this.context.accumulator={idx:1,target:a.at(1)}:2<this.context.inputs.length&&(this.context.accumulator.target=this.context.inputs.pop());if(this.context.accumulator.idx===a.length()){this.returnValueToParentContext(this.context.accumulator.target);return}this.context.accumulator.idx+=1;c=a.at(this.context.accumulator.idx)}var d=
this.context.accumulator.idx;var e=this.context.accumulator.target;this.pushContext();c=[e,c];2<b.inputs.length&&c.push(d);3<b.inputs.length&&c.push(a);this.evaluate(b,new List(c))}};Process.prototype.doWait=function(a){this.context.startTime||(this.context.startTime=Date.now());if(Date.now()-this.context.startTime>=1E3*a)return this.isAtomic||0!==a||(this.readyToYield=!0),null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doGlide=function(a,b,c){this.context.startTime||(this.context.startTime=Date.now(),this.context.startValue=new Point(this.blockReceiver().xPosition(),this.blockReceiver().yPosition()));if(Date.now()-this.context.startTime>=1E3*a)return this.blockReceiver().gotoXY(b,c),null;this.blockReceiver().glide(1E3*a,b,c,Date.now()-this.context.startTime,this.context.startValue);this.pushContext("doYield");this.pushContext()};
Process.prototype.doSayFor=function(a,b){this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().bubble(a));if(Date.now()-this.context.startTime>=1E3*b)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doThinkFor=function(a,b){this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().doThink(a));if(Date.now()-this.context.startTime>=1E3*b)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield");this.pushContext()};Process.prototype.blockReceiver=function(){return this.context?this.context.receiver||this.homeContext.receiver:this.homeContext.receiver||this.receiver};
Process.prototype.playSound=function(a){return a instanceof List?this.doPlaySoundAtRate(a,44100):this.blockReceiver().doPlaySound(a)};Process.prototype.doPlaySoundUntilDone=function(a){null===this.context.activeAudio&&(this.context.activeAudio=this.playSound(a));if(null===a||this.context.activeAudio.ended||this.context.activeAudio.terminated)return null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doStopAllSounds=function(){var a=this.homeContext.receiver.parentThatIsA(StageMorph);a&&(a.threads.processes.forEach(function(b){b.context&&(b.context.stopMusic(),b.context.activeAudio&&b.popContext())}),a.stopAllActiveSounds())};
Process.prototype.doPlaySoundAtRate=function(a,b){if(a instanceof List)var c=a;else{c=a instanceof Sound?a:"number"===typeof a?this.blockReceiver().sounds.at(a):detect(this.blockReceiver().sounds.asArray(),function(k){return k.name===a.toString()});if(!c.audioBuffer){this.decodeSound(c);return}c=this.reportGetSoundAttribute("samples",c)}var d=this.blockReceiver();var e=d.audioContext();var f=d.getGainNode();var g=d.getPannerNode();var h=this.encodeSound(c,b);d.setVolume(d.volume);h.connect(f);g?(f.connect(g),
g.connect(e.destination),d.setPan(d.pan)):f.connect(e.destination);h.pause=h.stop;h.ended=!1;h.onended=function(){return h.ended=!0};h.start();d.parentThatIsA(StageMorph).activeSounds.push(h);return h};
Process.prototype.reportGetSoundAttribute=function(a,b){var c=b instanceof Sound?b:"number"===typeof b?this.blockReceiver().sounds.at(b):b instanceof List?this.encodeSound(b):detect(this.blockReceiver().sounds.asArray(),function(d){return d.name===b.toString()});a=this.inputOption(a);if("name"===a)return c.name;if(c.audioBuffer)switch(a){case "samples":return c.cachedSamples||(c.cachedSamples=function(d,e){d=d.audioBuffer;var f;if(1<d.numberOfChannels){var g=new List;for(f=0;f<d.numberOfChannels;f+=
1)g.add(new List(e(d.getChannelData(f))));return g}return new List(e(d.getChannelData(0)))}(c,this.untype)),c.cachedSamples;case "sample rate":return c.audioBuffer.sampleRate;case "duration":return c.audioBuffer.duration;case "length":return c.audioBuffer.length;case "number of channels":return c.audioBuffer.numberOfChannels;default:return 0}else this.decodeSound(c)};
Process.prototype.decodeSound=function(a,b){var c=this,d;if(a.audioBuffer)return(b||nop)(a);if(!a.isDecoding){b=a.audio.src.split(",")[1];b=window.atob(b);var e=b.length;var f=new Uint8Array(e);for(d=0;d<e;d+=1)f[d]=b.charCodeAt(d);b=f.buffer;e=Note.prototype.getAudioContext();a.isDecoding=!0;e.decodeAudioData(b,function(g){a.audioBuffer=g;a.isDecoding=!1},function(g){a.isDecoding=!1;c.handleError(g)})}this.pushContext("doYield");this.pushContext()};
Process.prototype.encodeSound=function(a,b){var c=this.blockReceiver().audioContext(),d=a.at(1)instanceof List?a.length():1,e=1===d?a.length():a.at(1).length();b=c.createBuffer(d,e,+b||44100);var f;b.copyToChannel||(b.copyToChannel=function(g,h){h=this.getChannelData(h);for(f=0;f<g.length;f+=1)h[f]=g[f]});if(1===d)b.copyToChannel(Float32Array.from(a.asArray()),0,0);else for(f=0;f<d;f+=1)b.copyToChannel(Float32Array.from(a.at(f+1).asArray()),f,0);a=c.createBufferSource();a.buffer=b;a.audioBuffer=a.buffer;
return a};
Process.prototype.reportNewSoundFromSamples=function(a,b){var c=this;if(isNil(this.context.accumulator)){this.assertType(a,"list");this.context.accumulator={audio:null};var d=new Audio;a=new Blob([this.audioBufferToWav(this.encodeSound(a,b||44100).audioBuffer)],{type:"audio/wav"});var e=new FileReader;e.onload=function(){d.src=e.result;c.context.accumulator.audio=d};e.readAsDataURL(a)}if(this.context.accumulator.audio)return new Sound(this.context.accumulator.audio,this.blockReceiver().newSoundName(localize("sound")));this.pushContext("doYield");
this.pushContext()};Process.prototype.audioBufferToWav=function(a,b){var c=a.numberOfChannels,d=a.sampleRate;b=(b||{}).float32?3:1;var e=3===b?32:16;if(2===c){var f=a.getChannelData(0);a=a.getChannelData(1);for(var g=f.length+a.length,h=new Float32Array(g),k=0,l=0;k<g;)h[k++]=f[l],h[k++]=a[l],l+=1;f=h}else f=a.getChannelData(0);return this.encodeWAV(f,b,d,c,e)};
Process.prototype.encodeWAV=function(a,b,c,d,e){function f(q,p,t){for(var r=0;r<t.length;r+=1,p+=4)q.setFloat32(p,t[r],!0)}function g(q,p,t){var r;for(r=0;r<t.length;r+=1,p+=2){var u=Math.max(-1,Math.min(1,t[r]));q.setInt16(p,0>u?32768*u:32767*u,!0)}}function h(q,p,t){for(var r=0;r<t.length;r+=1)q.setUint8(p+r,t.charCodeAt(r))}var k=e/8,l=d*k,m=new ArrayBuffer(44+a.length*k),n=new DataView(m);h(n,0,"RIFF");n.setUint32(4,36+a.length*k,!0);h(n,8,"WAVE");h(n,12,"fmt ");n.setUint32(16,16,!0);n.setUint16(20,
b,!0);n.setUint16(22,d,!0);n.setUint32(24,c,!0);n.setUint32(28,c*l,!0);n.setUint16(32,l,!0);n.setUint16(34,e,!0);h(n,36,"data");n.setUint32(40,a.length*k,!0);1===b?g(n,44,a):f(n,44,a);return m};
Process.prototype.reportAudio=function(a){var b=this.blockReceiver().parentThatIsA(StageMorph);a=this.inputOption(a);if("resolution"===a)return b.microphone.binSize();if("modifier"===a)return b.microphone.modifier;if(b.microphone.isOn())switch(a){case "volume":return 100*b.microphone.volume;case "frequency":return b.microphone.pitch;case "note":return b.microphone.note;case "samples":return new List(this.untype(b.microphone.signals));case "sample rate":return b.microphone.audioContext.sampleRate;
case "output":return new List(this.untype(b.microphone.output));case "spectrum":return new List(this.untype(b.microphone.frequencies));default:return null}this.pushContext("doYield");this.pushContext()};Process.prototype.untype=function(a){var b=a.length,c=Array(b),d;for(d=0;d<b;d+=1)c[d]=a[d];return c};
Process.prototype.setMicrophoneModifier=function(a){var b=this.blockReceiver().parentThatIsA(StageMorph),c="sprite stage list costume sound number text Boolean".split(" ");!a||contains(c,this.reportTypeOf(a))?(b.microphone.modifier=null,b.microphone.stop()):(b.microphone.modifier=a,b.microphone.compiledModifier=this.reportCompiled(a,1),b.microphone.compilerProcess=this)};
Process.prototype.doAsk=function(a){var b=this.homeContext.receiver.parentThatIsA(StageMorph),c=this.blockReceiver(),d=c instanceof StageMorph,e=c instanceof SpriteMorph&&!c.isVisible;b.keysPressed={};if(!this.prompter){var f=detect(b.children,function(g){return g instanceof StagePrompterMorph});f||(d||e||c.bubble(a,!1,!0),this.prompter=new StagePrompterMorph(d||e?a:null),1>b.scale?this.prompter.setWidth(b.width()-10):this.prompter.setWidth(b.dimensions.x-20),this.prompter.fixLayout(),this.prompter.setCenter(b.center()),
this.prompter.setBottom(b.bottom()-this.prompter.border),b.add(this.prompter),this.prompter.inputField.edit(),b.changed())}else if(this.prompter.isDone)return b.lastAnswer=this.prompter.inputField.getValue(),this.prompter.destroy(),this.prompter=null,d||c.stopTalking(),null;this.pushContext("doYield");this.pushContext()};Process.prototype.reportLastAnswer=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).lastAnswer};
Process.prototype.reportURL=function(a){if(!this.httpRequest){if(0>a.indexOf("//")||8<a.indexOf("//"))a="file:"===location.protocol?"https://"+a:location.protocol+"//"+a;this.httpRequest=new XMLHttpRequest;this.httpRequest.open("GET",a,!0);this.httpRequest.send(null);if(this.context.isCustomCommand)return this.httpRequest=null}else if(4===this.httpRequest.readyState)return a=this.httpRequest.responseText,this.httpRequest=null,a;this.pushContext("doYield");this.pushContext()};
Process.prototype.doBroadcast=function(a){var b=this,c=this.homeContext.receiver.parentThatIsA(StageMorph),d=this.inputOption(a),e=[];if(!this.canBroadcast)return[];if(a instanceof List&&2===a.length()){var f=this.blockReceiver();d=a.at(1);var g=a.at(2);if(isSnapObject(g))g=[g];else if(isString(g))g=g===c.name?[c]:[this.getOtherObject(g,f,c)];else if(g instanceof List)g=g.itemsArray().map(function(h){return b.getOtherObject(h,f,c)});else return}else g=c.children.concat(c);""!==d&&(c.lastMessage=a,
g.forEach(function(h){isSnapObject(h)&&h.allHatBlocksFor(d).forEach(function(k){e.push(c.threads.startProcess(k,h,c.isThreadSafe))})}),(c.messageCallbacks[""]||[]).forEach(function(h){return h(d)}),(c.messageCallbacks[d]||[]).forEach(function(h){return h()}));return e};
Process.prototype.doBroadcastAndWait=function(a){this.context.activeSends||(this.context.activeSends=this.doBroadcast(a),this.isRunning()&&this.context.activeSends.forEach(function(b){return b.runStep()}));this.context.activeSends=this.context.activeSends.filter(function(b){return b.isRunning()});if(0===this.context.activeSends.length)return null;this.pushContext("doYield");this.pushContext()};
Process.prototype.getLastMessage=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))?a.getLastMessage():""};Process.prototype.doSend=function(a,b){var c=this.homeContext.receiver.parentThatIsA(StageMorph);this.doBroadcast(new List([a,b instanceof List?b:b===c.name?new List([c]):new List([b])]))};Process.prototype.reportIsA=function(a,b){return this.reportTypeOf(a)===this.inputOption(b)};
Process.prototype.assertType=function(a,b){a=this.reportTypeOf(a);if(a===b||b instanceof Array&&contains(b,a))return!0;throw Error("expecting "+b+" but getting "+a);};Process.prototype.assertAlive=function(a){if(a&&a.isCorpse)throw Error("cannot operate on a deleted sprite");};
Process.prototype.reportTypeOf=function(a){return null===a||void 0===a?"nothing":!0===a||!1===a?"Boolean":a instanceof List?"list":parseFloat(a)===+a?"number":isString(a)?"text":a instanceof SpriteMorph?"sprite":a instanceof StageMorph?"stage":a instanceof Costume?"costume":a instanceof Sound?"sound":a instanceof Context?a.expression instanceof RingMorph?a.expression.dataType():a.expression instanceof ReporterBlockMorph?a.expression.isPredicate?"predicate":"reporter":a.expression instanceof Array?
(a=a.expression[a.pc||0],a.isPredicate?"predicate":a instanceof RingMorph?a.dataType():a instanceof ReporterBlockMorph?"reporter":a instanceof CommandBlockMorph?"command":"reporter"):a.expression instanceof CommandBlockMorph?"command":"reporter":"undefined"};
Process.prototype.hyperDyadic=function(a,b,c){var d=this,e;if(this.enableHyperOps){if(this.isMatrix(b)){if(this.isMatrix(c)){b=b.asArray();c=c.asArray();var f=Math.min(b.length,c.length);var g=Array(f);for(e=0;e<f;e+=1)g[e]=this.hyperDyadic(a,b[e],c[e]);return new List(g)}return b.map(function(h){return d.hyperDyadic(a,h,c)})}return this.isMatrix(c)?c.map(function(h){return d.hyperDyadic(a,b,h)}):this.hyperZip(a,b,c)}return a(b,c)};
Process.prototype.hyperZip=function(a,b,c){var d=this,e;if(b instanceof List){if(c instanceof List){b=b.asArray();c=c.asArray();var f=Math.min(b.length,c.length);var g=Array(f);for(e=0;e<f;e+=1)g[e]=this.hyperZip(a,b[e],c[e]);return new List(g)}return b.map(function(h){return d.hyperZip(a,h,c)})}return c instanceof List?c.map(function(h){return d.hyperZip(a,b,h)}):a(b,c)};Process.prototype.isMatrix=function(a){return a instanceof List&&a.at(1)instanceof List};
Process.prototype.rank=function(a){for(var b=0;a instanceof List;)b+=1,a=a.at(1);return b};Process.prototype.reportSum=function(a,b){return this.hyperDyadic(this.reportBasicSum,a,b)};Process.prototype.reportBasicSum=function(a,b){return+a+ +b};Process.prototype.reportDifference=function(a,b){return this.hyperDyadic(this.reportBasicDifference,a,b)};Process.prototype.reportBasicDifference=function(a,b){return+a-+b};
Process.prototype.reportProduct=function(a,b){return this.hyperDyadic(this.reportBasicProduct,a,b)};Process.prototype.reportBasicProduct=function(a,b){return+a*+b};Process.prototype.reportQuotient=function(a,b){return this.hyperDyadic(this.reportBasicQuotient,a,b)};Process.prototype.reportBasicQuotient=function(a,b){return+a/+b};Process.prototype.reportPower=function(a,b){return this.hyperDyadic(this.reportBasicPower,a,b)};Process.prototype.reportBasicPower=function(a,b){return Math.pow(+a,+b)};
Process.prototype.reportModulus=function(a,b){return this.hyperDyadic(this.reportBasicModulus,a,b)};Process.prototype.reportBasicModulus=function(a,b){b=+b;return(+a%b+b)%b};Process.prototype.reportRandom=function(a,b){return this.hyperDyadic(this.reportBasicRandom,a,b)};Process.prototype.reportBasicRandom=function(a,b){a=+a;b=+b;return 0!==a%1||0!==b%1?Math.random()*(b-a)+a:Math.floor(Math.random()*(b-a+1))+a};
Process.prototype.reportLessThan=function(a,b){return this.hyperDyadic(this.reportBasicLessThan,a,b)};Process.prototype.reportBasicLessThan=function(a,b){var c=+a,d=+b;if(isNaN(c)||isNaN(d))c=a,d=b;return c<d};Process.prototype.reportNot=function(a){var b=this;return this.enableHyperOps&&a instanceof List?a.map(function(c){return b.reportNot(c)}):!a};Process.prototype.reportGreaterThan=function(a,b){return this.hyperDyadic(this.reportBasicGreaterThan,a,b)};
Process.prototype.reportBasicGreaterThan=function(a,b){var c=+a,d=+b;if(isNaN(c)||isNaN(d))c=a,d=b;return c>d};Process.prototype.reportEquals=function(a,b){return snapEquals(a,b)};Process.prototype.reportIsIdentical=function(a,b){function c(){Object.prototype.hasOwnProperty.call(a,"idTag")&&delete a.idTag;Object.prototype.hasOwnProperty.call(b,"idTag")&&delete b.idTag}if(this.isImmutable(a)||this.isImmutable(b))return snapEquals(a,b);c();a.idTag=Date.now();if(b.idTag===a.idTag)return c(),!0;c();return!1};
Process.prototype.isImmutable=function(a){a=this.reportTypeOf(a);return"nothing"===a||"Boolean"===a||"text"===a||"number"===a||"undefined"===a};Process.prototype.reportBoolean=function(a){return a};Process.prototype.reportRound=function(a){var b=this;return this.enableHyperOps&&a instanceof List?a.map(function(c){return b.reportRound(c)}):Math.round(+a)};
Process.prototype.reportMonadic=function(a,b){var c=this;if(this.enableHyperOps&&b instanceof List)return b.map(function(f){return c.reportMonadic(a,f)});var d=+b,e=0;switch(this.inputOption(a)){case "abs":e=Math.abs(d);break;case "neg":e=-1*b;break;case "ceiling":e=Math.ceil(d);break;case "floor":e=Math.floor(d);break;case "sqrt":e=Math.sqrt(d);break;case "sin":e=Math.sin(radians(d));break;case "cos":e=Math.cos(radians(d));break;case "tan":e=Math.tan(radians(d));break;case "asin":e=degrees(Math.asin(d));
break;case "acos":e=degrees(Math.acos(d));break;case "atan":e=degrees(Math.atan(d));break;case "ln":e=Math.log(d);break;case "log":e=Math.log10(d);break;case "lg":e=Math.log2(d);break;case "e^":e=Math.exp(d);break;case "10^":e=Math.pow(10,d);break;case "2^":e=Math.pow(2,d);break;case "id":return b;default:nop()}return e};
Process.prototype.reportTextFunction=function(a,b){b=(isNil(b)?"":b).toString();var c="";switch(this.inputOption(a)){case "encode URI":c=encodeURI(b);break;case "decode URI":c=decodeURI(b);break;case "encode URI component":c=encodeURIComponent(b);break;case "decode URI component":c=decodeURIComponent(b);break;case "XML escape":c=(new XML_Element).escape(b);break;case "XML unescape":c=(new XML_Element).unescape(b);break;case "hex sha512 hash":c=hex_sha512(b);break;default:nop()}return c};
Process.prototype.reportJoin=function(a,b){a=(isNil(a)?"":a).toString();b=(isNil(b)?"":b).toString();return a.concat(b)};Process.prototype.reportJoinWords=function(a){return a instanceof List?a.asText():(a||"").toString()};Process.prototype.reportLetter=function(a,b){var c=this;return this.hyperDyadic(function(d,e){return c.reportBasicLetter(d,e)},a,b)};
Process.prototype.reportBasicLetter=function(a,b){b=isNil(b)?"":b.toString();"any"===this.inputOption(a)&&(a=this.reportBasicRandom(1,b.length));"last"===this.inputOption(a)&&(a=b.length);return b[+(a||0)-1]||""};Process.prototype.reportStringSize=function(a){var b=this;return this.enableHyperOps&&a instanceof List?a.map(function(c){return b.reportStringSize(c)}):a instanceof List?a.length():isNil(a)?0:a.toString().length};
Process.prototype.reportUnicode=function(a){var b=this;if(this.enableHyperOps){if(a instanceof List)return a.map(function(c){return b.reportUnicode(c)});a=isNil(a)?"\x00":a.toString();if(1<a.length)return this.reportUnicode(new List(a.split("")))}else a=isNil(a)?"\x00":a.toString();return a.codePointAt?a.codePointAt(0)||0:a.charCodeAt(0)||0};
Process.prototype.reportUnicodeAsLetter=function(a){var b=this;if(this.enableHyperOps&&a instanceof List)return a.map(function(c){return b.reportUnicodeAsLetter(c)});a=+(a||0);return String.fromCodePoint?String.fromCodePoint(a):String.fromCharCode(a)};Process.prototype.reportTextSplit=function(a,b){var c=this;return this.hyperDyadic(function(d,e){return c.reportBasicTextSplit(d,e)},a,b)};
Process.prototype.reportBasicTextSplit=function(a,b){var c=["text","number"],d=this.reportTypeOf(a),e=this.reportTypeOf(this.inputOption(b));if(!contains(c,d))throw Error("expecting text instead of a "+d);if(!contains(c,e))throw Error("expecting a text delimiter instead of a "+e);c=isNil(a)?"":a.toString();switch(this.inputOption(b)){case "line":a=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case "tab":a="\t";break;case "cr":a="\r";break;case "word":case "whitespace":c=c.trim();a=/\s+/;break;case "letter":a=
"";break;case "csv":return this.parseCSV(a);case "json":return this.parseJSON(a);default:a=isNil(b)?"":b.toString()}return new List(c.split(a))};Process.prototype.parseCSV=function(a){return this.rawParseCSV(a,this.guessDelimiterCSV(a))};Process.prototype.guessDelimiterCSV=function(a){var b=[",",";","|","\t"],c=b.length;a=a.split("\n")[0];var d;for(d=0;d<c;d+=1)if(1<this.rawParseCSV(a,b[d]).length())return b[d];return b[0]};
Process.prototype.rawParseCSV=function(a,b){var c="",d=[""],e=[d],f=0,g=0,h=!0,k=a.length,l;b=b||",";for(l=0;l<k;l+=1){var m=a[l];'"'===m?(h&&m===c&&(d[f]+=m),h=!h):m===b&&h?(m="",f+=1,d[f]=m):"\r"===m&&h?(g+=1,e[g]=[""],d=e[g],f=0):"\n"===m&&h?"\r"!==c&&(g+=1,e[g]=[""],d=e[g],f=0):d[f]+=m;c=m}1===e[e.length-1].length&&""===e[e.length-1][0]&&e.pop();e=new List(e.map(function(n){return new List(n)}));return 1===e.length()?e.at(1):e};
Process.prototype.parseJSON=function(a){function b(c){return c instanceof Array?new List(c.map(function(d){return b(d)})):c instanceof Object?new List(Object.keys(c).map(function(d){return new List([d,b(c[d])])})):c}return b(JSON.parse(a))};Process.prototype.alert=function(a){if(this.homeContext.receiver){var b=this.homeContext.receiver.world();b.isDevMode&&alert("Snap! "+a.asArray())}};
Process.prototype.log=function(a){if(this.homeContext.receiver){var b=this.homeContext.receiver.world();b.isDevMode&&console.log("Snap! "+a.asArray())}};Process.prototype.getOtherObject=function(a,b,c){if(isSnapObject(a))return a;if("myself"===this.inputOption(a))return b;b=isNil(c)?b.parentThatIsA(StageMorph):c;c=null;b&&((c=detect(b.children,function(d){return d.name===a}))||(c=detect(b.world().hand.children,function(d){return d instanceof SpriteMorph&&d.name===a})));return c};
Process.prototype.getObjectsNamed=function(a,b,c){function d(e){return e instanceof SpriteMorph&&e.isTemporary?e.cloneOriginName===a:e.name===a}b=isNil(c)?b.parentThatIsA(StageMorph):c;c=[];b&&(c=b.children.filter(d),c.length||(c=b.world().hand.children.filter(d)));return c};Process.prototype.setHeading=function(a){var b=this.blockReceiver();b&&("random"===this.inputOption(a)&&(a=this.reportBasicRandom(1,36E3)/100),b.setHeading(a))};
Process.prototype.doFaceTowards=function(a){var b=this.blockReceiver();b&&("center"===this.inputOption(a)?b.faceToXY(0,0):"mouse-pointer"===this.inputOption(a)?b.faceToXY(this.reportMouseX(),this.reportMouseY()):"random position"===this.inputOption(a)?b.setHeading(this.reportBasicRandom(1,36E3)/100):a instanceof List?b.faceToXY(a.at(1),a.at(2)):(a=this.getOtherObject(a,this.homeContext.receiver))&&b.faceToXY(a.xPosition(),a.yPosition()))};
Process.prototype.doGotoObject=function(a){var b=this.blockReceiver();b&&("center"===this.inputOption(a)?b.gotoXY(0,0):"mouse-pointer"===this.inputOption(a)?b.gotoXY(this.reportMouseX(),this.reportMouseY()):"random position"===this.inputOption(a)?(a=b.parentThatIsA(StageMorph))&&b.setCenter(new Point(this.reportBasicRandom(a.left(),a.right()),this.reportBasicRandom(a.top(),a.bottom()))):a instanceof List?b.gotoXY(a.at(1),a.at(2)):(a=this.getOtherObject(a,this.homeContext.receiver))&&b.gotoXY(a.xPosition(),
a.yPosition()))};Process.prototype.goToLayer=function(a){a=this.inputOption(a);var b=this.blockReceiver();b instanceof SpriteMorph&&("front"===a?b.comeToFront():"back"===a&&b.goToBack())};Process.prototype.setHSVA=function(a,b){this.blockReceiver().setColorComponentHSVA(["hue","saturation","brightness","transparency"].indexOf(this.inputOption(a)),+b)};
Process.prototype.changeHSVA=function(a,b){this.blockReceiver().changeColorComponentHSVA(["hue","saturation","brightness","transparency"].indexOf(this.inputOption(a)),+b)};Process.prototype.setPenHSVA=Process.prototype.setHSVA;Process.prototype.changePenHSVA=Process.prototype.changeHSVA;Process.prototype.setBackgroundHSVA=Process.prototype.setHSVA;Process.prototype.changeBackgroundHSVA=Process.prototype.changeHSVA;
Process.prototype.doPasteOn=function(a,b,c){var d=this;b=b||this.blockReceiver();c=c||b.parentThatIsA(StageMorph);c.name===a&&(a=c);if(isSnapObject(a))return b.pasteOn(a);(a instanceof List?a.itemsArray():this.getObjectsNamed(a,b,c)).forEach(function(e){return d.doPasteOn(e,b,c)})};Process.prototype.createClone=function(a){var b=this.blockReceiver();a&&!this.readyToTerminate&&b&&("myself"===this.inputOption(a)?b.createClone(!this.isFirstStep):(a=this.getOtherObject(a,b))&&a.createClone(!this.isFirstStep))};
Process.prototype.newClone=function(a){var b=this.blockReceiver();if(a&&b){if("myself"===this.inputOption(a))return b.newClone(!this.isFirstStep);if(a=this.getOtherObject(a,b))return a.newClone(!this.isFirstStep)}};Process.prototype.reportTouchingObject=function(a){var b=this.blockReceiver();return b?this.objectTouchingObject(b,a):!1};
Process.prototype.objectTouchingObject=function(a,b){var c=this;if("mouse-pointer"===this.inputOption(b)){var d=a.world().hand.position();if(a.bounds.containsPoint(d)&&!a.isTransparentAt(d))return!0}else if(d=a.parentThatIsA(StageMorph)){if("edge"===this.inputOption(b)){var e=a.bounds;!a.costume&&a.penBounds&&(e=a.penBounds.translateBy(a.position()));if(!d.bounds.containsRectangle(e))return!0}if("pen trails"===this.inputOption(b)&&a.isTouching(d.penTrailsMorph()))return!0;if(isSnapObject(b))return b.isVisible&&
a.isTouching(b);d=b instanceof List?b.itemsArray():this.getObjectsNamed(b,a,d);if(d.some(function(f){return f.isVisible&&a.isTouching(f)}))return!0}return a.parts.some(function(f){return c.objectTouchingObject(f,b)})};
Process.prototype.reportAspect=function(a,b){a=this.inputOption(a);var c=this.inputOption(b);b=["hue","saturation","brightness","transparency"].indexOf(a);var d=this.blockReceiver(),e=d.parentThatIsA(StageMorph);var f=d.world();if("myself"===c){if("sprites"===a)return c=d instanceof StageMorph?d.center():d.rotationCenter(),this.spritesAtPoint(c,e);e=this.colorAtSprite(d)}else if("mouse-pointer"===c){if("sprites"===a)return this.spritesAtPoint(f.hand.position(),e);e=f.getGlobalPixelColor(f.hand.position())}else if(c instanceof
List){c=new Point(c.at(1)*e.scale+e.center().x,e.center().y-c.at(2)*e.scale);if("sprites"===a)return this.spritesAtPoint(c,e);e=f.getGlobalPixelColor(c)}else if(c&&(f=this.getOtherObject(c,d,e))){if("sprites"===a)return c=f instanceof SpriteMorph?f.rotationCenter():f.center(),this.spritesAtPoint(c,e);e=this.colorAtSprite(f)}else return;if("r-g-b-a"===a)return new List([e.r,e.g,e.b,Math.round(255*e.a)]);if(!(0>b||3<b))return 3===b?100*(1-e.a):100*e.hsv()[b]};
Process.prototype.colorAtSprite=function(a){var b=a instanceof SpriteMorph?a.rotationCenter():a.center(),c=a.parentThatIsA(StageMorph),d;if(!c)return BLACK;for(d=c.children.length;0<d;--d){var e=c.children[d-1];if(e!==a&&e.isVisible&&e.bounds.containsPoint(b)&&!e.isTransparentAt(b))return e.getPixelColor(b)}return c.bounds.containsPoint(b)?c.getPixelColor(b):BLACK};
Process.prototype.colorBelowSprite=function(a){var b=a instanceof SpriteMorph?a.rotationCenter():a.center(),c=a.parentThatIsA(StageMorph),d=c,e=!1,f;if(!c)return BLACK;for(f=0;f<c.children.length;f+=1)if(!e){var g=c.children[f];g===a?e=!0:g.isVisible&&g.bounds.containsPoint(b)&&!g.isTransparentAt(b)&&(d=g)}return d.bounds.containsPoint(b)?d.getPixelColor(b):BLACK};
Process.prototype.spritesAtPoint=function(a,b){return new List(b.children.filter(function(c){return c instanceof SpriteMorph&&c.isVisible&&c.bounds.containsPoint(a)&&!c.isTransparentAt(a)}))};Process.prototype.reportRelationTo=function(a,b){a=this.inputOption(a);return"distance"===a?this.reportDistanceTo(b):"direction"===a?this.reportDirectionTo(b):0};
Process.prototype.reportDistanceTo=function(a){var b=this.blockReceiver(),c;if(b){var d=c=b.rotationCenter();if("mouse-pointer"===this.inputOption(a))d=b.world().hand.position();else{if("center"===this.inputOption(a))return(new Point(b.xPosition(),b.yPosition())).distanceTo(ZERO);if(a instanceof List)return(new Point(b.xPosition(),b.yPosition())).distanceTo(new Point(a.at(1),a.at(2)))}var e=b.parentThatIsA(StageMorph);(a=this.getOtherObject(a,b,e))&&(d=a.rotationCenter());return c.distanceTo(d)/e.scale}return 0};
Process.prototype.reportDirectionTo=function(a){var b=this.blockReceiver();return b?"mouse-pointer"===this.inputOption(a)?b.angleToXY(this.reportMouseX(),this.reportMouseY()):"center"===this.inputOption(a)?b.angleToXY(0,0):a instanceof List?b.angleToXY(a.at(1),a.at(2)):(a=this.getOtherObject(a,this.homeContext.receiver))?b.angleToXY(a.xPosition(),a.yPosition()):b.direction():0};
Process.prototype.reportAttributeOf=function(a,b){var c=this.blockReceiver();if(c){this.assertAlive(c);var d=c.parentThatIsA(StageMorph);if(b=d.name===b?d:this.getOtherObject(b,c,d)){this.assertAlive(b);if(a instanceof BlockMorph)return this.reportContextFor(this.reify(b.getMethod(a.semanticSpec).blockInstance(),new List),b);if(a instanceof Context)return this.reportContextFor(a,b);if(isString(a))return b.variables.getVar(a);switch(this.inputOption(a)){case "x position":return b.xPosition?b.xPosition():
"";case "y position":return b.yPosition?b.yPosition():"";case "direction":return b.direction?b.direction():"";case "costume #":return b.getCostumeIdx();case "costume name":return b.costume?b.costume.name:b instanceof SpriteMorph?localize("Turtle"):localize("Empty");case "size":return b.getScale?b.getScale():"";case "volume":return b.getVolume();case "balance":return b.getPan();case "width":if(b instanceof StageMorph)return b.dimensions.x;this.assertType(b,"sprite");return b.width()/d.scale;case "height":if(b instanceof
StageMorph)return b.dimensions.y;this.assertType(b,"sprite");return b.height()/d.scale;case "left":return b.xLeft();case "right":return b.xRight();case "top":return b.yTop();case "bottom":return b.yBottom()}}}return""};
Process.prototype.reportGet=function(a){var b=this.blockReceiver();if(b)switch(this.inputOption(a)){case "self":return b;case "other sprites":return a=b.parentThatIsA(StageMorph),new List(a.children.filter(function(e){return e instanceof SpriteMorph&&e!==b}));case "parts":return new List((b.parts||[]).map(function(e){return e}));case "anchor":return b.anchor||"";case "parent":return b.exemplar||"";case "children":return new List(b.specimens?b.specimens():[]);case "temporary?":return b.isTemporary||
!1;case "clones":a=b.parentThatIsA(StageMorph);var c=b.name||b.cloneOriginName;return new List(a.children.filter(function(e){return e.isTemporary&&e!==b&&e.cloneOriginName===c}));case "other clones":return b.isTemporary?this.reportGet(["clones"]):new List;case "neighbors":a=b.parentThatIsA(StageMorph);var d=b.bounds.expandBy(new Point(b.width(),b.height()));return new List(a.children.filter(function(e){return e instanceof SpriteMorph&&e!==b&&e.bounds.intersects(d)}));case "dangling?":return!b.rotatesWithAnchor;
case "draggable?":return b.isDraggable;case "rotation style":return b.rotationStyle||0;case "rotation x":return b.xPosition();case "rotation y":return b.yPosition();case "center x":return b.xCenter();case "center y":return b.yCenter();case "left":return b.xLeft();case "right":return b.xRight();case "top":return b.yTop();case "bottom":return b.yBottom();case "name":return b.name;case "stage":return b.parentThatIsA(StageMorph);case "costume":return b.costume;case "costumes":return b.reportCostumes();
case "sounds":return b.sounds;case "width":return b instanceof StageMorph?b.dimensions.x:(a=b.parentThatIsA(StageMorph))?b.width()/a.scale:0;case "height":return b instanceof StageMorph?b.dimensions.y:(a=b.parentThatIsA(StageMorph))?b.height()/a.scale:0}return""};Process.prototype.reportObject=function(a){var b=this.blockReceiver();if(b){this.assertAlive(b);var c=b.parentThatIsA(StageMorph);(a=c.name===a?c:this.getOtherObject(a,b,c))&&this.assertAlive(a);return a}};
Process.prototype.doSet=function(a,b){var c=this.blockReceiver();this.assertAlive(c);if(!(a instanceof Context||a instanceof Array)||a instanceof Context&&"reportGet"!==a.expression.selector)throw Error(localize("unsupported attribute"));a=a instanceof Context?a.expression.inputs()[0].evaluate():a;a instanceof Array&&(a=a[0]);switch(a){case "anchor":this.assertType(c,"sprite");if(b instanceof SpriteMorph){if(!c.enableNesting||contains(c.allParts(),b))throw Error(localize("unable to nest\n(disabled or circular?)"));
b.attachPart(c)}else c.detachFromAnchor();break;case "parent":this.assertType(c,"sprite");b=b instanceof SpriteMorph?b:null;c.setExemplar(b,!0);break;case "temporary?":this.assertType(c,"sprite");this.assertType(b,"Boolean");b?c.release():c.perpetuate();break;case "name":this.assertType(c,["sprite","stage"]);this.assertType(b,["text","number"]);if(a=c.parentThatIsA(IDE_Morph))c.setName(a.newSpriteName(b.toString(),c)),a.spriteBar.nameField.setContents(a.currentSprite.name.toString());break;case "dangling?":this.assertType(c,
"sprite");this.assertType(b,"Boolean");c.rotatesWithAnchor=!b;c.version=Date.now();break;case "draggable?":this.assertType(c,"sprite");this.assertType(b,"Boolean");c.isDraggable=b;(a=c.parentThatIsA(IDE_Morph))&&a.spriteBar.children.forEach(function(d){d.refresh&&d.refresh()});c.version=Date.now();break;case "rotation style":this.assertType(c,"sprite");this.assertType(+b,"number");if(!contains([0,1,2],+b))break;c.changed();c.rotationStyle=+b;c.fixLayout();c.rerender();(a=c.parentThatIsA(IDE_Morph))&&
a.spriteBar.children.forEach(function(d){d.refresh&&d.refresh()});c.version=Date.now();break;case "rotation x":this.assertType(c,"sprite");this.assertType(b,"number");c.setRotationX(b);break;case "rotation y":this.assertType(c,"sprite");this.assertType(b,"number");c.setRotationY(b);break;case "microphone modifier":this.setMicrophoneModifier(b);break;default:throw Error('"'+localize(a)+'" '+localize("is read-only"));}};
Process.prototype.reportContextFor=function(a,b){a=copy(a);a.receiver=b;if(a.outerContext)if(a.outerContext=copy(a.outerContext),a.outerContext.variables=copy(a.outerContext.variables),a.outerContext.receiver=b,a.outerContext.variables.parentFrame){var c=a.outerContext.variables.parentFrame;b=copy(b.variables);b.parentFrame=c;a.outerContext.variables.parentFrame=b}else a.outerContext.variables.parentFrame=b.variables;return a};
Process.prototype.reportMouseX=function(){var a,b;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))&&(b=a.world())?(b.hand.position().x-a.center().x)/a.scale:0};Process.prototype.reportMouseY=function(){var a,b;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))&&(b=a.world())?(a.center().y-b.hand.position().y)/a.scale:0};
Process.prototype.reportMouseDown=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.world())?"left"===a.hand.mouseButton:!1};Process.prototype.reportKeyPressed=function(a){var b;return this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(StageMorph))?"any key"===this.inputOption(a)?0<Object.keys(b.keysPressed).length:void 0!==b.keysPressed[a]:!1};
Process.prototype.doResetTimer=function(){var a;this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))&&a.resetTimer()};Process.prototype.reportTimer=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))?a.getTimer():0};
Process.prototype.reportDate=function(a){a=this.inputOption(a);var b={year:"getFullYear",month:"getMonth",date:"getDate","day of week":"getDay",hour:"getHours",minute:"getMinutes",second:"getSeconds","time in milliseconds":"getTime"};if(!b[a])return"";b=(new Date)[b[a]]();if("month"===a||"day of week"===a)b+=1;return b};
Process.prototype.doSetVideoTransparency=function(a){var b;this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(StageMorph))&&(b.projectionTransparency=Math.max(0,Math.min(100,a)))};
Process.prototype.reportVideo=function(a,b){var c=this.blockReceiver(),d=c.parentThatIsA(StageMorph);b=this.getOtherObject(b,c,d);if(d.projectionSource&&d.projectionSource.stream){switch(this.inputOption(a)){case "motion":if(b instanceof SpriteMorph)return d.videoMotion.getLocalMotion(b),b.motionAmount;d.videoMotion.getStageMotion();return d.videoMotion.motionAmount;case "direction":if(b instanceof SpriteMorph)return d.videoMotion.getLocalMotion(b),b.motionDirection;d.videoMotion.getStageMotion();
return d.videoMotion.motionDirection;case "snap":return b instanceof SpriteMorph?b.projectionSnap():d.projectionSnap()}return-1}this.context.accumulator||(this.context.accumulator=!0,d.startVideo());this.pushContext("doYield");this.pushContext()};Process.prototype.startVideo=function(a){this.reportGlobalFlag("video capture")||(a.projectionSource&&a.projectionSource.stream||this.context.accumulator||(this.context.accumulator=!0,a.startVideo()),this.pushContext("doYield"),this.pushContext())};
Process.prototype.doMapCodeOrHeader=function(a,b,c){if("code"===this.inputOption(b))return this.doMapCode(a,c);if("header"===this.inputOption(b))return this.doMapHeader(a,c);throw Error(" '"+b+"'\nis not a valid option");};Process.prototype.doMapHeader=function(a,b){if(a instanceof Context&&a.expression instanceof SyntaxElementMorph)return a.expression.mapHeader(b||"")};
Process.prototype.doMapCode=function(a,b){if(a instanceof Context&&a.expression instanceof SyntaxElementMorph)return a.expression.mapCode(b||"")};
Process.prototype.doMapValueCode=function(a,b){a=this.inputOption(a);switch(a){case "String":StageMorph.prototype.codeMappings.string=b||"<#1>";break;case "Number":StageMorph.prototype.codeMappings.number=b||"<#1>";break;case "true":StageMorph.prototype.codeMappings.boolTrue=b||"true";break;case "false":StageMorph.prototype.codeMappings.boolFalse=b||"true";break;default:throw Error(localize("unsupported data type")+" "+a);}};
Process.prototype.doMapListCode=function(a,b,c){var d="",e="delim";"parameters"===this.inputOption(b)?d="parms_":"variables"===this.inputOption(b)&&(d="tempvars_");"list"===this.inputOption(a)?e="list":"item"===this.inputOption(a)&&(e="item");StageMorph.prototype.codeMappings[d+e]=c||""};Process.prototype.reportMappedCode=function(a){return a instanceof Context&&a.expression instanceof SyntaxElementMorph?a.expression.mappedCode():""};
Process.prototype.doRest=function(a){var b=this.reportTempo();this.doWait(60/b*a)};Process.prototype.reportTempo=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))?a.getTempo():0};Process.prototype.doChangeTempo=function(a){var b;this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(StageMorph))&&b.changeTempo(a)};
Process.prototype.doSetTempo=function(a){var b;this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(StageMorph))&&b.setTempo(a)};Process.prototype.doPlayNote=function(a,b){var c=this.reportTempo();this.doPlayNoteForSecs(parseFloat(a||"0"),60/c*parseFloat(b||"0"))};
Process.prototype.doPlayNoteForSecs=function(a,b){var c=this.blockReceiver();this.context.startTime||(c.setVolume(c.getVolume()),c.setPan(c.getPan()),this.context.startTime=Date.now(),this.context.activeNote=new Note(a),this.context.activeNote.play(this.instrument,c.getGainNode(),c.getPannerNode()));if(Date.now()-this.context.startTime>=1E3*b)return this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doPlayFrequency=function(a,b){this.doPlayFrequencyForSecs(parseFloat(a||"0"),parseFloat(b||"0"))};
Process.prototype.doPlayFrequencyForSecs=function(a,b){this.context.startTime||(this.context.startTime=Date.now(),this.context.activeNote=new Note,this.context.activeNote.frequency=a,this.context.activeNote.play(this.instrument));if(Date.now()-this.context.startTime>=1E3*b)return this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doSetInstrument=function(a){this.instrument=+a;this.receiver.instrument=+a;this.receiver.freqPlayer&&this.receiver.freqPlayer.setInstrument(+a)};Process.prototype.reportGetImageAttribute=function(a,b){b=this.costumeNamed(b)||new Costume;switch(this.inputOption(a)){case "name":return b.name;case "width":return b.width();case "height":return b.height();case "pixels":return b.rasterized().pixels();default:return b}};
Process.prototype.reportNewCostumeStretched=function(a,b,c){if(a instanceof List)return this.reportNewCostume(a,b,c);a=this.costumeNamed(a);if(!a)return new Costume;if(!isFinite(+b*+c)||isNaN(+b*+c))throw Error("expecting a finite number\nbut getting Infinity or NaN");return a.stretched(Math.round(a.width()*+b/100),Math.round(a.height()*+c/100))};
Process.prototype.costumeNamed=function(a){return a instanceof Costume?a:"number"===typeof a?this.blockReceiver().costumes.at(a):"current"===this.inputOption(a)?this.blockReceiver().costume:detect(this.blockReceiver().costumes.asArray(),function(b){return b.name===a.toString()})};
Process.prototype.reportNewCostume=function(a,b,c,d){var e;this.assertType(a,"list");if("current"===this.inputOption(b)){var f=this.blockReceiver();var g=f.parentThatIsA(StageMorph);b=f.costume?f.costume.width():g.dimensions.x}"current"===this.inputOption(c)&&(f=f||this.blockReceiver(),g=g||f.parentThatIsA(StageMorph),c=f.costume?f.costume.height():g.dimensions.y);b=Math.abs(Math.floor(+b));c=Math.abs(Math.floor(+c));if(0>=b||0>=c)return new Costume;if(!isFinite(b*c)||isNaN(b*c))throw Error("expecting a finite number\nbut getting Infinity or NaN");
g=newCanvas(new Point(b,c),!0);var h=g.getContext("2d");a=a.asArray();b=h.createImageData(b,c);for(c=0;c<a.length;c+=1){var k=a[c].asArray();for(e=0;4>e;e+=1)b.data[4*c+e]=k[e]}h.putImageData(b,0,0);return new Costume(g,d||(f||this.blockReceiver()).newCostumeName(localize("costume")))};
Process.prototype.reportPentrailsAsSVG=function(){if(!this.context.accumulator){var a=this.homeContext.receiver.parentThatIsA(StageMorph);if(!a.trailsLog.length)throw Error(localize("there are currently no\nvectorizable pen trail segments"));a=a.trailsLogAsSVG();this.context.accumulator={img:new Image,rot:a.rot,ready:!1};var b=this.context.accumulator;b.img.onload=function(){return b.ready=!0};b.img.src="data:image/svg+xml,"+a.src;b.img.rot=a.rotationShift}else if(this.context.accumulator.ready){var c=
ZERO;a=this.blockReceiver();a instanceof SpriteMorph&&(c=new Point(a.xPosition(),-a.yPosition()));this.returnValueToParentContext(new SVG_Costume(this.context.accumulator.img,this.blockReceiver().newCostumeName(localize("Costume")),this.context.accumulator.rot.translateBy(c)));return}this.pushContext()};Process.prototype.inputOption=function(a){return a instanceof Array?a[0]:a};
Process.prototype.pushContext=function(a,b){this.context=new Context(this.context,a,b||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver)};Process.prototype.popContext=function(){this.context&&this.context.stopMusic();this.context=this.context?this.context.parentContext:null};Process.prototype.returnValueToParentContext=function(a){void 0!==a&&(this.context?this.context.parentContext||this.homeContext:this.homeContext).addInput(a)};
Process.prototype.reportStackSize=function(){return this.context?this.context.stackSize():0};Process.prototype.reportFrameCount=function(){return this.frameCount};
Process.prototype.flashContext=function(){var a=this.context.expression;return!(this.enableSingleStepping&&!this.isAtomic&&a instanceof SyntaxElementMorph)||a instanceof CommandSlotMorph||this.context.isFlashing||!a.world()||a instanceof ColorSlotMorph?!1:(this.unflash(),a.flash(),this.context.isFlashing=!0,this.flashingContext=this.context,0<this.flashTime&&.5>=this.flashTime?(this.pushContext("doIdle"),this.context.addInput(this.flashTime)):this.pushContext("doInterrupt"),!0)};
Process.prototype.flashPausedContext=function(){var a=this.context?this.context.lastFlashable():null;a&&(this.unflash(),a.expression.flash(),a.isFlashing=!0,this.flashingContext=a)};Process.prototype.doInterrupt=function(){this.popContext();this.isAtomic||(this.isInterrupted=!0)};Process.prototype.doIdle=function(a){this.context.startTime||(this.context.startTime=Date.now());Date.now()-this.context.startTime<1E3*a?this.pushContext("doInterrupt"):this.popContext()};
Process.prototype.unflash=function(){this.flashingContext&&(this.flashingContext.expression.unflash(),this.flashingContext.isFlashing=!1,this.flashingContext=null)};Process.prototype.reportCompiled=function(a,b){return(new JSCompiler(this)).compileFunction(a,b)};
Process.prototype.capture=function(a){var b=new Process(this.topBlock,this.receiver),c=new Context(a.parentContext,a.expression,a.outerContext,a.receiver);c.variables=a.variables.fullCopy();c.variables.root().parentFrame=b.variables;b.context=c;return b};
Process.prototype.getVarNamed=function(a){var b=this.homeContext.variables.silentFind(a)||this.context.variables.silentFind(a);if(b)return a=b.vars[a].value,0===a?0:!1===a?!1:""===a?"":a||0;throw Error(localize("a variable of name '")+a+localize("'\ndoes not exist in this context"));};
Process.prototype.setVarNamed=function(a,b){var c=this.homeContext.variables.silentFind(a)||this.context.variables.silentFind(a);if(isNil(c))throw Error(localize("a variable of name '")+a+localize("'\ndoes not exist in this context"));c.vars[a].value=b};Process.prototype.incrementVarNamed=function(a,b){this.setVarNamed(a,this.getVarNamed(a)+ +b)};
Process.prototype.reportAtomicMap=function(a,b){this.assertType(b,"list");var c=[],d=b.asArray(),e=d.length,f=a.inputs.length,g;try{var h=this.reportCompiled(a,1)}catch(l){console.log(l.message),h=a}for(g=0;g<e;g+=1){var k=[d[g]];1<f&&k.push(g+1);2<f&&k.push(b);c.push(invoke(h,new List(k),null,null,null,null,this.capture(a)))}return new List(c)};
Process.prototype.reportAtomicKeep=function(a,b){this.assertType(b,"list");var c=[],d=b.asArray(),e=d.length,f=a.inputs.length,g;try{var h=this.reportCompiled(a,1)}catch(l){console.log(l.message),h=a}for(g=0;g<e;g+=1){var k=[d[g]];1<f&&k.push(g+1);2<f&&k.push(b);invoke(h,new List(k),null,null,null,null,this.capture(a))&&c.push(d[g])}return new List(c)};
Process.prototype.reportAtomicFindFirst=function(a,b){this.assertType(b,"list");var c=b.asArray(),d=c.length,e=a.inputs.length,f;try{var g=this.reportCompiled(a,1)}catch(k){console.log(k.message),g=a}for(f=0;f<d;f+=1){var h=[c[f]];1<e&&h.push(f+1);2<e&&h.push(b);if(invoke(g,new List(h),null,null,null,null,this.capture(a)))return c[f]}return!1};
Process.prototype.reportAtomicCombine=function(a,b){this.assertType(a,"list");var c="",d=a.asArray(),e=d.length,f=b.inputs.length,g;if(0===e)return c;c=d[0];try{var h=this.reportCompiled(b,2)}catch(k){console.log(k.message),h=b}for(g=1;g<e;g+=1)c=[c,d[g]],2<f&&c.push(g+1),3<f&&c.push(a),c=invoke(h,new List(c),null,null,null,null,this.capture(b));return c};
Process.prototype.reportAtomicSort=function(a,b){var c=this;this.assertType(a,"list");try{var d=this.reportCompiled(b,2)}catch(e){console.log(e.message),d=b}return new List(a.asArray().slice().sort(function(e,f){return invoke(d,new List([e,f]),null,null,null,null,c.capture(b))?-1:1}))};
Process.prototype.reportAtomicGroup=function(a,b){this.assertType(a,"list");var c=[],d=new Map,e=a.asArray(),f=e.length,g;try{var h=this.reportCompiled(b,1)}catch(k){console.log(k.message),h=b}for(g=0;g<f;g+=1)a=invoke(h,new List([e[g]]),null,null,null,null,this.capture(b)),d.has(a)?d.get(a).push(e[g]):d.set(a,[e[g]]);d.forEach(function(k,l){return c.push(new List([l,k.length,new List(k)]))});return new List(c)};
function Context(a,b,c,d){this.outerContext=c||null;this.parentContext=a||null;this.expression=b||null;this.receiver=d||null;this.origin=d||null;this.variables=new VariableFrame;this.outerContext&&(this.variables.parentFrame=this.outerContext.variables,this.receiver=this.outerContext.receiver);this.inputs=[];this.pc=0;this.isContinuation=!1;this.activeNote=this.activeAudio=this.activeSends=this.startTime=null;this.isCustomBlock=!1;this.isCustomCommand=null;this.emptySlots=0;this.tag=null;this.isFlashing=
!1;this.accumulator=null}Context.prototype.toString=function(){var a=this.expression;a instanceof Array&&0<a.length&&(a="["+a[0]+"]");return"Context >> "+a+" "+this.variables};
Context.prototype.blockify=function(){var a=new RingMorph,b;if(this.expression instanceof Morph){var c=this.expression.fullCopy();this.isContinuation&&(b=detect(c.allInputs(),function(d){return 1===d.bindingID}))&&c.revertToDefaultInput(b,!0);a.embed(c,this.inputs);return a}if(this.expression instanceof Array){c=this.expression[this.pc].fullCopy();if(c instanceof RingMorph&&!c.contents())return c;a.embed(c,this.isContinuation?[]:this.inputs);return a}a.color=SpriteMorph.prototype.blockColor.other;
a.setSpec("%rc %ringparms");this.isContinuation||this.inputs.forEach(function(d){return a.parts()[1].addInput(d)});return a};Context.prototype.image=function(){var a=this.blockify();return a.doWithAlpha(1,function(){return a.fullImage()})};
Context.prototype.continuation=function(a){if(this.expression instanceof Array)a=this;else if(this.parentContext)a=this.parentContext;else return a=new Context(null,a?"expectReport":"popContext"),a.isContinuation=!0,a;a=a.copyForContinuation();a.tag=null;a.isContinuation=!0;return a};
Context.prototype.copyForContinuation=function(){var a=copy(this),b=a;if(!(this.expression instanceof Array||isString(this.expression)))for(b.prepareContinuationForBinding();b.parentContext;)b.parentContext=copy(b.parentContext),b=b.parentContext,b.inputs=[];return a};
Context.prototype.copyForContinuationCall=function(){var a=copy(this),b=a;if(!(this.expression instanceof Array||isString(this.expression)))for(this.expression=this.expression.fullCopy(),this.inputs=[];b.parentContext;)b.parentContext=copy(b.parentContext),b=b.parentContext,b.inputs=[];return a};Context.prototype.prepareContinuationForBinding=function(){var a=this.inputs.length;this.expression=this.expression.fullCopy();if(a=this.expression.inputs()[a])this.inputs=[],this.emptySlots=a.bindingID=1};
Context.prototype.addInput=function(a){this.inputs.push(a)};Context.prototype.stopMusic=function(){this.activeNote&&(this.activeNote.stop(),this.activeNote=null)};Context.prototype.lastFlashable=function(){return this.expression instanceof SyntaxElementMorph&&!(this.expression instanceof CommandSlotMorph)?this:this.parentContext?this.parentContext.lastFlashable():null};Context.prototype.stackSize=function(){return this.parentContext?1+this.parentContext.stackSize():1};
function Variable(a,b){this.value=a;this.isTransient=b||!1}Variable.prototype.toString=function(){return"a "+(this.isTransient?"transient ":"")+"Variable ["+this.value+"]"};Variable.prototype.copy=function(){return new Variable(this.value,this.isTransient)};function VariableFrame(a,b){this.vars={};this.parentFrame=a||null;this.owner=b||null}VariableFrame.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}"};
VariableFrame.prototype.copy=function(){var a=this,b=new VariableFrame(this.parentFrame);this.names().forEach(function(c){return b.addVar(c,a.getVar(c))});return b};VariableFrame.prototype.fullCopy=function(){var a=this.parentFrame?new VariableFrame(this.parentFrame.fullCopy()):new VariableFrame;a.vars=copy(this.vars);return a};VariableFrame.prototype.root=function(){return this.parentFrame?this.parentFrame.root():this};
VariableFrame.prototype.find=function(a){var b=this.silentFind(a);if(b)return b;throw Error(localize("a variable of name '")+a+localize("'\ndoes not exist in this context"));};VariableFrame.prototype.silentFind=function(a){return this.vars[a]instanceof Variable?this:this.parentFrame?this.parentFrame.silentFind(a):null};VariableFrame.prototype.setVar=function(a,b,c){var d=this.find(a);d&&(c instanceof SpriteMorph&&d.owner instanceof SpriteMorph&&c!==d.owner?c.shadowVar(a,b):d.vars[a].value=b)};
VariableFrame.prototype.changeVar=function(a,b,c){var d=this.find(a);if(d){var e=parseFloat(d.vars[a].value);b=isNaN(e)?b:e+parseFloat(b);c instanceof SpriteMorph&&d.owner instanceof SpriteMorph&&c!==d.owner?c.shadowVar(a,b):d.vars[a].value=b}};
VariableFrame.prototype.getVar=function(a){var b=this.silentFind(a);if(b)return a=b.vars[a].value,0===a?0:!1===a?!1:""===a?"":a||0;if("number"===typeof a)return"";throw Error(localize("a variable of name '")+a+localize("'\ndoes not exist in this context"));};VariableFrame.prototype.addVar=function(a,b){this.vars[a]=new Variable(0===b?0:!1===b?!1:""===b?"":b||0)};VariableFrame.prototype.deleteVar=function(a){var b=this.find(a);b&&delete b.vars[a]};
VariableFrame.prototype.names=function(){var a,b=[];for(a in this.vars)Object.prototype.hasOwnProperty.call(this.vars,a)&&b.push(a);return b};VariableFrame.prototype.allNamesDict=function(a){for(var b={},c=this;c&&c!==a;){var d=void 0,e=c.vars,f=b;for(d in e)Object.prototype.hasOwnProperty.call(e,d)&&(f[d]=d);c=c.parentFrame}return b};VariableFrame.prototype.allNames=function(a){var b=[],c;a=this.allNamesDict(a);for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&b.push(c);return b};
function JSCompiler(a){this.process=a;this.paramCount=this.implicitParams=this.gensyms=this.source=null}JSCompiler.prototype.toString=function(){return"a JSCompiler"};
JSCompiler.prototype.compileFunction=function(a,b){var c=this,d=a.expression,e=a.inputs,f=[],g=!1;this.source=a;this.implicitParams=b||1;g=!isNil(detect(d.allChildren(),function(h){return h.isEmptySlot&&h.isEmptySlot()}));this.gensyms={};this.paramCount=0;if(e.length){if(g)throw Error("compiling does not yet support\nmixing explicit formal parameters\nwith empty input slots");e.forEach(function(h,k){k="p"+k;f.push(k);c.gensyms[h]=k})}else if(g)if(1<this.implicitParams)for(a=0;a<this.implicitParams;a+=
1)f.push("p"+a);else f=["p0"];return d instanceof CommandBlockMorph?Function.apply(null,f.concat([this.compileSequence(d)])):Function.apply(null,f.concat(["return "+this.compileExpression(d)]))};
JSCompiler.prototype.compileExpression=function(a){var b=a.selector,c=a.inputs();switch(b){case "reportOr":return this.compileInfix("||",c);case "reportAnd":return this.compileInfix("&&",c);case "reportIfElse":return"("+this.compileInput(c[0])+" ? "+this.compileInput(c[1])+" : "+this.compileInput(c[2])+")";case "evaluateCustomBlock":throw Error("compiling does not yet support\ncustom blocks");case "doSetVar":return"arguments[arguments.length - 1].setVarNamed("+this.compileInput(c[0])+","+this.compileInput(c[1])+
")";case "doChangeVar":return"arguments[arguments.length - 1].incrementVarNamed("+this.compileInput(c[0])+","+this.compileInput(c[1])+")";case "doReport":return"return "+this.compileInput(c[0]);case "doIf":return"if ("+this.compileInput(c[0])+") {\n"+this.compileSequence(c[1].evaluate())+"}";case "doIfElse":return"if ("+this.compileInput(c[0])+") {\n"+this.compileSequence(c[1].evaluate())+"} else {\n"+this.compileSequence(c[2].evaluate())+"}";default:a=this.process[b]?this.process:this.source.receiver||
this.process.receiver;var d=a.constructor.name+".prototype";c=this.compileInputs(c);return isSnapObject(a)?d+"."+b+".apply("+d+", ["+c+"])":"arguments[arguments.length - 1]."+b+".apply(arguments[arguments.length - 1], ["+c+"])"}};JSCompiler.prototype.compileSequence=function(a){var b=this,c="";a.blockSequence().forEach(function(d){c+=b.compileExpression(d);c+=";\n"});return c};JSCompiler.prototype.compileInfix=function(a,b){return"("+this.compileInput(b[0])+" "+a+" "+this.compileInput(b[1])+")"};
JSCompiler.prototype.compileInputs=function(a){var b=this,c="";a.forEach(function(d){c.length&&(c+=", ");c+=b.compileInput(d)});return c};
JSCompiler.prototype.compileInput=function(a){if(a.isEmptySlot&&a.isEmptySlot()){if(1<this.implicitParams){if(this.paramCount<this.implicitParams)return this.paramCount+=1,"p"+(this.paramCount-1);throw Error(localize("expecting")+" "+this.implicitParams+" "+localize("input(s), but getting")+" "+this.paramCount);}return"p0"}if(a instanceof MultiArgMorph)return"new List(["+this.compileInputs(a.inputs())+"])";if(a instanceof ArgLabelMorph)return this.compileInput(a.argMorph());if(a instanceof ArgMorph){a=
a.evaluate();var b=this.process.reportTypeOf(a);switch(b){case "number":case "Boolean":return""+a;case "text":return'"'+a+'"';case "list":return"new List(["+this.compileInputs(a)+"])";default:if(a instanceof Array)return'"'+a[0]+'"';throw Error("compiling does not yet support\ninputs of type\n"+b);}}else{if(a instanceof BlockMorph)return"reportGetVar"===a.selector?contains(this.source.inputs,a.blockSpec)?this.gensyms[a.blockSpec]:'arguments[arguments.length - 1].getVarNamed("'+a.blockSpec+'")':this.compileExpression(a);
throw Error("compiling does not yet support\ninput slots of type\n"+a.constructor.name);}};modules.objects="2020-August-07";function isSnapObject(a){return a instanceof SpriteMorph||a instanceof StageMorph}SpriteMorph.prototype=new PenMorph;SpriteMorph.prototype.constructor=SpriteMorph;SpriteMorph.uber=PenMorph.prototype;SpriteMorph.prototype.attributes="x position;y position;direction;size;costumes;costume #;volume;balance;sounds;shown?;pen down?;scripts".split(";");
SpriteMorph.prototype.categories="motion control looks sensing sound operators pen variables lists other".split(" ");SpriteMorph.prototype.blockColor={motion:new Color(74,108,212),looks:new Color(143,86,227),sound:new Color(207,74,217),pen:new Color(0,161,120),control:new Color(230,168,34),sensing:new Color(4,148,220),operators:new Color(98,194,19),variables:new Color(243,118,29),lists:new Color(217,77,17),other:new Color(150,150,150)};SpriteMorph.prototype.paletteColor=new Color(55,55,55);
SpriteMorph.prototype.paletteTextColor=new Color(230,230,230);SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30);SpriteMorph.prototype.isCachingPrimitives=!0;SpriteMorph.prototype.enableNesting=!0;SpriteMorph.prototype.enableFirstClass=!0;SpriteMorph.prototype.useFlatLineEnds=!1;SpriteMorph.prototype.highlightColor=new Color(250,200,130);SpriteMorph.prototype.highlightBorder=8;SpriteMorph.prototype.bubbleColor=WHITE;SpriteMorph.prototype.bubbleFontSize=14;
SpriteMorph.prototype.bubbleFontIsBold=!0;SpriteMorph.prototype.bubbleCorner=10;SpriteMorph.prototype.bubbleBorder=3;SpriteMorph.prototype.bubbleBorderColor=new Color(190,190,190);SpriteMorph.prototype.bubbleMaxTextWidth=130;
SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype.blocks={forward:{only:SpriteMorph,type:"command",category:"motion",spec:"move %n steps",defaults:[10]},turn:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %clockwise %n degrees",defaults:[15]},turnLeft:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %counterclockwise %n degrees",defaults:[15]},setHeading:{only:SpriteMorph,type:"command",category:"motion",spec:"point in direction %dir"},doFaceTowards:{only:SpriteMorph,
type:"command",category:"motion",spec:"point towards %dst"},gotoXY:{only:SpriteMorph,type:"command",category:"motion",spec:"go to x: %n y: %n",defaults:[0,0]},doGotoObject:{only:SpriteMorph,type:"command",category:"motion",spec:"go to %dst"},doGlide:{only:SpriteMorph,type:"command",category:"motion",spec:"glide %n secs to x: %n y: %n",defaults:[1,0,0]},changeXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change x by %n",defaults:[10]},setXPosition:{only:SpriteMorph,type:"command",
category:"motion",spec:"set x to %n",defaults:[0]},changeYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change y by %n",defaults:[10]},setYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set y to %n",defaults:[0]},bounceOffEdge:{only:SpriteMorph,type:"command",category:"motion",spec:"if on edge, bounce"},xPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"x position"},yPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"y position"},
direction:{only:SpriteMorph,type:"reporter",category:"motion",spec:"direction"},doSwitchToCostume:{type:"command",category:"looks",spec:"switch to costume %cst"},doWearNextCostume:{type:"command",category:"looks",spec:"next costume"},getCostumeIdx:{type:"reporter",category:"looks",spec:"costume #"},reportGetImageAttribute:{type:"reporter",category:"looks",spec:"%img of costume %cst",defaults:[["width"]]},reportNewCostume:{type:"reporter",category:"looks",spec:"new costume %l width %dim height %dim"},
reportNewCostumeStretched:{type:"reporter",category:"looks",spec:"stretch %cst x: %n y: %n %",defaults:["",100,50]},doSayFor:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s for %n secs",defaults:[localize("Hello!"),2]},bubble:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s",defaults:[localize("Hello!")]},doThinkFor:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s for %n secs",defaults:[localize("Hmm..."),2]},doThink:{only:SpriteMorph,type:"command",category:"looks",
spec:"think %s",defaults:[localize("Hmm...")]},changeEffect:{type:"command",category:"looks",spec:"change %eff effect by %n",defaults:[null,25]},setEffect:{type:"command",category:"looks",spec:"set %eff effect to %n",defaults:[null,0]},getEffect:{type:"reporter",category:"looks",spec:"%eff effect"},clearEffects:{type:"command",category:"looks",spec:"clear graphic effects"},changeScale:{only:SpriteMorph,type:"command",category:"looks",spec:"change size by %n",defaults:[10]},setScale:{only:SpriteMorph,
type:"command",category:"looks",spec:"set size to %n %",defaults:[100]},getScale:{only:SpriteMorph,type:"reporter",category:"looks",spec:"size"},show:{type:"command",category:"looks",spec:"show"},hide:{type:"command",category:"looks",spec:"hide"},reportShown:{type:"predicate",category:"looks",spec:"shown?"},goToLayer:{only:SpriteMorph,type:"command",category:"looks",spec:"go to %layer layer",defaults:[["front"]]},goBack:{only:SpriteMorph,type:"command",category:"looks",spec:"go back %n layers",defaults:[1]},
reportCostumes:{dev:!0,type:"reporter",category:"looks",spec:"wardrobe"},alert:{dev:!0,type:"command",category:"looks",spec:"alert %mult%s"},log:{dev:!0,type:"command",category:"looks",spec:"console log %mult%s"},playSound:{type:"command",category:"sound",spec:"play sound %snd"},doPlaySoundUntilDone:{type:"command",category:"sound",spec:"play sound %snd until done"},doPlaySoundAtRate:{type:"command",category:"sound",spec:"play sound %snd at %rate Hz",defaults:["",44100]},doStopAllSounds:{type:"command",
category:"sound",spec:"stop all sounds"},reportGetSoundAttribute:{type:"reporter",category:"sound",spec:"%aa of sound %snd",defaults:[["duration"]]},reportNewSoundFromSamples:{type:"reporter",category:"sound",spec:"new sound %l rate %rate Hz",defaults:[null,44100]},doRest:{type:"command",category:"sound",spec:"rest for %n beats",defaults:[.2]},doPlayNote:{type:"command",category:"sound",spec:"play note %note for %n beats",defaults:[60,.5]},doPlayFrequency:{dev:!0,type:"command",category:"sound",spec:"play %n Hz for %n secs",
defaults:[440,2]},doSetInstrument:{type:"command",category:"sound",spec:"set instrument to %inst",defaults:[1]},doChangeTempo:{type:"command",category:"sound",spec:"change tempo by %n",defaults:[20]},doSetTempo:{type:"command",category:"sound",spec:"set tempo to %n bpm",defaults:[60]},getTempo:{type:"reporter",category:"sound",spec:"tempo"},changeVolume:{type:"command",category:"sound",spec:"change volume by %n",defaults:[10]},setVolume:{type:"command",category:"sound",spec:"set volume to %n %",defaults:[100]},
getVolume:{type:"reporter",category:"sound",spec:"volume"},changePan:{type:"command",category:"sound",spec:"change balance by %n",defaults:[10]},setPan:{type:"command",category:"sound",spec:"set balance to %n",defaults:[0]},getPan:{type:"reporter",category:"sound",spec:"balance"},playFreq:{type:"command",category:"sound",spec:"play frequency %n Hz",defaults:[440]},stopFreq:{type:"command",category:"sound",spec:"stop frequency"},reportSounds:{dev:!0,type:"reporter",category:"sound",spec:"jukebox"},
clear:{type:"command",category:"pen",spec:"clear"},down:{only:SpriteMorph,type:"command",category:"pen",spec:"pen down"},up:{only:SpriteMorph,type:"command",category:"pen",spec:"pen up"},getPenDown:{only:SpriteMorph,type:"predicate",category:"pen",spec:"pen down?"},setColor:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %clr"},setPenHSVA:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen %hsva to %n",defaults:[["hue"],50]},changePenHSVA:{only:SpriteMorph,type:"command",
category:"pen",spec:"change pen %hsva by %n",defaults:[["hue"],10]},getPenAttribute:{type:"reporter",category:"pen",spec:"pen %pen",defaults:[["hue"]]},setBackgroundColor:{only:StageMorph,type:"command",category:"pen",spec:"set background color to %clr"},setBackgroundHSVA:{only:StageMorph,type:"command",category:"pen",spec:"set background %hsva to %n",defaults:[["hue"],50]},changeBackgroundHSVA:{only:StageMorph,type:"command",category:"pen",spec:"change background %hsva by %n",defaults:[["hue"],10]},
changeSize:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen size by %n",defaults:[1]},setSize:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen size to %n",defaults:[1]},doStamp:{only:SpriteMorph,type:"command",category:"pen",spec:"stamp"},floodFill:{only:SpriteMorph,type:"command",category:"pen",spec:"fill"},write:{only:SpriteMorph,type:"command",category:"pen",spec:"write %s size %n",defaults:[localize("Hello!"),12]},reportPenTrailsAsCostume:{type:"reporter",category:"pen",
spec:"pen trails"},reportPentrailsAsSVG:{type:"reporter",category:"pen",spec:"pen vectors"},doPasteOn:{type:"command",category:"pen",spec:"paste on %spr"},receiveGo:{type:"hat",category:"control",spec:"when %greenflag clicked"},receiveKey:{type:"hat",category:"control",spec:"when %keyHat key pressed"},receiveInteraction:{type:"hat",category:"control",spec:"when I am %interaction",defaults:["clicked"]},receiveMessage:{type:"hat",category:"control",spec:"when I receive %msgHat"},receiveCondition:{type:"hat",
category:"control",spec:"when %b"},doBroadcast:{type:"command",category:"control",spec:"broadcast %msg"},doBroadcastAndWait:{type:"command",category:"control",spec:"broadcast %msg and wait"},getLastMessage:{type:"reporter",category:"control",spec:"message"},doSend:{type:"command",category:"control",spec:"send %msg to %spr"},doWait:{type:"command",category:"control",spec:"wait %n secs",defaults:[1]},doWaitUntil:{type:"command",category:"control",spec:"wait until %b"},doForever:{type:"command",category:"control",
spec:"forever %loop"},doRepeat:{type:"command",category:"control",spec:"repeat %n %loop",defaults:[10]},doUntil:{type:"command",category:"control",spec:"repeat until %b %loop"},doFor:{type:"command",category:"control",spec:"for %upvar = %n to %n %cla",defaults:["i",1,10]},doIf:{type:"command",category:"control",spec:"if %b %c"},doIfElse:{type:"command",category:"control",spec:"if %b %c else %c"},reportIfElse:{type:"reporter",category:"control",spec:"if %b then %s else %s"},doStopThis:{type:"command",
category:"control",spec:"stop %stopChoices"},doRun:{type:"command",category:"control",spec:"run %cmdRing %inputs"},fork:{type:"command",category:"control",spec:"launch %cmdRing %inputs"},evaluate:{type:"reporter",category:"control",spec:"call %repRing %inputs"},doReport:{type:"command",category:"control",spec:"report %s"},doCallCC:{type:"command",category:"control",spec:"run %cmdRing w/continuation"},reportCallCC:{type:"reporter",category:"control",spec:"call %cmdRing w/continuation"},doWarp:{type:"command",
category:"other",spec:"warp %c"},doTellTo:{type:"command",category:"control",spec:"tell %spr to %cmdRing %inputs"},reportAskFor:{type:"reporter",category:"control",spec:"ask %spr for %repRing %inputs"},receiveOnClone:{type:"hat",category:"control",spec:"when I start as a clone"},createClone:{type:"command",category:"control",spec:"create a clone of %cln"},newClone:{type:"reporter",category:"control",spec:"a new clone of %cln",defaults:[["myself"]]},removeClone:{type:"command",category:"control",spec:"delete this clone"},
doPauseAll:{type:"command",category:"control",spec:"pause all %pause"},reportTouchingObject:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %col ?"},reportTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %clr ?"},reportColorIsTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"color %clr is touching %clr ?"},reportAspect:{type:"reporter",category:"sensing",spec:"%asp at %loc",defaults:[["hue"]]},reportStackSize:{dev:!0,type:"reporter",
category:"sensing",spec:"stack size"},reportFrameCount:{dev:!0,type:"reporter",category:"sensing",spec:"frames"},reportThreadCount:{dev:!0,type:"reporter",category:"sensing",spec:"processes"},doAsk:{type:"command",category:"sensing",spec:"ask %s and wait",defaults:[localize("what's your name?")]},reportLastAnswer:{dev:!0,type:"reporter",category:"sensing",spec:"answer"},getLastAnswer:{type:"reporter",category:"sensing",spec:"answer"},reportMouseX:{type:"reporter",category:"sensing",spec:"mouse x"},
reportMouseY:{type:"reporter",category:"sensing",spec:"mouse y"},reportMouseDown:{type:"predicate",category:"sensing",spec:"mouse down?"},reportKeyPressed:{type:"predicate",category:"sensing",spec:"key %key pressed?"},reportRelationTo:{only:SpriteMorph,type:"reporter",category:"sensing",spec:"%rel to %dst",defaults:[["distance"]]},doResetTimer:{type:"command",category:"sensing",spec:"reset timer"},reportTimer:{dev:!0,type:"reporter",category:"sensing",spec:"timer"},getTimer:{type:"reporter",category:"sensing",
spec:"timer"},reportAttributeOf:{type:"reporter",category:"sensing",spec:"%att of %spr",defaults:[["costume #"]]},reportObject:{type:"reporter",category:"sensing",spec:"object %self",defaults:[["myself"]]},reportURL:{type:"reporter",category:"sensing",spec:"url %s",defaults:["snap.berkeley.edu"]},doSetGlobalFlag:{type:"command",category:"sensing",spec:"set %setting to %b",defaults:[["video capture"]]},reportGlobalFlag:{type:"predicate",category:"sensing",spec:"is %setting on?",defaults:[["turbo mode"]]},
reportDate:{type:"reporter",category:"sensing",spec:"current %dates"},reportGet:{type:"reporter",category:"sensing",spec:"my %get",defaults:[["neighbors"]]},reportAudio:{type:"reporter",category:"sensing",spec:"microphone %audio",defaults:[["volume"]]},reifyScript:{type:"ring",category:"other",spec:"%rc %ringparms",alias:"command ring lambda"},reifyReporter:{type:"ring",category:"other",spec:"%rr %ringparms",alias:"reporter ring lambda"},reifyPredicate:{type:"ring",category:"other",spec:"%rp %ringparms",
alias:"predicate ring lambda"},reportSum:{type:"reporter",category:"operators",spec:"%n + %n"},reportDifference:{type:"reporter",category:"operators",spec:"%n \u2212 %n",alias:"-"},reportProduct:{type:"reporter",category:"operators",spec:"%n \u00d7 %n",alias:"*"},reportQuotient:{type:"reporter",category:"operators",spec:"%n / %n"},reportRound:{type:"reporter",category:"operators",spec:"round %n"},reportMonadic:{type:"reporter",category:"operators",spec:"%fun of %n",defaults:[null,10]},reportPower:{type:"reporter",
category:"operators",spec:"%n ^ %n"},reportModulus:{type:"reporter",category:"operators",spec:"%n mod %n"},reportRandom:{type:"reporter",category:"operators",spec:"pick random %n to %n",defaults:[1,10]},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},reportAnd:{type:"predicate",category:"operators",spec:"%b and %b"},reportOr:{type:"predicate",
category:"operators",spec:"%b or %b"},reportNot:{type:"predicate",category:"operators",spec:"not %b"},reportBoolean:{type:"predicate",category:"operators",spec:"%bool",alias:"true boolean"},reportFalse:{type:"predicate",category:"operators",spec:"%bool",defaults:[!1],alias:"false boolean"},reportJoinWords:{type:"reporter",category:"operators",spec:"join %words",defaults:[localize("hello")+" ",localize("world")]},reportLetter:{type:"reporter",category:"operators",spec:"letter %idx of %s",defaults:[1,
localize("world")]},reportStringSize:{type:"reporter",category:"operators",spec:"length of %s",defaults:[localize("world")]},reportUnicode:{type:"reporter",category:"operators",spec:"unicode of %s",defaults:["a"]},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"unicode %n as letter",defaults:[65]},reportIsA:{type:"predicate",category:"operators",spec:"is %s a %typ ?",defaults:[5]},reportIsIdentical:{type:"predicate",category:"operators",spec:"is %s identical to %s ?"},reportTextSplit:{type:"reporter",
category:"operators",spec:"split %s by %delim",defaults:[localize("hello")+" "+localize("world")," "]},reportJSFunction:{type:"reporter",category:"operators",spec:"JavaScript function ( %mult%s ) { %code }"},reportTypeOf:{dev:!0,type:"reporter",category:"operators",spec:"type of %s",defaults:[5]},reportTextFunction:{dev:!0,type:"reporter",category:"operators",spec:"%txtfun of %s",defaults:[null,"Abelson & Sussman"]},reportCompiled:{type:"reporter",category:"operators",spec:"compile %repRing for %n args",
defaults:[null,0]},doSetVar:{type:"command",category:"variables",spec:"set %var to %s",defaults:[null,0]},doChangeVar:{type:"command",category:"variables",spec:"change %var by %n",defaults:[null,1]},doShowVar:{type:"command",category:"variables",spec:"show variable %var"},doHideVar:{type:"command",category:"variables",spec:"hide variable %var"},doDeclareVariables:{type:"command",category:"other",spec:"script variables %scriptVars"},doDeleteAttr:{type:"command",category:"variables",spec:"inherit %shd"},
reportNewList:{type:"reporter",category:"lists",spec:"list %exp"},reportCONS:{type:"reporter",category:"lists",spec:"%s in front of %l"},reportListItem:{type:"reporter",category:"lists",spec:"item %idx of %l",defaults:[1]},reportCDR:{type:"reporter",category:"lists",spec:"all but first of %l"},reportListLength:{type:"reporter",category:"lists",spec:"length of %l"},reportListContainsItem:{type:"predicate",category:"lists",spec:"%l contains %s",defaults:[null,localize("thing")]},reportListIsEmpty:{type:"predicate",
category:"lists",spec:"is %l empty?"},reportListIndex:{dev:!0,type:"reporter",category:"lists",spec:"index of %s in %l",defaults:[localize("thing")]},doAddToList:{type:"command",category:"lists",spec:"add %s to %l",defaults:[localize("thing")]},doDeleteFromList:{type:"command",category:"lists",spec:"delete %ida of %l",defaults:[1]},doInsertInList:{type:"command",category:"lists",spec:"insert %s at %idx of %l",defaults:[localize("thing"),1]},doReplaceInList:{type:"command",category:"lists",spec:"replace item %idx of %l with %s",
defaults:[1,null,localize("thing")]},reportNumbers:{type:"reporter",category:"lists",spec:"numbers from %n to %n",defaults:[1,10]},reportConcatenatedLists:{dev:!0,type:"reporter",category:"lists",spec:"append %lists"},reportMap:{type:"reporter",category:"lists",spec:"map %repRing over %l"},reportAtomicMap:{dev:!0,type:"reporter",category:"lists",spec:"%blitz map %repRing over %l"},reportKeep:{type:"reporter",category:"lists",spec:"keep items %predRing from %l"},reportAtomicKeep:{dev:!0,type:"reporter",
category:"lists",spec:"%blitz keep items %predRing from %l"},reportFindFirst:{type:"reporter",category:"lists",spec:"find first item %predRing in %l"},reportAtomicFindFirst:{dev:!0,type:"reporter",category:"lists",spec:"%blitz find first item %predRing in %l"},reportCombine:{type:"reporter",category:"lists",spec:"combine %l using %repRing"},reportAtomicCombine:{dev:!0,type:"reporter",category:"lists",spec:"%blitz combine %l using %repRing"},doForEach:{type:"command",category:"lists",spec:"for each %upvar in %l %cla",
defaults:[localize("item")]},doShowTable:{dev:!0,type:"command",category:"lists",spec:"show table %l"},doMapCodeOrHeader:{type:"command",category:"other",spec:"map %cmdRing to %codeKind %code"},doMapValueCode:{type:"command",category:"other",spec:"map %mapValue to code %code",defaults:[["String"],"<#1>"]},doMapListCode:{type:"command",category:"other",spec:"map %codeListPart of %codeListKind to code %code"},reportMappedCode:{type:"reporter",category:"other",spec:"code of %cmdRing"},doSetVideoTransparency:{type:"command",
category:"sensing",spec:"set video transparency to %n",defaults:[50]},reportVideo:{type:"reporter",category:"sensing",spec:"video %vid on %self",defaults:[["motion"],["myself"]]}}};SpriteMorph.prototype.initBlocks();
SpriteMorph.prototype.initBlockMigrations=function(){SpriteMorph.prototype.blockMigrations={doStopAll:{selector:"doStopThis",inputs:[["all"]]},doStop:{selector:"doStopThis",inputs:[["this script"]]},doStopBlock:{selector:"doStopThis",inputs:[["this block"]]},doStopOthers:{selector:"doStopThis",inputs:[["all"]],offset:0},receiveClick:{selector:"receiveInteraction",inputs:[["clicked"]]},reportTrue:{selector:"reportBoolean",inputs:[!0]},reportFalse:{selector:"reportBoolean",inputs:[!1]},reportCostumes:{selector:"reportGet",
inputs:[["costumes"]]},reportSounds:{selector:"reportGet",inputs:[["sounds"]]},doMapStringCode:{selector:"doMapValueCode",inputs:[["String"],"<#1>"],offset:1},reportDistanceTo:{selector:"reportRelationTo",inputs:[["distance"]],offset:1},comeToFront:{selector:"goToLayer",inputs:[["front"]]},setHue:{selector:"setPenHSVA",inputs:[["hue"]],offset:1},setBrightness:{selector:"setPenHSVA",inputs:[["brightness"]],offset:1},changeHue:{selector:"changePenHSVA",inputs:[["hue"]],offset:1},changeBrightness:{selector:"changePenHSVA",
inputs:[["brightness"]],offset:1},reportIsFastTracking:{selector:"reportGlobalFlag",inputs:[["turbo mode"]],offset:1},doSetFastTracking:{selector:"doSetGlobalFlag",inputs:[["turbo mode"]],offset:1}}};SpriteMorph.prototype.initBlockMigrations();
SpriteMorph.prototype.blockAlternatives={forward:["changeXPosition","changeYPosition"],turn:["turnLeft"],turnLeft:["turn"],doFaceTowards:["doGotoObject"],gotoXY:[["doGlide",1]],doGotoObject:["doFaceTowards"],doGlide:[["gotoXY",-1]],changeXPosition:["changeYPosition","setXPosition","setYPosition","forward"],setXPosition:["setYPosition","changeXPosition","changeYPosition"],changeYPosition:["changeXPosition","setYPosition","setXPosition","forward"],setYPosition:["setXPosition","changeYPosition","changeXPosition"],
xPosition:["yPosition"],yPosition:["xPosition"],doSayFor:["doThinkFor","bubble","doThink","doAsk"],doThinkFor:["doSayFor","doThink","bubble","doAsk"],bubble:["doThink","doAsk","doSayFor","doThinkFor"],doThink:["bubble","doAsk","doSayFor","doThinkFor"],show:["hide"],hide:["show"],changeEffect:["setEffect"],setEffect:["changeEffect"],changeScale:["setScale"],setScale:["changeScale"],playSound:["doPlaySoundUntilDone","doPlaySoundAtRate"],doPlaySoundUntilDone:["playSound","doPlaySoundAtRate"],doPlaySoundAtRate:["playSound",
"doPlaySoundUntilDone"],doPlayNote:[["doRest",-1]],doRest:[["doPlayNote",1]],doChangeTempo:["doSetTempo"],doSetTempo:["doChangeTempo"],setVolume:["changeVolume"],changeVolume:["setVolume"],setPan:["changePan"],changePan:["setPan"],getVolume:["getTempo","getPan"],getTempo:["getVolume","getPan"],getPan:["getVolume","getTempo"],clear:["down","up","doStamp"],down:["up","clear","doStamp"],up:["down","clear","doStamp"],doStamp:["clear","down","up"],setPenHSVA:["changePenHSVA"],changePenHSVA:["setPenHSVA"],
setBackgroundHSVA:["changeBackgroundHSVA"],changeBackgroundHSVA:["setBackgroundHSVA"],changeSize:["setSize"],setSize:["changeSize"],doBroadcast:["doBroadcastAndWait","doSend"],doBroadcastAndWait:["doBroadcast","doSend"],doSend:["doBroadcast","doBroadcastAndWait"],doIf:["doIfElse","doUntil"],doIfElse:["doIf","doUntil"],doRepeat:["doUntil",["doForever",-1],["doFor",2],["doForEach",1]],doUntil:["doRepeat","doIf",["doForever",-1],["doFor",2],["doForEach",1]],doForever:[["doUntil",1],["doRepeat",1],["doFor",
3],["doForEach",2]],doFor:[["doForever",-3],["doRepeat",-2],["doUntil",-2],["doForEach",-1]],doAsk:["bubble","doThink","doSayFor","doThinkFor"],getLastAnswer:["getTimer"],getTimer:["getLastAnswer"],reportMouseX:["reportMouseY"],reportMouseY:["reportMouseX"],reportSum:["reportDifference","reportProduct","reportQuotient","reportPower","reportModulus"],reportDifference:["reportSum","reportProduct","reportQuotient","reportPower","reportModulus"],reportProduct:["reportDifference","reportSum","reportQuotient",
"reportPower","reportModulus"],reportQuotient:["reportDifference","reportProduct","reportSum","reportPower","reportModulus"],reportPower:["reportDifference","reportProduct","reportSum","reportQuotient","reportModulus"],reportModulus:["reportDifference","reportProduct","reportSum","reportQuotient","reportPower"],reportLessThan:["reportEquals","reportGreaterThan"],reportEquals:["reportLessThan","reportGreaterThan"],reportGreaterThan:["reportEquals","reportLessThan"],reportAnd:["reportOr"],reportOr:["reportAnd"],
doSetVar:["doChangeVar"],doChangeVar:["doSetVar"],doShowVar:["doHideVar"],doHideVar:["doShowVar"],reportMap:["reportKeep","reportFindFirst"],reportKeep:["reportFindFirst","reportMap"],reportFindFirst:["reportKeep","reportMap"],doForEach:[["doFor",1],["doForever",-2],["doRepeat",-1],["doUntil",-1]]};function SpriteMorph(a){this.init(a)}
SpriteMorph.prototype.init=function(a){this.name=localize("Sprite");this.variables=new VariableFrame(a||null,this);this.scripts=new ScriptsMorph;this.customBlocks=[];this.costumes=new List;this.costumes.type="costume";this.costume=null;this.sounds=new List;this.sounds.type="sound";this.normalExtent=new Point(60,60);this.rotationStyle=this.scale=1;this.instrument=null;this.version=Date.now();this.isCorpse=this.isTemporary=!1;this.cloneOriginName="";this.volume=100;this.gainNode=null;this.pan=0;this.freqPlayer=
this.pannerNode=null;this.cachedHSV=[0,0,0];this.inheritedMethodsCache=[];this.parts=[];this.anchor=null;this.nestingScale=1;this.rotatesWithAnchor=!0;this.layers=null;this.blocksCache={};this.paletteCache={};this.rotationOffset=ZERO;this.idx=0;this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0};this.exemplar=null;this.instances=[];this.cachedPropagation=!1;this.inheritedAttributes=[];this.imageOffset=this.imageExtent=
ZERO;this.imageData={};this.frameNumber=this.motionDirection=this.motionAmount=0;SpriteMorph.uber.init.call(this);this.isFreeForm=this.isCachingImage=!0;this.cachedHSV=this.color.hsv();this.isDraggable=!0;this.isDown=!1;this.heading=90;this.fixLayout();this.rerender()};
SpriteMorph.prototype.fullCopy=function(a){var b=this,c=SpriteMorph.uber.fullCopy.call(this),d=[],e,f;c.cachedImage=copyCanvas(this.cachedImage);c.instances=[];c.stopTalking();c.color=this.color.copy();c.gainNode=null;c.pannerNode=null;c.freqPlayer=null;c.blocksCache={};c.paletteCache={};c.imageData={};c.cachedHSV=c.color.hsv();d=[];this.inheritedAttributes.forEach(function(g){return d.push(g)});c.inheritedAttributes=d;a?(c.exemplar=this,c.customBlocks=[],c.variables=new VariableFrame(null,c),c.variables.parentFrame=
this.variables,c.inheritedVariableNames().forEach(function(g){return c.shadowVar(g,c.variables.getVar(g))}),this.addSpecimen(c),this.cachedPropagation=!1,["scripts","costumes","sounds"].forEach(function(g){contains(c.inheritedAttributes,g)||c.inheritedAttributes.push(g)})):(c.variables=this.variables.copy(),c.variables.owner=c,c.scripts=this.scripts.fullCopy(),c.customBlocks=[],this.customBlocks.forEach(function(g){e=g.copyAndBindTo(c);c.customBlocks.push(e);c.allBlockInstances(g).forEach(function(h){return h.definition=
e})}),d=[],this.costumes.asArray().forEach(function(g){var h=a?g:g.copy();d.push(h);g===b.costume&&(c.costume=h)}),c.costumes=new List(d),d=[],this.sounds.asArray().forEach(function(g){g=a?g:g.copy();d.push(g)}),c.sounds=new List(d),d=[]);c.nestingScale=1;c.rotatesWithAnchor=!0;c.anchor=null;c.parts=[];this.parts.forEach(function(g){var h=g.fullCopy(a);h.nestingScale=g.nestingScale;h.rotatesWithAnchor=g.rotatesWithAnchor;c.attachPart(h)});c.graphicsValues={};for(f in this.graphicsValues)this.graphicsValues.hasOwnProperty(f)&&
(c.graphicsValues[f]=this.graphicsValues[f]);return c};SpriteMorph.prototype.appearIn=function(a){this.isTemporary||(this.name=a.newSpriteName(this.name),a.corral.addSprite(this),a.sprites.add(this));a.stage.add(this);this.parts.forEach(function(b){return b.appearIn(a)})};SpriteMorph.prototype.setName=function(a){this.name=a||this.name;this.version=Date.now()};
SpriteMorph.prototype.getImage=function(){if(this.shouldRerender||!this.cachedImage)this.cachedImage=newCanvas(this.costume?this.imageExtent:this.extent(),!isNil(this.costume),this.cachedImage),this.render(this.cachedImage.getContext("2d")),this.shouldRerender=!1;return this.cachedImage};
SpriteMorph.prototype.fixLayout=function(){var a=this;var b=[];var c=this.center();b=this.costume&&"function"===typeof this.costume.loaded;var d=this.parent instanceof StageMorph?this.parent.scale:1;var e=this.rotationStyle?this.heading:90;if(2===this.rotationStyle&&(e=90,180<this.heading&&360>this.heading||0>this.heading&&-180<this.heading))var f=!0;if(this.costume&&!b){f=f?this.costume.flipped():this.costume;b=f.bounds().corners().map(function(l){return l.rotateBy(radians(e-90),a.costume.center())});
var g=b[0];var h=b[0];b.forEach(function(l){g=g.min(l);h=h.max(l)});var k=g.corner(h).extent().multiplyBy(this.scale*d);this.imageOffset=ZERO.rotateBy(radians(-(e-90)),f.center()).subtract(g);1===this.rotationStyle?(b=Math.sqrt(Math.pow(f.width(),2)+Math.pow(f.height(),2))*this.scale*d,this.imageExtent=new Point(b,b)):this.imageExtent=k;this.bounds.setExtent(k);this.setCenter(c,!0);this.rotationOffset=this.imageOffset.translateBy(f.rotationCenter).rotateBy(radians(-(e-90)),this.imageOffset).scaleBy(this.scale*
d)}else e=f?-90:e,d=Math.min(Math.max(this.normalExtent.x*this.scale*d,5),1E3),this.bounds.setWidth(d),this.bounds.setHeight(d),this.setCenter(c,!0),this.rotationOffset=this.extent().divideBy(2)};
SpriteMorph.prototype.render=function(a){var b=this;var c=this.costume&&"function"===typeof this.costume.loaded;var d=this.parent instanceof StageMorph?this.parent.scale:1;var e=this.rotationStyle?this.heading:90;if(2===this.rotationStyle&&(e=90,180<this.heading&&360>this.heading||0>this.heading&&-180<this.heading))var f=!0;if(this.costume&&!c)f=f?this.costume.flipped():this.costume,a.save(),a.scale(this.scale*d,this.scale*d),a.translate(this.imageOffset.x,this.imageOffset.y),a.rotate(radians(e-90)),
a.drawImage(f.contents,0,0),a.restore();else if(SpriteMorph.uber.render.call(this,a,f?-90:e),c){var g=this.costume;var h=setInterval(function(){b.wearCostume(g,!0);clearInterval(h)},100);return this.wearCostume(null,!0)}this.cachedImage=this.applyGraphicsEffects(this.cachedImage);this.version=Date.now()};SpriteMorph.prototype.rotationCenter=function(){return this.position().add(this.rotationOffset)};
SpriteMorph.prototype.getImageData=function(){if(this.version!==this.imageData.version){var a=this.parentThatIsA(StageMorph),b=this.extent();a=new Point(Math.floor(b.x/a.scale),Math.floor(b.y/a.scale));var c=newCanvas(a,!0).getContext("2d");c.drawImage(this.getImage(),0,0,Math.floor(b.x),Math.floor(b.y),0,0,a.x,a.y);b=c.getImageData(0,0,a.x,a.y).data;this.imageData={version:this.version,pixels:new Uint32Array(b.buffer.slice(0))}}return this.imageData.pixels};
SpriteMorph.prototype.projectionSnap=function(){var a=this.parentThatIsA(StageMorph),b=this.center().subtract(a.position()).divideBy(a.scale),c=this.costume||this.getImage();if(c instanceof Costume){var d=c.rotationCenter.copy();c=c.contents;var e=c.width;var f=c.height}else e=this.width(),f=this.height();b=new Point(Math.floor(b.x-e/2),Math.floor(b.y-f/2));e=newCanvas(new Point(e,f),!0);f=e.getContext("2d");f.drawImage(c,0,0);f.globalCompositeOperation="source-atop";f.drawImage(a.projectionLayer(),
-b.x,-b.y);return new Costume(e,this.newCostumeName(localize("snap")),d)};
SpriteMorph.prototype.blockForSelector=function(a,b){var c=this.blockMigrations[a];var d=this.blocks[c?c.selector:a];if(!d)return null;var e="command"===d.type?new CommandBlockMorph:"hat"===d.type?new HatBlockMorph:"ring"===d.type?new RingMorph:new ReporterBlockMorph("predicate"===d.type);e.color=this.blockColor[d.category];e.category=d.category;e.selector=c?c.selector:a;contains(["reifyReporter","reifyPredicate"],e.selector)&&(e.isStatic=!0);e.setSpec(localize(d.spec));if(b&&d.defaults||c&&c.inputs)if(a=
c?c.inputs:d.defaults,e.defaults=a,b=e.inputs(),b[0]instanceof MultiArgMorph)b[0].setContents(a),b[0].defaults=a;else for(c=0;c<a.length;c+=1)null!==a[c]&&b[c].setContents(a[c]);return e};SpriteMorph.prototype.variableBlock=function(a,b){var c=new ReporterBlockMorph(!1);c.selector="reportGetVar";c.color=this.blockColor.variables;c.category="variables";c.isLocalVarTemplate=b;c.setSpec(a);c.isDraggable=!0;return c};
SpriteMorph.prototype.blockTemplates=function(a){function b(p,t){if(StageMorph.prototype.hiddenPrimitives[p])return null;p=SpriteMorph.prototype.blockForSelector(p,!0);p.isTemplate=!0;t&&p.ghost();return p}function c(p,t){t=SpriteMorph.prototype.variableBlock(p,t);t.isDraggable=!1;t.isTemplate=!0;contains(n,p)&&t.ghost();return t}function d(p){if(StageMorph.prototype.hiddenPrimitives[p])return null;var t=SpriteMorph.prototype.blocks[p];return new ToggleMorph("checkbox",this,function(){m.toggleWatcher(p,
localize(t.spec),m.blockColor[t.category])},null,function(){return m.showingWatcher(p)},null)}function e(p){return new ToggleMorph("checkbox",this,function(){m.toggleVariableWatcher(p)},null,function(){return m.showingVariableWatcher(p)},null)}function f(){var p=new MenuMorph(this);p.addItem("help...","showHelp");return p}function g(p){p&&(m.isVariableNameInUse(p[0],p[1])?m.inform("that name is already in use"):SnapActions.addVariable(p[0],p[1]||m.id))}function h(p){SnapActions.deleteVariable(p,m.id)}
function k(p){var t=m.parentThatIsA(StageMorph),r=p.name.trim();p=p.fields.map(function(u){return u.trim()}).filter(function(u){return!!u});t.messageTypes.getMsgType(r)?m.inform("that name is already in use"):SnapActions.addMessageType(r,p)}var l=[],m=this;a=a||"motion";var n=this.inheritedVariableNames();if("motion"===a)l.push(b("forward")),l.push(b("turn")),l.push(b("turnLeft")),l.push("-"),l.push(b("setHeading")),l.push(b("doFaceTowards")),l.push("-"),l.push(b("gotoXY")),l.push(b("doGotoObject")),
l.push(b("doGlide")),l.push("-"),l.push(b("changeXPosition")),l.push(b("setXPosition")),l.push(b("changeYPosition")),l.push(b("setYPosition")),l.push("-"),l.push(b("bounceOffEdge")),l.push("-"),l.push(d("xPosition")),l.push(b("xPosition",this.inheritsAttribute("x position"))),l.push(d("yPosition")),l.push(b("yPosition",this.inheritsAttribute("y position"))),l.push(d("direction")),l.push(b("direction",this.inheritsAttribute("direction")));else if("looks"===a){if(l.push(b("doSwitchToCostume")),l.push(b("doWearNextCostume")),
l.push(d("getCostumeIdx")),l.push(b("getCostumeIdx",this.inheritsAttribute("costume #"))),l.push("-"),l.push(b("doSayFor")),l.push(b("bubble")),l.push(b("doThinkFor")),l.push(b("doThink")),l.push("-"),l.push(b("reportGetImageAttribute")),l.push(b("reportNewCostumeStretched")),l.push(b("reportNewCostume")),l.push("-"),l.push(b("changeEffect")),l.push(b("setEffect")),l.push(b("clearEffects")),l.push(b("getEffect")),l.push("-"),l.push(b("changeScale")),l.push(b("setScale")),l.push(d("getScale")),l.push(b("getScale",
this.inheritsAttribute("size"))),l.push("-"),l.push(b("show")),l.push(b("hide")),l.push(d("reportShown")),l.push(b("reportShown",this.inheritsAttribute("shown?"))),l.push("-"),l.push(b("goToLayer")),l.push(b("goBack")),this.world().isDevMode){l.push("-");var q=new TextMorph(localize("development mode \ndebugging primitives:"));q.fontSize=9;q.setColor(this.paletteTextColor);l.push(q);l.push("-");l.push(b("log"));l.push(b("alert"))}}else"sound"===a?(l.push(b("playSound")),l.push(b("doPlaySoundUntilDone")),
l.push(b("doStopAllSounds")),l.push("-"),l.push(b("doPlaySoundAtRate")),l.push(b("reportGetSoundAttribute")),l.push(b("reportNewSoundFromSamples")),l.push("-"),l.push(b("doRest")),l.push(b("doPlayNote")),l.push(b("doSetInstrument")),l.push("-"),l.push(b("doChangeTempo")),l.push(b("doSetTempo")),l.push(d("getTempo")),l.push(b("getTempo")),l.push("-"),l.push(b("changeVolume")),l.push(b("setVolume")),l.push(d("getVolume")),l.push(b("getVolume",this.inheritsAttribute("volume"))),l.push("-"),l.push(b("changePan")),
l.push(b("setPan")),l.push(d("getPan")),l.push(b("getPan",this.inheritsAttribute("balance"))),l.push("-"),l.push(b("playFreq")),l.push(b("stopFreq")),this.world().isDevMode&&(l.push("-"),q=new TextMorph(localize("development mode \ndebugging primitives:")),q.fontSize=9,q.setColor(this.paletteTextColor),l.push(q),l.push("-"),l.push(b("doPlayFrequency")))):"pen"===a?(l.push(b("clear")),l.push("-"),l.push(b("down")),l.push(b("up")),l.push(d("getPenDown")),l.push(b("getPenDown",this.inheritsAttribute("pen down?"))),
l.push("-"),l.push(b("setColor")),l.push(b("changePenHSVA")),l.push(b("setPenHSVA")),l.push(b("getPenAttribute")),l.push("-"),l.push(b("changeSize")),l.push(b("setSize")),l.push("-"),l.push(b("doStamp")),l.push(b("floodFill")),l.push(b("write")),l.push("-"),l.push(b("reportPenTrailsAsCostume")),l.push("-"),l.push(b("doPasteOn"))):"network"===a?(l.push(b("receiveSocketMessage")),l.push(b("doSocketMessage")),l.push("-"),l.push(b("doSocketRequest")),l.push(b("doSocketResponse")),l.push("-"),l.push(b("getJSFromRPCStruct")),
l.push(b("doRunRPC")),l.push(d("reportRPCError")),l.push(b("reportRPCError")),l.push("-"),l.push(b("getProjectIds")),l.push(b("getProjectId")),q=new PushButtonMorph(null,function(){(new MessageCreatorMorph(m,k)).popUp()},"Make a message type"),l.push(q),0<this.deletableMessageNames().length&&(q=new PushButtonMorph(null,function(){var p=new MenuMorph(function(t){SnapActions.deleteMessageType(t)},null);m.deletableMessageNames().forEach(function(t){p.addItem(t,t)});p.popUpAtHand(m.world())},"Delete a message type"),
q.userMenu=f,q.selector="deleteMessageType",q.showHelp=BlockMorph.prototype.showHelp,l.push(q))):"control"===a?(l.push(b("receiveGo")),l.push(b("receiveKey")),l.push(b("receiveInteraction")),l.push(b("receiveCondition")),l.push(b("receiveMessage")),l.push("-"),l.push(b("doBroadcast")),l.push(b("doBroadcastAndWait")),l.push(b("doSend")),l.push(d("getLastMessage")),l.push(b("getLastMessage")),l.push("-"),l.push(b("doWarp")),l.push("-"),l.push(b("doWait")),l.push(b("doWaitUntil")),l.push("-"),l.push(b("doForever")),
l.push(b("doRepeat")),l.push(b("doUntil")),l.push(b("doFor")),l.push("-"),l.push(b("doIf")),l.push(b("doIfElse")),l.push(b("reportIfElse")),l.push("-"),l.push(b("doReport")),l.push(b("doStopThis")),l.push("-"),l.push(b("doRun")),l.push(b("fork")),l.push(b("evaluate")),l.push("-"),l.push(b("doTellTo")),l.push(b("reportAskFor")),l.push("-"),l.push(b("doCallCC")),l.push(b("reportCallCC")),l.push("-"),l.push(b("receiveOnClone")),l.push(b("createClone")),l.push(b("newClone")),l.push(b("removeClone")),
l.push("-"),l.push(b("doPauseAll"))):"sensing"===a?(l.push(b("reportTouchingObject")),l.push(b("reportTouchingColor")),l.push(b("reportColorIsTouchingColor")),l.push("-"),l.push(b("doAsk")),l.push(d("getLastAnswer")),l.push(b("getLastAnswer")),l.push("-"),l.push(d("reportMouseX")),l.push(b("reportMouseX")),l.push(d("reportMouseY")),l.push(b("reportMouseY")),l.push(b("reportMouseDown")),l.push("-"),l.push(b("reportKeyPressed")),l.push("-"),l.push(b("reportRelationTo")),l.push(b("reportAspect")),l.push("-"),
l.push(b("doResetTimer")),l.push(d("getTimer")),l.push(b("getTimer")),l.push("-"),l.push(b("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&l.push(b("reportGet")),l.push(b("reportObject")),l.push("-"),l.push(b("reportURL")),l.push(b("reportAudio")),l.push(b("reportVideo")),l.push(b("doSetVideoTransparency")),l.push("-"),l.push(b("reportGlobalFlag")),l.push(b("doSetGlobalFlag")),l.push("-"),l.push(b("reportDate")),l.push(b("reportUsername")),l.push("-"),l.push(b("reportLatitude")),l.push(b("reportLongitude")),
l.push("-"),l.push(b("reportStageHeight")),l.push(b("reportStageWidth")),l.push(b("reportImageOfObject")),this.world().isDevMode&&(l.push("-"),q=new TextMorph(localize("development mode \ndebugging primitives:")),q.fontSize=9,q.setColor(this.paletteTextColor),l.push(q),l.push("-"),l.push(d("reportThreadCount")),l.push(b("reportThreadCount")),l.push(b("reportStackSize")),l.push(b("reportFrameCount")))):"operators"===a?(l.push(b("reifyScript")),l.push(b("reifyReporter")),l.push(b("reifyPredicate")),
l.push("#"),l.push("-"),l.push(b("reportSum")),l.push(b("reportDifference")),l.push(b("reportProduct")),l.push(b("reportQuotient")),l.push(b("reportPower")),l.push("-"),l.push(b("reportModulus")),l.push(b("reportRound")),l.push(b("reportMonadic")),l.push(b("reportRandom")),l.push("-"),l.push(b("reportLessThan")),l.push(b("reportEquals")),l.push(b("reportGreaterThan")),l.push("-"),l.push(b("reportAnd")),l.push(b("reportOr")),l.push(b("reportNot")),l.push(b("reportBoolean")),l.push("-"),l.push(b("reportJoinWords")),
l.push(b("reportTextSplit")),l.push(b("reportLetter")),l.push(b("reportStringSize")),l.push("-"),l.push(b("reportUnicode")),l.push(b("reportUnicodeAsLetter")),l.push("-"),l.push(b("reportIsA")),l.push(b("reportIsIdentical")),l.push("-"),l.push(b("reportJSFunction")),Process.prototype.enableCompiling&&l.push(b("reportCompiled")),this.world().isDevMode&&(l.push("-"),q=new TextMorph(localize("development mode \ndebugging primitives:")),q.fontSize=9,q.setColor(this.paletteTextColor),l.push(q),l.push("-"),
l.push(b("reportTypeOf")),l.push(b("reportTextFunction")))):"variables"===a&&(q=new PushButtonMorph(null,function(){(new VariableDialogMorph(null,g,m)).prompt("Variable name",null,m.world())},"Make a variable"),q.userMenu=f,q.selector="addVariable",q.showHelp=BlockMorph.prototype.showHelp,l.push(q),0<this.deletableVariableNames().length&&(q=new PushButtonMorph(null,function(){var p=new MenuMorph(h,null,m);m.deletableVariableNames().forEach(function(t){return p.addItem(t,t,null,null,null,null,null,
null,!0)});p.popUpAtHand(m.world())},"Delete a variable"),q.userMenu=f,q.selector="deleteVariable",q.showHelp=BlockMorph.prototype.showHelp,l.push(q)),l.push("-"),q=this.reachableGlobalVariableNames(!0),0<q.length&&(q.forEach(function(p){l.push(e(p));l.push(c(p))}),l.push("-")),q=this.allLocalVariableNames(!0),0<q.length&&(q.forEach(function(p){l.push(e(p));l.push(c(p,!0))}),l.push("-")),l.push(b("doSetVar")),l.push(b("doChangeVar")),l.push(b("doShowVar")),l.push(b("doHideVar")),l.push(b("doDeclareVariables")),
StageMorph.prototype.enableInheritance&&(l.push("-"),l.push(b("doDeleteAttr"))),l.push("="),l.push(b("reportNewList")),l.push(b("reportNumbers")),l.push("-"),l.push(b("reportCONS")),l.push(b("reportListItem")),l.push(b("reportCDR")),l.push("-"),l.push(b("reportListLength")),l.push(b("reportListIndex")),l.push(b("reportListContainsItem")),l.push(b("reportListIsEmpty")),l.push("-"),l.push(b("reportMap")),l.push(b("reportKeep")),l.push(b("reportFindFirst")),l.push(b("reportCombine")),l.push("-"),l.push(b("doForEach")),
l.push("-"),l.push(b("reportConcatenatedLists")),l.push("-"),l.push(b("doAddToList")),l.push(b("doDeleteFromList")),l.push(b("doInsertInList")),l.push(b("doReplaceInList")),this.world().isDevMode&&(l.push("-"),q=new TextMorph(localize("development mode \ndebugging primitives:")),q.fontSize=9,q.setColor(this.paletteTextColor),l.push(q),l.push("-"),l.push(b("doShowTable"))),StageMorph.prototype.enableCodeMapping&&(l.push("="),l.push(b("doMapCodeOrHeader")),l.push(b("doMapValueCode")),l.push(b("doMapListCode")),
l.push("-"),l.push(b("reportMappedCode"))));if(q=this.parentThatIsA(IDE_Morph))q=q.extensions.getPaletteContents(this,a).flatMap(function(p){switch(p.type){case "block":return b(p.name);case "watcher":return[d(p.name),b(p.name)];case "space":return p.name}return p}),l.push.apply(l,$jscomp.arrayFromIterable(q));l.push("=");l.push(this.makeBlockButton(a));return l};
SpriteMorph.prototype.makeBlockButton=function(a){a=new PushButtonMorph(this,"makeBlock","Make a block");a.userMenu=function(){var b=new MenuMorph(this);b.addItem("help...","showHelp");return b};a.selector="addCustomBlock";a.showHelp=BlockMorph.prototype.showHelp;return a};
SpriteMorph.prototype.makeBlock=function(){var a=this,b=this.parentThatIsA(IDE_Morph).currentCategory,c=SpriteMorph.prototype.blockColor[b];var d=new BlockDialogMorph(null,function(e){""!==e.spec&&SnapActions.addCustomBlock(e,a).then(function(f){(new BlockEditorMorph(f,a)).popUp()})},this);"variables"!==b&&(d.category=b,d.categories.children.forEach(function(e){return e.refresh()}),d.types.children.forEach(function(e){e.setColor(c);e.refresh()}));d.prompt("Make a block",null,this.world())};
SpriteMorph.prototype.palette=function(a){this.paletteCache[a]||(this.paletteCache[a]=this.freshPalette(a));return this.paletteCache[a]};
SpriteMorph.prototype.freshPalette=function(a){var b=new ScrollFrameMorph(null,null,this.sliderColor),c=SyntaxElementMorph.prototype.fontSize,d=0,e=5,f=0,g=!1,h=this.parentThatIsA(StageMorph);var k=new Color(140,140,140);b.owner=this;b.padding=c/2;b.color=this.paletteColor;b.growth=new Point(0,MorphicPreferences.scrollBarSize);b.toolBar=new AlignmentMorph("column");var l=new PushButtonMorph(this,"searchBlocks",new SymbolMorph("magnifierOutline",16));l.alpha=.2;l.padding=1;l.hint=localize("find blocks")+
"...";l.labelShadowColor=k;l.edge=0;l.padding=3;l.fixLayout();b.toolBar.add(l);l=new PushButtonMorph(this,"makeBlock",new SymbolMorph("cross",16));l.alpha=.2;l.padding=1;l.hint=localize("Make a block")+"...";l.labelShadowColor=k;l.edge=0;l.padding=3;l.fixLayout();b.toolBar.add(l);b.toolBar.fixLayout();b.add(b.toolBar);b.userMenu=function(){var m=this,n=new MenuMorph,q=this.parentThatIsA(IDE_Morph),p={operators:["reifyScript","reifyReporter","reifyPredicate"],control:["doWarp"],variables:"doDeclareVariables reportNewList reportNumbers reportCONS reportListItem reportCDR reportListLength reportListIndex reportConcatenatedLists reportListContainsItem reportListIsEmpty doForEach reportMap reportKeep reportFindFirst reportCombine doAddToList doDeleteFromList doInsertInList doReplaceInList".split(" ")};
n.addPair([new SymbolMorph("magnifyingGlass",MorphicPreferences.menuFontSize),localize("find blocks")+"..."],function(){return m.searchBlocks()},"^F");(function(){return b.contents.children.some(function(r){return contains(Object.keys(SpriteMorph.prototype.blocks),r.selector)})})()&&n.addItem("hide primitives",function(){var r=SpriteMorph.prototype.blocks;Object.keys(r).forEach(function(u){r[u].category===a&&(StageMorph.prototype.hiddenPrimitives[u]=!0)});(p[a]||[]).forEach(function(u){return StageMorph.prototype.hiddenPrimitives[u]=
!0});q.flushBlocksCache(a);q.refreshPalette()});(function(){var r=SpriteMorph.prototype.blocks;return Object.keys(StageMorph.prototype.hiddenPrimitives).some(function(u){return!isNil(r[u])&&(r[u].category===a||contains(p[a]||[],u))})})()&&n.addItem("show primitives",function(){var r=SpriteMorph.prototype.blocks;Object.keys(StageMorph.prototype.hiddenPrimitives).forEach(function(u){r[u]&&r[u].category===a&&delete StageMorph.prototype.hiddenPrimitives[u]});(p[a]||[]).forEach(function(u){return delete StageMorph.prototype.hiddenPrimitives[u]});
q.flushBlocksCache(a);q.refreshPalette()});if(SnapUndo.canUndo("palette")){var t=q.serializer.parse(SnapUndo.eventHistory.palette[SnapUndo.eventHistory.palette.length-1].args[2]);n.addItem('restore "'+t.attributes.s+'"',function(){SnapUndo.undo("palette")})}return n};k=this.blocksCache[a];k||(k=this.blockTemplates(a),this.isCachingPrimitives&&(this.blocksCache[a]=k));k.forEach(function(m){null!==m&&("-"===m?g||(e+=.8*c,g=!0):"="===m?g||(e+=1.6*c,g=!0):"#"===m?(d=0,e=f):(g=!1,0===d&&(e+=.3*c),m.setPosition(new Point(d,
e)),b.addContents(m),m instanceof ToggleMorph||m instanceof RingMorph?(d=m.right()+c/2,f=m.bottom()):(d=0,e+=m.height())))});h&&(e+=1.6*c,h.globalBlocks.forEach(function(m){if("custom"===a||m.category===a)m=m.templateInstance(),e+=.3*c,m.setPosition(new Point(d,e)),b.addContents(m),d=0,e+=m.height()}));e+=1.6*c;this.customBlocks.forEach(function(m){if("custom"===a||m.category===a)m=m.templateInstance(),e+=.3*c,m.setPosition(new Point(d,e)),b.addContents(m),d=0,e+=m.height()});this.exemplar&&this.inheritedBlocks(!0).forEach(function(m){if(m.category===
a||"variables"===a&&contains(["lists","other"],m.category))m=m.templateInstance(),e+=.3*c,m.setPosition(new Point(d,e)),b.addContents(m),m.ghost(),d=0,e+=m.height()});b.scrollX(b.padding);b.scrollY(b.padding);return b};
SpriteMorph.prototype.blocksMatching=function(a,b,c,d){function e(q){return BlockMorph.prototype.parseSpec(q).filter(function(p){return 0!==p.indexOf("%")}).join(" ")}function f(q,p){q=" "+q;p=q.indexOf(p);if(-1===p)return-1;q=" "===q.charAt(p-1);if(b&&!q)return-1;for(p=String(p);4>p.length;)p="0"+p;return(q?"1":"2")+p}function g(q){q=SpriteMorph.prototype.blockForSelector(q,!0);q.isTemplate=!0;return q}var h=this,k=[],l=a.toLowerCase(),m=this.parentThatIsA(StageMorph);c&&c.length||(c=["hat","command",
"reporter","predicate","ring"]);d||(d=[]);d.forEach(function(q){var p=f(e(q.toLowerCase()),l);-1!==p&&k.push([h.variableBlock(q),p+"1"])});[this.customBlocks,m.globalBlocks].forEach(function(q){return q.forEach(function(p){if(contains(c,p.type)){var t=p.localizedSpec().toLowerCase();t=f(e(t),l);-1!==t&&k.push([p.templateInstance(),t+"2"])}})});var n=SpriteMorph.prototype.blocks;Object.keys(n).forEach(function(q){if(!StageMorph.prototype.hiddenPrimitives[q]&&contains(c,n[q].type)&&!n[q].deprecated){var p=
n[q],t=localize(p.alias||p.spec).toLowerCase();t=f(e(t),l);-1===t||p.dev||p.only&&p.only!==h.constructor||k.push([g(q),t+"3"])}});contains(c,"reporter")&&(a=this.reporterize(a))&&k.push([a,""]);k.sort(function(q,p){return q[1]<p[1]?-1:1});return k.map(function(q){return q[0]})};
SpriteMorph.prototype.searchBlocks=function(a,b,c,d){function e(){t&&t.destroy();p&&d&&(t=p.outline(MorphicPreferences.isFlat?new Color(150,200,255):WHITE,2),n.contents.add(t),t.scrollIntoView())}function f(r){var u=n.contents.left()+5,v=m.bottom()+h;q=r;p=null;r.length&&d&&(p=r[0]);n.contents.children=[n.contents.children[0]];r.forEach(function(w){w.setPosition(new Point(u,v));n.addContents(w);v+=w.height();v+=.3*h});e();n.changed()}var g=this,h=SyntaxElementMorph.prototype.fontSize,k=this.parentThatIsA(IDE_Morph),
l="",m=new InputFieldMorph(a||""),n=k.createPalette("forSearch"),q=[],p,t;n.mouseClickLeft=function(){16===world.currentKey&&k.prompt("Search for used blocks",function(r){if(r&&!(3>r.length)){r=r.toLowerCase();console.log("searching with query:",r);r=k.findBlocks({specs:[r]});console.log("found",r.length,"blocks");if(r.length){var u={};r.map(function(w){return k.blockAddress(w).join(" => ")}).forEach(function(w){u[w]=void 0===u[w]?1:u[w]+1});r="";for(var v in u)1<u[v]&&(r+="["+u[v]+"x] "),r+=v+"\n"}else r=
"No blocks found";k.inform("Search Results",r)}},null,"searchBlocks")};n.owner=this;n.color=this.paletteColor;n.contents.color=this.paletteColor;n.addContents(m);m.setWidth(k.logo.width()-30);m.contrast=90;m.setPosition(n.contents.topLeft().add(new Point(10,10)));m.fixLayout();n.accept=function(){if(d)m.cancel(),p&&d.insertBlock(p);else{var r=m.getValue();0<r.length&&f(g.blocksMatching(r))}};n.reactToKeystroke=function(r){switch(r?r.keyCode:0){case 38:if(!d||!p)break;r=q.indexOf(p)-1;0>r&&(r=q.length-
1);p=q[r];e();break;case 40:if(!d||!p)break;r=q.indexOf(p)+1;r>=q.length&&(r=0);p=q[r];e();break;default:nop()}};n.reactToInput=function(r){r=m.getValue();r!==l&&(l=r,f(g.blocksMatching(r,2>r.length,b,c)))};m.cancel=function(){k.refreshPalette();k.palette.adjustScrollBars()};k.fixLayout("refreshPalette");m.edit();a&&n.reactToKeystroke()};
SpriteMorph.prototype.reporterize=function(a){function b(e,f,g){function h(q){return q instanceof Array||isNaN(+q)?q:+q}function k(){for(var q=1,p="";m<e.length;){n=e[m];m+=1;switch(n){case "(":q+=1;break;case ")":if(--q,!q)return p}p+=n}}for(var l=["",""],m=0,n;m<e.length;)switch(n=e[m],m+=1,n){case " ":break;case "(":l[f?1:0]=l[f?1:0].length?[l[f?1:0],b(k())]:b(k());break;case "-":case "+":case "*":case "/":case "%":case "=":case "<":case ">":case "&":case "|":if(f||l[0].length)if(f){if(l[1].length)return b(e.slice(m),
n,[f,g,h(l[1])]);l[1]=n}else f=n,g=h(l[0]);else l[0]=n;break;default:l[f?1:0]+=n}return f?[f,g,h(l[1])]:h(l[0])}function c(e){var f=1,g={};var h={"+":"reportSum","-":"reportDifference","*":"reportProduct","/":"reportQuotient","%":"reportModulus","^":"reportPower","=":"reportEquals","<":"reportLessThan",">":"reportGreaterThan","&":"reportAnd","|":"reportOr",round:"reportRound",not:"reportNot"};var k="abs ceiling floor sqrt sin cos tan asin acos atan ln log round not".split(" ");k.concat(["true","false"]).forEach(function(m){return g[localize(m).toLowerCase()]=
m});var l={ceil:"ceiling","!":"not"}[e[0]]||g[e[0].toLowerCase()]||e[0];contains(k,l)?(h=h[l])?(h=SpriteMorph.prototype.blockForSelector(h),k=h.inputs()):(h=SpriteMorph.prototype.blockForSelector("reportMonadic"),k=h.inputs(),k[0].setContents([l]),f=0):(h=SpriteMorph.prototype.blockForSelector(h[l]),k=h.inputs());for(l=1;l<e.length;l+=1)e[l]instanceof Array?h.replaceInput(k[l-f],c(e[l])):isString(e[l])?contains(["true","false"],g[e[l]]||e[l])?h.replaceInput(k[l-f],SpriteMorph.prototype.blockForSelector("true"===
(g[e[l]]||e[l])?"reportTrue":"reportFalse")):"_"!==e[l]&&h.replaceInput(k[l-f],SpriteMorph.prototype.variableBlock(e[l])):k[l-f].setContents(e[l]);h.isDraggable=!0;h.fixLayout();h.fixBlockColor(null,!0);return h}if(100<a.length)return null;try{var d=b(a);return d instanceof Array?c(d):null}catch(e){return null}};
SpriteMorph.prototype.addVariable=function(a,b){var c=this.parentThatIsA(IDE_Morph);b?(this.globalVariables().addVar(a),c&&c.flushBlocksCache("variables")):(this.variables.addVar(a),this.blocksCache.variables=null)};SpriteMorph.prototype.deleteVariable=function(a){var b=this.parentThatIsA(IDE_Morph);contains(this.inheritedVariableNames(!0),a)||this.deleteVariableWatcher(a);this.variables.deleteVar(a);b&&(b.flushBlocksCache("variables"),b.refreshPalette())};
SpriteMorph.prototype.addCostume=function(a){a.name||(a.name="costume"+(this.costumes.length()+1));this.shadowAttribute("costumes");this.costumes.add(a)};
SpriteMorph.prototype.wearCostume=function(a,b){var c=this.xPosition?this.xPosition():null,d=this.yPosition?this.yPosition():null,e=isNil(a)?null:this.costumes.asArray().indexOf(a);this.changed();this.costume=a;this.fixLayout();this.rerender();null!==c&&this.silentGotoXY(c,d,!0);this.positionTalkBubble&&this.positionTalkBubble();this.version=Date.now();b||this.shadowAttribute("costume #");this.specimens().forEach(function(f){f.cachedPropagation&&f.inheritsAttribute("costume #")&&(null===e?f.wearCostume(null,
!0):-1===e?f.wearCostume(a,!0):f.doSwitchToCostume(e+1,!0))})};SpriteMorph.prototype.getCostumeIdx=function(){return this.inheritsAttribute("costume #")?this.exemplar.getCostumeIdx():this.costumes.asArray().indexOf(this.costume)+1};SpriteMorph.prototype.doWearNextCostume=function(){var a=this.costumes.asArray();if(1<a.length){var b=a.indexOf(this.costume);-1<b&&(b+=1,b>a.length-1&&(b=0),this.wearCostume(a[b]))}};
SpriteMorph.prototype.doWearPreviousCostume=function(){var a=this.costumes.asArray();if(1<a.length){var b=a.indexOf(this.costume);-1<b&&(--b,0>b&&(b=a.length-1),this.wearCostume(a[b]))}};
SpriteMorph.prototype.doSwitchToCostume=function(a,b){if(a instanceof List){if(this.costume){var c=this.costume.width();var d=this.costume.height()}else c=StageMorph.prototype.dimensions.x,d=StageMorph.prototype.dimensions.y;a=Process.prototype.reportNewCostume(a,c,d,this.newCostumeName(localize("snap")))}if(a instanceof Costume)this.wearCostume(a,b);else if(!(a instanceof Array&&"current"===a[0])){c=this.costumes.asArray();if(contains([localize("Turtle"),localize("Empty")],a instanceof Array?a[0]:
null))d=null;else{if(-1===a){this.doWearPreviousCostume();return}d=detect(c,function(e){return e.name===a});null===d&&(d=parseFloat(a),d=0===d?null:c[d-1]||null)}this.wearCostume(d,b)}};SpriteMorph.prototype.reportCostumes=function(){return this.costumes};SpriteMorph.prototype.addSound=function(a){this.shadowAttribute("sounds");this.sounds.add(a);return a};
SpriteMorph.prototype.doPlaySound=function(a){var b=this.parentThatIsA(StageMorph),c=a instanceof Sound?a:"number"===typeof a?this.sounds.at(a):detect(this.sounds.asArray(),function(h){return h.name===a.toString()}),d=this.audioContext(),e=this.getGainNode(),f=this.getPannerNode();if(c){var g=document.createElement("audio");g.src=c.audio.src;d.resume();c=d.createMediaElementSource(g);c.connect(e);f?(e.connect(f),f.connect(d.destination),this.setPan(this.getPan())):e.connect(d.destination);this.setVolume(this.getVolume());
g.play();b&&(b.activeSounds.push(g),b.activeSounds=b.activeSounds.filter(function(h){return!h.ended&&!h.terminated}));return g}};SpriteMorph.prototype.reportSounds=function(){return this.sounds};
SpriteMorph.prototype.setVolume=function(a,b){this.volume=Math.max(Math.min(+a||0,100),0);this.getGainNode().gain.setValueAtTime(1/Math.pow(10,Math.log2(100/this.volume)),this.audioContext().currentTime);this instanceof StageMorph||(b||this.shadowAttribute("volume"),this.instances.forEach(function(c){c.cachedPropagation&&c.inheritsAttribute("volume")&&c.setVolume(a,!0)}))};SpriteMorph.prototype.changeVolume=function(a){this.setVolume(this.getVolume()+(+a||0))};
SpriteMorph.prototype.getVolume=function(){return this.inheritsAttribute("volume")?this.exemplar.getVolume():this.volume};SpriteMorph.prototype.getGainNode=function(){this.gainNode||(this.gainNode=this.audioContext().createGain());return this.gainNode};SpriteMorph.prototype.audioContext=function(){return Note.prototype.getAudioContext()};
SpriteMorph.prototype.setPan=function(a,b){var c=this.getPannerNode();c&&(this.pan=Math.max(Math.min(+a||0,100),-100),c.pan.setValueAtTime(this.pan/100,this.audioContext().currentTime),this instanceof StageMorph||(b||this.shadowAttribute("balance"),this.instances.forEach(function(d){d.cachedPropagation&&d.inheritsAttribute("balance")&&d.setPan(a,!0)})))};SpriteMorph.prototype.changePan=function(a){this.setPan(this.getPan()+(+a||0))};
SpriteMorph.prototype.getPan=function(){return this.inheritsAttribute("balance")?this.exemplar.getPan():this.pan};SpriteMorph.prototype.getPannerNode=function(){if(!this.pannerNode){var a=this.audioContext();a.createStereoPanner&&(this.pannerNode=this.audioContext().createStereoPanner())}return this.pannerNode};
SpriteMorph.prototype.playFreq=function(a){var b=this.audioContext(),c=this.getGainNode(),d=this.getPannerNode(),e=this.parentThatIsA(StageMorph);this.freqPlayer||(this.freqPlayer=new Note);var f=this.freqPlayer;f.fader=b.createGain();f.oscillator?f.oscillator.frequency.value=a:(f.oscillator=b.createOscillator(),f.oscillator.start||(f.oscillator.start=f.oscillator.noteOn),f.oscillator.stop||(f.oscillator.stop=f.oscillator.noteOff),f.setInstrument(this.instrument),f.oscillator.frequency.value=a,this.setVolume(this.getVolume()),
f.oscillator.connect(f.fader),f.fader.connect(c),d?(c.connect(d),d.connect(b.destination),this.setPan(this.pan)):c.connect(b.destination),f.ended=!1,e&&(e.activeSounds.push(f),e.activeSounds=e.activeSounds.filter(function(g){return!g.ended&&!g.terminated})),f.fader.gain.setValueCurveAtTime(f.fadeIn,b.currentTime,f.fadeTime),f.oscillator.start(0))};SpriteMorph.prototype.stopFreq=function(){this.freqPlayer&&this.freqPlayer.stop()};
SpriteMorph.prototype.userMenu=function(){var a=this.parentThatIsA(IDE_Morph),b=new MenuMorph(this);if(a&&a.isAppMode)return b;this.isTemporary||(b.addItem("duplicate","duplicate"),StageMorph.prototype.enableInheritance&&(b.addItem("clone","instantiate"),b.addLine()));b.addItem("delete","remove");b.addItem("move","moveCenter");b.addItem("rotate","setRotation");this.costume&&b.addItem("pivot","moveRotationCenter","edit the costume's\nrotation center");this.isTemporary?StageMorph.prototype.enableInheritance&&
b.addItem("edit","perpetuateAndEdit","make permanent and\nshow in the sprite corral"):b.addItem("edit","edit");b.addLine();if(this.anchor)b.addItem(localize("detach from")+" "+this.anchor.name,function(){SnapActions.detachParts([this])});else{var c=this.allParts();a=this.parent.children.filter(function(d){return d instanceof SpriteMorph&&!contains(c,d)});a.length&&b.addMenu("stick to",this.anchorsMenu(a))}this.parts.length&&b.addItem("detach all parts",function(){SnapActions.detachParts(this.parts)});
b.addItem("export...","exportSprite");return b};SpriteMorph.prototype.anchorsMenu=function(a){var b=new MenuMorph(this.attachTo,null,this);a.forEach(function(c){return b.addItem([c.thumbnail(new Point(24,24)),c.name],c)});return b};SpriteMorph.prototype.exportSprite=function(){if(!this.isTemporary){var a=this.parentThatIsA(IDE_Morph);a&&a.exportSprite(this)}};SpriteMorph.prototype.edit=function(){var a=this.parentThatIsA(IDE_Morph);a&&!a.isAppMode&&a.selectSprite(this)};
SpriteMorph.prototype.showOnStage=function(){var a=this.parentThatIsA(StageMorph);a&&(this.keepWithin(a),a.add(this));this.show()};SpriteMorph.prototype.duplicate=function(){SnapActions.duplicateSprite(this)};SpriteMorph.prototype.instantiate=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.instantiateSprite(this)};SpriteMorph.prototype.remove=function(){SnapActions.removeSprite(this)};
SpriteMorph.prototype.createClone=function(a){var b=this.parentThatIsA(StageMorph);if(b&&5E3>=b.cloneCount){var c=this.fullCopy(!0);c.clonify(b,a)}return c};SpriteMorph.prototype.newClone=function(a){a=this.createClone(a);if(isNil(a))throw Error("exceeding maximum number of clones");return a};
SpriteMorph.prototype.clonify=function(a,b){var c=this;this.parts.forEach(function(d){return d.clonify(a)});a.cloneCount+=1;this.cloneOriginName=this.isTemporary?this.cloneOriginName:this.name;this.isTemporary=!0;this.name="";a.add(this);this.allHatBlocksFor("__clone__init__").forEach(function(d){return a.threads.startProcess(d,c,a.isThreadSafe,null,null,null,b)});this.endWarp()};
SpriteMorph.prototype.initClone=function(a){var b=this,c=this.parentThatIsA(StageMorph);c&&(a.forEach(function(d){return c.threads.startProcess(d,b,c.isThreadSafe)}),this.endWarp())};SpriteMorph.prototype.removeClone=function(){var a=this,b=this.exemplar;this.isTemporary&&(this.parent.threads.stopAllForReceiver(this),this.parts.slice().forEach(function(c){a.detachPart(c);c.removeClone()}),this.corpsify(),this.instances.forEach(function(c){c.isTemporary&&c.setExemplar(b)}),this.destroy(),--this.parent.cloneCount)};
SpriteMorph.prototype.perpetuate=function(){var a=this.parentThatIsA(StageMorph),b=this.parentThatIsA(IDE_Morph);this.exemplar&&this.exemplar.perpetuate();this.isTemporary&&a&&b&&(this.isTemporary=!1,this.name=b.newSpriteName(this.cloneOriginName),this.cloneOriginName="",--a.cloneCount,b.corral.addSprite(this),b.sprites.add(this),this.parts.forEach(function(c){return c.perpetuate()}))};SpriteMorph.prototype.perpetuateAndEdit=function(){var a=this.parentThatIsA(IDE_Morph);a&&(this.perpetuate(),a.selectSprite(this))};
SpriteMorph.prototype.release=function(){var a=this,b=this.parentThatIsA(StageMorph),c=this.parentThatIsA(IDE_Morph);if(!this.isTemporary&&this.exemplar&&b&&c){this.parts.forEach(function(e){return e.release()});this.instances.forEach(function(e){return e.release()});this.isTemporary=!0;this.name="";this.cloneOriginName=this.exemplar.name;b.cloneCount+=1;var d=c.sprites.asArray().indexOf(this)+1;b.watchers().forEach(function(e){e.object()===a&&e.destroy()});0<d&&c.sprites.remove(d);c.createCorral();
c.fixLayout();c.currentSprite===this&&(c.currentSprite=detect(b.children,function(e){return e instanceof SpriteMorph&&!e.isTemporary})||this.stage);c.selectSprite(c.currentSprite);c.isAppMode&&c.toggleAppMode(!0)}};SpriteMorph.prototype.corpsify=function(){this.isCorpse=!0;this.version=Date.now()};SpriteMorph.prototype.show=function(){this.setVisibility(!0)};SpriteMorph.prototype.hide=function(){this.setVisibility(!1)};
SpriteMorph.prototype.setVisibility=function(a,b){var c=this.talkBubble();a?SpriteMorph.uber.show.call(this):SpriteMorph.uber.hide.call(this);c&&(a?c.show():c.hide());this.parts.forEach(function(d){return d.setVisibility(a)});b||this.shadowAttribute("shown?");this.instances.forEach(function(d){d.cachedPropagation&&d.inheritsAttribute("shown?")&&d.setVisibility(a,!0)})};SpriteMorph.prototype.reportShown=function(){return this.inheritsAttribute("shown?")?this.exemplar.reportShown():this.isVisible};
SpriteMorph.prototype.setColorComponentHSVA=function(a,b){var c=this.xPosition(),d=this.yPosition();b=+b;a=+a;if(!(0>a||3<a)){if(0==a){if(0>b||100<b)b=(0>b?100:0)+b%100}else b=Math.min(100,Math.max(0,b));3===a?this.color.a=1-b/100:(this.cachedHSV[a]=b/100,this.color.set_hsv.apply(this.color,this.cachedHSV));this.costume||this.rerender();this.gotoXY(c,d)}};SpriteMorph.prototype.getColorComponentHSLA=function(a){a=+a;return 3===a?100*(1-this.color.a):100*(this.cachedHSV[a]||0)};
SpriteMorph.prototype.changeColorComponentHSVA=function(a,b){this.setColorComponentHSVA(a,this.getColorComponentHSLA(a)+(+b||0))};SpriteMorph.prototype.setColor=function(a){var b=this.xPosition(),c=this.yPosition();this.color.eq(a,!0)||(this.color=a.copy(),this.costume||(this.rerender(),this.silentGotoXY(b,c)),this.cachedHSV=this.color.hsv())};SpriteMorph.prototype.setBackgroundColor=SpriteMorph.prototype.setColor;
SpriteMorph.prototype.getPenAttribute=function(a){a=a instanceof Array?a[0]:a.toString();return"size"===a?this.size||0:this.getColorComponentHSLA(["hue","saturation","brightness","transparency"].indexOf(a))};SpriteMorph.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())};SpriteMorph.prototype.goToBack=function(){this.parent&&(this.parent.addBack(this),this.changed())};
SpriteMorph.prototype.goBack=function(a){var b=+a;if(!this.parent)return null;a=this.parent.children.indexOf(this);this.parent.removeChild(this);this.parent.children.splice(Math.max(a-b,0),null,this);this.parent.changed()};SpriteMorph.prototype.reportTouchingColor=function(a){var b=this.parentThatIsA(StageMorph),c;if(b){b=this.overlappingPixels(b);if(!b)return!1;var d=b[0].length;for(c=3;c<d;c+=4)if(b[0][c]&&b[1][c]&&b[1][c-3]===a.r&&b[1][c-2]===a.g&&b[1][c-1]===a.b)return!0}return!1};
SpriteMorph.prototype.reportColorIsTouchingColor=function(a,b){var c=this.parentThatIsA(StageMorph),d;if(c){c=this.overlappingPixels(c);if(!c)return!1;var e=c[0].length;for(d=3;d<e;d+=4)if(c[0][d]&&c[1][d]&&c[0][d-3]===a.r&&c[0][d-2]===a.g&&c[0][d-1]===a.b&&c[1][d-3]===b.r&&c[1][d-2]===b.g&&c[1][d-1]===b.b)return!0}return!1};
SpriteMorph.prototype.overlappingPixels=function(a){var b=this.bounds.intersect(a.bounds),c=this.getImage(),d=a.getImage();a instanceof StageMorph&&(d=a.fancyThumbnail(a.extent(),this,!0));if(1>b.width()||1>b.height()||!c||!d||!c.width||!c.height||!d.width||!d.height)return!1;c.isRetinaEnabled!==d.isRetinaEnabled&&(c=normalizeCanvas(c,!0),d=normalizeCanvas(d,!0));return[c.getContext("2d").getImageData(b.left()-this.left(),b.top()-this.top(),b.width(),b.height()).data,d.getContext("2d").getImageData(b.left()-
a.left(),b.top()-a.top(),b.width(),b.height()).data]};SpriteMorph.prototype.doStamp=function(){var a=this.parent,b=a.penTrails().getContext("2d"),c=this.getImage();1>c.width||1>c.height||(b.save(),b.scale(1/a.scale,1/a.scale),b.globalAlpha=this.alpha,b.drawImage(c,this.left()-a.left(),this.top()-a.top()),b.restore(),this.changed(),a.cachedPenTrailsMorph=null)};SpriteMorph.prototype.clear=function(){this.parent.clearPenTrails()};
SpriteMorph.prototype.write=function(a,b){if("string"!==typeof a&&"number"!==typeof a)throw Error("LABEL can only draw text or numbers, not a "+typeof a);var c=this.parentThatIsA(StageMorph),d=c.penTrails().getContext("2d"),e=radians(this.direction()-90),f=new Point(this.rotationCenter().x-c.left(),this.rotationCenter().y-c.top());d.save();d.font=b+"px monospace";d.textAlign="left";d.textBaseline="alphabetic";d.fillStyle=this.color.toString();b=d.measureText(a).width;f=f.multiplyBy(1/c.scale);d.translate(f.x,
f.y);d.rotate(e);d.fillText(a,0,0);d.translate(-f.x,-f.y);d.restore();a=new Point(b*Math.sin(radians(this.direction())),b*Math.cos(radians(this.direction())));a=a.add(new Point(this.xPosition(),this.yPosition()));this.gotoXY(a.x,a.y,!1);this.changed();c.changed()};SpriteMorph.prototype.setSize=function(a){isNaN(a)||(this.size=Math.min(Math.max(+a,1E-4),1E3))};SpriteMorph.prototype.changeSize=function(a){this.setSize(this.size+(+a||0))};
SpriteMorph.prototype.pasteOn=function(a){var b=1===this.rotationStyle?this.heading:90,c=1===a.rotationStyle?a.heading:90;if(this!==a&&this.costume&&a.costume){var d=this.costume;d instanceof SVG_Costume&&(d=d.rasterized());var e=a.costume instanceof SVG_Costume?a.costume.rasterized():a.costume.copy();if(a instanceof SpriteMorph)if(this instanceof SpriteMorph){var f=b-c;var g=this.scale/a.scale;c=this.parentThatIsA(StageMorph).scale;var h=a.center().distanceTo(this.center());var k=this.center().subtract(a.center());
k=Math.atan2(k.y,k.x);var l=(new Point(d.width(),d.height())).multiplyBy(.5*this.scale*c);var m=l.distanceTo(ZERO);l=Math.atan2(l.y,l.x);var n=(new Point(a.costume.width(),a.costume.height())).multiplyBy(.5*a.scale*c).rotateBy(radians(f));b=n.distanceAngle(h,degrees(k)-b+180);b=b.distanceAngle(m,degrees(l)-90);b=b.divideBy(c).divideBy(g).divideBy(a.scale)}else f=90-c,g=1/a.scale,h=a.center().distanceTo(this.position()),k=this.position().subtract(a.center()),k=Math.atan2(k.y,k.x),l=(new Point(a.costume.width(),
a.costume.height())).multiplyBy(.5*a.scale).rotateBy(radians(90-c)),b=l.distanceAngle(h/this.scale,degrees(k)+90);else f=b-90,g=this.scale,l=this.center().subtract(a.position()).divideBy(this.scale*a.scale).rotateBy(radians(b-90)),b=l.subtract((new Point(d.width(),d.height())).multiplyBy(.5));c=e.contents.getContext("2d");c.rotate(radians(f));c.scale(g,g);c.globalCompositeOperation="source-atop";c.drawImage(d.contents,b.x,b.y);a.doSwitchToCostume(e)}};SpriteMorph.prototype.down=function(){this.setPenDown(!0)};
SpriteMorph.prototype.up=function(){this.setPenDown(!1)};SpriteMorph.prototype.setPenDown=function(a,b){a?SpriteMorph.uber.down.call(this):SpriteMorph.uber.up.call(this);b||this.shadowAttribute("pen down?");this.instances.forEach(function(c){c.cachedPropagation&&c.inheritsAttribute("pen down?")&&c.setPenDown(a,!0)})};SpriteMorph.prototype.getPenDown=function(){return this.inheritsAttribute("pen down?")?this.exemplar.getPenDown():this.isDown};
SpriteMorph.prototype.getScale=function(){return this.inheritsAttribute("size")?this.exemplar.getScale():100*this.scale};
SpriteMorph.prototype.setScale=function(a,b){var c=this.xPosition(),d=this.yPosition();var e=(+a||0)/100;var f=e/this.nestingScale;this.nestingScale=e;this.scale=Math.max(e,.01);this.changed();this.fixLayout();this.rerender();this.silentGotoXY(c,d,!0);this.positionTalkBubble();this.parts.forEach(function(g){var h=g.xPosition()-c,k=g.yPosition()-d;g.setScale(100*g.scale*f);g.silentGotoXY(c+h*f,d+k*f)});b||this.shadowAttribute("size");this.instances.forEach(function(g){g.cachedPropagation&&g.inheritsAttribute("size")&&
g.setScale(a,!0)})};SpriteMorph.prototype.changeScale=function(a){this.setScale(this.getScale()+(+a||0))};SpriteMorph.prototype.graphicsChanged=function(){var a=this;return Object.keys(this.graphicsValues).some(function(b){return 0>a.graphicsValues[b]||0<a.graphicsValues[b]})};
SpriteMorph.prototype.applyGraphicsEffects=function(a){function b(p,t){var r,u;var v=p.width;var w=p.height;p=p.data;var x=q.createImageData(v,w);var y=x.data;var B=v/2;var A=w/2;t=Math.max(0,(t+100)/100);for(u=0;u<w;u++)for(r=0;r<v;r++){var C=(r-B)/B;var E=(u-A)/A;var I=Math.pow(Math.sqrt(C*C+E*E),t);1>=I?(E=Math.atan2(E,C),C=Math.floor(B+I*Math.cos(E)*B),E=Math.floor(A+I*Math.sin(E)*A)):(C=r,E=u);I=4*(u*v+r);C=4*(E*v+C);y[I]=p[C];y[I+1]=p[C+1];y[I+2]=p[C+2];y[I+3]=p[C+3]}return x}function c(p,t){var r;
var u=p.width;var v=p.height;p=p.data;var w=q.createImageData(u,v);var x=w.data;var y=u/2;var B=v/2;var A=Math.min(y,B);if(u<v){var C=v/u;var E=1}else C=1,E=u/v;var I=-radians(t);var J=A*A;for(r=0;r<v;r++)for(t=0;t<u;t++){var K=C*(t-y);var D=E*(r-B);var G=K*K+D*D;if(G<J){G=1-Math.sqrt(G)/A;G*=I*G;var O=Math.sin(G);var P=Math.cos(G);G=Math.floor((P*K-O*D)/C+y);D=Math.floor((O*K+P*D)/E+B)}else G=t,D=r;K=4*(r*u+t);D=4*(D*u+G);x[K]=p[D];x[K+1]=p[D+1];x[K+2]=p[D+2];x[K+3]=p[D+3]}return w}function d(p,
t){var r,u;var v=p.width;var w=p.height;p=p.data;var x=q.createImageData(v,w);var y=x.data;t=Math.floor(Math.abs(t/10)+1);for(u=0;u<w;u++)for(r=0;r<v;r++){var B=Math.floor(r/t)*t;var A=Math.floor(u/t)*t;var C=4*(u*v+r);B=4*(A*v+B);y[C]=p[B];y[C+1]=p[B+1];y[C+2]=p[B+2];y[C+3]=p[B+3]}return x}function e(p,t){var r;var u=p.data;var v=q.createImageData(p.width,p.height);var w=v.data;t=Math.round((Math.abs(t)+10)/10);t=Math.max(0,Math.min(t,Math.min(p.width,p.height)));p=0;for(r=u.length;p<r;p+=4){var x=
p*t%r;w[p]=u[x];w[p+1]=u[x+1];w[p+2]=u[x+2];w[p+3]=u[x+3]}return v}function f(p,t){var r;var u=p.data;for(r=0;r<u.length;r+=4)u[r]=u[r*t],u[r+1]=u[r*t+1],u[r+2]=u[r*t+2],u[r+3]=u[r*t+3];return p}function g(p,t,r,u){var v;var w=p.data;var x=0;for(v=w.length;x<v;x+=4){var y=w[x];var B=w[x+1];var A=w[x+2];var C=Math.max(y,B,A);var E=Math.min(y,B,A);var I=C-E;if(0===I)var J=y=0;else C===y?J=60*(B-A)/I:C===B?J=120+60*(A-y)/I:C===A&&(J=240+60*(y-B)/I),y=(C-E)/C;0>J&&(J+=360);C/=255;J=(J+360*t/200)%360;
y=Math.max(0,Math.min(y+r/100,1));C=Math.max(0,Math.min(C+u/100,1));B=Math.floor(J/60);I=J/60-B;A=C*(1-y);E=C*(1-y*I);y=C*(1-y*(1-I));if(0===B||6===B){var K=C;var D=y;var G=A}else 1===B?(K=E,D=C,G=A):2===B?(K=A,D=C,G=y):3===B?(K=A,D=E,G=C):4===B?(K=y,D=A,G=C):5===B&&(K=C,D=A,G=E);w[x]=255*K;w[x+1]=255*D;w[x+2]=255*G}return p}function h(p,t){var r;var u=p.data;var v=0;for(r=u.length;v<r;v+=4){var w=255-u[v];var x=255-u[v+1];var y=255-u[v+2];u[v]<w?u[v]+=t:u[v]>w&&(u[v]-=t);u[v+1]<x?u[v+1]+=t:u[v+1]>
x&&(u[v+1]-=t);u[v+2]<y?u[v+2]+=t:u[v+2]>y&&(u[v+2]-=t)}return p}function k(p,t){var r;var u=p.data;var v=0;for(r=u.length;v<r;v+=4)u[v]+=127*Math.sin(v*t)+128,u[v+1]+=127*Math.sin(v*t)+128,u[v+2]+=127*Math.sin(v*t)+128;return p}function l(p,t){var r;var u=p.data;var v=0;for(r=u.length;v<r;v+=1)u[v]=127*Math.sin(t*u[v])+u[v];return p}if(this.graphicsChanged()){var m=Math.ceil(this.width());var n=Math.ceil(this.height());if(!(a.width&&a.height&&m&&n))return a;var q=a.getContext("2d");m=q.getImageData(0,
0,m,n);this.graphicsValues.fisheye&&(m=b(m,this.graphicsValues.fisheye));this.graphicsValues.whirl&&(m=c(m,this.graphicsValues.whirl));this.graphicsValues.pixelate&&(m=d(m,this.graphicsValues.pixelate));this.graphicsValues.mosaic&&(m=e(m,this.graphicsValues.mosaic));this.graphicsValues.duplicate&&(m=f(m,this.graphicsValues.duplicate));if(this.graphicsValues.color||this.graphicsValues.saturation||this.graphicsValues.brightness)m=g(m,this.graphicsValues.color,this.graphicsValues.saturation,this.graphicsValues.brightness);
this.graphicsValues.negative&&(m=h(m,this.graphicsValues.negative));this.graphicsValues.comic&&(m=k(m,this.graphicsValues.comic));this.graphicsValues.confetti&&(m=l(m,this.graphicsValues.confetti));q.putImageData(m,0,0)}return a};
SpriteMorph.prototype.setEffect=function(a,b){a=a instanceof Array?a[0]:a.toString();if(!contains("color saturation brightness ghost fisheye whirl pixelate mosaic negative duplicate comic confetti".split(" "),a))throw Error(localize("unsupported graphic effect")+":\n"+a);"ghost"===a?this.alpha=1-Math.min(Math.max(+b||0,0),100)/100:this.graphicsValues[a]=+b;this.rerender()};
SpriteMorph.prototype.getEffect=function(a){a=a instanceof Array?a[0]:a.toString();return"ghost"===a?this.getGhostEffect():this.graphicsValues[a]||0};SpriteMorph.prototype.getGhostEffect=function(){return 100*(1-this.alpha)};SpriteMorph.prototype.changeEffect=function(a,b){var c=a instanceof Array?a[0]:a.toString();"ghost"===c?this.setEffect(a,this.getGhostEffect()+(+b||0)):this.setEffect(a,+this.graphicsValues[c]+ +b)};
SpriteMorph.prototype.clearEffects=function(){for(var a in this.graphicsValues)this.graphicsValues.hasOwnProperty(a)&&this.setEffect([a],0);this.setEffect(["ghost"],0)};SpriteMorph.prototype.stopTalking=function(){var a=this.talkBubble();a&&a.destroy()};SpriteMorph.prototype.doThink=function(a){this.bubble(a,!0)};SpriteMorph.prototype.bubble=function(a,b,c){var d=this.parentThatIsA(StageMorph);this.stopTalking();""===a||isNil(a)||(a=new SpriteBubbleMorph(a,d,b,c),this.add(a),this.positionTalkBubble())};
SpriteMorph.prototype.talkBubble=function(){return detect(this.children,function(a){return a instanceof SpeechBubbleMorph})};
SpriteMorph.prototype.positionTalkBubble=function(){var a=this.parentThatIsA(StageMorph),b=a?a.scale:1,c=this.talkBubble(),d=this.center().y;if(!c)return null;c.show();c.isPointingRight||(c.isPointingRight=!0,c.fixLayout(),c.rerender());c.setLeft(this.right());for(c.setBottom(this.top());!this.isTouching(c)&&c.bottom()<d;)c.moveBy((new Point(-1,1)).scaleBy(b));if(!a)return null;c.right()>a.right()&&(c.isPointingRight=!1,c.fixLayout(),c.rerender(),c.setRight(this.center().x));c.keepWithin(a)};
SpriteMorph.prototype.prepareToBeGrabbed=function(a){this.removeShadow();this.recordLayers();this.shadowAttribute("x position");this.shadowAttribute("y position");!this.bounds.containsPoint(a.position())&&this.isCorrectingOutsideDrag()&&this.setCenter(a.position());this.addShadow()};SpriteMorph.prototype.isCorrectingOutsideDrag=function(){return!this.parts.length};
SpriteMorph.prototype.justDropped=function(){var a=this,b=this.parentThatIsA(StageMorph);b&&(SnapActions.setSpritePosition(this),b.enableCustomHatBlocks=!0);this.exemplar&&this.inheritedAttributes.forEach(function(c){contains(["direction","size","costume #"],c)&&a.refreshInheritedAttribute(c)});this.restoreLayers();this.positionTalkBubble();this.receiveUserInteraction("dropped")};
SpriteMorph.prototype.drawLine=function(a,b){var c=this.parent.bounds.origin,d=this.parent.scale,e=this.parent.penTrails().getContext("2d"),f=a.subtract(c).divideBy(d),g=b.subtract(c).divideBy(d),h=f.multiplyBy(d).add(c);c=g.multiplyBy(d).add(c);d=h.rectangle(c).expandBy(Math.max(this.size*d/2,1)).intersect(this.parent.visibleBounds()).spread();this.isDown&&(StageMorph.prototype.enablePenLogging&&this.parent.trailsLog.push([this.snapPoint(a),this.snapPoint(b),this.color.copy(),this.size,this.useFlatLineEnds?
"butt":"round"]),e.lineWidth=this.size,e.strokeStyle=this.color.toString(),this.useFlatLineEnds?(e.lineCap="butt",e.lineJoin="miter"):(e.lineCap="round",e.lineJoin="round"),e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(g.x,g.y),e.stroke(),!1===this.isWarped&&this.world().broken.push(d),this.parent.cachedPenTrailsMorph=null)};
SpriteMorph.prototype.floodFill=function(){function a(m){m*=4;return[g[m],g[m+1],g[m+2],g[m+3]]}function b(m){return m[0]===k[0]&&m[1]===k[1]&&m[2]===k[2]&&m[3]===k[3]}if(this.parent.bounds.containsPoint(this.rotationCenter())){this.parent.cachedPenTrailsMorph=null;1<this.color.a&&(this.color.a/=255);var c=normalizeCanvas(this.parent.penTrails()),d=c.width,e=c.height;c=c.getContext("2d");var f=c.getImageData(0,0,d,e),g=f.data,h=[Math.round(e/2-this.yPosition())*d+Math.round(this.xPosition()+d/2)];
var k=a(h[0]);if(k[0]!==Math.round(this.color.r)||k[1]!==Math.round(this.color.g)||k[2]!==Math.round(this.color.b)||k[3]!==Math.round(255*this.color.a)){for(;0<h.length;){var l=h.pop();b(a(l))&&(1<l%d&&(h.push(l+1),h.push(l-1)),0<l&&l<e*d&&(h.push(l+d),h.push(l-d)));g[4*l]=Math.round(this.color.r);g[4*l+1]=Math.round(this.color.g);g[4*l+2]=Math.round(this.color.b);g[4*l+3]=Math.round(255*this.color.a)}c.putImageData(f,0,0);this.parent.changed()}}};
SpriteMorph.prototype.reportPenTrailsAsCostume=function(){var a=new Costume(this.parentThatIsA(StageMorph).trailsCanvas,this.newCostumeName(localize("Costume")));a.shrinkWrap();a.rotationCenter=a.rotationCenter.translateBy(new Point(this.xPosition(),-this.yPosition()));return a};
SpriteMorph.prototype.moveBy=function(a,b){var c=this.isDown&&!b&&this.parent?this.rotationCenter():null;SpriteMorph.uber.moveBy.call(this,a);c&&this.drawLine(c,this.rotationCenter());b||(this.parts.forEach(function(d){return d.moveBy(a)}),this.instances.forEach(function(d){if(d.cachedPropagation){var e=d.inheritsAttribute("x position"),f=d.inheritsAttribute("y position");e&&f?d.moveBy(a):e?d.moveBy(new Point(a.x,0)):f&&d.moveBy(new Point(0,a.y))}}))};
SpriteMorph.prototype.rootForGrab=function(){return this.anchor?this.anchor.rootForGrab():SpriteMorph.uber.rootForGrab.call(this)};SpriteMorph.prototype.setCenter=function(a,b){a=a.subtract(this.center());this.moveBy(a,b)};SpriteMorph.prototype.nestingBounds=function(){var a=this.bounds;!this.costume&&this.penBounds&&(a=this.penBounds.translateBy(this.position()));this.parts.forEach(function(b){b.isVisible&&(a=a.merge(b.nestingBounds()))});return a};
SpriteMorph.prototype.setPosition=function(a,b){a=a.subtract(this.topLeft());0===a.x&&0===a.y||this.moveBy(a,b)};
SpriteMorph.prototype.forward=function(a){a=a*this.parent.scale||0;0===a&&this.isDown?(this.isDown=!1,this.forward(-.05),this.isDown=!0,this.forward(.1),this.isDown=!1,this.forward(-.05),this.isDown=!0):(a=0<=a?this.position().distanceAngle(a,this.heading):this.position().distanceAngle(Math.abs(a),this.heading-180),this.shadowAttribute("x position"),this.shadowAttribute("y position"),this.setPosition(a),this.positionTalkBubble())};
SpriteMorph.prototype.setHeading=function(a,b){var c=this.xPosition(),d=this.yPosition(),e=isFinite(a)?+a:0,f=e-this.heading;this.rotationStyle?(this.changed(),SpriteMorph.uber.setHeading.call(this,e),this.silentGotoXY(c,d,!0),this.positionTalkBubble()):this.heading=(+a%360+360)%360;this.parts.forEach(function(g){var h=(new Point(g.xPosition(),g.yPosition())).rotateBy(radians(f),new Point(c,d));g.rotatesWithAnchor&&g.turn(f);g.gotoXY(h.x,h.y)});b||this.shadowAttribute("direction");this.instances.forEach(function(g){g.cachedPropagation&&
g.inheritsAttribute("direction")&&g.setHeading(a,!0)})};SpriteMorph.prototype.faceToXY=function(a,b){this.setHeading(this.angleToXY(a,b))};SpriteMorph.prototype.angleToXY=function(a,b){a=(a-this.xPosition())*this.parent.scale;b=(b-this.yPosition())*this.parent.scale;return(.001>Math.abs(a)?0>b?90:270:Math.round((0<=a?0:180)-57.2957795131*Math.atan(b/a)))+90};SpriteMorph.prototype.turn=function(a){this.setHeading(this.heading+(+a||0))};
SpriteMorph.prototype.turnLeft=function(a){this.setHeading(this.heading-(+a||0))};SpriteMorph.prototype.xPosition=function(){if(this.inheritsAttribute("x position"))return this.exemplar.xPosition();var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(this.rotationCenter().x-a.center().x)/a.scale:this.rotationCenter().x};
SpriteMorph.prototype.yPosition=function(){if(this.inheritsAttribute("y position"))return this.exemplar.yPosition();var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(a.center().y-this.rotationCenter().y)/a.scale:this.rotationCenter().y};SpriteMorph.prototype.direction=function(){return this.inheritsAttribute("direction")?this.exemplar.direction():this.heading};SpriteMorph.prototype.penSize=function(){return this.size};
SpriteMorph.prototype.gotoXY=function(a,b,c,d){var e=this.parentThatIsA(StageMorph);e&&(d||(this.shadowAttribute("x position"),this.shadowAttribute("y position")),a=isFinite(+a)?+a:0,b=isFinite(+b)?+b:0,a=e.center().x+a*e.scale,b=e.center().y-b*e.scale,b=this.costume?(new Point(a,b)).subtract(this.rotationOffset):(new Point(a,b)).subtract(this.extent().divideBy(2)),this.setPosition(b,c),this.positionTalkBubble())};
SpriteMorph.prototype.silentGotoXY=function(a,b,c){var d=this.isDown;this.isDown=!1;this.gotoXY(a,b,c,!0);this.isDown=d};SpriteMorph.prototype.setXPosition=function(a){this.shadowAttribute("x position");this.gotoXY(+a||0,this.yPosition(),!1,!0)};SpriteMorph.prototype.changeXPosition=function(a){this.setXPosition(this.xPosition()+(+a||0))};SpriteMorph.prototype.setYPosition=function(a){this.shadowAttribute("y position");this.gotoXY(this.xPosition(),+a||0,!1,!0)};
SpriteMorph.prototype.changeYPosition=function(a){this.setYPosition(this.yPosition()+(+a||0))};SpriteMorph.prototype.glide=function(a,b,c,d,e){b=new Point(b,c);a=Math.max(Math.min(d/a,1),0);e=e.add(b.subtract(e).multiplyBy(a));this.gotoXY(e.x,e.y)};
SpriteMorph.prototype.bounceOffEdge=function(){var a=this.parentThatIsA(StageMorph),b=this.nestingBounds();if(!a||a.bounds.containsRectangle(b))return null;var c=Math.cos(radians(this.heading-90));var d=-Math.sin(radians(this.heading-90));b.left()<a.left()&&(c=Math.abs(c));b.right()>a.right()&&(c=-Math.abs(c));b.top()<a.top()&&(d=-Math.abs(d));b.bottom()>a.bottom()&&(d=Math.abs(d));this.shadowAttribute("x position");this.shadowAttribute("y position");this.shadowAttribute("direction");this.setHeading(degrees(Math.atan2(-d,
c))+90);this.setPosition(this.position().add(b.amountToTranslateWithin(a.bounds)));this.positionTalkBubble()};SpriteMorph.prototype.snapPoint=function(a){var b=this.parentThatIsA(StageMorph),c=b.center();return new Point((a.x-c.x)/b.scale,(c.y-a.y)/b.scale)};SpriteMorph.prototype.setRotationX=function(a){this.setRotationCenter(new Point(a,this.yPosition()))};SpriteMorph.prototype.setRotationY=function(a){this.setRotationCenter(new Point(this.xPosition(),a))};
SpriteMorph.prototype.setRotationCenter=function(a){if(!this.costume)throw Error("setting the rotation center requires a costume");a=a.subtract(new Point(this.xPosition(),this.yPosition())).divideBy(this.scale).rotateBy(radians(90-this.heading));a=this.costume.rotationCenter.add(new Point(a.x,-a.y));this.costume.rotationCenter=a;this.changed();this.fixLayout();this.changed()};SpriteMorph.prototype.moveRotationCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"movePivot")};
SpriteMorph.prototype.setPivot=function(a){var b=this.parentThatIsA(StageMorph);if(b){var c=b.center();this.setRotationCenter(new Point((a.x-c.x)/b.scale,(c.y-a.y)/b.scale))}};SpriteMorph.prototype.xCenter=function(){var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(this.center().x-a.center().x)/a.scale:this.center().x};
SpriteMorph.prototype.yCenter=function(){var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(a.center().y-this.center().y)/a.scale:this.center().y};SpriteMorph.prototype.xLeft=function(){var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(this.left()-a.center().x)/a.scale:this.left()};
SpriteMorph.prototype.xRight=function(){var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(this.right()-a.center().x)/a.scale:this.right()};SpriteMorph.prototype.yTop=function(){var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(a.center().y-this.top())/a.scale:this.top()};
SpriteMorph.prototype.yBottom=function(){var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(a.center().y-this.bottom())/a.scale:this.bottom()};
SpriteMorph.prototype.allMessageNames=function(){var a=[],b=this.scripts.children.slice();this.customBlocks.forEach(function(c){c.body&&b.push(c.body.expression);c.scripts.forEach(function(d){return b.push(d)})});this.globalBlocks&&this.globalBlocks.forEach(function(c){c.body&&b.push(c.body.expression);c.scripts.forEach(function(d){return b.push(d)})});b.forEach(function(c){c.allChildren().forEach(function(d){d instanceof InputSlotMorph&&d.choices&&contains(["messagesMenu","messagesReceivedMenu"],
d.choices)&&(d=d.evaluate(),isString(d)&&""!==d&&(contains(a,d)||a.push(d)))})});return a};SpriteMorph.prototype.allSendersOf=function(a,b){"number"===typeof a&&(a=a.toString());return this.scripts.allChildren().filter(function(c){var d;if(c.selector&&contains(["doBroadcast","doBroadcastAndWait","doSend"],c.selector)){var e=c.inputs()[0].evaluate();"doSend"===c.selector&&(d=c.inputs()[1].evaluate());return("doSend"!==c.selector||b===d)&&(e===a||a instanceof Array&&"any message"===a[0])}return!1})};
SpriteMorph.prototype.allHatBlocksFor=function(a){"number"===typeof a&&(a=a.toString());return this.scripts.children.filter(function(b){if(b.selector){if("receiveMessage"===b.selector)return b=b.inputs()[0].evaluate(),b===a||b instanceof Array&&"__shout__go__"!==a&&"__clone__init__"!==a;if("receiveGo"===b.selector)return"__shout__go__"===a;if("receiveOnClone"===b.selector)return"__clone__init__"===a}return!1})};
SpriteMorph.prototype.allHatBlocksForKey=function(a){return this.scripts.children.filter(function(b){return b.selector&&"receiveKey"===b.selector?(b=b.inputs()[0].evaluate()[0],b===a||"any key"===b):!1})};SpriteMorph.prototype.allHatBlocksForInteraction=function(a){return this.scripts.children.filter(function(b){return b.selector&&"receiveInteraction"===b.selector?b.inputs()[0].evaluate()[0]===a:!1})};
SpriteMorph.prototype.allGenericHatBlocks=function(){return this.scripts.children.filter(function(a){return a.selector?"receiveCondition"===a.selector:!1})};SpriteMorph.prototype.mouseClickLeft=function(){return this.receiveUserInteraction("clicked")};SpriteMorph.prototype.mouseEnter=function(){return this.receiveUserInteraction("mouse-entered")};SpriteMorph.prototype.mouseDownLeft=function(){return this.receiveUserInteraction("pressed")};
SpriteMorph.prototype.mouseScroll=function(a){return this.receiveUserInteraction("scrolled-"+(0<a?"up":"down"))};SpriteMorph.prototype.receiveUserInteraction=function(a,b,c){var d=this,e=this.parentThatIsA(StageMorph),f=[];if(e)return this.allHatBlocksForInteraction(a).forEach(function(g){return f.push(e.threads.startProcess(g,d,c||e.isThreadSafe,null,null,null,b,"stopped"===a))}),f};SpriteMorph.prototype.mouseDoubleClick=function(){this.isTemporary||this.edit()};
SpriteMorph.prototype.getTimer=function(){var a=this.parentThatIsA(StageMorph);return a?a.getTimer():0};SpriteMorph.prototype.getTempo=function(){var a=this.parentThatIsA(StageMorph);return a?a.getTempo():0};SpriteMorph.prototype.getLastMessage=function(){var a=this.parentThatIsA(StageMorph);return a?a.getLastMessage():""};SpriteMorph.prototype.getLastAnswer=function(){return this.parentThatIsA(StageMorph).lastAnswer};
SpriteMorph.prototype.reportMouseX=function(){var a=this.parentThatIsA(StageMorph);return a?a.reportMouseX():0};SpriteMorph.prototype.reportMouseY=function(){var a=this.parentThatIsA(StageMorph);return a?a.reportMouseY():0};SpriteMorph.prototype.reportThreadCount=function(){var a=this.parentThatIsA(StageMorph);return a?a.threads.processes.length:0};
SpriteMorph.prototype.refactorVariableInstances=function(a,b,c){c&&this.hasSpriteVariable(a)||this.scripts.children.forEach(function(d){d instanceof BlockMorph&&d.refactorVarInStack(a,b)})};SpriteMorph.prototype.findVariableWatcher=function(a){var b=this,c=this.parentThatIsA(StageMorph),d=this.globalVariables();return null===c?null:detect(c.children,function(e){return e instanceof WatcherMorph&&(e.target===b.variables||e.target===d)&&e.getter===a})};
SpriteMorph.prototype.toggleVariableWatcher=function(a,b,c){var d=this.parentThatIsA(StageMorph),e=this.parentThatIsA(IDE_Morph),f=this.globalVariables();if(null===d)return null;isNil(b)&&(b=contains(f.names(),a));var g=this.findVariableWatcher(a);c||SnapActions.toggleVariableWatcher(a,b,g&&g.isVisible);if(null!==g)g.isVisible?g.hide():(g.show(),g.fixLayout(),g.keepWithin(d)),b&&(e.flushBlocksCache("variables"),e.refreshPalette()),this.refreshVariableWatcher(a);else return g=new WatcherMorph(a,this.blockColor.variables,
b?f:this.variables,a),g.setPosition(d.position().add(10)),b=d.watchers(g.left()),0<b.length&&g.setTop(b[b.length-1].bottom()),g.fixLayout(),g.keepWithin(d),d.add(g),g.changed(),this.refreshVariableWatcher(a),g};SpriteMorph.prototype.findVariableWatcherToggle=function(a,b){b=b||this.palette("variables");b=b.contents.children;for(var c=2;c<b.length-2&&b[c]instanceof ToggleMorph;){if(b[c+1].blockSpec===a)return b[c];c+=2}};
SpriteMorph.prototype.refreshVariableWatcher=function(a){var b=this,c=this.parentThatIsA(IDE_Morph);c&&c.sprites.asArray().concat(c.stage).map(function(d){return d.palette("variables")}).map(function(d){return b.findVariableWatcherToggle(a,d)}).filter(function(d){return!!d}).forEach(function(d){return d.refresh()})};SpriteMorph.prototype.showingVariableWatcher=function(a){return null===this.parentThatIsA(StageMorph)?!1:(a=this.findVariableWatcher(a))?a.isVisible:!1};
SpriteMorph.prototype.deleteVariableWatcher=function(a){if(null===this.parentThatIsA(StageMorph))return null;a=this.findVariableWatcher(a);null!==a&&a.destroy()};
SpriteMorph.prototype.toggleWatcher=function(a,b,c){var d=this.parentThatIsA(StageMorph),e=this.parentThatIsA(IDE_Morph);if(d){var f=this.watcherFor(d,a);SnapActions.toggleWatcher(a,f&&f.isVisible);f?f.isVisible?f.hide():(f.show(),f.fixLayout(),f.keepWithin(d)):(f=new WatcherMorph(b,c,WatcherMorph.prototype.isGlobal(a)?d:this,a),f.setPosition(d.position().add(10)),b=d.watchers(f.left()),0<b.length&&f.setTop(b[b.length-1].bottom()),d.add(f),f.fixLayout(),f.keepWithin(d),f.changed());f.isGlobal(a)&&
(e.flushBlocksCache(),e.refreshPalette())}};SpriteMorph.prototype.showingWatcher=function(a){var b=this.parentThatIsA(StageMorph);return null===b?!1:(a=this.watcherFor(b,a))?a.isVisible:!1};SpriteMorph.prototype.watcherFor=function(a,b){var c=this;return detect(a.children,function(d){return d instanceof WatcherMorph&&d.getter===b&&d.target===(d.isGlobal(b)?a:c)})};
SpriteMorph.prototype.deleteAllBlockInstances=function(a){(a.isGlobal?this.allBlockInstances(a):this.allIndependentInvocationsOf(a.blockSpec())).forEach(function(b){return b.deleteBlock()});if(a.isGlobal){if(a=this.parentThatIsA(StageMorph))a.globalBlocks.forEach(function(b){return b.purgeCorpses()}),a.children.concat(a).forEach(function(b){b.isSnapObject&&b.customBlocks.forEach(function(c){return c.purgeCorpses()})})}else this.allSpecimens().concat(this).forEach(function(b){return b.customBlocks.forEach(function(c){return c.purgeCorpses()})})};
SpriteMorph.prototype.allBlockInstances=function(a){var b=[];if(a.isGlobal){var c=this.parentThatIsA(StageMorph);var d=c.children.filter(function(f){return f instanceof SpriteMorph});d.push(c);d.forEach(function(f){return b=b.concat(f.allLocalBlockInstances(a))});var e=[];c.globalBlocks.forEach(function(f){f.scripts.forEach(function(g){return g.allChildren().forEach(function(h){h.isCustomBlock&&h.definition===a&&e.push(h)})});f.body&&f.body.expression.allChildren().forEach(function(g){g.isCustomBlock&&
g.definition===a&&e.push(g)})});return b.concat(e)}return this.allLocalBlockInstances(a)};SpriteMorph.prototype.allIndependentInvocationsOf=function(a){if(this.exemplar&&this.exemplar.getMethod(a))return[];var b=this.allInvocationsOf(a);this.instances.forEach(function(c){return c.addAllInvocationsOf(a,b)});return b};SpriteMorph.prototype.allDependentInvocationsOf=function(a){var b=this.allInvocationsOf(a);this.instances.forEach(function(c){return c.addAllInvocationsOf(a,b)});return b};
SpriteMorph.prototype.allInvocationsOf=function(a){var b=this.scripts.allChildren().filter(function(e){return e.isCustomBlock&&!e.isGlobal&&e.blockSpec===a});var c=[];this.customBlocks.forEach(function(e){e.scripts.forEach(function(f){return f.allChildren().forEach(function(g){g.isCustomBlock&&!g.isGlobal&&g.blockSpec===a&&c.push(g)})});e.body&&e.body.expression.allChildren().forEach(function(f){f.isCustomBlock&&!f.isGlobal&&f.blockSpec===a&&c.push(f)})});var d=this.allEditorBlockInstances(null,a);
return b.concat(c).concat(d)};SpriteMorph.prototype.addAllInvocationsOf=function(a,b){this.getLocalMethod(a)||(this.allInvocationsOf(a).forEach(function(c){return b.push(c)}),this.instances.forEach(function(c){return c.addAllInvocationsOf(a,b)}))};
SpriteMorph.prototype.allLocalBlockInstances=function(a){var b=this.scripts.allChildren().filter(function(f){return f.isCustomBlock&&f.definition===a});var c=[];this.customBlocks.forEach(function(f){f.body&&f.body.expression.allChildren().forEach(function(g){g.isCustomBlock&&g.definition===a&&c.push(g)})});var d=this.allEditorBlockInstances(a);var e=this.paletteBlockInstance(a);b=b.concat(c).concat(d);e&&b.push(e);return b};
SpriteMorph.prototype.allEditorBlockInstances=function(a,b){var c=[];if(!this.world())return[];this.world().children.forEach(function(d){d instanceof BlockEditorMorph&&d.body.contents.allChildren().forEach(function(e){a?e.isPrototype||e instanceof PrototypeHatBlockMorph||e.definition!==a||c.push(e):!e.isCustomBlock||e.isGlobal||e.isPrototype||e instanceof PrototypeHatBlockMorph||e.blockSpec!==b||c.push(e)})});return c};
SpriteMorph.prototype.paletteBlockInstance=function(a){var b=this.parentThatIsA(IDE_Morph);return b?detect(b.palette.contents.children,function(c){return c.isCustomBlock&&c.definition===a}):null};
SpriteMorph.prototype.usesBlockInstance=function(a,b,c,d){if(detect(this.scripts.allChildren(),function(f){return f.isCustomBlock&&f.definition===a}))return!0;if(a.isGlobal&&!c){var e=[];this.parentThatIsA(StageMorph).globalBlocks.forEach(function(f){b&&a===f||d&&contains(d,f)||f.body&&f.body.expression.allChildren().forEach(function(g){g.isCustomBlock&&g.definition===a&&e.push(g)})});if(0<e.length)return!0}e=[];this.customBlocks.forEach(function(f){f.body&&f.body.expression.allChildren().forEach(function(g){g.isCustomBlock&&
g.definition===a&&e.push(g)})});return 0<e.length};SpriteMorph.prototype.doubleDefinitionsFor=function(a){var b=a.blockSpec();if(a.isGlobal){var c=this.parentThatIsA(StageMorph);if(!c)return[];c=c.globalBlocks}else c=this.customBlocks;var d=c.indexOf(a);return-1===d?[]:c.filter(function(e,f){return e.blockSpec()===b&&f!==d})};
SpriteMorph.prototype.replaceDoubleDefinitionsFor=function(a){var b=this,c=this.doubleDefinitionsFor(a);c.forEach(function(e){return b.allBlockInstances(e).forEach(function(f){f.definition=a;f.refresh()})});if(a.isGlobal){var d=this.parentThatIsA(StageMorph);d.globalBlocks=d.globalBlocks.filter(function(e){return!contains(c,e)})}else this.customBlocks=this.customBlocks.filter(function(e){return!contains(c,e)});if(d=this.parentThatIsA(IDE_Morph))d.flushPaletteCache(),d.refreshPalette()};
SpriteMorph.prototype.chooseExemplar=function(){var a=this,b=this.parentThatIsA(StageMorph).children.filter(function(d){return d instanceof SpriteMorph&&!d.isTemporary&&!contains(d.allExemplars(),a)});var c=new MenuMorph(function(d){return a.setExemplar(d)},localize("current parent")+":\n"+(this.exemplar?this.exemplar.name:localize("none")));b.forEach(function(d){return c.addItem(d.name,d,null,null,null,null,null,null,!0)});c.addLine();c.addItem(localize("none"),null);c.popUpAtHand(this.world())};
SpriteMorph.prototype.setExemplar=function(a,b){if(a instanceof SpriteMorph&&contains(a.allExemplars(),this)){if(b)throw Error(localize("unable to inherit\n(disabled or circular?)"));}else if(this.emancipate(),(this.exemplar=a)?(this.variables.parentFrame=a.variables,a.addSpecimen(this)):this.variables.parentFrame=this.globalVariables(),this.isTemporary)this.cloneOriginName=a.cloneOriginName||a.name;else if(a=this.parentThatIsA(IDE_Morph))a.flushBlocksCache(),a.refreshPalette()};
SpriteMorph.prototype.prune=function(){this.instances.forEach(function(a){a.shadowAllAttributes();a.shadowAllMethods();a.shadowAllVars();a.exemplar=null});this.instances=[]};SpriteMorph.prototype.emancipate=function(){this.exemplar&&(this.isTemporary||(this.shadowAllAttributes(),this.shadowAllMethods(),this.shadowAllVars()),this.exemplar.removeSpecimen(this),this.exemplar=null)};SpriteMorph.prototype.allExemplars=function(){for(var a=[],b=this;!isNil(b);)a.push(b),b=b.exemplar;return a};
SpriteMorph.prototype.specimens=function(){return this.instances};SpriteMorph.prototype.allSpecimens=function(){var a=this.instances.slice();this.instances.forEach(function(b){return a.push.apply(a,b.allSpecimens())});return a};SpriteMorph.prototype.addSpecimen=function(a){this.instances.push(a)};SpriteMorph.prototype.removeSpecimen=function(a){a=this.instances.indexOf(a);-1!==a&&this.instances.splice(a,1)};
SpriteMorph.prototype.inheritsAttribute=function(a){return!isNil(this.exemplar)&&contains(this.inheritedAttributes,a)};SpriteMorph.prototype.updatePropagationCache=function(){var a=this;this.cachedPropagation=!isNil(this.exemplar)&&detect("x position;y position;direction;size;costume #;volume;balance;shown?;pen down?".split(";"),function(b){return contains(a.inheritedAttributes,b)})};
SpriteMorph.prototype.shadowedAttributes=function(){var a=this.inheritedAttributes;return this.attributes.filter(function(b){return!contains(a,b)})};SpriteMorph.prototype.shadowAllAttributes=function(){var a=this;this.attributes.forEach(function(b){return a.shadowAttribute(b)})};
SpriteMorph.prototype.shadowAttribute=function(a){var b=this;if(this.inheritsAttribute(a)){var c=this.parentThatIsA(IDE_Morph);this.inheritedAttributes=this.inheritedAttributes.filter(function(g){return g!==a});if("costumes"===a){var d=new List;this.costumes.asArray().forEach(function(g){var h=g.copy();d.add(h);g===b.costume&&b.wearCostume(h)});this.costumes=d;this.instances.forEach(function(g){g.inheritsAttribute("costumes")&&g.refreshInheritedAttribute("costumes")})}else if("sounds"===a){var e=
new List;this.sounds.asArray().forEach(function(g){return e.add(g.copy())});this.sounds=e;this.instances.forEach(function(g){g.inheritsAttribute("sounds")&&g.refreshInheritedAttribute("sounds")})}else if("scripts"===a){c.stage.threads.stopAllForReceiver(this);var f=this.scripts.position();this.scripts=this.exemplar.scripts.fullCopy();c&&contains(c.currentSprite.allExemplars(),this)&&(c.createSpriteEditor(),c.fixLayout("selectSprite"),this.scripts.fixMultiArgs(),this.scripts.setPosition(f),c.spriteEditor.adjustScrollBars());
this.instances.forEach(function(g){g.inheritsAttribute("scripts")&&g.refreshInheritedAttribute("scripts")})}else this.updatePropagationCache(),c&&!this.isTemporary&&(c.flushBlocksCache(),c.refreshPalette())}};SpriteMorph.prototype.inheritAttribute=function(a){var b=this.parentThatIsA(IDE_Morph);this.exemplar&&contains(this.attributes,a)&&!this.inheritsAttribute(a)&&(this.inheritedAttributes.push(a),this.refreshInheritedAttribute(a),b&&(b.flushBlocksCache(),b.refreshPalette()))};
SpriteMorph.prototype.refreshInheritedAttribute=function(a){switch(a){case "x position":case "y position":this.cachedPropagation=!0;this.gotoXY(this.xPosition(),this.yPosition(),!1,!0);break;case "direction":this.cachedPropagation=!0;this.setHeading(this.direction(),!0);break;case "size":this.cachedPropagation=!0;this.setScale(this.getScale(),!0);break;case "costume #":this.cachedPropagation=!0;this.inheritsAttribute("costumes")?this.wearCostume(this.exemplar.costume,!0):this.doSwitchToCostume(this.getCostumeIdx(),
!0);break;case "volume":this.cachedPropagation=!0;this.setVolume(this.getVolume(),!0);break;case "shown?":this.cachedPropagation=!0;this.setVisibility(this.reportShown(),!0);break;case "pen down?":this.cachedPropagation=!0;this.setPenDown(this.getPenDown(),!0);break;case "balance":this.cachedPropagation=!0;this.setPan(this.getPan(),!0);break;case "costumes":a=this.getCostumeIdx();this.costumes=this.exemplar.costumes;this.doSwitchToCostume(a,!0);this.instances.forEach(function(b){b.inheritsAttribute("costumes")&&
b.refreshInheritedAttribute("costumes")});break;case "sounds":this.sounds=this.exemplar.sounds;this.instances.forEach(function(b){b.inheritsAttribute("sounds")&&b.refreshInheritedAttribute("sounds")});break;case "scripts":this.scripts=this.exemplar.scripts;if(a=this.parentThatIsA(IDE_Morph))a.stage.threads.stopAllForReceiver(this),contains(a.currentSprite.allExemplars(),this)&&(a.createSpriteEditor(),a.fixLayout("selectSprite"));this.instances.forEach(function(b){b.inheritsAttribute("scripts")&&b.refreshInheritedAttribute("scripts")});
break;default:nop()}};SpriteMorph.prototype.toggleInheritanceForAttribute=function(a){this.inheritsAttribute(a)?this.shadowAttribute(a):this.inheritAttribute(a)};SpriteMorph.prototype.isVariableNameInUse=function(a,b){return b?contains(this.variables.allNames(),a):contains(this.variables.names(),a)?!0:contains(this.globalVariables().names(),a)};SpriteMorph.prototype.globalVariables=function(){for(var a=this.variables.parentFrame;a.owner;)a=a.parentFrame;return a};
SpriteMorph.prototype.shadowAllVars=function(){var a=this;this.inheritedVariableNames().forEach(function(b){return a.shadowVar(b,a.variables.getVar(b))})};SpriteMorph.prototype.shadowVar=function(a,b){this.variables.addVar(a,b);!this.isTemporary&&(a=this.parentThatIsA(IDE_Morph))&&(a.flushBlocksCache("variables"),a.refreshPalette())};
SpriteMorph.prototype.toggleInheritedVariable=function(a){contains(this.inheritedVariableNames(!0),a)?this.deleteVariable(a):contains(this.inheritedVariableNames(),a)&&this.shadowVar(a,this.variables.getVar(a))};SpriteMorph.prototype.inheritedVariableNames=function(a){function b(f){return a?contains(d,f):!contains(d,f)}for(var c=[],d=this.variables.names(),e=this.variables.parentFrame;e.owner instanceof SpriteMorph;)c.push.apply(c,e.names().filter(b)),e=e.parentFrame;return c};
SpriteMorph.prototype.deletableVariableNames=function(){var a=this.variables.names(),b=this.inheritedVariableNames();return a.concat(this.globalVariables().names().filter(function(c){return!contains(a,c)&&!contains(b,c)}))};SpriteMorph.prototype.hasSpriteVariable=function(a){return contains(this.variables.names(),a)};SpriteMorph.prototype.allLocalVariableNames=function(a){function b(d,e){return d.toLowerCase()<e.toLowerCase()?-1:1}var c=this.variables.names();a&&c.sort(b);return c};
SpriteMorph.prototype.reachableGlobalVariableNames=function(a){function b(e,f){return e.toLowerCase()<f.toLowerCase()?-1:1}var c=this.allLocalVariableNames();var d=this.globalVariables().names().filter(function(e){return!contains(c,e)});a&&d.sort(b);return d};SpriteMorph.prototype.getMethod=function(a){return this.allBlocks()[a]};SpriteMorph.prototype.getLocalMethod=function(a){return this.ownBlocks()[a]};
SpriteMorph.prototype.ownBlocks=function(){var a={};this.customBlocks.forEach(function(b){return a[b.blockSpec()]=b});return a};SpriteMorph.prototype.allBlocks=function(a){var b={};this.allExemplars().reverse().forEach(function(c){return c.customBlocks.forEach(function(d){return b[d.blockSpec()]=d})});return a?Object.keys(b).map(function(c){return b[c]}):b};
SpriteMorph.prototype.inheritedBlocks=function(a){var b={},c=Object.keys(this.ownBlocks()),d=this.allExemplars().reverse();d.pop();d.forEach(function(e){return e.customBlocks.forEach(function(f){var g=f.blockSpec();contains(c,g)||(b[g]=f)})});return a?Object.keys(b).map(function(e){return b[e]}):b};
SpriteMorph.prototype.shadowAllMethods=function(){var a=this,b;this.inheritedMethods().forEach(function(c){return a.customBlocks.push(c)});!this.isTemporary&&(b=this.parentThatIsA(IDE_Morph))&&(b.flushPaletteCache(),b.refreshPalette())};SpriteMorph.prototype.inheritedMethods=function(){var a=this;return this.inheritedBlocks(!0).map(function(b){return b.copyAndBindTo(a,!0)})};
SpriteMorph.prototype.thumbnail=function(a,b){function c(n,q,p){var t=Math.min(a.x,a.y)/10;m.strokeStyle=n;m.globalAlpha=q;m.compositeOperation="lighter";m.lineWidth=p||1;m.moveTo(t,t);m.lineTo(l.width-t,l.height-t);m.moveTo(t,l.height-t);m.lineTo(l.width-t,t);m.stroke()}var d=this.getImage(),e=this.width(),f=this.height(),g=Math.min(a.x/e,a.y/f),h=(a.x-e*g)/2,k=(a.y-f*g)/2,l=newCanvas(a,!1,b),m=l.getContext("2d");m.save();this.isCorpse&&(m.globalAlpha=.3);e&&f&&d.width&&d.height&&(m.scale(g,g),m.drawImage(d,
Math.floor(h/g),Math.floor(k/g)));this.isCorpse&&(m.restore(),c("white",.8,6),c("black",.8,1));m.restore();return l};SpriteMorph.prototype.fullThumbnail=function(a,b){b=this.thumbnail(a,b);var c=b.getContext("2d"),d=a.divideBy(3),e;c.restore();this.anchor&&c.drawImage(this.anchor.thumbnail(d),0,0);for(e=0;3>e;e+=1)this.parts[e]&&c.drawImage(this.parts[e].thumbnail(d),e*d.x,a.y-d.y);return b};SpriteMorph.prototype.booleanMorph=function(a){a=new BooleanSlotMorph(a);a.isStatic=!0;a.fixLayout();return a};
SpriteMorph.prototype.attachTo=function(a){a.attachPart(this)};SpriteMorph.prototype.attachPart=function(a){var b=Date.now();a.anchor&&a.anchor.detachPart(a);this.parts.push(a);this.version=b;a.anchor=this;this.allParts().forEach(function(c){return c.nestingScale=c.scale});a.version=b};SpriteMorph.prototype.detachPart=function(a){var b=this.parts.indexOf(a);if(-1!==b){var c=Date.now();this.parts.splice(b,1);this.version=c;a.anchor=null;a.version=c}};
SpriteMorph.prototype.detachAllParts=function(){var a=Date.now();this.parts.forEach(function(b){b.anchor=null;b.version=a});this.parts=[];this.version=a};SpriteMorph.prototype.detachFromAnchor=function(){this.anchor&&this.anchor.detachPart(this)};SpriteMorph.prototype.allParts=function(){var a=[this];this.parts.forEach(function(b){return a=a.concat(b.allParts())});return a};SpriteMorph.prototype.allAnchors=function(){var a=[this];null!==this.anchor&&(a=a.concat(this.anchor.allAnchors()));return a};
SpriteMorph.prototype.recordLayers=function(){var a=this.parentThatIsA(StageMorph);a?(this.layers=this.allParts(),this.layers.forEach(function(b){(b=b.talkBubble())&&b.hide()}),this.layers.sort(function(b,c){return a.children.indexOf(b)<a.children.indexOf(c)?-1:1})):this.layerCache=null};SpriteMorph.prototype.restoreLayers=function(){this.layers&&1<this.layers.length&&this.layers.forEach(function(a){a.comeToFront();a.positionTalkBubble()});this.layers=null};
SpriteMorph.prototype.destroy=function(){this.anchor&&this.anchor.detachPart(this);this.emancipate();this.isTemporary||this.prune();SpriteMorph.uber.destroy.call(this)};SpriteMorph.prototype.flash=function(){var a=this,b=this.world();this.addHighlight();b.animations.push(new Animation(nop,nop,0,800,nop,function(){return a.removeHighlight()}))};
SpriteMorph.prototype.addHighlight=function(a){var b=!this.isVisible;b&&this.show();a=this.highlight(a?a.color:this.highlightColor,this.highlightBorder);this.addBack(a);this.fullChanged();b&&this.hide();return a};SpriteMorph.prototype.removeHighlight=function(){var a=this.getHighlight();null!==a&&(this.fullChanged(),this.removeChild(a));return a};SpriteMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()};
SpriteMorph.prototype.highlight=function(a,b){var c=new SpriteHighlightMorph,d=this.bounds;c.bounds.setExtent(d.extent().add(2*b));c.color=a;c.cachedImage=this.highlightImage(a,b);a=c.cachedImage.getContext("2d");a.drawImage(this.highlightImage(WHITE,4),b-4,b-4);a.drawImage(this.highlightImage(new Color(50,50,50),2),b-2,b-2);a.drawImage(this.highlightImage(WHITE,1),b-1,b-1);c.setPosition(d.origin.subtract(new Point(b,b)));return c};
SpriteMorph.prototype.highlightImage=function(a,b){var c=this.extent();var d=this.getImage();var e=newCanvas(c.add(2*b));var f=e.getContext("2d");f.drawImage(d,0,0);f.drawImage(d,b,0);f.drawImage(d,2*b,0);f.drawImage(d,2*b,b);f.drawImage(d,2*b,2*b);f.drawImage(d,b,2*b);f.drawImage(d,0,2*b);f.drawImage(d,0,b);f.globalCompositeOperation="destination-out";f.drawImage(d,b,b);b=newCanvas(c.add(2*b));f=b.getContext("2d");f.drawImage(e,0,0);f.globalCompositeOperation="source-atop";f.fillStyle=a.toString();
f.fillRect(0,0,b.width,b.height);return b};SpriteMorph.prototype.getHighlight=function(){var a=this.children.slice(0).reverse().filter(function(b){return b instanceof SpriteHighlightMorph});return 0!==a.length?a[0]:null};SpriteMorph.prototype.mouseEnterDragging=function(){if(this.enableNesting){var a=this.world().hand.children[0];this.wantsDropOf(a)&&this.addHighlight()}};SpriteMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed");this.enableNesting&&this.removeHighlight()};
SpriteMorph.prototype.wantsDropOf=function(a){return this.enableNesting&&a instanceof SpriteIconMorph&&!contains(a.object.allParts(),this)};SpriteMorph.prototype.reactToDropOf=function(a,b){this.removeHighlight();SnapActions.attachParts(this,[a.object]);this.world().add(a);a.slideBackTo(b.grabOrigin)};
SpriteMorph.prototype.newCostumeName=function(a,b){var c=a.indexOf("(");a=0>c?a:a.substring(0,c);c=1;for(var d=a,e=this.costumes.asArray().filter(function(f){return f!==b}).map(function(f){return f.name});contains(e,d);)c+=1,d=a+"("+c+")";return d};
SpriteMorph.prototype.doScreenshot=function(a,b){var c=this.parentThatIsA(StageMorph);b=this.newCostumeName(b);if(void 0!==a[0]){if("pen trails"===a[0]){a=c.trailsCanvas;var d=(new Costume(a,b)).copy()}else"stage image"===a[0]&&(a=c.fullImage(),d=new Costume(a,b));this.addCostume(d)}};
SpriteMorph.prototype.newSoundName=function(a,b){var c=a.indexOf("(");a=0>c?a:a.substring(0,c);c=1;for(var d=a,e=this.sounds.asArray().filter(function(f){return f!==b}).map(function(f){return f.name});contains(e,d);)c+=1,d=a+"("+c+")";return d};SpriteHighlightMorph.prototype=new Morph;SpriteHighlightMorph.prototype.constructor=SpriteHighlightMorph;SpriteHighlightMorph.uber=Morph.prototype;function SpriteHighlightMorph(){this.init()}
SpriteHighlightMorph.prototype.init=function(){SpriteHighlightMorph.uber.init.call(this);this.isCachingImage=!0};StageMorph.prototype=new FrameMorph;StageMorph.prototype.constructor=StageMorph;StageMorph.uber=FrameMorph.prototype;StageMorph.prototype.dimensions=new Point(480,360);StageMorph.prototype.frameRate=0;StageMorph.prototype.isCachingPrimitives=SpriteMorph.prototype.isCachingPrimitives;StageMorph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;
StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor;StageMorph.prototype.hiddenPrimitives={};StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=!1;StageMorph.prototype.enableInheritance=!0;StageMorph.prototype.enableSublistIDs=!1;StageMorph.prototype.enablePenLogging=!1;function StageMorph(a){this.init(a)}
StageMorph.prototype.init=function(a){this.name=localize("Stage");this.instrument=null;this.threads=new ThreadManager;this.variables=new VariableFrame(a||null,this);this.scripts=new ScriptsMorph;this.customBlocks=[];this.globalBlocks=[];this.costumes=new List;this.costume=null;this.sounds=new List;this.version=Date.now();this.isFastTracked=!1;this.enableCustomHatBlocks=!0;this.cloneCount=0;this.timerStart=Date.now();this.tempo=60;this.lastMessage="";this.volume=100;this.gainNode=null;this.pan=0;this.freqPlayer=
this.pannerNode=null;this.watcherUpdateFrequency=2;this.lastWatcherUpdate=Date.now();this.scale=1;this.cachedHSV=[0,0,0];this.keysPressed={};this.blocksCache={};this.paletteCache={};this.lastAnswer="";this.activeSounds=[];this.trailsCanvas=null;this.trailsLog=[];this.isThreadSafe=!1;this.microphone=new Microphone;this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0};this.stopProjectionSource=this.getProjectionImage=
this.projectionSource=this.remixID=this.cachedPenTrailsMorph=null;this.continuousProjection=!1;this.projectionCanvas=null;this.projectionTransparency=50;this.mirrorVideo=!0;this.videoMotion=null;this.messageCallbacks={};StageMorph.uber.init.call(this);this.isCachingImage=!0;this.cachedHSV=this.color.hsv();this.acceptsDrops=!1;this.setColor(new Color(255,255,255));this.fps=this.frameRate};
StageMorph.prototype.setScale=function(a){var b=this,c=a/this.scale,d=this.position(),e,f;1!==c&&(this.cachedPenTrailsMorph=null,this.scale=a,this.setExtent(this.dimensions.multiplyBy(a)),this.children.forEach(function(g){e=g.position().subtract(d);g.fixLayout();g.setPosition(e.multiplyBy(c).add(d),!0);if(g instanceof SpriteMorph){if(g.rerender(),f=g.talkBubble())f.setScale(a),g.positionTalkBubble()}else g instanceof StagePrompterMorph&&(1>b.scale?g.setWidth(b.width()-10):g.setWidth(b.dimensions.x-
20),g.setCenter(b.center()),g.setBottom(b.bottom()))}))};StageMorph.prototype.moveBy=function(a){var b=this.children,c=b.length;this.changed();this.bounds=this.bounds.translateBy(a);this.changed();for(c;0<c;--c)b[c-1].moveBy(a,!0)};
StageMorph.prototype.render=function(a){a.save();a.fillStyle=this.color.toString();a.fillRect(0,0,this.width(),this.height());this.costume&&(a.scale(this.scale,this.scale),a.drawImage(this.costume.contents,(this.width()/this.scale-this.costume.width())/2,(this.height()/this.scale-this.costume.height())/2),this.cachedImage=this.applyGraphicsEffects(this.cachedImage));a.restore();this.version=Date.now()};
StageMorph.prototype.drawOn=function(a,b){var c=b.intersect(this.bounds);if(this.isVisible&&c.extent().gt(ZERO)){StageMorph.uber.drawOn.call(this,a,b);b=this.position();var d=c.translateBy(b.neg());b=d.left();var e=d.top();var f=d.width();d=d.height();f/=this.scale;d/=this.scale;a.save();a.scale(this.scale,this.scale);this.projectionSource&&(a.globalAlpha=1-this.projectionTransparency/100,a.drawImage(this.projectionLayer(),b/this.scale,e/this.scale,f,d,c.left()/this.scale,c.top()/this.scale,f,d),
this.version=Date.now());a.globalAlpha=1;a.drawImage(this.penTrails(),b/this.scale,e/this.scale,f,d,c.left()/this.scale,c.top()/this.scale,f,d);a.restore()}};StageMorph.prototype.clearPenTrails=function(){this.cachedPenTrailsMorph=null;this.trailsCanvas=newCanvas(this.dimensions,null,this.trailsCanvas);this.trailsLog=[];this.changed()};StageMorph.prototype.penTrails=function(){this.trailsCanvas||(this.trailsCanvas=newCanvas(this.dimensions));return this.trailsCanvas};
StageMorph.prototype.penTrailsMorph=function(){if(this.cachedPenTrailsMorph)return this.cachedPenTrailsMorph;var a=new Morph;a.isCachingImage=!0;var b=this.penTrails();a.bounds=this.bounds.copy();a.cachedImage=newCanvas(this.extent(),!0);a.cachedImage.getContext("2d").drawImage(b,0,0,b.width,b.height,0,0,this.width(),this.height());return this.cachedPenTrailsMorph=a};StageMorph.prototype.projectionLayer=function(){this.projectionCanvas||(this.projectionCanvas=newCanvas(this.dimensions,!0));return this.projectionCanvas};
StageMorph.prototype.clearProjectionLayer=function(){this.projectionCanvas=null;this.changed()};
StageMorph.prototype.startVideo=function(){function a(){var c=new DialogBoxMorph;c.inform(localize("Camera not supported"),localize('Please make sure your web browser is up to date\nand your camera is properly configured. \n\nSome browsers also require you to access Snap!\nthrough HTTPS to use the camera.\n\nPlease replace the "http://" part of the address\nin your browser by "https://" and try again.'),this.world);c.fixLayout();b.projectionSource&&(b.projectionSource.remove(),b.projectionSource=
null)}var b=this;this.projectionSource||(this.projectionSource=document.createElement("video"),this.projectionSource.width=this.dimensions.x,this.projectionSource.height=this.dimensions.y,this.projectionSource.hidden=!0,document.body.appendChild(this.projectionSource),this.videoMotion||(this.videoMotion=new VideoMotion(this.dimensions.x,this.dimensions.y)),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(c){b.getProjectionImage=
b.getVideoImage;b.stopProjectionSource=b.stopVideo;b.continuousProjection=!0;b.projectionSource.srcObject=c;b.projectionSource.play().catch(a);b.projectionSource.stream=c}).catch(a))};StageMorph.prototype.getVideoImage=function(){return this.projectionSource};StageMorph.prototype.stopVideo=function(){this.projectionSource&&this.projectionSource.stream&&this.projectionSource.stream.getTracks().forEach(function(a){return a.stop()});this.videoMotion=null};
StageMorph.prototype.stopProjection=function(){this.projectionSource&&(this.stopProjectionSource(),this.projectionSource.remove(),this.projectionSource=null,this.continuousProjection=!1);this.clearProjectionLayer()};StageMorph.prototype.projectionSnap=function(){var a=newCanvas(this.dimensions,!0);a.getContext("2d").drawImage(this.projectionLayer(),0,0);return new Costume(a,this.newCostumeName(localize("snap")))};
StageMorph.prototype.getPixelColor=function(a){if(this.trailsCanvas){var b=a.subtract(this.bounds.origin);var c=this.penTrailsMorph().getImage().getContext("2d");c=c.getImageData(b.x,b.y,1,1);return 0===c.data[3]?this.projectionCanvas?(b=b.divideBy(this.scale),c=this.projectionCanvas.getContext("2d"),c=c.getImageData(b.x,b.y,1,1),new Color(c.data[0],c.data[1],c.data[2],c.data[3]/255)):StageMorph.uber.getPixelColor.call(this,a):new Color(c.data[0],c.data[1],c.data[2],c.data[3]/255)}};
StageMorph.prototype.startVideo=function(){function a(){var c=new DialogBoxMorph;c.inform(localize("Camera not supported"),localize("Please make sure your web browser is up to date\nand your camera is properly configured."),this.world);c.fixLayout();c.rerender();b.projectionSource&&(b.projectionSource.remove(),b.projectionSource=null)}var b=this;this.projectionSource||(this.projectionSource=document.createElement("video"),this.projectionSource.width=this.dimensions.x,this.projectionSource.height=
this.dimensions.y,this.projectionSource.hidden=!0,document.body.appendChild(this.projectionSource),this.videoMotion||(this.videoMotion=new VideoMotion(this.dimensions.x,this.dimensions.y)),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(c){b.getProjectionImage=b.getVideoImage;b.stopProjectionSource=b.stopVideo;b.continuousProjection=!0;b.projectionSource.srcObject=c;b.projectionSource.play().catch(a);b.projectionSource.stream=
c}).catch(a))};StageMorph.prototype.getVideoImage=function(){return this.projectionSource};StageMorph.prototype.stopVideo=function(){this.projectionSource&&this.projectionSource.stream&&this.projectionSource.stream.getTracks().forEach(function(a){a.stop()});this.videoMotion=null};StageMorph.prototype.stopProjection=function(){this.projectionSource&&(this.stopProjectionSource(),this.projectionSource.remove(),this.projectionSource=null,this.continuousProjection=!1);this.clearProjectionLayer()};
StageMorph.prototype.projectionSnap=function(){var a=newCanvas(this.dimensions,!0);a.getContext("2d").drawImage(this.projectionLayer(),0,0);return new Costume(a,this.newCostumeName(localize("snap")))};
StageMorph.prototype.getPixelColor=function(a){if(this.trailsCanvas){var b=a.subtract(this.bounds.origin);var c=this.penTrailsMorph().image.getContext("2d");c=c.getImageData(b.x,b.y,1,1);return 0===c.data[3]?this.projectionCanvas?(b=b.divideBy(this.scale),c=this.projectionCanvas.getContext("2d"),c=c.getImageData(b.x,b.y,1,1),new Color(c.data[0],c.data[1],c.data[2],c.data[3]/255)):StageMorph.uber.getPixelColor.call(this,a):new Color(c.data[0],c.data[1],c.data[2],c.data[3]/255)}};
StageMorph.prototype.watchers=function(a){return this.children.filter(function(b){return b instanceof WatcherMorph?a?b.left()===a:b.isVisible:!1})};StageMorph.prototype.resetTimer=function(){this.timerStart=Date.now()};StageMorph.prototype.getTimer=function(){return Math.floor((Date.now()-this.timerStart)/100)/10};StageMorph.prototype.setTempo=function(a){this.tempo=Math.max(20,+a||0)};StageMorph.prototype.changeTempo=function(a){this.setTempo(this.getTempo()+(+a||0))};
StageMorph.prototype.getTempo=function(){return+this.tempo};StageMorph.prototype.getLastMessage=function(){return this.lastMessage||""};StageMorph.prototype.reportMouseX=function(){var a=this.world();return a?(a.hand.position().x-this.center().x)/this.scale:0};StageMorph.prototype.reportMouseY=function(){var a=this.world();return a?(this.center().y-a.hand.position().y)/this.scale:0};
StageMorph.prototype.wantsDropOf=function(a){return a instanceof SpriteMorph||a instanceof WatcherMorph||a instanceof ListWatcherMorph||a instanceof SpriteIconMorph};StageMorph.prototype.reactToDropOf=function(a,b){a instanceof SpriteIconMorph&&(a.object.anchor&&SnapActions.detachParts([a.object]),this.world().add(a),a.slideBackTo(b.grabOrigin))};
StageMorph.prototype.step=function(){var a=this.world();null===a.keyboardFocus&&(a.keyboardFocus=this);null===a.currentKey&&(this.keyPressed=null);this.enableCustomHatBlocks&&this.stepGenericConditions();if(this.isFastTracked&&this.threads.processes.length){for(;this.isFastTracked&&15>Date.now()-this.lastTime;)this.threads.step();this.changed()}else this.threads.step(),this.threads.wantsToPause&&(a=this.parentThatIsA(IDE_Morph))&&a.controlBar.pauseButton.refresh();a=Date.now()-this.lastWatcherUpdate;
1>1E3/this.watcherUpdateFrequency-a&&(this.watchers().forEach(function(b){return b.update()}),this.lastWatcherUpdate=Date.now());this.continuousProjection&&this.projectionSource&&this.updateProjection()};
StageMorph.prototype.updateProjection=function(){var a=this.projectionLayer().getContext("2d");a.save();this.mirrorVideo&&(a.translate(this.dimensions.x,0),a.scale(-1,1));a.drawImage(this.getProjectionImage(),0,0,this.projectionSource.width,this.projectionSource.height);this.videoMotion&&this.videoMotion.addFrame(a.getImageData(0,0,this.projectionSource.width,this.projectionSource.height).data);a.restore();this.changed()};
StageMorph.prototype.stepGenericConditions=function(a){var b=this,c=0,d;this.children.concat(this).forEach(function(e){isSnapObject(e)&&e.allGenericHatBlocks().forEach(function(f){c+=1;b.threads.doWhen(f,e,a)})});c||(this.enableCustomHatBlocks=!1,(d=this.parentThatIsA(IDE_Morph))&&d.controlBar.stopButton.refresh())};
StageMorph.prototype.developersMenu=function(){var a=this,b=StageMorph.uber.developersMenu.call(this);b.addItem("stop",function(){return a.threads.stopAll()},"terminate all running threads");return b};StageMorph.prototype.processKeyDown=function(a){this.processKeyEvent(a,this.fireKeyEvent)};StageMorph.prototype.processKeyUp=function(a){this.processKeyEvent(a,this.removePressedKey)};
StageMorph.prototype.processKeyEvent=function(a,b){switch(a.keyCode){case 13:var c="enter";a.ctrlKey||a.metaKey?c="ctrl enter":a.shiftKey&&(c="shift enter");break;case 27:c="esc";break;case 32:c="space";break;case 37:c="left arrow";break;case 39:c="right arrow";break;case 38:c="up arrow";break;case 40:c="down arrow";break;default:if(c=a.key||String.fromCharCode(a.keyCode||a.charCode),a.ctrlKey||a.metaKey)c="ctrl "+(a.shiftKey?"shift ":"")+c}switch(a.key){case "+":case "-":c=a.key}b.call(this,c)};
StageMorph.prototype.fireKeyEvent=function(a){var b=this,c=a.toLowerCase(),d=[];a=this.parentThatIsA(IDE_Morph);this.keysPressed[c]=!0;if("ctrl enter"===c&&!a.isAppMode)return this.fireGreenFlagEvent();if("shift enter"===c)return this.editScripts();if("ctrl f"===c)a.isAppMode||a.currentSprite.searchBlocks();else if("ctrl z"===c)a.isAppMode||SnapUndo.undo(a.getActiveEntity());else if("ctrl shift z"===c||"ctrl y"===c)a.isAppMode||SnapUndo.redo(a.getActiveEntity());else if("ctrl n"===c)a.isAppMode||
a.createNewProject();else if("ctrl o"===c)a.isAppMode||a.openProjectsBrowser();else if("ctrl s"===c)a.isAppMode||a.save();else if("ctrl shift s"===c){if(!a.isAppMode)return a.saveProjectsBrowser()}else{if("esc"===c&&!a.isAppMode)return this.fireStopAllEvent();this.children.concat(this).forEach(function(e){isSnapObject(e)&&e.allHatBlocksForKey(c).forEach(function(f){return d.push(b.threads.startProcess(f,e,!0))})});return d}};StageMorph.prototype.removePressedKey=function(a){delete this.keysPressed[a.toLowerCase()]};
StageMorph.prototype.processKeyPress=function(a){nop(a)};StageMorph.prototype.inspectKeyEvent=CursorMorph.prototype.inspectKeyEvent;StageMorph.prototype.fireGreenFlagEvent=function(){var a=this,b=[],c=this.parentThatIsA(IDE_Morph);this.removeAllClones();this.children.concat(this).forEach(function(d){isSnapObject(d)&&d.allHatBlocksFor("__shout__go__").forEach(function(e){return b.push(a.threads.startProcess(e,d,a.isThreadSafe))})});c&&c.controlBar.pauseButton.refresh();return b};
StageMorph.prototype.fireStopAllEvent=function(){var a=this,b=this.parentThatIsA(IDE_Morph);this.threads.resumeAll(this.stage);this.runStopScripts();this.keysPressed={};this.threads.stopAll();this.stopAllActiveSounds();this.children.forEach(function(c){c.stopTalking&&c.stopTalking()});this.removeAllClones();b&&b.nextSteps([nop,function(){return a.stopAllActiveSounds()},function(){return a.stopProjection()},function(){return b.controlBar.pauseButton.refresh()}])};
StageMorph.prototype.runStopScripts=function(){this.receiveUserInteraction("stopped",!0,!0);this.children.forEach(function(a){a instanceof SpriteMorph&&a.receiveUserInteraction("stopped",!0,!0)})};StageMorph.prototype.removeAllClones=function(){var a=this;this.children.filter(function(b){return b instanceof SpriteMorph&&b.isTemporary}).forEach(function(b){a.threads.stopAllForReceiver(b);b.detachFromAnchor();b.corpsify();b.destroy()});this.cloneCount=0};
StageMorph.prototype.editScripts=function(){var a=this.parentThatIsA(IDE_Morph);if(!a.isAppMode&&ScriptsMorph.prototype.enableKeyboard){a=a.getActiveScripts().selectForEdit();a.edit(a.position());var b=a.focus.sortedScripts();b.length?(a.focus.element=b[0],a.focus.element instanceof HatBlockMorph&&a.focus.nextCommand()):a.focus.moveBy(new Point(50,50));a.focus.fixLayout()}};
StageMorph.prototype.blockTemplates=function(a){function b(n){if(l.hiddenPrimitives[n])return null;n=SpriteMorph.prototype.blockForSelector(n,!0);n.isTemplate=!0;return n}function c(n,q){n=SpriteMorph.prototype.variableBlock(n,q);n.isDraggable=!1;n.isTemplate=!0;return n}function d(n){if(l.hiddenPrimitives[n])return null;var q=SpriteMorph.prototype.blocks[n];return new ToggleMorph("checkbox",this,function(){l.toggleWatcher(n,localize(q.spec),l.blockColor[q.category])},null,function(){return l.showingWatcher(n)},
null)}function e(n){return new ToggleMorph("checkbox",this,function(){l.toggleVariableWatcher(n)},null,function(){return l.showingVariableWatcher(n)},null)}function f(n){n&&(l.isVariableNameInUse(n[0])?l.inform("that name is already in use"):SnapActions.addVariable(n[0],n[1]||l.id))}function g(n){SnapActions.deleteVariable(n,l.id)}function h(n){var q=l.parentThatIsA(StageMorph),p=n.name.trim();n=n.fields.map(function(t){return t.trim()}).filter(function(t){return!!t});q.messageTypes.getMsgType(p)?
l.inform("that name is already in use"):SnapActions.addMessageType(p,n)}var k=[],l=this;a=a||"motion";if("motion"===a){var m=new TextMorph(localize("Stage selected:\nno motion primitives"));m.fontSize=9;m.setColor(this.paletteTextColor);k.push(m)}else"looks"===a?(k.push(b("doSwitchToCostume")),k.push(b("doWearNextCostume")),k.push(d("getCostumeIdx")),k.push(b("getCostumeIdx")),k.push("-"),k.push(b("reportGetImageAttribute")),k.push(b("reportNewCostumeStretched")),k.push(b("reportNewCostume")),k.push("-"),
k.push(b("changeEffect")),k.push(b("setEffect")),k.push(b("clearEffects")),k.push(b("getEffect")),k.push("-"),k.push(b("show")),k.push(b("hide")),k.push(d("reportShown")),k.push(b("reportShown")),this.world().isDevMode&&(k.push("-"),m=new TextMorph(localize("development mode \ndebugging primitives:")),m.fontSize=9,m.setColor(this.paletteTextColor),k.push(m),k.push("-"),k.push(b("log")),k.push(b("alert")))):"sound"===a?(k.push(b("playSound")),k.push(b("doPlaySoundUntilDone")),k.push(b("doStopAllSounds")),
k.push("-"),k.push(b("doPlaySoundAtRate")),k.push(b("reportGetSoundAttribute")),k.push(b("reportNewSoundFromSamples")),k.push("-"),k.push(b("doRest")),k.push(b("doPlayNote")),k.push(b("doSetInstrument")),k.push("-"),k.push(b("doChangeTempo")),k.push(b("doSetTempo")),k.push(d("getTempo")),k.push(b("getTempo")),k.push("-"),k.push(b("changeVolume")),k.push(b("setVolume")),k.push(d("getVolume")),k.push(b("getVolume")),k.push("-"),k.push(b("changePan")),k.push(b("setPan")),k.push(d("getPan")),k.push(b("getPan")),
k.push("-"),k.push(b("playFreq")),k.push(b("stopFreq")),this.world().isDevMode&&(k.push("-"),m=new TextMorph(localize("development mode \ndebugging primitives:")),m.fontSize=9,m.setColor(this.paletteTextColor),k.push(m),k.push("-"),k.push(b("doPlayFrequency")))):"pen"===a?(k.push(b("clear")),k.push("-"),k.push(b("setBackgroundColor")),k.push(b("changeBackgroundHSVA")),k.push(b("setBackgroundHSVA")),k.push("-"),k.push(b("reportPenTrailsAsCostume")),k.push("-"),k.push(b("doPasteOn"))):"network"===a?
(k.push(b("receiveSocketMessage")),k.push(b("doSocketMessage")),k.push("-"),k.push(b("doSocketRequest")),k.push(b("doSocketResponse")),k.push("-"),k.push(b("getJSFromRPCStruct")),k.push(b("doRunRPC")),k.push(d("reportRPCError")),k.push(b("reportRPCError")),k.push("-"),k.push(b("getProjectIds")),k.push(b("getProjectId")),m=new PushButtonMorph(null,function(){(new MessageCreatorMorph(l,h)).popUp()},"Make a message type"),k.push(m),0<this.deletableMessageNames().length&&(m=new PushButtonMorph(null,function(){var n=
new MenuMorph(function(q){SnapActions.deleteMessageType(q)},null);l.deletableMessageNames().forEach(function(q){n.addItem(q,q)});n.popUpAtHand(l.world())},"Delete a message type"),m.selector="deleteMessageType",m.showHelp=BlockMorph.prototype.showHelp,k.push(m))):"control"===a?(k.push(b("receiveGo")),k.push(b("receiveKey")),k.push(b("receiveInteraction")),k.push(b("receiveCondition")),k.push(b("receiveMessage")),k.push("-"),k.push(b("doBroadcast")),k.push(b("doBroadcastAndWait")),k.push(b("doSend")),
k.push(d("getLastMessage")),k.push(b("getLastMessage")),k.push("-"),k.push(b("doWarp")),k.push("-"),k.push(b("doWait")),k.push(b("doWaitUntil")),k.push("-"),k.push(b("doForever")),k.push(b("doRepeat")),k.push(b("doUntil")),k.push(b("doFor")),k.push("-"),k.push(b("doIf")),k.push(b("doIfElse")),k.push(b("reportIfElse")),k.push("-"),k.push(b("doReport")),k.push(b("doStopThis")),k.push("-"),k.push(b("doRun")),k.push(b("fork")),k.push(b("evaluate")),k.push("-"),k.push(b("doTellTo")),k.push(b("reportAskFor")),
k.push("-"),k.push(b("doCallCC")),k.push(b("reportCallCC")),k.push("-"),k.push(b("createClone")),k.push(b("newClone")),k.push("-"),k.push(b("doPauseAll"))):"sensing"===a?(k.push(b("doAsk")),k.push(d("getLastAnswer")),k.push(b("getLastAnswer")),k.push("-"),k.push(d("reportMouseX")),k.push(b("reportMouseX")),k.push(d("reportMouseY")),k.push(b("reportMouseY")),k.push(b("reportMouseDown")),k.push("-"),k.push(b("reportKeyPressed")),k.push("-"),k.push(b("reportAspect")),k.push("-"),k.push(b("doResetTimer")),
k.push(d("getTimer")),k.push(b("getTimer")),k.push("-"),k.push(b("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&k.push(b("reportGet")),k.push(b("reportObject")),k.push("-"),k.push(b("reportURL")),k.push(b("reportAudio")),k.push(b("reportVideo")),k.push(b("doSetVideoTransparency")),k.push("-"),k.push(b("reportGlobalFlag")),k.push(b("doSetGlobalFlag")),k.push("-"),k.push(b("reportDate")),k.push(b("reportUsername")),k.push("-"),k.push(b("reportLatitude")),k.push(b("reportLongitude")),
k.push("-"),k.push(b("reportStageHeight")),k.push(b("reportStageWidth")),k.push(b("reportImageOfObject")),this.world().isDevMode&&(k.push("-"),m=new TextMorph(localize("development mode \ndebugging primitives:")),m.fontSize=9,m.setColor(this.paletteTextColor),k.push(m),k.push("-"),k.push(d("reportThreadCount")),k.push(b("reportThreadCount")),k.push(b("reportStackSize")),k.push(b("reportFrameCount")))):"operators"===a?(k.push(b("reifyScript")),k.push(b("reifyReporter")),k.push(b("reifyPredicate")),
k.push("#"),k.push("-"),k.push(b("reportSum")),k.push(b("reportDifference")),k.push(b("reportProduct")),k.push(b("reportQuotient")),k.push(b("reportPower")),k.push("-"),k.push(b("reportModulus")),k.push(b("reportRound")),k.push(b("reportMonadic")),k.push(b("reportRandom")),k.push("-"),k.push(b("reportLessThan")),k.push(b("reportEquals")),k.push(b("reportGreaterThan")),k.push("-"),k.push(b("reportAnd")),k.push(b("reportOr")),k.push(b("reportNot")),k.push(b("reportBoolean")),k.push("-"),k.push(b("reportJoinWords")),
k.push(b("reportTextSplit")),k.push(b("reportLetter")),k.push(b("reportStringSize")),k.push("-"),k.push(b("reportUnicode")),k.push(b("reportUnicodeAsLetter")),k.push("-"),k.push(b("reportIsA")),k.push(b("reportIsIdentical")),k.push("-"),k.push(b("reportJSFunction")),Process.prototype.enableCompiling&&k.push(b("reportCompiled")),this.world().isDevMode&&(k.push("-"),m=new TextMorph("development mode \ndebugging primitives:"),m.fontSize=9,m.setColor(this.paletteTextColor),k.push(m),k.push("-"),k.push(b("reportTypeOf")),
k.push(b("reportTextFunction")))):"variables"===a&&(m=new PushButtonMorph(null,function(){(new VariableDialogMorph(null,f,l)).prompt("Variable name",null,l.world())},"Make a variable"),k.push(m),0<this.variables.allNames().length&&(m=new PushButtonMorph(null,function(){var n=new MenuMorph(g,null,l);l.variables.allNames().forEach(function(q){return n.addItem(q,q,null,null,null,null,null,null,!0)});n.popUpAtHand(l.world())},"Delete a variable"),k.push(m)),k.push("-"),m=this.reachableGlobalVariableNames(!0),
0<m.length&&(m.forEach(function(n){k.push(e(n));k.push(c(n))}),k.push("-")),m=this.allLocalVariableNames(!0),0<m.length&&(m.forEach(function(n){k.push(e(n));k.push(c(n,!0))}),k.push("-")),k.push(b("doSetVar")),k.push(b("doChangeVar")),k.push(b("doShowVar")),k.push(b("doHideVar")),k.push(b("doDeclareVariables")),k.push("="),k.push(b("reportNewList")),k.push(b("reportNumbers")),k.push("-"),k.push(b("reportCONS")),k.push(b("reportListItem")),k.push(b("reportCDR")),k.push("-"),k.push(b("reportListLength")),
k.push(b("reportListIndex")),k.push(b("reportListContainsItem")),k.push(b("reportListIsEmpty")),k.push("-"),k.push(b("reportMap")),k.push(b("reportKeep")),k.push(b("reportFindFirst")),k.push(b("reportCombine")),k.push("-"),k.push(b("doForEach")),k.push("-"),k.push(b("reportConcatenatedLists")),k.push("-"),k.push(b("doAddToList")),k.push(b("doDeleteFromList")),k.push(b("doInsertInList")),k.push(b("doReplaceInList")),this.world().isDevMode&&(k.push("-"),m=new TextMorph(localize("development mode \ndebugging primitives:")),
m.fontSize=9,m.setColor(this.paletteTextColor),k.push(m),k.push("-"),k.push(b("doShowTable"))),StageMorph.prototype.enableCodeMapping&&(k.push("="),k.push(b("doMapCodeOrHeader")),k.push(b("doMapValueCode")),k.push(b("doMapListCode")),k.push("-"),k.push(b("reportMappedCode"))));if(m=this.parentThatIsA(IDE_Morph))m=m.extensions.getPaletteContents(this,a).flatMap(function(n){switch(n.type){case "block":return b(n.name);case "watcher":return[d(n.name),b(n.name)];case "space":return n.name}return n}),
k.push.apply(k,$jscomp.arrayFromIterable(m));k.push("=");k.push(this.makeBlockButton(a));return k};StageMorph.prototype.clear=function(){this.clearPenTrails()};
StageMorph.prototype.userMenu=function(){var a=this,b=this.parentThatIsA(IDE_Morph),c=new MenuMorph(this);if(b&&b.isAppMode)return c;c.addItem("edit","edit");c.addItem("show all","showAll");c.addItem("pic...",function(){return b.saveCanvasAs(a.fullImage(),a.name)},"save a picture\nof the stage");c.addLine();c.addItem("pen trails",function(){var d=b.currentSprite.reportPenTrailsAsCostume().copy();b.currentSprite.addCostume(d);b.currentSprite.wearCostume(d);b.hasChangedMedia=!0;b.spriteBar.tabBar.tabTo("costumes")},
b.currentSprite instanceof SpriteMorph?"turn all pen trails and stamps\ninto a new costume for the\ncurrently selected sprite":"turn all pen trails and stamps\ninto a new background for the stage");this.trailsLog.length&&c.addItem("svg...","exportTrailsLogAsSVG","export pen trails\nline segments as SVG");return c};
StageMorph.prototype.showAll=function(){var a=this;this.children.forEach(function(b){b instanceof SpriteMorph?b.anchor||(b.show(),b.keepWithin(a)):(b.show(),b.keepWithin(a),b.fixLayout&&b.fixLayout())})};StageMorph.prototype.edit=SpriteMorph.prototype.edit;StageMorph.prototype.fullImage=Morph.prototype.fullImage;StageMorph.prototype.thumbnail=function(a,b){return this.fancyThumbnail(a,null,!1,b)};
StageMorph.prototype.fancyThumbnail=function(a,b,c,d){var e=this,f=this.getImage(),g=Math.min(a.x/f.width,a.y/f.height);a=newCanvas(a,c,d);var h=a.getContext("2d"),k,l;h.save();h.scale(g,g);h.drawImage(f,0,0);h.drawImage(this.penTrails(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale);this.projectionSource&&(h.save(),h.globalAlpha=1-this.projectionTransparency/100,h.drawImage(this.projectionLayer(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale),h.restore());this.children.forEach(function(m){m.isVisible&&
m!==b&&(k=m.fullBounds(),l=m.fullImage(),l.width&&l.height&&h.drawImage(m.fullImage(),k.origin.x-e.bounds.origin.x,k.origin.y-e.bounds.origin.y))});h.restore();return a};StageMorph.prototype.exportTrailsLogAsSVG=function(){var a=this.parentThatIsA(IDE_Morph);a.saveFileAs(this.trailsLogAsSVG().src,"image/svg",a.projectName||this.name)};
StageMorph.prototype.trailsLogAsSVG=function(){var a=this,b=this.trailsLog[0][0],c=b,d=this.trailsLog[0][3],e,f;this.trailsLog.forEach(function(l){b=b.min(l[0]);b=b.min(l[1]);c=c.max(l[0]);c=c.max(l[1]);d=Math.max(d,l[3])});var g=b.corner(c).expandBy(d/2);var h=(new Point(-b.x,c.y)).translateBy(d/2);var k='<svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" viewBox="0 0 '+g.width()+" "+g.height()+'" width="'+g.width()+'" height="'+g.height()+'" >';k+="\x3c!-- Generated by Snap! - http://snap.berkeley.edu/ --\x3e";
this.trailsLog.forEach(function(l){e=a.normalizePoint(l[0]).translateBy(h);f=a.normalizePoint(l[1]).translateBy(h);k+='<line x1="'+e.x+'" y1="'+e.y+'" x2="'+f.x+'" y2="'+f.y+'" style="stroke:'+l[2].toString()+";stroke-width:"+l[3]+";stroke-linecap:"+l[4]+'" />'});k+="</svg>";return{src:k,rot:new Point(-g.origin.x,g.corner.y)}};StageMorph.prototype.normalizePoint=function(a){return new Point(a.x,-a.y)};StageMorph.prototype.hide=function(){this.isVisible=!1;this.changed()};
StageMorph.prototype.show=function(){this.isVisible=!0;this.changed()};StageMorph.prototype.reportShown=SpriteMorph.prototype.reportShown;StageMorph.prototype.createClone=nop;StageMorph.prototype.newClone=nop;StageMorph.prototype.setColorComponentHSVA=function(a,b){b=+b;a=+a;if(!(0>a||3<a)){if(0==a){if(0>b||100<b)b=(0>b?100:0)+b%100}else b=Math.min(100,Math.max(0,b));3===a?this.color.a=1-b/100:(this.cachedHSV[a]=b/100,this.color.set_hsv.apply(this.color,this.cachedHSV));this.rerender()}};
StageMorph.prototype.getColorComponentHSLA=SpriteMorph.prototype.getColorComponentHSLA;StageMorph.prototype.changeColorComponentHSVA=SpriteMorph.prototype.changeColorComponentHSVA;StageMorph.prototype.setColor=function(a){this.color.eq(a,!0)||(this.color=a.copy(),this.rerender(),this.cachedHSV=this.color.hsv())};StageMorph.prototype.setBackgroundColor=StageMorph.prototype.setColor;StageMorph.prototype.getPenAttribute=SpriteMorph.prototype.getPenAttribute;StageMorph.prototype.pasteOn=SpriteMorph.prototype.pasteOn;
StageMorph.prototype.categories=SpriteMorph.prototype.categories;StageMorph.prototype.blockColor=SpriteMorph.prototype.blockColor;StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor;StageMorph.prototype.setName=SpriteMorph.prototype.setName;StageMorph.prototype.makeBlockButton=SpriteMorph.prototype.makeBlockButton;StageMorph.prototype.makeBlock=SpriteMorph.prototype.makeBlock;StageMorph.prototype.palette=SpriteMorph.prototype.palette;StageMorph.prototype.freshPalette=SpriteMorph.prototype.freshPalette;
StageMorph.prototype.blocksMatching=SpriteMorph.prototype.blocksMatching;StageMorph.prototype.searchBlocks=SpriteMorph.prototype.searchBlocks;StageMorph.prototype.reporterize=SpriteMorph.prototype.reporterize;StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher;StageMorph.prototype.addVariable=SpriteMorph.prototype.addVariable;StageMorph.prototype.deleteVariable=SpriteMorph.prototype.deleteVariable;StageMorph.prototype.newCostumeName=SpriteMorph.prototype.newCostumeName;
StageMorph.prototype.blockForSelector=SpriteMorph.prototype.blockForSelector;StageMorph.prototype.findVariableWatcher=SpriteMorph.prototype.findVariableWatcher;StageMorph.prototype.toggleVariableWatcher=SpriteMorph.prototype.toggleVariableWatcher;StageMorph.prototype.findVariableWatcherToggle=SpriteMorph.prototype.findVariableWatcherToggle;StageMorph.prototype.refreshVariableWatcher=SpriteMorph.prototype.refreshVariableWatcher;StageMorph.prototype.showingVariableWatcher=SpriteMorph.prototype.showingVariableWatcher;
StageMorph.prototype.deleteVariableWatcher=SpriteMorph.prototype.deleteVariableWatcher;StageMorph.prototype.addCostume=SpriteMorph.prototype.addCostume;StageMorph.prototype.wearCostume=SpriteMorph.prototype.wearCostume;StageMorph.prototype.getCostumeIdx=SpriteMorph.prototype.getCostumeIdx;StageMorph.prototype.doWearNextCostume=SpriteMorph.prototype.doWearNextCostume;StageMorph.prototype.doWearPreviousCostume=SpriteMorph.prototype.doWearPreviousCostume;StageMorph.prototype.doSwitchToCostume=SpriteMorph.prototype.doSwitchToCostume;
StageMorph.prototype.reportCostumes=SpriteMorph.prototype.reportCostumes;StageMorph.prototype.graphicsChanged=SpriteMorph.prototype.graphicsChanged;StageMorph.prototype.applyGraphicsEffects=SpriteMorph.prototype.applyGraphicsEffects;StageMorph.prototype.setEffect=SpriteMorph.prototype.setEffect;StageMorph.prototype.getEffect=SpriteMorph.prototype.getEffect;StageMorph.prototype.getGhostEffect=SpriteMorph.prototype.getGhostEffect;StageMorph.prototype.changeEffect=SpriteMorph.prototype.changeEffect;
StageMorph.prototype.clearEffects=SpriteMorph.prototype.clearEffects;StageMorph.prototype.addSound=SpriteMorph.prototype.addSound;StageMorph.prototype.doPlaySound=SpriteMorph.prototype.doPlaySound;StageMorph.prototype.stopAllActiveSounds=function(){this.activeSounds.forEach(function(a){return a.pause()});this.activeSounds=[];this.microphone.modifier&&this.microphone.isReady&&this.microphone.stop()};StageMorph.prototype.pauseAllActiveSounds=function(){this.activeSounds.forEach(function(a){return a.pause()})};
StageMorph.prototype.resumeAllActiveSounds=function(){this.activeSounds.forEach(function(a){return a.play()})};StageMorph.prototype.reportSounds=SpriteMorph.prototype.reportSounds;StageMorph.prototype.newSoundName=SpriteMorph.prototype.newSoundName;StageMorph.prototype.setVolume=SpriteMorph.prototype.setVolume;StageMorph.prototype.changeVolume=SpriteMorph.prototype.changeVolume;StageMorph.prototype.getVolume=SpriteMorph.prototype.getVolume;StageMorph.prototype.getGainNode=SpriteMorph.prototype.getGainNode;
StageMorph.prototype.audioContext=SpriteMorph.prototype.audioContext;StageMorph.prototype.setPan=SpriteMorph.prototype.setPan;StageMorph.prototype.changePan=SpriteMorph.prototype.changePan;StageMorph.prototype.getPan=SpriteMorph.prototype.getPan;StageMorph.prototype.getPannerNode=SpriteMorph.prototype.getPannerNode;StageMorph.prototype.playFreq=SpriteMorph.prototype.playFreq;StageMorph.prototype.stopFreq=SpriteMorph.prototype.stopFreq;StageMorph.prototype.toggleWatcher=SpriteMorph.prototype.toggleWatcher;
StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher;StageMorph.prototype.watcherFor=SpriteMorph.prototype.watcherFor;StageMorph.prototype.getLastAnswer=SpriteMorph.prototype.getLastAnswer;StageMorph.prototype.reportThreadCount=SpriteMorph.prototype.reportThreadCount;StageMorph.prototype.xCenter=function(){return 0};StageMorph.prototype.yCenter=function(){return 0};StageMorph.prototype.xLeft=function(){return-.5*this.dimensions.x};
StageMorph.prototype.xRight=function(){return this.dimensions.x/2};StageMorph.prototype.yTop=function(){return this.dimensions.y/2};StageMorph.prototype.yBottom=function(){return-.5*this.dimensions.y};StageMorph.prototype.allMessageNames=SpriteMorph.prototype.allMessageNames;StageMorph.prototype.allSendersOf=SpriteMorph.prototype.allSendersOf;StageMorph.prototype.allHatBlocksFor=SpriteMorph.prototype.allHatBlocksFor;StageMorph.prototype.allHatBlocksForKey=SpriteMorph.prototype.allHatBlocksForKey;
StageMorph.prototype.allHatBlocksForInteraction=SpriteMorph.prototype.allHatBlocksForInteraction;StageMorph.prototype.allGenericHatBlocks=SpriteMorph.prototype.allGenericHatBlocks;StageMorph.prototype.mouseClickLeft=SpriteMorph.prototype.mouseClickLeft;StageMorph.prototype.mouseEnter=SpriteMorph.prototype.mouseEnter;StageMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed")};StageMorph.prototype.mouseDownLeft=SpriteMorph.prototype.mouseDownLeft;
StageMorph.prototype.mouseScroll=SpriteMorph.prototype.mouseScroll;StageMorph.prototype.receiveUserInteraction=SpriteMorph.prototype.receiveUserInteraction;StageMorph.prototype.deleteAllBlockInstances=SpriteMorph.prototype.deleteAllBlockInstances;StageMorph.prototype.allBlockInstances=SpriteMorph.prototype.allBlockInstances;StageMorph.prototype.allLocalBlockInstances=SpriteMorph.prototype.allLocalBlockInstances;StageMorph.prototype.allEditorBlockInstances=SpriteMorph.prototype.allEditorBlockInstances;
StageMorph.prototype.paletteBlockInstance=SpriteMorph.prototype.paletteBlockInstance;StageMorph.prototype.usesBlockInstance=SpriteMorph.prototype.usesBlockInstance;StageMorph.prototype.doubleDefinitionsFor=SpriteMorph.prototype.doubleDefinitionsFor;StageMorph.prototype.replaceDoubleDefinitionsFor=SpriteMorph.prototype.replaceDoubleDefinitionsFor;StageMorph.prototype.allInvocationsOf=SpriteMorph.prototype.allInvocationsOf;StageMorph.prototype.allIndependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf;
StageMorph.prototype.allDependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf;StageMorph.prototype.specimens=function(){return[]};StageMorph.prototype.allSpecimens=function(){return[]};StageMorph.prototype.shadowAttribute=nop;StageMorph.prototype.inheritsAttribute=function(){return!1};StageMorph.prototype.isVariableNameInUse=SpriteMorph.prototype.isVariableNameInUse;StageMorph.prototype.globalVariables=SpriteMorph.prototype.globalVariables;StageMorph.prototype.inheritedVariableNames=function(){return[]};
StageMorph.prototype.allLocalVariableNames=SpriteMorph.prototype.allLocalVariableNames;StageMorph.prototype.reachableGlobalVariableNames=SpriteMorph.prototype.reachableGlobalVariableNames;StageMorph.prototype.getMethod=SpriteMorph.prototype.getMethod;StageMorph.prototype.getLocalMethod=SpriteMorph.prototype.getLocalMethod;StageMorph.prototype.ownBlocks=SpriteMorph.prototype.ownBlocks;
StageMorph.prototype.allBlocks=function(a){var b=this.ownBlocks();return a?Object.keys(b).map(function(c){return b[c]}):b};StageMorph.prototype.inheritedBlocks=function(){return[]};StageMorph.prototype.hasSpriteVariable=SpriteMorph.prototype.hasSpriteVariable;StageMorph.prototype.refactorVariableInstances=SpriteMorph.prototype.refactorVariableInstances;StageMorph.prototype.reportPenTrailsAsCostume=function(){return new Costume(this.trailsCanvas,this.newCostumeName(localize("Background")))};
SpriteBubbleMorph.prototype=new SpeechBubbleMorph;SpriteBubbleMorph.prototype.constructor=SpriteBubbleMorph;SpriteBubbleMorph.uber=SpeechBubbleMorph.prototype;function SpriteBubbleMorph(a,b,c,d){this.init(a,b,c,d)}
SpriteBubbleMorph.prototype.init=function(a,b,c,d){var e=SpriteMorph.prototype;this.scale=(this.stage=b)?b.scale:1;this.data=a;this.isQuestion=d;SpriteBubbleMorph.uber.init.call(this,this.data,e.bubbleColor,null,null,d?e.blockColor.sensing:e.bubbleBorderColor,null,c,!0);this.isCachingImage=!0;this.rerender()};
SpriteBubbleMorph.prototype.dataAsMorph=function(a){var b=SpriteMorph.prototype;if(a instanceof Morph)if(isSnapObject(a)){var c=a.thumbnail(new Point(40,40));var d=new Morph;d.isCachingImage=!0;d.bounds.setWidth(c.width);d.bounds.setHeight(c.height);d.cachedImage=c;d.version=a.version;d.step=function(){this.version!==a.version&&(this.cachedImage=c=a.thumbnail(new Point(40,40),this.cachedImage),this.version=a.version,this.changed())}}else d=a;else if(isString(a)){var e=!0;d=new TextMorph(a,b.bubbleFontSize*
this.scale,null,b.bubbleFontIsBold,!1,"center")}else"boolean"===typeof a?(c=b.booleanMorph(a).fullImage(),d=new Morph,d.isCachingImage=!0,d.bounds.setWidth(c.width),d.bounds.setHeight(c.height),d.cachedImage=c):a instanceof Costume?(c=a.thumbnail(new Point(40,40)),d=new Morph,d.isCachingImage=!0,d.bounds.setWidth(c.width),d.bounds.setHeight(c.height),d.cachedImage=c):a instanceof Sound?d=new SymbolMorph("notes",30):a instanceof HTMLCanvasElement?(c=a,d=new Morph,d.isCachingImage=!0,d.bounds.setWidth(c.width),
d.bounds.setHeight(c.height),d.cachedImage=c):a instanceof List?(a.isTable()?d=new TableFrameMorph(new TableMorph(a,10)):(d=new ListWatcherMorph(a),d.update(!0),d.step=d.update),this.stage&&d.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding))),d.isDraggable=!1):a instanceof Context?(c=a.image(),d=new Morph,d.isCachingImage=!0,d.bounds.setWidth(c.width),d.bounds.setHeight(c.height),d.cachedImage=c):d=new TextMorph(a.toString(),b.bubbleFontSize*this.scale,null,b.bubbleFontIsBold,
!1,"center");if(d instanceof TextMorph){var f=Math.max(d.width(),2*b.bubbleCorner*this.scale);e&&(f=Math.min(f,b.bubbleMaxTextWidth*this.scale));d.setWidth(f)}else a instanceof List||(b=newCanvas(d.extent().multiplyBy(this.scale)),b.getContext("2d").drawImage(d.getImage(),0,0,b.width,b.height),d.cachedImage=b,d.bounds=d.bounds.scaleBy(this.scale));return d};SpriteBubbleMorph.prototype.setScale=function(a){this.scale=a;this.changed();this.fixLayout();this.rerender()};
SpriteBubbleMorph.prototype.fixLayout=function(){var a=SpriteMorph.prototype;this.contentsMorph instanceof ListWatcherMorph||this.contentsMorph instanceof TableFrameMorph||(this.contentsMorph.destroy(),this.contentsMorph=this.dataAsMorph(this.data));this.add(this.contentsMorph);this.edge=a.bubbleCorner*this.scale;this.border=a.bubbleBorder*this.scale;this.padding=a.bubbleCorner/2*this.scale;this.bounds.setWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge));this.bounds.setHeight(this.contentsMorph.height()+
this.edge+2*this.border+2*this.padding+2);this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))};function Costume(a,b,c,d){this.contents=a?normalizeCanvas(a,!0):newCanvas(null,!0);d||this.shrinkToFit(this.maxExtent());this.name=b||null;this.rotationCenter=c||this.center();this.version=Date.now();this.loaded=null}Costume.prototype.maxExtent=function(){return StageMorph.prototype.dimensions};
Costume.prototype.toString=function(){return"a Costume("+this.name+")"};Costume.prototype.extent=function(){return new Point(this.contents.width,this.contents.height)};Costume.prototype.center=function(){return this.extent().divideBy(2)};Costume.prototype.width=function(){return this.contents.width};Costume.prototype.height=function(){return this.contents.height};Costume.prototype.bounds=function(){return new Rectangle(0,0,this.width(),this.height())};
Costume.prototype.shrinkWrap=function(){var a=this.boundingBox(),b=a.extent(),c=newCanvas(b,!0);c.getContext("2d").drawImage(this.contents,a.origin.x,a.origin.y,b.x,b.y,0,0,b.x,b.y);this.rotationCenter=this.rotationCenter.subtract(a.origin);this.contents=c;this.version=Date.now()};
Costume.prototype.canvasBoundingBox=function(a){var b,c,d=a.width,e=a.height,f=a.getContext("2d").getImageData(0,0,d,e);a:{for(c=0;c<=d;c+=1)for(b=0;b<=e;b+=1)if(f.data[b*d*4+4*c+3]){a=c;break a}a=0}a:{for(b=0;b<=e;b+=1)for(c=0;c<=d;c+=1)if(f.data[b*d*4+4*c+3]){var g=b;break a}g=0}a:{for(c=d;0<=c;--c)for(b=e;0<=b;--b)if(f.data[b*d*4+4*c+3]){var h=Math.min(c+1,d);break a}h=d}a:{for(b=e;0<=b;--b)for(c=d;0<=c;--c)if(f.data[b*d*4+4*c+3]){d=Math.min(b+1,e);break a}d=e}return new Rectangle(a,g,h,d)};
Costume.prototype.boundingBox=function(){return this.canvasBoundingBox(this.contents)};Costume.prototype.copy=function(){var a=newCanvas(this.extent(),!0);a.getContext("2d").drawImage(this.contents,0,0);a=new Costume(a,this.name?copy(this.name):null);a.rotationCenter=this.rotationCenter.copy();return a};
Costume.prototype.flipped=function(){var a=newCanvas(this.extent(),!0),b=a.getContext("2d");b.translate(this.width(),0);b.scale(-1,1);b.drawImage(this.contents,0,0);return new Costume(a,this.name,new Point(this.width()-this.rotationCenter.x,this.rotationCenter.y))};
Costume.prototype.stretched=function(a,b){a=(Math.sign(a)||1)*Math.max(1,Math.abs(a));b=(Math.sign(b)||1)*Math.max(1,Math.abs(b));var c=newCanvas(new Point(Math.abs(a),Math.abs(b)),!0),d=c.getContext("2d"),e=a/this.width(),f=b/this.height(),g=this.rotationCenter.multiplyBy(new Point(e,f));0>e&&(g.x=c.width-Math.abs(g.x));0>f&&(g.y=c.height-Math.abs(g.y));d.translate(Math.abs(Math.min(a,0)),Math.abs(Math.min(b,0)));d.scale(e,f);d.drawImage(this.contents,0,0);return new Costume(c,this.name,g,!0)};
Costume.prototype.edit=function(a,b,c,d,e){var f=this,g=new PaintEditorMorph;g.oncancel=d||nop;g.openIn(a,c?newCanvas(StageMorph.prototype.dimensions,!0):this.contents,c?null:this.rotationCenter,function(h,k){f.contents=h;f.rotationCenter=k;f.version=Date.now();a.changed();b&&(b.currentSprite instanceof SpriteMorph&&f.shrinkWrap(),b.currentSprite.wearCostume(f,!0),b.hasChangedMedia=!0);(e||nop)()},b)};
Costume.prototype.editRotationPointOnly=function(a,b){var c=this,d=new CostumeEditorMorph(this);d.fixLayout();var e=new DialogBoxMorph(this,function(){d.accept();b&&b.call(c)});var f=new TextMorph(localize("click or drag crosshairs to move the rotation center"),e.fontSize,e.fontStyle,!0,!1,"center",null,null,new Point(1,1),WHITE);e.labelString="Costume Editor";e.createLabel();e.setPicture(d);e.addBody(f);e.addButton("ok","Ok");e.addButton("cancel","Cancel");e.fixLayout();e.popUp(a)};
Costume.prototype.shrinkToFit=function(a){if(a.x<this.width()||a.y<this.height())this.contents=this.thumbnail(a)};Costume.prototype.thumbnail=function(a,b){var c=this.contents,d=Math.min(a.x/c.width,a.y/c.height),e=(a.x-c.width*d)/2,f=(a.y-c.height*d)/2;a=newCanvas(a,!0,b);b=a.getContext("2d");if(!c||0===c.width+c.height)return a;b.save();b.scale(d,d);b.drawImage(c,Math.floor(e/d),Math.floor(f/d));b.restore();return a};Costume.prototype.rasterized=function(){return this};
Costume.prototype.pixels=function(){var a=[],b;if(!this.contents.width||!this.contents.height)return a;var c=this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height);for(b=0;b<c.data.length;b+=4)a.push(new List([c.data[b],c.data[b+1],c.data[b+2],c.data[b+3]]));return new List(a)};Costume.prototype.isTainted=function(){try{this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height)}catch(a){return!0}return!1};SVG_Costume.prototype=new Costume;
SVG_Costume.prototype.constructor=SVG_Costume;SVG_Costume.uber=Costume.prototype;function SVG_Costume(a,b,c){this.contents=a;this.shapes=[];this.shrinkToFit(this.maxExtent());this.name=b||null;this.rotationCenter=c||this.center();this.version=Date.now();this.loaded=null}SVG_Costume.prototype.toString=function(){return"an SVG_Costume("+this.name+")"};
SVG_Costume.prototype.copy=function(){var a=new Image;a.src=this.contents.src;a=new SVG_Costume(a,this.name?copy(this.name):null);a.rotationCenter=this.rotationCenter.copy();a.shapes=this.shapes.map(function(b){return b.copy()});return a};SVG_Costume.prototype.shrinkToFit=function(a){nop(a)};
SVG_Costume.prototype.parseShapes=function(){var a=new XML_Element,b=this.contents.src.replace(/^data:image\/.*?, */,"");-1<this.contents.src.indexOf("base64")&&(b=atob(b));a.parseString(b);0===this.shapes.length&&a.attributes.snap&&(this.shapes=a.children.map(function(c){return window[c.attributes.prototype].fromSVG(c)}))};
SVG_Costume.prototype.edit=function(a,b,c,d,e){var f=new VectorPaintEditorMorph,g=this;f.oncancel=d||nop;f.openIn(a,c?newCanvas(StageMorph.prototype.dimensions):this.contents,c?new Point(240,180):this.rotationCenter,function(h,k,l){g.contents=h;g.rotationCenter=k;g.shapes=l;g.version=Date.now();a.changed();b&&(c&&b.currentSprite.addCostume(g),b.currentSprite.wearCostume(g),b.hasChangedMedia=!0);(e||nop)()},b,this.shapes||[])};
SVG_Costume.prototype.rasterized=function(){var a=newCanvas(this.extent(),!0);a.getContext("2d").drawImage(this.contents,0,0);return new Costume(a,this.name,this.rotationCenter.copy())};CostumeEditorMorph.prototype=new Morph;CostumeEditorMorph.prototype.constructor=CostumeEditorMorph;CostumeEditorMorph.uber=Morph.prototype;CostumeEditorMorph.prototype.size=Costume.prototype.maxExtent();function CostumeEditorMorph(a){this.init(a)}
CostumeEditorMorph.prototype.init=function(a){this.costume=a||new Costume;this.rotationCenter=this.costume.rotationCenter.copy();this.margin=ZERO;CostumeEditorMorph.uber.init.call(this)};CostumeEditorMorph.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy();this.costume.version=Date.now()};CostumeEditorMorph.prototype.fixLayout=function(){this.bounds.setExtent(this.size)};
CostumeEditorMorph.prototype.render=function(a){this.margin=this.size.subtract(this.costume.extent()).divideBy(2);var b=this.rotationCenter.add(this.margin);this.cachedTexture||(this.cachedTexture=this.createTexture());this.renderCachedTexture(a);a.drawImage(this.costume.contents,this.margin.x,this.margin.y);a.globalAlpha=.5;a.fillStyle="white";a.beginPath();a.arc(b.x,b.y,20,radians(0),radians(360),!1);a.closePath();a.fill();a.stroke();a.beginPath();a.arc(b.x,b.y,10,radians(0),radians(360),!1);a.stroke();
a.beginPath();a.moveTo(0,b.y);a.lineTo(this.costume.width()+2*this.margin.x,b.y);a.stroke();a.beginPath();a.moveTo(b.x,0);a.lineTo(b.x,this.costume.height()+2*this.margin.y);a.stroke()};CostumeEditorMorph.prototype.createTexture=function(){var a=newCanvas(new Point(10,10)),b=a.getContext("2d"),c=new Color(230,230,230);b.fillStyle="white";b.fillRect(0,0,10,10);b.fillStyle=c.toString();b.fillRect(0,0,5,5);b.fillRect(5,5,5,5);return a};
CostumeEditorMorph.prototype.mouseDownLeft=function(a){this.rotationCenter=a.subtract(this.position().add(this.margin));this.rerender()};CostumeEditorMorph.prototype.mouseMove=CostumeEditorMorph.prototype.mouseDownLeft;function Sound(a,b){this.audio=a;this.name=b||"Sound";this.audioBuffer=this.cachedSamples=null;this.isDecoding=!1}Sound.prototype.play=function(){var a=document.createElement("audio");a.src=this.audio.src;a.play();return a};
Sound.prototype.copy=function(){var a=document.createElement("audio");a.src=this.audio.src;return new Sound(a,this.name?copy(this.name):null)};Sound.prototype.toDataURL=function(){return this.audio.src};function Note(a){this.pitch=0===a?0:a||69;this.frequency=null;this.setupContext();this.fader=this.oscillator=null;this.ended=!1}Note.prototype.audioContext=null;Note.prototype.fadeIn=new Float32Array(2);Note.prototype.fadeIn[0]=[0];Note.prototype.fadeIn[1]=[.2];Note.prototype.fadeOut=new Float32Array(2);
Note.prototype.fadeOut[0]=[.2];Note.prototype.fadeOut[1]=[0];Note.prototype.fadeTime=.01;Note.prototype.setupContext=function(){if(!this.audioContext){var a=window.AudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext||window.webkitAudioContext;a.prototype.createGain||(a.prototype.createGain=a.prototype.createGainNode);if(!a)throw Error("Web Audio API is not supported\nin this browser");Note.prototype.audioContext=new a}};
Note.prototype.getAudioContext=function(){this.audioContext||this.setupContext();this.audioContext.resume();return this.audioContext};
Note.prototype.play=function(a,b,c){b||(b=this.audioContext.createGain());this.fader=this.audioContext.createGain();this.oscillator=this.audioContext.createOscillator();this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn);this.oscillator.stop||(this.oscillator.stop=this.oscillator.noteOff);this.setInstrument(a);this.oscillator.frequency.value=isNil(this.frequency)?440*Math.pow(2,(this.pitch-69)/12):this.frequency;this.oscillator.connect(this.fader);this.fader.connect(b);c?(b.connect(c),
c.connect(this.audioContext.destination)):b.connect(this.audioContext.destination);this.ended=!1;this.fader.gain.setValueCurveAtTime(this.fadeIn,this.audioContext.currentTime,this.fadeTime);this.oscillator.start(0)};Note.prototype.setInstrument=function(a){this.oscillator&&(this.oscillator.type=["sine","square","sawtooth","triangle"][(a||1)-1])};
Note.prototype.stop=function(a){var b=!a;if(a&&this.oscillator)this.oscillator.stop(0);else{if(this.fader)try{this.fader.gain.setValueCurveAtTime(this.fadeOut,this.audioContext.currentTime,this.fadeTime)}catch(c){b=!1}this.oscillator&&(this.oscillator.stop(b?this.audioContext.currentTime+this.fadeTime:0),this.oscillator=null);this.ended=!0}};Note.prototype.pause=function(){this.stop()};
function Microphone(){this.analyser=this.processor=this.sourceStream=this.audioContext=null;this.resolution=2;this.GOOD_ENOUGH_CORRELATION=.96;this.compilerProcess=this.compiledModifier=this.modifier=null;this.correlations=[];this.wrapper=new List([0]);this.outChannels=[];this.volume=0;this.signals=[];this.output=[];this.frequencies=[];this.pitch=-1;this.isReady=this.isStarted=!1;this.isAutoStop="file:"!==location.protocol;this.lastTime=Date.now()}
Microphone.prototype.isOn=function(){if(this.isReady)return this.lastTime=Date.now(),!0;this.start();return!1};Microphone.prototype.binSizes=[256,512,1024,2048,4096];Microphone.prototype.binSize=function(){return this.binSizes[this.resolution-1]};Microphone.prototype.setResolution=function(a){contains([1,2,3,4],a)&&(this.isReady&&this.stop(),this.resolution=a)};
Microphone.prototype.start=function(){var a=this;this.isStarted||(this.isStarted=!0,this.isReady=!1,this.audioContext=Note.prototype.getAudioContext(),navigator.mediaDevices.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}}).then(function(b){return a.setupNodes(b)}).catch(nop))};
Microphone.prototype.stop=function(){this.processor.onaudioprocess=null;this.sourceStream.getTracks().forEach(function(a){return a.stop()});this.processor.disconnect();this.analyser.disconnect();this.audioContext=this.analyser=this.processor=null;this.isStarted=this.isReady=!1};
Microphone.prototype.setupNodes=function(a){this.sourceStream=a;this.createProcessor();this.createAnalyser();this.analyser.connect(this.processor);this.processor.connect(this.audioContext.destination);this.audioContext.createMediaStreamSource(a).connect(this.analyser);this.lastTime=Date.now()};
Microphone.prototype.createAnalyser=function(){this.analyser=this.audioContext.createAnalyser();this.analyser.fftSize=this.binSizes[this.resolution];var a=this.analyser.frequencyBinCount;this.frequencies=new Uint8Array(a);this.correlations=Array(Math.floor(a/2))};
Microphone.prototype.createProcessor=function(){var a=this;this.processor=this.audioContext.createScriptProcessor(this.binSizes[this.resolution-1]);this.processor.onaudioprocess=function(b){a.stepAudio(b)};this.processor.clipping=!1;this.processor.lastClip=0;this.processor.clipLevel=.98;this.processor.averaging=.95;this.processor.clipLag=750};
Microphone.prototype.stepAudio=function(a){var b;if(this.isAutoStop&&5E3<Date.now()-this.lastTime&&!this.modifier)this.stop();else{this.signals=a.inputBuffer.getChannelData(0);if(this.modifier){var c=a.outputBuffer.numberOfChannels;this.outChannels.length!==c&&(this.outChannels=Array(c));for(b=0;b<c;b+=1)this.outChannels[b]=a.outputBuffer.getChannelData(b);this.output=this.outChannels[0]}else this.output=a.outputBuffer.getChannelData(0);this.analyser.getByteFrequencyData(this.frequencies);this.pitch=
this.detectPitchAndVolume(this.signals,this.audioContext.sampleRate);0<this.pitch&&(this.note=Math.round(Math.log(this.pitch/440)/Math.log(2)*12)+69);this.isReady=!0;this.isStarted=!1}};
Microphone.prototype.detectPitchAndVolume=function(a,b){var c=a.length,d=Math.floor(c/2),e=-1,f=0,g=0,h=!1,k=this.correlations,l=this.outChannels.length,m;for(m=0;m<c;m+=1){var n=a[m];Math.abs(n)>=this.processor.clipLevel&&(this.processor.clipping=!0,this.processor.lastClip=window.performance.now());g+=n*n;if(this.modifier){this.wrapper.contents[0]=n;var q=invoke(this.compiledModifier,this.wrapper,null,null,null,null,this.compilerProcess);for(n=0;n<l;n+=1)this.outChannels[n][m]=q}}g=Math.sqrt(g/c);
this.volume=Math.max(g,this.volume*this.processor.averaging);if(.01>g)return this.pitch;for(l=g=1;l<d;l+=1){for(m=c=0;m<d;m+=1)c+=Math.abs(a[m]-a[m+l]);c=1-c/d;k[l]=c;if(c>this.GOOD_ENOUGH_CORRELATION&&c>g)h=!0,c>f&&(f=c,e=l);else if(h)return a=(k[e+1]-k[e-1])/k[e],b/(e+8*a);g=c}return.01<f?b/e:this.pitch};
function Microphone(){this.analyser=this.processor=this.sourceStream=this.audioContext=null;this.resolution=2;this.GOOD_ENOUGH_CORRELATION=.96;this.compilerProcess=this.compiledModifier=this.modifier=null;this.correlations=[];this.wrapper=new List([0]);this.outChannels=[];this.volume=0;this.signals=[];this.output=[];this.frequencies=[];this.pitch=-1;this.isReady=this.isStarted=!1;this.isAutoStop="file:"!==location.protocol;this.lastTime=Date.now()}
Microphone.prototype.isOn=function(){if(this.isReady)return this.lastTime=Date.now(),!0;this.start();return!1};Microphone.prototype.binSizes=[256,512,1024,2048,4096];Microphone.prototype.binSize=function(){return this.binSizes[this.resolution-1]};Microphone.prototype.setResolution=function(a){contains([1,2,3,4],a)&&(this.isReady&&this.stop(),this.resolution=a)};
Microphone.prototype.start=function(){var a=this;this.isStarted||(this.isStarted=!0,this.isReady=!1,this.audioContext=Note.prototype.getAudioContext(),navigator.mediaDevices.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}}).then(function(b){a.setupNodes(b)}).catch(nop))};
Microphone.prototype.stop=function(){this.processor.onaudioprocess=null;this.sourceStream.getTracks().forEach(function(a){a.stop()});this.processor.disconnect();this.analyser.disconnect();this.audioContext=this.analyser=this.processor=null;this.isStarted=this.isReady=!1};
Microphone.prototype.setupNodes=function(a){this.sourceStream=a;this.createProcessor();this.createAnalyser();this.analyser.connect(this.processor);this.processor.connect(this.audioContext.destination);this.audioContext.createMediaStreamSource(a).connect(this.analyser);this.lastTime=Date.now()};
Microphone.prototype.createAnalyser=function(){this.analyser=this.audioContext.createAnalyser();this.analyser.fftSize=this.binSizes[this.resolution];var a=this.analyser.frequencyBinCount;this.frequencies=new Uint8Array(a);this.correlations=Array(Math.floor(a/2))};
Microphone.prototype.createProcessor=function(){var a=this;this.processor=this.audioContext.createScriptProcessor(this.binSizes[this.resolution-1]);this.processor.onaudioprocess=function(b){a.stepAudio(b)};this.processor.clipping=!1;this.processor.lastClip=0;this.processor.clipLevel=.98;this.processor.averaging=.95;this.processor.clipLag=750};
Microphone.prototype.stepAudio=function(a){var b;if(this.isAutoStop&&5E3<Date.now()-this.lastTime&&!this.modifier)this.stop();else{this.signals=a.inputBuffer.getChannelData(0);if(this.modifier){var c=a.outputBuffer.numberOfChannels;this.outChannels.length!==c&&(this.outChannels=Array(c));for(b=0;b<c;b+=1)this.outChannels[b]=a.outputBuffer.getChannelData(b);this.output=this.outChannels[0]}else this.output=a.outputBuffer.getChannelData(0);this.analyser.getByteFrequencyData(this.frequencies);this.pitch=
this.detectPitchAndVolume(this.signals,this.audioContext.sampleRate);0<this.pitch&&(this.note=Math.round(Math.log(this.pitch/440)/Math.log(2)*12)+69);this.isReady=!0;this.isStarted=!1}};
Microphone.prototype.detectPitchAndVolume=function(a,b){var c=a.length,d=Math.floor(c/2),e=-1,f=0,g=0,h=!1,k=this.correlations,l=this.outChannels.length,m;for(m=0;m<c;m+=1){var n=a[m];Math.abs(n)>=this.processor.clipLevel&&(this.processor.clipping=!0,this.processor.lastClip=window.performance.now());g+=n*n;if(this.modifier){this.wrapper.contents[0]=n;var q=invoke(this.compiledModifier,this.wrapper,null,null,null,null,this.compilerProcess);for(n=0;n<l;n+=1)this.outChannels[n][m]=q}}g=Math.sqrt(g/c);
this.volume=Math.max(g,this.volume*this.processor.averaging);if(.01>g)return this.pitch;for(l=g=1;l<d;l+=1){for(m=c=0;m<d;m+=1)c+=Math.abs(a[m]-a[m+l]);c=1-c/d;k[l]=c;if(c>this.GOOD_ENOUGH_CORRELATION&&c>g)h=!0,c>f&&(f=c,e=l);else if(h)return a=(k[e+1]-k[e-1])/k[e],b/(e+8*a);g=c}return.01<f?b/e:this.pitch};CellMorph.prototype=new BoxMorph;CellMorph.prototype.constructor=CellMorph;CellMorph.uber=BoxMorph.prototype;function CellMorph(a,b,c,d){this.init(a,b,c,d)}
CellMorph.prototype.init=function(a,b,c,d){this.contents=0===a?0:!1===a?!1:a||"";this.isEditable=isNil(c)?!1:!0;this.idx=c||null;this.parentCell=d||null;CellMorph.uber.init.call(this,SyntaxElementMorph.prototype.corner,1,WHITE);this.color=b||new Color(255,140,0);this.isBig=!1;this.version=null;this.fixLayout()};
CellMorph.prototype.big=function(){this.isBig=!0;this.changed();this.contentsMorph instanceof TextMorph&&this.contentsMorph.setFontSize(1.5*SyntaxElementMorph.prototype.fontSize);this.fixLayout(!0);this.rerender()};CellMorph.prototype.normal=function(){this.isBig=!1;this.changed();this.contentsMorph instanceof TextMorph&&this.contentsMorph.setFontSize(SyntaxElementMorph.prototype.fontSize);this.fixLayout(!0);this.rerender()};
CellMorph.prototype.isCircular=function(a){return this.parentCell?a instanceof List?this.contents===a||this.parentCell.isCircular(a):this.parentCell.isCircular(this.contents):!1};
CellMorph.prototype.fixLayout=function(a){var b=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents,c=this.contentsMorph instanceof TableFrameMorph&&this.contentsMorph.tableMorph.table===this.contents;!a&&(this.createContents(),this.bounds.setHeight(this.contentsMorph.height()+this.edge+2*this.border),this.bounds.setWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:3.5*SyntaxElementMorph.prototype.fontSize)),
b||c||this.contentsMorph.setCenter(this.center()),this.parent&&(this.parent.changed(),this.parent.fixLayout(),this.parent.rerender(),a=this.parentThatIsA(ListWatcherMorph)))&&(a.changed(),a.fixLayout(),a.rerender())};
CellMorph.prototype.createContents=function(){var a=SyntaxElementMorph.prototype.fontSize;var b=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents;var c=this.contentsMorph instanceof TableFrameMorph&&this.contentsMorph.tableMorph.table===this.contents;this.isBig&&(a*=1.5);!this.contentsMorph||b||c||(this.contentsMorph.destroy(),this.version=null);b||c||(this.contents instanceof Morph?isSnapObject(this.contents)?(a=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=
new Morph,this.contentsMorph.isCachingImage=!0,this.contentsMorph.bounds.setWidth(a.width),this.contentsMorph.bounds.setHeight(a.height),this.contentsMorph.cachedImage=a,this.version=this.contents.version):this.contentsMorph=this.contents:isString(this.contents)?(b=500<this.contents.length?this.contents.slice(0,500)+"...":this.contents,this.contentsMorph=new TextMorph(b,a,null,!0,!1,"left"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(WHITE)):
"boolean"===typeof this.contents?(a=SpriteMorph.prototype.booleanMorph.call(null,this.contents).fullImage(),this.contentsMorph=new Morph,this.contentsMorph.isCachingImage=!0,this.contentsMorph.bounds.setWidth(a.width),this.contentsMorph.bounds.setHeight(a.height),this.contentsMorph.cachedImage=a):this.contents instanceof HTMLCanvasElement?(a=this.contents,this.contentsMorph=new Morph,this.contentsMorph.isCachingImage=!0,this.contentsMorph.bounds.setWidth(a.width),this.contentsMorph.bounds.setHeight(a.height),
this.contentsMorph.cachedImage=a):this.contents instanceof Context?(a=this.contents.image(),this.contentsMorph=new Morph,this.contentsMorph.isCachingImage=!0,this.contentsMorph.bounds.setWidth(a.width),this.contentsMorph.bounds.setHeight(a.height),this.contentsMorph.cachedImage=a):this.contents instanceof Costume?(a=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.isCachingImage=!0,this.contentsMorph.bounds.setWidth(a.width),this.contentsMorph.bounds.setHeight(a.height),
this.contentsMorph.cachedImage=a):this.contents instanceof Sound?this.contentsMorph=new SymbolMorph("notes",30):this.contents instanceof List?(this.contents.isTable()?(this.contentsMorph=new TableFrameMorph(new TableMorph(this.contents,10)),this.contentsMorph.expand(new Point(200,150))):this.isCircular()?(this.contentsMorph=new TextMorph("(...)",a,null,!1,!0,"center"),this.contentsMorph.setColor(WHITE)):this.contentsMorph=new ListWatcherMorph(this.contents,this),this.contentsMorph.isDraggable=!1):
(this.contentsMorph=new TextMorph(isNil(this.contents)?"":this.contents.toString(),a,null,!0,!1,"center"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(WHITE)),this.add(this.contentsMorph))};CellMorph.prototype.update=function(){(isSnapObject(this.contents)||this.contents instanceof Costume)&&this.version!==this.contents.version&&(this.rerender(),this.version=this.contents.version)};
CellMorph.prototype.render=function(a){if(0===this.edge&&0===this.border)return BoxMorph.uber.render.call(this,a),null;a.fillStyle=this.color.toString();a.beginPath();this.outlinePath(a,Math.max(this.edge-this.border,0),this.border);a.closePath();a.fill();0<this.border&&!MorphicPreferences.isFlat&&(a.lineWidth=this.border,a.strokeStyle=this.borderColor.toString(),a.beginPath(),this.outlinePath(a,this.edge,this.border/2),a.closePath(),a.stroke(),a.shadowOffsetX=this.border,a.shadowOffsetY=this.border,
a.shadowBlur=this.border,a.shadowColor=this.color.darker(80).toString(),this.drawShadow(a,this.edge,this.border/2))};CellMorph.prototype.drawShadow=function(a,b,c){c=b+c;var d=this.width(),e=this.height();a.beginPath();a.moveTo(0,e-c);a.lineTo(0,c);a.stroke();a.beginPath();a.arc(c,c,b,radians(-180),radians(-90),!1);a.stroke();a.beginPath();a.moveTo(c,0);a.lineTo(d-c,0);a.stroke()};
CellMorph.prototype.layoutChanged=function(){var a=this.parentThatIsA(ListWatcherMorph);this.bounds.setHeight(this.contentsMorph.height()+this.edge+2*this.border);this.bounds.setWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:2*this.height()));this.contentsMorph.setCenter(this.center());this.rerender();a&&a.fixLayout()};
CellMorph.prototype.reactToEdit=function(a){var b;isNil(this.idx)||(b=this.parentThatIsA(ListWatcherMorph))&&b.list.put(a.text,this.idx+b.start-1)};CellMorph.prototype.mouseClickLeft=function(a){this.isEditable&&this.contentsMorph instanceof TextMorph?this.contentsMorph.selectAllAndEdit():this.escalateEvent("mouseClickLeft",a)};
CellMorph.prototype.mouseDoubleClick=function(a){List.prototype.enableTables&&this.currentValue instanceof List?(new TableDialogMorph(this.contents)).popUp(this.world()):this.escalateEvent("mouseDoubleClick",a)};WatcherMorph.prototype=new BoxMorph;WatcherMorph.prototype.constructor=WatcherMorph;WatcherMorph.uber=BoxMorph.prototype;function WatcherMorph(a,b,c,d,e){this.init(a,b,c,d,e)}
WatcherMorph.prototype.init=function(a,b,c,d,e){this.labelText=a||"";this.version=null;this.objName="";this.isGhosted=!1;WatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120));this.color=new Color(220,220,220);this.readoutColor=b;this.style="normal";this.target=c||null;this.getter=d||null;this.cellMorph=this.sliderMorph=this.labelMorph=this.currentValue=null;this.isDraggable=!0;this.fixLayout();this.update();e&&this.hide()};
WatcherMorph.prototype.isTemporary=function(){var a=this.parentThatIsA(StageMorph);return this.target instanceof VariableFrame?a&&this.target===a.variables.parentFrame?!1:null===this.target.owner:!1};WatcherMorph.prototype.object=function(){return this.target instanceof VariableFrame?this.target.owner:this.target};WatcherMorph.prototype.isGlobal=function(a){return contains("getLastAnswer getLastMessage getTempo getTimer reportMouseX reportMouseY reportThreadCount".split(" "),a)};
WatcherMorph.prototype.setSliderMin=function(a,b){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,b),this.sliderMorph.setStart(a,b),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,b))};WatcherMorph.prototype.setSliderMax=function(a,b){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,b),this.sliderMorph.setStop(a,b),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,b))};
WatcherMorph.prototype.update=function(){var a=!1;if(this.target&&this.getter){this.updateLabel();if(this.target instanceof VariableFrame){var b=this.target.vars[this.getter]?this.target.vars[this.getter].value:void 0;if(void 0===b&&this.target.owner)if(b=this.target.owner,contains(b.inheritedVariableNames(),this.getter))b=this.target.getVar(this.getter),this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables.lighter(35));else{this.destroy();return}else this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables)}else b=
this.target[this.getter](),a=(a={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",getScale:"size",getVolume:"volume",getPan:"balance",reportShown:"shown?",getPenDown:"pen down?"}[this.getter])?this.target.inheritsAttribute(a):!1;""===b||isNil(b)||"boolean"===typeof b||isNaN(+b)||(b=Math.round(1E9*b)/1E9);if(void 0===b){this.destroy();return}if(b!==this.currentValue||a!==this.isGhosted||!isNil(b)&&b.version&&b.version!==this.version)this.changed(),this.cellMorph.contents=
b,this.isGhosted=a,isSnapObject(this.target)&&(a?this.cellMorph.setColor(this.readoutColor.lighter(35)):this.cellMorph.setColor(this.readoutColor)),this.cellMorph.fixLayout(),isNaN(b)||(this.sliderMorph.value=b,this.sliderMorph.fixLayout()),this.fixLayout(),this.version=this.currentValue&&this.currentValue.version?this.currentValue.version:Date.now(),this.currentValue=b}this.cellMorph.contentsMorph instanceof ListWatcherMorph?this.cellMorph.contentsMorph.update():isSnapObject(this.cellMorph.contents)&&
this.cellMorph.update()};WatcherMorph.prototype.updateLabel=function(){var a=this.object();a&&!this.isGlobal(this.getter)&&a.version!==this.version&&(this.objName=a.name?a.name+" ":" ",this.labelMorph&&(this.labelMorph.destroy(),this.labelMorph=null,this.fixLayout()))};
WatcherMorph.prototype.fixLayout=function(){var a=SyntaxElementMorph.prototype.fontSize,b,c=this;null===this.labelMorph&&(this.labelMorph=new StringMorph(this.objName+this.labelText,a,null,!0,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),WHITE),this.add(this.labelMorph));null===this.cellMorph&&(this.cellMorph=new CellMorph("",this.readoutColor),this.add(this.cellMorph));null===this.sliderMorph&&(this.sliderMorph=new SliderMorph(0,100,0,20,"horizontal"),this.sliderMorph.alpha=1,this.sliderMorph.button.color=
this.color.darker(),this.sliderMorph.color=this.color.lighter(60),this.sliderMorph.button.highlightColor=this.color.darker(),this.sliderMorph.button.highlightColor.b+=50,this.sliderMorph.button.pressColor=this.color.darker(),this.sliderMorph.button.pressColor.b+=100,this.sliderMorph.setHeight(a),this.sliderMorph.action=function(d){c.target.setVar(c.getter,Math.round(d),c.target.owner)},this.add(this.sliderMorph));if(b=this.cellMorph.contents instanceof List)this.style="normal";"large"===this.style?
(this.labelMorph.hide(),this.sliderMorph.hide(),this.cellMorph.big(),this.cellMorph.setPosition(this.position()),this.bounds.setExtent(this.cellMorph.extent().subtract(1))):(this.labelMorph.show(),this.sliderMorph.show(),this.cellMorph.normal(),this.labelMorph.setPosition(this.position().add(new Point(this.edge,this.border+SyntaxElementMorph.prototype.typeInPadding))),b?this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new Point(0,SyntaxElementMorph.prototype.typeInPadding))):(this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(a/
3,0))),this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)),"slider"===this.style?(this.sliderMorph.setPosition(new Point(this.labelMorph.left(),this.cellMorph.bottom()+SyntaxElementMorph.prototype.typeInPadding)),this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left()),this.bounds.setHeight(this.cellMorph.height()+this.sliderMorph.height()+2*this.border+3*SyntaxElementMorph.prototype.typeInPadding)):(this.sliderMorph.hide(),this.bounds.corner.y=
this.cellMorph.bottom()+this.border+SyntaxElementMorph.prototype.typeInPadding),this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+SyntaxElementMorph.prototype.typeInPadding)};WatcherMorph.prototype.mouseDoubleClick=function(a){List.prototype.enableTables&&this.currentValue instanceof List?(new TableDialogMorph(this.currentValue)).popUp(this.world()):this.escalateEvent("mouseDoubleClick",a)};
WatcherMorph.prototype.rootForGrab=function(){var a=this.parentThatIsA(IDE_Morph);return a&&a.isAppMode?a:this};
WatcherMorph.prototype.userMenu=function(){function a(g){var h=c.parentThatIsA(StageMorph),k=c.currentValue.outerContext.variables;f.addItem(g+"...",function(){var l=detect(h.children,function(n){return n instanceof WatcherMorph&&n.target===k&&n.getter===g});if(null!==l)l.show();else{l=new WatcherMorph(g+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,k,g);l.setPosition(h.position().add(10));var m=h.watchers(l.left());0<m.length&&l.setTop(m[m.length-1].bottom());h.add(l)}l.fixLayout()})}
var b=this,c=this,d=this.parentThatIsA(IDE_Morph),e=16===this.world().currentKey,f=new MenuMorph(this);if(!d||!d.isAppMode)return f.addItem(("normal"===this.style?"\u25cf":"\u25cb")+" "+localize("normal"),"styleNormal"),f.addItem(("large"===this.style?"\u25cf":"\u25cb")+" "+localize("large"),"styleLarge"),this.target instanceof VariableFrame&&(f.addItem(("slider"===this.style?"\u25cf":"\u25cb")+" "+localize("slider"),"styleSlider"),f.addLine(),f.addItem("slider min...","userSetSliderMin"),f.addItem("slider max...",
"userSetSliderMax"),f.addLine(),f.addItem("import...","importData"),f.addItem("raw data...",function(){return b.importData(!0)},"import without attempting to\nparse or format data"),e&&(this.currentValue instanceof List&&this.currentValue.canBeCSV()&&f.addItem("export as CSV...",function(){b.parentThatIsA(IDE_Morph).saveFileAs(b.currentValue.asCSV(),"text/csv;charset=utf-8",b.getter)},null,new Color(100,0,0)),this.currentValue instanceof List&&this.currentValue.canBeJSON()&&f.addItem("export as JSON...",
function(){b.parentThatIsA(IDE_Morph).saveFileAs(b.currentValue.asJSON(!0),"text/json;charset=utf-8",b.getter)},null,new Color(100,0,0))),isString(this.currentValue)||!isNaN(+this.currentValue)?(e&&f.addItem("parse","parseTxt","try to convert\nraw data into a list",new Color(100,0,0)),f.addItem("export...",function(){b.parentThatIsA(IDE_Morph).saveFileAs(b.currentValue.toString(),"text/plain;charset=utf-8",b.getter)})):this.currentValue instanceof List&&this.currentValue.canBeCSV()?f.addItem("export...",
function(){b.parentThatIsA(IDE_Morph).saveFileAs(b.currentValue.asCSV(),"text/csv;charset=utf-8",b.getter)}):this.currentValue instanceof List&&this.currentValue.canBeJSON()?f.addItem("export...",function(){b.parentThatIsA(IDE_Morph).saveFileAs(b.currentValue.asJSON(!0),"text/json;charset=utf-8",b.getter)}):this.currentValue instanceof List&&this.currentValue.canBeCSV()?f.addItem("export...",function(){c.parentThatIsA(IDE_Morph).saveFileAs(c.currentValue.asCSV(),"text/csv;charset=utf-8",c.getter)}):
this.currentValue instanceof List&&this.currentValue.canBeJSON()?f.addItem("export...",function(){c.parentThatIsA(IDE_Morph).saveFileAs(c.currentValue.asJSON(!0),"text/json;charset=utf-8",c.getter)}):this.currentValue instanceof Context&&(e=this.currentValue.outerContext.variables.names(),e.length&&(f.addLine(),e.forEach(function(g){return a(g)}))),this.currentValue.blockify&&f.addItem("blockify",function(){var g=d.world();b.currentValue.blockify().pickUp(g);g.hand.grabOrigin={origin:d.palette,position:d.palette.center()}}),
f.addItem("hide...",function(){var g=c.parentThatIsA(IDE_Morph),h=c.getter;c.isTemporary()?c.destroy():g.stage.toggleVariableWatcher(h)})),f};
WatcherMorph.prototype.importData=function(a){var b=document.createElement("input"),c=this.parentThatIsA(IDE_Morph),d=this;c.filePicker&&(document.body.removeChild(c.filePicker),c.filePicker=null);b.type="file";b.style.color="transparent";b.style.backgroundColor="transparent";b.style.border="none";b.style.outline="none";b.style.position="absolute";b.style.top="0px";b.style.left="0px";b.style.width="0px";b.style.height="0px";b.style.display="none";b.addEventListener("change",function(){function e(g,
h){c.confirm(localize('Snap! can only import "text" files.\nYou selected a file of type "'+g+'".')+"\n\n"+localize("Open anyway?"),"Unable to import",h)}function f(g){function h(m,n){return-1!==m.type.indexOf(n)||l===n}var k=new FileReader,l=g.name.split(".").pop().toLowerCase();k.onloadend=function(m){!a&&h(g,"csv")?d.target.setVar(d.getter,Process.prototype.parseCSV(m.target.result)):!a&&h(g,"json")?d.target.setVar(d.getter,Process.prototype.parseJSON(m.target.result)):d.target.setVar(d.getter,
m.target.result)};a||-1!==g.type.indexOf("text")||contains(["txt","csv","xml","json","tsv"],l)?k.readAsText(g):e(g.type,function(){return k.readAsText(g)})}document.body.removeChild(b);c.filePicker=null;0<b.files.length&&f(b.files[b.files.length-1])},!1);document.body.appendChild(b);c.filePicker=b;b.click()};WatcherMorph.prototype.parseTxt=function(){var a=this.target.vars[this.getter].value;this.target.setVar(this.getter,0===a.indexOf("[")?Process.prototype.parseJSON(a):Process.prototype.parseCSV(a))};
WatcherMorph.prototype.setStyle=function(a){this.style=a;this.fixLayout()};WatcherMorph.prototype.styleNormal=function(){this.setStyle("normal")};WatcherMorph.prototype.styleLarge=function(){this.setStyle("large")};WatcherMorph.prototype.styleSlider=function(){this.setStyle("slider")};WatcherMorph.prototype.userSetSliderMin=function(){(new DialogBoxMorph(this,this.setSliderMin,this)).prompt("Slider minimum value",this.sliderMorph.start.toString(),this.world(),null,null,null,!0)};
WatcherMorph.prototype.userSetSliderMax=function(){(new DialogBoxMorph(this,this.setSliderMax,this)).prompt("Slider maximum value",this.sliderMorph.stop.toString(),this.world(),null,null,null,!0)};
WatcherMorph.prototype.render=function(a){if(MorphicPreferences.isFlat||0===this.edge&&0===this.border)BoxMorph.uber.render.call(this,a);else{var b=a.createLinearGradient(0,0,0,this.height());b.addColorStop(0,this.color.lighter().toString());b.addColorStop(1,this.color.darker().toString());a.fillStyle=b;a.beginPath();this.outlinePath(a,Math.max(this.edge-this.border,0),this.border);a.closePath();a.fill();0<this.border&&(b=a.createLinearGradient(0,0,0,this.height()),b.addColorStop(0,this.borderColor.lighter().toString()),
b.addColorStop(1,this.borderColor.darker().toString()),a.lineWidth=this.border,a.strokeStyle=b,a.beginPath(),this.outlinePath(a,this.edge,this.border/2),a.closePath(),a.stroke())}};StagePrompterMorph.prototype=new BoxMorph;StagePrompterMorph.prototype.constructor=StagePrompterMorph;StagePrompterMorph.uber=BoxMorph.prototype;function StagePrompterMorph(a){this.init(a)}
StagePrompterMorph.prototype.init=function(a){var b=this;this.isDone=!1;this.label=a?new StringMorph(a,SpriteMorph.prototype.bubbleFontSize,null,SpriteMorph.prototype.bubbleFontIsBold,!1,"left"):null;this.inputField=new InputFieldMorph;this.button=new PushButtonMorph(null,function(){return b.accept()},"\u2713");StagePrompterMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,SpriteMorph.prototype.bubbleBorder,SpriteMorph.prototype.blockColor.sensing);this.color=WHITE;this.label&&this.add(this.label);
this.add(this.inputField);this.add(this.button);this.setWidth(StageMorph.prototype.dimensions.x-20);this.fixLayout()};
StagePrompterMorph.prototype.fixLayout=function(){var a=0;this.label&&(this.label.setPosition(new Point(this.left()+this.edge,this.top()+this.edge)),a=this.label.bottom()-this.top());this.inputField.setPosition(new Point(this.left()+this.edge,this.top()+a+this.edge));this.inputField.setWidth(this.width()-2*this.edge-this.button.width()-this.border);this.button.setCenter(this.inputField.center());this.button.setLeft(this.inputField.right()+this.border);this.setHeight(this.inputField.bottom()-this.top()+
this.edge)};StagePrompterMorph.prototype.mouseClickLeft=function(){this.inputField.edit()};StagePrompterMorph.prototype.accept=function(){this.isDone=!0};ReplayControls.prototype=new Morph;ReplayControls.prototype.buttonColor=new Color(200,200,200);ReplayControls.prototype.constructor=ReplayControls;ReplayControls.uber=Morph.prototype;function ReplayControls(){this.init()}
ReplayControls.prototype.init=function(){var a=this;ReplayControls.uber.init.call(this);this.alpha=0;this.actions=null;this.actionIndex=-1;this.actionTime=0;this.isPlaying=this.isApplyingAction=!1;this.maxGapDuration=12E4;this.gapFolds=[];this.isShowingCaptions=!1;this.lastCaption=null;this.replaySpeed=1;this.maxInactiveDuration=0;this.playButton=new SymbolMorph("pointRight",40,this.buttonColor);this.playButton.mouseClickLeft=function(){a.play()};this.stepForwardButton=new SymbolMorph("stepForward",
17,this.buttonColor);this.stepForwardButton.mouseClickLeft=function(){a.stepForward()};this.stepBackwardButton=new SymbolMorph("stepBackward",17,this.buttonColor);this.stepBackwardButton.mouseClickLeft=function(){a.stepBackward()};this.jumpBackwardButton=new SymbolMorph("jumpBackward",20,this.buttonColor);this.jumpBackwardButton.mouseClickLeft=function(){a.jumpToBeginning()};this.jumpForwardButton=new SymbolMorph("jumpForward",20,this.buttonColor);this.jumpForwardButton.mouseClickLeft=function(){a.jumpToEnd()};
this.displayTime=new TextMorph("0:00 / 1:00",1.5*PushButtonMorph.prototype.fontSize,PushButtonMorph.prototype.fontStyle,!0);this.displayTime.color=this.buttonColor;this.settingsButton=new SymbolMorph("gears",30,this.buttonColor);this.settingsButton.mouseClickLeft=function(){var d=this.world(),e=a.settingsMenu(),f=d.hand.position().subtract(e.extent());e.popup(d,f)};this.captionsButton=new SymbolMorph("speechBubble",30,this.buttonColor);this.captionsButton.mouseClickLeft=function(){a.toggleCaptions()};
this.slider=new SliderMorph(0,100,0,1,"horizontal");this.slider.start=0;this.slider.value=0;var b=this.slider.mouseDownLeft;this.slider.mouseDownLeft=function(d){a.pause();b.call(this,d)};var c=this.slider.updateValue;this.slider.updateValue=function(){c.apply(this,arguments);a.updateDisplayTime()};this.add(this.slider);this.add(this.playButton);this.add(this.stepForwardButton);this.add(this.jumpForwardButton);this.add(this.jumpBackwardButton);this.add(this.stepBackwardButton);this.add(this.displayTime);
this.add(this.captionsButton);this.add(this.settingsButton);this.fixLayout();this.rerender();this.update()};
ReplayControls.prototype.settingsMenu=function(){var a=this,b=new MenuMorph(this),c=new MenuMorph(this),d={slow:.5,normal:1,"slightly faster":3,fast:5,"really fast":10,"ludicrous speed":20},e={"1 minute":6E4,"2 minute":12E4,"5 minutes":3E5,"10 minutes":6E5,"20 minutes":12E5},f=function(g,h,k){var l=new MenuMorph(a),m=k.skip||[];Object.keys(g).forEach(function(n){var q=g[n],p=contains(m,n);delete g[n];n=p?localize(n):localize(n)+" ("+q+k.suffix+")";g[n]=q;l.addItem(p?n:q+k.suffix,function(){a[h]=q;
if(k.refresh){var t=a.getTimeFromPosition(a.slider.value);a.setActions(a.actions);a.slider.value=a.getSliderPositionFromTime(t);a.slider.rerender();a.updateDisplayTime()}},null,null,a[h]===q)});return l};b.addMenu("Max inactive duration...",f({"no acceleration":0,tiny:.5,small:1,medium:2,"long":5},"maxInactiveDuration",{suffix:"s",skip:["no acceleration"]}));c=f(d,"replaySpeed",{suffix:"x"});c.addItem("other...",function(){(new DialogBoxMorph(null,function(g){a.replaySpeed=Math.max(+g,0)||1})).withKey("replaySpeed").prompt("Replay Speed",
a.replaySpeed.toString(),a.world(),null,d,!1,!0)});b.addMenu("Replay speed...",c);b.addMenu("Auto-condense gap size...",f(e,"maxGapDuration",{skip:Object.keys(e),refresh:!0}));b.rerender();return b};
ReplayControls.prototype.toggleCaptions=function(){var a=this.parentThatIsA(IDE_Morph);var b=(this.isShowingCaptions=!this.isShowingCaptions)?new Color(98,194,19):this.buttonColor;a.showMessage(localize("captions "+(this.isShowingCaptions?"enabled":"disabled")),1);this.lastCaption&&(this.lastCaption.destroy(),this.lastCaption=null);this.captionsButton.color=b;this.captionsButton.rerender();this.captionsButton.changed()};
ReplayControls.prototype.jumpToBeginning=function(){this.slider.button.setLeft(this.getSliderLeftFromValue(this.slider.start));this.slider.updateValue()};ReplayControls.prototype.jumpToEnd=function(){this.slider.button.setLeft(this.getSliderLeftFromValue(this.slider.stop));this.slider.updateValue()};ReplayControls.prototype.stepForward=function(){this.pause();this.playNext()};ReplayControls.prototype.stepBackward=function(){this.pause();this.playNext(-1)};
ReplayControls.prototype.displayCaption=function(a,b){var c=a.type;a.replayType===UndoManager.UNDO?(b===a&&(b=this.getInverseEvent(a)),c=b.type+" (undo)"):a.replayType===UndoManager.REDO&&(c+=" (redo)");var d=new MenuMorph(null,c,null,16);a=new Point(this.center().x,this.top()-50);b=this.world();this.lastCaption&&this.lastCaption.destroy();d.popup(b,a);this.lastCaption=d;var e=setInterval(function(){d.destroy();clearInterval(e)},4E3);return d};ReplayControls.prototype.getCaptionFor=function(a){return a.type};
ReplayControls.prototype.play=function(){var a=this;this.isAtEnd()||(this.isPlaying=!0,this.lastPlayUpdate=Date.now(),this.removeChild(this.playButton),this.playButton=new SymbolMorph("pause",40,this.buttonColor),this.playButton.mouseClickLeft=function(){a.pause()},this.add(this.playButton),this.fixLayout())};ReplayControls.prototype.isAtEnd=function(){return this.actionIndex===this.actions.length-1};
ReplayControls.prototype.getSliderLeftFromValue=function(a){return(a-this.slider.start)*this.slider.unitSize()+this.slider.left()};
ReplayControls.prototype.step=function(){if(this.isPlaying){var a=Date.now(),b=a-this.lastPlayUpdate,c=this.actions[this.actionIndex+1];if(this.maxInactiveDuration&&c){var d=c.time-this.slider.value;1E3*this.maxInactiveDuration<d&&(b=c.time-1E3*this.maxInactiveDuration-this.slider.value)}b*=this.replaySpeed;b=this.slider.value+b;b>this.slider.stop&&(b=this.slider.stop,this.pause());this.slider.button.setLeft(this.getSliderLeftFromValue(b));this.slider.updateValue();this.lastPlayUpdate=a}};
ReplayControls.prototype.formatTime=function(a){var b=function(f,g){for(f=f.toString();f.length<g;)f="0"+f;return f};if(36E5<a){var c=Math.floor(a/36E5);a-=36E5*c}var d=Math.floor(a/6E4);a-=6E4*d;var e=Math.floor(a/1E3);a-=1E3*e;e=b(e,2);return c?(d=b(d,2),24<c?(a=Math.floor(c/24),[a,c-24*a,d,e].join(":")):[c,d,e].join(":")):[d,e].join(":")};
ReplayControls.prototype.updateDisplayTime=function(){var a=this.actions[this.actions.length-1].time-this.actions[0].time,b=this.getTimeFromPosition(this.slider.value)-this.getTimeFromPosition(this.slider.start);this.displayTime.text=this.formatTime(b)+" / "+this.formatTime(a);this.displayTime.changed();this.displayTime.fixLayout();this.displayTime.rerender()};
ReplayControls.prototype.playNext=function(a){var b;a=a||1;if(b=this.actions[this.actionIndex+Math.max(a,0)])a=this.getSliderPosition(b)+a,this.slider.button.setLeft(this.getSliderLeftFromValue(a)),this.slider.updateValue();this.pause()};
ReplayControls.prototype.pause=function(){var a=this;this.removeChild(this.playButton);this.playButton=new SymbolMorph("pointRight",40,this.buttonColor);this.playButton.mouseClickLeft=function(){a.play()};this.add(this.playButton);this.fixLayout();this.isPlaying=!1};
ReplayControls.prototype.fixLayout=function(){var a=this.center(),b=this.top(),c=this.width(),d=this.height();this.playButton.size=d-45;this.playButton.setTop(b+15+10);this.playButton.rerender();this.jumpBackwardButton.setCenter(this.playButton.center());this.stepBackwardButton.setCenter(this.playButton.center());this.jumpBackwardButton.setLeft(this.left()+25);this.jumpBackwardButton.rerender();this.stepBackwardButton.setLeft(this.jumpBackwardButton.right()+15);this.stepBackwardButton.rerender();
this.playButton.setLeft(this.stepBackwardButton.right()+20);this.playButton.rerender();this.stepForwardButton.setCenter(this.playButton.center());this.stepForwardButton.setLeft(this.playButton.right()+20);this.stepForwardButton.rerender();this.jumpForwardButton.setCenter(this.stepForwardButton.center());this.jumpForwardButton.setLeft(this.stepForwardButton.right()+15);this.jumpForwardButton.rerender();this.displayTime.setCenter(this.playButton.center());this.displayTime.setLeft(this.jumpForwardButton.right()+
40);this.displayTime.rerender();this.settingsButton.setTop(b+15+10);this.settingsButton.setRight(this.right()-30);this.settingsButton.rerender();this.captionsButton.setTop(b+15+10);this.captionsButton.setRight(this.settingsButton.left()-10);this.captionsButton.rerender();this.slider.setWidth(c-20);this.slider.setHeight(15);this.slider.setCenter(new Point(a.x,0));this.slider.setTop(b);this.slider.rerender()};ReplayControls.prototype.enable=function(){this.enabled=!0;this.show()};
ReplayControls.prototype.disable=function(){this.enabled=!1;this.actions=null;this.isPlaying=!1;this.lastCaption&&this.lastCaption.destroy();this.hide()};ReplayControls.prototype.getCurrentHistory=function(){return this.actions.slice(0,this.actionIndex+1)};ReplayControls.prototype.getSliderPosition=function(a){return this.getSliderPositionFromTime(a.time)};
ReplayControls.prototype.getSliderPositionFromTime=function(a){for(var b=0,c=this.gapFolds.length;c--;)this.gapFolds[c][1]<=a&&(b+=this.gapFolds[c][1]-this.gapFolds[c][0]);return a-b};ReplayControls.prototype.getTimeFromPosition=function(a){for(var b=0;b<this.gapFolds.length;b++)this.gapFolds[b][0]<=a&&(a+=this.gapFolds[b][1]-this.gapFolds[b][0]);return a};
ReplayControls.prototype.computeGapFolds=function(){for(var a=[],b,c,d=1;d<this.actions.length;d++)b=this.actions[d].time-this.actions[d-1].time-this.maxGapDuration,0<b&&(b=this.actions[d-1].time+this.maxGapDuration/2,c=this.actions[d].time-this.maxGapDuration/2,a.push([b,c]));this.gapFolds=a};
ReplayControls.prototype.setActions=function(a,b){this.slider.clearTicks();this.isPlaying=!1;this.actions=a;this.computeGapFolds();for(a=this.gapFolds.length;a--;)this.slider.addTick(this.getSliderPositionFromTime(this.gapFolds[a][0]),this.color.lighter(),4),this.slider.addTick(this.getSliderPositionFromTime(this.gapFolds[a][1]),this.color.lighter(),4);var c=this.actions[this.actions.length-1].time;a=this.getSliderPosition(this.actions[this.actions.length-1])+1;this.slider.start=this.getSliderPosition(this.actions[0])-
1;b?(this.slider.value=a,this.actionIndex=this.actions.length-1,this.actionTime=c):(this.actionIndex=-1,this.slider.value=this.slider.start);this.slider.setStop(a);for(a=0;a<this.actions.length;a++)this.slider.addTick(this.getSliderPosition(this.actions[a]),this.getColorForTick(this.actions[a]));this.slider.fixLayout();this.slider.rerender();this.updateDisplayTime()};ReplayControls.prototype.getColorForTick=function(){return null};
ReplayControls.prototype.update=function(){var a=this,b=this.getTimeFromPosition(this.slider.value);if(!this.enabled)return setTimeout(this.update.bind(this),100);if(this.actionTime!==b&&this.actions&&!this.isApplyingAction){var c=b-this.actionTime;c/=Math.abs(c);if(1===c){var d=this.actions[this.actionIndex+1];var e=copy(d);if(!d||d.time>=b)return setTimeout(this.update.bind(this),100)}else{d=this.actions[this.actionIndex];if(!d||d.time<=b)return setTimeout(this.update.bind(this),100);e=this.getInverseEvent(d)}"openProject"===
e.type&&!e.replayType&&2>e.args.length&&(b=this.parentThatIsA(IDE_Morph),b=b.serializer.serialize(b.stage),0===e.args.length&&e.args.push(null),e.args.push(b));this.isApplyingAction=!0;e.isReplay=!0;this.actionIndex+=c;this.actionTime=d.time;this.applyEvent(e,function(){a.isApplyingAction=!1;a.isShowingCaptions&&a.displayCaption(e,d);setTimeout(a.update.bind(a),10)},c)}else setTimeout(this.update.bind(this),100)};
ReplayControls.prototype.applyEvent=function(a,b,c){if(a.isUserAction)return b();var d=this,e=this.parentThatIsA(IDE_Morph);if(a.owner){var f=a.owner.split("/");var g=f[0];f=f[1];if(g=SnapActions.getOwnerFromId(g))e.selectSprite(g),e.spriteBar.tabBar.tabTo(f)}return SnapActions.applyEvent(a).then(b).catch(function(h){d.onReplayError(h,a,c);b()})};
ReplayControls.prototype.onReplayError=function(a,b,c){c=1===c?"apply":"revert";var d=".";b&&(d=" "+localize("when trying to ")+b.type);a&&(d+=":\n\n"+a.message);d=localize("Something went wrong")+d+"\n\n"+localize("The error has been reported. Reloading the page is recommended.");this.pause();(new DialogBoxMorph).inform(localize("Could not "+c+" action"),d,this.world());console.error("Could not apply event: "+JSON.stringify(b,null,2));console.error(a)};
ReplayControls.prototype.getInverseEvent=function(a){if(a.replayType)for(var b=0,c,d=this.actionIndex;d--;){if(c=this.actions[d],c.replayType=c.replayType||0,c.owner===a.owner){if(a.replayType===c.replayType+1&&0===b)return this.actions[d];c.replayType===a.replayType?b--:b++}}else return b=SnapUndo.getInverseEvent(a),b.replayType=UndoManager.UNDO,b.owner=a.owner,b};modules.paint="2020-July-13";PaintEditorMorph.prototype=new DialogBoxMorph;PaintEditorMorph.prototype.constructor=PaintEditorMorph;
PaintEditorMorph.uber=DialogBoxMorph.prototype;PaintEditorMorph.prototype.padding=10;function PaintEditorMorph(){this.init()}PaintEditorMorph.prototype.init=function(){this.oncancel=this.paper=null;PaintEditorMorph.uber.init.call(this);this.labelString="Paint Editor";this.createLabel();this.buildContents()};
PaintEditorMorph.prototype.buildContents=function(){var a=this;this.paper=new PaintCanvasMorph(function(){return a.shift});this.paper.setExtent(StageMorph.prototype.dimensions);this.addBody(new AlignmentMorph("row",this.padding));this.controls=new AlignmentMorph("column",this.padding/2);this.controls.alignment="center";this.edits=new AlignmentMorph("row",this.padding/2);this.buildEdits();this.controls.add(this.edits);this.body.color=this.color;this.body.add(this.controls);this.body.add(this.paper);
this.toolbox=new BoxMorph;this.toolbox.color=SpriteMorph.prototype.paletteColor.lighter(8);this.toolbox.borderColor=this.toolbox.color.lighter(40);MorphicPreferences.isFlat&&(this.toolbox.edge=0);this.buildToolbox();this.controls.add(this.toolbox);this.scaleBox=new AlignmentMorph("row",this.padding/2);this.buildScaleBox();this.controls.add(this.scaleBox);this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null};this.populatePropertiesMenu();
this.addButton("ok","OK");this.addButton("cancel","Cancel");this.refreshToolButtons();this.fixLayout()};
PaintEditorMorph.prototype.buildToolbox=function(){var a={brush:"Paintbrush tool\n(free draw)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: vertical/horizontal)",rectangleSolid:"Filled Rectangle\n(shift: square)",circleSolid:"Filled Ellipse\n(shift: circle)",paintbucket:"Fill a region",pipette:"Pipette tool\n(pick a color anywhere)"},b=this,c=this.toolbox.left(),d=this.toolbox.top(),
e=0,f=0;Object.keys(a).forEach(function(g){var h=b.toolButton(g,a[g]);h.setPosition(new Point(c+e,d+f));e+=h.width()+2;"crosshairs"===g&&(e=0,f+=h.height()+2,b.paper.drawcrosshair());b.toolbox[g]=h;b.toolbox.add(h)});this.toolbox.bounds=this.toolbox.fullBounds().expandBy(10)};
PaintEditorMorph.prototype.buildEdits=function(){var a=this,b=this.paper;this.edits.add(this.pushButton("undo",function(){b.undo()}));this.edits.add(this.pushButton("clear",function(){b.clearCanvas()}));this.edits.add(this.pushButton("Vector",function(){0<a.paper.undoBuffer.length?a.ide.confirm("This will erase your current drawing.\nAre you sure you want to continue?","Switch to vector editor?",function(){setTimeout(function(){a.switchToVector()})}):a.switchToVector()}));this.edits.fixLayout()};
PaintEditorMorph.prototype.buildScaleBox=function(){var a=this.paper;this.scaleBox.add(this.pushButton(new SymbolMorph("grow",18),function(){a.scale(.05,.05)},"grow"));this.scaleBox.add(this.pushButton(new SymbolMorph("shrink",18),function(){a.scale(-.05,-.05)},"shrink"));this.scaleBox.add(this.pushButton(new SymbolMorph("flipHorizontal",18),function(){a.scale(-2,0)},"flip horizontal"));this.scaleBox.add(this.pushButton(new SymbolMorph("flipVertical",18),function(){a.scale(0,-2)},"flip vertical"));
this.scaleBox.fixLayout()};
PaintEditorMorph.prototype.openIn=function(a,b,c,d,e){var f=this;this.oldim=b;this.callback=d||nop;this.ide=e;this.processKeyUp=function(){f.shift=!1;f.propertiesControls.constrain.refresh()};this.processKeyDown=function(){f.shift=16===f.world().currentKey;f.propertiesControls.constrain.refresh()};this.oldim&&(this.paper.automaticCrosshairs=isNil(c),this.paper.centermerge(this.oldim,this.paper.paper),this.paper.rotationCenter=(c||new Point(0,0)).add(new Point((this.paper.paper.width-this.oldim.width)/
2,(this.paper.paper.height-this.oldim.height)/2)),this.paper.drawNew());this.key="paint";this.popUp(a)};PaintEditorMorph.prototype.fixLayout=function(){this.changed();this.paper&&(this.paper.buildContents(),this.paper.drawNew());this.controls&&this.controls.fixLayout();this.body&&this.body.fixLayout();PaintEditorMorph.uber.fixLayout.call(this);this.changed()};PaintEditorMorph.prototype.refreshToolButtons=function(){this.toolbox.children.forEach(function(a){a.refresh()})};
PaintEditorMorph.prototype.ok=function(){this.paper.updateAutomaticCenter();this.callback(this.paper.paper,this.paper.rotationCenter);this.destroy()};PaintEditorMorph.prototype.cancel=function(){if(this.oncancel)this.oncancel();this.destroy()};PaintEditorMorph.prototype.switchToVector=function(){this.object=new SVG_Costume(new Image,"",new Point(0,0));this.object.edit(this.world(),this.ide,!0)};
PaintEditorMorph.prototype.populatePropertiesMenu=function(){var a=this.controls,b=this,c=this.propertiesControls,d=new AlignmentMorph("row",this.padding),e=new AlignmentMorph("column",3);e.alignment="left";c.primaryColorViewer=new Morph;c.primaryColorViewer.isCachingImage=!0;c.primaryColorViewer.render=function(f){var g=b.paper.settings.primarycolor,h;if("transparent"===g)for(g=0;180>g;g+=5)for(h=0;15>h;h+=5)f.fillStyle=0===(h+g)/5%2?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",f.fillRect(g,h,5,5);
else f.fillStyle=g.toString(),f.fillRect(0,0,180,15);f.strokeStyle="black";f.lineWidth=Math.min(b.paper.settings.linewidth,20);f.beginPath();f.lineCap="round";f.moveTo(20,30);f.lineTo(160,30);f.stroke()};c.primaryColorViewer.setExtent(new Point(180,40));c.primaryColorViewer.color=new Color(0,0,0);c.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(f){b.paper.settings.primarycolor=f;c.primaryColorViewer.rerender()});c.colorpicker.isCachingImage=!0;c.colorpicker.action(new Color(0,0,
0));c.penSizeSlider=new SliderMorph(0,20,5,5);c.penSizeSlider.orientation="horizontal";c.penSizeSlider.setHeight(15);c.penSizeSlider.setWidth(150);c.penSizeSlider.action=function(f){c.penSizeField&&c.penSizeField.setContents(f);b.paper.settings.linewidth=f;c.colorpicker.action(b.paper.settings.primarycolor)};c.penSizeField=new InputFieldMorph("5",!0,null,!1);c.penSizeField.contents().minWidth=20;c.penSizeField.setWidth(25);c.penSizeField.accept=function(){var f=parseFloat(c.penSizeField.getValue());
c.penSizeSlider.value=f;c.penSizeSlider.updateValue();this.setContents(f);b.paper.settings.linewidth=f;this.world().keyboardFocus=b;c.colorpicker.action(b.paper.settings.primarycolor)};d.add(c.penSizeSlider);d.add(c.penSizeField);d.color=b.color;d.fixLayout();c.penSizeField.fixLayout();c.constrain=new ToggleMorph("checkbox",this,function(){b.shift=!b.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return b.shift});c.constrain.label.isBold=!1;a.add(c.colorpicker);a.add(c.primaryColorViewer);
e.add(new StringMorph(localize("Brush size")+":",10,null,!0));e.add(d);e.add(c.constrain);e.fixLayout();a.add(e)};PaintEditorMorph.prototype.toolButton=function(a,b){var c=this;var d=new ToggleButtonMorph(null,this,function(){c.paper.currentTool=a;c.paper.toolChanged(a);c.refreshToolButtons();"pipette"===a&&c.getUserColor()},new SymbolMorph(a,18),function(){return c.paper.currentTool===a});d.hint=b;return d};
PaintEditorMorph.prototype.pushButton=function(a,b,c){return new PushButtonMorph(this,b,a,null,c)};
PaintEditorMorph.prototype.getUserColor=function(){var a=this,b=this.world(),c=b.hand,d=getDocumentPositionOf(b.worldCanvas),e=c.processMouseMove,f=c.processMouseDown,g=c.processMouseUp;c.processMouseMove=function(h){c.setPosition(new Point(h.pageX-d.x,h.pageY-d.y));h=b.getGlobalPixelColor(c.position());h.a&&(h.a=1,a.propertiesControls.colorpicker.action(h))};c.processMouseDown=nop;c.processMouseUp=function(){a.paper.currentTool="brush";a.paper.toolChanged("brush");a.refreshToolButtons();c.processMouseMove=
e;c.processMouseDown=f;c.processMouseUp=g}};PaintColorPickerMorph.prototype=new Morph;PaintColorPickerMorph.prototype.constructor=PaintColorPickerMorph;PaintColorPickerMorph.uber=Morph.prototype;function PaintColorPickerMorph(a,b){this.init(a,b)}PaintColorPickerMorph.prototype.init=function(a,b){this.isCachingImage=!0;this.setExtent(a||new Point(200,100));this.action=b||nop};
PaintColorPickerMorph.prototype.render=function(a){var b,c;for(b=0;b<this.width();b+=1)for(c=0;c<this.height()-20;c+=1)a.fillStyle="hsl("+360*b/this.width()+",100%,"+100*c/(this.height()-20)+"%)",a.fillRect(b,c,1,1);for(b=0;b<this.width();b+=1)c=Math.floor(255*b/this.width()),a.fillStyle="rgb("+c+", "+c+", "+c+")",a.fillRect(b,this.height()-20,1,10);c=["black","white","gray"];for(b=0;b<c.length;b+=1)a.fillStyle=c[b],a.fillRect(b*this.width()/c.length,this.height()-10,this.width()/c.length,10);for(b=
2*this.width()/3;b<this.width();b+=2)for(c=this.height()-10;c<this.height();c+=2)0===(b+c)/2%2&&(a.fillStyle="#DDD",a.fillRect(b,c,2,2))};PaintColorPickerMorph.prototype.mouseDownLeft=function(a){a.subtract(this.position()).x>2*this.width()/3&&a.subtract(this.position()).y>this.height()-10?this.action("transparent"):this.action(this.getPixelColor(a))};PaintColorPickerMorph.prototype.mouseMove=PaintColorPickerMorph.prototype.mouseDownLeft;PaintCanvasMorph.prototype=new Morph;
PaintCanvasMorph.prototype.constructor=PaintCanvasMorph;PaintCanvasMorph.uber=Morph.prototype;function PaintCanvasMorph(a){this.init(a)}
PaintCanvasMorph.prototype.init=function(a){this.rotationCenter=new Point(240,180);this.previousDragPoint=this.dragRect=null;this.currentTool="brush";this.dragRect=new Rectangle;this.background=this.erasermask=this.paper=this.mask=null;this.settings={primarycolor:new Color(0,0,0,255),secondarycolor:new Color(0,0,0,255),linewidth:3};this.brushBuffer=[];this.undoBuffer=[];this.isShiftPressed=a||function(){return 16===this.world().currentKey};this.isCachingImage=this.automaticCrosshairs=!0;this.buildContents();
this.drawNew()};PaintCanvasMorph.prototype.calculateCanvasCenter=function(a){a=Costume.prototype.canvasBoundingBox(a);return null===a?null:new Point((a.origin.x+a.corner.x)/2,(a.origin.y+a.corner.y)/2)};PaintCanvasMorph.prototype.updateAutomaticCenter=function(){if(this.automaticCrosshairs){var a=this.calculateCanvasCenter(this.paper);null!==a&&(this.rotationCenter=a)}};
PaintCanvasMorph.prototype.scale=function(a,b){this.updateAutomaticCenter();this.mask=newCanvas(this.extent(),!0);var c=newCanvas(this.extent(),!0);c.getContext("2d").save();c.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y);c.getContext("2d").scale(1+a,1+b);c.getContext("2d").drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y);c.getContext("2d").restore();this.paper=c;this.drawNew();this.changed()};
PaintCanvasMorph.prototype.cacheUndo=function(){var a=newCanvas(this.extent(),!0);this.merge(this.paper,a);this.undoBuffer.push(a)};PaintCanvasMorph.prototype.undo=function(){0<this.undoBuffer.length&&(this.paper=newCanvas(this.extent(),!0),this.mask.width=this.mask.width+1-1,this.merge(this.undoBuffer.pop(),this.paper),this.drawNew(),this.changed())};PaintCanvasMorph.prototype.merge=function(a,b){b.getContext("2d").drawImage(a,0,0)};
PaintCanvasMorph.prototype.centermerge=function(a,b){b.getContext("2d").drawImage(a,(b.width-a.width)/2,(b.height-a.height)/2)};PaintCanvasMorph.prototype.clearCanvas=function(){this.buildContents();this.drawNew();this.changed()};PaintCanvasMorph.prototype.toolChanged=function(a){this.mask=newCanvas(this.extent(),!0,this.mask);"crosshairs"===a&&(this.updateAutomaticCenter(),this.drawcrosshair());this.drawNew();this.changed()};
PaintCanvasMorph.prototype.drawcrosshair=function(a){a=a||this.mask.getContext("2d");var b=this.rotationCenter;a.save();a.lineWidth=1;a.strokeStyle="black";a.clearRect(0,0,this.mask.width,this.mask.height);a.globalAlpha=.5;a.fillStyle="white";a.beginPath();a.arc(b.x,b.y,20,radians(0),radians(360),!1);a.closePath();a.fill();a.stroke();a.beginPath();a.arc(b.x,b.y,10,radians(0),radians(360),!1);a.stroke();a.beginPath();a.moveTo(0,b.y);a.lineTo(this.mask.width,b.y);a.stroke();a.beginPath();a.moveTo(b.x,
0);a.lineTo(b.x,this.mask.height);a.stroke();a.restore();this.drawNew()};
PaintCanvasMorph.prototype.floodfill=function(a){var b=this.paper.width,c=this.paper.height,d=this.paper.getContext("2d"),e=d.getImageData(0,0,b,c),f=e.data;a=[Math.round(Math.round(a.y)*b+a.x)];var g=function(m){m*=4;return[f[m],f[m+1],f[m+2],f[m+3]]};var h=g(a[0]);var k=function(m){return m[0]===h[0]&&m[1]===h[1]&&m[2]===h[2]&&m[3]===h[3]};if(0!==h[3]||"transparent"!==this.settings.primarycolor)if(h[0]!==this.settings.primarycolor.r||h[1]!==this.settings.primarycolor.g||h[2]!==this.settings.primarycolor.b||
h[3]!==255*this.settings.primarycolor.a)if(0!==h[3]||0!==this.settings.primarycolor.a){for(;0<a.length;){var l=a.pop();k(g(l))&&(1<l%b&&(a.push(l+1),a.push(l-1)),0<l&&l<c*b&&(a.push(l+b),a.push(l-b)));"transparent"===this.settings.primarycolor?f[4*l+3]=0:(f[4*l]=this.settings.primarycolor.r,f[4*l+1]=this.settings.primarycolor.g,f[4*l+2]=this.settings.primarycolor.b,f[4*l+3]=255*this.settings.primarycolor.a)}d.putImageData(e,0,0);this.drawNew();this.changed()}};
PaintCanvasMorph.prototype.mouseDownLeft=function(a){this.cacheUndo();this.dragRect.origin=a.subtract(this.bounds.origin);this.dragRect.corner=a.subtract(this.bounds.origin);this.previousDragPoint=this.dragRect.corner.copy();if("crosshairs"===this.currentTool)this.rotationCenter=a.subtract(this.bounds.origin),this.drawcrosshair();else{if("paintbucket"===this.currentTool)return this.floodfill(a.subtract(this.bounds.origin));"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool&&
(this.erasermask=newCanvas(this.extent(),!0,this.erasermask),this.merge(this.paper,this.erasermask))}};
PaintCanvasMorph.prototype.mouseMove=function(a){function b(){return l/Math.abs(l)*Math.max(Math.abs(l),Math.abs(m))}function c(){return m/Math.abs(m)*Math.max(Math.abs(l),Math.abs(m))}if("paintbucket"!==this.currentTool){a=a.subtract(this.bounds.origin);var d=this.mask.getContext("2d"),e=this.paper.getContext("2d"),f=this.dragRect.origin.x,g=this.dragRect.origin.y,h=a.x,k=a.y,l=(h-f)/2,m=(k-g)/2,n=this.paper.width;d.save();this.brushBuffer.push([h,k]);d.lineWidth=this.settings.linewidth;d.clearRect(0,
0,this.bounds.width(),this.bounds.height());this.dragRect.corner=a.subtract(this.dragRect.origin);"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool?(this.merge(this.erasermask,this.mask),e.clearRect(0,0,this.bounds.width(),this.bounds.height()),d.globalCompositeOperation="destination-out"):(d.fillStyle=this.settings.primarycolor.toString(),d.strokeStyle=this.settings.primarycolor.toString());switch(this.currentTool){case "rectangle":this.isShiftPressed()?d.strokeRect(f,g,
2*b(),2*c()):d.strokeRect(f,g,2*l,2*m);break;case "rectangleSolid":this.isShiftPressed()?d.fillRect(f,g,2*b(),2*c()):d.fillRect(f,g,2*l,2*m);break;case "brush":d.lineCap="round";d.lineJoin="round";d.beginPath();d.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]);for(e=0;e<this.brushBuffer.length;e+=1)d.lineTo(this.brushBuffer[e][0],this.brushBuffer[e][1]);d.stroke();break;case "line":d.beginPath();d.moveTo(f,g);this.isShiftPressed()?Math.abs(m)>Math.abs(l)?d.lineTo(f,k):d.lineTo(h,g):d.lineTo(h,
k);d.stroke();break;case "circle":case "circleSolid":d.beginPath();if(this.isShiftPressed())d.arc(f,g,(new Point(f,g)).distanceTo(new Point(h,k)),0,2*Math.PI,!1);else{for(e=0;e<n;e+=1)d.lineTo(e,2*m*Math.sqrt(2-Math.pow((e-f)/(2*l),2))+g);for(e=n;0<e;--e)d.lineTo(e,-2*m*Math.sqrt(2-Math.pow((e-f)/(2*l),2))+g)}d.closePath();"circleSolid"===this.currentTool?d.fill():"circle"===this.currentTool&&d.stroke();break;case "crosshairs":this.automaticCrosshairs=!1;this.rotationCenter=a.copy();this.drawcrosshair(d);
break;case "eraser":this.merge(this.paper,this.mask);d.save();d.globalCompositeOperation="destination-out";d.beginPath();d.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]);for(e=0;e<this.brushBuffer.length;e+=1)d.lineTo(this.brushBuffer[e][0],this.brushBuffer[e][1]);d.stroke();d.restore();this.paper=newCanvas(this.extent(),!0);this.merge(this.mask,this.paper);break;default:nop()}this.previousDragPoint=a;this.drawNew();d.restore();this.changed()}};
PaintCanvasMorph.prototype.mouseClickLeft=function(){"crosshairs"!==this.currentTool&&this.merge(this.mask,this.paper);this.brushBuffer=[]};PaintCanvasMorph.prototype.mouseLeaveDragging=PaintCanvasMorph.prototype.mouseClickLeft;
PaintCanvasMorph.prototype.buildContents=function(){this.background=newCanvas(this.extent(),!1,this.background);this.paper=newCanvas(this.extent(),!0,this.paper);this.mask=newCanvas(this.extent(),!0,this.mask);this.erasermask=newCanvas(this.extent(),!0,this.erasermask);var a,b,c=this.background.getContext("2d");for(a=0;a<this.background.width;a+=5)for(b=0;b<this.background.height;b+=5)c.fillStyle=1===(a+b)/5%2?"rgba(255, 255, 255, 1)":"rgba(255, 255, 255, 0.3)",c.fillRect(a,b,5,5)};
PaintCanvasMorph.prototype.drawNew=function(){var a=newCanvas(this.extent(),!0,this.cachedImage);this.merge(this.background,a);this.merge(this.paper,a);this.merge(this.mask,a);this.cachedImage=a;this.drawFrame()};PaintCanvasMorph.prototype.rerender=PaintCanvasMorph.prototype.drawNew;
PaintCanvasMorph.prototype.drawFrame=function(){var a=this.cachedImage.getContext("2d");if(this.parent){this.color=this.parent.color.lighter(.75*this.contrast);var b=this.parent.color}else b=new Color(120,120,120);a.fillStyle=this.color.toString();this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();this.drawRectBorder(a)};PaintCanvasMorph.prototype.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;
PaintCanvasMorph.prototype.edge=InputFieldMorph.prototype.edge;PaintCanvasMorph.prototype.fontSize=InputFieldMorph.prototype.fontSize;PaintCanvasMorph.prototype.typeInPadding=InputFieldMorph.prototype.typeInPadding;PaintCanvasMorph.prototype.contrast=InputFieldMorph.prototype.contrast;modules.cloud="2020-September-1";var SnapCloud=new Cloud(CLIENT_ID,SERVER_URL+"/api/");
function Cloud(a,b){this.clientId=a;this.password=this.username=this.roleId=null;this.url=b;this.api=this.route=this.limo=this.session=null}Cloud.prototype.clear=function(){this.api=this.route=this.limo=this.session=this.password=this.username=null};Cloud.prototype.hasProtocol=function(){return 0===this.url.toLowerCase().indexOf("http")};Cloud.prototype.setRoute=function(a){var b=0,c;for(c=0;c<a.length;c+=1)b+=a.charCodeAt(c);b=b%20+1;this.route=".sc1m"+(10>b?"0":"")+b};
Cloud.prototype.getPublicProject=function(a){var b=this,c,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){c=utils.defer();d=new XMLHttpRequest;try{d.open("GET",(b.hasProtocol()?"":"http://")+b.url+"RawPublic?"+a,!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.withCredentials=!0,d.onreadystatechange=function(){4===d.readyState&&(d.responseText?0===d.responseText.indexOf("ERROR")?c.reject(Error(d.responseText)):c.resolve(d.responseText):c.reject(Error(localize("could not connect to:")+
b.url)))},d.send(null)}catch(f){c.reject(f)}return e.return(c.promise)})};
Cloud.prototype.resetPassword=function(a,b,c){var d=new XMLHttpRequest,e=this;try{d.open("GET",(this.hasProtocol()?"":"http://")+this.url+"ResetPW?Username="+encodeURIComponent(a),!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.withCredentials=!0,d.onreadystatechange=function(){4===d.readyState&&(d.responseText?0===d.responseText.indexOf("ERROR")?c.call(this,d.responseText,"Reset Password"):b.call(null,d.responseText,"Reset Password"):c.call(null,e.url+"ResetPW",localize("could not connect to:")))},
d.send(null)}catch(f){c.call(this,f.toString(),"Snap!Cloud")}};
Cloud.prototype.login=function(a,b,c,d){var e=this,f=utils.defer(),g=new XMLHttpRequest;c=JSON.stringify({projectId:this.projectId,__h:b,__u:a,remember:c,clientId:SnapCloud.clientId});this.setRoute(a);try{var h=(this.hasProtocol()?"":"http://")+this.url+"?SESSIONGLUE="+this.route;d&&(h+="&strategy="+d);g.open("POST",h,!0);g.setRequestHeader("Content-Type","application/json; charset=utf-8");g.setRequestHeader("SESSIONGLUE",this.route);g.withCredentials=!0;g.onreadystatechange=function(){var k;return $jscomp.asyncExecutePromiseGeneratorProgram(function(l){if(1==
l.nextAddress)return 4!==g.readyState?l.jumpTo(0):200!==g.status?403===g.status?l.return(f.reject(Error(localize(g.responseText||"wrong username or password")))):l.return(f.reject(Error(localize("could not connect to cloud.")))):l.yield(e.getUserData(),4);k=l.yieldResult;e.username=k.username;e.credentials={username:a,password:b,strategy:d};return l.return(f.resolve(k))})};g.send(c)}catch(k){f.reject(k)}return f.promise};
Cloud.prototype.getProjectList=function(a,b){var c=this;this.reconnect(function(){c.callService("getProjectList",function(d,e){a.call(null,d,e);c.disconnect()},b)},b)};Cloud.prototype.getSharedProjectList=function(a,b){var c=this;this.reconnect(function(){c.callService("getSharedProjectList",function(d,e){a.call(null,d,e);c.disconnect()},b)},b)};
Cloud.prototype.changePassword=function(a,b,c,d){var e=this;this.reconnect(function(){e.callService("changePassword",function(f,g){c.call(null,f,g);e.disconnect()},d,[hex_sha512(a),hex_sha512(b)])},d)};
Cloud.prototype.callURL=function(a,b,c){var d=new XMLHttpRequest,e=this;try{var f=a+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo;d.open("GET",f,!0);d.withCredentials=!0;d.setRequestHeader("Content-Type","application/x-www-form-urlencoded");d.setRequestHeader("MioCracker",this.session);d.setRequestHeader("SESSIONGLUE",this.route);d.onreadystatechange=function(){if(4===d.readyState)if(d.responseText){var g=e.parseResponse(d);b.call(null,g,a)}else c.call(null,a,"no response from:")};d.send(null)}catch(g){c.call(this,
g.toString(),a)}};Cloud.prototype.supportsService=function(a){return!!this.api[a]};Cloud.prototype.parseAPI=function(a){var b={};a.split(" ").forEach(function(c){var d={},e;c.split("&").forEach(function(f){var g=f.split("=");f=decodeURIComponent(g[0]).toLowerCase();g=decodeURIComponent(g[1]);if("service"===f)b[g]=d;else if("parameters"===f){if(e=g.split(","),1!==e.length||e[0])d.parameters=e}else d[f]=g})});return b};
Cloud.prototype.parseResponse=function(a){var b=a.responseText;return-1<a.getResponseHeader("content-type").indexOf("application/json")?JSON.parse(b):-1<a.getResponseHeader("content-type").indexOf("xml")?b:this.parseSnapResponse(b)};Cloud.prototype.parseSnapResponse=function(a){var b=[];if(!a)return b;a.split(" ").forEach(function(c){var d={};c.split("&").forEach(function(e){var f=e.split("=");e=decodeURIComponent(f[0]);f=decodeURIComponent(f[1]);d[e]=f});b.push(d)});return b};
Cloud.prototype.parseDict=function(a){var b={};if(!a)return b;a.split("&").forEach(function(c){var d=c.split("=");c=decodeURIComponent(d[0]);d=decodeURIComponent(d[1]);b[c]=d});return b};Cloud.prototype.encodeDict=function(a){var b="",c;if(!a)return null;for(c in a)if(a.hasOwnProperty(c)){var d=encodeURIComponent(c)+"="+encodeURIComponent(a[c]);0<b.length&&(b+="&");b+=d}return b};
Cloud.prototype.getUserData=function(){var a=this,b,c,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){if(1==e.nextAddress)return b=(a.hasProtocol()?"":"http://")+a.url,c=new XMLHttpRequest,c.open("GET",b,!0),c.setRequestHeader("Content-Type","application/json; charset=utf-8"),c.withCredentials=!0,e.setCatchFinallyBlocks(2),e.yield(utils.requestPromise(c),4);if(2!=e.nextAddress)return e.return(JSON.parse(c.responseText));d=e.enterCatchBlock();console.warn("Unable to fetch user data:",
d);e.jumpToEnd()})};Cloud.prototype.addRole=function(a,b,c){var d=this;this.reconnect(function(){d.callService("addRole",b,c,[a,d.clientId,d.projectId])},c)};Cloud.prototype.renameRole=function(a,b,c,d){var e=this;this.reconnect(function(){e.callService("renameRole",c,d,[a,b,e.projectId])},d)};Cloud.prototype.cloneRole=function(a,b,c){var d=this;this.reconnect(function(){d.callService("cloneRole",b,c,[a,d.projectId])},c)};
Cloud.prototype.respondToInvitation=function(a,b,c,d){var e=this,f=[a,b,SnapCloud.clientId];this.reconnect(function(){e.callService("invitationResponse",function(g){g=g[0];b&&e.setLocalState(g.ProjectID,g.RoleID);c(g)},d,f)},function(g){e.ide.showMessage(g,2)})};Cloud.prototype.inviteGuest=function(a,b){var c=this;this.reconnect(function(){c.callService("inviteGuest",nop,nop,[SnapCloud.clientId,a,b,c.projectId])},nop)};
Cloud.prototype.inviteToCollaborate=function(){var a=this,b=Array.prototype.slice.call(arguments);this.reconnect(function(){a.callService("inviteToCollaborate",nop,nop,b.concat(a.projectId))},nop)};Cloud.prototype.joinActiveProject=function(a,b,c){var d=this;this.callService("joinActiveProject",function(e){e=e[0];d.setLocalState(e.ProjectID,e.RoleID);b(e)},c,[a])};
Cloud.prototype.evictCollaborator=function(a,b){var c=this;this.reconnect(function(){c.callService("evictCollaborator",nop,nop,[a,b||c.projectId])},nop)};Cloud.prototype.collabResponse=function(a,b,c,d){var e=this,f=[a,b,SnapCloud.clientId];this.reconnect(function(){e.callService("inviteCollaboratorResponse",c,d,f)},function(g){e.ide.showMessage(g,2)})};Cloud.prototype.getFriendList=function(a,b){var c=this;this.reconnect(function(){c.callService("getFriendList",function(d){a(d)},b)},b)};
Cloud.prototype.getProject=function(a,b,c,d){var e=this,f=[a];d&&f.push(d);this.reconnect(function(){e.callService("getProject",function(g){g=g[0];e.setLocalState(g.ProjectID,g.RoleID);b(g)},c,f)},c)};Cloud.prototype.getProjectByName=function(a,b,c,d){var e=this;this.reconnect(function(){e.callService("getProjectByName",function(f){f=f[0];e.setLocalState(f.ProjectID,f.RoleID);c(f)},d,[a,b])},d)};
Cloud.prototype.getCollaboratorList=function(a,b){var c=this;this.reconnect(function(){c.callService("getCollaborators",a,b,[c.projectId])},b)};Cloud.prototype.deleteRole=function(a,b,c){var d=this;this.reconnect(function(){d.callService("deleteRole",b,c,[a,d.projectId])},c)};Cloud.prototype.evictUser=function(a,b,c){var d=this;this.reconnect(function(){d.callService("evictUser",b,c,[a,d.projectId])},c)};
Cloud.prototype.saveProject=function(a,b,c,d,e){var f=this,g=a.sockets.getSerializedProject();f.reconnect(function(){f.callService("saveProject",function(h,k){f.setLocalState(h.projectId,h.roleId);b.call(null,h,k)},c,[f.roleId,a.projectName,e||a.room.name,SnapCloud.projectId,a.room.ownerId,!0===d,g.SourceCode,g.Media])},c)};
Cloud.prototype.callService=function(a,b,c,d){var e=new XMLHttpRequest,f=this.api[a],g=this;if(this.api)if(f){if(d&&0<d.length){var h={};f.parameters.forEach(function(l,m){void 0!==d[m]&&(h[l]=d[m])})}try{var k=this.url+"/"+f.url;e.open(f.method,k,!0);e.withCredentials=!0;e.setRequestHeader("Content-Type","application/x-www-form-urlencoded");e.onreadystatechange=function(){if(4===e.readyState){var l=e.responseText&&0===e.responseText.indexOf("ERROR");200>e.status||399<e.status||l?c.call(this,e.responseText,
localize("Service:")+" "+localize(a)):(l=g.parseResponse(e),b.call(null,l,f.url))}};e.send(this.encodeDict(h))}catch(l){c.call(this,l.toString(),f.url)}}else c.call(null,"service "+a+" is not available","API");else c.call(null,"You are not connected","Cloud")};Cloud.prototype.reconnect=function(a,b){if(this.username){var c=this.setClientState();a&&b&&(c=c.then(a).catch(b));return c}this.message("You are not logged in")};Cloud.prototype.disconnect=nop;
Cloud.prototype.logout=function(a,b){var c=this;this.reconnect(function(){c.callService("logout",a,b,[c.clientId]);c.clear()},b)};
Cloud.prototype.signup=function(a,b,c,d){var e=new XMLHttpRequest,f=this;a="Username="+encodeURIComponent(a)+"&Email="+encodeURIComponent(b);try{e.open("POST",(this.hasProtocol()?"":"http://")+this.url+"SignUp",!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.withCredentials=!0,e.onreadystatechange=function(){4===e.readyState&&(e.responseText?0===e.responseText.indexOf("ERROR")?d.call(this,e.responseText,"Signup"):c.call(null,e.responseText,"Signup"):d.call(null,f.url+
"SignUp",localize("could not connect to:")))},e.send(a)}catch(g){d.call(this,g.toString(),"NetsBlox Cloud")}};Cloud.prototype.isProjectActive=function(a,b,c){var d=this;this.reconnect(function(){d.callService("isProjectActive",function(e){return b(e.active)},c,[d.clientId,a])},c)};Cloud.prototype.hasConflictingStoredProject=function(a,b,c){var d=this;this.reconnect(function(){d.callService("hasConflictingStoredProject",function(e){return b("true"===e[0].hasConflicting)},c,[d.projectId,a])},c)};
Cloud.prototype.saveProjectCopy=function(a,b){var c=this;this.reconnect(function(){c.callService("saveProjectCopy",function(d,e){c.setLocalState(d.projectId,c.roleId);a.call(null,d,e);c.disconnect()},b,[c.clientId,c.projectId])},b)};
Cloud.prototype.request=function(a,b){var c,d,e=new Promise(function(g,h){c=g;d=h});b=JSON.stringify(b);a=SERVER_URL+a;var f=new XMLHttpRequest;f.open("POST",a,!0);f.setRequestHeader("Content-Type","application/json");f.withCredentials=!0;f.onreadystatechange=function(){if(4===f.readyState){if(299<f.status||200>f.status||f.responseText&&0===f.responseText.indexOf("ERROR"))return d(f);c(JSON.parse(f.responseText))}};f.send(b);return e};
Cloud.prototype.setLocalState=function(a,b){this.projectId=a;this.roleId=b};Cloud.prototype.resetLocalState=function(){var a=this.clientId+"-"+Date.now();this.setLocalState("tmp-project-id-"+a,"tmp-role-id-"+a)};
Cloud.prototype.newProject=function(a){var b=this;a={clientId:SnapCloud.clientId,name:a||""};this.newProjectRequest||(this.newProjectRequest=this.request("/api/newProject",a).then(function(c){b.setLocalState(c.projectId,c.roleId);b.newProjectRequest=null;return c}).catch(function(c){b.resetLocalState();b.newProjectRequest=null;throw Error(c.responseText);}));return this.newProjectRequest};
Cloud.prototype.getClientState=function(){return{username:this.username,clientId:this.clientId,projectId:this.projectId,roleId:this.roleId}};
Cloud.prototype.setClientState=function(a,b,c){var d=this;return(this.newProjectRequest||Promise.resolve()).then(function(){return d.request("/api/setClientState",{__u:d.username,__h:d.password,clientId:d.clientId,socketId:d.clientId,projectId:d.projectId,roleId:d.roleId,roomName:a,roleName:b,actionId:c})}).then(function(e){d.setLocalState(e.projectId,e.roleId);d.api||(d.api=e.api);return e}).catch(function(e){var f="Could not connect to "+d.url;throw Error(e.responseText||f);})};
Cloud.prototype.setProjectName=function(a){var b=this;return(this.newProjectRequest||Promise.resolve()).then(function(){return b.request("/api/setProjectName",{projectId:b.projectId,name:a})}).then(function(c){return c}).catch(function(c){var d="Could not connect to "+b.url;throw Error(c.responseText||d);})};
Cloud.prototype.importProject=function(a,b,c){var d=this;return this.request("/api/importProject",{projectId:this.projectId,clientId:this.clientId,name:a,role:b,roles:c}).then(function(e){d.setLocalState(e.projectId,e.roleId);return e.state}).catch(function(e){d.resetLocalState();throw Error(e.responseText);})};Cloud.prototype.getEntireProject=function(a,b,c){var d=this;this.reconnect(function(){d.callService("getEntireProject",function(e){b(e);d.disconnect()},c,[a])},c)};
Cloud.prototype.linkAccount=function(a,b,c){var d=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){return e.yield(d.request("/api/linkAccount/"+c,{username:a,password:b}),0)})};Cloud.prototype.unlinkAccount=function(a){var b=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){return c.yield(b.request("/api/unlinkAccount",a),0)})};
Cloud.prototype.exportProject=function(a){a=void 0===a?this.projectId:a;var b;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){return 1==c.nextAddress?c.yield(fetch("/api/v2/projects/"+a+"/latest"),2):3!=c.nextAddress?(b=c.yieldResult,c.yield(b.text(),3)):c.return(c.yieldResult)})};
Cloud.prototype.exportRole=function(a,b){a=void 0===a?this.projectId:a;b=void 0===b?this.roleId:b;var c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){return 1==d.nextAddress?d.yield(fetch("/api/v2/projects/"+a+"/"+b+"/latest"),2):3!=d.nextAddress?(c=d.yieldResult,d.yield(c.text(),3)):d.return(d.yieldResult)})};Cloud.prototype.message=function(a){alert(a)};var CloudError=function(a,b){b=Error.call(this,b);this.message=b.message;"stack"in b&&(this.stack=b.stack);this.label=a};
$jscomp.inherits(CloudError,Error);modules.gui="2020-August-08";var SERVER_URL=SERVER_URL||window.location.origin,SERVER_ADDRESS=SERVER_URL.replace(/^.*\/\//,"");function ensureFullUrl(a){null===a.match(/^\w+:\/\//)&&(a="/"===a.substring(0,1)[0]?SERVER_URL+a:SERVER_URL+"/"+a);return a}IDE_Morph.prototype=new Morph;IDE_Morph.prototype.constructor=IDE_Morph;IDE_Morph.uber=Morph.prototype;
IDE_Morph.prototype.setDefaultDesign=function(){MorphicPreferences.isFlat=!1;SpriteMorph.prototype.paletteColor=new Color(30,30,30);SpriteMorph.prototype.paletteTextColor=new Color(230,230,230);StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor;StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor;SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30);IDE_Morph.prototype.buttonContrast=30;IDE_Morph.prototype.backgroundColor=new Color(10,
10,10);IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor;IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(5);IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;IDE_Morph.prototype.buttonLabelColor=WHITE;IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.darker(50),IDE_Morph.prototype.groupColor.darker(25),IDE_Morph.prototype.groupColor];IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors;IDE_Morph.prototype.appModeColor=
BLACK;IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture();IDE_Morph.prototype.padding=1;SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SyntaxElementMorph.prototype.contrast=65;ScriptsMorph.prototype.feedbackColor=WHITE};
IDE_Morph.prototype.setFlatDesign=function(){MorphicPreferences.isFlat=!0;SpriteMorph.prototype.paletteColor=WHITE;SpriteMorph.prototype.paletteTextColor=new Color(70,70,70);StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor;StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor;SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor;IDE_Morph.prototype.buttonContrast=30;IDE_Morph.prototype.backgroundColor=new Color(220,220,230);IDE_Morph.prototype.frameColor=
new Color(240,240,245);IDE_Morph.prototype.groupColor=WHITE;IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;IDE_Morph.prototype.buttonLabelColor=new Color(70,70,70);IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor.lighter(50),IDE_Morph.prototype.groupColor];IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors;IDE_Morph.prototype.appModeColor=IDE_Morph.prototype.frameColor;IDE_Morph.prototype.scriptsPaneTexture=null;IDE_Morph.prototype.padding=
1;SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SyntaxElementMorph.prototype.contrast=25;ScriptsMorph.prototype.feedbackColor=new Color(153,255,213)};
IDE_Morph.prototype.scriptsTexture=function(){var a=newCanvas(new Point(100,100)),b=a.getContext("2d"),c;for(c=0;100>c;c+=4)b.fillStyle=this.frameColor.toString(),b.fillRect(c,0,1,100),b.fillStyle=this.groupColor.lighter(2).toString(),b.fillRect(c+1,0,1,100),b.fillRect(c+3,0,1,100),b.fillStyle=this.groupColor.darker(2).toString(),b.fillRect(c+2,0,1,100);return a};IDE_Morph.prototype.setDefaultDesign();function IDE_Morph(a){this.init(a)}
IDE_Morph.prototype.init=function(a){MorphicPreferences.globalFontFamily="Helvetica, Arial";this.userLanguage=null;this.projectsInURLs=!1;this.allowMsgsWhileCollaborating=null;this.applySavedSettings();this.cloud=SnapCloud;this.cloudMsg=null;this.source="local";this.serializer=new SnapSerializer;this.globalVariables=new VariableFrame;this.currentSprite=new SpriteMorph(this.globalVariables);this.sprites=new List([this.currentSprite]);this.currentCategory="motion";this.currentTab="scripts";this.projectNotes=
this.projectName="";this.embedOverlay=this.embedPlayButton=this.corral=this.corralBar=this.stageHandle=this.stage=this.spriteEditor=this.spriteBar=this.paletteHandle=this.palette=this.categories=this.controlBar=this.logo=null;this.isEmbedMode=!1;this.isAutoFill=void 0===a?!0:a;this.isReplayMode=this.isAppMode=!1;this.preReplayUndoState=null;this.isSmallStage=!1;this.filePicker=null;this.hasChangedMedia=!1;this.isAnimating=!0;this.paletteWidth=200;this.stageRatio=1;this.loadNewProject=this.wasSingleStepping=
!1;this.shield=null;this.savingPreferences=!0;IDE_Morph.uber.init.call(this);this.color=this.backgroundColor;this.activeEditor=this;this.extensions=NetsBloxExtensions};
IDE_Morph.prototype.openIn=function(a){var b;this.projectName="myRole";localStorage&&(b=localStorage["-snap-user"])&&(b=SnapCloud.parseSnapResponse(b)[0])&&(SnapCloud.username=b.username||null,SnapCloud.password=b.password||null,SnapCloud.username&&(this.source="cloud"));this.buildPanes();SnapActions.configure(this);SnapActions.disableCollaboration();SnapUndo.reset();a.add(this);a.userMenu=this.userMenu;this.cloud.message=function(c){var d=new MenuMorph(null,c);d.popUpCenteredInWorld(a);var e=setInterval(function(){d.destroy();
clearInterval(e)},2E3)};a.reactToDropOf=function(c){c instanceof DialogBoxMorph||c instanceof MenuMorph||(a.hand.grabOrigin?c.slideBackTo(a.hand.grabOrigin):a.hand.grab(c))};this.reactToWorldResize(a.bounds);if(this.userLanguage)this.loadNewProject=!0,this.setLanguage(this.userLanguage,this.onOpen);else this.onOpen();this.extensions.initialize(this);this.initializeEmbeddedAPI();window.dispatchEvent(new CustomEvent("ideLoaded"))};
IDE_Morph.prototype.onOpen=function(){var a=this,b=this.sockets.onConnect,c=!1;if(-1<location.href.indexOf("?")||location.hash){var d=new MenuMorph(null,"Loading...");d.popUpCenteredInWorld(this.world());this.sockets.onConnect=function(){d.destroy();c=!0;a.sockets.onConnect=b;a.interpretUrlAnchors();a.sockets.onConnect()};setTimeout(function(){c||(d.destroy(),a.interpretUrlAnchors())},750)}else this.interpretUrlAnchors()};
IDE_Morph.prototype.interpretUrlAnchors=function(a){function b(z){try{return utils.getUrlSync(z)}catch(F){return e.showMessage("unable to retrieve project"),""}}function c(z){z.embedMode&&e.setEmbedMode();z.editMode?e.toggleAppMode(!1):e.toggleAppMode(!0);z.noRun||e.runScripts();z.hideControls&&(e.controlBar.hide(),window.onbeforeunload=nop);z.noExitWarning&&(window.onbeforeunload=nop);z.lang&&e.setLanguage(z.lang,null,!0);e.isEmbedMode||e.world().worldCanvas.focus()}var d=this,e,f,g,h,k,l,m,n,q,
p,t,r,u,v,w,x,y,B,A,C,E,I,J,K,D,G,O,P;return $jscomp.asyncExecutePromiseGeneratorProgram(function(z){switch(z.nextAddress){case 1:e=d;a=a||location;h={};-1<a.href.indexOf("?")&&(l=a.href.replace(/^.*\?/,"").replace("#"+a.hash,""),h=SnapCloud.parseDict(l));if("#open:"===a.hash.substr(0,6)){g=a.hash.substr(6);if("%"===g.charAt(0)||-1<g.search(/%(?:[0-9a-f]{2})/i))g=decodeURIComponent(g);return contains(["project","blocks","sprites","snapdata"].map(function(F){return g.substr(0,8).indexOf(F)}),1)?z.yield(d.droppedText(g),
3):z.yield(d.droppedText(b(g)),3)}if("#run:"===a.hash.substr(0,5)){g=a.hash.substr(5);k=g.indexOf("&");0<k&&(g=g.slice(0,k));if("%"===g.charAt(0)||-1<g.search(/%(?:[0-9a-f]{2})/i))g=decodeURIComponent(g);return"<project>"===g.substr(0,8)?z.yield(SnapActions.openProject(g),38):z.yield(SnapActions.openProject(b(g)),38)}if("#present:"===a.hash.substr(0,9)||"present"===h.action)return d.shield=new Morph,d.shield.color=d.color,d.shield.setExtent(d.parent.extent()),d.parent.add(d.shield),e.showMessage("Fetching project\nfrom the cloud..."),
"#present:"===a.hash.substr(0,9)&&(h=SnapCloud.parseDict(a.hash.substr(9))),z.setCatchFinallyBlocks(33),z.yield(SnapCloud.getPublicProject(SnapCloud.encodeDict(h)),35);if("#cloud:"===a.hash.substr(0,7))return d.shield=new Morph,d.shield.alpha=0,d.shield.setExtent(d.parent.extent()),d.parent.add(d.shield),e.showMessage("Fetching project\nfrom the cloud..."),h=SnapCloud.parseDict(a.hash.substr(7)),h.Username=h.Username.toLowerCase(),z.setCatchFinallyBlocks(29),z.yield(SnapCloud.getPublicProject(SnapCloud.encodeDict(h)),
31);if("#dl:"===a.hash.substr(0,4))return e.showMessage("Fetching project\nfrom the cloud..."),h=SnapCloud.parseDict(a.hash.substr(4)),h.Username=h.Username.toLowerCase(),z.setCatchFinallyBlocks(26),z.yield(SnapCloud.getPublicProject(SnapCloud.encodeDict(h)),28);if("#lang:"===a.hash.substr(0,6)){f=a.hash.substr(6);d.setLanguage(f);d.loadNewProject=!0;z.jumpTo(3);break}if("#signup"===a.hash.substr(0,7)){d.createCloudAccount();z.jumpTo(3);break}if("#collaborate"===a.hash.substr(0,12)){m=a.hash.substr(13);
SnapActions.enableCollaboration();SnapActions.joinSession(m,d.cloudError());z.jumpTo(3);break}if("#example:"===a.hash.substr(0,9)||"example"===h.action)return u=h?h.ProjectName:a.hash.substr(9),d.shield=new Morph,d.shield.alpha=0,d.shield.setExtent(d.parent.extent()),d.parent.add(d.shield),v=d.getURL(e.resourceURL("Examples",u)),w=e.showMessage("Opening "+u+" example..."),z.yield(d.droppedText(v),25);if("#private:"===a.hash.substr(0,9)||"private"===h.action){n=h?h.ProjectName:a.hash.substr(9);q=null!==
SnapCloud.username;if(!q)return e.showMessage("You are not logged in. Cannot open "+n),z.return();p=e.showMessage("Opening "+n+" example...");z.setCatchFinallyBlocks(21);return z.yield(SnapCloud.getProjectByName(SnapCloud.username,h.ProjectName),23)}if("#signup"===a.hash.substr(0,7)||"signup"===h.action){d.createCloudAccount();z.jumpTo(3);break}return z.yield(e.newProject(),3);case 23:return t=z.yieldResult,z.yield(e.rawLoadCloudProject(t),24);case 24:c(h);z.leaveTryBlock(22);break;case 21:r=z.enterCatchBlock(),
d.cloudError()(r.message);case 22:p.destroy();z.jumpTo(3);break;case 25:e.hasChangedMedia=!0;d.shield.destroy();d.shield=null;w.destroy();c(h);z.jumpTo(3);break;case 28:x=z.yieldResult;window.open("data:text/xml,"+x);z.leaveTryBlock(3);break;case 26:y=z.enterCatchBlock();d.cloudError()(y.message);z.jumpTo(3);break;case 31:return B=z.yieldResult,A=d.showMessage(localize("Opening project...")),z.yield(SnapActions.openProject(B),32);case 32:d.hasChangedMedia=!0;d.shield.destroy();d.shield=null;A.destroy();
d.toggleAppMode(!1);z.leaveTryBlock(3);break;case 29:C=z.enterCatchBlock();d.cloudError()(C.message);z.jumpTo(3);break;case 35:return E=z.yieldResult,I=e.showMessage("Opening project..."),z.yield(e.droppedText(E),36);case 36:e.hasChangedMedia=!0;e.shield.destroy();e.shield=null;I.destroy();c(h);z.leaveTryBlock(3);break;case 33:J=z.enterCatchBlock();d.cloudError()(J.message);z.jumpTo(3);break;case 38:d.toggleAppMode(!0);d.runScripts();z.jumpTo(3);break;case 3:d.world().keyboardFocus=d.stage;d.warnAboutIE();
if(h.extensions)try{K=JSON.parse(decodeURIComponent(h.extensions)),K.forEach(function(F){return d.loadExtension(F)})}catch(F){d.inform("Unable to load extensions","The following error occurred while trying to load extensions:\n\n"+F.message+"\n\nPerhaps the URL is malformed?")}if(h.setVariable)if(D=$jscomp.makeIterator(h.setVariable.split("=")),G=D.next().value,O=D.next().value,P=d.globalVariables.allNames().includes(G))d.globalVariables.setVar(G,O),z.jumpTo(0);else return z.yield(d.droppedText(O,
G,"text"),0);else z.jumpTo(0)}})};IDE_Morph.prototype.buildPanes=function(){this.createLogo();this.createControlBar();this.createCategories();this.createPalette();this.createStage();this.createSpriteBar();this.createSpriteEditor();this.createCorralBar();this.createCorral();this.createReplayControls()};
IDE_Morph.prototype.createLogo=function(){var a=this;this.logo&&this.logo.destroy();this.logo=new Morph;this.logo.texture=LOGO_IMAGE;this.logo.render=function(b){var c=b.createLinearGradient(0,0,this.width(),0);c.addColorStop(0,"black");c.addColorStop(.5,a.frameColor.toString());b.fillStyle=MorphicPreferences.isFlat?a.frameColor.toString():c;b.fillRect(0,0,this.width(),this.height());this.cachedTexture?this.renderCachedTexture(b):this.texture&&this.renderTexture(this.texture,b)};this.logo.renderCachedTexture=
function(b){b.drawImage(this.cachedTexture,5,Math.round((this.height()-this.cachedTexture.height)/2));this.changed()};this.logo.mouseClickLeft=function(){a.snapMenu()};this.logo.color=BLACK;this.logo.setExtent(new Point(200,28));this.add(this.logo)};IDE_Morph.prototype.mouseClickLeft=function(){this.setActiveEditor()};IDE_Morph.prototype.setActiveEditor=function(a){this.activeEditor!==a&&(this.activeEditor.onUnsetActive(),this.activeEditor=a||this,this.activeEditor.onSetActive())};
IDE_Morph.prototype.onSetActive=function(){this.isAppMode?this.spriteEditor.hide():"scripts"===this.currentTab?this.currentSprite.scripts.updateToolbar():this.spriteEditor.updateToolbar&&this.spriteEditor.updateToolbar()};IDE_Morph.prototype.onUnsetActive=function(){"scripts"===this.currentTab?this.currentSprite.scripts.hideToolbar():this.spriteEditor.hideToolbar&&this.spriteEditor.hideToolbar()};
IDE_Morph.prototype.getActiveScripts=function(){return this.activeEditor instanceof BlockEditorMorph?this.activeEditor.body.contents:this.currentSprite.scripts};IDE_Morph.prototype.getActiveEntity=function(){return this.activeEditor instanceof BlockEditorMorph?this.activeEditor.definition.id+"/scripts":this.currentSprite.id+"/"+this.currentTab};
IDE_Morph.prototype.createControlBar=function(){var a=this,b,c=MorphicPreferences.isFlat?this.tabColors:[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)],d=this;this.controlBar&&this.controlBar.destroy();this.controlBar=new Morph;this.controlBar.color=this.frameColor;this.controlBar.setHeight(this.logo.height());this.controlBar.mouseClickLeft=function(){this.world().fillPage()};this.add(this.controlBar);var e=new ToggleButtonMorph(null,this,"toggleStageSize",[new SymbolMorph("smallStage",
14),new SymbolMorph("normalStage",14)],function(){return a.isSmallStage});e.hasNeutralBackground=!0;e.corner=12;e.color=c[0];e.highlightColor=c[1];e.pressColor=c[0];e.labelMinExtent=new Point(36,18);e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=MorphicPreferences.isFlat?WHITE:this.buttonLabelColor;e.contrast=this.buttonContrast;e.fixLayout();e.refresh();var f=e;this.controlBar.add(f);this.controlBar.stageSizeButton=e;e=new ToggleButtonMorph(null,this,"toggleAppMode",
[new SymbolMorph("fullScreen",14),new SymbolMorph("normalScreen",14)],function(){return a.isAppMode});e.hasNeutralBackground=!0;e.corner=12;e.color=c[0];e.highlightColor=c[1];e.pressColor=c[0];e.labelMinExtent=new Point(36,18);e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=this.buttonLabelColor;e.contrast=this.buttonContrast;e.fixLayout();e.refresh();var g=e;this.controlBar.add(g);this.controlBar.appModeButton=g;e=new ToggleButtonMorph(null,this,"toggleSingleStepping",
[new SymbolMorph("footprints",16),new SymbolMorph("footprints",16)],function(){return Process.prototype.enableSingleStepping});e.corner=12;e.color=c[0];e.highlightColor=c[1];e.pressColor=new Color(153,255,213);e.labelMinExtent=new Point(36,18);e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=this.buttonLabelColor;e.contrast=this.buttonContrast;e.hint="Visible stepping";e.fixLayout();e.refresh();var h=e;this.controlBar.add(h);this.controlBar.steppingButton=h;e=
new ToggleButtonMorph(null,this,"stopAllScripts",[new SymbolMorph("octagon",14),new SymbolMorph("square",14)],function(){return a.stage?d.stage.enableCustomHatBlocks&&d.stage.threads.pauseCustomHatBlocks:!0});e.corner=12;e.color=c[0];e.highlightColor=c[1];e.pressColor=c[2];e.labelMinExtent=new Point(36,18);e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=new Color(MorphicPreferences.isFlat?128:200,0,0);e.contrast=this.buttonContrast;e.fixLayout();e.refresh();var k=
e;this.controlBar.add(k);this.controlBar.stopButton=k;e=new ToggleButtonMorph(null,this,"togglePauseResume",[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)],function(){return a.isPaused()});e.hasNeutralBackground=!0;e.corner=12;e.color=c[0];e.highlightColor=c[1];e.pressColor=c[0];e.labelMinExtent=new Point(36,18);e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=MorphicPreferences.isFlat?new Color(220,185,0):new Color(255,220,0);e.contrast=this.buttonContrast;
e.fixLayout();e.refresh();var l=e;this.controlBar.add(l);this.controlBar.pauseButton=l;e=new PushButtonMorph(this,"pressStart",new SymbolMorph("flag",14));e.corner=12;e.color=c[0];e.highlightColor=c[1];e.pressColor=c[2];e.labelMinExtent=new Point(36,18);e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=new Color(0,MorphicPreferences.isFlat?100:200,0);e.contrast=this.buttonContrast;e.fixLayout();var m=e;this.controlBar.add(m);this.controlBar.startButton=m;var n=
new SliderMorph(61,1,100*Process.prototype.flashTime+1,6,"horizontal");n.action=function(u){Process.prototype.flashTime=(u-1)/100;a.controlBar.refreshResumeSymbol()};n.color=new Color(153,255,213);n.alpha=.3;n.setExtent(new Point(50,14));this.controlBar.add(n);this.controlBar.steppingSlider=n;e=new PushButtonMorph(this,function(){var u=d.projectMenu(),v=d.controlBar.projectButton.bottomLeft(),w=d.world();u.popup(w,v)},new SymbolMorph("file",14));e.corner=12;e.color=c[0];e.highlightColor=c[1];e.pressColor=
c[2];e.labelMinExtent=new Point(36,18);e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=this.buttonLabelColor;e.contrast=this.buttonContrast;e.fixLayout();var q=e;this.controlBar.add(q);this.controlBar.projectButton=q;e=new PushButtonMorph(this,function(){var u=d.settingsMenu(),v=d.controlBar.settingsButton.bottomLeft();u.popup(d.world(),v)},new SymbolMorph("gears",14));e.corner=12;e.color=c[0];e.highlightColor=c[1];e.pressColor=c[2];e.labelMinExtent=new Point(36,
18);e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=this.buttonLabelColor;e.contrast=this.buttonContrast;e.fixLayout();var p=e;this.controlBar.add(p);this.controlBar.settingsButton=p;e=new PushButtonMorph(this,function(){var u=d.extensionsMenu(),v=d.controlBar.extensionsButton.bottomLeft();u.popup(d.world(),v)},new SymbolMorph("puzzlePiece",14));e.corner=12;e.color=c[0];e.highlightColor=c[1];e.pressColor=c[2];e.labelMinExtent=new Point(36,18);e.padding=0;e.labelShadowOffset=
new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=this.buttonLabelColor;e.contrast=this.buttonContrast;e.fixLayout();var t=e;this.controlBar.add(t);this.controlBar.extensionsButton=t;this.controlBar.extensionsButton.hide();e=new ToggleButtonMorph(null,this,function(){var u,v;return $jscomp.asyncExecutePromiseGeneratorProgram(function(w){if(1==w.nextAddress)return w.yield(a.cloudMenu(),2);u=w.yieldResult;v=a.controlBar.cloudButton.bottomLeft();u.popup(a.world(),v);w.jumpToEnd()})},[new SymbolMorph("cloudOutline",
11),new SymbolMorph("cloud",11)],function(){return!isNil(a.cloud.username)});e.hasNeutralBackground=!0;e.corner=12;e.color=c[0];e.highlightColor=c[1];e.pressColor=c[0];e.labelMinExtent=new Point(36,18);e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=this.buttonLabelColor;e.contrast=this.buttonContrast;e.fixLayout();var r=e;this.controlBar.add(r);this.controlBar.cloudButton=r;this.controlBar.fixLayout=function(){b=this.right()-5;[k,l,m].forEach(function(u){u.setCenter(d.controlBar.center());
u.setRight(b);b-=u.width();b-=5});b=Math.min(m.left()-(15+2*f.width()),d.right()-StageMorph.prototype.dimensions.x*(d.isSmallStage?d.stageRatio:1));[f,g].forEach(function(u){b+=5;u.setCenter(d.controlBar.center());u.setLeft(b);b+=u.width()});n.setCenter(d.controlBar.center());n.setRight(f.left()-5);h.setCenter(d.controlBar.center());h.setRight(n.left()-5);t.setCenter(d.controlBar.center());t.setRight(h.left()-5);p.setCenter(d.controlBar.center());p.setLeft(this.left());r.setCenter(d.controlBar.center());
r.setRight(p.left()-5);q.setCenter(d.controlBar.center());q.setRight(r.left()-5);this.refreshSlider();this.updateLabel()};this.controlBar.refreshSlider=function(){Process.prototype.enableSingleStepping&&!d.isAppMode?(n.fixLayout(),n.rerender(),n.show()):n.hide();this.refreshResumeSymbol()};this.controlBar.refreshResumeSymbol=function(){if(Process.prototype.enableSingleStepping&&.5<Process.prototype.flashTime){d.stage.threads.pauseAll(d.stage);var u=[new SymbolMorph("pause",12),new SymbolMorph("stepForward",
14)]}else u=[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)];l.labelString=u;l.createLabel();l.fixLayout();l.refresh()};this.controlBar.updateLabel=function(){var u=d.world().isDevMode?" - "+localize("development mode"):"";this.label&&this.label.destroy();d.isAppMode||(u=new StringMorph((d.projectName||localize("untitled"))+u,14,"sans-serif",!0,!1,!1,MorphicPreferences.isFlat?null:new Point(2,1),d.frameColor.darker(d.buttonContrast)),u.color=d.buttonLabelColor,this.label=new FrameMorph,
this.label.acceptsDrops=!1,this.label.alpha=0,u.setPosition(this.label.position()),this.label.add(u),this.label.setExtent(new Point(h.left()-p.right()-10,u.height())),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+5),this.add(this.label))}};
IDE_Morph.prototype.createCategories=function(){function a(c){var d=[b.frameColor,b.frameColor.darker(MorphicPreferences.isFlat?5:50),SpriteMorph.prototype.blockColor[c]];var e=new ToggleButtonMorph(d,b,function(){b.currentCategory=c;b.categories.children.forEach(function(f){return f.refresh()});b.refreshPalette(!0)},c[0].toUpperCase().concat(c.slice(1)),function(){return b.currentCategory===c},null,null,75,!0);e.corner=8;e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=d[1];e.labelColor=
b.buttonLabelColor;MorphicPreferences.isFlat&&(e.labelPressColor=WHITE);e.fixLayout();e.refresh();b.categories.add(e);return e}var b=this;this.categories&&this.categories.destroy();this.categories=new Morph;this.categories.color=this.groupColor;this.categories.bounds.setWidth(this.paletteWidth);SpriteMorph.prototype.categories.forEach(function(c){contains(["lists","other"],c)||a(c)});(function(){var c=b.categories.children[0].width(),d=b.categories.children[0].height(),e=Math.ceil(b.categories.children.length/
2),f=(197-2*c)/3,g=b.categories.left(),h=b.categories.top(),k=0,l,m;b.categories.children.forEach(function(n){k+=1;l=Math.ceil(k/2);m=2-k%2;n.setPosition(new Point(g+(m*f+(m-1)*c),h+(2*l+(l-1)*d+3)))});b.categories.setHeight(2*(e+1)+e*d+6)})();this.add(this.categories)};
IDE_Morph.prototype.createPalette=function(a){var b=this;this.palette&&this.palette.destroy();this.palette=a?new ScrollFrameMorph(null,null,this.currentSprite.sliderColor):this.currentSprite.palette(this.currentCategory);this.palette.isDraggable=!1;this.palette.acceptsDrops=!0;this.palette.enableAutoScrolling=!1;this.palette.contents.acceptsDrops=!1;this.palette.reactToDropOf=function(c,d){c instanceof DialogBoxMorph?b.world().add(c):c instanceof SpriteMorph?SnapActions.removeSprite(c):c instanceof
SpriteIconMorph?(c.destroy(),SnapActions.removeSprite(c.object)):c instanceof CostumeIconMorph?(SnapActions.removeCostume(c.object),c.perish()):c instanceof SoundIconMorph?(SnapActions.removeSound(c.object),c.destroy()):c instanceof BlockMorph&&(b.stage.threads.stopAllForBlock(c),c.id&&SnapActions.removeBlock(c),c.perish())};this.palette.contents.reactToDropOf=function(c){c instanceof BlockMorph&&c.destroy()};this.palette.setWidth(this.logo.width());this.add(this.palette);this.isAppMode&&this.palette.hide();
return this.palette};IDE_Morph.prototype.createPaletteHandle=function(){this.paletteHandle&&this.paletteHandle.destroy();this.paletteHandle=new PaletteHandleMorph(this.categories);this.add(this.paletteHandle);this.isAppMode&&this.paletteHandle.hide()};
IDE_Morph.prototype.createStage=function(){this.stage&&this.stage.destroy();StageMorph.prototype.frameRate=0;this.stage=new StageMorph(this.globalVariables);this.stage.setExtent(this.stage.dimensions);this.currentSprite instanceof SpriteMorph&&(this.currentSprite.setPosition(this.stage.center().subtract(this.currentSprite.extent().divideBy(2))),this.stage.add(this.currentSprite));this.add(this.stage)};
IDE_Morph.prototype.createStageHandle=function(){this.stageHandle&&this.stageHandle.destroy();this.stageHandle=new StageHandleMorph(this.stage);this.add(this.stageHandle)};
IDE_Morph.prototype.createSpriteBar=function(){function a(q){var p=k.rotationStyleColors;var t=new ToggleButtonMorph(p,k,function(){k.currentSprite instanceof SpriteMorph&&SnapActions.setRotationStyle(k.currentSprite,q)},g[q],function(){return k.currentSprite instanceof SpriteMorph&&k.currentSprite.rotationStyle===q},null,localize(h[q]));t.corner=8;t.labelMinExtent=new Point(11,11);t.padding=0;t.labelShadowOffset=new Point(-1,-1);t.labelShadowColor=p[1];t.labelColor=k.buttonLabelColor;t.fixLayout();
t.refresh();c.push(t);t.setPosition(k.spriteBar.position().add(new Point(2,4)));t.setTop(t.top()+(c.length-1)*(t.height()+2));k.spriteBar.add(t);k.currentSprite instanceof StageMorph&&t.hide();return t}var b=this,c=[],d=new Point(45,45),e=this.tabColors,f=new AlignmentMorph("row",-30),g=[new SymbolMorph("arrowRightThin",10),new SymbolMorph("turnAround",10),new SymbolMorph("arrowLeftRightThin",10)],h=["don't rotate","can rotate","only face left/right"],k=this;this.spriteBar&&this.spriteBar.destroy();
this.spriteBar=new Morph;this.spriteBar.color=this.frameColor;this.add(this.spriteBar);a(1);a(2);a(0);this.rotationStyleButtons=c;var l=new Morph;l.isCachingImage=!0;l.bounds.setExtent(d);l.cachedImage=this.currentSprite.thumbnail(d);l.setPosition(c[0].topRight().add(new Point(5,3)));this.spriteBar.add(l);l.fps=3;l.step=function(){l.version!==k.currentSprite.version&&(l.cachedImage=k.currentSprite.thumbnail(d,l.cachedImage),l.changed(),l.version=k.currentSprite.version)};var m=new InputFieldMorph(this.currentSprite.name);
m.setWidth(100);m.contrast=90;m.setPosition(l.topRight().add(new Point(10,3)));this.spriteBar.add(m);this.spriteBar.nameField=m;m.fixLayout();m.accept=function(){var q=m.getValue(),p=k.currentSprite.name;q=k.newSpriteName(q,k.currentSprite);if(q!==p)return SnapActions.renameSprite(k.currentSprite,q);m.setContents(q)};this.spriteBar.nameField=m;this.spriteBar.reactToEdit=m.accept;var n=new ToggleMorph("checkbox",null,function(){return SnapActions.toggleDraggable(k.currentSprite,!k.currentSprite.isDraggable)},
localize("draggable"),function(){return b.currentSprite.isDraggable});n.label.isBold=!1;n.label.setColor(this.buttonLabelColor);n.color=e[2];n.highlightColor=e[0];n.pressColor=e[1];n.tick.shadowOffset=MorphicPreferences.isFlat?ZERO:new Point(-1,-1);n.tick.shadowColor=BLACK;n.tick.color=this.buttonLabelColor;n.tick.isBold=!1;n.tick.fixLayout();n.setPosition(m.bottomLeft().add(2));n.fixLayout();this.spriteBar.add(n);this.spriteBar.padlock=n;this.currentSprite instanceof StageMorph&&n.hide();f.tabTo=
function(q){var p;k.currentTab=q;this.children.forEach(function(t){t.refresh();t.state&&(p=t)});p.refresh();k.createSpriteEditor();k.fixLayout("tabEditor")};n=new TabMorph(e,null,function(){SnapActions.selectTab("scripts");f.tabTo("scripts")},localize("Scripts"),function(){return"scripts"===b.currentTab});n.padding=3;n.corner=15;n.edge=1;n.labelShadowOffset=new Point(-1,-1);n.labelShadowColor=e[1];n.labelColor=this.buttonLabelColor;n.getPressRenderColor=function(){return MorphicPreferences.isFlat||
.85<SyntaxElementMorph.prototype.alpha?this.pressColor:this.pressColor.mixed(Math.max(SyntaxElementMorph.prototype.alpha-.15,0),SpriteMorph.prototype.paletteColor)};n.fixLayout();f.add(n);n=new TabMorph(e,null,function(){SnapActions.selectTab("costumes");f.tabTo("costumes")},localize(this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds"),function(){return"costumes"===b.currentTab});n.padding=3;n.corner=15;n.edge=1;n.labelShadowOffset=new Point(-1,-1);n.labelShadowColor=e[1];n.labelColor=
this.buttonLabelColor;n.fixLayout();f.add(n);n=new TabMorph(e,null,function(){SnapActions.selectTab("sounds");f.tabTo("sounds")},localize("Sounds"),function(){return"sounds"===b.currentTab});n.padding=3;n.corner=15;n.edge=1;n.labelShadowOffset=new Point(-1,-1);n.labelShadowColor=e[1];n.labelColor=this.buttonLabelColor;n.fixLayout();f.add(n);f.fixLayout();f.children.forEach(function(q){return q.refresh()});this.spriteBar.tabBar=f;this.spriteBar.add(this.spriteBar.tabBar);this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left());
this.tabBar.setBottom(this.bottom()+k.padding)};this.isAppMode&&this.spriteBar.hide()};
IDE_Morph.prototype.createSpriteEditor=function(){var a=this,b=this.currentSprite.scripts;this.spriteEditor&&this.spriteEditor.destroy();"scripts"===this.currentTab?(b.isDraggable=!1,b.color=this.groupColor,b.cachedTexture=this.scriptsPaneTexture,this.spriteEditor=new ScrollFrameMorph(b,null,this.sliderColor),this.spriteEditor.color=this.groupColor,this.spriteEditor.padding=10,this.spriteEditor.growth=50,this.spriteEditor.isDraggable=!1,this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=
!0,b.scrollFrame=this.spriteEditor,b.updateToolbar(),this.add(this.spriteEditor),this.spriteEditor.scrollX(this.spriteEditor.padding),this.spriteEditor.scrollY(this.spriteEditor.padding)):"costumes"===this.currentTab?(this.spriteEditor=new WardrobeMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!1,this.spriteEditor.contents.mouseEnterDragging=
function(c){c instanceof BlockMorph&&a.spriteBar.tabBar.tabTo("scripts")}):"sounds"===this.currentTab?(this.spriteEditor=new JukeboxMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptDrops=!1,this.spriteEditor.contents.acceptsDrops=!1,this.spriteEditor.contents.mouseEnterDragging=function(c){c instanceof BlockMorph&&a.spriteBar.tabBar.tabTo("scripts")}):(this.spriteEditor=new Morph,
this.spriteEditor.color=this.groupColor,this.spriteEditor.acceptsDrops=!0,this.spriteEditor.reactToDropOf=function(c){c instanceof DialogBoxMorph?a.world().add(c):c instanceof SpriteMorph?a.removeSprite(c):c.destroy()},this.add(this.spriteEditor));this.activeEditor.onSetActive()};
IDE_Morph.prototype.createCorralBar=function(){var a=MorphicPreferences.isFlat?this.tabColors:[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)];this.corralBar&&this.corralBar.destroy();this.corralBar=new Morph;this.corralBar.color=this.frameColor;this.corralBar.setHeight(this.logo.height());this.add(this.corralBar);var b=new PushButtonMorph(this,"addNewSprite",new SymbolMorph("turtle",14));b.corner=12;b.color=a[0];b.highlightColor=a[1];b.pressColor=a[2];b.labelMinExtent=new Point(36,
18);b.padding=0;b.labelShadowOffset=new Point(-1,-1);b.labelShadowColor=a[1];b.labelColor=this.buttonLabelColor;b.contrast=this.buttonContrast;b.hint="add a new Turtle sprite";b.fixLayout();b.setCenter(this.corralBar.center());b.setLeft(this.corralBar.left()+5);this.corralBar.add(b);var c=new PushButtonMorph(this,"paintNewSprite",new SymbolMorph("brush",15));c.corner=12;c.color=a[0];c.highlightColor=a[1];c.pressColor=a[2];c.labelMinExtent=new Point(36,18);c.padding=0;c.labelShadowOffset=new Point(-1,
-1);c.labelShadowColor=a[1];c.labelColor=this.buttonLabelColor;c.contrast=this.buttonContrast;c.hint="paint a new sprite";c.fixLayout();c.setCenter(this.corralBar.center());c.setLeft(this.corralBar.left()+5+b.width()+5);this.corralBar.add(c);if(CamSnapshotDialogMorph.prototype.enableCamera){var d=new PushButtonMorph(this,"newCamSprite",new SymbolMorph("camera",15));d.corner=12;d.color=a[0];d.highlightColor=a[1];d.pressColor=a[2];d.labelMinExtent=new Point(36,18);d.padding=0;d.labelShadowOffset=new Point(-1,
-1);d.labelShadowColor=a[1];d.labelColor=this.buttonLabelColor;d.contrast=this.buttonContrast;d.hint="take a camera snapshot and\nimport it as a new sprite";d.fixLayout();d.setCenter(this.corralBar.center());d.setLeft(this.corralBar.left()+5+b.width()+5+c.width()+5);this.corralBar.add(d);document.addEventListener("cameraDisabled",function(e){d.disable();d.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage})}};
IDE_Morph.prototype.createCorral=function(){var a=this,b=this;this.createStageHandle();this.createPaletteHandle();this.corral&&this.corral.destroy();this.corral=new Morph;this.corral.color=this.groupColor;this.corral.getRenderColor=ScriptsMorph.prototype.getRenderColor;this.add(this.corral);this.corral.stageIcon=new SpriteIconMorph(this.stage);this.corral.stageIcon.isDraggable=!1;this.corral.add(this.corral.stageIcon);var c=new ScrollFrameMorph(null,null,this.sliderColor);c.acceptsDrops=!1;c.contents.acceptsDrops=
!1;c.contents.wantsDropOf=function(d){return d instanceof SpriteIconMorph};c.contents.reactToDropOf=function(d){return a.corral.reactToDropOf(d)};c.alpha=0;this.sprites.asArray().forEach(function(d){d.isTemporary||c.contents.add(new SpriteIconMorph(d))});this.corral.frame=c;this.corral.add(c);this.corral.fixLayout=function(){this.stageIcon.setCenter(this.center());this.stageIcon.setLeft(this.left()+5);this.frame.setLeft(this.stageIcon.right()+5);this.frame.setExtent(new Point(this.right()-this.frame.left(),
this.height()));this.arrangeIcons();this.refresh()};this.corral.arrangeIcons=function(){var d=this.frame.left(),e=this.frame.top(),f=this.frame.right(),g=this.frame.left();this.frame.contents.children.forEach(function(h){var k=h.width();d+k>f&&(d=g,e+=h.height());h.setPosition(new Point(d,e));d+=k});this.frame.contents.adjustBounds()};this.corral.addSprite=function(d){this.frame.contents.add(new SpriteIconMorph(d));this.fixLayout()};this.corral.refresh=function(){this.stageIcon.refresh();this.frame.contents.children.forEach(function(d){return d.refresh()})};
this.corral.wantsDropOf=function(d){return d instanceof SpriteIconMorph};this.corral.reactToDropOf=function(d){var e=1,f=d.position(),g=!!SnapActions.getOwnerFromId(d.object.id);d.destroy();g&&(this.frame.contents.children.forEach(function(h){if(f.gt(h.position())||f.y>h.bottom())e+=1}),b.sprites.add(d.object,e),b.createCorral(),b.fixLayout())};this.corral.userMenu=function(){var d=new MenuMorph(this);if(SnapUndo.canUndo("corral")){var e=SnapUndo.eventHistory.corral.length;e=SnapUndo.eventHistory.corral[e-
1];e=b.serializer.parse(e.args[1]).childrenNamed("sprite")[0];d.addItem("restore "+e.attributes.name,function(){SnapUndo.undo("corral")})}return d};this.isAppMode&&this.corral.hide()};IDE_Morph.prototype.createReplayControls=function(){this.replayControls=new ReplayControls(this);this.add(this.replayControls);this.replayControls.hide()};
IDE_Morph.prototype.fixLayout=function(a){var b=this.padding;"refreshPalette"!==a&&(this.controlBar.setPosition(this.logo.topRight()),this.controlBar.setWidth(this.right()-this.controlBar.left()),this.controlBar.fixLayout(),this.categories.setLeft(this.logo.left()),this.categories.setTop(this.logo.bottom()),this.categories.setWidth(this.paletteWidth));this.palette.setLeft(this.logo.left());this.palette.setTop(this.categories.bottom());this.palette.setHeight(this.bottom()-this.palette.top());this.palette.setWidth(this.paletteWidth);
if("refreshPalette"!==a){if(this.isEmbedMode){this.stage.setScale(Math.floor(100*Math.min(this.width()/this.stage.dimensions.x,this.height()/this.stage.dimensions.y))/100);var c=this.embedPlayButton.flag;c.size=Math.floor(Math.min(this.width(),this.height()))/5;c.fixLayout();this.embedPlayButton.size=1.6*c.size;this.embedPlayButton.fixLayout();this.embedOverlay&&this.embedOverlay.setExtent(this.extent());this.stage.setCenter(this.center());this.embedPlayButton.setCenter(this.stage.center());c.setCenter(this.embedPlayButton.center());
c.setLeft(c.left()+.1*c.size)}else if(this.isAppMode){if(this.isMobileDevice()){c=(this.width()-2*b)/this.stage.dimensions.x;var d=(this.height()-2*b)/this.stage.dimensions.y;c=Math.floor(1E3*Math.min(c,d))/1E3}else c=Math.floor(10*Math.min((this.width()-2*b)/this.stage.dimensions.x,(this.height()-2*this.controlBar.height()-2*b)/this.stage.dimensions.y))/10;this.stage.setScale(c);this.stage.setCenter(this.center())}else this.stage.setScale(this.isSmallStage?this.stageRatio:1),this.stage.setTop(this.logo.bottom()+
b),this.stage.setRight(this.right()),c=Math.max(200,this.width()-this.stage.width()-this.spriteBar.tabBar.width()-2*this.padding),this.paletteWidth>c&&(this.paletteWidth=c,this.fixLayout()),this.stageHandle.fixLayout(),this.paletteHandle.fixLayout();this.spriteBar.setLeft(this.paletteWidth+b);this.spriteBar.setTop(this.logo.bottom()+b);this.spriteBar.setExtent(new Point(Math.max(0,this.stage.left()-b-this.spriteBar.left()),this.categories.bottom()-this.spriteBar.top()-b-8));this.spriteBar.fixLayout();
this.spriteEditor.isVisible&&(this.spriteEditor.setPosition(new Point(this.spriteBar.left(),this.spriteBar.bottom()+b)),this.spriteEditor.setExtent(new Point(this.spriteBar.width(),this.bottom()-this.spriteEditor.top())));this.corralBar.setLeft(this.stage.left());this.corralBar.setTop(this.stage.bottom()+b);this.corralBar.setWidth(this.stage.width());contains(["selectSprite","tabEditor"],a)||(this.corral.setPosition(this.corralBar.bottomLeft()),this.corral.setWidth(this.stage.width()),this.corral.setHeight(this.bottom()-
this.corral.top()),this.corral.fixLayout())}this.width();this.removeChild(this.replayControls);this.add(this.replayControls);this.replayControls.setWidth(this.width()-40);this.replayControls.setHeight(80);this.replayControls.setCenter(new Point(this.width()/2,0));this.replayControls.setBottom(this.bottom());this.replayControls.fixLayout();Morph.prototype.trackChanges=!0;this.changed();this.isAppMode&&this.isMobileDevice()&&0!==this.mobileMode.buttons.length&&this.mobileMode.fixLayout()};
IDE_Morph.prototype.setProjectName=function(a){this.projectName=a.replace(/['"]/g,"");this.hasChangedMedia=!0;this.controlBar.updateLabel()};
IDE_Morph.prototype.setExtent=function(a){var b=new Point(430,110);b=this.isAppMode?this.isMobileDevice()?new Point(10,10):this.isEmbedMode?new Point(100,100):StageMorph.prototype.dimensions.add(this.controlBar.height()+10):1<this.stageRatio?b.add(StageMorph.prototype.dimensions):b.add(StageMorph.prototype.dimensions.multiplyBy(this.stageRatio));a=a.max(b);b=a.x-(200+this.spriteBar.tabBar.width()+2*this.padding);this.stageRatio=Math.min(Math.min(b/this.stage.dimensions.x,(a.y-3.5*SpriteIconMorph.prototype.thumbSize.y)/
this.stage.dimensions.y),Math.max(3*SpriteIconMorph.prototype.thumbSize.x/this.stage.dimensions.x,this.stageRatio));IDE_Morph.uber.setExtent.call(this,a);this.fixLayout()};
IDE_Morph.prototype.render=function(a){IDE_Morph.uber.render.call(this,a);if(this.isAppMode&&this.stage){var b=this.stage.bounds.translateBy(this.position().neg()).expandBy(2);a.strokeStyle=(MorphicPreferences.isFlat?this.backgroundColor:this.groupColor).toString();a.lineWidth=1;a.beginPath();a.moveTo(b.origin.x,b.origin.y);a.lineTo(b.corner.x,b.origin.y);a.lineTo(b.corner.x,b.corner.y);a.lineTo(b.origin.x,b.corner.y);a.closePath();a.stroke()}};
IDE_Morph.prototype.reactToWorldResize=function(a){this.isAutoFill&&(this.setPosition(a.origin),this.setExtent(a.extent()));this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null)};
IDE_Morph.prototype.droppedImage=function(a,b){a=new Costume(a,this.currentSprite.newCostumeName(b?b.split(".")[0]:""));a.isTainted()?this.inform("Unable to import this image","The picture you wish to import has been\ntainted by a restrictive cross-origin policy\nmaking it unusable for costumes in Snap!. \n\nTry downloading this picture first to your\ncomputer, and import it from there."):SnapActions.addCostume(a,this.currentSprite,!0)};
IDE_Morph.prototype.droppedSVG=function(a,b){a=new SVG_Costume(a,b.split(".")[0]);SnapActions.addCostume(a,this.currentSprite,!0)};IDE_Morph.prototype.droppedAudio=function(a,b){var c=this,d,e;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){if(1==f.nextAddress)return d=a,f.yield(c.getAudioAsBase64(a.src),2);d.src=f.yieldResult;e=new Sound(a,b.split(".")[0]);SnapActions.addSound(e,c.currentSprite,!0).then(function(){return c.spriteBar.tabBar.tabTo("sounds")});f.jumpToEnd()})};
IDE_Morph.prototype.getAudioAsBase64=function(a){var b=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){return 1==c.nextAddress?a.startsWith("data:audio")?c.return(a):c.yield(new Promise(function(d){return b.getURL(a,function(e){var f=new window.FileReader;f.readAsDataURL(e);f.onloadend=function(){var g=f.result;g="data:audio/ogg;base64,"+g.split(",")[1];d(g)}},"blob")}),3):c.return(c.yieldResult)})};
IDE_Morph.prototype.droppedText=function(a,b,c){var d=this,e,f,g,h;return $jscomp.asyncExecutePromiseGeneratorProgram(function(k){if(1==k.nextAddress){e=b?b.split(".")[0]:"";f=b?b.slice(b.lastIndexOf(".")+1).toLowerCase():"";if(0===a.indexOf("<project"))return location.hash="",SnapActions.disableCollaboration(),SnapUndo.reset(),k.return(d.openProjectString(a));if(0===a.indexOf("<replay"))return k.return(d.openReplayString(a));if(0===a.indexOf("<snapdata"))return SnapActions.disableCollaboration(),
SnapUndo.reset(),location.hash="",k.return(d.openCloudDataString(a));if(0===a.indexOf("<blocks"))return k.return(SnapActions.importBlocks(a,e));if(0===a.indexOf("<sprites"))return k.return(SnapActions.importSprites(a));if(0===a.indexOf("<media"))return k.return(d.openMediaString(a));c=c||"text";return 0!==a.indexOf("<script")?k.jumpTo(2):k.yield(d.openScriptString(a),3)}if(2!=k.nextAddress){if(g=k.yieldResult)(h=d.world().hand.children.length)?d.showMessage(localize("Cannot import scripts while dragging another object.")):
(g.setPosition(d.palette.center()),d.palette.add(g),delete g.id,g.pickUp(d.world()),d.showMessage(localize("Imported script."),2));return k.return()}return-1!==c.indexOf("csv")||"csv"===f?k.return(d.openDataString(a,e,"csv")):-1!==c.indexOf("json")||"json"===f?k.return(d.openDataString(a,e,"json")):k.return(d.openDataString(a,e,"text"))})};
IDE_Morph.prototype.droppedBinary=function(a,b){function c(f,g){var h=new sb.Reader,k=g.split(".")[0];h.onload=function(l){e.droppedText((new sb.XMLWriter).write(k,l))};h.readYPR(new Uint8Array(f))}var d=document.getElementById("ypr"),e=this;"ypr"===b.substring(b.length-3).toLowerCase()&&(d?c(a,b):(d=document.createElement("script"),d.id="ypr",d.onload=function(){c(a,b)},document.head.appendChild(d),d.src=this.resourceURL("src","ypr.js")))};
IDE_Morph.prototype.refreshPalette=function(a){var b=this.palette.contents.top();this.createPalette();this.isAppMode?this.palette.hide():(this.fixLayout("refreshPalette"),a||this.palette.contents.setTop(b))};IDE_Morph.prototype.pressStart=function(){SnapActions.pressStart(16===this.world().currentKey);16===this.world().currentKey?this.toggleFastTracking():(this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.runScripts())};
IDE_Morph.prototype.toggleFastTracking=function(){this.stage.isFastTracked?this.stopFastTracking():this.startFastTracking()};IDE_Morph.prototype.toggleVariableFrameRate=function(){StageMorph.prototype.frameRate?(StageMorph.prototype.frameRate=0,this.stage.fps=0):(StageMorph.prototype.frameRate=30,this.stage.fps=30)};
IDE_Morph.prototype.toggleCollaborativeEditing=function(){var a=this;SnapActions.isCollaborating()?SnapActions.disableCollaboration():this.isReplayMode?this.confirm("Cannot enter collaborate while in replay mode. \nWould you like to exit replay mode and enable collaborative editing?","Exit Replay Mode?",function(){a.exitReplayMode();SnapActions.enableCollaboration()}):SnapActions.enableCollaboration()};
IDE_Morph.prototype.toggleSingleStepping=function(){this.stage.threads.toggleSingleStepping();this.controlBar.steppingButton.refresh();this.controlBar.refreshSlider()};IDE_Morph.prototype.toggleCameraSupport=function(){CamSnapshotDialogMorph.prototype.enableCamera=!CamSnapshotDialogMorph.prototype.enableCamera;this.spriteBar.tabBar.tabTo(this.currentTab);this.createCorralBar();this.fixLayout()};
IDE_Morph.prototype.startFastTracking=function(){this.stage.isFastTracked=!0;this.stage.fps=0;this.controlBar.startButton.labelString=new SymbolMorph("flash",14);this.controlBar.startButton.createLabel();this.controlBar.startButton.fixLayout();this.controlBar.startButton.rerender()};
IDE_Morph.prototype.stopFastTracking=function(){this.stage.isFastTracked=!1;this.stage.fps=this.stage.frameRate;this.controlBar.startButton.labelString=new SymbolMorph("flag",14);this.controlBar.startButton.createLabel();this.controlBar.startButton.fixLayout();this.controlBar.startButton.rerender()};IDE_Morph.prototype.runScripts=function(){this.stage.fireGreenFlagEvent()};
IDE_Morph.prototype.togglePauseResume=function(){SnapActions.togglePause(this.stage.threads.isPaused());this.stage.threads.isPaused()?this.stage.threads.resumeAll(this.stage):this.stage.threads.pauseAll(this.stage);this.controlBar.pauseButton.refresh()};IDE_Morph.prototype.isPaused=function(){return this.stage?this.stage.threads.isPaused():!1};
IDE_Morph.prototype.stopAllScripts=function(){SnapActions.stopAllScripts();this.stage.threads.pauseCustomHatBlocks=this.stage.enableCustomHatBlocks?!this.stage.threads.pauseCustomHatBlocks:!1;this.controlBar.stopButton.refresh();this.stage.fireStopAllEvent()};
IDE_Morph.prototype.selectSprite=function(a){if(!detect(this.world().children,function(b){return b instanceof BlockEditorMorph||b instanceof BlockDialogMorph}))return this.currentSprite&&this.currentSprite.scripts.focus&&this.currentSprite.scripts.focus.stopEditing(),this.currentSprite=a,this.createPalette(),this.createSpriteBar(),this.createSpriteEditor(),this.corral.refresh(),this.fixLayout("selectSprite"),this.currentSprite.scripts.fixMultiArgs(),this.currentSprite};
IDE_Morph.prototype.toggleRetina=function(){isRetinaEnabled()?disableRetinaSupport():enableRetinaSupport();this.world().fillPage();MorphicPreferences.isFlat||(IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture());this.stage.clearPenTrails();this.refreshIDE()};IDE_Morph.prototype.defaultDesign=function(){this.setDefaultDesign();this.refreshIDE();this.removeSetting("design")};IDE_Morph.prototype.flatDesign=function(){this.setFlatDesign();this.refreshIDE();this.saveSetting("design","flat")};
IDE_Morph.prototype.refreshIDE=function(){if(Process.prototype.isCatchingErrors)try{var a=this.serializer.serialize(this.stage)}catch(b){this.showMessage("Serialization failed: "+b)}else a=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks();this.buildPanes();this.fixLayout();this.loadNewProject?SnapActions.openProject():(SnapUndo.reset(),this.openProjectString(a))};
IDE_Morph.prototype.applySavedSettings=function(){var a=this.getSetting("design"),b=this.getSetting("zoom"),c=this.getSetting("fade"),d=this.getSetting("language"),e=this.getSetting("click"),f=this.getSetting("longform"),g=this.getSetting("longurls"),h=this.getSetting("plainprototype"),k=this.getSetting("keyboard"),l=this.getSetting("tables"),m=this.getSetting("tableLines"),n=this.getSetting("autowrapping");"flat"===a?this.setFlatDesign():this.setDefaultDesign();b&&(SyntaxElementMorph.prototype.setScale(Math.min(b,
12)),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks());isNil(c)||this.setBlockTransparency(+c);this.userLanguage=d&&"en"!==d?d:null;e&&!BlockMorph.prototype.snapSound&&BlockMorph.prototype.toggleSnapSound();f&&(InputSlotDialogMorph.prototype.isLaunchingExpanded=!0);this.projectsInURLs=g?!0:!1;ScriptsMorph.prototype.enableKeyboard="false"===k?!1:!0;List.prototype.enableTables="false"===l?!1:!0;TableMorph.prototype.highContrast=m?!0:!1;ScriptsMorph.prototype.enableNestedAutoWrapping=
"false"===n?!1:!0;h&&(BlockLabelPlaceHolderMorph.prototype.plainLabel=!0)};IDE_Morph.prototype.saveSetting=function(a,b){this.savingPreferences&&this.hasLocalStorage()&&(localStorage["-snap-setting-"+a]=b)};IDE_Morph.prototype.getSetting=function(a){return this.hasLocalStorage()?localStorage["-snap-setting-"+a]:null};IDE_Morph.prototype.removeSetting=function(a){this.hasLocalStorage()&&delete localStorage["-snap-setting-"+a]};IDE_Morph.prototype.hasLocalStorage=function(){try{return!isNil(localStorage)}catch(a){return!1}};
IDE_Morph.prototype.addNewSprite=function(){var a=this,b=new SpriteMorph(this.globalVariables),c=Process.prototype.reportBasicRandom;b.name=this.newSpriteName(b.name);b.setCenter(this.stage.center());b.parent=this.stage;b.setColorComponentHSVA(0,c.call(this,0,100));b.setColorComponentHSVA(1,100);b.setColorComponentHSVA(2,c.call(this,50,100));b.setXPosition(c.call(this,-220,220));b.setYPosition(c.call(this,-160,160));16===this.world().currentKey&&b.turn(c.call(this,1,360));return SnapActions.addSprite(b).then(function(d){return a.selectSprite(d)})};
IDE_Morph.prototype.paintNewSprite=function(){var a=this,b=new SpriteMorph(this.globalVariables),c=new Costume;c.edit(this.world(),null,!0,nop,function(){c.shrinkWrap();b.parent=a.stage;b.addCostume(c);b.wearCostume(c);b.gotoXY(0,0);SnapActions.addSprite(b)})};
IDE_Morph.prototype.newCamSprite=function(){var a=this,b=new SpriteMorph(this.globalVariables);b.name=this.newSpriteName(b.name);b.setCenter(this.stage.center());b.parent=this.stage;var c=new CamSnapshotDialogMorph(this,b,nop,function(d){b.addCostume(d);b.wearCostume(d);c.close();SnapActions.addSprite(b).then(function(e){return a.selectSprite(e)})});c.popUp(this.world())};
IDE_Morph.prototype.recordNewSound=function(){var a=this;var b=new SoundRecorderDialogMorph(function(c){c&&(c=a.currentSprite.addSound(c,a.newSoundName("recording")),a.makeSureRecordingIsMono(c),a.spriteBar.tabBar.tabTo("sounds"),a.hasChangedMedia=!0)});b.key="microphone";b.popUp(this.world())};
IDE_Morph.prototype.makeSureRecordingIsMono=function(a){function b(e,f){var g=Note.prototype.getAudioContext();f=g.createBuffer(1,e.length,+f||44100);var h;f.copyToChannel||(f.copyToChannel=function(k,l){l=this.getChannelData(l);for(h=0;h<k.length;h+=1)l[h]=k[h]});f.copyToChannel(Float32Array.from(e),0,0);e=g.createBufferSource();e.buffer=f;e.audioBuffer=e.buffer;return e}function c(e,f){var g=e.sampleRate;f=(f||{}).float32?3:1;var h=3===f?32:16;e=e.getChannelData(0);return d(e,f,g,1,h)}function d(e,
f,g,h,k){function l(u,v,w){for(var x=0;x<w.length;x+=1,v+=4)u.setFloat32(v,w[x],!0)}function m(u,v,w){var x;for(x=0;x<w.length;x+=1,v+=2){var y=Math.max(-1,Math.min(1,w[x]));u.setInt16(v,0>y?32768*y:32767*y,!0)}}function n(u,v,w){for(var x=0;x<w.length;x+=1)u.setUint8(v+x,w.charCodeAt(x))}var q=k/8,p=h*q,t=new ArrayBuffer(44+e.length*q),r=new DataView(t);n(r,0,"RIFF");r.setUint32(4,36+e.length*q,!0);n(r,8,"WAVE");n(r,12,"fmt ");r.setUint32(16,16,!0);r.setUint16(20,f,!0);r.setUint16(22,h,!0);r.setUint32(24,
g,!0);r.setUint32(28,g*p,!0);r.setUint16(32,p,!0);r.setUint16(34,k,!0);n(r,36,"data");r.setUint32(40,e.length*q,!0);1===f?m(r,44,e):l(r,44,e);return t}(function(e,f){var g;if(e.audioBuffer)return f(e);var h=e.audio.src.split(",")[1];h=window.atob(h);var k=h.length;var l=new Uint8Array(k);for(g=0;g<k;g+=1)l[g]=h.charCodeAt(g);h=l.buffer;k=Note.prototype.getAudioContext();e.isDecoding=!0;k.decodeAudioData(h,function(m){e.audioBuffer=m;return f(e)},function(m){throw m;})})(a,function(e){if(1!==e.audioBuffer.numberOfChannels){var f=
e.audioBuffer.getChannelData(0);var g=new Audio;f=new Blob([c(b(f,44100).audioBuffer)],{type:"audio/wav"});var h=new FileReader;h.onload=function(){g.src=h.result;e.audio=g;e.audioBuffer=null;e.cachedSamples=null;e.isDecoding=!1};h.readAsDataURL(f)}})};IDE_Morph.prototype.duplicateSprite=function(a){a=a.fullCopy();a.appearIn(this);return a};
IDE_Morph.prototype.instantiateSprite=function(a){var b=a.fullCopy(!0),c=b.allHatBlocksFor("__clone__init__");b.isDown=!1;b.appearIn(this);c.length?b.initClone(c):(b.setPosition(this.world().hand.position()),b.keepWithin(this.stage));b.isDown=a.isDown;this.selectSprite(b)};
IDE_Morph.prototype.removeSprite=function(a){var b=this;a.parts.slice().forEach(function(d){return b.removeSprite(d)});var c=this.sprites.asArray().indexOf(a)+1;this.stage.threads.stopAllForReceiver(a);a.corpsify();a.destroy();this.stage.watchers().forEach(function(d){d.object()===a&&d.destroy()});0<c&&this.sprites.remove(c);this.createCorral();this.fixLayout();this.currentSprite=detect(this.stage.children,function(d){return d instanceof SpriteMorph&&!d.isTemporary})||this.stage;this.selectSprite(this.currentSprite)};
IDE_Morph.prototype.newSoundName=function(a){var b=this.currentSprite.sounds.at(this.currentSprite.sounds.length());return this.newName(a||b.name,this.currentSprite.sounds.asArray().map(function(c){return c.name}))};IDE_Morph.prototype.newSpriteName=function(a,b){var c=this.sprites.asArray().concat(this.stage).filter(function(d){return d!==b}).map(function(d){return d.name});return this.newName(a,c)};
IDE_Morph.prototype.newName=function(a,b){var c=a.indexOf("(");a=0>c?a:a.substring(0,c);c=1;for(var d=a;contains(b,d);)c+=1,d=a+"("+c+")";return d};IDE_Morph.prototype.removeBlock=function(a,b){this.stage.threads.stopAllForBlock(a);a.destroy(b)};IDE_Morph.prototype.userMenu=function(){return new MenuMorph(this)};
IDE_Morph.prototype.snapMenu=function(){var a=this,b=this.world();var c=new MenuMorph(this);c.addItem("About...","aboutNetsBlox");c.addLine();c.addItem("NetsBlox website",function(){window.open("https://netsblox.org","NetsBloxWebsite")});c.addItem("Snap! manual",function(){var d=a.resourceURL("help","SnapManual.pdf");window.open(d,"SnapReferenceManual")});c.addItem("Source code",function(){window.open("https://github.com/netsblox/netsblox")});c.addLine();c.addItem("Report a bug","reportBug");16===
b.currentKey&&c.addItem("Load reported bug","loadBugReport",void 0,new Color(100,0,0));b.isDevMode?(c.addLine(),c.addItem("Switch back to user mode","switchToUserMode","disable deep-Morphic\ncontext menus\nand show user-friendly ones",new Color(0,100,0))):16===b.currentKey&&(c.addLine(),c.addItem("Switch to dev mode","switchToDevMode","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!",new Color(100,0,0)));c.popup(b,this.logo.bottomLeft())};
IDE_Morph.prototype.cloudMenu=function(){var a=this,b=16===this.world().currentKey;if("file:"!==location.protocol||b){var c=new MenuMorph(this);this.cloud.username?(c.addItem(localize("Logout")+" "+this.cloud.username,"logout"),c.addItem("Change Password...","changeCloudPassword")):(c.addItem("Login...","initializeCloud"),c.addItem("Login with Snap!...","initializeCloudWithSnap"),c.addItem("Signup...","createCloudAccount"),c.addItem("Reset Password...","resetCloudPassword"));b&&(c.addLine(),c.addItem("export project media only...",
function(){a.projectName?a.exportProjectMedia(a.projectName):a.prompt("Export Project As...",function(d){return a.exportProjectMedia(d)},null,"exportProject")},null,this.hasChangedMedia?new Color(100,0,0):new Color(0,100,0)),c.addItem("export project without media...",function(){a.projectName?a.exportProjectNoMedia(a.projectName):a.prompt("Export Project As...",function(d){return a.exportProjectNoMedia(d)},null,"exportProject")},null,new Color(100,0,0)),c.addLine(),c.addItem("open shared project from cloud...",
function(){a.prompt("Author name\u2026",function(d){a.prompt("Project name...",function(e){var f,g,h,k;return $jscomp.asyncExecutePromiseGeneratorProgram(function(l){switch(l.nextAddress){case 1:return f="Username="+encodeURIComponent(d.toLowerCase())+"&ProjectName="+encodeURIComponent(e),a.showMessage("Fetching project\nfrom the cloud..."),l.setCatchFinallyBlocks(2),l.yield(SnapCloud.getPublicProject(f),4);case 4:return g=l.yieldResult,Process.prototype.isCatchingErrors||window.open("data:text/xml,"+
g),h=a.showMessage("Opening project..."),l.yield(SnapActions.openProject(g),5);case 5:h.destroy();l.leaveTryBlock(0);break;case 2:k=l.enterCatchBlock(),a.cloudError()(k.message),l.jumpToEnd()}})},null,"project")},null,"project")},null,new Color(100,0,0)));return c}this.showMessage("cloud unavailable without a web server.")};
IDE_Morph.prototype.settingsMenu=function(){function a(h,k,l,m,n,q){q&&!d||g.addItem([l?e:f,localize(h)],k,l?m:n,q?new Color(100,0,0):null)}var b=this,c=this.stage,d=16===this.world().currentKey,e=new SymbolMorph("checkedBox",.75*MorphicPreferences.menuFontSize),f=new SymbolMorph("rectangle",.75*MorphicPreferences.menuFontSize);var g=new MenuMorph(this);g.addPair([new SymbolMorph("globe",MorphicPreferences.menuFontSize),localize("Language...")],"languageMenu");g.addItem("Zoom blocks...","userSetBlocksScale");
g.addItem("Fade blocks...","userFadeBlocks");g.addItem("Stage size...","userSetStageSize");d&&g.addItem("Dragging threshold...","userSetDragThreshold","specify the distance the hand has to move\nbefore it picks up an object",new Color(100,0,0));g.addItem("Microphone resolution...","microphoneMenu");g.addLine();isRetinaSupported()&&a("Retina display support","toggleRetina",isRetinaEnabled(),"uncheck for lower resolution,\nsaves computing resources","check for higher resolution,\nuses more computing resources",
!0);a("Input sliders","toggleInputSliders",MorphicPreferences.useSliderForInput,"uncheck to disable\ninput sliders for\nentry fields","check to enable\ninput sliders for\nentry fields");MorphicPreferences.useSliderForInput&&a("Execute on slider change","toggleSliderExecute",ArgMorph.prototype.executeOnSliderEdit,"uncheck to suppress\nrunning scripts\nwhen moving the slider","check to run\nthe edited script\nwhen moving the slider");a("Turbo mode","toggleFastTracking",this.stage.isFastTracked,"uncheck to run scripts\nat normal speed",
"check to prioritize\nscript execution");a("Visible stepping","toggleSingleStepping",Process.prototype.enableSingleStepping,"uncheck to turn off\nvisible stepping","check to turn on\n visible stepping (slow)",!1);a("Log pen vectors",function(){return StageMorph.prototype.enablePenLogging=!StageMorph.prototype.enablePenLogging},StageMorph.prototype.enablePenLogging,"uncheck to turn off\nlogging pen vectors","check to turn on\nlogging pen vectors",!1);a("Ternary Boolean slots",function(){return BooleanSlotMorph.prototype.isTernary=
!BooleanSlotMorph.prototype.isTernary},BooleanSlotMorph.prototype.isTernary,"uncheck to limit\nBoolean slots to true / false","check to allow\nempty Boolean slots",!0);a("Camera support","toggleCameraSupport",CamSnapshotDialogMorph.prototype.enableCamera,"uncheck to disable\ncamera support","check to enable\ncamera support",!0);g.addLine();a("Blurred shadows","toggleBlurredShadows",useBlurredShadows,"uncheck to use solid drop\nshadows and highlights","check to use blurred drop\nshadows and highlights",
!0);a("Zebra coloring","toggleZebraColoring",BlockMorph.prototype.zebraContrast,"uncheck to disable alternating\ncolors for nested block","check to enable alternating\ncolors for nested blocks",!0);a("Dynamic input labels","toggleDynamicInputLabels",SyntaxElementMorph.prototype.dynamicInputLabels,"uncheck to disable dynamic\nlabels for variadic inputs","check to enable dynamic\nlabels for variadic inputs",!0);a("Prefer empty slot drops","togglePreferEmptySlotDrops",ScriptsMorph.prototype.isPreferringEmptySlots,
"uncheck to allow dropped\nreporters to kick out others","settings menu prefer empty slots hint",!0);a("Long form input dialog","toggleLongFormInputDialog",InputSlotDialogMorph.prototype.isLaunchingExpanded,"uncheck to use the input\ndialog in short form","check to always show slot\ntypes in the input dialog");a("Plain prototype labels","togglePlainPrototypeLabels",BlockLabelPlaceHolderMorph.prototype.plainLabel,"uncheck to always show (+) symbols\nin block prototype labels","check to hide (+) symbols\nin block prototype labels");
a("Virtual keyboard","toggleVirtualKeyboard",MorphicPreferences.useVirtualKeyboard,"uncheck to disable\nvirtual keyboard support\nfor mobile devices","check to enable\nvirtual keyboard support\nfor mobile devices",!0);a("Clicking sound",function(){BlockMorph.prototype.toggleSnapSound();BlockMorph.prototype.snapSound?b.saveSetting("click",!0):b.removeSetting("click")},BlockMorph.prototype.snapSound,"uncheck to turn\nblock clicking\nsound off","check to turn\nblock clicking\nsound on");a("Animations",
function(){return b.isAnimating=!b.isAnimating},this.isAnimating,"uncheck to disable\nIDE animations","check to enable\nIDE animations",!0);a("Cache Inputs",function(){BlockMorph.prototype.isCachingInputs=!BlockMorph.prototype.isCachingInputs},BlockMorph.prototype.isCachingInputs,"uncheck to stop caching\ninputs (for debugging the evaluator)","check to cache inputs\nboosts recursion",!0);a("Rasterize SVGs",function(){return MorphicPreferences.rasterizeSVGs=!MorphicPreferences.rasterizeSVGs},MorphicPreferences.rasterizeSVGs,
"uncheck for smooth\nscaling of vector costumes","check to rasterize\nSVGs on import",!0);a("Flat design",function(){if(MorphicPreferences.isFlat)return b.defaultDesign();b.flatDesign()},MorphicPreferences.isFlat,"uncheck for default\nGUI design","check for alternative\nGUI design",!1);a("Nested auto-wrapping",function(){ScriptsMorph.prototype.enableNestedAutoWrapping=!ScriptsMorph.prototype.enableNestedAutoWrapping;ScriptsMorph.prototype.enableNestedAutoWrapping?b.removeSetting("autowrapping"):b.saveSetting("autowrapping",
!1)},ScriptsMorph.prototype.enableNestedAutoWrapping,"uncheck to confine auto-wrapping\nto top-level block stacks","check to enable auto-wrapping\ninside nested block stacks",!0);a("Project URLs",function(){b.projectsInURLs=!b.projectsInURLs;b.projectsInURLs?b.saveSetting("longurls",!0):b.removeSetting("longurls")},this.projectsInURLs,"uncheck to disable\nproject data in URLs","check to enable\nproject data in URLs",!0);a("Sprite Nesting",function(){return SpriteMorph.prototype.enableNesting=!SpriteMorph.prototype.enableNesting},
SpriteMorph.prototype.enableNesting,"uncheck to disable\nsprite composition","check to enable\nsprite composition",!0);a("First-Class Sprites",function(){SpriteMorph.prototype.enableFirstClass=!SpriteMorph.prototype.enableFirstClass;b.currentSprite.blocksCache.sensing=null;b.currentSprite.paletteCache.sensing=null;b.refreshPalette()},SpriteMorph.prototype.enableFirstClass,"uncheck to disable support\nfor first-class sprites","check to enable support\n for first-class sprite",!0);a("Keyboard Editing",
function(){ScriptsMorph.prototype.enableKeyboard=!ScriptsMorph.prototype.enableKeyboard;b.currentSprite.scripts.updateToolbar();ScriptsMorph.prototype.enableKeyboard?b.removeSetting("keyboard"):b.saveSetting("keyboard",!1)},ScriptsMorph.prototype.enableKeyboard,"uncheck to disable\nkeyboard editing support","check to enable\nkeyboard editing support",!0);a("Table support",function(){List.prototype.enableTables=!List.prototype.enableTables;List.prototype.enableTables?b.removeSetting("tables"):b.saveSetting("tables",
!1)},List.prototype.enableTables,"uncheck to disable\nmulti-column list views","check for multi-column\nlist view support",!0);List.prototype.enableTables&&a("Table lines",function(){TableMorph.prototype.highContrast=!TableMorph.prototype.highContrast;TableMorph.prototype.highContrast?b.saveSetting("tableLines",!0):b.removeSetting("tableLines")},TableMorph.prototype.highContrast,"uncheck for less contrast\nmulti-column list views","check for higher contrast\ntable views",!0);a("Live coding support",
function(){return Process.prototype.enableLiveCoding=!Process.prototype.enableLiveCoding},Process.prototype.enableLiveCoding,"EXPERIMENTAL! uncheck to disable live\ncustom control structures","EXPERIMENTAL! check to enable\n live custom control structures",!0);a("JIT compiler support",function(){Process.prototype.enableCompiling=!Process.prototype.enableCompiling;b.currentSprite.blocksCache.operators=null;b.currentSprite.paletteCache.operators=null;b.refreshPalette()},Process.prototype.enableCompiling,
"EXPERIMENTAL! uncheck to disable live\nsupport for compiling","EXPERIMENTAL! check to enable\nsupport for compiling",!0);!1!==SnapActions.supportsCollaboration&&a("Collaborative editing","toggleCollaborativeEditing",SnapActions.isCollaborating(),"uncheck to disable Google Docs-style collaboration","check to enable Google Docs-style collaboration",!1);a("Replay Mode",function(){if(b.isReplayMode){if(b.isPreviousVersion()){b.confirm("Exiting replay mode now will revert the project to\nthe current point in history (losing any unapplied changes)\n\nAre you sure you want to exit replay mode?",
"Exit Replay Mode?",function(){return b.exitReplayMode()});return}return b.exitReplayMode()}if(2>SnapUndo.allEvents.length)return b.showMessage("Nothing to replay!",2);SnapActions.isCollaborating()?b.confirm("Cannot enter replay mode while collaborating. \nWould you like to disable collaboration and enter replay mode?","Disable Collaboration?",function(){SnapActions.disableCollaboration();b.replayEvents()}):b.replayEvents()},this.isReplayMode,"uncheck to disable replay mode","check to enable replay mode",
!1);a("Save replay history",function(){SnapSerializer.prototype.isSavingHistory=!SnapSerializer.prototype.isSavingHistory},SnapSerializer.prototype.isSavingHistory,"uncheck to only save project","check to save replay with project",!1);a("Messaging while collaborating?",function(){var h,k,l;return $jscomp.asyncExecutePromiseGeneratorProgram(function(m){if(1==m.nextAddress){if(b.allowMsgsWhileCollaborating)return b.allowMsgsWhileCollaborating=!b.allowMsgsWhileCollaborating,m.jumpTo(0);h=localize("Send messages while collaborating?");
k=localize("By default, message sending is disabled when collaborating because it can make\ndebugging distributed applications difficult.\n\n")+localize("When multiple users collaborate, each collaborating user may send his/her own response\nto a received message. ")+localize('This is problematic when using the "send msg and wait"\nblock as well as for applications like turn-based games.\n\n')+localize("Would you like to enable message sending while collaborating?");return m.yield(b.confirm(k,h),
3)}if(l=m.yieldResult)b.allowMsgsWhileCollaborating=!b.allowMsgsWhileCollaborating;m.jumpToEnd()})},this.allowMsgsWhileCollaborating,"uncheck to block message sending while multiple users occupy a single role","check to allow message sending while multiple users occupy a single role",!1);g.addLine();a("Thread safe scripts",function(){return c.isThreadSafe=!c.isThreadSafe},this.stage.isThreadSafe,"uncheck to allow\nscript reentrance","check to disallow\nscript reentrance");a("Prefer smooth animations",
"toggleVariableFrameRate",StageMorph.prototype.frameRate,"uncheck for greater speed\nat variable frame rates","check for smooth, predictable\nanimations across computers",!0);a("Flat line ends",function(){return SpriteMorph.prototype.useFlatLineEnds=!SpriteMorph.prototype.useFlatLineEnds},SpriteMorph.prototype.useFlatLineEnds,"uncheck for round ends of lines","check for flat ends of lines");a("Codification support",function(){StageMorph.prototype.enableCodeMapping=!StageMorph.prototype.enableCodeMapping;
b.currentSprite.blocksCache.variables=null;b.currentSprite.paletteCache.variables=null;b.refreshPalette()},StageMorph.prototype.enableCodeMapping,"uncheck to disable\nblock to text mapping features","check for block\nto text mapping features",!1);a("Hyper blocks support",function(){return Process.prototype.enableHyperOps=!Process.prototype.enableHyperOps},Process.prototype.enableHyperOps,"uncheck to disable\nusing operators on lists and tables","check to enable\nusing operators on lists and tables",
!1);a("Persist linked sublist IDs",function(){return StageMorph.prototype.enableSublistIDs=!StageMorph.prototype.enableSublistIDs},StageMorph.prototype.enableSublistIDs,"uncheck to disable\nsaving linked sublist identities","check to enable\nsaving linked sublist identities",!0);a("Enable command drops in all rings",function(){return RingReporterSlotMorph.prototype.enableCommandDrops=!RingReporterSlotMorph.prototype.enableCommandDrops},RingReporterSlotMorph.prototype.enableCommandDrops,"uncheck to disable\ndropping commands in reporter rings",
"check to enable\ndropping commands in all rings",!0);return g};IDE_Morph.prototype.loadExtension=function(a){var b=this,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){if(1==d.nextAddress)return d.yield(b.isTrustedExtension(a),2);d.yieldResult&&(c=document.createElement("script"),c.setAttribute("src",a),c.setAttribute("type","text/javascript"),document.body.appendChild(c));d.jumpToEnd()})};
IDE_Morph.prototype.isTrustedExtension=function(a){var b=this,c,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){if(1==e.nextAddress){if(c=a.startsWith("/")||a.startsWith(window.location.origin))return e.return(!0);d="An untrusted third-party extension was encountered and\nrequires approval to load:\n\n"+a+"\n\nIf the above URL is not recognized or trusted, installation is not \nrecommended as third-party extensions could be malicious.\n\nWould you like to install this extension?";
return e.yield(b.confirm(d,"Install Third-Party Extension?"),2)}return e.return(e.yieldResult)})};
IDE_Morph.prototype.projectMenu=function(){var a=this;var b=this.world();var c=this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds",d=16===b.currentKey;b=new MenuMorph(this);b.addItem("Project notes...","editProjectNotes");b.addLine();b.addPair("New","createNewProject","^N");b.addPair("Open...","openProjectsBrowser","^O");b.addPair("Save","save","^S");b.addItem("Save As...","saveAs");d&&b.addItem(localize("Replay events from file"),function(){var e=document.createElement("input");1<
SnapUndo.allEvents.length&&a.newProject();a.filePicker&&(document.body.removeChild(a.filePicker),a.filePicker=null);e.type="file";e.style.color="transparent";e.style.backgroundColor="transparent";e.style.border="none";e.style.outline="none";e.style.position="absolute";e.style.top="0px";e.style.left="0px";e.style.width="0px";e.style.height="0px";e.addEventListener("change",function(){var f=new FileReader;document.body.removeChild(e);this.filePicker=null;f.onloadend=function(g){return this.loadReplayFromXml(g.target.result)};
f.readAsText(e.files[0])},!1);document.body.appendChild(e);a.filePicker=e;e.click()},"Load project replay from the beginning",new Color(100,0,0));b.addLine();b.addItem("Import...","importLocalFile","file menu import hint");d&&(b.addItem(localize("Export project...")+" "+localize("(in a new window)"),function(){a.projectName?a.exportProject(a.projectName,d):a.prompt("Export Project As...",function(e){return a.exportProject(e,!1)},null,"exportProject")},"show project data as XML\nin a new browser window",
new Color(100,0,0)),b.addItem(localize("Export project without history..."),function(){var e=a.serializer.isSavingHistory;a.projectName?(a.serializer.isSavingHistory=!1,a.exportProject(a.projectName,d),a.serializer.isSavingHistory=e):a.prompt("Export Project As...",function(f){this.serializer.isSavingHistory=!1;this.exportProject(f,d);this.serializer.isSavingHistory=e},null,"exportProject")},null,new Color(100,0,0)));b.addItem(d?"Export project as plain text...":"Export project...",function(){a.projectName?
a.exportProject(a.projectName,d):a.prompt("Export Project As...",function(e){return a.exportProject(e,d)},null,"exportProject")},"save project data as XML\nto your downloads folder",d?new Color(100,0,0):null);this.stage.globalBlocks.length&&(b.addItem("Export blocks...",function(){return a.exportGlobalBlocks()},"save global custom block\ndefinitions as XML"),SnapCloud.username&&b.addItem("Save blocks...","createLibrary","save custom blocks to the cloud as a library"),b.addItem("Unused blocks...",
function(){return a.removeUnusedBlocks()},"find unused global custom blocks\nand remove their definitions"));b.addItem("Export summary...",function(){return a.exportProjectSummary()},"save a summary\nof this project");d&&(b.addItem("Export summary with drop-shadows...",function(){return a.exportProjectSummary(!0)},"download and save\nwith a summary of this project\nwith drop-shadows on all pictures.\nnot supported by all browsers",new Color(100,0,0)),b.addItem("Export all scripts as pic...",function(){return a.exportScriptsPicture()},
"show a picture of all scripts\nand block definitions",new Color(100,0,0)));b.addLine();b.addItem("Libraries...",function(){"file:"===location.protocol?a.importLocalFile():(new LibraryDialogMorph(a)).popUp(a.world())},"Select categories of additional blocks to add to this project.");b.addItem(localize(c)+"...",function(){"file:"===location.protocol?a.importLocalFile():a.importMedia(c)},"Select a costume from the media library");b.addItem(localize("Sounds")+"...",function(){"file:"===location.protocol?
a.importLocalFile():a.importMedia("Sounds")},"Select a sound from the media library");return b};IDE_Morph.prototype.replayEvents=function(a,b){b=!!b;a||(b=!0,a=JSON.parse(JSON.stringify(SnapUndo.allEvents)));this.replayControls.enable();this.replayControls.setActions(a,b);this.isReplayMode=!0;this.preReplayUndoState={};a=SnapUndo.allQueueIds();for(b=a.length;b--;)this.preReplayUndoState[a[b]]=SnapUndo.undoCount[a[b]]};
IDE_Morph.prototype.exitReplayMode=function(){if(this.isReplayMode){this.isReplayMode=!1;var a=this;SnapUndo.allQueueIds().filter(function(b){return a.preReplayUndoState[b]!==SnapUndo.undoCount[b]}).forEach(function(b){SnapUndo.trim(b)});SnapUndo.allEvents=this.replayControls.getCurrentHistory();this.activeEditor.onSetActive();this.replayControls.disable()}};IDE_Morph.prototype.resourceURL=function(){return Array.prototype.slice.call(arguments,0).join("/")};
IDE_Morph.prototype.getMediaListFromURL=function(a,b){function c(e,f){return e.name.toLowerCase()<f.name.toLowerCase()?-1:1}var d=this;if(b instanceof Function)this.getURL(a,function(e){e=d.parseResourceFile(e);e.sort(c);b.call(d,e)});else return a=this.parseResourceFile(this.getURL(a)),a.sort(c),a};IDE_Morph.prototype.getMediaList=function(a,b){a=this.resourceURL(a,a.toUpperCase());return this.getMediaListFromURL.call(this,a,b)};
IDE_Morph.prototype.parseResourceFile=function(a){var b,c=[];a.split("\n").map(function(d){return d.trim()}).filter(function(d){return 0<d.length}).forEach(function(d){b=d.split("\t").map(function(e){return e.trim()});2>b.length||c.push({fileName:b[0],name:b[1],description:2<b.length?b[2]:""})});return c};
IDE_Morph.prototype.importLocalFile=function(){var a=this,b=document.createElement("input"),c=this.world();this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null);b.type="file";b.style.color="transparent";b.style.backgroundColor="transparent";b.style.border="none";b.style.outline="none";b.style.position="absolute";b.style.top="0px";b.style.left="0px";b.style.width="0px";b.style.height="0px";b.style.display="none";b.addEventListener("change",function(){document.body.removeChild(b);
a.filePicker=null;c.hand.processDrop(b.files)},!1);document.body.appendChild(b);this.filePicker=b;b.click()};IDE_Morph.prototype.importMedia=function(a){var b=this,c=this.showMessage("Opening "+a+"...");this.getMediaList(a,function(d){c.destroy();b.popupMediaImportDialog(a,d)})};
IDE_Morph.prototype.popupMediaImportDialog=function(a,b){var c=this,d=(new DialogBoxMorph).withKey("import"+a),e=new ScrollFrameMorph,f=null,g=new SymbolMorph("turtle",60),h=this,k=this.world();e.acceptsDrops=!1;e.contents.acceptsDrops=!1;e.color=h.groupColor;e.fixLayout=nop;d.labelString=a;d.createLabel();d.addBody(e);d.addButton("ok","Import");d.addButton("cancel","Close");d.ok=function(){f&&(f.object instanceof Sound?h.droppedAudio(f.object.copy().audio,f.labelString):f.object instanceof SVG_Costume?
h.droppedSVG(f.object.contents,f.labelString):h.droppedImage(f.object.contents,f.labelString))};d.fixLayout=function(){var l=fontHeight(this.titleFontSize)+2*this.titlePadding,m=0,n=0;this.buttons.fixLayout();this.body.setPosition(this.position().add(new Point(this.padding,l+this.padding)));this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-l-this.buttons.height()));var q=this.body.position();var p=this.body.width();e.contents.children.forEach(function(t){t.setPosition(q.add(new Point(m,
n)));m+=t.width();m+t.width()>p&&(m=0,n+=t.height())});e.contents.adjustBounds();this.label.setCenter(this.center());this.label.setTop(this.top()+(l-this.label.height())/2);this.buttons.setCenter(this.center());this.buttons.setBottom(this.bottom()-this.padding);this.removeShadow();this.addShadow()};b.forEach(function(l){var m=c.resourceURL(a,l.fileName),n=new Image,q=m.slice(m.lastIndexOf(".")+1).toLowerCase(),p="svg"===q&&!MorphicPreferences.rasterizeSVGs;q=contains(["wav","mp3"],q);var t=q?new SoundIconMorph(new Sound(new Audio,
l.name)):new CostumeIconMorph(new Costume(g.getImage(),l.name));t.isDraggable=!1;t.userMenu=nop;t.action=function(){if(f!==t){var r=f;f=t;r&&r.refresh()}};t.doubleClickAction=d.ok;t.query=function(){return t===f};e.addContents(t);q?(t.object.audio.onloadeddata=function(){t.createThumbnail();t.fixLayout();t.refresh()},t.object.audio.src=m,t.object.audio.load()):p?(n.onload=function(){t.object=new SVG_Costume(n,l.name);t.refresh()},c.getURL(m,function(r){return n.src="data:image/svg+xml;base64,"+window.btoa(r)})):
(n.onload=function(){var r=newCanvas(new Point(n.width,n.height),!0);r.getContext("2d").drawImage(n,0,0);t.object=new Costume(r,l.name);t.refresh()},n.src=m)});d.popUp(k);d.setExtent(new Point(400,300));d.setCenter(k.center());new HandleMorph(d,300,280,d.corner,d.corner)};
IDE_Morph.prototype.aboutSnap=function(){function a(t){t=new TextMorph(t,h.fontSize,h.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE);var r=d.height()-10*h.titleFontSize;if(t.height()>r){var u=new ScrollFrameMorph;u.acceptsDrops=!1;u.contents.acceptsDrops=!1;u.bounds.setWidth(t.width());u.bounds.setHeight(r);u.addContents(t);u.color=new Color(0,0,0,0);return u}return t}var b="",c,d=this.world();var e=localize("License")+"\n\nSnap! is free software: you can redistribute it and/or modify\nit under the terms of the GNU Affero General Public License as\npublished by the Free Software Foundation, either version 3 of\nthe License, or (at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\nGNU Affero General Public License for more details.\n\nYou should have received a copy of the\nGNU Affero General Public License along with this program.\nIf not, see http://www.gnu.org/licenses/\n\nWant to use Snap! but scared by the open-source license?\nGet in touch with us, we'll make it work.";
var f=localize("Contributors")+'\n\nNathan Dinsmore: Saving/Loading, Snap-Logo Design, \ncountless bugfixes and optimizations\nMichael Ball: Time/Date UI, Library Import Dialog,\ncountless bugfixes and optimizations\nBernat Romagosa: Countless contributions\nBartosz Leper: Retina Display Support\nZhenlei Jia and Dariusz Doro\u017calski: IME text editing\nKen Kahn: IME support and countless other contributions\nJosep Ferr\u00e0ndiz: Video Motion Detection\nJoan Guill\u00e9n: Countless contributions\nKartik Chandra: Paint Editor\nCarles Paredes: Initial Vector Paint Editor\n"Ava" Yuan Yuan, Dylan Servilla: Graphic Effects\nKyle Hotchkiss: Block search design\nBrian Broll: Many bugfixes and optimizations\nIan Reynolds: UI Design, Event Bindings, Sound primitives\nJadga H\u00fcgle: Icons and countless other contributions\nIvan Motyashov: Initial Squeak Porting\nLucas Karahadian: Piano Keyboard Design\nDavide Della Casa: Morphic Optimizations\nAchal Dave: Web Audio\nJoe Otto: Morphic Testing and Debugging';
for(c in modules)Object.prototype.hasOwnProperty.call(modules,c)&&(b+="\n"+c+" ("+modules[c]+")");""!==b&&(b=localize("current module versions:")+" \n\nmorphic ("+morphicVersion+")"+b);var g=localize("Translations")+"\n"+SnapTranslator.credits();var h=new DialogBoxMorph;h.inform("About Snap","Snap! 6.2.0 - dev -\nBuild Your Own Blocks\n\nCopyright \u24b8 2008-2020 Jens M\u00f6nig and Brian Harvey\njens@moenig.org, bh@cs.berkeley.edu\n\n        Snap! is developed by the University of California, Berkeley and SAP        \nwith support from the National Science Foundation (NSF),\nMIOsoft and YC Research.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see https://snap.berkeley.edu",
d,this.logo.cachedTexture);var k=h.buttons.children[0];var l=h.addButton(function(){h.addBody(a(g));h.body.fixLayout();k.show();m.show();q.hide();p.hide();n.hide();l.hide();h.fixLayout();h.setCenter(d.center())},"Translators...");var m=h.addButton(function(){h.addBody(a("Snap! 6.2.0 - dev -\nBuild Your Own Blocks\n\nCopyright \u24b8 2008-2020 Jens M\u00f6nig and Brian Harvey\njens@moenig.org, bh@cs.berkeley.edu\n\n        Snap! is developed by the University of California, Berkeley and SAP        \nwith support from the National Science Foundation (NSF),\nMIOsoft and YC Research.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see https://snap.berkeley.edu"));
h.body.fixLayout();k.show();m.hide();q.show();p.show();n.show();l.hide();h.fixLayout();h.setCenter(d.center())},"Back...");m.hide();var n=h.addButton(function(){h.addBody(a(e));h.body.fixLayout();k.show();m.show();q.hide();p.hide();n.hide();l.hide();h.fixLayout();h.setCenter(d.center())},"License...");var q=h.addButton(function(){h.addBody(a(b));h.body.fixLayout();k.show();m.show();q.hide();p.hide();n.hide();l.hide();h.fixLayout();h.setCenter(d.center())},"Modules...");var p=h.addButton(function(){h.addBody(a(f));
h.body.fixLayout();k.show();m.show();l.show();q.hide();p.hide();n.hide();h.fixLayout();h.setCenter(d.center())},"Credits...");l.hide();h.fixLayout()};
IDE_Morph.prototype.editProjectNotes=function(){var a=this,b=(new DialogBoxMorph).withKey("projectNotes"),c=new ScrollFrameMorph,d=new TextMorph(this.projectNotes||""),e=this.world();c.padding=6;c.setWidth(250);c.acceptsDrops=!1;c.contents.acceptsDrops=!1;d.setWidth(250-2*c.padding);d.setPosition(c.topLeft().add(c.padding));d.enableSelecting();d.isEditable=!0;c.setHeight(250);c.fixLayout=nop;c.edge=InputFieldMorph.prototype.edge;c.fontSize=InputFieldMorph.prototype.fontSize;c.typeInPadding=InputFieldMorph.prototype.typeInPadding;
c.contrast=InputFieldMorph.prototype.contrast;c.render=InputFieldMorph.prototype.render;c.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;c.addContents(d);b.getInput=function(){return d.text};b.target=this;b.action=function(f){return a.projectNotes=f};b.justDropped=function(){return d.edit()};b.labelString="Project Notes";b.createLabel();b.addBody(c);b.addButton("ok","OK");b.addButton("cancel","Cancel");b.fixLayout();b.popUp(e);b.setCenter(e.center());d.edit()};
IDE_Morph.prototype.newProject=function(){this.source=this.cloud.username?"cloud":null;this.stage&&this.stage.destroy();"#lang:"!==location.hash.substr(0,6)&&(location.hash="");this.globalVariables=new VariableFrame;this.currentSprite=new SpriteMorph(this.globalVariables);this.sprites=new List([this.currentSprite]);StageMorph.prototype.dimensions=new Point(480,360);StageMorph.prototype.hiddenPrimitives={};StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=
!1;StageMorph.prototype.enableInheritance=!0;StageMorph.prototype.enableSublistIDs=!1;StageMorph.prototype.enablePenLogging=!1;SpriteMorph.prototype.useFlatLineEnds=!1;Process.prototype.enableLiveCoding=!1;Process.prototype.enableHyperOps=!0;this.setProjectName("");this.projectNotes="";this.createStage();this.add(this.stage);this.createCorral();this.selectSprite(this.stage.children[0]);this.fixLayout()};
IDE_Morph.prototype.isPreviousVersion=function(){if(!this.isReplayMode)return!1;var a=this.replayControls.actionIndex+1;return 0<SnapUndo.allEvents.filter(function(b){return!b.isReplay}).length-a};IDE_Morph.prototype.saveAs=function(){if(this.isPreviousVersion())return this.showMessage("Please exit replay mode before saving");this.saveProjectsBrowser()};
IDE_Morph.prototype.save=function(){var a=this;if(this.isPreviousVersion())return this.showMessage("Please exit replay mode before saving");"examples"===this.source&&(this.source="local");"file:"===location.protocol?this.projectName?this.exportProject(this.projectName,!1):this.prompt("Export Project As...",function(b){return a.exportProject(b,!1)},null,"exportProject"):this.room.name?"local"===this.source?this.saveProject(this.room.name):this.saveProjectToCloud(this.room.name):this.saveProjectsBrowser()};
IDE_Morph.prototype.saveProject=function(a){var b=this;this.nextSteps([function(){return b.showMessage("Saving...")},function(){return b.rawSaveProject(a)}])};
IDE_Morph.prototype.rawSaveProject=function(a){var b;if(a)if(this.setProjectName(a),Process.prototype.isCatchingErrors)try{localStorage["-snap-project-"+a]=b=this.serializer.serialize(this.stage),this.setURL("#open:"+b),this.showMessage("Saved!",1)}catch(c){this.showMessage("Save failed: "+c)}else localStorage["-snap-project-"+a]=b=this.serializer.serialize(this.stage),this.setURL("#open:"+b),this.showMessage("Saved!",1)};
IDE_Morph.prototype.exportProject=function(a,b){if(a){var c=this.projectName;this.silentSetProjectName(a);b="data:text/"+b?"plain,":"xml,";try{var d=this.showMessage("Exporting");var e=this.serializer.serialize(this.stage);this.setURL("#open:"+b+encodeURIComponent(e));this.saveXMLAs(e,a);d.destroy();this.showMessage("Exported!",1)}catch(f){if(Process.prototype.isCatchingErrors)this.showMessage("Export failed: "+f);else throw f;}this.silentSetProjectName(c)}};
IDE_Morph.prototype.exportGlobalBlocks=function(){var a=this;0<this.stage.globalBlocks.length||this.stage.deletableMessageNames().length?(new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks,this.stage,function(b,c){return a.saveXMLAs(b,c)})).popUp(this.world()):this.inform("Export blocks/msg types","this project doesn't have any\ncustom global blocks or message types yet")};
IDE_Morph.prototype.createLibrary=function(){var a=this;if(0<this.stage.globalBlocks.length||this.stage.deletableMessageNames().length){var b=new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks,this.stage,function(c,d){var e;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){if(1==f.nextAddress)return f.yield(a.promptLibraryNotes(),2);e=f.yieldResult;(new LibraryDialogMorph(a,d,c,e)).popUp(a.world());f.jumpToEnd()})});b.labelString="Save blocks / message types";b.createLabel();
b.fixLayout();b.popUp(this.world())}else this.inform("Export blocks/msg types","this project doesn't have any\ncustom global blocks or message types yet")};
IDE_Morph.prototype.promptLibraryNotes=function(){var a=utils.defer(),b=(new DialogBoxMorph).withKey("libraryNotes"),c=new ScrollFrameMorph,d=new TextMorph(""),e=b.ok,f=this.world();c.padding=6;c.setWidth(250);c.acceptsDrops=!1;c.contents.acceptsDrops=!1;d.setWidth(250-2*c.padding);d.setPosition(c.topLeft().add(c.padding));d.enableSelecting();d.isEditable=!0;c.setHeight(250);c.fixLayout=nop;c.edge=InputFieldMorph.prototype.edge;c.fontSize=InputFieldMorph.prototype.fontSize;c.typeInPadding=InputFieldMorph.prototype.typeInPadding;
c.contrast=InputFieldMorph.prototype.contrast;c.render=InputFieldMorph.prototype.render;c.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;c.addContents(d);b.ok=function(){a.resolve(d.text);e.call(this)};b.justDropped=function(){return d.edit()};b.labelString="Library Notes";b.createLabel();b.addBody(c);b.addButton("ok","OK");b.addButton("cancel","Cancel");b.fixLayout();b.popUp(f);b.setCenter(f.center());d.edit();return a.promise};
IDE_Morph.prototype.removeUnusedBlocks=function(){function a(){return c.filter(function(g){return contains(d,g)?!1:b.every(function(h,k){return!h.usesBlockInstance(g,!0,k,d)})})}for(var b=this.sprites.asArray().concat([this.stage]),c=this.stage.globalBlocks,d=[],e=!1,f;!e;)f=a(),f.length?d=d.concat(f):e=!0;0<d.length?(new BlockRemovalDialogMorph(d,this.stage)).popUp(this.world()):this.inform("Remove unused blocks","there are currently no unused\nglobal custom blocks in this project")};
IDE_Morph.prototype.exportSprite=function(a){var b=this.serializer.isSavingHistory;this.serializer.isSavingHistory=!1;var c=this.serializer.serialize(a.allParts());this.serializer.isSavingHistory=b;c='<sprites app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+c+"</sprites>";this.saveXMLAs(c,a.name)};
IDE_Morph.prototype.exportScriptsPicture=function(){var a=[],b=0,c=0,d=0;this.sprites.asArray().forEach(function(g){a.push(g.getImage());a.push(g.scripts.scriptsPicture());g.customBlocks.forEach(function(h){return a.push(h.scriptsPicture())})});a.push(this.stage.getImage());a.push(this.stage.scripts.scriptsPicture());this.stage.customBlocks.forEach(function(g){return a.push(g.scriptsPicture())});this.stage.globalBlocks.forEach(function(g){return a.push(g.scriptsPicture())});a=a.filter(function(g){return!isNil(g)});
a.forEach(function(g){b=Math.max(b,g.width);c+=g.height;c+=20});c-=20;var e=newCanvas(new Point(b,c));var f=e.getContext("2d");a.forEach(function(g){f.drawImage(g,0,d);d+=20;d+=g.height});this.saveCanvasAs(e,this.projectName||localize("Untitled"))};
IDE_Morph.prototype.exportProjectSummary=function(a){function b(q,p,t){p||(p=m);return new XML_Element(q,t,p)}function c(q,p,t){p||(p="p");t||(t=m);return new XML_Element(p,q,t)}function d(q,p,t){p||(p=m);t=t?null:b("p",p);p=b("img",t||p);p.attributes.src=q.toDataURL();return p}function e(q){var p=q.names().sort(),t=!0,r;p.length&&(c(localize("Variables"),"h3"),p.forEach(function(u){t&&(r=b("ul"),t=!1);var v=b("li",r);u=new WatcherMorph(u,SpriteMorph.prototype.blockColor.variables,q,u);var w=u.cellMorph.contentsMorph;
w instanceof ListWatcherMorph&&w.expand();d(u.fullImage(),v).attributes.class="script"}))}function f(q){q.length&&(c(localize("Blocks"),"h3"),SpriteMorph.prototype.categories.forEach(function(p){var t=!0,r;q.forEach(function(u){if(u.category===p){t&&(c(localize(p[0].toUpperCase().concat(p.slice(1))),"h4"),r=b("ul"),t=!1);var v=b("li",r);var w=d(u.templateInstance().scriptPic(),v);w.attributes.class="script";u.sortedElements().forEach(function(x){d(x instanceof BlockMorph?x.scriptPic():x.fullImage(),
v).attributes.class="script"})}})}))}var g=this.stage;var h=this.projectName||localize("untitled");var k=new XML_Element("html");k.attributes.lang=SnapTranslator.language;var l=b("head",k);b("meta",l).attributes.charset="UTF-8";b("style",l,a?"img {vertical-align: top;filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-webkit-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-ms-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}":"img {vertical-align: top;}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}.sprite {border: 1px solid lightgray;}");
c(h,"title",l);var m=b("body",k);c(h,"h1");0===location.hash.indexOf("#present:")?(c(location.toString(),"a",m).attributes.href=location.toString(),d(g.thumbnail(g.dimensions)).attributes.class="sprite",c(this.serializer.app,"h4")):(c(this.serializer.app,"h4"),d(g.thumbnail(g.dimensions)).attributes.class="sprite");Process.prototype.reportTextSplit(this.projectNotes,"line").asArray().forEach(function(q){return c(q)});c(localize("Contents"),"h4");var n=b("ul");this.sprites.asArray().concat([g]).forEach(function(q){var p=
b("li",n),t=q.scripts.sortedElements(),r=q.costumes.length();b("hr");d(q.thumbnail(new Point(40,40)),p,!0).attributes.class="toc";c(q.name,"a",p).attributes.href="#"+q.name;c(q.name,"h2").attributes.id=q.name;d(q.thumbnail(q.extent().divideBy(g.scale))).attributes.class="sprite";if(q instanceof SpriteMorph&&(q.exemplar&&(d(q.exemplar.thumbnail(new Point(40,40)),c(localize("Kind of")+" "+q.exemplar.name),!0).attributes.class="toc"),q.anchor&&(d(q.anchor.thumbnail(new Point(40,40)),c(localize("Part of")+
" "+q.anchor.name),!0).attributes.class="toc"),q.parts.length)){c(localize("Parts"),"h3");var u=b("ul");q.parts.forEach(function(v){var w=b("li",u,v.name);d(v.thumbnail(new Point(40,40)),w,!0).attributes.class="toc"})}if(1<r||q.getCostumeIdx()!==r)c(localize("Costumes"),"h3"),u=b("ol"),q.costumes.asArray().forEach(function(v){var w=b("li",u,v.name);d(v.thumbnail(new Point(40,40)),w,!0).attributes.class="toc"});q.sounds.length()&&(c(localize("Sounds"),"h3"),u=b("ol"),q.sounds.asArray().forEach(function(v){return c(v.name,
"li",u)}));e(q.variables);t.length&&(c(localize("Scripts"),"h3"),t.forEach(function(v){d(v instanceof BlockMorph?v.scriptPic():v.fullImage()).attributes.class="script"}));f(q.customBlocks)});a=g.globalVariables();if(Object.keys(a.vars).length||g.globalBlocks.length)b("hr"),c(localize("For all Sprites"),"a",b("li",n)).attributes.href="#global",c(localize("For all Sprites"),"h2").attributes.id="global",e(a),f(g.globalBlocks);this.saveFileAs("<!DOCTYPE html>"+k.toString(),"text/html;charset=utf-8",h)};
IDE_Morph.prototype.openProjectString=function(a){var b=this,c;this.exitReplayMode();this.nextSteps([function(){return c=b.showMessage("Opening project...")},function(){return SnapActions.openProject(a).then(function(){return c.destroy()})}])};
IDE_Morph.prototype.rawOpenProjectString=function(a){this.toggleAppMode(!1);this.spriteBar.tabBar.tabTo("scripts");StageMorph.prototype.hiddenPrimitives={};StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=!1;StageMorph.prototype.enableInheritance=!0;StageMorph.prototype.enableSublistIDs=!1;StageMorph.prototype.enablePenLogging=!1;Process.prototype.enableLiveCoding=!1;if(Process.prototype.isCatchingErrors)try{var b=this.serializer.openProject(this.serializer.load(a,
this),this)}catch(c){this.showMessage("Load failed: "+c)}else b=this.serializer.openProject(this.serializer.load(a,this),this);this.stopFastTracking();return b};IDE_Morph.prototype.openCloudDataString=function(a){var b=Math.round(a.length/1024);this.exitReplayMode();var c=this.showMessage("Opening project\n"+b+" KB...");return SnapActions.openProject(a).then(function(){return c.destroy()})};
IDE_Morph.prototype.rawOpenCloudDataString=function(a){StageMorph.prototype.hiddenPrimitives={};StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=!1;StageMorph.prototype.enableInheritance=!0;StageMorph.prototype.enableSublistIDs=!1;StageMorph.prototype.enablePenLogging=!1;Process.prototype.enableLiveCoding=!1;SnapActions.disableCollaboration();SnapUndo.reset();if(Process.prototype.isCatchingErrors)try{var b=this.serializer.parse(a);this.serializer.loadMediaModel(b.childNamed("media"));
var c=this.serializer.openProject(this.serializer.loadProjectModel(b.childNamed("project"),this,b.attributes.remixID),this)}catch(d){this.showMessage("Load failed: "+d)}else b=this.serializer.parse(a),this.serializer.loadMediaModel(b.childNamed("media")),c=this.serializer.openProject(this.serializer.loadProjectModel(b.childNamed("project"),this,b.attributes.remixID),this);this.stopFastTracking();return c};
IDE_Morph.prototype.uniqueIdForImport=function(a,b,c){var d=this;this.nextSteps([function(){nop()},function(){for(var e=d.serializer.parse(a),f=e.allChildren(),g=f.length;g--;)f[g].attributes&&(f[g].attributes.collabId=SnapActions.newId());c(e.toString())}])};IDE_Morph.prototype.openBlocksString=function(a,b,c){var d=this,e;this.nextSteps([function(){return e=d.showMessage("Opening blocks...")},function(){d.rawOpenBlocksString(a,b,c);e.destroy()}])};
IDE_Morph.prototype.rawOpenBlocksString=function(a,b,c){if(Process.prototype.isCatchingErrors)try{var d=this.serializer.loadBlocks(a,this.stage)}catch(e){this.showMessage("Load failed: "+e)}else d=this.serializer.loadBlocks(a,this.stage);c?this.importCustomBlocks(d,b):(new BlockImportDialogMorph(d,this.stage,b)).popUp();return d};
IDE_Morph.prototype.importCustomBlocks=function(a,b){var c=this;a.forEach(function(d){d.receiver=c.stage;c.stage.globalBlocks.push(d);c.stage.replaceDoubleDefinitionsFor(d)});this.flushPaletteCache();this.refreshPalette();this.showMessage("Imported Blocks Module"+(b?": "+b:"")+".",2);SnapActions.loadCustomBlocks(a)};IDE_Morph.prototype.openSpritesString=function(a){var b=this,c;this.nextSteps([function(){return c=b.showMessage("Opening sprite...")},function(){b.rawOpenSpritesString(a);c.destroy()}])};
IDE_Morph.prototype.rawOpenSpritesString=function(a){if(Process.prototype.isCatchingErrors)try{this.serializer.loadSprites(a,this)}catch(b){this.showMessage("Load failed: "+b)}else this.serializer.loadSprites(a,this)};IDE_Morph.prototype.openMediaString=function(a){if(Process.prototype.isCatchingErrors)try{this.serializer.loadMedia(a)}catch(b){this.showMessage("Load failed: "+b)}else this.serializer.loadMedia(a);this.showMessage("Imported Media Module.",2)};
IDE_Morph.prototype.openScriptString=function(a){var b=this,c;return new Promise(function(d){b.nextSteps([function(){return c=b.showMessage("Opening script...")},function(){var e=b.rawOpenScriptString(a);c.destroy();d(e)}])})};
IDE_Morph.prototype.rawOpenScriptString=function(a){if(Process.prototype.isCatchingErrors)try{var b=this.serializer.parse(a,this.currentSprite);var c=this.serializer.loadScript(b,this.currentSprite)}catch(d){this.showMessage("Load failed: "+d)}else b=this.serializer.loadScript(a,this.currentSprite),c=this.serializer.loadScript(b,this.currentSprite);return c};
IDE_Morph.prototype.openDataString=function(a,b,c){var d=this,e;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){if(1==f.nextAddress)return e=d.showMessage(localize("Opening data...")),f.yield(utils.sleep(),2);if(3!=f.nextAddress)return f.yield(d.rawOpenDataString(a,b,c),3);e.destroy();f.jumpToEnd()})};
IDE_Morph.prototype.rawOpenDataString=function(a,b,c){var d=this,e,f=this.currentSprite.globalVariables();switch(c){case "csv":var g=Process.prototype.parseCSV(a);break;case "json":g=Process.prototype.parseJSON(a);break;default:g=a}var h=function(k){var l=f.names(),m=k.indexOf("(");k=0>m?k:k.substring(0,m);m=1;for(var n=k;contains(l,n);)m+=1,n=k+"("+m+")";return n}(b||"data");return SnapActions.addVariable(h,!0).then(function(){f.setVar(h,g);d.currentSprite.toggleVariableWatcher(h,!0);d.flushBlocksCache("variables");
d.currentCategory="variables";d.categories.children.forEach(function(k){k.refresh()});d.refreshPalette(!0);g instanceof List&&(e=new TableDialogMorph(g),e.labelString=localize(e.labelString)+": "+h,e.createLabel(),e.popUp(d.world()))})};IDE_Morph.prototype.openProject=function(a){a&&(this.showMessage("opening project\n"+a),this.setProjectName(a),a=localStorage["-snap-project-"+a],SnapActions.disableCollaboration(),SnapUndo.reset(),this.openProjectString(a),this.setURL("#open:"+a))};
IDE_Morph.prototype.setURL=function(a){location.hash=this.projectsInURLs?a:""};
IDE_Morph.prototype.saveFileAs=function(a,b,c){var d=!1,e=this.world();var f=b.split("/")[1].split(";")[0];f="."+("plain"===f?"txt":f);try{d=!!new Blob}catch(h){}if(d){if(!(a instanceof Blob)){a=e=a;d=e.split(",");var g=0===e.indexOf("data:");if(g&&-1<d[0].indexOf("base64"))for(e=atob(d[1]),a=new Uint8Array(e.length),d=e.length;d--;)a[d]=e.charCodeAt(d);else if(g)for(e=e.replace(/^data:image\/.*?, */,""),a=new Uint8Array(e.length),d=e.length;d--;)a[d]=e.charCodeAt(d);a=new Blob([a],{type:b})}saveAs(a,
c+f,!1)}else b=new DialogBoxMorph,b.inform(localize("Could not export")+" "+c,"unable to export text",e),b.fixLayout()};IDE_Morph.prototype.saveCanvasAs=function(a,b){this.saveFileAs(a.toDataURL(),"image/png",b)};IDE_Morph.prototype.saveAudioAs=function(a,b){this.saveFileAs(a.src,"audio/wav",b)};IDE_Morph.prototype.saveXMLAs=function(a,b){this.saveFileAs(a,"text/xml;chartset=utf-8",b)};
IDE_Morph.prototype.switchToUserMode=function(){var a=this.world();a.isDevMode=!1;Process.prototype.isCatchingErrors=!0;this.controlBar.updateLabel();this.isAutoFill=!0;this.isDraggable=!1;this.reactToWorldResize(a.bounds.copy());this.siblings().forEach(function(b){b instanceof DialogBoxMorph?a.add(b):b.destroy()});this.flushBlocksCache();this.refreshPalette();a.reactToDropOf=function(b){b instanceof DialogBoxMorph||b instanceof MenuMorph||(a.hand.grabOrigin?b.slideBackTo(a.hand.grabOrigin):a.hand.grab(b))};
this.showMessage("entering user mode",1)};IDE_Morph.prototype.switchToDevMode=function(){var a=this.world();a.isDevMode=!0;Process.prototype.isCatchingErrors=!1;this.controlBar.updateLabel();this.isAutoFill=!1;this.isDraggable=!0;this.setExtent(a.extent().subtract(100));this.setPosition(a.position().add(20));this.flushBlocksCache();this.refreshPalette();delete a.reactToDropOf;this.showMessage("entering development mode.\n\nerror catching is turned off,\nuse the browser's web console\nto see error messages.")};
IDE_Morph.prototype.flushBlocksCache=function(a){a?(this.stage.blocksCache[a]=null,this.stage.children.forEach(function(b){b instanceof SpriteMorph&&(b.blocksCache[a]=null)})):(this.stage.blocksCache={},this.stage.children.forEach(function(b){b instanceof SpriteMorph&&(b.blocksCache={})}));this.flushPaletteCache(a)};
IDE_Morph.prototype.flushPaletteCache=function(a){a?(this.stage.paletteCache[a]=null,this.stage.children.forEach(function(b){b instanceof SpriteMorph&&(b.paletteCache[a]=null)})):(this.stage.paletteCache={},this.stage.children.forEach(function(b){b instanceof SpriteMorph&&(b.paletteCache={})}))};
IDE_Morph.prototype.toggleZebraColoring=function(){var a=[];BlockMorph.prototype.zebraContrast=BlockMorph.prototype.zebraContrast?0:40;this.stage.children.concat(this.stage).forEach(function(b){isSnapObject(b)&&(a=a.concat(b.scripts.children.filter(function(c){return c instanceof BlockMorph})))});a.forEach(function(b){return b.fixBlockColor(null,!0)})};
IDE_Morph.prototype.toggleDynamicInputLabels=function(){SyntaxElementMorph.prototype.dynamicInputLabels=!SyntaxElementMorph.prototype.dynamicInputLabels;if(Process.prototype.isCatchingErrors)try{var a=this.serializer.serialize(this.stage)}catch(b){this.showMessage("Serialization failed: "+b)}else a=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks();this.spriteBar.tabBar.tabTo("scripts");this.createCategories();this.createCorralBar();SnapUndo.reset();this.openProjectString(a)};
IDE_Morph.prototype.toggleBlurredShadows=function(){window.useBlurredShadows=!useBlurredShadows};IDE_Morph.prototype.toggleLongFormInputDialog=function(){InputSlotDialogMorph.prototype.isLaunchingExpanded=!InputSlotDialogMorph.prototype.isLaunchingExpanded;InputSlotDialogMorph.prototype.isLaunchingExpanded?this.saveSetting("longform",!0):this.removeSetting("longform")};
IDE_Morph.prototype.togglePlainPrototypeLabels=function(){BlockLabelPlaceHolderMorph.prototype.plainLabel=!BlockLabelPlaceHolderMorph.prototype.plainLabel;BlockLabelPlaceHolderMorph.prototype.plainLabel?this.saveSetting("plainprototype",!0):this.removeSetting("plainprototype")};IDE_Morph.prototype.togglePreferEmptySlotDrops=function(){ScriptsMorph.prototype.isPreferringEmptySlots=!ScriptsMorph.prototype.isPreferringEmptySlots};
IDE_Morph.prototype.toggleVirtualKeyboard=function(){MorphicPreferences.useVirtualKeyboard=!MorphicPreferences.useVirtualKeyboard};IDE_Morph.prototype.toggleInputSliders=function(){MorphicPreferences.useSliderForInput=!MorphicPreferences.useSliderForInput};IDE_Morph.prototype.toggleSliderExecute=function(){ArgMorph.prototype.executeOnSliderEdit=!ArgMorph.prototype.executeOnSliderEdit};
IDE_Morph.prototype.setEmbedMode=function(){var a=this;this.isEmbedMode=!0;this.appModeColor=new Color(243,238,235);this.embedOverlay=new Morph;this.embedOverlay.color=new Color(128,128,128);this.embedOverlay.alpha=.5;this.embedPlayButton=new SymbolMorph("circleSolid");this.embedPlayButton.color=new Color(64,128,64);this.embedPlayButton.alpha=.75;this.embedPlayButton.flag=new SymbolMorph("flag");this.embedPlayButton.flag.color=new Color(128,255,128);this.embedPlayButton.flag.alpha=.75;this.embedPlayButton.add(this.embedPlayButton.flag);
this.embedPlayButton.mouseClickLeft=function(){a.runScripts();a.embedOverlay.destroy();this.destroy()};this.controlBar.hide();this.add(this.embedOverlay);this.add(this.embedPlayButton);this.fixLayout()};
IDE_Morph.prototype.toggleAppMode=function(a){var b=this.world(),c=[this.logo,this.controlBar.cloudButton,this.controlBar.projectButton,this.controlBar.settingsButton,this.controlBar.steppingButton,this.controlBar.stageSizeButton,this.paletteHandle,this.stageHandle,this.corral,this.corralBar,this.spriteEditor,this.spriteBar,this.palette,this.categories];(this.isAppMode=isNil(a)?!this.isAppMode:a)?((this.wasSingleStepping=Process.prototype.enableSingleStepping)&&this.toggleSingleStepping(),this.setColor(this.appModeColor),
this.controlBar.setColor(this.color),this.controlBar.appModeButton.refresh(),c.forEach(function(d){return d.hide()}),b.children.forEach(function(d){d instanceof DialogBoxMorph&&d.hide()}),b.keyboardFocus instanceof ScriptFocusMorph&&b.keyboardFocus.stopEditing()):(this.wasSingleStepping&&!Process.prototype.enableSingleStepping&&this.toggleSingleStepping(),this.setColor(this.backgroundColor),this.controlBar.setColor(this.frameColor),c.forEach(function(d){return d.show()}),this.stage.setScale(1),b.children.forEach(function(d){d instanceof
DialogBoxMorph&&d.show()}),b.allChildren().filter(function(d){return d instanceof ScrollFrameMorph}).forEach(function(d){return d.adjustScrollBars()}),this.currentSprite===this.stage&&this.spriteBar.children.forEach(function(d){d instanceof PushButtonMorph&&d.hide()}),this.currentSprite.scripts.updateToolbar());this.setExtent(this.world().extent());this.isMobileDevice()&&this.isAppMode&&this.mobileMode.init()};
IDE_Morph.prototype.toggleStageSize=function(a,b){function c(){e.isSmallStage=isNil(a)?!e.isSmallStage:a}function d(k){e.isSmallStage=!0;g.animations.push(new Animation(function(l){e.stageRatio=l;e.setExtent(g.extent())},function(){return e.stageRatio},k-e.stageRatio,f,null,function(){e.isSmallStage=1!==k;e.controlBar.stageSizeButton.refresh()}))}var e=this;b=b||.5;var f=this.isAnimating?100:0,g=this.world(),h=18===g.currentKey;16===g.currentKey?(b=3*SpriteIconMorph.prototype.thumbSize.x/this.stage.dimensions.x,
this.isSmallStage&&b!==this.stageRatio||c()):h?(b=this.width()/2/this.stage.dimensions.x,this.isSmallStage&&b!==this.stageRatio||c()):c();this.isSmallStage?d(b):d(1)};IDE_Morph.prototype.setPaletteWidth=function(a){var b=this,c=this.isAnimating?100:0,d=this.world();d.animations.push(new Animation(function(e){b.paletteWidth=e;b.setExtent(d.extent())},function(){return b.paletteWidth},a-this.paletteWidth,c))};
IDE_Morph.prototype.createNewProject=function(){var a=this;this.confirm("Replace the current project with a new one?","New Project",function(){a.exitReplayMode();SnapActions.disableCollaboration();SnapUndo.reset();a.newProject()})};IDE_Morph.prototype.openProjectsBrowser=function(){"file:"===location.protocol?this.importLocalFile():(new ProjectDialogMorph(this,"open")).popUp(this.world())};
IDE_Morph.prototype.saveProjectsBrowser=function(){var a=this;"file:"===location.protocol?this.prompt("Export Project As...",function(b){return a.exportProject(b,!1)},null,"exportProject"):("examples"===this.source&&(this.source=null),(new ProjectDialogMorph(this,"save")).popUp(this.world()))};
IDE_Morph.prototype.microphoneMenu=function(){var a=new MenuMorph(this),b=this.world(),c=this.controlBar.settingsButton.bottomLeft(),d=this.stage.microphone,e=new SymbolMorph("tick",.75*MorphicPreferences.menuFontSize),f=new SymbolMorph("checkedBox",.75*MorphicPreferences.menuFontSize),g=e.fullCopy();g.render=nop;d.isReady&&(a.addItem([f,localize("Microphone")],function(){return d.stop()}),a.addLine());["low","normal","high","max"].forEach(function(h,k){a.addItem([d.resolution===k+1?e:g,localize(h)],
function(){return d.setResolution(k+1)})});a.popup(b,c)};IDE_Morph.prototype.languageMenu=function(){var a=this,b=new MenuMorph(this),c=this.world(),d=this.controlBar.settingsButton.bottomLeft(),e=new SymbolMorph("tick",.75*MorphicPreferences.menuFontSize),f=e.fullCopy();f.render=nop;SnapTranslator.languages().forEach(function(g){return b.addItem([SnapTranslator.language===g?e:f,SnapTranslator.languageName(g)],function(){a.loadNewProject=!1;a.setLanguage(g)})});b.popup(c,d)};
IDE_Morph.prototype.setLanguage=function(a,b,c){var d=this,e=document.getElementById("language"),f=this.resourceURL("locale","lang-"+a+".js");SnapTranslator.unload();e&&document.head.removeChild(e);if("en"===a)return this.reflectLanguage("en",b,c);e=document.createElement("script");e.id="language";e.onload=function(){return d.reflectLanguage(a,b,c)};document.head.appendChild(e);e.src=f};
IDE_Morph.prototype.reflectLanguage=function(a,b,c){var d=location.hash;SnapTranslator.language=a;if(!this.loadNewProject)if(Process.prototype.isCatchingErrors)try{var e=this.serializer.serialize(this.stage)}catch(f){this.showMessage("Serialization failed: "+f)}else e=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks();this.spriteBar.tabBar.tabTo("scripts");this.createCategories();this.createCorralBar();this.fixLayout();this.loadNewProject?(this.newProject(),location.hash=d):
(SnapUndo.reset(),this.openProjectString(e));c||this.saveSetting("language",a);b&&b.call(this)};
IDE_Morph.prototype.userSetBlocksScale=function(){var a=this;var b=new CommandBlockMorph;b.color=SpriteMorph.prototype.blockColor.motion;b.setSpec(localize("build"));var c=new CommandBlockMorph;c.color=SpriteMorph.prototype.blockColor.sound;c.setSpec(localize("your own"));b.nextBlock(c);c=new CommandBlockMorph;c.color=SpriteMorph.prototype.blockColor.operators;c.setSpec(localize("blocks"));b.bottomBlock().nextBlock(c);c=new FrameMorph;c.acceptsDrops=!1;c.color=IDE_Morph.prototype.groupColor;.8<SyntaxElementMorph.prototype.alpha&&
(c.cachedTexture=this.scriptsPaneTexture);c.setExtent(new Point(250,180));b.setPosition(c.position().add(10));c.add(b);var d=new Morph;d.alpha=0;d.setExtent(c.extent());d.setPosition(c.position());c.add(d);d=(new DialogBoxMorph(null,function(e){return a.setBlocksScale(Math.min(e,12))})).withKey("zoomBlocks");MorphicPreferences.isTouchDevice&&(d.isDraggable=!1);d.prompt("Zoom blocks",SyntaxElementMorph.prototype.scale.toString(),this.world(),c,{"normal (1x)":1,"demo (1.2x)":1.2,"presentation (1.4x)":1.4,
"big (2x)":2,"huge (4x)":4,"giant (8x)":8,"monstrous (10x)":10},!1,!0,1,5,function(e){b.blockSequence().forEach(function(f){f.setScale(e);f.setSpec(f.blockSpec)});b.fullChanged()})};
IDE_Morph.prototype.setBlocksScale=function(a){if(Process.prototype.isCatchingErrors)try{var b=this.serializer.serialize(this.stage)}catch(c){this.showMessage("Serialization failed: "+c)}else b=this.serializer.serialize(this.stage);SyntaxElementMorph.prototype.setScale(a);CommentMorph.prototype.refreshScale();SpriteMorph.prototype.initBlocks();this.spriteBar.tabBar.tabTo("scripts");this.createCategories();this.createCorralBar();this.fixLayout();this.openProjectString(b);this.saveSetting("zoom",a)};
IDE_Morph.prototype.userFadeBlocks=function(){var a=this,b=100-100*SyntaxElementMorph.prototype.alpha;var c=(new DialogBoxMorph(null,function(d){return a.setBlockTransparency(d,!0)})).withKey("fadeBlocks");MorphicPreferences.isTouchDevice&&(c.isDraggable=!1);c.cancel=function(){a.setBlockTransparency(b);c.destroy()};c.prompt("Fade blocks",b.toString(),this.world(),null,{"block-solid (0)":0,"medium (50)":50,"light (70)":70,"shimmering (80)":80,"elegant (90)":90,"subtle (95)":95,"text-only (100)":100},
!1,!0,0,100,function(d){return a.setBlockTransparency(d)},0)};IDE_Morph.prototype.setBlockTransparency=function(a,b){SyntaxElementMorph.prototype.setAlphaScaled(100-a);this.changed();b&&(0===a?this.removeSetting("fade"):this.saveSetting("fade",a))};IDE_Morph.prototype.userSetStageSize=function(){(new DialogBoxMorph(this,function(a){SnapActions.setStageSize(a.x,a.y)},this)).promptVector("Stage size",StageMorph.prototype.dimensions,new Point(480,360),"Stage width","Stage height",this.world(),null,null)};
IDE_Morph.prototype.setStageExtent=function(a){function b(){c.step=function(){var f=e.subtract(StageMorph.prototype.dimensions).divideBy(2);f.abs().lt(new Point(5,5))?(StageMorph.prototype.dimensions=e,delete c.step):StageMorph.prototype.dimensions=StageMorph.prototype.dimensions.add(f);c.stage.setExtent(StageMorph.prototype.dimensions);c.stage.clearPenTrails();c.fixLayout();this.setExtent(d.extent())}}var c=this,d=this.world(),e=a.max(new Point(240,180));this.stageRatio=1;this.isSmallStage=!1;this.controlBar.stageSizeButton.refresh();
this.stage.stopVideo();this.setExtent(d.extent());this.isAnimating?b():(StageMorph.prototype.dimensions=e,this.stage.setExtent(StageMorph.prototype.dimensions),this.stage.clearPenTrails(),this.fixLayout(),this.setExtent(d.extent()))};IDE_Morph.prototype.userSetDragThreshold=function(){(new DialogBoxMorph(this,function(a){return MorphicPreferences.grabThreshold=Math.min(Math.max(+a,0),200)},this)).prompt("Dragging threshold",MorphicPreferences.grabThreshold.toString(),this.world(),null,null,null,!0)};
IDE_Morph.prototype.initializeCloudWithSnap=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(c){var d,e,f,g,h;return $jscomp.asyncExecutePromiseGeneratorProgram(function(k){if(1==k.nextAddress)return k.setCatchFinallyBlocks(2),k.yield(a.cloud.login(c.username.toLowerCase(),c.password,c.choice,"Snap!"),4);if(2!=k.nextAddress)return a.controlBar.cloudButton.refresh(),a.source="cloud",d=a.cloud,e=d.username,f=d.strategy,g=localize("Logged in as ")+e,f&&(g+=" (using "+f+")"),a.showMessage(g,
2),k.leaveTryBlock(0);h=k.enterCatchBlock();a.cloudError()(h.message);k.jumpToEnd()})})).withKey("cloudlogin").promptCredentials("Sign in with Snap!","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",b,this.cloudIcon(),this.cloudMsg)};
IDE_Morph.prototype.initializeCloud=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(c){var d,e,f,g,h;return $jscomp.asyncExecutePromiseGeneratorProgram(function(k){if(1==k.nextAddress)return k.setCatchFinallyBlocks(2),d=hex_sha512(c.password),k.yield(a.cloud.login(c.username,d,c.choice),4);if(2!=k.nextAddress)return e=a.cloud,f=e.username,sessionStorage.username=f,a.controlBar.cloudButton.refresh(),a.source="cloud",Services.fetchHosts(),g=localize("Logged in as ")+f,a.showMessage(g,
2),k.leaveTryBlock(0);h=k.enterCatchBlock();a.cloudError()(h.message);k.jumpToEnd()})})).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",b,this.cloudIcon(),this.cloudMsg)};
IDE_Morph.prototype.createCloudAccount=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(c){return a.cloud.signup(c.username,c.password,c.passwordRepeat,c.email,function(d,e){return(new DialogBoxMorph).inform(e,d+".\n\nYou can now log in.",b,a.cloudIcon(null,new Color(0,180,0)))},a.cloudError())})).withKey("cloudsignup").promptCredentials("Sign up","signup","https://snap.berkeley.edu/tos.html","Terms of Service...","https://snap.berkeley.edu/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",
b,this.cloudIcon(),this.cloudMsg)};IDE_Morph.prototype.promptExitReplay=function(a){var b=this;this.confirm("The given action cannot be applied while in replay mode. \nWould you like to exit replay mode?","Exit Replay?",function(){b.exitReplayMode();a()})};
IDE_Morph.prototype.resetCloudPassword=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(c){return a.cloud.resetPassword(c.username,function(d,e){return(new DialogBoxMorph).inform(e,d+"\n\nAn e-mail with a link to\nreset your password\nhas been sent to the address provided",b,a.cloudIcon(null,new Color(0,180,0)))},a.cloudError())})).withKey("cloudresetpassword").promptCredentials("Reset password","resetPassword",null,null,null,null,null,b,this.cloudIcon(),this.cloudMsg)};
IDE_Morph.prototype.resendVerification=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(c){return a.cloud.resendVerification(c.username,function(d,e){return(new DialogBoxMorph).inform(e,d,b,a.cloudIcon(null,new Color(0,180,0)))},a.cloudError())})).withKey("cloudresendverification").promptCredentials("Resend verification email","resendVerification",null,null,null,null,null,b,this.cloudIcon(),this.cloudMsg)};
IDE_Morph.prototype.changeCloudPassword=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(c){return a.cloud.changePassword(c.oldpassword,c.password,function(){return a.showMessage("password has been changed.",2)},a.cloudError())})).withKey("cloudpassword").promptCredentials("Change Password","changePassword",null,null,null,null,null,b,this.cloudIcon(),this.cloudMsg)};
IDE_Morph.prototype.logout=function(){var a=this;this.cloud.logout(function(){delete sessionStorage.username;a.controlBar.cloudButton.refresh();a.showMessage("disconnected.",2)},function(){delete sessionStorage.username;a.controlBar.cloudButton.refresh();a.showMessage("disconnected.",2)})};
IDE_Morph.prototype.buildProjectRequest=function(){var a=this.serializer.serialize(this.stage),b=normalizeCanvas(this.stage.thumbnail(SnapSerializer.prototype.thumbnailSize)).toDataURL();this.serializer.isCollectingMedia=!0;a={notes:this.projectNotes,xml:a,media:this.hasChangedMedia?this.serializer.mediaXML(this.projectName):null,thumbnail:b,remixID:this.stage.remixID};this.serializer.isCollectingMedia=!1;this.serializer.flushMedia();return a};
IDE_Morph.prototype.verifyProject=function(a){var b=JSON.stringify(a);if(b.length>Cloud.MAX_FILE_SIZE)return(new DialogBoxMorph).inform("Snap!Cloud - Cannot Save Project","The media inside this project exceeds 10 MB.\nPlease reduce the size of costumes or sounds.\n",this.world(),this.cloudIcon(null,new Color(180,0,0))),!1;try{this.serializer.parse(a.xml)}catch(c){return this.showMessage("Serialization of program data failed:\n"+c),!1}if(null!==a.media)try{this.serializer.parse(a.media)}catch(c){return this.showMessage("Serialization of media failed:\n"+
c),!1}this.serializer.isCollectingMedia=!1;this.serializer.flushMedia();return b.length};IDE_Morph.prototype.saveProjectToCloud=function(a){var b=this,c=this.room.hasMultipleRoles()?this.room.getCurrentRoleName():this.room.name;a&&(this.showMessage("Saving "+c+"\nto the cloud..."),this.room.name=a,SnapCloud.saveProject(this,function(d){d.name&&b.room.silentSetRoomName(d.name);b.showMessage("Saved "+c+" to the cloud!",2)},this.cloudSaveError()))};
IDE_Morph.prototype.exportProjectMedia=function(a){this.serializer.isCollectingMedia=!0;if(a){this.setProjectName(a);try{var b=this.showMessage("Exporting");var c=this.serializer.mediaXML(a);this.saveXMLAs(c,this.projectName+" media");b.destroy();this.showMessage("Exported!",1)}catch(d){if(Process.prototype.isCatchingErrors)this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+d);else throw d;}}this.serializer.isCollectingMedia=!1;this.serializer.flushMedia()};
IDE_Morph.prototype.exportProjectNoMedia=function(a){this.serializer.isCollectingMedia=!0;if(a)if(this.setProjectName(a),Process.prototype.isCatchingErrors)try{var b=this.showMessage("Exporting");var c=this.serializer.serialize(this.stage);this.saveXMLAs(c,this.projectName);b.destroy();this.showMessage("Exported!",1)}catch(d){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+d)}else b=this.showMessage("Exporting"),c=this.serializer.serialize(this.stage),this.saveXMLAs(c,this.projectName),
b.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1;this.serializer.flushMedia()};
IDE_Morph.prototype.exportProjectAsCloudData=function(a){this.serializer.isCollectingMedia=!0;if(a)if(this.setProjectName(a),Process.prototype.isCatchingErrors)try{var b=this.showMessage("Exporting");var c=this.serializer.serialize(this.stage);this.serializer.mediaXML(a);this.serializer.replayHistory();this.saveXMLAs(c,this.projectName);b.destroy();this.showMessage("Exported!",1)}catch(d){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+d)}else b=this.showMessage("Exporting"),
c=this.serializer.serialize(this.stage),this.serializer.mediaXML(a),this.serializer.replayHistory(),this.saveXMLAs(c,this.projectName),b.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1;this.serializer.flushMedia()};IDE_Morph.prototype.cloudAcknowledge=function(){var a=this;return function(b,c){nop(b);(new DialogBoxMorph).inform("Cloud Connection","Successfully connected to:\nhttp://"+c,a.world(),a.cloudIcon(null,new Color(0,180,0)))}};
IDE_Morph.prototype.cloudResponse=function(){var a=this;return function(b,c){50<b.length&&(b=b.substring(0,50)+"...");(new DialogBoxMorph).inform("Snap!Cloud","http://"+c+":\n\nresponds:\n"+b,a.world(),a.cloudIcon(null,new Color(0,180,0)))}};IDE_Morph.prototype.cloudError=function(){var a=this;return function(b,c){a.shield&&(a.shield.destroy(),a.shield=null);(new DialogBoxMorph).inform("NetsBlox Cloud",(c?c+"\n":"")+b,a.world(),a.cloudIcon(null,new Color(180,0,0)))}};
IDE_Morph.prototype.cloudIcon=function(a,b){b=b||DialogBoxMorph.prototype.titleBarColor;var c=MorphicPreferences.isFlat;a=new SymbolMorph(c?"cloud":"cloudGradient",a||50,b,c?null:new Point(-1,-1),b.darker(50));c||a.addShadow(new Point(1,1),1,b.lighter(95));return a};
IDE_Morph.prototype.setCloudURL=function(){var a=this;(new DialogBoxMorph(null,function(b){a.cloud.url=b;a.cloud.checkCredentials(function(){return a.controlBar.cloudButton.refresh()},function(){return a.controlBar.cloudButton.refresh()})})).withKey("cloudURL").prompt("Cloud URL",this.cloud.url,this.world(),null,this.cloud.knownDomains)};IDE_Morph.prototype.urlParameters=function(){var a=location.hash.slice(location.hash.indexOf(":")+1);return this.cloud.parseDict(a)};
IDE_Morph.prototype.hasCloudProject=function(){var a=this.urlParameters();return a.hasOwnProperty("Username")&&a.hasOwnProperty("ProjectName")};
IDE_Morph.prototype.getURL=function(a,b,c){var d=this,e=new XMLHttpRequest,f=b instanceof Function;f&&(e.responseType=c||"text");var g=f&&"text"!==e.responseType?"response":"responseText";try{if(e.open("GET",a,f),f&&(e.onreadystatechange=function(){if(4===e.readyState)if(e[g])b.call(d,e[g]);else throw d.showMessage("unable to retrieve "+a),Error("unable to retrieve "+a);}),e.send(),!f){if(200===e.status)return e[g];throw Error("unable to retrieve "+a);}}catch(h){if(this.showMessage(h.toString()),
f)b.call(this);else return e[g]}};IDE_Morph.prototype.showMessage=function(a,b){var c=new MenuMorph(null,a),d;c.popUpCenteredInWorld(this.world());b&&(d=setInterval(function(){c.destroy();clearInterval(d)},1E3*b));return c};IDE_Morph.prototype.inform=function(a,b){(new DialogBoxMorph).inform(a,localize(b),this.world())};
IDE_Morph.prototype.confirm=function(a,b,c){var d=!c;if(d){var e=utils.defer();c=e.resolve.bind(null,!0)}var f=new DialogBoxMorph(null,c);f.askYesNo(b,localize(a),this.world());if(d)return f.cancel=function(){e.resolve(!1);f.destroy()},e.promise};IDE_Morph.prototype.prompt=function(a,b,c,d){(new DialogBoxMorph(null,b)).withKey(d).prompt(a,"",this.world(),null,c)};
IDE_Morph.prototype.warnAboutIE=function(){if(this.isIE()){var a=new DialogBoxMorph;var b=new TextMorph("Please do not use Internet Explorer.\nSnap! runs best in a web-standards\ncompliant browser",a.fontSize,a.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE);a.key="IE-Warning";a.labelString="Internet Explorer";a.createLabel();a.addBody(b);a.fixLayout();a.popUp(this.world())}};
IDE_Morph.prototype.isIE=function(){var a=navigator.userAgent;return-1<a.indexOf("MSIE ")||-1<a.indexOf("Trident/")};SaveOpenDialogMorphSource.prototype.constructor=SaveOpenDialogMorphSource;function SaveOpenDialogMorphSource(a,b,c){this.init(a,b,c)}SaveOpenDialogMorphSource.prototype.init=function(a,b,c){this.name=a;this.icon=b;this.id=c||a.toLowerCase()};SaveOpenDialogMorphSource.prototype.canPublish=function(){return this.can("publish")};SaveOpenDialogMorphSource.prototype.canDelete=function(){return this.can("delete")};
SaveOpenDialogMorphSource.prototype.can=function(a){return this[a]!==SaveOpenDialogMorphSource.prototype[a]};SaveOpenDialogMorphSource.prototype.delete=function(){throw Error(localize("Cannot delete projects from the ")+localize(this.name));};SaveOpenDialogMorphSource.prototype.publish=function(){throw Error(localize("Cannot publish projects to the ")+localize(this.name));};
SaveOpenDialogMorphSource.prototype.save=function(){throw Error(localize("Cannot save projects to the ")+localize(this.name));};SaveOpenDialogMorphSource.prototype.getPreview=function(){throw Error(localize("Cannot get project preview from the ")+localize(this.name));};SaveOpenDialogMorphSource.prototype.getContent=function(){throw Error(localize("Cannot get content from the ")+localize(this.name));};SaveOpenDialogMorph.prototype=new DialogBoxMorph;SaveOpenDialogMorph.prototype.constructor=SaveOpenDialogMorph;
SaveOpenDialogMorph.uber=DialogBoxMorph.prototype;function SaveOpenDialogMorph(){}
SaveOpenDialogMorph.prototype.init=function(a,b,c,d,e){var f=this,g=this;this.task=a||"open";this.sources=c.filter(function(h){return h.can(f.task)});this.source=d||this.sources[0];this.itemsList=[];this.itemName=b;this.recoverButton=this.unpublishButton=this.publishButton=this.unshareButton=this.shareButton=this.deleteButton=this.notesField=this.notesText=this.preview=this.listField=this.magnifyingGlass=this.filterField=this.nameField=this.srcBar=this.handle=null;SaveOpenDialogMorph.uber.init.call(this,
this,null,null);this.labelString="save"===this.task?"Save "+b:"Open "+b;this.createLabel();this.key=a+b;this.buildContents(e);this.onNextStep=function(){g.setSource(g.source)}};
SaveOpenDialogMorph.prototype.buildContents=function(a){var b=this,c=new Point(455,146);this.addBody(new Morph);this.body.color=this.color;this.srcBar=new AlignmentMorph("column",this.padding/2);this.sources.forEach(function(d){d=b.addSourceButton(d);c.y+=d.height()});c.y=Math.max(c.y,335);"open"===this.task&&this.buildFilterField();this.srcBar.fixLayout();this.body.add(this.srcBar);"save"===this.task&&(this.nameField=new InputFieldMorph(a.name),this.body.add(this.nameField));this.listField=new ListMorph([]);
this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.render=InputFieldMorph.prototype.render;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.body.add(this.listField);this.initPreview();this.notesField=new ScrollFrameMorph;
this.notesField.fixLayout=nop;this.notesField.edge=InputFieldMorph.prototype.edge;this.notesField.fontSize=InputFieldMorph.prototype.fontSize;this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.notesField.contrast=InputFieldMorph.prototype.contrast;this.notesField.render=InputFieldMorph.prototype.render;this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.notesField.acceptsDrops=!1;this.notesField.contents.acceptsDrops=!1;"open"===this.task?this.notesText=
new TextMorph(""):(this.notesText=new TextMorph(a.notes),this.notesText.isEditable=!0,this.notesText.enableSelecting());this.notesField.isTextLineWrapping=!0;this.notesField.padding=3;this.notesField.setContents(this.notesText);this.notesField.setWidth(this.preview.width());this.body.add(this.notesField);"open"===this.task?(this.addButton("openItem","Open"),this.action="openItem"):(this.addButton("trySaveItem","Save"),this.action="trySaveItem");this.shareButton=this.addButton("shareItem","Share");
this.unshareButton=this.addButton("unshareItem","Unshare");this.shareButton.hide();this.unshareButton.hide();this.deleteButton=this.addButton("deleteItem","Delete");this.addButton("cancel","Cancel");this.setExtent(c);this.fixLayout()};
SaveOpenDialogMorph.prototype.deleteItem=function(){var a=this,b,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){if(1==d.nextAddress)return(b=a.listField.selected)?d.yield(a.ide.confirm(localize("Are you sure you want to delete")+'\n"'+b.name+'"?',"Delete "+a.itemName),3):d.jumpTo(0);if(5!=d.nextAddress)return(c=d.yieldResult)?d.yield(a.source.delete(b),5):d.jumpTo(0);a.setSource(a.source);return d.return(b)})};
SaveOpenDialogMorph.prototype.shareItem=function(){var a=this,b,c,d,e;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){switch(f.nextAddress){case 1:b=a.listField.selected;c=a.listField.active;if(!b){f.jumpTo(0);break}return f.yield(a.ide.confirm(localize("Are you sure you want to publish")+'\n"'+b.name+'"?',"Share "+a.itemName),3);case 3:d=f.yieldResult;if(!d){f.jumpTo(0);break}a.ide.showMessage("sharing\n"+a.itemName.toLowerCase()+"...");f.setCatchFinallyBlocks(5);return f.yield(a.source.publish(b),
7);case 7:return b.public=!0,a.unshareButton.show(),a.shareButton.hide(),c.label.isBold=!0,c.label.rerender(),a.buttons.fixLayout(),a.rerender(),a.ide.showMessage("shared.",2),f.return(b);case 5:e=f.enterCatchBlock(),a.ide.cloudError().call(null,e.label,e.message),f.jumpToEnd()}})};
SaveOpenDialogMorph.prototype.unshareItem=function(){var a=this,b,c,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){if(1==e.nextAddress)return b=a.listField.selected,c=a.listField.active,b?e.yield(a.ide.confirm(localize("Are you sure you want to unpublish")+'\n"'+b.name+'"?',"Unshare "+a.itemName),3):e.jumpTo(0);if(5!=e.nextAddress){d=e.yieldResult;if(!d)return e.jumpTo(0);a.ide.showMessage("unsharing\n"+a.itemName.toLowerCase()+"...");return e.yield(a.source.publish(b,!0),5)}b.public=
!1;a.shareButton.show();a.unshareButton.hide();c.label.isBold=!1;c.label.rerender();a.buttons.fixLayout();a.rerender();a.ide.showMessage("unshared.",2);return e.return(b)})};SaveOpenDialogMorph.prototype.openItem=function(){var a=this,b;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){if(1==c.nextAddress)return(b=a.listField.selected)?c.yield(a.source.open(b),3):c.jumpTo(0);a.destroy();c.jumpToEnd()})};
SaveOpenDialogMorph.prototype.trySaveItem=function(){var a=this,b,c,d,e,f,g,h;return $jscomp.asyncExecutePromiseGeneratorProgram(function(k){switch(k.nextAddress){case 1:b={name:a.nameField.contents().text.text,notes:a.notesText.text};c=detect(a.itemsList,function(l){return l.name===b.name});d=localize(a.source.name.toLowerCase());e=localize("Saving "+a.itemName.toLowerCase()+"\nto the ")+d+"...";f=localize("Saved to the ")+d+"!";g=!0;if(!c){k.jumpTo(2);break}a.ide.showMessage(e);return k.yield(a.ide.confirm(localize("Are you sure you want to replace")+
'\n"'+b.name+'"?',"Replace "+a.itemName),3);case 3:g=k.yieldResult;case 2:if(!g){k.jumpTo(0);break}k.setCatchFinallyBlocks(5);a.ide.showMessage(e);return k.yield(a.saveItem(b),7);case 7:a.ide.showMessage(f,2);a.destroy();k.leaveTryBlock(6);break;case 5:h=k.enterCatchBlock(),a.ide.cloudError().call(null,h.label,h.message);case 6:return k.return(b)}})};
SaveOpenDialogMorph.prototype.saveItem=function(a){var b=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){return c.yield(b.source.save(a),0)})};SaveOpenDialogMorph.prototype.initPreview=function(){throw Error("Action not supported!");};
SaveOpenDialogMorph.prototype.addSourceButton=function(a){var b=this,c=localize(a.name),d=a.icon,e=new StringMorph(c,10,null,!0,null,null,new Point(1,1),WHITE);c=new StringMorph(c,10,null,!0,null,null,new Point(-1,-1),this.titleBarColor.darker(50),WHITE);var f=new Morph,g=new Morph;e.add(new SymbolMorph(d,24,this.titleBarColor.darker(20),new Point(1,1),this.titleBarColor.darker(50)));e.children[0].setCenter(e.center());e.children[0].setBottom(e.top()-this.padding/2);f.isCachingImage=!0;f.cachedImage=
e.fullImage();f.bounds=e.fullBounds();c.add(new SymbolMorph(d,24,WHITE,new Point(-1,-1),this.titleBarColor.darker(50)));c.children[0].setCenter(c.center());c.children[0].setBottom(c.top()-this.padding/2);g.isCachingImage=!0;g.cachedImage=c.fullImage();g.bounds=c.fullBounds();d=new ToggleButtonMorph(null,this,function(){return b.setSource(a)},[f,g],function(){return b.source===a});d.corner=this.buttonCorner;d.edge=this.buttonEdge;d.outline=this.buttonOutline;d.outlineColor=this.buttonOutlineColor;
d.outlineGradient=this.buttonOutlineGradient;d.labelMinExtent=new Point(60,0);d.padding=this.buttonPadding;d.contrast=this.buttonContrast;d.pressColor=this.titleBarColor.darker(20);d.fixLayout();d.refresh();this.srcBar.add(d);return d};SaveOpenDialogMorph.prototype.fixListFieldItemColors=function(){var a=this;this.listField.contents.children[0].alpha=0;this.listField.contents.children[0].children.forEach(function(b){b.pressColor=a.titleBarColor.darker(20);b.color=new Color(0,0,0,0)})};
SaveOpenDialogMorph.prototype.buildFilterField=function(){var a=this;this.filterField=new InputFieldMorph("");this.magnifyingGlass=new SymbolMorph("magnifyingGlass",this.filterField.height(),this.titleBarColor.darker(50));this.body.add(this.magnifyingGlass);this.body.add(this.filterField);this.filterField.reactToInput=function(b){var c=this.getValue();a.listField.elements=a.itemsList.filter(function(d){var e=d.notes||"";return-1<d.name.toLowerCase().indexOf(c.toLowerCase())||-1<e.toLowerCase().indexOf(c.toLowerCase())});
0===a.listField.elements.length&&a.listField.elements.push("(no matches)");a.clearPreview();a.listField.buildListContents();a.fixListFieldItemColors();a.listField.adjustScrollBars();a.listField.scrollY(a.listField.top());a.fixLayout()}};
SaveOpenDialogMorph.prototype.setSource=function(a){var b=this,c,d,e,f;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){switch(g.nextAddress){case 1:return b.source=a,b.srcBar.children.forEach(function(h){h.refresh()}),c=b.itemName.toLowerCase(),d=b.ide.showMessage("Updating\n"+c+" list..."),g.setCatchFinallyBlocks(2),b.itemsList=[],g.yield(a.list(),4);case 4:e=g.yieldResult;if(b.source===a)b.itemsList=e;else return d.destroy(),g.return();g.leaveTryBlock(3);break;case 2:f=g.enterCatchBlock(),
b.ide.cloudError().call(null,f.label,f.message);case 3:d.destroy(),b.itemsList.sort(function(h,k){return h.name.toLowerCase()<k.name.toLowerCase()?-1:1}),b.listField.destroy(),b.listField=new ListMorph(b.itemsList,0<b.itemsList.length?function(h){return h.name||h}:null,[["bold",function(h){return!0===h.public}]],function(){return b.ok()}),b.fixListFieldItemColors(),b.listField.fixLayout=nop,b.listField.edge=InputFieldMorph.prototype.edge,b.listField.fontSize=InputFieldMorph.prototype.fontSize,b.listField.typeInPadding=
InputFieldMorph.prototype.typeInPadding,b.listField.contrast=InputFieldMorph.prototype.contrast,b.listField.render=InputFieldMorph.prototype.render,b.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,b.listField.action=function(h){return $jscomp.asyncExecutePromiseGeneratorProgram(function(k){if(1==k.nextAddress){if(void 0===h)return k.return();b.nameField&&b.nameField.setContents(h.name||"");return"open"!==b.task?k.jumpTo(2):k.yield(b.setPreview(h),2)}b.source.canPublish()?h.public?
(b.shareButton.hide(),b.unshareButton.show()):(b.unshareButton.hide(),b.shareButton.show()):(b.unshareButton.hide(),b.shareButton.hide());b.buttons.fixLayout();b.fixLayout();b.edit();k.jumpToEnd()})},b.body.add(b.listField),b.source.canPublish()?b.shareButton.show():b.shareButton.hide(),b.unshareButton.hide(),b.source.canDelete()?b.deleteButton.show():b.deleteButton.hide(),b.buttons.fixLayout(),b.fixLayout(),"open"===b.task&&b.clearPreview(),g.jumpToEnd()}})};
SaveOpenDialogMorph.prototype.setPreview=function(a){var b=this,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){if(1==d.nextAddress)return d.yield(b.source.getPreview(a),2);c=d.yieldResult;b.notesText.text=c.notes||"";b.notesText.rerender();b.notesField.contents.adjustBounds();b.preview.texture=c.thumbnail||null;b.preview.cachedTexture=null;b.preview.rerender();c.details&&(new SpeechBubbleMorph(new TextMorph(c.details,null,null,null,null,"center"))).popUp(b.world(),b.preview.rightCenter().add(new Point(2,
0)));d.jumpToEnd()})};SaveOpenDialogMorph.prototype.clearPreview=function(){this.notesText.text="";this.notesText.rerender();this.notesField.contents.adjustBounds();this.preview.texture=null;this.preview.cachedTexture=null;this.preview.rerender()};SaveOpenDialogMorph.prototype.edit=function(){this.nameField?this.nameField.edit():this.filterField&&this.filterField.edit()};
SaveOpenDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding,b=this.padding/2,c=this.nameField||this.filterField;this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout();this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-a-this.buttons.height())),this.srcBar.setPosition(this.body.position()),c.setWidth(this.body.width()-
this.srcBar.width()-6*this.padding),c.setLeft(this.srcBar.right()+3*this.padding),c.setTop(this.srcBar.top()),this.listField.setLeft(this.srcBar.right()+this.padding),this.listField.setWidth(this.body.width()-this.srcBar.width()-this.preview.width()-this.padding-b),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(c.bottom()+this.padding),this.listField.setHeight(this.body.height()-c.height()-this.padding),this.magnifyingGlass&&(this.magnifyingGlass.setTop(c.top()),this.magnifyingGlass.setLeft(this.listField.left())),
this.preview.setRight(this.body.right()),this.preview.setTop(c.bottom()+this.padding),this.notesField.setTop(this.preview.bottom()+b),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-b));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&0<this.buttons.children.length&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding));this.removeShadow();
this.addShadow()};ProjectRecoveryDialogMorph.prototype=new DialogBoxMorph;ProjectRecoveryDialogMorph.prototype.constructor=ProjectRecoveryDialogMorph;ProjectRecoveryDialogMorph.uber=DialogBoxMorph.prototype;function ProjectRecoveryDialogMorph(a,b,c){this.init(a,b,c)}
ProjectRecoveryDialogMorph.prototype.init=function(a,b,c){ProjectRecoveryDialogMorph.uber.init.call(this,this,null,null);this.ide=a;this.browser=c;this.key="recoverProject";this.projectName=b;this.notesField=this.notesText=this.preview=this.listField=this.handle=this.versions=null;this.labelString="Recover project";this.createLabel();this.buildContents()};
ProjectRecoveryDialogMorph.prototype.buildContents=function(){this.addBody(new Morph);this.body.color=this.color;this.buildListField();this.preview=new Morph;this.preview.fixLayout=nop;this.preview.edge=InputFieldMorph.prototype.edge;this.preview.fontSize=InputFieldMorph.prototype.fontSize;this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.preview.contrast=InputFieldMorph.prototype.contrast;this.preview.render=function(a){InputFieldMorph.prototype.render.call(this,a);this.cachedTexture?
this.renderCachedTexture(a):this.texture&&this.renderTexture(this.texture,a)};this.preview.renderCachedTexture=function(a){a.drawImage(this.cachedTexture,this.edge,this.edge)};this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.preview.setExtent(this.ide.serializer.thumbnailSize.add(2*this.preview.edge));this.body.add(this.preview);this.notesField=new ScrollFrameMorph;this.notesField.fixLayout=nop;this.notesField.edge=InputFieldMorph.prototype.edge;this.notesField.fontSize=InputFieldMorph.prototype.fontSize;
this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.notesField.contrast=InputFieldMorph.prototype.contrast;this.notesField.render=InputFieldMorph.prototype.render;this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.notesField.acceptsDrops=!1;this.notesField.contents.acceptsDrops=!1;this.notesText=new TextMorph("");this.notesField.isTextLineWrapping=!0;this.notesField.padding=3;this.notesField.setContents(this.notesText);this.notesField.setWidth(this.preview.width());
this.body.add(this.notesField);this.addButton("recoverProject","Recover",!0);this.addButton("cancel","Cancel");this.setExtent(new Point(360,300));this.fixLayout()};
ProjectRecoveryDialogMorph.prototype.buildListField=function(){var a=this;this.listField=new ListMorph([]);this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.render=InputFieldMorph.prototype.render;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;
this.listField.action=function(b){if(void 0!==b){var c=detect(a.versions,function(d){return d.lastupdated===b});a.notesText.text=c.notes||"";a.notesText.rerender();a.notesField.contents.adjustBounds();a.preview.texture=c.thumbnail;a.preview.cachedTexture=null;a.preview.rerender()}};this.ide.cloud.getProjectVersionMetadata(this.projectName,function(b){var c=new Date,d=new Date;d.setDate(c.getDate()-1);a.versions=b;a.versions.forEach(function(e){var f=new Date((new Date).getTime()-1E3*e.lastupdated);
f.toDateString()===c.toDateString()?e.lastupdated=localize("Today, ")+f.toLocaleTimeString():f.toDateString()===d.toDateString()?e.lastupdated=localize("Yesterday, ")+f.toLocaleTimeString():e.lastupdated=f.toLocaleString()});a.listField.elements=a.versions.map(function(e){return e.lastupdated});a.clearDetails();a.listField.buildListContents();a.fixListFieldItemColors();a.listField.adjustScrollBars();a.listField.scrollY(a.listField.top());a.fixLayout()},this.ide.cloudError());this.body.add(this.listField)};
ProjectRecoveryDialogMorph.prototype.cancel=function(){var a=this;this.browser.show();this.browser.listField.select(detect(this.browser.projectList,function(b){return b.projectname===a.projectName}));ProjectRecoveryDialogMorph.uber.cancel.call(this)};ProjectRecoveryDialogMorph.prototype.recoverProject=function(){var a=this.listField.selected,b=detect(this.versions,function(c){return c.lastupdated===a});this.browser.openCloudProject({projectname:this.projectName},b.delta);this.destroy()};
ProjectRecoveryDialogMorph.prototype.popUp=function(){var a=this.ide.world();a&&(ProjectRecoveryDialogMorph.uber.popUp.call(this,a),this.handle=new HandleMorph(this,300,300,this.corner,this.corner))};ProjectRecoveryDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors;ProjectRecoveryDialogMorph.prototype.clearDetails=ProjectDialogMorph.prototype.clearDetails;
ProjectRecoveryDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding,b=this.padding/2;this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-a-this.buttons.height())),this.listField.setWidth(this.body.width()-this.preview.width()-this.padding),this.listField.contents.children[0].adjustWidths(),this.listField.setPosition(this.body.position()),
this.listField.setHeight(this.body.height()),this.preview.setRight(this.body.right()),this.preview.setTop(this.listField.top()),this.notesField.setTop(this.preview.bottom()+b),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-b));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&(this.buttons.fixLayout(),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-
this.padding));this.removeShadow();this.addShadow()};SaveOpenDialogMorph.prototype.popUp=function(a){a&&(SaveOpenDialogMorph.uber.popUp.call(this,a),this.handle=new HandleMorph(this,350,300,this.corner,this.corner))};ProjectsDialogSource.prototype=Object.create(SaveOpenDialogMorphSource.prototype);ProjectsDialogSource.prototype.constructor=ProjectsDialogSource;ProjectsDialogSource.uber=SaveOpenDialogMorphSource.prototype;function ProjectsDialogSource(a){this.init(a)}
ProjectsDialogSource.prototype.init=function(a,b,c,d){ProjectsDialogSource.uber.init.call(this,b,c,d);this.ide=a};ProjectsDialogSource.prototype.getPreview=function(a){var b=this,c,d,e;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){if(1==f.nextAddress)return f.yield(b.getContent(a),2);c=f.yieldResult;d=b.ide.serializer.parse(c);e=d.children[0].children[0];return f.return({thumbnail:e.childNamed("thumbnail").contents,notes:e.childNamed("notes").contents||""})})};
ProjectsDialogSource.prototype.open=function(a){var b=this,c,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){return 1==e.nextAddress?(c=b.ide,d=c.droppedText,e.yield(b.getContent(a),2)):e.return(d.call(c,e.yieldResult))})};CloudProjectsSource.prototype=Object.create(ProjectsDialogSource.prototype);CloudProjectsSource.prototype.constructor=CloudProjectsSource;CloudProjectsSource.uber=ProjectsDialogSource.prototype;function CloudProjectsSource(a){this.init(a,"Cloud","cloud")}
CloudProjectsSource.prototype.publish=function(a,b){var c=this,d=(b=void 0===b?!1:b)?"unpublishProject":"publishProject",e=this,f=this.ide.cloud;f.reconnect(function(){f.callService(d,function(){return f.disconnect()},c.ide.cloudError(),[a.name]);if(!b&&a.name===e.ide.projectName){var g="Username="+encodeURIComponent(SnapCloud.username.toLowerCase())+"&ProjectName="+encodeURIComponent(a.name);location.hash="present:"+g}},this.ide.cloudError())};
CloudProjectsSource.prototype.open=function(a){var b=this,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){c=utils.defer();SnapCloud.getProject(a.ID,function(e){return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){if(1==f.nextAddress)return f.yield(b.ide.rawLoadCloudProject(e,a.public),2);c.resolve(e);f.jumpToEnd()})},function(e,f){e=new CloudError(f,e);c.reject(e)});return d.return(c.promise)})};
CloudProjectsSource.prototype.list=function(){var a=utils.defer();SnapCloud.getProjectList(function(b){b.forEach(function(c){c.name=c.ProjectName;c.public="true"===c.Public});a.resolve(b)},function(b,c){b=new CloudError(c,b);a.reject(b)});return a.promise};CloudProjectsSource.prototype.getPreview=function(a){return{thumbnail:a.Thumbnail,notes:a.notes,details:localize("last changed")+"\n"+a.Updated}};
CloudProjectsSource.prototype.save=function(a){var b=utils.defer(),c=a.name!==this.ide.room.name,d=this;SnapCloud.saveProject(this.ide,function(e){e.name&&d.ide.room.silentSetRoomName(e.name);c&&d.ide.updateUrlQueryString();b.resolve()},function(e,f){e=new CloudError(f,e);b.reject(e)},!0,a.name);return b.promise};
CloudProjectsSource.prototype.delete=function(a){var b=this;SnapCloud.reconnect(function(){SnapCloud.callService("deleteProject",function(){SnapCloud.disconnect();b.ide.hasChangedMedia=!0},b.ide.cloudError(),[a.name])},this.ide.cloudError())};SharedCloudProjectsSource.prototype=Object.create(ProjectsDialogSource.prototype);SharedCloudProjectsSource.prototype.constructor=SharedCloudProjectsSource;SharedCloudProjectsSource.uber=ProjectsDialogSource.prototype;
function SharedCloudProjectsSource(a){this.init(a,"Shared with me","cloud","cloud-shared")}SharedCloudProjectsSource.prototype.list=function(){var a=utils.defer();SnapCloud.getSharedProjectList(function(b){b.forEach(function(c){c.name=c.ProjectName});a.resolve(b)},function(b,c){b=new CloudError(c,b);a.reject(b)});return a.promise};SharedCloudProjectsSource.prototype.delete=function(a){SnapCloud.evictCollaborator(SnapCloud.username,a.ID)};
SharedCloudProjectsSource.prototype.open=function(a){var b=this;SnapCloud.joinActiveProject(a.ID,function(c){return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){b.ide.rawLoadCloudProject(c,a.public);d.jumpToEnd()})},this.ide.cloudError())};BrowserProjectsSource.prototype=Object.create(ProjectsDialogSource.prototype);BrowserProjectsSource.prototype.constructor=BrowserProjectsSource;BrowserProjectsSource.uber=ProjectsDialogSource.prototype;
function BrowserProjectsSource(a){this.init(a,"Browser","storage","local")}BrowserProjectsSource.prototype.getContent=function(a){return localStorage["-snap-project-"+a.name]};BrowserProjectsSource.prototype.list=function(){var a,b=[];for(a in localStorage)if(Object.prototype.hasOwnProperty.call(localStorage,a)&&"-snap-project-"===a.substr(0,14)){var c=a.substr(14);c={name:c};b.push(c)}return b};BrowserProjectsSource.prototype.save=function(a){this.ide.room.name=a.name;this.ide.saveProject(name)};
BrowserProjectsSource.prototype.delete=function(a){delete localStorage["-snap-project-"+a.name]};CloudProjectExamples.prototype=Object.create(ProjectsDialogSource.prototype);CloudProjectExamples.prototype.constructor=CloudProjectExamples;CloudProjectExamples.uber=ProjectsDialogSource.prototype;function CloudProjectExamples(a){this.init(a,"Examples","poster")}CloudProjectExamples.prototype.getContent=function(a){return this.ide.getURL(this.ide.resourceURL("Examples",a.fileName))};
CloudProjectExamples.prototype.open=function(a){var b=this,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){if(1==d.nextAddress)return d.yield(b.getContent(a),2);if(3!=d.nextAddress)return c=d.yieldResult,d.yield(b.ide.droppedText(c),3);b.ide.updateUrlQueryString(a.name,!1,!0);d.jumpToEnd()})};CloudProjectExamples.prototype.list=function(){return this.ide.getMediaList("Examples").map(function(a){return{name:a.name,fileName:a.fileName,notes:a.description}})};
ProjectDialogMorph.prototype=new SaveOpenDialogMorph;ProjectDialogMorph.prototype.constructor=ProjectDialogMorph;ProjectDialogMorph.uber=SaveOpenDialogMorph.prototype;function ProjectDialogMorph(a,b){this.init(a,b)}
ProjectDialogMorph.prototype.init=function(a,b){this.ide=a;var c=[new CloudProjectsSource(a),new SharedCloudProjectsSource(a),new BrowserProjectsSource(a),new CloudProjectExamples(a)],d=a.source||"local",e=c.find(function(f){return f.id===d});ProjectDialogMorph.uber.init.call(this,b,"Project",c,e,{name:a.room.name,notes:a.projectNotes})};
ProjectDialogMorph.prototype.initPreview=function(){this.preview=new Morph;this.preview.fixLayout=nop;this.preview.edge=InputFieldMorph.prototype.edge;this.preview.fontSize=InputFieldMorph.prototype.fontSize;this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.preview.contrast=InputFieldMorph.prototype.contrast;this.preview.render=function(b){InputFieldMorph.prototype.render.call(this,b);this.cachedTexture?this.renderCachedTexture(b):this.texture&&this.renderTexture(this.texture,
b)};this.preview.renderCachedTexture=function(b){if(this.cachedTexture){var c=Math.min(this.width()/this.cachedTexture.width,this.height()/this.cachedTexture.height);b.drawImage(this.cachedTexture,this.edge,this.edge,c*this.cachedTexture.width,c*this.cachedTexture.height)}};this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.preview.setExtent(this.ide.serializer.thumbnailSize.divideBy(4).add(2*this.preview.edge));this.body.add(this.preview);if("save"===this.task){var a=this.ide.stage.thumbnail(SnapSerializer.prototype.thumbnailSize);
this.preview.texture=null;this.preview.cachedTexture=a;this.preview.rerender()}};ProjectDialogMorph.prototype.trySaveItem=function(){var a=this.nameField.contents().text.text,b=this.notesText.text;this.ide.projectNotes=b||this.ide.projectNotes;/[\.@]+/.test(a)?this.ide.inform("Invalid Project Name","Could not save project because\nthe provided name contains illegal characters.",this.world()):ProjectDialogMorph.uber.trySaveItem.call(this,{name:a,notes:b})};
ProjectDialogMorph.prototype.saveItem=function(a){ProjectDialogMorph.uber.saveItem.call(this,a);this.ide.source=this.source.id};ProjectDialogMorph.prototype.saveCloudProject=function(a){var b=this;this.ide.showMessage("Saving project\nto the cloud...");SnapCloud.saveProject(this.ide,function(c){c.name&&b.ide.room.silentSetRoomName(c.name);b.ide.source="cloud";b.ide.showMessage("Saved to cloud!",2)},this.ide.cloudError(),!0,a);this.destroy()};
ProjectDialogMorph.prototype.shareItem=function(){var a=this,b;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){if(1==c.nextAddress)return c.yield(ProjectDialogMorph.uber.shareItem.call(a),2);(b=c.yieldResult)&&a.isCurrentProject(b)&&a.ide.updateUrlQueryString(b.name,!0);c.jumpToEnd()})};ProjectDialogMorph.prototype.isCurrentProject=function(a){return a.ID===SnapCloud.projectId};
ProjectDialogMorph.prototype.unshareItem=function(){var a=this,b;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){if(1==c.nextAddress)return c.yield(ProjectDialogMorph.uber.unshareItem.call(a),2);(b=c.yieldResult)&&a.isCurrentProject(b)&&a.ide.updateUrlQueryString();c.jumpToEnd()})};SpriteIconMorph.prototype=new ToggleButtonMorph;SpriteIconMorph.prototype.constructor=SpriteIconMorph;SpriteIconMorph.uber=ToggleButtonMorph.prototype;SpriteIconMorph.prototype.thumbSize=new Point(40,40);
SpriteIconMorph.prototype.labelShadowOffset=null;SpriteIconMorph.prototype.labelShadowColor=null;SpriteIconMorph.prototype.labelColor=WHITE;SpriteIconMorph.prototype.fontSize=9;function SpriteIconMorph(a){this.init(a)}
SpriteIconMorph.prototype.init=function(a){var b=this;var c=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor];this.object=a||new SpriteMorph;this.version=this.object.version;this.rotationButton=this.thumbnail=null;SpriteIconMorph.uber.init.call(this,c,null,function(){var d=b.parentThatIsA(IDE_Morph);d&&(SnapActions.selectSprite(b.object),d.selectSprite(b.object))},this.object.name,function(){var d=b.parentThatIsA(IDE_Morph);return d?d.currentSprite===b.object:
!1},null,function(){return a.exemplar?localize("parent")+":\n"+a.exemplar.name:null});this.isDraggable=!0;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};
SpriteIconMorph.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy();this.thumbnail=new Morph;this.thumbnail.isCachingImage=!0;this.thumbnail.bounds.setExtent(this.thumbSize);this.object instanceof SpriteMorph?(this.thumbnail.cachedImage=this.object.fullThumbnail(this.thumbSize,this.thumbnail.cachedImage),this.add(this.thumbnail),this.createRotationButton()):(this.thumbnail.cachedImage=this.object.thumbnail(this.thumbSize,this.thumbnail.cachedImage),this.add(this.thumbnail))};
SpriteIconMorph.prototype.createLabel=function(){this.label&&this.label.destroy();var a=new StringMorph(this.object.name,this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor);this.label=new FrameMorph;this.label.acceptsDrops=!1;this.label.alpha=0;this.label.setExtent(a.extent());a.setPosition(this.label.position());this.label.add(a);this.add(this.label)};
SpriteIconMorph.prototype.createRotationButton=function(){var a=this;this.rotationButton&&(this.rotationButton.destroy(),this.roationButton=null);if(this.object.anchor){var b=new ToggleButtonMorph(null,null,function(){return a.object.rotatesWithAnchor=!a.object.rotatesWithAnchor},["\u2192","\u21bb"],function(){return a.object.rotatesWithAnchor});b.corner=8;b.labelMinExtent=new Point(11,11);b.padding=0;b.pressColor=b.color;b.fixLayout();b.refresh();this.rotationButton=b;this.add(this.rotationButton)}};
SpriteIconMorph.prototype.step=function(){this.version!==this.object.version&&(this.createThumbnail(),this.createLabel(),this.fixLayout(),this.version=this.object.version,this.refresh())};
SpriteIconMorph.prototype.fixLayout=function(){if(!this.thumbnail||!this.label)return null;this.bounds.setWidth(this.thumbnail.width()+2*this.outline+2*this.edge+2*this.padding);this.bounds.setHeight(this.thumbnail.height()+2*this.outline+2*this.edge+3*this.padding+this.label.height());this.thumbnail.setCenter(this.center());this.thumbnail.setTop(this.top()+this.outline+this.edge+this.padding);this.rotationButton&&(this.rotationButton.setTop(this.top()),this.rotationButton.setRight(this.right()));
this.label.setWidth(Math.min(this.label.children[0].width(),this.thumbnail.width()));this.label.setCenter(this.center());this.label.setTop(this.thumbnail.bottom()+this.padding)};
SpriteIconMorph.prototype.userMenu=function(){var a=this,b=new MenuMorph(this);if(this.object instanceof StageMorph)return b.addItem("pic...",function(){a.parentThatIsA(IDE_Morph).saveCanvasAs(a.object.fullImage(),a.object.name)},"save a picture\nof the stage"),this.object.trailsLog.length&&b.addItem("svg...",function(){return a.object.exportTrailsLogAsSVG()},"export pen trails\nline segments as SVG"),b;if(!(this.object instanceof SpriteMorph))return null;b.addItem("show","showSpriteOnStage");b.addLine();
b.addItem("duplicate",function(){var c=a.world().hand.position();SnapActions.duplicateSprite(a.object,c)});b.addItem("delete",function(){return SnapActions.removeSprite(a.object)});b.addLine();this.object.anchor&&b.addItem(localize("detach from")+" "+this.object.anchor.name,function(){return SnapActions.detachParts([a.object])});this.object.parts.length&&b.addItem("detach all parts",function(){return SnapActions.detachParts(a.object.parts)});b.addItem("export...","exportSprite");return b};
SpriteIconMorph.prototype.instantiateSprite=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.instantiateSprite(this.object)};SpriteIconMorph.prototype.exportSprite=function(){this.object.exportSprite()};SpriteIconMorph.prototype.chooseExemplar=function(){this.object.chooseExemplar()};SpriteIconMorph.prototype.releaseSprite=function(){this.object.release()};SpriteIconMorph.prototype.showSpriteOnStage=function(){this.object.showOnStage()};
SpriteIconMorph.prototype.mouseDoubleClick=function(){this.object instanceof SpriteMorph&&this.object.flash()};SpriteIconMorph.prototype.render=function(a){switch(this.userState){case "highlight":this.drawBackground(a,this.highlightColor);break;case "pressed":this.drawOutline(a);this.drawBackground(a,this.pressColor);this.drawEdges(a,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40));break;default:this.drawBackground(a,this.getRenderColor())}};
SpriteIconMorph.prototype.getRenderColor=ScriptsMorph.prototype.getRenderColor;SpriteIconMorph.prototype.prepareToBeGrabbed=function(){var a=this.parentThatIsA(IDE_Morph);this.mouseClickLeft();this.alpha=.85;if(a){var b=a.sprites.asArray().indexOf(this.object);a.sprites.remove(b+1);a.createCorral();a.fixLayout()}};SpriteIconMorph.prototype.justDropped=function(){this.alpha=1};
SpriteIconMorph.prototype.wantsDropOf=function(a){return a instanceof BlockMorph||a instanceof CostumeIconMorph||a instanceof SoundIconMorph};SpriteIconMorph.prototype.reactToDropOf=function(a,b){a instanceof BlockMorph?this.copyStack(a):a instanceof CostumeIconMorph?this.copyCostume(a.object):a instanceof SoundIconMorph&&this.copySound(a.object);this.world().add(a);a.slideBackTo(b.grabOrigin)};
SpriteIconMorph.prototype.copyStack=function(a){var b=this,c,d,e,f;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){if(1==g.nextAddress)return c=b.object,d=a.id?a.fullCopy():a,e=Math.max(c.scripts.children.map(function(h){return h.fullBounds().bottom()}).concat([c.scripts.top()])),f=new Point(b.object.scripts.left()+20,e+20),d.allComments().forEach(function(h){return h.align(d)}),d.allChildren().forEach(function(h){!h.isCustomBlock||h.isGlobal||c.getMethod(h.blockSpec)||h.deleteBlock()}),
d.id=null,g.yield(SnapActions.addBlock(d,c,f),2);c.scripts.adjustBounds();g.jumpToEnd()})};SpriteIconMorph.prototype.copyCostume=function(a){a=a.copy();a.name=this.object.newCostumeName(a.name);SnapActions.addCostume(a,this.object)};SpriteIconMorph.prototype.copySound=function(a){SnapActions.addSound(a,this.object)};
SpriteIconMorph.prototype.flash=function(){var a=this,b=this.world(),c=MorphicPreferences.isFlat,d=SpriteMorph.prototype.highlightColor,e=c?this.pressColor:this.outlineColor,f=this.outline,g=this.userState;c?this.pressColor=d:(this.outlineColor=d,this.outline=2);this.userState="pressed";this.rerender();b.animations.push(new Animation(nop,nop,0,800,nop,function(){c?a.pressColor=e:(a.outlineColor=e,a.outline=f);a.userState=g;a.rerender()}))};CostumeIconMorph.prototype=new ToggleButtonMorph;
CostumeIconMorph.prototype.constructor=CostumeIconMorph;CostumeIconMorph.uber=ToggleButtonMorph.prototype;CostumeIconMorph.prototype.thumbSize=new Point(80,60);CostumeIconMorph.prototype.labelShadowOffset=null;CostumeIconMorph.prototype.labelShadowColor=null;CostumeIconMorph.prototype.labelColor=WHITE;CostumeIconMorph.prototype.fontSize=9;function CostumeIconMorph(a){this.init(a)}
CostumeIconMorph.prototype.init=function(a){var b=this;var c=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor];this.object=a||new Costume;this.version=this.object.version;this.thumbnail=null;CostumeIconMorph.uber.init.call(this,c,null,function(){var d=b.parentThatIsA(IDE_Morph),e=b.parentThatIsA(WardrobeMorph);d&&d.currentSprite.wearCostume(b.object);e&&e.updateSelection()},this.object.name,function(){var d=b.parentThatIsA(IDE_Morph);return d?d.currentSprite.costume===
b.object:!1},null,null);this.isDraggable=!0;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};CostumeIconMorph.prototype.createThumbnail=function(){SpriteIconMorph.prototype.createThumbnail.call(this);if(this.object instanceof SVG_Costume){var a=new StringMorph("svg",.8*this.fontSize,this.fontStyle,!1,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor);a.setBottom(this.thumbnail.bottom());this.thumbnail.add(a)}};
CostumeIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel;CostumeIconMorph.prototype.step=SpriteIconMorph.prototype.step;CostumeIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;
CostumeIconMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(!(this.object instanceof Costume))return null;a.addItem("edit","editCostume");16===this.world().currentKey&&a.addItem("edit rotation point only...","editRotationPointOnly",null,new Color(100,0,0));a.addItem("rename","renameCostume");a.addLine();a.addItem("duplicate","duplicateCostume");a.addItem("delete","removeCostume");a.addLine();a.addItem("export","exportCostume");return a};
CostumeIconMorph.prototype.editCostume=function(){var a=this,b=this.object.copy();this.disinherit();if(this.object instanceof SVG_Costume&&0===this.object.shapes.length)try{this.object.parseShapes()}catch(c){this.editRotationPointOnly();return}this.object.edit(this.world(),this.parentThatIsA(IDE_Morph),!1,null,function(){return SnapActions.updateCostume(b,a.object)})};
CostumeIconMorph.prototype.editRotationPointOnly=function(){var a=this.parentThatIsA(IDE_Morph);this.object.editRotationPointOnly(this.world());a.hasChangedMedia=!0};
CostumeIconMorph.prototype.renameCostume=function(){this.disinherit();var a=this.object,b=this.parentThatIsA(WardrobeMorph);this.parentThatIsA(IDE_Morph);(new DialogBoxMorph(null,function(c){c&&c!==a.name&&(c=b.sprite.newCostumeName(c,a),SnapActions.renameCostume(a,c))})).prompt(this.currentSprite instanceof SpriteMorph?"rename costume":"rename background",a.name,this.world())};
CostumeIconMorph.prototype.duplicateCostume=function(){var a=this.parentThatIsA(WardrobeMorph);this.parentThatIsA(IDE_Morph);var b=this.object.copy();b.name=a.sprite.newCostumeName(b.name);SnapActions.addCostume(b,a.sprite)};CostumeIconMorph.prototype.removeCostume=function(){SnapActions.removeCostume(this.object)};
CostumeIconMorph.prototype.exportCostume=function(){var a=this.parentThatIsA(IDE_Morph);this.object instanceof SVG_Costume?a.saveFileAs(this.object.contents.src,"text/svg",this.object.name):a.saveCanvasAs(this.object.contents,this.object.name)};CostumeIconMorph.prototype.render=SpriteIconMorph.prototype.render;
CostumeIconMorph.prototype.disinherit=function(){var a=this.parentThatIsA(WardrobeMorph),b=this.parent.children.indexOf(this);a.sprite.inheritsAttribute("costumes")&&(a.sprite.shadowAttribute("costumes"),this.object=a.sprite.costumes.at(b-3))};CostumeIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit();this.mouseClickLeft();this.localRemoveCostume()};
CostumeIconMorph.prototype.localRemoveCostume=function(){var a=this.parentThatIsA(WardrobeMorph),b=this.parent.children.indexOf(this),c=this.parentThatIsA(IDE_Morph);a.removeCostumeAt(b-2);c.currentSprite.costume===this.object&&c.currentSprite.wearCostume(null)};TurtleIconMorph.prototype=new ToggleButtonMorph;TurtleIconMorph.prototype.constructor=TurtleIconMorph;TurtleIconMorph.uber=ToggleButtonMorph.prototype;TurtleIconMorph.prototype.thumbSize=new Point(80,60);
TurtleIconMorph.prototype.labelShadowOffset=null;TurtleIconMorph.prototype.labelShadowColor=null;TurtleIconMorph.prototype.labelColor=WHITE;TurtleIconMorph.prototype.fontSize=9;function TurtleIconMorph(a){this.init(a)}
TurtleIconMorph.prototype.init=function(a){var b=this;var c=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor];this.object=a;this.version=this.object.version;this.thumbnail=null;TurtleIconMorph.uber.init.call(this,c,null,function(){var d=b.parentThatIsA(IDE_Morph),e=b.parentThatIsA(WardrobeMorph);d&&d.currentSprite.wearCostume(null);e&&e.updateSelection()},"default",function(){var d=b.parentThatIsA(IDE_Morph);return d?null===d.currentSprite.costume:!1},
null,null);this.isDraggable=!1;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout()};TurtleIconMorph.prototype.createThumbnail=function(){var a=MorphicPreferences.isFlat;this.thumbnail&&this.thumbnail.destroy();this.thumbnail=this.object instanceof SpriteMorph?new SymbolMorph("turtle",this.thumbSize.y,this.labelColor,a?null:new Point(-1,-1),new Color(0,0,0)):new SymbolMorph("stage",this.thumbSize.y,this.labelColor,a?null:new Point(-1,-1),new Color(0,0,0));this.add(this.thumbnail)};
TurtleIconMorph.prototype.createLabel=function(){this.label&&this.label.destroy();var a=new StringMorph(localize(this.object instanceof SpriteMorph?"Turtle":"Empty"),this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor);this.label=new FrameMorph;this.label.acceptsDrops=!1;this.label.alpha=0;this.label.setExtent(a.extent());a.setPosition(this.label.position());this.label.add(a);this.add(this.label)};TurtleIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;
TurtleIconMorph.prototype.render=SpriteIconMorph.prototype.render;
TurtleIconMorph.prototype.userMenu=function(){var a=this,b=new MenuMorph(this,"pen");if(this.object instanceof StageMorph)return null;b.addItem(("tip"===this.object.penPoint?"\u25cf":"\u25cb")+" "+localize("tip"),function(){a.object.penPoint="tip";a.object.changed();a.object.fixLayout();a.object.rerender()});b.addItem(("middle"===this.object.penPoint?"\u25cf":"\u25cb")+" "+localize("middle"),function(){a.object.penPoint="middle";a.object.changed();a.object.fixLayout();a.object.rerender()});return b};
WardrobeMorph.prototype=new ScrollFrameMorph;WardrobeMorph.prototype.undoCategory="costumes";WardrobeMorph.prototype.constructor=WardrobeMorph;WardrobeMorph.uber=ScrollFrameMorph.prototype;function WardrobeMorph(a,b){this.init(a,b)}WardrobeMorph.prototype.init=function(a,b){this.sprite=a||new SpriteMorph;this.spriteVersion=this.costumesVersion=null;WardrobeMorph.uber.init.call(this,null,null,b);this.fps=2;this.updateList()};
WardrobeMorph.prototype.updateList=function(){var a=this,b=this.left()+5,c=this.top()+5,d=this.contents.position();this.changed();this.contents.destroy();this.contents=new FrameMorph(this);this.contents.acceptsDrops=!1;this.contents.reactToDropOf=function(h){a.reactToDropOf(h)};this.addBack(this.contents);var e=new TurtleIconMorph(this.sprite);e.setPosition(new Point(b,c));this.addContents(e);c=e.bottom()+4;var f=new PushButtonMorph(this,"paintNew",new SymbolMorph("brush",15));f.padding=0;f.corner=
12;f.color=IDE_Morph.prototype.groupColor;f.highlightColor=IDE_Morph.prototype.frameColor.darker(50);f.pressColor=f.highlightColor;f.labelMinExtent=new Point(36,18);f.labelShadowOffset=new Point(-1,-1);f.labelShadowColor=f.highlightColor;f.labelColor=TurtleIconMorph.prototype.labelColor;f.contrast=this.buttonContrast;f.hint="Paint a new costume";f.setPosition(new Point(b,c));f.fixLayout();f.setCenter(e.center());f.setLeft(e.right()+16);this.addContents(f);if(CamSnapshotDialogMorph.prototype.enableCamera){var g=
new PushButtonMorph(this,"newFromCam",new SymbolMorph("camera",15));g.padding=0;g.corner=12;g.color=IDE_Morph.prototype.groupColor;g.highlightColor=IDE_Morph.prototype.frameColor.darker(50);g.pressColor=f.highlightColor;g.labelMinExtent=new Point(36,18);g.labelShadowOffset=new Point(-1,-1);g.labelShadowColor=f.highlightColor;g.labelColor=TurtleIconMorph.prototype.labelColor;g.contrast=this.buttonContrast;g.hint="Import a new costume from your webcam";g.setPosition(new Point(b,c));g.fixLayout();g.setCenter(f.center());
g.setLeft(f.right()+5);this.addContents(g);CamSnapshotDialogMorph.prototype.enabled||(g.disable(),g.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage);document.addEventListener("cameraDisabled",function(){g.disable();g.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage})}f=new TextMorph(localize("costumes tab help"));f.fontSize=9;f.setColor(SpriteMorph.prototype.paletteTextColor);f.setPosition(new Point(b,c));this.addContents(f);c=f.bottom()+4;this.sprite.costumes.asArray().forEach(function(h){e=
new CostumeIconMorph(h);e.setPosition(new Point(b,c));a.addContents(e);c=e.bottom()+4});this.costumesVersion=this.sprite.costumes.lastChanged;this.contents.setPosition(d);this.adjustScrollBars();this.changed();this.updateSelection();this.onNextStep=this.updateToolbar};WardrobeMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(a){a.refresh&&a.refresh()});this.spriteVersion=this.sprite.version};
WardrobeMorph.prototype.step=function(){this.costumesVersion!==this.sprite.costumes.lastChanged&&this.updateList();this.spriteVersion!==this.sprite.version&&this.updateSelection()};WardrobeMorph.prototype.removeCostumeAt=function(a){this.sprite.shadowAttribute("costumes");this.sprite.costumes.remove(a);this.updateList()};
WardrobeMorph.prototype.paintNew=function(){var a=this,b=this.sprite.newCostumeName(localize("untitled")),c=this.parentThatIsA(IDE_Morph),d=new Costume(newCanvas(null,!0),b);d.edit(this.world(),c,!0,null,function(){return SnapActions.addCostume(d,a.sprite)})};WardrobeMorph.prototype.newFromCam=function(){var a=this.parentThatIsA(IDE_Morph);var b=this.sprite;a=new CamSnapshotDialogMorph(a,b,nop,function(c){SnapActions.addCostume(c,b).then(function(d){return b.wearCostume(d)})});a.key="camera";a.popUp(this.world())};
WardrobeMorph.prototype.wantsDropOf=function(a){return a instanceof CostumeIconMorph};WardrobeMorph.prototype.reactToDropOf=function(a){var b=0,c=a.object,d=a.top();a.destroy();this.contents.children.forEach(function(e){e instanceof CostumeIconMorph&&e.top()<d-4&&(b+=1)});this.sprite.shadowAttribute("costumes");this.sprite.costumes.add(c,b+1);this.updateList();a.mouseClickLeft()};WardrobeMorph.prototype.undoOwnerId=function(){return this.sprite.id+"/"+this.undoCategory};
WardrobeMorph.prototype.updateToolbar=ScriptsMorph.prototype.updateToolbar;WardrobeMorph.prototype.addToolbar=ScriptsMorph.prototype.addToolbar;SoundIconMorph.prototype=new ToggleButtonMorph;SoundIconMorph.prototype.constructor=SoundIconMorph;SoundIconMorph.uber=ToggleButtonMorph.prototype;SoundIconMorph.prototype.thumbSize=new Point(80,60);SoundIconMorph.prototype.labelShadowOffset=null;SoundIconMorph.prototype.labelShadowColor=null;SoundIconMorph.prototype.labelColor=WHITE;
SoundIconMorph.prototype.fontSize=9;function SoundIconMorph(a){this.init(a)}SoundIconMorph.prototype.init=function(a){var b=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor];var c=nop;this.object=a;this.version=this.object.version;this.thumbnail=null;SoundIconMorph.uber.init.call(this,b,null,c,this.object.name,function(){return!1},null,null);this.isDraggable=!0;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};
SoundIconMorph.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy();this.thumbnail=new Morph;this.thumbnail.bounds.setExtent(this.thumbSize);this.add(this.thumbnail);var a=new StringMorph(this.createInfo(),"16","",!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,new Color(200,200,200));this.thumbnail.add(a);a.setCenter(new Point(40,15));this.button=new PushButtonMorph(this,"toggleAudioPlaying",this.object.previewAudio?"Stop":"Play");this.button.hint="Play sound";this.button.fixLayout();
this.thumbnail.add(this.button);this.button.setCenter(new Point(40,40))};SoundIconMorph.prototype.createInfo=function(){var a=Math.round(this.object.audio.duration||0),b=a%60;return Math.floor(a/60).toString()+":"+(10>b?"0":"")+b.toString()};
SoundIconMorph.prototype.toggleAudioPlaying=function(){var a=this;this.object.previewAudio?(this.button.labelString="Play",this.button.hint="Play sound",this.object.previewAudio.pause(),this.object.previewAudio.terminated=!0,this.object.previewAudio=null):(this.button.labelString="Stop",this.button.hint="Stop sound",this.object.previewAudio=this.object.play(),this.object.previewAudio.addEventListener("ended",function(){return a.audioHasEnded()},!1));this.button.createLabel()};
SoundIconMorph.prototype.audioHasEnded=function(){this.button.trigger();this.button.mouseLeave()};SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel;SoundIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;SoundIconMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(!(this.object instanceof Sound))return null;a.addItem("rename","renameSound");a.addItem("delete","removeSound");a.addLine();a.addItem("export","exportSound");return a};
SoundIconMorph.prototype.renameSound=function(){var a=this.object;this.parentThatIsA(IDE_Morph);this.disinherit();(new DialogBoxMorph(null,function(b){b&&b!==a.name&&SnapActions.renameSound(a,b)})).prompt("rename sound",a.name,this.world())};SoundIconMorph.prototype.removeSound=function(){SnapActions.removeSound(this.object)};SoundIconMorph.prototype.localRemoveSound=function(){var a=this.parentThatIsA(JukeboxMorph),b=this.parent.children.indexOf(this)-1;a.removeSound(b)};
SoundIconMorph.prototype.exportSound=function(){this.parentThatIsA(IDE_Morph).saveAudioAs(this.object.audio,this.object.name)};SoundIconMorph.prototype.render=SpriteIconMorph.prototype.render;SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel;SoundIconMorph.prototype.disinherit=function(){var a=this.parentThatIsA(JukeboxMorph),b=this.parent.children.indexOf(this);a.sprite.inheritsAttribute("sounds")&&(a.sprite.shadowAttribute("sounds"),this.object=a.sprite.sounds.at(b-1))};
SoundIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit();this.userState="pressed";this.state=!0;this.rerender();this.localRemoveSound()};JukeboxMorph.prototype=new ScrollFrameMorph;JukeboxMorph.prototype.undoCategory="sounds";JukeboxMorph.prototype.constructor=JukeboxMorph;JukeboxMorph.uber=ScrollFrameMorph.prototype;function JukeboxMorph(a,b){this.init(a,b)}
JukeboxMorph.prototype.init=function(a,b){this.sprite=a||new SpriteMorph;this.spriteVersion=this.soundsVersion=null;JukeboxMorph.uber.init.call(this,null,null,b);this.acceptsDrops=!1;this.fps=2;this.updateList()};
JukeboxMorph.prototype.updateList=function(){var a=this,b=this.left()+5,c=this.top()+5,d,e=this.sprite.parentThatIsA(IDE_Morph);this.changed();this.contents.destroy();this.contents=new FrameMorph(this);this.contents.acceptsDrops=!1;this.contents.reactToDropOf=function(g){return a.reactToDropOf(g)};this.addBack(this.contents);var f=new TextMorph(localize("import a sound from your computer\nby dragging it into here"));f.fontSize=9;f.setColor(SpriteMorph.prototype.paletteTextColor);f.setPosition(new Point(b,
c));this.addContents(f);e=new PushButtonMorph(e,"recordNewSound",new SymbolMorph("circleSolid",15));e.padding=0;e.corner=12;e.color=IDE_Morph.prototype.groupColor;e.highlightColor=IDE_Morph.prototype.frameColor.darker(50);e.pressColor=e.highlightColor;e.labelMinExtent=new Point(36,18);e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=e.highlightColor;e.labelColor=TurtleIconMorph.prototype.labelColor;e.contrast=this.buttonContrast;e.hint="Record a new sound";e.fixLayout();e.label.setColor(new Color(255,
20,20));e.setPosition(f.bottomLeft().add(new Point(0,8)));this.addContents(e);c=e.bottom()+4;this.sprite.sounds.asArray().forEach(function(g){d=new SoundIconMorph(g);d.setPosition(new Point(b,c));a.addContents(d);c=d.bottom()+4});this.soundsVersion=this.sprite.sounds.lastChanged;this.changed();this.updateSelection();this.onNextStep=this.updateToolbar};JukeboxMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(a){a.refresh&&a.refresh()});this.spriteVersion=this.sprite.version};
JukeboxMorph.prototype.step=function(){this.soundsVersion!==this.sprite.sounds.lastChanged&&this.updateList();this.spriteVersion!==this.sprite.version&&this.updateSelection()};JukeboxMorph.prototype.removeSound=function(a){this.sprite.sounds.remove(a);this.updateList()};JukeboxMorph.prototype.wantsDropOf=function(a){return a instanceof SoundIconMorph};
JukeboxMorph.prototype.reactToDropOf=function(a){var b=0,c=a.object,d=a.top();a.destroy();this.contents.children.forEach(function(e){e instanceof SoundIconMorph&&e.top()<d-4&&(b+=1)});this.sprite.shadowAttribute("sounds");this.sprite.sounds.add(c,b+1);this.updateList()};JukeboxMorph.prototype.updateToolbar=ScriptsMorph.prototype.updateToolbar;JukeboxMorph.prototype.addToolbar=ScriptsMorph.prototype.addToolbar;JukeboxMorph.prototype.undoOwnerId=WardrobeMorph.prototype.undoOwnerId;
StageHandleMorph.prototype=new Morph;StageHandleMorph.prototype.constructor=StageHandleMorph;StageHandleMorph.uber=Morph.prototype;function StageHandleMorph(a){this.init(a)}StageHandleMorph.prototype.init=function(a){this.target=a||null;this.userState="normal";HandleMorph.uber.init.call(this);this.color=MorphicPreferences.isFlat?IDE_Morph.prototype.backgroundColor:new Color(190,190,190);this.isDraggable=!1;this.setExtent(new Point(12,50))};
StageHandleMorph.prototype.render=function(a){"highlight"===this.userState?this.renderOn(a,MorphicPreferences.isFlat?new Color(245,245,255):new Color(100,100,255),this.color):this.renderOn(a,this.color)};
StageHandleMorph.prototype.renderOn=function(a,b,c){var d=this.height()/8,e=this.width()/6,f=e/2,g;a.lineWidth=e;a.lineCap="round";var h=this.height()/2;a.strokeStyle=b.toString();b=this.width()/12;for(g=0;3>g;g+=1)0<g&&(a.beginPath(),a.moveTo(b,h-(d-f)),a.lineTo(b,h+(d-f)),a.stroke()),b+=2*e,d*=2;if(c)for(a.strokeStyle=c.toString(),b=this.width()/12+e,d=this.height()/8,g=0;3>g;g+=1)0<g&&(a.beginPath(),a.moveTo(b,h-(d-f)),a.lineTo(b,h+(d-f)),a.stroke()),b+=2*e,d*=2};
StageHandleMorph.prototype.fixLayout=function(){if(this.target){var a=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10);this.setRight(this.target.left());a&&a.add(this)}};StageHandleMorph.prototype.step=null;
StageHandleMorph.prototype.mouseDownLeft=function(a){var b=this.world(),c=this.right()-a.x,d=this.target.parentThatIsA(IDE_Morph);if(!this.target)return null;d.isSmallStage=!0;d.controlBar.stageSizeButton.refresh();this.step=function(){if(b.hand.mouseButton){var e=b.hand.bounds.origin.x+c;e=this.target.right()-e;d.stageRatio=e/this.target.dimensions.x;d.setExtent(b.extent())}else this.step=null,d.isSmallStage=1!==d.stageRatio,d.controlBar.stageSizeButton.refresh()}};
StageHandleMorph.prototype.mouseEnter=function(){this.userState="highlight";this.rerender()};StageHandleMorph.prototype.mouseLeave=function(){this.userState="normal";this.rerender()};StageHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).toggleStageSize(!0,1)};PaletteHandleMorph.prototype=new Morph;PaletteHandleMorph.prototype.constructor=PaletteHandleMorph;PaletteHandleMorph.uber=Morph.prototype;function PaletteHandleMorph(a){this.init(a)}
PaletteHandleMorph.prototype.init=function(a){this.target=a||null;this.userState="normal";HandleMorph.uber.init.call(this);this.color=MorphicPreferences.isFlat?IDE_Morph.prototype.backgroundColor:new Color(190,190,190);this.isDraggable=!1;this.setExtent(new Point(12,50))};PaletteHandleMorph.prototype.render=StageHandleMorph.prototype.render;PaletteHandleMorph.prototype.renderOn=StageHandleMorph.prototype.renderOn;
PaletteHandleMorph.prototype.fixLayout=function(){if(this.target){var a=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10);this.setRight(this.target.right());a&&a.add(this)}};PaletteHandleMorph.prototype.step=null;
PaletteHandleMorph.prototype.mouseDownLeft=function(a){var b=this.world(),c=this.right()-a.x,d=this.target.parentThatIsA(IDE_Morph);if(!this.target)return null;this.step=function(){if(b.hand.mouseButton){var e=b.hand.bounds.origin.x+c;d.paletteWidth=Math.min(Math.max(200,e),d.stageHandle.left()-d.spriteBar.tabBar.width());d.setExtent(b.extent())}else this.step=null}};PaletteHandleMorph.prototype.mouseEnter=StageHandleMorph.prototype.mouseEnter;PaletteHandleMorph.prototype.mouseLeave=StageHandleMorph.prototype.mouseLeave;
PaletteHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).setPaletteWidth(200)};CamSnapshotDialogMorph.prototype=new DialogBoxMorph;CamSnapshotDialogMorph.prototype.constructor=CamSnapshotDialogMorph;CamSnapshotDialogMorph.uber=DialogBoxMorph.prototype;CamSnapshotDialogMorph.prototype.enableCamera=!0;CamSnapshotDialogMorph.prototype.enabled=!0;CamSnapshotDialogMorph.prototype.notSupportedMessage='Please make sure your web browser is up to date\nand your camera is properly configured. \n\nSome browsers also require you to access Snap!\nthrough HTTPS to use the camera.\n\nPlase replace the "http://" part of the address\nin your browser by "https://" and try again.';
function CamSnapshotDialogMorph(a,b,c,d){this.init(a,b,c,d)}CamSnapshotDialogMorph.prototype.init=function(a,b,c,d){this.ide=a;this.sprite=b;this.padding=10;this.oncancel=c;this.accept=d;this.videoElement=null;this.videoView=new Morph;this.videoView.isCachingImage=!0;CamSnapshotDialogMorph.uber.init.call(this);this.labelString="Camera";this.createLabel();this.buildContents()};
CamSnapshotDialogMorph.prototype.buildContents=function(){function a(){c.disable();c.ide.inform("Camera not supported",CamSnapshotDialogMorph.prototype.notSupportedMessage);c.videoElement&&c.videoElement.remove();c.cancel()}var b=this,c=this,d=this.sprite.parentThatIsA(StageMorph);this.videoElement=document.createElement("video");this.videoElement.hidden=!0;this.videoElement.width=d.dimensions.x;this.videoElement.height=d.dimensions.y;document.body.appendChild(this.videoElement);navigator.mediaDevices&&
navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){b.videoElement.srcObject=e;b.videoElement.play().catch(a);b.videoElement.stream=e}).catch(a);this.videoView.setExtent(d.dimensions);this.videoView.cachedImage=newCanvas(d.dimensions,!0,this.videoView.cachedImage);this.videoView.drawOn=function(e,f){var g=c.videoElement.videoWidth,h=c.videoElement.videoHeight;f=d.dimensions.x;var k=d.dimensions.y;if(g){e.save();e.translate(f,0);e.scale(-1,1);if(g/
f>h/k){var l=h/k*f;g=h}else l=g,g=g/f*k;e.drawImage(c.videoElement,0,0,l,g,-1*this.left(),this.top(),f,k);e.restore()}};this.videoView.step=function(){this.changed()};this.addBody(new AlignmentMorph("column",this.padding/2));this.body.add(this.videoView);this.body.fixLayout();this.addButton("ok","Save");this.addButton("cancel","Cancel");this.fixLayout();this.rerender()};CamSnapshotDialogMorph.prototype.ok=function(){this.accept((new Costume(this.videoView.fullImage(),this.sprite.newCostumeName("camera"))).flipped())};
CamSnapshotDialogMorph.prototype.disable=function(){CamSnapshotDialogMorph.prototype.enabled=!1;document.dispatchEvent(new Event("cameraDisabled"))};CamSnapshotDialogMorph.prototype.destroy=function(){this.oncancel.call(this);this.close()};CamSnapshotDialogMorph.prototype.close=function(){this.videoElement&&this.videoElement.stream&&(this.videoElement.stream.getTracks()[0].stop(),this.videoElement.remove());CamSnapshotDialogMorph.uber.destroy.call(this)};SoundRecorderDialogMorph.prototype=new DialogBoxMorph;
SoundRecorderDialogMorph.prototype.constructor=SoundRecorderDialogMorph;SoundRecorderDialogMorph.uber=DialogBoxMorph.prototype;function SoundRecorderDialogMorph(a){this.init(a)}
SoundRecorderDialogMorph.prototype.init=function(a){var b=this;this.padding=10;this.accept=a;this.mediaRecorder=null;this.audioElement=document.createElement("audio");this.audioElement.hidden=!0;this.audioElement.onended=function(c){b.stop()};document.body.appendChild(this.audioElement);this.playButton=this.stopButton=this.recordButton=null;this.progressBar=new BoxMorph;SoundRecorderDialogMorph.uber.init.call(this);this.labelString="Sound Recorder";this.createLabel();this.buildContents()};
SoundRecorderDialogMorph.prototype.buildContents=function(){var a=this,b=[];this.recordButton=new PushButtonMorph(this,"record",new SymbolMorph("circleSolid",10));this.stopButton=new PushButtonMorph(this,"stop",new SymbolMorph("rectangleSolid",10));this.playButton=new PushButtonMorph(this,"play",new SymbolMorph("pointRight",10));this.buildProgressBar();this.addBody(new AlignmentMorph("row",this.padding));this.body.add(this.recordButton);this.body.add(this.stopButton);this.body.add(this.playButton);
this.body.add(this.progressBar);this.body.fixLayout();navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({audio:{channelCount:1}}).then(function(c){a.mediaRecorder=new MediaRecorder(c);a.mediaRecorder.ondataavailable=function(d){b.push(d.data)};a.mediaRecorder.onstop=function(d){d=new Blob(b);var e=new window.FileReader;e.readAsDataURL(d);e.onloadend=function(){var f=e.result;f="data:audio/ogg;base64,"+f.split(",")[1];a.audioElement.src=f;a.audioElement.load();
b=[]}}});this.addButton("ok","Save");this.addButton("cancel","Cancel");this.fixLayout();this.rerender()};
SoundRecorderDialogMorph.prototype.buildProgressBar=function(){var a=new Morph,b=this;this.progressBar.setExtent(new Point(150,20));this.progressBar.setColor(new Color(200,200,200));this.progressBar.setBorderWidth(1);this.progressBar.setBorderColor(new Color(150,150,150));a.setExtent(new Point(130,2));a.setColor(new Color(50,50,50));a.setCenter(this.progressBar.center());this.progressBar.add(a);this.progressBar.indicator=new Morph;this.progressBar.indicator.setExtent(new Point(5,15));this.progressBar.indicator.setColor(new Color(50,
200,50));this.progressBar.indicator.setCenter(a.leftCenter());this.progressBar.add(this.progressBar.indicator);this.progressBar.setPercentage=function(c){this.indicator.setLeft(a.left()+a.width()/100*c-this.indicator.width()/2)};this.progressBar.step=function(){b.audioElement.duration?this.setPercentage(b.audioElement.currentTime/b.audioElement.duration*100):this.setPercentage(0)}};
SoundRecorderDialogMorph.prototype.record=function(){this.mediaRecorder&&"inactive"!==this.mediaRecorder.state?this.stop():(this.mediaRecorder.start(),this.recordButton.label.setColor(new Color(255,0,0)),this.playButton.label.setColor(new Color(0,0,0)))};
SoundRecorderDialogMorph.prototype.stop=function(){this.mediaRecorder&&"inactive"!==this.mediaRecorder.state&&this.mediaRecorder.stop();this.audioElement.pause();this.audioElement.currentTime=0;this.recordButton.label.setColor(new Color(0,0,0));this.playButton.label.setColor(new Color(0,0,0))};SoundRecorderDialogMorph.prototype.play=function(){this.stop();this.audioElement.oncanplaythrough=function(){this.play();this.oncanplaythrough=nop};this.playButton.label.setColor(new Color(0,255,0))};
SoundRecorderDialogMorph.prototype.ok=function(){var a=this;this.stop();this.audioElement.oncanplaythrough=function(){this.duration&&Infinity!==this.duration?(a.accept(this),this.oncanplaythrough=nop,a.destroy()):(a.buttons.children.forEach(function(b){return b.disable()}),this.play())}};SoundRecorderDialogMorph.prototype.destroy=function(){this.stop();this.audioElement.remove();this.mediaRecorder&&this.mediaRecorder.stream&&this.mediaRecorder.stream.getTracks()[0].stop();SoundRecorderDialogMorph.uber.destroy.call(this)};
modules.paint="2020-July-13";PaintEditorMorph.prototype=new DialogBoxMorph;PaintEditorMorph.prototype.constructor=PaintEditorMorph;PaintEditorMorph.uber=DialogBoxMorph.prototype;PaintEditorMorph.prototype.padding=10;function PaintEditorMorph(){this.init()}PaintEditorMorph.prototype.init=function(){this.oncancel=this.paper=null;PaintEditorMorph.uber.init.call(this);this.labelString="Paint Editor";this.createLabel();this.buildContents()};
PaintEditorMorph.prototype.buildContents=function(){var a=this;this.paper=new PaintCanvasMorph(function(){return a.shift});this.paper.setExtent(StageMorph.prototype.dimensions);this.addBody(new AlignmentMorph("row",this.padding));this.controls=new AlignmentMorph("column",this.padding/2);this.controls.alignment="center";this.edits=new AlignmentMorph("row",this.padding/2);this.buildEdits();this.controls.add(this.edits);this.body.color=this.color;this.body.add(this.controls);this.body.add(this.paper);
this.toolbox=new BoxMorph;this.toolbox.color=SpriteMorph.prototype.paletteColor.lighter(8);this.toolbox.borderColor=this.toolbox.color.lighter(40);MorphicPreferences.isFlat&&(this.toolbox.edge=0);this.buildToolbox();this.controls.add(this.toolbox);this.scaleBox=new AlignmentMorph("row",this.padding/2);this.buildScaleBox();this.controls.add(this.scaleBox);this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null};this.populatePropertiesMenu();
this.addButton("ok","OK");this.addButton("cancel","Cancel");this.refreshToolButtons();this.fixLayout()};
PaintEditorMorph.prototype.buildToolbox=function(){var a={brush:"Paintbrush tool\n(free draw)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: vertical/horizontal)",rectangleSolid:"Filled Rectangle\n(shift: square)",circleSolid:"Filled Ellipse\n(shift: circle)",paintbucket:"Fill a region",pipette:"Pipette tool\n(pick a color anywhere)"},b=this,c=this.toolbox.left(),d=this.toolbox.top(),
e=0,f=0;Object.keys(a).forEach(function(g){var h=b.toolButton(g,a[g]);h.setPosition(new Point(c+e,d+f));e+=h.width()+2;"crosshairs"===g&&(e=0,f+=h.height()+2,b.paper.drawcrosshair());b.toolbox[g]=h;b.toolbox.add(h)});this.toolbox.bounds=this.toolbox.fullBounds().expandBy(10)};
PaintEditorMorph.prototype.buildEdits=function(){var a=this,b=this.paper;this.edits.add(this.pushButton("undo",function(){b.undo()}));this.edits.add(this.pushButton("clear",function(){b.clearCanvas()}));this.edits.add(this.pushButton("Vector",function(){0<a.paper.undoBuffer.length?a.ide.confirm("This will erase your current drawing.\nAre you sure you want to continue?","Switch to vector editor?",function(){setTimeout(function(){a.switchToVector()})}):a.switchToVector()}));this.edits.fixLayout()};
PaintEditorMorph.prototype.buildScaleBox=function(){var a=this.paper;this.scaleBox.add(this.pushButton(new SymbolMorph("grow",18),function(){a.scale(.05,.05)},"grow"));this.scaleBox.add(this.pushButton(new SymbolMorph("shrink",18),function(){a.scale(-.05,-.05)},"shrink"));this.scaleBox.add(this.pushButton(new SymbolMorph("flipHorizontal",18),function(){a.scale(-2,0)},"flip horizontal"));this.scaleBox.add(this.pushButton(new SymbolMorph("flipVertical",18),function(){a.scale(0,-2)},"flip vertical"));
this.scaleBox.fixLayout()};
PaintEditorMorph.prototype.openIn=function(a,b,c,d,e){var f=this;this.oldim=b;this.callback=d||nop;this.ide=e;this.processKeyUp=function(){f.shift=!1;f.propertiesControls.constrain.refresh()};this.processKeyDown=function(){f.shift=16===f.world().currentKey;f.propertiesControls.constrain.refresh()};this.oldim&&(this.paper.automaticCrosshairs=isNil(c),this.paper.centermerge(this.oldim,this.paper.paper),this.paper.rotationCenter=(c||new Point(0,0)).add(new Point((this.paper.paper.width-this.oldim.width)/
2,(this.paper.paper.height-this.oldim.height)/2)),this.paper.drawNew());this.key="paint";this.popUp(a)};PaintEditorMorph.prototype.fixLayout=function(){this.changed();this.paper&&(this.paper.buildContents(),this.paper.drawNew());this.controls&&this.controls.fixLayout();this.body&&this.body.fixLayout();PaintEditorMorph.uber.fixLayout.call(this);this.changed()};PaintEditorMorph.prototype.refreshToolButtons=function(){this.toolbox.children.forEach(function(a){a.refresh()})};
PaintEditorMorph.prototype.ok=function(){this.paper.updateAutomaticCenter();this.callback(this.paper.paper,this.paper.rotationCenter);this.destroy()};PaintEditorMorph.prototype.cancel=function(){if(this.oncancel)this.oncancel();this.destroy()};PaintEditorMorph.prototype.switchToVector=function(){this.object=new SVG_Costume(new Image,"",new Point(0,0));this.object.edit(this.world(),this.ide,!0)};
PaintEditorMorph.prototype.populatePropertiesMenu=function(){var a=this.controls,b=this,c=this.propertiesControls,d=new AlignmentMorph("row",this.padding),e=new AlignmentMorph("column",3);e.alignment="left";c.primaryColorViewer=new Morph;c.primaryColorViewer.isCachingImage=!0;c.primaryColorViewer.render=function(f){var g=b.paper.settings.primarycolor,h;if("transparent"===g)for(g=0;180>g;g+=5)for(h=0;15>h;h+=5)f.fillStyle=0===(h+g)/5%2?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",f.fillRect(g,h,5,5);
else f.fillStyle=g.toString(),f.fillRect(0,0,180,15);f.strokeStyle="black";f.lineWidth=Math.min(b.paper.settings.linewidth,20);f.beginPath();f.lineCap="round";f.moveTo(20,30);f.lineTo(160,30);f.stroke()};c.primaryColorViewer.setExtent(new Point(180,40));c.primaryColorViewer.color=new Color(0,0,0);c.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(f){b.paper.settings.primarycolor=f;c.primaryColorViewer.rerender()});c.colorpicker.isCachingImage=!0;c.colorpicker.action(new Color(0,0,
0));c.penSizeSlider=new SliderMorph(0,20,5,5);c.penSizeSlider.orientation="horizontal";c.penSizeSlider.setHeight(15);c.penSizeSlider.setWidth(150);c.penSizeSlider.action=function(f){c.penSizeField&&c.penSizeField.setContents(f);b.paper.settings.linewidth=f;c.colorpicker.action(b.paper.settings.primarycolor)};c.penSizeField=new InputFieldMorph("5",!0,null,!1);c.penSizeField.contents().minWidth=20;c.penSizeField.setWidth(25);c.penSizeField.accept=function(){var f=parseFloat(c.penSizeField.getValue());
c.penSizeSlider.value=f;c.penSizeSlider.updateValue();this.setContents(f);b.paper.settings.linewidth=f;this.world().keyboardFocus=b;c.colorpicker.action(b.paper.settings.primarycolor)};d.add(c.penSizeSlider);d.add(c.penSizeField);d.color=b.color;d.fixLayout();c.penSizeField.fixLayout();c.constrain=new ToggleMorph("checkbox",this,function(){b.shift=!b.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return b.shift});c.constrain.label.isBold=!1;a.add(c.colorpicker);a.add(c.primaryColorViewer);
e.add(new StringMorph(localize("Brush size")+":",10,null,!0));e.add(d);e.add(c.constrain);e.fixLayout();a.add(e)};PaintEditorMorph.prototype.toolButton=function(a,b){var c=this;var d=new ToggleButtonMorph(null,this,function(){c.paper.currentTool=a;c.paper.toolChanged(a);c.refreshToolButtons();"pipette"===a&&c.getUserColor()},new SymbolMorph(a,18),function(){return c.paper.currentTool===a});d.hint=b;return d};
PaintEditorMorph.prototype.pushButton=function(a,b,c){return new PushButtonMorph(this,b,a,null,c)};
PaintEditorMorph.prototype.getUserColor=function(){var a=this,b=this.world(),c=b.hand,d=getDocumentPositionOf(b.worldCanvas),e=c.processMouseMove,f=c.processMouseDown,g=c.processMouseUp;c.processMouseMove=function(h){c.setPosition(new Point(h.pageX-d.x,h.pageY-d.y));h=b.getGlobalPixelColor(c.position());h.a&&(h.a=1,a.propertiesControls.colorpicker.action(h))};c.processMouseDown=nop;c.processMouseUp=function(){a.paper.currentTool="brush";a.paper.toolChanged("brush");a.refreshToolButtons();c.processMouseMove=
e;c.processMouseDown=f;c.processMouseUp=g}};PaintColorPickerMorph.prototype=new Morph;PaintColorPickerMorph.prototype.constructor=PaintColorPickerMorph;PaintColorPickerMorph.uber=Morph.prototype;function PaintColorPickerMorph(a,b){this.init(a,b)}PaintColorPickerMorph.prototype.init=function(a,b){this.isCachingImage=!0;this.setExtent(a||new Point(200,100));this.action=b||nop};
PaintColorPickerMorph.prototype.render=function(a){var b,c;for(b=0;b<this.width();b+=1)for(c=0;c<this.height()-20;c+=1)a.fillStyle="hsl("+360*b/this.width()+",100%,"+100*c/(this.height()-20)+"%)",a.fillRect(b,c,1,1);for(b=0;b<this.width();b+=1)c=Math.floor(255*b/this.width()),a.fillStyle="rgb("+c+", "+c+", "+c+")",a.fillRect(b,this.height()-20,1,10);c=["black","white","gray"];for(b=0;b<c.length;b+=1)a.fillStyle=c[b],a.fillRect(b*this.width()/c.length,this.height()-10,this.width()/c.length,10);for(b=
2*this.width()/3;b<this.width();b+=2)for(c=this.height()-10;c<this.height();c+=2)0===(b+c)/2%2&&(a.fillStyle="#DDD",a.fillRect(b,c,2,2))};PaintColorPickerMorph.prototype.mouseDownLeft=function(a){a.subtract(this.position()).x>2*this.width()/3&&a.subtract(this.position()).y>this.height()-10?this.action("transparent"):this.action(this.getPixelColor(a))};PaintColorPickerMorph.prototype.mouseMove=PaintColorPickerMorph.prototype.mouseDownLeft;PaintCanvasMorph.prototype=new Morph;
PaintCanvasMorph.prototype.constructor=PaintCanvasMorph;PaintCanvasMorph.uber=Morph.prototype;function PaintCanvasMorph(a){this.init(a)}
PaintCanvasMorph.prototype.init=function(a){this.rotationCenter=new Point(240,180);this.previousDragPoint=this.dragRect=null;this.currentTool="brush";this.dragRect=new Rectangle;this.background=this.erasermask=this.paper=this.mask=null;this.settings={primarycolor:new Color(0,0,0,255),secondarycolor:new Color(0,0,0,255),linewidth:3};this.brushBuffer=[];this.undoBuffer=[];this.isShiftPressed=a||function(){return 16===this.world().currentKey};this.isCachingImage=this.automaticCrosshairs=!0;this.buildContents();
this.drawNew()};PaintCanvasMorph.prototype.calculateCanvasCenter=function(a){a=Costume.prototype.canvasBoundingBox(a);return null===a?null:new Point((a.origin.x+a.corner.x)/2,(a.origin.y+a.corner.y)/2)};PaintCanvasMorph.prototype.updateAutomaticCenter=function(){if(this.automaticCrosshairs){var a=this.calculateCanvasCenter(this.paper);null!==a&&(this.rotationCenter=a)}};
PaintCanvasMorph.prototype.scale=function(a,b){this.updateAutomaticCenter();this.mask=newCanvas(this.extent(),!0);var c=newCanvas(this.extent(),!0);c.getContext("2d").save();c.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y);c.getContext("2d").scale(1+a,1+b);c.getContext("2d").drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y);c.getContext("2d").restore();this.paper=c;this.drawNew();this.changed()};
PaintCanvasMorph.prototype.cacheUndo=function(){var a=newCanvas(this.extent(),!0);this.merge(this.paper,a);this.undoBuffer.push(a)};PaintCanvasMorph.prototype.undo=function(){0<this.undoBuffer.length&&(this.paper=newCanvas(this.extent(),!0),this.mask.width=this.mask.width+1-1,this.merge(this.undoBuffer.pop(),this.paper),this.drawNew(),this.changed())};PaintCanvasMorph.prototype.merge=function(a,b){b.getContext("2d").drawImage(a,0,0)};
PaintCanvasMorph.prototype.centermerge=function(a,b){b.getContext("2d").drawImage(a,(b.width-a.width)/2,(b.height-a.height)/2)};PaintCanvasMorph.prototype.clearCanvas=function(){this.buildContents();this.drawNew();this.changed()};PaintCanvasMorph.prototype.toolChanged=function(a){this.mask=newCanvas(this.extent(),!0,this.mask);"crosshairs"===a&&(this.updateAutomaticCenter(),this.drawcrosshair());this.drawNew();this.changed()};
PaintCanvasMorph.prototype.drawcrosshair=function(a){a=a||this.mask.getContext("2d");var b=this.rotationCenter;a.save();a.lineWidth=1;a.strokeStyle="black";a.clearRect(0,0,this.mask.width,this.mask.height);a.globalAlpha=.5;a.fillStyle="white";a.beginPath();a.arc(b.x,b.y,20,radians(0),radians(360),!1);a.closePath();a.fill();a.stroke();a.beginPath();a.arc(b.x,b.y,10,radians(0),radians(360),!1);a.stroke();a.beginPath();a.moveTo(0,b.y);a.lineTo(this.mask.width,b.y);a.stroke();a.beginPath();a.moveTo(b.x,
0);a.lineTo(b.x,this.mask.height);a.stroke();a.restore();this.drawNew()};
PaintCanvasMorph.prototype.floodfill=function(a){var b=this.paper.width,c=this.paper.height,d=this.paper.getContext("2d"),e=d.getImageData(0,0,b,c),f=e.data;a=[Math.round(Math.round(a.y)*b+a.x)];var g=function(m){m*=4;return[f[m],f[m+1],f[m+2],f[m+3]]};var h=g(a[0]);var k=function(m){return m[0]===h[0]&&m[1]===h[1]&&m[2]===h[2]&&m[3]===h[3]};if(0!==h[3]||"transparent"!==this.settings.primarycolor)if(h[0]!==this.settings.primarycolor.r||h[1]!==this.settings.primarycolor.g||h[2]!==this.settings.primarycolor.b||
h[3]!==255*this.settings.primarycolor.a)if(0!==h[3]||0!==this.settings.primarycolor.a){for(;0<a.length;){var l=a.pop();k(g(l))&&(1<l%b&&(a.push(l+1),a.push(l-1)),0<l&&l<c*b&&(a.push(l+b),a.push(l-b)));"transparent"===this.settings.primarycolor?f[4*l+3]=0:(f[4*l]=this.settings.primarycolor.r,f[4*l+1]=this.settings.primarycolor.g,f[4*l+2]=this.settings.primarycolor.b,f[4*l+3]=255*this.settings.primarycolor.a)}d.putImageData(e,0,0);this.drawNew();this.changed()}};
PaintCanvasMorph.prototype.mouseDownLeft=function(a){this.cacheUndo();this.dragRect.origin=a.subtract(this.bounds.origin);this.dragRect.corner=a.subtract(this.bounds.origin);this.previousDragPoint=this.dragRect.corner.copy();if("crosshairs"===this.currentTool)this.rotationCenter=a.subtract(this.bounds.origin),this.drawcrosshair();else{if("paintbucket"===this.currentTool)return this.floodfill(a.subtract(this.bounds.origin));"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool&&
(this.erasermask=newCanvas(this.extent(),!0,this.erasermask),this.merge(this.paper,this.erasermask))}};
PaintCanvasMorph.prototype.mouseMove=function(a){function b(){return l/Math.abs(l)*Math.max(Math.abs(l),Math.abs(m))}function c(){return m/Math.abs(m)*Math.max(Math.abs(l),Math.abs(m))}if("paintbucket"!==this.currentTool){a=a.subtract(this.bounds.origin);var d=this.mask.getContext("2d"),e=this.paper.getContext("2d"),f=this.dragRect.origin.x,g=this.dragRect.origin.y,h=a.x,k=a.y,l=(h-f)/2,m=(k-g)/2,n=this.paper.width;d.save();this.brushBuffer.push([h,k]);d.lineWidth=this.settings.linewidth;d.clearRect(0,
0,this.bounds.width(),this.bounds.height());this.dragRect.corner=a.subtract(this.dragRect.origin);"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool?(this.merge(this.erasermask,this.mask),e.clearRect(0,0,this.bounds.width(),this.bounds.height()),d.globalCompositeOperation="destination-out"):(d.fillStyle=this.settings.primarycolor.toString(),d.strokeStyle=this.settings.primarycolor.toString());switch(this.currentTool){case "rectangle":this.isShiftPressed()?d.strokeRect(f,g,
2*b(),2*c()):d.strokeRect(f,g,2*l,2*m);break;case "rectangleSolid":this.isShiftPressed()?d.fillRect(f,g,2*b(),2*c()):d.fillRect(f,g,2*l,2*m);break;case "brush":d.lineCap="round";d.lineJoin="round";d.beginPath();d.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]);for(e=0;e<this.brushBuffer.length;e+=1)d.lineTo(this.brushBuffer[e][0],this.brushBuffer[e][1]);d.stroke();break;case "line":d.beginPath();d.moveTo(f,g);this.isShiftPressed()?Math.abs(m)>Math.abs(l)?d.lineTo(f,k):d.lineTo(h,g):d.lineTo(h,
k);d.stroke();break;case "circle":case "circleSolid":d.beginPath();if(this.isShiftPressed())d.arc(f,g,(new Point(f,g)).distanceTo(new Point(h,k)),0,2*Math.PI,!1);else{for(e=0;e<n;e+=1)d.lineTo(e,2*m*Math.sqrt(2-Math.pow((e-f)/(2*l),2))+g);for(e=n;0<e;--e)d.lineTo(e,-2*m*Math.sqrt(2-Math.pow((e-f)/(2*l),2))+g)}d.closePath();"circleSolid"===this.currentTool?d.fill():"circle"===this.currentTool&&d.stroke();break;case "crosshairs":this.automaticCrosshairs=!1;this.rotationCenter=a.copy();this.drawcrosshair(d);
break;case "eraser":this.merge(this.paper,this.mask);d.save();d.globalCompositeOperation="destination-out";d.beginPath();d.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]);for(e=0;e<this.brushBuffer.length;e+=1)d.lineTo(this.brushBuffer[e][0],this.brushBuffer[e][1]);d.stroke();d.restore();this.paper=newCanvas(this.extent(),!0);this.merge(this.mask,this.paper);break;default:nop()}this.previousDragPoint=a;this.drawNew();d.restore();this.changed()}};
PaintCanvasMorph.prototype.mouseClickLeft=function(){"crosshairs"!==this.currentTool&&this.merge(this.mask,this.paper);this.brushBuffer=[]};PaintCanvasMorph.prototype.mouseLeaveDragging=PaintCanvasMorph.prototype.mouseClickLeft;
PaintCanvasMorph.prototype.buildContents=function(){this.background=newCanvas(this.extent(),!1,this.background);this.paper=newCanvas(this.extent(),!0,this.paper);this.mask=newCanvas(this.extent(),!0,this.mask);this.erasermask=newCanvas(this.extent(),!0,this.erasermask);var a,b,c=this.background.getContext("2d");for(a=0;a<this.background.width;a+=5)for(b=0;b<this.background.height;b+=5)c.fillStyle=1===(a+b)/5%2?"rgba(255, 255, 255, 1)":"rgba(255, 255, 255, 0.3)",c.fillRect(a,b,5,5)};
PaintCanvasMorph.prototype.drawNew=function(){var a=newCanvas(this.extent(),!0,this.cachedImage);this.merge(this.background,a);this.merge(this.paper,a);this.merge(this.mask,a);this.cachedImage=a;this.drawFrame()};PaintCanvasMorph.prototype.rerender=PaintCanvasMorph.prototype.drawNew;
PaintCanvasMorph.prototype.drawFrame=function(){var a=this.cachedImage.getContext("2d");if(this.parent){this.color=this.parent.color.lighter(.75*this.contrast);var b=this.parent.color}else b=new Color(120,120,120);a.fillStyle=this.color.toString();this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();this.drawRectBorder(a)};PaintCanvasMorph.prototype.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;
PaintCanvasMorph.prototype.edge=InputFieldMorph.prototype.edge;PaintCanvasMorph.prototype.fontSize=InputFieldMorph.prototype.fontSize;PaintCanvasMorph.prototype.typeInPadding=InputFieldMorph.prototype.typeInPadding;PaintCanvasMorph.prototype.contrast=InputFieldMorph.prototype.contrast;modules.video="2019-May-22";
function VideoMotion(a,b){this.width=a;this.height=b;this.frameNumber=0;this.winSize=8;this.motionDirection=this.motionAmount=this.lastAnalyzedFrame=0;this.imageBuffer=new ArrayBuffer(this.width*this.height*2);this.curr=new Uint8ClampedArray(this.imageBuffer,0,this.width*this.height);this.prev=new Uint8ClampedArray(this.imageBuffer,this.width*this.height,this.width*this.height);this.threshold=30;this.amountScale=100;this.toDegree=180/Math.PI}
VideoMotion.prototype.reset=function(a,b){this.width=a;this.height=b;this.lastAnalyzedFrame=this.frameNumber=0;this.imageBuffer=new ArrayBuffer(this.width*this.height*2);this.curr=new Uint8ClampedArray(this.imageBuffer,0,this.width*this.height);this.prev=new Uint8ClampedArray(this.imageBuffer,this.width*this.height,this.width*this.height)};
VideoMotion.prototype.addFrame=function(a){var b=this.prev;a=new Uint32Array(a.buffer.slice(0));this.frameNumber++;this.prev=this.curr;this.curr=b;for(b=0;b<a.length;b++)this.curr[b]=a[b]&255};
VideoMotion.prototype.getStageMotion=function(){var a=0,b=0,c=0,d,e,f,g=2*this.winSize+1,h=this.width-this.winSize-1,k=this.height-this.winSize-1,l,m,n,q;if(!this.curr||!this.prev)this.motionAmount=this.motionDirection=-1;else if(this.lastAnalyzedFrame!==this.frameNumber){this.lastAnalyzedFrame=this.frameNumber;for(d=this.winSize+1;d<k;d+=g)for(e=this.winSize+1;e<h;e+=g){var p=q=n=m=l=0;var t=(d-this.winSize)*this.width+e-this.winSize;var r=t+g;for(f=(d+this.winSize)*this.width+e+this.winSize;t<=
f;t+=this.width-g,r+=this.width)for(;t<=r;t+=1){var u=this.prev[t]-this.curr[t];var v=this.curr[t-1]-this.curr[t+1];var w=this.curr[t-this.width]-this.curr[t+this.width];l+=v*v;m+=v*w;n+=w*w;p+=v*u;q+=w*u}t=this.getMotionVector(l,m,n,p,q);-g<t.u&&t.u<g&&-g<t.v&&t.v<g&&(a+=t.u,b+=t.v,c++)}a/=c;b/=c;this.motionAmount=Math.round(this.amountScale*Math.hypot(a,b));this.motionAmount>this.threshold&&(this.motionDirection=((Math.atan2(b,a)*this.toDegree+270)%360-180).toFixed(2))}};
VideoMotion.prototype.getMotionVector=function(a,b,c,d,e){var f=b*b-a*c;var g={u:0,v:0};f?(f=8/f,g.u=-(e*b-d*c)*f,g.v=-(b*d-a*e)*f):(f=(b+a)*(b+a)+(c+b)*(c+b))?(f=8/f,g.u=(b+a)*-(e+d)*f,g.v=(c+b)*-(e+d)*f):(g.u=0,g.v=0);return g};
VideoMotion.prototype.getLocalMotion=function(a){var b=a.parentThatIsA(StageMorph),c=0,d=Math.floor(a.width()/b.scale),e=this.winSize,f=0,g=0,h=0,k=0,l=0,m=this.threshold/3,n=2E-4*this.amountScale,q=0,p;if(!this.curr||!this.prev)a.motionAmount=a.motionDirection=-1;else if(a.frameNumber!==this.frameNumber){var t=a.getImageData();var r=a.parentThatIsA(StageMorph);var u=r.scale;var v=p=0;var w=Math.floor(a.extent().x/u);var x=Math.floor(a.extent().y/u);a.left()<r.left()&&(w=Math.max(Math.floor((a.right()-
r.left())/u),0),p=Math.floor(a.width()/u-w));a.right()>r.right()&&(w=Math.max(Math.floor((r.right()-a.left())/u),0));a.top()<r.top()&&(x=Math.max(Math.floor((a.bottom()-r.top())/u),0),v=Math.floor(a.height()/u-x));a.bottom()>r.bottom()&&(x=Math.max(Math.floor((r.bottom()-a.top())/u),0));r=Math.max(Math.floor((a.left()-b.left())/b.scale),0);var y=Math.max(Math.floor((a.top()-b.top())/b.scale),0);u=Math.min(w+r,b.dimensions.x);b=Math.min(x+y,b.dimensions.y-1);p=v*d+p;for(v=y;v<b;v++,p+=d-w)for(y=r;y<
u;y++,++p)if(0<y&&y<this.width&&0<v&&v<this.height&&255==(t[p]>>24&255)){var B=v*this.width+y;x=this.prev[B]-this.curr[B];var A=this.curr[B-1]-this.curr[B+1];B=this.curr[B-this.width]-this.curr[B+this.width];f+=A*A;g+=A*B;h+=B*B;l+=A*x;k+=B*x;q++}d=this.getMotionVector(f,g,h,l,k);q&&(c=q,q/=4*e*e,d.u/=q,d.v/=q);a.motionAmount=Math.round(n*c*Math.hypot(d.u,d.v));100<a.motionAmount&&(a.motionAmount=100);a.motionAmount>m&&(a.motionDirection=((Math.atan2(d.v,d.u)*this.toDegree+270)%360-180).toFixed(2));
a.frameNumber=this.frameNumber}};modules.sketch="2020-July-13";VectorShape.prototype={};VectorShape.prototype.constructor=VectorShape;VectorShape.uber=Object.prototype;function VectorShape(a,b,c){this.init(a,b,c)}VectorShape.prototype.init=function(a,b,c){this.borderWidth=b&&b.a?a:0;this.borderColor=b||new Color(0,0,0,0);this.fillColor=c||new Color(0,0,0,0);this.image=newCanvas();this.isCrosshair=this.isSelection=this.isPolygon=!1;this.origin=new Point;this.destination=new Point};
VectorShape.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])};
VectorShape.prototype.asSVG=function(a){a=new XML_Element(a);this.borderColor&&this.borderColor.a?(a.attributes.stroke=this.borderColor.toRGBstring(),a.attributes["stroke-linejoin"]="miter",a.attributes["stroke-width"]=this.borderWidth):a.attributes.stroke="none";a.attributes.fill=this.fillColor&&this.fillColor.a?this.fillColor.toRGBstring():"none";a.attributes.prototype=this.constructor.name;return a};
VectorShape.prototype.imageURL=function(){var a=new XML_Element("svg"),b=this.bounds();a.attributes.xmlns="http://www.w3.org/2000/svg";a.attributes.version="1.1";a.attributes.preserveAspectRatio="xMinYMin meet";a.attributes.viewBox=b.left()+" "+b.top()+" "+(b.right()-b.left())+" "+(b.bottom()-b.top());a.attributes.width=b.right()-b.left();a.attributes.height=b.bottom()-b.top();a.children=[this.asSVG()];return"data:image/svg+xml;base64,"+a};
VectorShape.prototype.copy=function(a){a=a||new VectorShape(this.borderWidth,this.borderColor,this.fillColor);a.image.width=this.image.width;a.image.height=this.image.height;a.image.getContext("2d").drawImage(this.image,0,0);return a};
VectorShape.prototype.bounds=function(){return new Rectangle(Math.min(this.origin.x,this.destination.x)-this.borderWidth/2,Math.min(this.origin.y,this.destination.y)-this.borderWidth/2,Math.max(this.origin.x,this.destination.x)+this.borderWidth/2,Math.max(this.origin.y,this.destination.y)+this.borderWidth/2)};VectorShape.prototype.containsPoint=function(a){return this.bounds().containsPoint(a)};VectorShape.prototype.update=function(a,b){this.destination=b?this.constraintPoint(a):a};
VectorShape.prototype.constraintPoint=function(a){a=a.subtract(this.origin);a=new Point(a.x/Math.abs(a.x)*Math.max(Math.abs(a.x),Math.abs(a.y)),a.y/Math.abs(a.y)*Math.max(Math.abs(a.x),Math.abs(a.y)));return this.origin.add(a)};VectorShape.prototype.setColor=function(a,b){b?this.borderColor=a:this.fillColor=a};VectorShape.prototype.setBorderWidth=function(a){this.borderColor&&this.borderColor.a&&(this.borderWidth=a)};
VectorShape.prototype.moveBy=function(a){this.origin=this.origin.add(a);this.destination=this.destination.add(a)};VectorShape.prototype.resizeBy=function(a,b){this.origin=this.origin.subtract(b).multiplyBy(a).add(b);this.destination=this.destination.subtract(b).multiplyBy(a).add(b)};
VectorShape.prototype.drawOn=function(a){var b=this,c=this.bounds().origin.subtract(a.position()),d=new Image;this.image=newCanvas(a.extent());d.onload=function(){b.image.getContext("2d").drawImage(d,c.x,c.y);a.redraw=!0};d.src=this.imageURL()};VectorRectangle.prototype=new VectorShape;VectorRectangle.prototype.constructor=VectorRectangle;VectorRectangle.uber=VectorShape.prototype;function VectorRectangle(a,b,c,d,e){VectorRectangle.uber.init.call(this,a,b,c);this.init(d,e)}
VectorRectangle.prototype.init=function(a,b){this.origin=a;this.destination=b};VectorRectangle.fromSVG=function(a){a=a.attributes;return new VectorRectangle(parseInt(a["stroke-width"]),"none"===a.stroke?null:Color.fromString(a.stroke),"none"===a.fill?null:Color.fromString(a.fill),new Point(parseInt(a.x),parseInt(a.y)),new Point(parseInt(a.x)+parseInt(a.width),parseInt(a.y)+parseInt(a.height)))};
VectorRectangle.prototype.copy=function(){var a=new VectorRectangle(this.borderWidth,this.borderColor,this.fillColor,this.origin.copy(),this.destination.copy());return VectorRectangle.uber.copy.call(this,a)};VectorRectangle.prototype.toString=function(){return VectorRectangle.uber.toString.call(this)+this.bounds().toString()};VectorRectangle.prototype.width=function(){return Math.abs(this.origin.x-this.destination.x)};VectorRectangle.prototype.height=function(){return Math.abs(this.origin.y-this.destination.y)};
VectorRectangle.prototype.x=function(){return Math.min(this.origin.x,this.destination.x)};VectorRectangle.prototype.y=function(){return Math.min(this.origin.y,this.destination.y)};VectorRectangle.prototype.asSVG=function(){var a=VectorRectangle.uber.asSVG.call(this,"rect");a.attributes.width=this.width();a.attributes.height=this.height();a.attributes.x=this.x();a.attributes.y=this.y();return a};
VectorRectangle.prototype.drawOn=function(a){var b=a.position();this.image=newCanvas(a.extent());var c=this.image.getContext("2d");c.beginPath();c.rect(this.x()-b.x,this.y()-b.y,this.width(),this.height());0<this.fillColor.a&&(c.fillStyle=this.fillColor.toRGBstring(),c.fill());0<this.borderColor.a&&(c.lineWidth=this.borderWidth,c.strokeStyle=this.borderColor.toRGBstring(),c.stroke());a.redraw=!0};VectorLine.prototype=new VectorShape;VectorLine.prototype.constructor=VectorLine;VectorLine.uber=VectorShape.prototype;
function VectorLine(a,b,c,d){VectorLine.uber.init.call(this,a,b);this.init(c,d)}VectorLine.prototype.init=function(a,b){this.origin=a;this.destination=b};VectorLine.fromSVG=function(a){a=a.attributes;return new VectorLine(parseInt(a["stroke-width"]),Color.fromString(a.stroke),new Point(parseInt(a.x1),parseInt(a.y1)),new Point(parseInt(a.x2),parseInt(a.y2)))};
VectorLine.prototype.copy=function(){var a=new VectorLine(this.borderWidth,this.borderColor.copy(),this.origin.copy(),this.destination.copy());return VectorLine.uber.copy.call(this,a)};VectorLine.prototype.containsPoint=function(a){var b=this.origin.distanceTo(this.destination);a=a.distanceTo(this.origin)+a.distanceTo(this.destination);return Math.abs(b-a)<=Math.sqrt(this.borderWidth/2)/2};
VectorLine.prototype.constraintPoint=function(a){var b=a;var c=b.subtract(this.origin).abs().degrees();22.5>c?b.y=this.origin.y:67.5<c?b.x=this.origin.x:b=VectorLine.uber.constraintPoint.call(this,a);return b};VectorLine.prototype.setColor=function(a,b){VectorLine.uber.setColor.call(this,a,!b)};VectorLine.prototype.toString=function(){return VectorLine.uber.toString.call(this)+this.bounds().toString()};
VectorLine.prototype.asSVG=function(){var a=VectorLine.uber.asSVG.call(this,"line");a.attributes.x1=this.origin.x;a.attributes.y1=this.origin.y;a.attributes.x2=this.destination.x;a.attributes.y2=this.destination.y;return a};
VectorLine.prototype.drawOn=function(a){var b=this.origin.subtract(a.position()),c=this.destination.subtract(a.position());this.image=newCanvas(a.extent());var d=this.image.getContext("2d");d.beginPath();0<this.borderColor.a&&(d.lineWidth=this.borderWidth,d.strokeStyle=this.borderColor.toRGBstring(),d.moveTo(b.x,b.y),d.lineTo(c.x,c.y),d.stroke());a.redraw=!0};VectorEllipse.prototype=new VectorShape;VectorEllipse.prototype.constructor=VectorEllipse;VectorEllipse.uber=VectorShape.prototype;
function VectorEllipse(a,b,c,d,e){VectorEllipse.uber.init.call(this,a,b,c);this.init(d,e)}VectorEllipse.prototype.init=function(a,b){this.origin=a;this.destination=b};VectorEllipse.fromSVG=function(a){a=a.attributes;return new VectorEllipse(parseInt(a["stroke-width"]),"none"===a.stroke?null:Color.fromString(a.stroke),"none"===a.fill?null:Color.fromString(a.fill),new Point(parseInt(a.cx),parseInt(a.cy)),new Point(parseInt(a.cx)+parseInt(a.rx),parseInt(a.cy)+parseInt(a.ry)))};
VectorEllipse.prototype.copy=function(){var a=new VectorEllipse(this.borderWidth,this.borderColor,this.fillColor,this.origin.copy(),this.destination.copy());return VectorEllipse.uber.copy.call(this,a)};VectorEllipse.prototype.hRadius=function(){return Math.abs(this.destination.x-this.origin.x)};VectorEllipse.prototype.vRadius=function(){return Math.abs(this.destination.y-this.origin.y)};
VectorEllipse.prototype.toString=function(){return VectorEllipse.uber.toString.call(this)+" center: "+this.origin.toString()+" radii: "+this.hRadius().toString()+","+this.vRadius().toString()};VectorEllipse.prototype.bounds=function(){var a=this.hRadius(),b=this.vRadius();return new Rectangle(this.origin.x-a-this.borderWidth/2,this.origin.y-b-this.borderWidth/2,this.origin.x+a+this.borderWidth/2,this.origin.y+b+this.borderWidth/2)};
VectorEllipse.prototype.containsPoint=function(a){return 1>Math.pow(a.x-this.origin.x,2)/Math.pow(this.hRadius()+this.borderWidth/2,2)+Math.pow(a.y-this.origin.y,2)/Math.pow(this.vRadius()+this.borderWidth/2,2)};VectorEllipse.prototype.asSVG=function(){var a=VectorEllipse.uber.asSVG.call(this,"ellipse");a.attributes.cx=this.origin.x;a.attributes.cy=this.origin.y;a.attributes.rx=this.hRadius();a.attributes.ry=this.vRadius();return a};
VectorEllipse.prototype.drawOn=function(a){var b=a.position();this.image=newCanvas(a.extent());var c=this.image.getContext("2d");c.beginPath();c.ellipse(this.origin.x-b.x,this.origin.y-b.y,this.hRadius(),this.vRadius(),0,0,2*Math.PI,!0);this.fillColor&&0<this.fillColor.a&&(c.fillStyle=this.fillColor.toRGBstring(),c.fill());0<this.borderColor.a&&(c.lineWidth=this.borderWidth,c.strokeStyle=this.borderColor.toRGBstring(),c.stroke());a.redraw=!0};VectorPolygon.prototype=new VectorShape;
VectorPolygon.prototype.constructor=VectorPolygon;VectorPolygon.uber=VectorShape.prototype;function VectorPolygon(a,b,c,d,e,f){VectorPolygon.uber.init.call(this,a,b,c);this.init(d,e,f)}VectorPolygon.prototype.init=function(a,b,c){this.points=a||[];this.isClosed=b;this.isFreeHand=c;this.isPolygon=!0};
VectorPolygon.fromSVG=function(a){a=a.attributes;var b=a.d.slice(1).split(/L */).map(function(c){c=c.split(" ");return new Point(parseInt(c[0]),parseInt(c[1]))});return new VectorPolygon(parseInt(a["stroke-width"]),"none"===a.stroke?null:Color.fromString(a.stroke),"none"===a.fill?null:Color.fromString(a.fill),b,b[0].eq(b[b.length-1]),!1)};
VectorPolygon.prototype.copy=function(){var a=new VectorPolygon(this.borderWidth,this.borderColor,this.fillColor,this.points.map(function(b){return b.copy()}),this.isClosed,this.isFreeHand);return VectorPolygon.uber.copy.call(this,a)};VectorPolygon.prototype.toString=function(){return VectorPolygon.uber.toString.call(this)+this.points};
VectorPolygon.prototype.bounds=function(){var a=this.points[0].x,b=this.points[0].y,c=this.points[this.points.length-1].x,d=this.points[this.points.length-1].y;this.points.forEach(function(e){a=Math.min(a,e.x);b=Math.min(b,e.y);c=Math.max(c,e.x);d=Math.max(d,e.y)});return new Rectangle(a-this.borderWidth/2,b-this.borderWidth/2,c+this.borderWidth/2,d+this.borderWidth/2)};
VectorPolygon.prototype.containsPoint=function(a){var b=this.points.length,c=!1,d;for(d=1;d<b;d+=1){var e=this.points[d-1];var f=this.points[d];if(Math.abs(e.distanceTo(f)-(a.distanceTo(e)+a.distanceTo(f)))<=Math.sqrt(this.borderWidth/2)/2)return!0}if(this.isClosed){d=0;for(e=b-1;d<b;d+=1)this.points[d].y>a.y!==this.points[e].y>a.y&&a.x<(this.points[e].x-this.points[d].x)*(a.y-this.points[d].y)/(this.points[e].y-this.points[d].y)+this.points[d].x&&(c=!c),e=d;return c}return!1};
VectorPolygon.prototype.update=function(a,b){this.isFreeHand||1===this.points.length?this.points.push(a):this.isFreeHand||(b&&(this.origin=this.points[this.points.length-2],a=VectorLine.prototype.constraintPoint.call(this,a)),this.points[this.points.length-1]=a)};VectorPolygon.prototype.setColor=function(a,b){VectorPolygon.uber.setColor.call(this,a,!this.isClosed||b)};VectorPolygon.prototype.moveBy=function(a){this.points.forEach(function(b){b.x+=a.x;b.y+=a.y})};
VectorPolygon.prototype.resizeBy=function(a,b){this.points=this.points.map(function(c){return c.subtract(b).multiplyBy(a).add(b)})};VectorPolygon.prototype.close=function(){this.isClosed&&this.points.push(this.points[0].copy())};
VectorPolygon.prototype.asSVG=function(){var a=VectorPolygon.uber.asSVG.call(this,"path");a.attributes["stroke-linejoin"]="round";a.attributes["stroke-linecap"]="round";a.attributes.d="M"+this.points[0].x+" "+this.points[0].y;this.points.slice(1).forEach(function(b){a.attributes.d+=" L "+b.x+" "+b.y});return a};
VectorPolygon.prototype.drawOn=function(a){var b=this.points.map(function(d){return d.subtract(a.position())});this.image=newCanvas(a.extent());var c=this.image.getContext("2d");c.lineCap="round";c.lineJoin="round";c.beginPath();c.moveTo(b[0].x,b[0].y);b.slice(1).forEach(function(d){c.lineTo(d.x,d.y)});this.fillColor&&0<this.fillColor.a&&(c.fillStyle=this.fillColor.toRGBstring(),c.fill());0<this.borderColor.a?(c.lineWidth=this.borderWidth,c.strokeStyle=this.borderColor.toRGBstring(),c.stroke()):2===
this.points.length&&(c.lineWidth=1,c.strokeStyle=this.fillColor.toRGBstring(),c.stroke());a.redraw=!0};VectorSelection.prototype=new VectorRectangle;VectorSelection.prototype.constructor=VectorSelection;VectorSelection.uber=VectorRectangle.prototype;function VectorSelection(a,b){VectorRectangle.uber.init.call(this,1,new Color(0,0,0,255),null);this.init(a,b)}VectorSelection.prototype.init=function(a,b){VectorSelection.uber.init.call(this,a,b);this.isSelection=!0;this.threshold=5};
VectorSelection.prototype.corners=function(){var a=this.bounds();return[a.topLeft(),a.topRight(),a.bottomLeft(),a.bottomRight()]};VectorSelection.prototype.cornerAt=function(a){var b=this.threshold;return this.corners().find(function(c){return a.distanceTo(c)<=b})};VectorSelection.prototype.cornerOppositeTo=function(a){return this.corners().reduce(function(b,c){return a.distanceTo(b)>a.distanceTo(c)?b:c})};
VectorSelection.prototype.drawOn=function(a){function b(h,k){g.beginPath();g.arc(h-d.x,k-d.y,f,0,2*Math.PI);g.stroke()}var c=this.bounds(),d=a.position(),e=c.origin.subtract(d),f=this.threshold;this.image=newCanvas(a.extent());var g=this.image.getContext("2d");g.rect(e.x,e.y,this.width(),this.height());g.setLineDash([5]);g.stroke();g.setLineDash([]);b(c.left(),c.top());b(c.left(),c.bottom());b(c.right(),c.top());b(c.right(),c.bottom());a.redraw=!0};Crosshair.prototype=VectorShape;
Crosshair.prototype.constructor=Crosshair;Crosshair.uber=VectorShape.prototype;function Crosshair(a,b){this.init(a,b)}Crosshair.prototype.init=function(a,b){this.center=a;this.paper=b;this.image=newCanvas();this.isCrosshair=!0};Crosshair.prototype.update=function(a){this.center=a.subtract(this.paper.position())};Crosshair.prototype.moveBy=function(a){this.center=this.center.add(a)};
Crosshair.prototype.drawOn=function(a){this.image=newCanvas(a.extent());a.rotationCenter=this.center.copy();a.drawcrosshair(this.image.getContext("2d"));a.redraw=!0};VectorPaintEditorMorph.prototype=new PaintEditorMorph;VectorPaintEditorMorph.prototype.constructor=VectorPaintEditorMorph;VectorPaintEditorMorph.uber=PaintEditorMorph.prototype;function VectorPaintEditorMorph(){this.init()}
VectorPaintEditorMorph.prototype.init=function(){this.paper=null;this.shapes=[];this.selection=[];this.selecting=!1;this.originalSelection=null;this.resizing=this.moving=!1;this.lastDragPosition=null;this.history=[];this.clipboard=[];this.currentShape=null;VectorPaintEditorMorph.uber.init.call(this);this.labelString="Vector Paint Editor";this.createLabel();this.fixLayout()};
VectorPaintEditorMorph.prototype.buildEdits=function(){var a=this;this.edits.add(this.pushButton("undo",function(){a.undo()}));this.edits.add(this.pushButton("clear",function(){a.paper.clearCanvas()}));this.edits.add(this.pushButton("Bitmap",function(){0<a.shapes.length?a.ide.confirm("This will convert your vector objects into\nbitmaps, and you will not be able to convert\nthem back into vector drawings.\nAre you sure you want to continue?","Convert to bitmap?",function(){setTimeout(function(){a.convertToBitmap()})}):
a.convertToBitmap()}));this.edits.fixLayout()};
VectorPaintEditorMorph.prototype.convertToBitmap=function(){var a=newCanvas(StageMorph.prototype.dimensions),b=this;this.object=new Costume;this.shapes.forEach(function(c){a.getContext("2d").drawImage(c.image,0,0)});this.object.rotationCenter=this.paper.rotationCenter.copy();this.object.contents=a;this.object.edit(this.world(),this.ide,!1,null,function(){b.ide.currentSprite.shadowAttribute("costumes");b.ide.currentSprite.addCostume(b.object);b.ide.spriteEditor.updateList();b.ide&&b.ide.currentSprite.wearCostume(b.object)})};
VectorPaintEditorMorph.prototype.buildScaleBox=function(){var a=this;["Top","Bottom","Up","Down"].forEach(function(b){a.scaleBox.add(a.pushButton(b,function(){a.changeSelectionLayer(b.toLowerCase())}))});this.scaleBox.fixLayout()};
VectorPaintEditorMorph.prototype.openIn=function(a,b,c,d,e,f){var g=this;b=isNil(f)||0===f.length;VectorPaintEditorMorph.uber.openIn.call(this,a,null,c,d,e);this.ide=e;this.paper.drawNew();this.paper.changed();f.forEach(function(h){h.drawOn(g.paper)});this.shapes=f.map(function(h){return h.copy()});this.shapes.forEach(function(h){h.drawOn(g.paper)});c&&!b?(this.paper.automaticCrosshairs=!1,this.paper.rotationCenter=this.getBounds(this.shapes).origin.subtract(this.paper.bounds.origin).add(c)):this.paper.automaticCrosshairs=
!0;this.updateHistory();this.processKeyUp=function(){g.shift=!1;g.ctrl=!1;g.propertiesControls.constrain.refresh()};this.processKeyDown=function(h){g.shift=16===g.world().currentKey;g.ctrl=h.ctrlKey;switch(g.world().currentKey){case 46:case 8:g.sortSelection();g.selection.slice().reverse().forEach(function(k){g.shapes.splice(g.shapes.indexOf(k),1)});g.clearSelection();g.updateHistory();break;case 13:g.currentShape&&g.currentShape.isPolygon&&(g.currentShape.close(),g.currentShape.drawOn(g.paper),g.shapes.push(g.currentShape),
g.currentShape=null,g.updateHistory());break;case 33:g.changeSelectionLayer("up");break;case 34:g.changeSelectionLayer("down");break;case 35:g.changeSelectionLayer("bottom");break;case 36:g.changeSelectionLayer("top");break;case 90:g.ctrl&&g.undo();break;case 67:g.ctrl&&g.selection.length&&(g.clipboard=g.selection.map(function(k){return k.copy()}));break;case 86:h=g.world().hand.position();g.ctrl&&g.paper.bounds.containsPoint(h)&&(g.paper.pasteAt(h),g.updateHistory());break;case 65:g.ctrl&&(g.paper.currentTool=
"selection",g.paper.toolChanged("selection"),g.refreshToolButtons(),g.paper.selectShapes(g.shapes));break;case 27:g.clearSelection();break;case 37:g.moveSelectionBy(new Point(-1,0));g.updateHistory();break;case 38:g.moveSelectionBy(new Point(0,-1));g.updateHistory();break;case 39:g.moveSelectionBy(new Point(1,0));g.updateHistory();break;case 40:g.moveSelectionBy(new Point(0,1));g.updateHistory();break;default:nop()}g.propertiesControls.constrain.refresh()}};
VectorPaintEditorMorph.prototype.buildContents=function(){VectorPaintEditorMorph.uber.buildContents.call(this);this.paper.destroy();this.paper=new VectorPaintCanvasMorph(this.shift);this.paper.setExtent(StageMorph.prototype.dimensions);this.body.add(this.paper);this.refreshToolButtons();this.fixLayout()};
VectorPaintEditorMorph.prototype.buildToolbox=function(){var a={brush:"Paintbrush tool\n(free draw)",rectangle:"Rectangle\n(shift: square)",ellipse:"Ellipse\n(shift: circle)",selection:"Selection tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: constrain to 45\u00ba)",closedBrush:"Closed brush\n(free draw)",polygon:"Polygon",paintbucket:"Paint a shape\n(shift: edge color)",pipette:"Pipette tool\n(pick a color from anywhere\nshift: fill color)"},b=this,c=this.toolbox.left(),d=this.toolbox.top(),
e=0,f=0;Object.keys(a).forEach(function(g){var h=b.toolButton(g,a[g]);h.setPosition(new Point(c+e,d+f));e+=h.width()+2;"crosshairs"===g&&(e=0,f+=h.height()+2,b.paper.drawcrosshair());b.toolbox[g]=h;b.toolbox.add(h)});this.toolbox.bounds=this.toolbox.fullBounds().expandBy(10)};
VectorPaintEditorMorph.prototype.populatePropertiesMenu=function(){var a=this.controls,b=this,c=this.propertiesControls,d=new AlignmentMorph("row",this.padding),e=new AlignmentMorph("row",this.padding),f=new AlignmentMorph("row",this.padding),g=new AlignmentMorph("column",3);g.alignment="left";c.primaryColorViewer=new Morph;c.primaryColorViewer.color=new Color(0,0,0);c.primaryColorViewer.setExtent(new Point(85,15));c.primaryColorViewer.render=function(h){b.renderColorSelection(h,b.paper.settings.primaryColor)};
c.secondaryColorViewer=new Morph;c.secondaryColorViewer.color=new Color(0,0,0);c.secondaryColorViewer.setExtent(new Point(85,15));c.secondaryColorViewer.render=function(h){b.renderColorSelection(h,b.paper.settings.secondaryColor)};c.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(h,k){b.selectColor(h,!k)});c.colorpicker.mouseDownRight=function(h){h.subtract(this.position()).x>2*this.width()/3&&h.subtract(this.position()).y>this.height()-10?this.action("transparent",!0):this.action(this.getPixelColor(h),
!0)};c.colorpicker.action(new Color(0,0,0));c.colorpicker.action("transparent",!0);c.penSizeSlider=new SliderMorph(0,20,5,5);c.penSizeSlider.orientation="horizontal";c.penSizeSlider.setHeight(15);c.penSizeSlider.setWidth(150);c.penSizeSlider.action=function(h){c.penSizeField&&c.penSizeField.setContents(h);b.paper.settings.lineWidth=h;b.selection.forEach(function(k){k.setBorderWidth(h);k.drawOn(b.paper);b.paper.updateSelection()});b.updateHistory()};c.penSizeField=new InputFieldMorph("3",!0,null,!1);
c.penSizeField.contents().minWidth=20;c.penSizeField.setWidth(25);c.penSizeField.accept=function(h){var k=parseFloat(c.penSizeField.getValue());c.penSizeSlider.value=k;c.penSizeSlider.updateValue();this.setContents(k);b.paper.settings.lineWidth=k;this.world().keyboardFocus=b;b.selection.forEach(function(l){l.setBorderWidth(h);l.drawOn(b.paper);b.paper.updateSelection()});b.updateHistory()};d.add(c.penSizeSlider);d.add(c.penSizeField);d.color=b.color;d.fixLayout();c.constrain=new ToggleMorph("checkbox",
this,function(){b.shift=!b.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return b.shift});c.constrain.label.isBold=!1;e.add(c.secondaryColorViewer);e.add(c.primaryColorViewer);e.fixLayout();f.add(new TextMorph(localize("Edge color\n(left click)"),10,null,null,null,"center",85));f.add(new TextMorph(localize("Fill color\n(right click)"),10,null,null,null,"center",85));f.fixLayout();a.add(c.colorpicker);a.add(f);a.add(e);g.add(new StringMorph(localize("Brush size")+
":",10,null,!0));g.add(d);g.add(c.constrain);g.fixLayout();a.add(g)};VectorPaintEditorMorph.prototype.selectColor=function(a,b){var c=this,d=this.paper.isShiftPressed()?!1:b;b=(d?"secondary":"primary")+"Color";this.paper.settings[b]=a;this.selection.length&&(this.selection.forEach(function(e){e.setColor(a,d);e.drawOn(c.paper)}),this.updateHistory());this.propertiesControls[b+"Viewer"].rerender()};
VectorPaintEditorMorph.prototype.renderColorSelection=function(a,b){b=void 0===b?"transparent":b;var c;if("transparent"===b||0===b.a)for(b=0;180>b;b+=5)for(c=0;15>c;c+=5)a.fillStyle=0===(c+b)/5%2?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",a.fillRect(b,c,5,5);else a.fillStyle=b.toString(),a.fillRect(0,0,180,15)};
VectorPaintEditorMorph.prototype.changeSelectionLayer=function(a){var b=this;this.sortSelection();switch(a){case "top":this.selection.forEach(function(c){b.shapes.splice(b.shapes.indexOf(c),1);b.shapes.push(c)});break;case "bottom":this.selection.slice().reverse().forEach(function(c){b.shapes.splice(b.shapes.indexOf(c),1);b.shapes.splice(0,0,c)});break;case "up":this.selection.forEach(function(c){var d=b.shapes.indexOf(c);b.shapes.splice(d,1);b.shapes.splice(d+b.selection.length,0,c)});break;case "down":this.shapes[0]!==
this.selection[0]&&this.selection.forEach(function(c){var d=b.shapes.indexOf(c);b.shapes.splice(d,1);b.shapes.splice(d-1,0,c)})}this.updateHistory();this.paper.redraw=!0};
VectorPaintEditorMorph.prototype.dragSelection=function(a){if(this.lastDragPosition)if(this.moving){var b=a.subtract(this.lastDragPosition);this.moveSelectionBy(b)}else this.resizing&&(this.shift&&(b=this.originalSelection.origin,a=Math.max((a.x-b.x)/(this.originalSelection.destination.x-b.x),(a.y-b.y)/(this.originalSelection.destination.y-b.y)),a=this.originalSelection.destination.subtract(b).multiplyBy(a).add(b)),b=a.subtract(this.currentShape.origin).divideBy(this.lastDragPosition.subtract(this.currentShape.origin)),
this.resizeSelectionBy(b));else this.resizing&&(this.originalSelection=this.currentShape.copy());this.lastDragPosition=a};VectorPaintEditorMorph.prototype.moveSelectionBy=function(a){var b=this.paper;this.selection.forEach(function(c){c.moveBy(a);c.drawOn(b)});this.currentShape&&this.currentShape.isSelection&&(this.currentShape.moveBy(a),this.currentShape.drawOn(b))};
VectorPaintEditorMorph.prototype.resizeSelectionBy=function(a){var b=this.paper;if(this.currentShape&&this.currentShape.isSelection){var c=this.currentShape;this.selection.forEach(function(d){d.resizeBy(a,c.origin);d.drawOn(b)});c.resizeBy(a,c.origin);c.drawOn(b)}};VectorPaintEditorMorph.prototype.sortSelection=function(){var a=this;this.selection.sort(function(b,c){return a.shapes.indexOf(b)>a.shapes.indexOf(c)})};
VectorPaintEditorMorph.prototype.clearSelection=function(){this.currentShape=null;this.selection=[];this.paper.redraw=!0};
VectorPaintEditorMorph.prototype.getSVG=function(){var a=new XML_Element("svg"),b=this.getBounds(this.shapes);a.attributes.xmlns="http://www.w3.org/2000/svg";a.attributes.snap="http://snap.berkeley.edu/run";a.attributes.version="1.1";a.attributes.preserveAspectRatio="none meet";a.attributes.viewBox=b.left()+" "+b.top()+" "+(b.right()-b.left())+" "+(b.bottom()-b.top());a.attributes.width=b.right()-b.left();a.attributes.height=b.bottom()-b.top();a.children=this.shapes.map(function(c){return c.asSVG()});
return window.btoa(a)};VectorPaintEditorMorph.prototype.getBounds=function(a){a=a.map(function(b){return b.bounds()});return 0===a.length?null:a.reduce(function(b,c){return new Rectangle(Math.min(b.left(),c.left()),Math.min(c.top(),b.top()),Math.max(b.right(),c.right()),Math.max(b.bottom(),c.bottom()))})};VectorPaintEditorMorph.prototype.silentMoveBy=function(a){VectorPaintEditorMorph.uber.silentMoveBy.call(this,a);this.currentShape&&this.currentShape.moveBy(a);this.shapes.forEach(function(b){b.moveBy(a)})};
VectorPaintEditorMorph.prototype.ok=function(){var a=this,b=new Image;if(0===this.shapes.length)this.cancel();else{var c=this.getBounds(this.shapes).origin.subtract(this.paper.bounds.origin);this.paper.updateAutomaticCenter();b.src="data:image/svg+xml;base64,"+this.getSVG().toString();b.onload=function(){a.callback(b,a.paper.rotationCenter.subtract(c),a.shapes)};this.destroy()}};VectorPaintEditorMorph.prototype.updateHistory=function(){this.history.push(this.shapes.map(function(a){return a.copy()}))};
VectorPaintEditorMorph.prototype.undo=function(){function a(e){e.drawOn(b)}for(var b=this.paper,c=this.checksum(),d=c;this.shapes.length&&c==d;)this.shapes=this.history.pop()||[],this.shapes.forEach(a),d=this.checksum();this.clearSelection()};VectorPaintEditorMorph.prototype.checksum=function(){return JSON.stringify(this.shapes).split("").reduce(function(a,b){return a+b.charCodeAt(0)},0)};VectorPaintCanvasMorph.prototype=new PaintCanvasMorph;VectorPaintCanvasMorph.prototype.constructor=VectorPaintCanvasMorph;
VectorPaintCanvasMorph.uber=PaintCanvasMorph.prototype;function VectorPaintCanvasMorph(a){this.init(a)}VectorPaintCanvasMorph.prototype.init=function(a){VectorPaintCanvasMorph.uber.init.call(this,a);this.isCachingImage=!0;this.pointBuffer=[];this.currentTool="brush";this.settings={primaryColor:new Color(0,0,0,0),secondaryColor:new Color(0,0,0,255),lineWidth:3}};VectorPaintCanvasMorph.prototype.calculateCanvasCenter=function(){var a=this.bounds;return new Point(a.width()/2,a.height()/2)};
VectorPaintCanvasMorph.prototype.updateAutomaticCenter=function(){var a=this.parentThatIsA(VectorPaintEditorMorph);a=a.getBounds(a.shapes);if(this.automaticCrosshairs&&a){var b=a.origin.subtract(this.bounds.origin);this.rotationCenter=(new Point(a.width()/2,a.height()/2)).add(b)}else this.automaticCrosshairs&&this.calculateCanvasCenter()};
VectorPaintCanvasMorph.prototype.clearCanvas=function(){var a=this.parentThatIsA(VectorPaintEditorMorph);a.updateHistory();a.shapes=[];a.clearSelection();this.mask.getContext("2d").clearRect(0,0,this.bounds.width(),this.bounds.height());this.redraw=!0};
VectorPaintCanvasMorph.prototype.toolChanged=function(a){var b=this.parentThatIsA(VectorPaintEditorMorph);VectorPaintCanvasMorph.uber.toolChanged.call(this,a);b.currentShape&&b.currentShape.isPolygon&&(b.currentShape.close(),b.currentShape.drawOn(this),b.shapes.push(b.currentShape));"crosshairs"===a?(b.clearSelection(),b.currentShape=new Crosshair(this.rotationCenter,this),b.currentShape.drawOn(this),this.automaticCrosshairs=!1):"pipette"===a&&b.selection||(b.clearSelection(),b.currentShape=null)};
VectorPaintCanvasMorph.prototype.drawNew=function(){var a=this,b=this.parentThatIsA(VectorPaintEditorMorph),c=newCanvas(this.extent(),!1,this.cachedImage);this.merge(this.background,c);this.merge(this.paper,c);b&&(b.shapes.forEach(function(d){a.merge(d.image,c)}),b.currentShape&&this.merge(b.currentShape.image,c));this.cachedImage=c;this.drawFrame()};VectorPaintCanvasMorph.prototype.render=VectorPaintCanvasMorph.prototype.drawNew;
VectorPaintCanvasMorph.prototype.step=function(){this.redraw&&(this.drawNew(),this.changed(),this.redraw=!1)};
VectorPaintCanvasMorph.prototype.mouseMove=function(a){var b=this.parentThatIsA(VectorPaintEditorMorph),c=this.settings.primaryColor,d=this.settings.secondaryColor,e=this.settings.lineWidth;"paintbucket"!==this.currentTool&&(b.currentShape&&b.currentShape.isSelection&&!b.selecting?(c=b.currentShape.cornerAt(a),b.resizing||b.moving?b.dragSelection(a):c?(a=b.currentShape.cornerOppositeTo(c),b.currentShape=new VectorSelection(a,c),b.currentShape.drawOn(this),b.resizing=!0,document.body.style.cursor=
"move"):b.currentShape.containsPoint(a)&&(b.moving=!0,document.body.style.cursor="move")):(!b.currentShape||b.currentShape.isSelection&&!b.selecting?this.beginShape(e,c,d,a):b.currentShape.update(a,b.shift),b.currentShape.drawOn(this)))};VectorPaintCanvasMorph.prototype.mouseEnter=function(){document.body.style.cursor="selection"===this.currentTool?"crosshair":"default"};VectorPaintCanvasMorph.prototype.mouseLeave=function(){document.body.style.cursor="default"};
VectorPaintCanvasMorph.prototype.mouseClickLeft=function(a){var b=this.parentThatIsA(VectorPaintEditorMorph),c=b.currentShape;c?c.isPolygon&&!c.isFreeHand?c.points.push(c.points[c.points.length-1].copy()):c.isPolygon?(c.close(),c.drawOn(this),b.shapes.push(c),b.currentShape=null):c.isSelection?b.selecting?(c.destination=a,this.selectInside(c),b.selecting=!1):b.moving||b.resizing?(b.moving=!1,b.resizing=!1,this.updateSelection()):this.selectAtPoint(a):c.isCrosshair?this.rotationCenter=a.subtract(this.bounds.origin):
(c.update(a,b.shift),b.shapes.push(c),b.currentShape=null):"selection"===this.currentTool&&this.selectAtPoint(a);b.lastDragPosition=null;this.mouseEnter();b.updateHistory()};VectorPaintCanvasMorph.prototype.mouseDoubleClick=function(a){a=this.parentThatIsA(VectorPaintEditorMorph);var b=a.currentShape;b&&b.isPolygon&&(b.close(),b.drawOn(this),a.shapes.push(b),a.currentShape=null,a.updateHistory())};
VectorPaintCanvasMorph.prototype.beginShape=function(a,b,c,d){switch(this.currentTool){case "brush":this.beginPolygon(a,c,null,d,!1,!0);break;case "line":this.beginLine(a,c,d);break;case "rectangle":this.beginRectangle(a,c,b,d);break;case "ellipse":this.beginEllipse(a,c,b,d);break;case "polygon":this.beginPolygon(a,c,b,d,!0,!1);break;case "closedBrush":this.beginPolygon(a,c,b,d,!0,!0);break;case "selection":this.beginSelection(d)}};
VectorPaintCanvasMorph.prototype.beginPolygon=function(a,b,c,d,e,f){this.parentThatIsA(VectorPaintEditorMorph).currentShape=new VectorPolygon(a,b,c,[d],e,f)};VectorPaintCanvasMorph.prototype.beginLine=function(a,b,c){this.parentThatIsA(VectorPaintEditorMorph).currentShape=new VectorLine(a,b,c,c)};VectorPaintCanvasMorph.prototype.beginRectangle=function(a,b,c,d){this.parentThatIsA(VectorPaintEditorMorph).currentShape=new VectorRectangle(a,b,c,d,d)};
VectorPaintCanvasMorph.prototype.beginEllipse=function(a,b,c,d){this.parentThatIsA(VectorPaintEditorMorph).currentShape=new VectorEllipse(a,b,c,d,d)};VectorPaintCanvasMorph.prototype.beginSelection=function(a){var b=this.parentThatIsA(VectorPaintEditorMorph);b.currentShape=new VectorSelection(a,a);b.selecting=!0};
VectorPaintCanvasMorph.prototype.selectInside=function(a){var b=a.bounds(),c=this.parentThatIsA(VectorPaintEditorMorph);c.selection=c.shapes.filter(function(d){return b.containsRectangle(d.bounds())});0<c.selection.length?(b=c.getBounds(c.selection),a.origin=b.topLeft(),a.destination=b.bottomRight(),a.drawOn(this)):(c.currentShape=null,this.redraw=!0)};
VectorPaintCanvasMorph.prototype.selectAtPoint=function(a){var b=this.parentThatIsA(VectorPaintEditorMorph);a=this.shapeAt(a);if(a){if(b.shift){var c=b.selection.indexOf(a);-1<c?b.selection.splice(c,1):b.selection.push(a)}else b.selection=[a];c=b.getBounds(b.selection)}c?(b.currentShape=new VectorSelection(c.topLeft(),c.bottomRight()),b.currentShape.drawOn(this)):b.clearSelection()};
VectorPaintCanvasMorph.prototype.selectShapes=function(a){var b=this.parentThatIsA(VectorPaintEditorMorph);if(0<a.length){var c=b.getBounds(a);b.selection=a;b.currentShape=new VectorSelection(c.topLeft(),c.bottomRight());b.currentShape.drawOn(this)}};VectorPaintCanvasMorph.prototype.updateSelection=function(){var a=this.parentThatIsA(VectorPaintEditorMorph);this.selectShapes(a.selection)};
VectorPaintCanvasMorph.prototype.shapeAt=function(a){var b=this.parentThatIsA(VectorPaintEditorMorph);return detect(b.shapes.slice().reverse(),function(c){return c.containsPoint(a)})};
VectorPaintCanvasMorph.prototype.pasteAt=function(a){var b=this.parentThatIsA(VectorPaintEditorMorph),c=this,d=b.clipboard,e,f=[];0<d.length&&(e=a.subtract(d[0].bounds().origin));d.forEach(function(g){g=g.copy();g.moveBy(e);b.selection.push(g);b.shapes.push(g);g.drawOn(c);f.push(g)});0<f.length&&(this.selectShapes(f),b.updateHistory())};
VectorPaintCanvasMorph.prototype.floodfill=function(a){var b=this.parentThatIsA(VectorPaintEditorMorph);if(a=this.shapeAt(a.add(this.position())))a.setColor(b.shift?this.settings.secondaryColor:this.settings.primaryColor,b.shift),a.drawOn(this)};modules.lists="2020-July-01";function List(a){this.type=null;this.contents=a||[];this.rest=this.first=null;this.isLinked=!1;this.lastChanged=Date.now()}List.prototype.enableTables=!0;List.prototype.toString=function(){return"a List ["+this.length()+" elements]"};
List.prototype.changed=function(){this.lastChanged=Date.now()};List.prototype.cons=function(a,b){var c=new List;if(!(b instanceof List||isNil(b)))throw Error("cdr isn't a list: "+b);c.first=isNil(a)?null:a;c.rest=b||null;c.isLinked=!0;return c};List.prototype.cdr=function(){var a;if(this.isLinked)return this.rest||new List;if(2>this.contents.length)return new List;var b=new List;for(a=this.contents.length;1<a;--a)b=this.cons(this.at(a),b);return b};
List.prototype.add=function(a,b){b=b||this.length()+1;a=isNil(a)?null:a;this.becomeArray();this.contents.splice(b-1,0,a);this.changed()};List.prototype.put=function(a,b){a=0===a?0:!1===a?!1:a||null;this.becomeArray();this.contents[b-1]=a;this.changed()};List.prototype.remove=function(a){this.becomeArray();this.contents.splice(a-1,1);this.changed()};List.prototype.clear=function(){this.contents=[];this.rest=this.first=null;this.isLinked=!1;this.changed()};List.prototype.map=function(a){return new List(this.asArray().map(a))};
List.prototype.length=function(){if(this.isLinked){for(var a=this,b=0;a&&a.isLinked;)b+=1,a=a.rest;return b+(a?a.contents.length:0)}return this.contents.length};List.prototype.at=function(a){a=+a;for(var b=this;b.isLinked;)if(1<a)b=b.rest,--a;else return b.first;a=b.contents[a-1];return isNil(a)?"":a};List.prototype.contains=function(a){for(var b=this;b.isLinked;){if(snapEquals(b.first,a))return!0;b=b.rest}return b.contents.some(function(c){return snapEquals(c,a)})};
List.prototype.isEmpty=function(){return this.isLinked?isNil(this.first):!this.contents.length};List.prototype.indexOf=function(a){for(var b=this,c=1,d,e;b.isLinked;){if(snapEquals(b.first,a))return c;b=b.rest;c+=1}e=b.contents.length;for(d=0;d<e;d+=1)if(snapEquals(b.contents[d],a))return c+d;return 0};List.prototype.isTable=function(){return this.enableTables&&(100<this.length()||1<this.cols())};
List.prototype.get=function(a,b){if(!a)return b?b>this.rows()?null:this.rowName(b):[this.length()];if(!b)return 1===this.cols()?localize("items"):this.colName(a);var c=this.at(b);if(c instanceof List){b=c.length();var d=this.cols();return a>b?null:1===d&&1<b?[c]:a>=d&&b>d?new Variable(c.at(a)):c.at(a)}return 1===a&&b<=this.rows()?[c]:null};List.prototype.rows=function(){return this.length()};
List.prototype.cols=function(){var a=Math.min(10,this.length()),b=1,c;for(c=1;c<=a;c+=1){var d=this.at(c);d instanceof List&&(b=Math.max(b,d.length()))}return b};List.prototype.colName=function(a){return a>this.cols()?null:String.fromCharCode(64+(a%26||26)).repeat(Math.floor((a-1)/26)+1)};List.prototype.rowName=function(a){return a};List.prototype.columnNames=function(){return[]};
List.prototype.version=function(a,b,c,d){b=Math.min(a+b,this.length());var e=this.lastChanged,f;for(f=a;f<=b;f+=1)a=this.at(f),e=a instanceof Costume?Math.max(e,a.version):a instanceof List?Math.max(e,a.version(c,d)):Math.max(e,a.lastChanged?a.lastChanged:0);return e};List.prototype.asArray=function(){this.becomeArray();return this.contents};
List.prototype.itemsArray=function(){if(this.isLinked){for(var a=this,b=[],c;a&&a.isLinked;)b.push(a.first),a=a.rest;if(a)for(c=1;c<=a.contents.length;c+=1)b.push(a.at(c));return b}return this.contents};
List.prototype.asText=function(){for(var a="",b,c,d=this,e;d.isLinked;)c=d.first,c instanceof List?a=a.concat(c.asText()):(c=isNil(c)?"":c.toString(),a=a.concat(c)),d=d.rest;b=d.length();for(e=1;e<=b;e+=1)c=d.at(e),c instanceof List?a=a.concat(c.asText()):(c=isNil(c)?"":c.toString(),a=a.concat(c));return a};List.prototype.becomeArray=function(){this.isLinked&&(this.contents=this.itemsArray(),this.isLinked=!1,this.rest=this.first=null)};
List.prototype.becomeLinked=function(){var a,b=this;if(!this.isLinked){var c=this.length();for(a=0;a<c;a+=1)b.first=this.contents[a],a<c&&(b.rest=new List,b.isLinked=!0,b=b.rest);this.contents=[];this.isLinked=!0}};
List.prototype.asCSV=function(){function a(d){d=isNil(d)?"":d.toString();if(-1===d.indexOf('"')&&-1===d.indexOf("\n")&&-1===d.indexOf(","))return d;var e=['"'];d.split("").forEach(function(f){e.push(f);'"'===f&&e.push(f)});e.push('"');return e.join("")}var b=this.itemsArray(),c=[];return b.some(function(d){return d instanceof List})?(b.forEach(function(d){d instanceof List?c.push(d.itemsArray().map(a).join(",")):c.push(a(d))}),c.join("\n")):b.map(a).join(",")};
List.prototype.asJSON=function(a){function b(d,e){d=d.itemsArray();var f={};return c(d)?(d.forEach(function(g){var h=2===g.length()?g.at(2):void 0;f[g.at(1)]=h instanceof List?b(h,e):h}),f):d.map(function(g){return g instanceof List?b(g,e):g})}function c(d){if(d.every(function(f){return f instanceof List&&3>f.length()})){var e=d.map(function(f){return f.at(1)});return e.every(function(f){var g;if(g=isString(f))g=e.indexOf(f)===e.lastIndexOf(f);return g})}}return JSON.stringify(b(this,a))};
List.prototype.equalTo=function(a){var b=this,c=a,d,e;if(!(a instanceof List))return!1;for(;b.isLinked&&c.isLinked;){if(!snapEquals(b.first,c.first))return!1;b=b.rest;c=c.rest}c.isLinked&&(a=c,c=b,b=a);for(d=0;b.isLinked;){if(!snapEquals(b.first,c.contents[d]))return!1;b=b.rest;d+=1}a=0;if(b.contents.length!==c.contents.length-d)return!1;for(e=b.contents.length;0<e;){--e;if(!snapEquals(b.contents[a],c.contents[d]))return!1;a+=1;d+=1}return!0};
List.prototype.canBeCSV=function(){return this.itemsArray().every(function(a){return!isNaN(+a)&&"boolean"!==typeof a||isString(a)||a instanceof List&&a.hasOnlyAtomicData()})};List.prototype.canBeJSON=function(){return this.itemsArray().every(function(a){return!isNaN(+a)||isString(a)||!0===a||!1===a||a instanceof List&&a.canBeJSON()})};List.prototype.hasOnlyAtomicData=function(){return this.itemsArray().every(function(a){return!isNaN(+a)&&"boolean"!==typeof a||isString(a)})};
List.prototype.blockify=function(a,b){a=void 0===a?500:a;b=void 0===b?[0]:b;var c=SpriteMorph.prototype.blockForSelector("reportNewList"),d=c.inputs()[0],e=this.length(),f;c.isDraggable=!0;d.removeInput();for(f=0;f<e&&b[0]<a;f+=1){var g=this.at(f+1);if(g.blockify)d.replaceInput(d.addInput(),g.blockify(a,b));else if("boolean"===typeof g){var h=SpriteMorph.prototype.blockForSelector("reportBoolean");h.inputs()[0].setContents(g);h.isDraggable=!0;d.replaceInput(d.addInput(),h)}else d.addInput(g);b[0]+=
1}d.fixBlockColor(null,!0);return c};ListWatcherMorph.prototype=new BoxMorph;ListWatcherMorph.prototype.constructor=ListWatcherMorph;ListWatcherMorph.uber=BoxMorph.prototype;ListWatcherMorph.prototype.cellColor=SpriteMorph.prototype.blockColor.lists;function ListWatcherMorph(a,b){this.init(a,b)}
ListWatcherMorph.prototype.init=function(a,b){var c=this;this.list=a||new List;this.start=1;this.range=100;this.lastUpdated=0;this.lastCell=null;this.parentCell=b||null;this.label=new StringMorph(localize("length: ")+this.list.length(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?ZERO:new Point(1,1),WHITE);this.label.mouseClickLeft=function(){c.startIndexMenu()};this.frame=new ScrollFrameMorph(null,10);this.frame.alpha=0;this.frame.acceptsDrops=!1;this.frame.contents.acceptsDrops=
!1;this.handle=new HandleMorph(this,80,70,3,3);this.handle.setExtent(new Point(13,13));this.arrow=new ArrowMorph("down",SyntaxElementMorph.prototype.fontSize);this.arrow.mouseClickLeft=function(){c.startIndexMenu()};this.arrow.setRight(this.handle.right());this.arrow.setBottom(this.handle.top());this.handle.add(this.arrow);(a=this.list.type&&!contains(["text","number"],this.list.type))?this.plusButton=null:(this.plusButton=new PushButtonMorph(this.list,"add","+"),this.plusButton.padding=0,this.plusButton.edge=
0,this.plusButton.outlineColor=this.color,this.plusButton.fixLayout());ListWatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1,new Color(120,120,120));this.color=new Color(220,220,220);this.isDraggable=!1;this.setExtent((new Point(80,70)).multiplyBy(SyntaxElementMorph.prototype.scale));this.add(this.label);this.add(this.frame);a||this.add(this.plusButton);this.add(this.handle);this.handle.fixLayout();this.update();this.fixLayout()};
ListWatcherMorph.prototype.update=function(a){this.frame.contents.children.forEach(function(k){k instanceof CellMorph&&(k.contentsMorph instanceof ListWatcherMorph?k.contentsMorph.update():(isSnapObject(k.contents)||k.contents instanceof Costume)&&k.update())});if(this.lastUpdated===this.list.lastChanged&&!a)return null;this.updateLength(!0);this.start=Math.max(Math.min(this.start,Math.floor((this.list.length()-1)/this.range)*this.range+1),1);var b=Math.min(this.start+this.range-1,this.list.length());
var c=Math.min(3*(b-this.start+1),this.frame.contents.children.length);for(a=0;a<c;a+=3){var d=this.start+a/3;var e=this.frame.contents.children[a];var f=this.frame.contents.children[a+1];var g=this.frame.contents.children[a+2];var h=this.list.at(d);e.contents!==h&&(e.contents=h,e.fixLayout(),this.lastCell&&e.setLeft(this.lastCell.left()));this.lastCell=e;f.text!==d.toString()&&(f.text=d.toString(),f.fixLayout());g.action=d}for(a=3*(b-this.start+1);this.frame.contents.children.length>a;)this.frame.contents.children[a].destroy();
c=a;a=this.frame.contents.children.length;h=Date.now();if(c>a+1)for(a;a<c;a+=3){if(1E3<Date.now()-h)return this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),null;d=this.start+a/3;f=new StringMorph(d.toString(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?ZERO:new Point(1,1),WHITE);e=new CellMorph(this.list.at(d),this.cellColor,d,this.parentCell);g=new PushButtonMorph(this.list.remove,d,"-",this.list);g.padding=1;g.edge=
0;g.corner=1;g.outlineColor=this.color.darker();g.fixLayout();this.frame.contents.add(e);this.lastCell?e.setPosition(this.lastCell.bottomLeft()):e.setTop(this.frame.contents.top());this.lastCell=e;f.setCenter(e.center());f.setRight(e.left()-2);this.frame.contents.add(f);this.frame.contents.add(g)}this.lastCell=null;this.fixLayout();this.frame.contents.adjustBounds();this.frame.contents.setLeft(this.frame.left());this.updateLength();this.lastUpdated=this.list.lastChanged};
ListWatcherMorph.prototype.updateLength=function(a){this.label.text=localize("length: ")+this.list.length();this.label.color=a?new Color(0,0,100):new Color(0,0,0);this.label.fixLayout();this.label.setCenter(this.center());this.label.setBottom(this.bottom()-3)};
ListWatcherMorph.prototype.startIndexMenu=function(){var a=this,b,c=Math.ceil(this.list.length()/this.range),d=new MenuMorph(function(f){return a.setStartIndex(f)},null,this);d.addItem("1...",1);for(b=1;b<c;b+=1){var e=100*b+1;d.addItem(e+"...",e)}d.popUpAtHand(this.world())};ListWatcherMorph.prototype.setStartIndex=function(a){this.start=a;this.list.changed();this.update()};
ListWatcherMorph.prototype.fixLayout=function(){this.label&&(this.frame&&(this.arrangeCells(),this.frame.setPosition(this.position().add(3)),this.frame.bounds.corner=this.bounds.corner.subtract(new Point(3,17)),this.frame.fixLayout(),this.frame.contents.adjustBounds()),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3),this.plusButton&&(this.plusButton.setLeft(this.left()+3),this.plusButton.setBottom(this.bottom()-3)),this.parent&&(this.parent.changed(),this.parent.fixLayout(),
this.parent.rerender()))};ListWatcherMorph.prototype.arrangeCells=function(){var a,b=this.frame.contents.children.length;for(a=0;a<b;a+=3){var c=this.frame.contents.children[a];var d=this.frame.contents.children[a+1];var e=this.frame.contents.children[a+2];f&&c.setTop(f.bottom());d&&(d.setTop(c.center().y-d.height()/2),d.setRight(c.left()-2));e&&(e.setCenter(c.center()),e.setLeft(c.right()+2));var f=c}this.frame.contents.adjustBounds()};
ListWatcherMorph.prototype.expand=function(a){var b=this.frame.contents.extent();b=new Point(b.x+6,b.y+this.label.height()+6);a&&(b=b.min(a));this.setExtent(b);this.handle.setRight(this.right()-3);this.handle.setBottom(this.bottom()-3)};
ListWatcherMorph.prototype.userMenu=function(){var a=this;if(!List.prototype.enableTables)return this.escalateEvent("userMenu");var b=new MenuMorph(this);b.addItem("table view...","showTableView");this.list.canBeJSON()&&b.addItem("blockify",function(){var c=a.world(),d=detect(c.children,function(e){return e instanceof IDE_Morph});a.list.blockify().pickUp(c);c.hand.grabOrigin={origin:d.palette,position:d.palette.center()}});b.addLine();b.addItem("open in dialog...",function(){return(new TableDialogMorph(a.list)).popUp(a.world())});
return b};
ListWatcherMorph.prototype.showTableView=function(){var a=this.parentThatIsA(SpriteBubbleMorph,SpeechBubbleMorph,CellMorph);a&&(a instanceof SpriteBubbleMorph?(a.contentsMorph.destroy(),a.contentsMorph=new TableFrameMorph(new TableMorph(this.list,10)),a.contentsMorph.expand(this.extent()),a.parent.positionTalkBubble()):a instanceof SpeechBubbleMorph?(a.contents=new TableFrameMorph(new TableMorph(this.list,10)),a.contents.expand(this.extent())):(a.changed(),a.contentsMorph.destroy(),a.contentsMorph=new TableFrameMorph(new TableMorph(this.list,
10)),a.add(a.contentsMorph),a.contentsMorph.setPosition(this.position()),a.contentsMorph.expand(this.extent())),a.fixLayout(),a.rerender())};ListWatcherMorph.prototype.mouseDoubleClick=function(a){List.prototype.enableTables?(new TableDialogMorph(this.list)).popUp(this.world()):this.escalateEvent("mouseDoubleClick",a)};ListWatcherMorph.prototype.show=function(){ListWatcherMorph.uber.show.call(this);this.frame.contents.adjustBounds()};ListWatcherMorph.prototype.render=WatcherMorph.prototype.render;
modules.byob="2020-July-24";function CustomBlockDefinition(a,b){this.body=null;this.scripts=[];this.category=null;this.isGlobal=!1;this.type="command";this.spec=a||"";this.declarations=new Map;this.variableNames=[];this.codeHeader=this.codeMapping=this.comment=null;this.translations={};this.receiver=b||null;this.storedSemanticSpec=this.cachedTranslation=this.cachedIsRecursive=this.editorDimensions=null}
CustomBlockDefinition.prototype.blockInstance=function(a){var b="command"===this.type?new CustomCommandBlockMorph(this):new CustomReporterBlockMorph(this,"predicate"===this.type);b.isDraggable=!0;a&&(b.storedTranslations=this.translationsAsText());return b};CustomBlockDefinition.prototype.templateInstance=function(){var a=this.blockInstance();a.refreshDefaults(this);a.isDraggable=!1;a.isTemplate=!0;return a};
CustomBlockDefinition.prototype.prototypeInstance=function(){var a=this,b;var c="command"===this.type?new CustomCommandBlockMorph(this,!0):new CustomReporterBlockMorph(this,"predicate"===this.type,!0);c.parts().forEach(function(d){d instanceof BlockInputFragmentMorph&&(b=a.declarations.get(d.fragment.labelString))&&(d.fragment.type=b[0],d.fragment.defaultValue=b[1],d.fragment.options=b[2],d.fragment.isReadOnly=b[3]||!1)});return c};
CustomBlockDefinition.prototype.copyAndBindTo=function(a,b){var c=copy(this);delete c[XML_Serializer.prototype.idProperty];c.receiver=a;c.declarations=new Map;a=$jscomp.makeIterator(this.declarations);for(var d=a.next();!d.done;d=a.next()){var e=$jscomp.makeIterator(d.value);d=e.next().value;e=e.next().value;c.declarations.set(d,e)}if(b)return c.body=null,c;c.body&&(c.body=Process.prototype.reify.call(null,this.body.expression,new List(this.inputNames())),c.body.outerContext=null);return c};
CustomBlockDefinition.prototype.blockSpec=function(){var a=this;if(this.storedSemanticSpec)return this.storedSemanticSpec;var b=[],c;this.parseSpec(this.spec).forEach(function(d){c="%"===d[0]&&1<d.length?a.typeOf(d.slice(1)):"$nl"===d?"%br":d;b.push(c);b.push(" ")});return"".concat.apply("",b).trim()};CustomBlockDefinition.prototype.helpSpec=function(){var a=[];this.parseSpec(this.spec).forEach(function(b){"%"!==b[0]&&a.push(b)});return"".concat.apply("",a).replace(/\?/g,"")};
CustomBlockDefinition.prototype.typeOf=function(a){return this.declarations.has(a)?this.declarations.get(a)[0]:"%s"};CustomBlockDefinition.prototype.defaultValueOf=function(a){return this.declarations.has(a)?this.declarations.get(a)[1]:""};CustomBlockDefinition.prototype.defaultValueOfInputIdx=function(a){a=this.inputNames()[a];return this.defaultValueOf(a)};CustomBlockDefinition.prototype.dropDownMenuOfInputIdx=function(a){a=this.inputNames()[a];return this.dropDownMenuOf(a)};
CustomBlockDefinition.prototype.isReadOnlyInputIdx=function(a){a=this.inputNames()[a];return this.isReadOnlyInput(a)};CustomBlockDefinition.prototype.inputOptionsOfIdx=function(a){a=this.inputNames()[a];return this.inputOptionsOf(a)};
CustomBlockDefinition.prototype.dropDownMenuOf=function(a){if(this.declarations.has(a)&&this.declarations.get(a)[2]){if(0===this.declarations.get(a)[2].indexOf("\u00a7_")){var b=this.declarations.get(a)[2].slice(2);if(contains("messagesMenu messagesReceivedMenu objectsMenu costumesMenu soundsMenu getVarNamesDict pianoKeyboardMenu directionDialMenu".split(" "),b))return b}return this.parseChoices(this.declarations.get(a)[2])}return null};
CustomBlockDefinition.prototype.parseChoices=function(a){var b={},c=[b];if(a.match(/^function\s*\(.*\)\s*{.*\n/)){var d=a.match(/^function\s*\((.*)\)/)[1].split(",");a=a.split("\n").slice(1,-1).join("\n");return Function.apply(null,d.concat([a]))}a.split("\n").forEach(function(e){e=e.split("=");"}"===e[0]?(c.pop(),b=c[c.length-1]):"{"===e[1]?(b={},c[c.length-1][e[0]]=b,c.push(b)):b[e[0]]=isNil(e[1])?e[0]:e[1]});return b};
CustomBlockDefinition.prototype.isReadOnlyInput=function(a){return this.declarations.has(a)&&!0===this.declarations.get(a)[3]};CustomBlockDefinition.prototype.inputOptionsOf=function(a){return[this.dropDownMenuOf(a),this.isReadOnlyInput(a)]};CustomBlockDefinition.prototype.inputNames=function(){var a=[];this.parseSpec(this.spec).forEach(function(b){"%"===b[0]&&1<b.length&&a.push(b.slice(1))});return a};
CustomBlockDefinition.prototype.parseSpec=function(a){var b=[],c="",d,e=!1;for(d=0;d<a.length;d+=1){var f=a[d];"'"===f?e=!e:" "!==f||e?c=c.concat(f):(b.push(c),c="")}b.push(c);return b};CustomBlockDefinition.prototype.isDirectlyRecursive=function(){if(null!==this.cachedIsRecursive)return this.cachedIsRecursive;if(this.body){var a=this.blockSpec();this.cachedIsRecursive=this.body.expression.anyChild(function(b){return b.isCustomBlock&&b.blockSpec===a})}else this.cachedIsRecursive=!1;return this.cachedIsRecursive};
CustomBlockDefinition.prototype.localizedSpec=function(){if(this.cachedTranslation)return this.cachedTranslation;var a=this.translations[SnapTranslator.language],b=this.blockSpec(),c=-1;if(isNil(a))return b;var d=BlockMorph.prototype.parseSpec(b).filter(function(e){return 1<e.length&&"%"===e[0]});a=BlockMorph.prototype.parseSpec(a);a.some(function(e){return 1<e.length&&"%"===e[0]})||a.filter(function(e){return"_"===e}).length!==d.length?this.cachedTranslation=b:(a=a.map(function(e){return"_"===e?
(c+=1,d[c]):e}),this.cachedTranslation=a.join(" "));return this.cachedTranslation};CustomBlockDefinition.prototype.abstractBlockSpec=function(){return BlockMorph.prototype.parseSpec(this.blockSpec()).map(function(a){return 1<a.length&&"%"===a[0]?"_":a}).join(" ")};CustomBlockDefinition.prototype.translationsAsText=function(){var a=this,b="";Object.keys(this.translations).forEach(function(c){return b+=c+":"+a.translations[c]+"\n"});return b};
CustomBlockDefinition.prototype.updateTranslations=function(a){var b=this;a=a.split("\n").filter(function(c){return c.length});this.translations={};a.forEach(function(c){var d=c.indexOf(":"),e=c.slice(0,d).trim();c=c.slice(d+1).trim();d&&(b.translations[e]=c)})};CustomBlockDefinition.prototype.scriptsPicture=function(){return this.scriptsModel().scriptsPicture()};CustomBlockDefinition.prototype.sortedElements=function(){return this.scriptsModel().sortedElements()};
CustomBlockDefinition.prototype.scriptsModel=function(){var a;var b=new ScriptsMorph;b.cleanUpMargin=10;var c=new PrototypeHatBlockMorph(this);c.setPosition(b.position().add(10));if(null!==this.comment){var d=this.comment.fullCopy();c.comment=d;d.block=c}null!==this.body&&c.nextBlock(this.body.expression.fullCopy());b.add(c);c.fixBlockColor(null,!0);this.scripts.forEach(function(e){a=e.fullCopy();a.setPosition(b.position().add(e.position()));b.add(a);a instanceof BlockMorph&&a.allComments().forEach(function(f){return f.align(a)})});
c.allComments().forEach(function(e){return e.align(c)});d=c.parts()[0];d.fixLayout();d.forceNormalColoring();d.fixBlockColor(c,!0);b.fixMultiArgs();return b};CustomBlockDefinition.prototype.purgeCorpses=function(){this.body&&this.body.expression.isCorpse&&(this.body=null);this.scripts=this.scripts.filter(function(a){return!a.isCorpse})};CustomCommandBlockMorph.prototype=new CommandBlockMorph;CustomCommandBlockMorph.prototype.constructor=CustomCommandBlockMorph;CustomCommandBlockMorph.uber=CommandBlockMorph.prototype;
CustomCommandBlockMorph.prototype.isCustomBlock=!0;function CustomCommandBlockMorph(a,b){this.init(a,b)}CustomCommandBlockMorph.prototype.init=function(a,b){this.definition=a;this.semanticSpec="";this.isGlobal=a?a.isGlobal:!1;this.isPrototype=b||!1;CustomCommandBlockMorph.uber.init.call(this);this.category=a.category;this.selector="evaluateCustomBlock";this.storedTranslations=this.variables=null;this.initializeVariables();a&&this.refresh()};
CustomCommandBlockMorph.prototype.initializeVariables=function(a){var b=this;this.variables=new VariableFrame;this.isGlobal&&this.definition.variableNames.forEach(function(c){var d=a?a[c]:null;b.variables.addVar(c,d instanceof Variable?d.value:null)})};
CustomCommandBlockMorph.prototype.refresh=function(a){var b=a||this.definition;a=this.isPrototype?b.spec:b.localizedSpec();this.semanticSpec=b.blockSpec();this.setCategory(b.category);if(this.blockSpec!==a){var c=this.inputs();this.zebraContrast?this.fixBlockColor():this.forceNormalColoring();this.setSpec(a,b);this.fixLabelColor();this.restoreInputs(c)}else this.inputs().forEach(function(d,e){d instanceof InputSlotMorph&&d.setChoices.apply(d,b.inputOptionsOfIdx(e))});this.cachedInputs=null;this.inputs().forEach(function(d,
e){d instanceof TemplateSlotMorph&&"\u2191"===d.contents()&&d.setContents(b.inputNames()[e])});this.isGlobal&&this.initializeVariables(this.variables.vars);this.forceNormalColoring();this.fixBlockColor(null,!0)};
CustomCommandBlockMorph.prototype.restoreInputs=function(a){var b=this,c=0,d;this.isPrototype||(this.cachedInputs=null,this.inputs().forEach(function(e){d=a[c];d instanceof ReporterBlockMorph&&!(e instanceof TemplateSlotMorph)?b.replaceInput(e,d.fullCopy()):d instanceof InputSlotMorph&&e instanceof InputSlotMorph?d.isEmptySlot()?e.setContents(""):e.setContents(d.evaluate()):d instanceof BooleanSlotMorph&&e instanceof BooleanSlotMorph?e.setContents(d.evaluate()):d instanceof TemplateSlotMorph&&e instanceof
TemplateSlotMorph?e.setContents(d.evaluate()):d instanceof CSlotMorph&&e instanceof CSlotMorph&&e.nestedBlock(d.evaluate());c+=1}),this.cachedInputs=null)};CustomCommandBlockMorph.prototype.refreshDefaults=function(a){var b=this,c=0;this.inputs().forEach(function(d){(d instanceof InputSlotMorph||d instanceof BooleanSlotMorph)&&d.setContents((a||b.definition).defaultValueOfInputIdx(c));c+=1});this.cachedInputs=null};
CustomCommandBlockMorph.prototype.refreshPrototype=function(){var a=[],b=this,c,d,e=0;if(!this.isPrototype)return null;var f=this.parentThatIsA(PrototypeHatBlockMorph);this.parts().forEach(function(h){h.fragment.isDeleted||(h.fragment.type?a.push(h.fragment):(c=b.definition.parseSpec(h.fragment.labelString),c.forEach(function(k){d=h.fragment.copy();d.labelString=k;a.push(d)})))});var g=this.specFromFragments()||this.blockSpec;this instanceof CustomCommandBlockMorph&&("reporter"===f.type||"predicate"===
f.type)?(b=new CustomReporterBlockMorph(this.definition,"predicate"===f.type,!0),f.replaceInput(this,b)):this instanceof CustomReporterBlockMorph&&("command"===f.type?(b=new CustomCommandBlockMorph(this.definition,!0),f.replaceInput(this,b)):(this.isPredicate="predicate"===f.type,this.fixLayout(),this.rerender()));b.setCategory(f.blockCategory||"other");f.fixBlockColor();b.setSpec(g);b.parts().forEach(function(h){h instanceof BlockLabelPlaceHolderMorph||(a[e]&&(h.fragment=a[e]),e+=1)});this.refreshPrototypeSlotTypes();
f.fixLayout()};CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes=function(){this.parts().forEach(function(a){a instanceof BlockInputFragmentMorph&&(a.template().instantiationSpec=a.contents(),a.setContents(a.fragment.defTemplateSpecFragment()))});this.fixBlockColor(null,!0)};CustomCommandBlockMorph.prototype.inputFragmentNames=function(){var a=[];this.parts().forEach(function(b){!b.fragment.isDeleted&&b.fragment.type&&a.push(b.fragment.labelString)});return a};
CustomCommandBlockMorph.prototype.upvarFragmentNames=function(){var a=[];this.parts().forEach(function(b){b.fragment.isDeleted||"%upvar"!==b.fragment.type||a.push(b.fragment.labelString)});return a};CustomCommandBlockMorph.prototype.upvarFragmentName=function(a){return this.upvarFragmentNames()[a]||"\u2191"};CustomCommandBlockMorph.prototype.specFromFragments=function(){var a="";this.parts().forEach(function(b){b.fragment.isDeleted||(a=a+b.fragment.defSpecFragment()+" ")});return a.trim()};
CustomCommandBlockMorph.prototype.blockSpecFromFragments=function(){var a="";this.parts().forEach(function(b){b.fragment.isDeleted||(a=a+b.fragment.blockSpecFragment()+" ")});return a.trim()};CustomCommandBlockMorph.prototype.declarationsFromFragments=function(){var a=new Map;this.parts().forEach(function(b){b instanceof BlockInputFragmentMorph&&a.set(b.fragment.labelString,[b.fragment.type,b.fragment.defaultValue,b.fragment.options,b.fragment.isReadOnly])});return a};
CustomCommandBlockMorph.prototype.parseSpec=function(a){return this.isPrototype?CustomBlockDefinition.prototype.parseSpec(a):CustomCommandBlockMorph.uber.parseSpec.call(this,a)};CustomCommandBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype)return CustomCommandBlockMorph.uber.mouseClickLeft.call(this);this.edit()};
CustomCommandBlockMorph.prototype.edit=function(){var a=this,b=this.definition;if(this.isPrototype){var c=this.definition.blockInstance();c.addShadow();b=this.parentThatIsA(PrototypeHatBlockMorph);(new BlockDialogMorph(null,function(e){e&&SnapActions.setCustomBlockType(a.definition,e.category,e.type)},this)).openForChange("Change block",b.blockCategory,b.type,this.world(),c.doWithAlpha(1,function(){return c.fullImage()}),this.isInUse())}else{var d=this.scriptTarget();if(!this.isGlobal){if(contains(Object.keys(d.inheritedBlocks()),
this.blockSpec)){this.duplicateBlockDefinition();return}b=d.getMethod(this.semanticSpec)}b=new BlockEditorMorph(b,d);b.popUp();b.changed()}};
CustomCommandBlockMorph.prototype.labelPart=function(a){if(!this.isPrototype)return CustomCommandBlockMorph.uber.labelPart.call(this,a);"%"===a[0]&&1<a.length?a=new BlockInputFragmentMorph(a.replace(/%/g,"")):(a=new BlockLabelFragmentMorph(a),a.fontSize=this.fontSize,a.color=WHITE,a.isBold=!0,a.shadowColor=this.color.darker(this.labelContrast),a.shadowOffset=this.embossing,a.fixLayout(),a.rerender());return a};
CustomCommandBlockMorph.prototype.placeHolder=function(){var a=new BlockLabelPlaceHolderMorph;a.fontSize=1.4*this.fontSize;a.color=new Color(45,45,45);a.fixLayout();return a};CustomCommandBlockMorph.prototype.attachTargets=function(){return this.isPrototype?[]:CustomCommandBlockMorph.uber.attachTargets.call(this)};
CustomCommandBlockMorph.prototype.isInUse=function(){var a=this.definition,b=this.scriptTarget(),c=b.parentThatIsA(IDE_Morph);return a.isGlobal&&c?c.sprites.asArray().concat([c.stage]).some(function(d,e){return d.usesBlockInstance(a,!1,e)}):0<b.allDependentInvocationsOf(this.blockSpec).length};
CustomCommandBlockMorph.prototype.userMenu=function(){function a(g,h,k,l,m){f.addItem((k?"\u2611 ":"\u2610 ")+localize(g),h,k?l:m)}function b(g){var h=d.parentThatIsA(StageMorph),k=e.variables;f.addItem(g+"...",function(){var l=detect(h.children,function(n){return n instanceof WatcherMorph&&n.target===k&&n.getter===g});if(null!==l)l.show();else{l=new WatcherMorph(g+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,k,g);l.setPosition(h.position().add(10));var m=h.watchers(l.left());
0<m.length&&l.setTop(m[m.length-1].bottom());h.add(l)}l.fixLayout()})}var c=this.parentThatIsA(PrototypeHatBlockMorph),d=this.scriptTarget(),e=this;if(this.isPrototype){var f=new MenuMorph(this);f.addItem("script pic...",function(){var g=this.world().children[0];g.saveCanvasAs(this.topBlock().scriptPic(),(g.projectName||localize("untitled"))+" "+localize("script pic"))},"download a picture of this script");f.addItem("translations...",function(){c.parentThatIsA(BlockEditorMorph).editTranslations()},
"experimental -\nunder construction");this.isGlobal&&(2>c.inputs().length?f.addItem("block variables...",function(){c.enableBlockVars()},"experimental -\nunder construction"):f.addItem("remove block variables...",function(){c.enableBlockVars(!1)},"experimental -\nunder construction"))}else(f=this.constructor.uber.userMenu.call(this))?f.addLine():f=new MenuMorph(this),this.isTemplate?(this.isGlobal?f.addItem("delete block definition...","deleteBlockDefinition"):contains(Object.keys(d.inheritedBlocks()),
this.blockSpec)?a("inherited",function(){var g=e.parentThatIsA(IDE_Morph);d.customBlocks.push(d.getMethod(e.blockSpec).copyAndBindTo(d));g&&(g.flushPaletteCache(),g.refreshPalette())},!0,"uncheck to\ndisinherit",null):d.exemplar&&d.exemplar.getMethod(this.blockSpec)?a("inherited","deleteBlockDefinition",!1,null,localize("check to inherit\nfrom")+" "+d.exemplar.name):f.addItem("delete block definition...","deleteBlockDefinition"),f.addItem("duplicate block definition...","duplicateBlockDefinition")):
(this.isGlobal||contains(Object.keys(d.ownBlocks()),this.blockSpec))&&f.addItem("delete block definition...","deleteBlockDefinition"),this.variables.names().forEach(function(g){return b(g)});f.addItem("edit...","edit");return f};CustomCommandBlockMorph.prototype.exportBlockDefinition=function(){var a=(new SnapSerializer).serialize(this.definition);this.parentThatIsA(IDE_Morph).saveXMLAs(a,this.spec)};
CustomCommandBlockMorph.prototype.duplicateBlockDefinition=function(){var a=this,b,c,d,e;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){if(1==f.nextAddress)return b=a.scriptTarget(),c=a.isGlobal?a.definition:b.getMethod(a.blockSpec),d=c.copyAndBindTo(b),f.yield(SnapActions.addCustomBlock(d,b),2);e=f.yieldResult;(new BlockEditorMorph(e,b)).popUp();return f.return(e)})};
CustomCommandBlockMorph.prototype.deleteBlockDefinition=function(){var a=this,b=this.scriptTarget();if(this.isPrototype)return null;var c=(this.isGlobal?this.definition:b.getLocalMethod(this.blockSpec)).blockInstance();(new DialogBoxMorph(this,function(){return SnapActions.deleteCustomBlock(a.definition)},this)).askYesNo("Delete Custom Block",localize("block deletion dialog text"),this.world(),c.doWithAlpha(1,function(){c.addShadow();return c.fullImage()}))};
CustomCommandBlockMorph.prototype.relabel=function(a){var b=this,c=new MenuMorph(this),d=this.inputs().map(function(e){return e.fullCopy()});a.forEach(function(e){var f=e.blockInstance();f.restoreInputs(d);f.fixBlockColor(null,!0);f.addShadow(new Point(3,3));c.addItem(f.doWithAlpha(1,function(){return f.fullImage()}),function(){b.definition=e;b.refresh()})});c.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))};
CustomCommandBlockMorph.prototype.alternatives=function(){var a=this,b=this.scriptTarget(),c=b.parentThatIsA(StageMorph);b=b.customBlocks.concat(c.globalBlocks);var d=this instanceof CommandBlockMorph?"command":this.isPredicate?"predicate":"reporter";return b.filter(function(e){return e!==a.definition&&e.type===d})};CustomReporterBlockMorph.prototype=new ReporterBlockMorph;CustomReporterBlockMorph.prototype.constructor=CustomReporterBlockMorph;CustomReporterBlockMorph.uber=ReporterBlockMorph.prototype;
CustomReporterBlockMorph.prototype.isCustomBlock=!0;function CustomReporterBlockMorph(a,b,c){this.init(a,b,c)}CustomReporterBlockMorph.prototype.init=function(a,b,c){this.definition=a;this.semanticSpec="";this.isGlobal=a?a.isGlobal:!1;this.isPrototype=c||!1;CustomReporterBlockMorph.uber.init.call(this,b,!0);this.category=a.category;this.storedTranslations=null;this.variables=new VariableFrame;this.initializeVariables();this.selector="evaluateCustomBlock";a&&this.refresh()};
CustomReporterBlockMorph.prototype.initializeVariables=CustomCommandBlockMorph.prototype.initializeVariables;CustomReporterBlockMorph.prototype.refresh=function(a){var b=a||this.definition;CustomCommandBlockMorph.prototype.refresh.call(this,a,!0);this.isPrototype||(this.isPredicate="predicate"===b.type);this.parent instanceof SyntaxElementMorph&&(this.parent.cachedInputs=null);this.fixLayout()};
CustomReporterBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype)return CustomReporterBlockMorph.uber.mouseClickLeft.call(this);this.edit()};CustomReporterBlockMorph.prototype.placeHolder=CustomCommandBlockMorph.prototype.placeHolder;CustomReporterBlockMorph.prototype.parseSpec=CustomCommandBlockMorph.prototype.parseSpec;CustomReporterBlockMorph.prototype.edit=CustomCommandBlockMorph.prototype.edit;CustomReporterBlockMorph.prototype.labelPart=CustomCommandBlockMorph.prototype.labelPart;
CustomReporterBlockMorph.prototype.upvarFragmentNames=CustomCommandBlockMorph.prototype.upvarFragmentNames;CustomReporterBlockMorph.prototype.upvarFragmentName=CustomCommandBlockMorph.prototype.upvarFragmentName;CustomReporterBlockMorph.prototype.inputFragmentNames=CustomCommandBlockMorph.prototype.inputFragmentNames;CustomReporterBlockMorph.prototype.specFromFragments=CustomCommandBlockMorph.prototype.specFromFragments;CustomReporterBlockMorph.prototype.blockSpecFromFragments=CustomCommandBlockMorph.prototype.blockSpecFromFragments;
CustomReporterBlockMorph.prototype.declarationsFromFragments=CustomCommandBlockMorph.prototype.declarationsFromFragments;CustomReporterBlockMorph.prototype.refreshPrototype=CustomCommandBlockMorph.prototype.refreshPrototype;CustomReporterBlockMorph.prototype.refreshPrototypeSlotTypes=CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes;CustomReporterBlockMorph.prototype.restoreInputs=CustomCommandBlockMorph.prototype.restoreInputs;CustomReporterBlockMorph.prototype.refreshDefaults=CustomCommandBlockMorph.prototype.refreshDefaults;
CustomReporterBlockMorph.prototype.isInUse=CustomCommandBlockMorph.prototype.isInUse;CustomReporterBlockMorph.prototype.userMenu=CustomCommandBlockMorph.prototype.userMenu;CustomReporterBlockMorph.prototype.duplicateBlockDefinition=CustomCommandBlockMorph.prototype.duplicateBlockDefinition;CustomReporterBlockMorph.prototype.deleteBlockDefinition=CustomCommandBlockMorph.prototype.deleteBlockDefinition;CustomReporterBlockMorph.prototype.bubbleHelp=CustomCommandBlockMorph.prototype.bubbleHelp;
CustomReporterBlockMorph.prototype.popUpbubbleHelp=CustomCommandBlockMorph.prototype.popUpbubbleHelp;CustomReporterBlockMorph.prototype.relabel=CustomCommandBlockMorph.prototype.relabel;CustomReporterBlockMorph.prototype.alternatives=CustomCommandBlockMorph.prototype.alternatives;JaggedBlockMorph.prototype=new ReporterBlockMorph;JaggedBlockMorph.prototype.constructor=JaggedBlockMorph;JaggedBlockMorph.uber=ReporterBlockMorph.prototype;function JaggedBlockMorph(a){this.init(a)}
JaggedBlockMorph.prototype.init=function(a){JaggedBlockMorph.uber.init.call(this);a&&this.setSpec(a);if("%cs"===a||"%ca"===a)this.minWidth=25,this.fixLayout()};
JaggedBlockMorph.prototype.outlinePath=function(a,b){var c=this.width(),d=this.position(),e=0;a.moveTo(b,b);a.lineTo(c-b,b);this.cSlots().forEach(function(k){k.outlinePath(a,b,k.position().subtract(d));e+=k.height()});var f=this.height()-e-b;var g=Math.round(f/this.jag);var h=f/g;for(f=0;f<g;f+=1)e+=h/2,a.lineTo(c-this.jag/2-b,e),e+=h/2,a.lineTo(c-b,e);f=this.height()-b;g=Math.round(f/this.jag);h=f/g;a.lineTo(b,f-b);e=f;for(f=0;f<g;f+=1)e-=h/2,a.lineTo(this.jag/2+b,e),e-=h/2,a.lineTo(b,e)};
JaggedBlockMorph.prototype.drawEdges=function(a){var b=this.width(),c=this.height(),d=Math.round(c/this.jag),e=c/d,f=this.edge/2,g;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var h=a.createLinearGradient(0,0,0,this.edge);h.addColorStop(0,this.cachedClrBright);h.addColorStop(1,this.cachedClr);a.strokeStyle=h;a.beginPath();a.moveTo(f,f);a.lineTo(b-f,f);a.stroke();if(!this.cSlots().length)for(h=g=0;h<d;h+=1)a.strokeStyle=this.cachedClrDark,a.beginPath(),a.moveTo(b-f,g),g+=e/2,a.lineTo(b-
this.jag/2-f,g),a.stroke(),g+=e/2;h=a.createLinearGradient(0,c-this.edge,0,c);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrDark);a.strokeStyle=h;a.beginPath();a.moveTo(b-f,c-f);a.lineTo(f,c-f);a.stroke();g=c;for(h=0;h<d;h+=1)a.strokeStyle=this.cachedClrBright,a.beginPath(),a.moveTo(f,g),g-=e/2,a.lineTo(this.jag/2+f,g),a.stroke(),g-=e/2};BlockDialogMorph.prototype=new DialogBoxMorph;BlockDialogMorph.prototype.constructor=BlockDialogMorph;BlockDialogMorph.uber=DialogBoxMorph.prototype;
function BlockDialogMorph(a,b,c){this.init(a,b,c)}
BlockDialogMorph.prototype.init=function(a,b,c){this.blockType="command";this.category="other";this.isGlobal=!0;this.categories=this.types=null;BlockDialogMorph.uber.init.call(this,a,b,c);this.key="makeABlock";this.types=new AlignmentMorph("row",this.padding);this.add(this.types);this.scopes=new AlignmentMorph("row",this.padding);this.add(this.scopes);this.categories=new BoxMorph;this.categories.color=SpriteMorph.prototype.paletteColor.lighter(8);this.categories.borderColor=this.categories.color.lighter(40);
this.createCategoryButtons();this.fixCategoriesLayout();this.add(this.categories);this.createTypeButtons();this.createScopeButtons();this.fixLayout()};
BlockDialogMorph.prototype.openForChange=function(a,b,c,d,e,f){var g=SpriteMorph.prototype.blockColor[b];this.key="changeABlock";this.category=b;this.blockType=c;this.categories.children.forEach(function(h){return h.refresh()});this.types.children.forEach(function(h){h.setColor(g);h.refresh()});this.labelString=a;this.createLabel();e&&this.setPicture(e);this.addButton("ok","OK");this.addButton("cancel","Cancel");f&&(this.types.destroy(),this.types=null);this.scopes.destroy();this.scopes=null;this.fixLayout();
this.rerender();this.popUp(d)};BlockDialogMorph.prototype.createCategoryButtons=function(){var a=this;SpriteMorph.prototype.categories.forEach(function(b){return a.addCategoryButton(b)})};
BlockDialogMorph.prototype.addCategoryButton=function(a){var b=this,c=[IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor.darker(MorphicPreferences.isFlat?5:50),SpriteMorph.prototype.blockColor[a]];var d=new ToggleButtonMorph(c,this,function(){b.category=a;b.categories.children.forEach(function(e){return e.refresh()});b.types&&b.types.children.forEach(function(e){return e.setColor(c[2])});b.edit()},a[0].toUpperCase().concat(a.slice(1)),function(){return b.category===a},null,null,75,!0);
d.corner=8;d.padding=0;d.labelShadowOffset=new Point(-1,-1);d.labelShadowColor=c[1];d.labelColor=IDE_Morph.prototype.buttonLabelColor;MorphicPreferences.isFlat&&(d.labelPressColor=WHITE);d.contrast=this.buttonContrast;d.fixLayout();d.refresh();this.categories.add(d);return d};
BlockDialogMorph.prototype.fixCategoriesLayout=function(){var a=this.categories.children[0].width(),b=this.categories.children[0].height(),c=Math.ceil(this.categories.children.length/2),d=this.categories.left(),e=this.categories.top(),f=0,g,h;this.categories.children.forEach(function(k){f+=1;g=Math.ceil(f/2);h=2-f%2;k.setPosition(new Point(d+(15*h+(h-1)*a),e+(2*g+(g-1)*b+10)))});MorphicPreferences.isFlat&&(this.categories.corner=0,this.categories.border=0,this.categories.edge=0);this.categories.setExtent(new Point(45+
2*a,2*(c+1)+c*b+20))};
BlockDialogMorph.prototype.createTypeButtons=function(){var a=this,b=SpriteMorph.prototype.blockColor[this.category];var c=new CommandBlockMorph;c.setColor(b);c.setSpec(localize("Command"));this.addBlockTypeButton(function(){return a.setType("command")},c,function(){return"command"===a.blockType});c=new ReporterBlockMorph;c.setColor(b);c.setSpec(localize("Reporter"));this.addBlockTypeButton(function(){return a.setType("reporter")},c,function(){return"reporter"===a.blockType});c=new ReporterBlockMorph(!0);
c.setColor(b);c.setSpec(localize("Predicate"));this.addBlockTypeButton(function(){return a.setType("predicate")},c,function(){return"predicate"===a.blockType})};BlockDialogMorph.prototype.addBlockTypeButton=function(a,b,c){a=new ToggleElementMorph(this,a,b,c,null,null,"rebuild");a.refresh();a.fixLayout();this.types.add(a);return a};
BlockDialogMorph.prototype.addTypeButton=function(a,b,c){a=new ToggleMorph("radiobutton",this,a,b,c);a.edge=this.buttonEdge/2;a.outline=this.buttonOutline/2;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.contrast=this.buttonContrast;a.fixLayout();this.types.add(a);return a};BlockDialogMorph.prototype.setType=function(a){this.blockType=a||this.blockType;this.types.children.forEach(function(b){return b.refresh()});this.edit()};
BlockDialogMorph.prototype.createScopeButtons=function(){var a=this;this.addScopeButton(function(){return a.setScope("global")},"for all sprites",function(){return a.isGlobal});this.addScopeButton(function(){return a.setScope("local")},"for this sprite only",function(){return!a.isGlobal})};
BlockDialogMorph.prototype.addScopeButton=function(a,b,c){a=new ToggleMorph("radiobutton",this,a,b,c);a.edge=this.buttonEdge/2;a.outline=this.buttonOutline/2;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.contrast=this.buttonContrast;a.fixLayout();this.scopes.add(a);return a};BlockDialogMorph.prototype.setScope=function(a){this.isGlobal="global"===a;this.scopes.children.forEach(function(b){return b.refresh()});this.edit()};
BlockDialogMorph.prototype.getInput=function(){var a;this.body instanceof InputFieldMorph&&(a=this.normalizeSpaces(this.body.getValue()));a=new CustomBlockDefinition(a);a.type=this.blockType;a.category=this.category;a.isGlobal=this.isGlobal;if("reporter"===a.type||"predicate"===a.type){var b=Process.prototype.reify.call(null,SpriteMorph.prototype.blockForSelector("doReport"),new List,!0);b.outerContext=null;a.body=b}return a};
BlockDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body?(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.bounds.setWidth(this.body.width()+2*this.padding),this.bounds.setHeight(this.body.height()+2*this.padding+a),this.categories&&(this.categories.setCenter(this.body.center()),this.categories.setTop(this.body.top()),this.body.setTop(this.categories.bottom()+this.padding),this.bounds.setHeight(this.height()+
this.categories.height()+this.padding))):this.head&&(this.types?(this.types.fixLayout(),this.bounds.setWidth(Math.max(this.types.width(),this.head.width())+2*this.padding)):this.bounds.setWidth(Math.max(this.categories.width(),this.head.width())+2*this.padding),this.head.setCenter(this.center()),this.head.setTop(a+this.padding),this.bounds.setHeight(this.head.height()+2*this.padding+a),this.categories&&(this.categories.setCenter(this.center()),this.categories.setTop(this.head.bottom()+this.padding),
this.bounds.setHeight(this.height()+this.categories.height()+this.padding)));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.types&&(this.types.fixLayout(),this.bounds.setHeight(this.height()+this.types.height()+this.padding),this.bounds.setWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+
this.padding));this.scopes&&(this.scopes.fixLayout(),this.bounds.setHeight(this.height()+this.scopes.height()+this.padding/3),this.bounds.setWidth(Math.max(this.width(),this.scopes.width()+2*this.padding)),this.scopes.setCenter(this.center()),this.types&&this.scopes.setTop(this.types.bottom()+this.padding/3));this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.bounds.setHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-
this.padding));this.removeShadow();this.addShadow()};BlockDialogMorph.prototype.accept=function(){this.body instanceof InputFieldMorph&&""===this.normalizeSpaces(this.body.getValue())?this.edit():BlockDialogMorph.uber.accept.call(this)};BlockEditorMorph.prototype=new DialogBoxMorph;BlockEditorMorph.prototype.constructor=BlockEditorMorph;BlockEditorMorph.uber=DialogBoxMorph.prototype;function BlockEditorMorph(a,b){this.init(a,b)}
BlockEditorMorph.prototype.init=function(a,b){var c=this,d=Process.prototype.enableLiveCoding||Process.prototype.enableSingleStepping;this.definition=a;this.translations=a.translationsAsText();this.handle=null;BlockEditorMorph.uber.init.call(this,b,function(){return c.updateDefinition()},b);this.key="editBlock"+a.spec;this.labelString=this.definition.isGlobal?"Block Editor":"Method Editor";this.createLabel();var e=new ScriptsMorph;e.rejectsHats=!0;e.isDraggable=!1;e.color=IDE_Morph.prototype.groupColor;
e.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture;e.cleanUpMargin=10;var f=new PrototypeHatBlockMorph(this.definition);f.setPosition(e.position().add(10));null!==a.comment&&(b=a.comment.fullCopy(),f.comment=b,b.block=f);null!==a.body&&f.nextBlock(d?a.body.expression:a.body.expression.fullCopy());e.add(f);f.fixBlockColor(null,!0);this.definition.scripts.forEach(function(h){g=h.fullCopy();g.setPosition(e.position().add(h.position()));e.add(g);g instanceof BlockMorph&&g.allComments().forEach(function(k){return k.align(g)})});
f.allComments().forEach(function(h){return h.align(f)});a=new ScrollFrameMorph(e);a.padding=10;a.growth=50;a.isDraggable=!1;a.acceptsDrops=!1;a.contents.acceptsDrops=!0;e.scrollFrame=a;e.updateToolbar();this.addBody(a);this.addButton("ok","Done");this.setExtent(new Point(375,300));this.fixLayout();e.fixMultiArgs();var g=f.parts()[0];g.forceNormalColoring();g.fixBlockColor(f,!0)};BlockEditorMorph.prototype.mouseClickLeft=function(){this.target.parentThatIsA(IDE_Morph).setActiveEditor(this)};
BlockEditorMorph.prototype.onSetActive=function(){this.body.contents.updateToolbar()};BlockEditorMorph.prototype.onUnsetActive=function(){this.body.contents.hideToolbar()};BlockEditorMorph.prototype.popUp=function(a){var b=this.target.world();if(b){BlockEditorMorph.uber.popUp.call(this,b);this.setInitialDimensions(a);this.handle=new HandleMorph(this,280,220,this.corner,this.corner);b.keyboardReceiver=null;var c=this.target.parentThatIsA(IDE_Morph);a||c.setActiveEditor(this);b.keyboardFocus=null}};
BlockEditorMorph.prototype.justDropped=function(){nop()};
BlockEditorMorph.prototype.accept=function(a){if(!(a instanceof CursorMorph)){if(this.action)if("function"===typeof this.target)"function"===typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action);else if("function"===typeof this.action)this.action.call(this.target,this.getInput());else this.target[this.action](this.getInput());(a=this.target.parentThatIsA(IDE_Morph))&&a.activeEditor===this&&a.setActiveEditor();this.close()}};
BlockEditorMorph.prototype.cancel=function(a){a instanceof CursorMorph||this.close()};
BlockEditorMorph.prototype.close=function(){var a;if(this.definition.isGlobal&&(a=detect(this.body.contents.allChildren(),function(c){return c.isCustomBlock&&!c.isGlobal}))){a=a.scriptTarget().getMethod(a.semanticSpec).blockInstance();a.addShadow();(new DialogBoxMorph).inform("Local Block(s) in Global Definition","This global block definition contains one or more\nlocal custom blocks which must be removed first.",this.world(),a.doWithAlpha(1,function(){return a.fullImage()}));return}var b=this.target.doubleDefinitionsFor(this.definition);
0<b.length?(a=b[0].blockInstance(),a.addShadow(),(new DialogBoxMorph(this,"consolidateDoubles",this)).askYesNo("Same Named Blocks","Another custom block with this name exists.\nWould you like to replace it?",this.world(),a.doWithAlpha(1,function(){return a.fullImage()}))):this.destroy()};BlockEditorMorph.prototype.consolidateDoubles=function(){this.target.replaceDoubleDefinitionsFor(this.definition);this.destroy()};
BlockEditorMorph.prototype.refreshAllBlockInstances=function(a){var b=this.definition,c=this.target.paletteBlockInstance(b);this.definition.isGlobal?this.target.allBlockInstances(this.definition).reverse().forEach(function(d){return d.refresh()}):this.target.allDependentInvocationsOf(a).reverse().forEach(function(d){return d.refresh(b)});c&&c.refreshDefaults()};
BlockEditorMorph.prototype.updateDefinition=function(){var a=this,b;var c=this.definition.blockSpec();var d=this.body.contents.position(),e=1,f;this.definition.receiver=this.target;this.definition.spec=this.prototypeSpec();this.definition.declarations=this.prototypeSlots();this.definition.variableNames=this.variableNames();this.definition.scripts=[];this.definition.updateTranslations(this.translations);this.definition.cachedTranslation=null;this.definition.editorDimensions=this.bounds.copy();this.definition.cachedIsRecursive=
null;this.body.contents.children.forEach(function(g){if(g instanceof PrototypeHatBlockMorph)b=g;else if(g instanceof BlockMorph||g instanceof CommentMorph&&!g.block)f=g.fullCopy(),f.parent=null,f.setPosition(g.position().subtract(d)),a.definition.scripts.push(f)});b&&(this.definition.category!==b.blockCategory&&this.target.shadowAttribute("scripts"),this.definition.category=b.blockCategory,this.definition.type=b.type,b.comment?(this.definition.comment=b.comment.fullCopy(),this.definition.comment.block=
!0):this.definition.comment=null);for(this.definition.body=this.context(b);0<this.target.doubleDefinitionsFor(this.definition).length;)e+=1,this.definition.spec=this.definition.spec+" ("+e+")";this.refreshAllBlockInstances(c);c=this.target.parentThatIsA(IDE_Morph);c.flushPaletteCache();c.refreshPalette()};
BlockEditorMorph.prototype.context=function(a){a=(a||detect(this.body.contents.children,function(b){return b instanceof PrototypeHatBlockMorph})).nextBlock();if(null===a)return null;a.allChildren().forEach(function(b){b instanceof BlockMorph&&(b.cachedInputs=null)});a=Process.prototype.reify.call(null,a,new List(this.definition.inputNames()),!0);a.outerContext=null;return a};
BlockEditorMorph.prototype.prototypeSpec=function(){return detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph}).parts()[0].specFromFragments()};BlockEditorMorph.prototype.prototypeSlots=function(){return detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph}).parts()[0].declarationsFromFragments()};BlockEditorMorph.prototype.variableNames=function(){return detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph}).variableNames()};
BlockEditorMorph.prototype.editTranslations=function(){var a=this,b=this.definition.blockInstance();b.addShadow(new Point(3,3));(new DialogBoxMorph(this,function(c){return a.translations=c},this)).promptCode("Custom Block Translations",this.translations,this.world(),b.doWithAlpha(1,function(){return b.fullImage()}),this.definition.abstractBlockSpec()+"\n\n"+localize('Enter one translation per line. use colon (":") as lang/spec delimiter\nand underscore ("_") as placeholder for an input, e.g.:\n\nen:say _ for _ secs'))};
BlockEditorMorph.prototype.setInitialDimensions=function(){var a=this.world(),b=a.extent().subtract(new Point(this.padding,this.padding)),c=fontHeight(this.titleFontSize)+2*this.titlePadding,d=this.buttons.height();this.definition.editorDimensions?(this.setPosition(this.definition.editorDimensions.origin),this.setExtent(this.definition.editorDimensions.extent().min(b)),this.keepWithin(a)):(this.setExtent(this.body.contents.extent().add(new Point(this.padding,this.padding+c+d)).min(b)),this.setCenter(this.world().center()))};
BlockEditorMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout();this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-a-this.buttons.height())));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&
0<this.buttons.children.length&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding));this.removeShadow();this.addShadow()};PrototypeHatBlockMorph.prototype=new HatBlockMorph;PrototypeHatBlockMorph.prototype.constructor=PrototypeHatBlockMorph;PrototypeHatBlockMorph.uber=HatBlockMorph.prototype;function PrototypeHatBlockMorph(a){this.init(a)}
PrototypeHatBlockMorph.prototype.init=function(a){var b=a.prototypeInstance();this.blockCategory=(this.definition=a)?a.category:null;this.type=a?a.type:null;HatBlockMorph.uber.init.call(this);this.color=SpriteMorph.prototype.blockColor.control;this.category="control";this.add(b);if(a.variableNames.length){var c=this.labelPart("%blockVars");this.add(this.labelPart("%br"));this.add(c);a.variableNames.forEach(function(d){return c.addInput(d)})}b.refreshPrototypeSlotTypes();this.fixLayout();b.fixBlockColor(this,
!0);this.id=this.definition.id};PrototypeHatBlockMorph.prototype.mouseClickLeft=function(){if(16===this.world().currentKey)return this.focus();this.parts()[0].mouseClickLeft()};PrototypeHatBlockMorph.prototype.userMenu=function(){return this.parts()[0].userMenu()};
PrototypeHatBlockMorph.prototype.fixBlockColor=function(a,b){a=this.parts()[0]||a;if(this.zebraContrast||b){if(!this.zebraContrast&&b)return this.forceNormalColoring();a.category===this.category?a.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor();b&&this.fixChildrensBlockColor(!0)}};PrototypeHatBlockMorph.prototype.variableNames=function(a){a=this.parts();return 3>a.length?[]:a[2].evaluate()};
PrototypeHatBlockMorph.prototype.enableBlockVars=function(a){var b=this.parts()[0];!1===a?this.setSpec("%s",!0):this.setSpec("%s %br %blockVars",!0);this.replaceInput(this.parts()[0],b);this.spec=null};function BlockLabelFragment(a){this.labelString=a||"";this.type="%s";this.options=this.defaultValue="";this.isDeleted=this.isReadOnly=!1}BlockLabelFragment.prototype.defSpecFragment=function(){var a=this.type?"%'":"";return this.isDeleted?"":a+this.labelString+(this.type?"'":"")};
BlockLabelFragment.prototype.defTemplateSpecFragment=function(){var a="";if(!this.type)return this.defSpecFragment();this.isUpvar()?a=" \u2191":this.isMultipleInput()?a="...":"%cs"===this.type||"%ca"===this.type?a=" \u03bb":"%b"===this.type?a=" ?":"%l"===this.type?a=" \ufe19":"%obj"===this.type?a=" %turtleOutline":contains(["%cmdRing","%repRing","%predRing","%anyUE","%boolUE"],this.type)?a=" \u03bb":this.defaultValue?a="%n"===this.type?" # = "+this.defaultValue.toString():contains(["%mlt","%code"],
this.type)?" \u00b6 = "+this.defaultValue.toString():" = "+this.defaultValue.toString():"%n"===this.type?a=" #":contains(["%mlt","%code"],this.type)&&(a=" \u00b6");return this.labelString+a};BlockLabelFragment.prototype.blockSpecFragment=function(){return this.isDeleted?"":this.type||this.labelString};BlockLabelFragment.prototype.copy=function(){var a=new BlockLabelFragment(this.labelString);a.type=this.type;a.defaultValue=this.defaultValue;a.options=this.options;a.isReadOnly=this.isReadOnly;return a};
BlockLabelFragment.prototype.hasOptions=function(){return""!==this.options&&!this.hasSpecialMenu()};BlockLabelFragment.prototype.hasSpecialMenu=function(){return contains("\u00a7_messagesMenu \u00a7_messagesReceivedMenu \u00a7_objectsMenu \u00a7_costumesMenu \u00a7_soundsMenu \u00a7_getVarNamesDict \u00a7_pianoKeyboardMenu \u00a7_directionDialMenu".split(" "),this.options)};BlockLabelFragment.prototype.isSingleInput=function(){return!this.isMultipleInput()&&"%upvar"!==this.type};
BlockLabelFragment.prototype.isMultipleInput=function(){return this.type?-1<this.type.indexOf("%mult"):!1};BlockLabelFragment.prototype.isUpvar=function(){return this.type?"%upvar"===this.type:!1};BlockLabelFragment.prototype.setToSingleInput=function(){if(!this.type)return null;this.type="%upvar"===this.type?"%s":this.singleInputType()};
BlockLabelFragment.prototype.setToMultipleInput=function(){if(!this.type)return null;"%upvar"===this.type?this.type="%s":"%ca"===this.type&&(this.type="%cs");this.type="%mult".concat(this.singleInputType())};BlockLabelFragment.prototype.setToUpvar=function(){if(!this.type)return null;this.type="%upvar"};BlockLabelFragment.prototype.singleInputType=function(){return this.type?this.isMultipleInput()?this.type.substr(5):this.type:null};
BlockLabelFragment.prototype.setSingleInputType=function(a){this.type&&this.isMultipleInput()?this.type="%mult".concat(a):this.type=a};BlockLabelFragmentMorph.prototype=new StringMorph;BlockLabelFragmentMorph.prototype.constructor=BlockLabelFragmentMorph;BlockLabelFragmentMorph.uber=StringMorph.prototype;function BlockLabelFragmentMorph(a){this.init(a)}
BlockLabelFragmentMorph.prototype.init=function(a){this.fragment=new BlockLabelFragment(a);this.sO=this.fragment.type=null;BlockLabelFragmentMorph.uber.init.call(this,a,null,SyntaxElementMorph.prototype.labelFontStyle,null,null,null,null,null,null,SyntaxElementMorph.prototype.labelFontName)};BlockLabelFragmentMorph.prototype.mouseEnter=function(){this.sO=this.shadowOffset;this.shadowOffset=this.sO.neg();this.fixLayout();this.rerender()};
BlockLabelFragmentMorph.prototype.mouseLeave=function(){this.shadowOffset=this.sO;this.fixLayout();this.rerender()};
BlockLabelFragmentMorph.prototype.mouseClickLeft=function(){var a=this,b=this.fragment.copy(),c=this instanceof BlockLabelPlaceHolderMorph,d=2>this.parent.parseSpec(this.parent.blockSpec).length;(new InputSlotDialogMorph(b,null,function(){b.isDeleted?SnapActions.deleteBlockLabel(a.parent.definition,a):b.labelString&&SnapActions.updateBlockLabel(a.parent.definition,a,b)},this,this.parent.definition.category)).open(this instanceof BlockLabelFragmentMorph?"Edit label fragment":c?"Create input name":
"Edit input name",b.labelString,this.world(),null,c||d)};BlockLabelFragmentMorph.prototype.updateBlockLabel=function(a){var b=this.parentThatIsA(BlockMorph);this.fragment=a;b&&b.refreshPrototype()};
BlockLabelFragmentMorph.prototype.userMenu=function(){var a=this,b=new Color(100,100,130),c=new MenuMorph(function(d){var e=a.text.split("-");a.changed();e[0]="$"+d;a.text=e.join("-");a.fragment.labelString=a.text;a.parent.parent.changed();a.fixLayout();a.parent.parent.fixLayout();a.parent.parent.changed()},null,this,this.fontSize);SymbolMorph.prototype.names.forEach(function(d){return c.addItem([new SymbolMorph(d,c.fontSize,b),localize(d)],d)});c.addLine();c.addItem("\u23ce "+localize("new line"),
"nl");return c};BlockLabelPlaceHolderMorph.prototype=new StringMorph;BlockLabelPlaceHolderMorph.prototype.constructor=BlockLabelPlaceHolderMorph;BlockLabelPlaceHolderMorph.uber=StringMorph.prototype;BlockLabelPlaceHolderMorph.prototype.plainLabel=!1;function BlockLabelPlaceHolderMorph(){this.init()}
BlockLabelPlaceHolderMorph.prototype.init=function(){this.fragment=new BlockLabelFragment("");this.fragment.type="%s";this.fragment.isDeleted=!0;this.isHighlighted=!1;this.isProtectedLabel=!0;BlockLabelFragmentMorph.uber.init.call(this,"+")};
BlockLabelPlaceHolderMorph.prototype.fixLayout=function(){this.plainLabel&&(this.text=this.isHighlighted?" + ":"");this.measureCtx.font=this.font();this.bounds.corner=this.bounds.origin.add(new Point(Math.max(this.measureCtx.measureText(this.text).width,SyntaxElementMorph.prototype.scale),fontHeight(this.fontSize)));this.parent&&(this.parent.fixLayout&&this.parent.fixLayout(),this.parent.parent instanceof PrototypeHatBlockMorph&&this.parent.parent.fixLayout())};
BlockLabelPlaceHolderMorph.prototype.render=function(a){if(this.isHighlighted){var b=this.width()/2;var c=this.height()/2;a.fillStyle=this.color.toString();a.beginPath();a.arc(b,1.2*c,Math.min(b,c),radians(0),radians(360),!1);a.closePath();a.fill()}a.font=this.font();a.textAlign="left";a.textBaseline="bottom";a.fillStyle=this.isHighlighted?"white":this.color.toString();a.fillText(this.text,0,fontHeight(this.fontSize))};
BlockLabelPlaceHolderMorph.prototype.mouseEnter=function(){var a=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!0;this.plainLabel&&a?(a.changed(),this.fixLayout(),a.changed()):(this.fixLayout(),this.rerender())};BlockLabelPlaceHolderMorph.prototype.mouseLeave=function(){var a=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!1;this.plainLabel&&a?(a.changed(),this.fixLayout(),a.changed()):(this.fixLayout(),this.rerender())};
BlockLabelPlaceHolderMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft;BlockLabelPlaceHolderMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel;BlockInputFragmentMorph.prototype=new TemplateSlotMorph;BlockInputFragmentMorph.prototype.constructor=BlockInputFragmentMorph;BlockInputFragmentMorph.uber=TemplateSlotMorph.prototype;function BlockInputFragmentMorph(a){this.init(a)}
BlockInputFragmentMorph.prototype.init=function(a){this.fragment=new BlockLabelFragment(a);this.fragment.type="%s";BlockInputFragmentMorph.uber.init.call(this,a)};BlockInputFragmentMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft;BlockInputFragmentMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel;InputSlotDialogMorph.prototype=new DialogBoxMorph;InputSlotDialogMorph.prototype.constructor=InputSlotDialogMorph;
InputSlotDialogMorph.uber=DialogBoxMorph.prototype;InputSlotDialogMorph.prototype.isLaunchingExpanded=!1;function InputSlotDialogMorph(a,b,c,d,e){this.init(a,b,c,d,e)}
InputSlotDialogMorph.prototype.init=function(a,b,c,d,e){var f=SyntaxElementMorph.prototype.scale,g=fontHeight(10)/1.2*f;this.fragment=a||new BlockLabelFragment;this.slots=this.types=this.textfield=null;this.isExpanded=!1;this.category=e||"other";this.noDelete=!1;BlockDialogMorph.uber.init.call(this,b,c,d);this.types=new AlignmentMorph("row",this.padding);this.types.respectHiddens=!0;this.add(this.types);this.slots=new BoxMorph;this.slots.color=new Color(55,55,55);this.slots.borderColor=this.slots.color.lighter(50);
this.slots.setExtent(new Point(24*(g+10),10.4*(g+10*f)));this.add(this.slots);this.createSlotTypeButtons();this.fixSlotsLayout();this.addSlotsMenu();this.createTypeButtons();this.fixLayout()};
InputSlotDialogMorph.prototype.createTypeButtons=function(){var a=this,b=SpriteMorph.prototype.blockColor[this.category];var c=new JaggedBlockMorph(localize("Title text"));c.setColor(b);this.addBlockTypeButton(function(){return a.setType(null)},c,function(){return null===a.fragment.type});c=new JaggedBlockMorph("%inputName");c.setColor(b);this.addBlockTypeButton(function(){return a.setType("%s")},c,function(){return null!==a.fragment.type});var d=new ArrowMorph("right",PushButtonMorph.prototype.fontSize+
4,2);d.noticesTransparentClick=!0;this.types.add(d);this.types.fixLayout();d.refresh=function(){null===a.fragment.type?(a.isExpanded=!1,d.hide()):(d.show(),d.direction=a.isExpanded?"down":"right",d.fixLayout(),d.rerender())};d.mouseClickLeft=function(){d.isVisible&&(a.isExpanded=!a.isExpanded,a.types.children.forEach(function(e){return e.refresh()}),a.changed(),a.fixLayout(),a.rerender(),a.edit())};d.refresh()};InputSlotDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton;
InputSlotDialogMorph.prototype.addBlockTypeButton=BlockDialogMorph.prototype.addBlockTypeButton;
InputSlotDialogMorph.prototype.setType=function(a){this.textfield.choices=a?null:this.symbolMenu;this.textfield.fixLayout();this.fragment.type=a||null;this.types.children.forEach(function(b){return b.refresh()});this.slots.children.forEach(function(b){return b.refresh()});isNil(a)&&(this.isExpanded=!1,this.types.children.forEach(function(b){return b.refresh()}),this.changed(),this.fixLayout(),this.rerender());this.edit()};
InputSlotDialogMorph.prototype.getInput=function(){var a;this.body instanceof InputFieldMorph&&(a=this.normalizeSpaces(this.body.getValue()));if(a)return this.fragment.labelString=a,contains(["%b","%boolUE"],this.fragment.type)?this.fragment.defaultValue=this.slots.defaultSwitch.evaluate():this.fragment.defaultValue=this.slots.defaultInputField.getValue(),a;this.fragment.isDeleted=!0;return null};
InputSlotDialogMorph.prototype.fixLayout=function(){var a=this.left(),b=fontHeight(this.titleFontSize)+2*this.titlePadding;if(!this.isExpanded)return this.slots&&this.slots.hide(),BlockDialogMorph.prototype.fixLayout.call(this);this.slots.show();var c=this.slots.width();this.body.setPosition(this.position().add(new Point(this.padding+(c-this.body.width())/2,b+this.padding)));this.label.setLeft(a+this.padding+(c-this.label.width())/2);this.label.setTop(this.top()+(b-this.label.height())/2);this.types.fixLayout();
this.types.setTop(this.body.bottom()+this.padding);this.types.setLeft(a+this.padding+(c-this.types.width())/2);this.slots.setPosition(new Point(this.left()+this.padding,this.types.bottom()+this.padding));this.slots.children.forEach(function(d){return d.refresh()});this.buttons.fixLayout();this.buttons.setTop(this.slots.bottom()+this.padding);this.buttons.setLeft(a+this.padding+(c-this.buttons.width())/2);this.bounds.setHeight(this.buttons.bottom()-this.top()+this.padding);this.bounds.setWidth(this.slots.right()-
this.left()+this.padding);this.removeShadow();this.addShadow()};
InputSlotDialogMorph.prototype.open=function(a,b,c,d,e){b=new InputFieldMorph(b);this.fragment.type||(b.choices=this.symbolMenu);this.isExpanded=this.isLaunchingExpanded;b.setWidth(250);this.labelString=a;this.createLabel();d&&this.setPicture(d);this.addBody(b);this.textfield=b;this.addButton("ok","OK");e?this.noDelete=!0:this.addButton("deleteFragment","Delete");this.addButton("cancel","Cancel");this.fixLayout();this.popUp(c);this.add(this.types);this.changed()};
InputSlotDialogMorph.prototype.symbolMenu=function(){var a=this,b=[],c=new Color(100,100,130);SymbolMorph.prototype.names.forEach(function(d){return b.push([[new SymbolMorph(d,a.fontSize,c),localize(d)],"$"+d])});b.push(["\u23ce "+localize("new line"),"$nl"]);return b};InputSlotDialogMorph.prototype.deleteFragment=function(){this.fragment.isDeleted=!0;this.accept()};
InputSlotDialogMorph.prototype.createSlotTypeButtons=function(){var a=this;this.addSlotTypeButton("Object","%obj");this.addSlotTypeButton("Text","%txt");this.addSlotTypeButton("List","%l");this.addSlotTypeButton("Number","%n");this.addSlotTypeButton("Any type","%s");this.addSlotTypeButton("Boolean (T/F)","%b");this.addSlotTypeButton("Command\n(inline)","%cmdRing");this.addSlotTypeButton("Reporter","%repRing");this.addSlotTypeButton("Predicate","%predRing");this.addSlotTypeButton("Command\n(C-shape)",
["%cs","%ca"]);this.addSlotTypeButton("Any\n(unevaluated)","%anyUE");this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE");this.slots.radioButtonSingle=this.addSlotArityButton(function(){return a.setSlotArity("single")},"Single input.",function(){return a.fragment.isSingleInput()});this.addSlotArityButton(function(){return a.setSlotArity("multiple")},"Multiple inputs (value is list of inputs)",function(){return a.fragment.isMultipleInput()});this.addSlotArityButton(function(){return a.setSlotArity("upvar")},
"Upvar - make internal variable visible to caller",function(){return a.fragment.isUpvar()});var b=new StringMorph(localize("Default Value:"));b.fontSize=this.slots.radioButtonSingle.fontSize;b.setColor(WHITE);b.refresh=function(){a.isExpanded&&contains("%s %n %txt %anyUE %b %boolUE %mlt %code".split(" "),a.fragment.type)?b.show():b.hide()};this.slots.defaultInputLabel=b;this.slots.add(b);var c=new InputFieldMorph(this.fragment.defaultValue);c.contents().fontSize=b.fontSize;c.contrast=90;c.setWidth(50);
c.refresh=function(){a.isExpanded&&contains("%s %n %txt %anyUE %mlt %code".split(" "),a.fragment.type)?(c.show(),"%n"===a.fragment.type?c.setIsNumeric(!0):c.setIsNumeric(!1)):c.hide()};this.slots.defaultInputField=c;this.slots.add(c);var d=new BooleanSlotMorph(this.fragment.defaultValue);d.refresh=function(){a.isExpanded&&contains(["%b","%boolUE"],a.fragment.type)?d.show():d.hide()};this.slots.defaultSwitch=d;this.slots.add(d);var e=new ToggleMorph("checkbox",this,function(){"%ca"===a.fragment.type?
a.setType("%cs"):a.setType("%ca")},null,function(){return"%ca"===a.fragment.type},null,null,new SymbolMorph("loop",.7*this.fontSize,WHITE),null);e.refresh=function(){ToggleMorph.prototype.refresh.call(e);a.isExpanded&&contains(["%cs","%ca"],a.fragment.type)?e.show():e.hide()};this.slots.loopArrow=e;this.slots.add(e)};InputSlotDialogMorph.prototype.setSlotType=function(a){this.fragment.setSingleInputType(a);this.slots.children.forEach(function(b){return b.refresh()});this.edit()};
InputSlotDialogMorph.prototype.setSlotArity=function(a){"single"===a?this.fragment.setToSingleInput():"multiple"===a?this.fragment.setToMultipleInput():"upvar"===a&&this.fragment.setToUpvar();this.slots.children.forEach(function(b){return b.refresh()});this.edit()};InputSlotDialogMorph.prototype.setSlotOptions=function(a){this.fragment.options=a};
InputSlotDialogMorph.prototype.addSlotTypeButton=function(a,b){var c=this,d=new JaggedBlockMorph(b instanceof Array?b[0]:b);d.setCategory(this.category);d.rebuild();a=new ToggleMorph("radiobutton",this,function(){c.setSlotType(b instanceof Array?b[0]:b)},a,function(){return b instanceof Array?contains(b,c.fragment.singleInputType()):c.fragment.singleInputType()===b},null,null,d.doWithAlpha(1,function(){return d.fullImage()}),"rebuild");a.edge=this.buttonEdge/2;a.outline=this.buttonOutline/2;a.outlineColor=
this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.fixLayout();a.label.isBold=!1;a.label.setColor(WHITE);this.slots.add(a);return a};InputSlotDialogMorph.prototype.addSlotArityButton=function(a,b,c){a=new ToggleMorph("radiobutton",this,a,b,c,null,null);a.edge=this.buttonEdge/2;a.outline=this.buttonOutline/2;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.fixLayout();a.label.setColor(WHITE);this.slots.add(a);return a};
InputSlotDialogMorph.prototype.fixSlotsLayout=function(){var a=this.slots,b=SyntaxElementMorph.prototype.scale,c=10*b,d=14*b,e=(fontHeight(10)/1.2+15)*b;b*=fontHeight(10)/1.2+10;c=[a.left()+c,a.left()+a.width()/3,a.left()+2*a.width()/3];d=[a.top()+d,a.top()+d+e,a.top()+d+2*e,a.top()+d+3*e,a.top()+d+4*e,a.top()+d+5*e,a.top()+d+5*e+b,a.top()+d+5*e+2*b];b=-1;for(e=0;12>e;e+=1){var f=e%3;0===e%3&&(b+=1);a.children[e].setPosition(new Point(c[f],d[b]))}f=0;b=5;for(e=12;15>e;e+=1)a.children[e].setPosition(new Point(c[f],
d[b+e-12]));this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new Point(5,0)));this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0)));this.slots.defaultSwitch.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultSwitch.width()/2+this.slots.defaultInputLabel.width()/2+5,0)));this.slots.loopArrow.setPosition(this.slots.defaultInputLabel.position());
this.slots.changed()};
InputSlotDialogMorph.prototype.addSlotsMenu=function(){var a=this;this.slots.userMenu=function(){if(contains("%s %n %txt %anyUE %mlt %code".split(" "),a.fragment.type)){var b=new MenuMorph(a);b.addItem((a.fragment.hasOptions()?"\u2611 ":"\u2610 ")+localize("options")+"...","editSlotOptions");b.addItem((a.fragment.isReadOnly?"\u2611 ":"\u2610 ")+localize("read-only"),function(){return a.fragment.isReadOnly=!a.fragment.isReadOnly});b.addLine();b.addMenu((a.fragment.hasSpecialMenu()?"\u2611 ":"\u2610 ")+
localize("menu"),a.specialOptionsMenu());b.addMenu((contains(["%mlt","%code"],a.fragment.type)?"\u2611 ":"\u2610 ")+localize("special"),a.specialSlotsMenu());return b}return a.specialSlotsMenu()}};InputSlotDialogMorph.prototype.editSlotOptions=function(){var a=this;(new DialogBoxMorph(this,function(b){return a.fragment.options=b.trim()},this)).promptCode("Input Slot Options",this.fragment.options,this.world(),null,localize('Enter one option per line.\nOptionally use "=" as key/value delimiter and {} for submenus. e.g.\n   the answer=42'))};
InputSlotDialogMorph.prototype.specialSlotsMenu=function(){var a=new MenuMorph(this.setSlotType,null,this);a.addItem(("%mlt"===this.fragment.type?"\u26ab ":"\u26aa ")+localize("multi-line"),"%mlt");a.addItem(("%code"===this.fragment.type?"\u26ab ":"\u26aa ")+localize("code"),"%code");return a};
InputSlotDialogMorph.prototype.specialOptionsMenu=function(){function a(d,e){b.addItem((c.fragment.options===e?"\u26ab ":"\u26aa ")+localize(d),e)}var b=new MenuMorph(this.setSlotOptions,null,this),c=this;a("(none)","");a("messages","\u00a7_messagesMenu");a("objects","\u00a7_objectsMenu");a("costumes","\u00a7_costumesMenu");a("sounds","\u00a7_soundsMenu");a("variables","\u00a7_getVarNamesDict");a("piano keyboard","\u00a7_pianoKeyboardMenu");a("360\u00b0 dial","\u00a7_directionDialMenu");return b};
InputSlotDialogMorph.prototype.hide=function(){this.isVisible=!1;this.changed()};InputSlotDialogMorph.prototype.show=function(){this.isVisible=!0;this.changed()};VariableDialogMorph.prototype=new DialogBoxMorph;VariableDialogMorph.prototype.constructor=VariableDialogMorph;VariableDialogMorph.uber=DialogBoxMorph.prototype;function VariableDialogMorph(a,b,c){this.init(a,b,c)}
VariableDialogMorph.prototype.init=function(a,b,c){this.types=null;this.isGlobal=!0;BlockDialogMorph.uber.init.call(this,a,b,c);this.types=new AlignmentMorph("row",this.padding);this.add(this.types);this.createTypeButtons()};VariableDialogMorph.prototype.createTypeButtons=function(){var a=this;this.addTypeButton(function(){return a.setType("global")},"for all sprites",function(){return a.isGlobal});this.addTypeButton(function(){return a.setType("local")},"for this sprite only",function(){return!a.isGlobal})};
VariableDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton;VariableDialogMorph.prototype.setType=function(a){this.isGlobal="global"===a;this.types.children.forEach(function(b){return b.refresh()});this.edit()};VariableDialogMorph.prototype.getInput=function(){var a=this.normalizeSpaces(this.body.getValue());return a?[a,this.isGlobal]:null};
VariableDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.bounds.setWidth(this.body.width()+2*this.padding),this.bounds.setHeight(this.body.height()+2*this.padding+a));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.types&&(this.types.fixLayout(),this.bounds.setHeight(this.height()+this.types.height()+
this.padding),this.bounds.setWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding));this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.bounds.setHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding));this.removeShadow();
this.addShadow()};BlockExportDialogMorph.prototype=new DialogBoxMorph;BlockExportDialogMorph.prototype.constructor=BlockExportDialogMorph;BlockExportDialogMorph.uber=DialogBoxMorph.prototype;BlockExportDialogMorph.prototype.key="blockExport";function BlockExportDialogMorph(a,b,c,d){this.init(a,b,c,d)}
BlockExportDialogMorph.prototype.init=function(a,b,c,d){var e=this;this.serializer=a;this.blocks=b.slice(0);this.handle=null;BlockExportDialogMorph.uber.init.call(this,c,function(){return e.exportBlocks(d)},null);this.labelString="Export blocks / message types";this.createLabel();this.buildContents()};
BlockExportDialogMorph.prototype.buildContents=function(){var a=this,b,c,d,e=this.target;var f=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor);f.color=SpriteMorph.prototype.paletteColor;f.padding=4;f.isDraggable=!1;f.acceptsDrops=!1;f.contents.acceptsDrops=!1;var g=f.left()+4;var h=f.top()+4;SpriteMorph.prototype.categories.forEach(function(m){a.blocks.forEach(function(n){n.category===m&&(d&&m!==d&&(h+=4),d=m,b=n.templateInstance(),c=new ToggleMorph("checkbox",a,function(){var q=
a.blocks.indexOf(n);-1<q?a.blocks.splice(q,1):a.blocks.push(n)},null,function(){return contains(a.blocks,n)},null,null,b.fullImage()),c.setPosition(new Point(g,h+(c.top()-c.toggleElement.top()))),f.addContents(c),h+=c.fullBounds().height()+4)})});this.msgs=[];for(var k=0;k<e.deletableMessageNames().length;k++){var l=new ReporterBlockMorph;l.setSpec(e.deletableMessageNames()[k]);l.setColor(new Color(217,77,17));this.msgs.push(l)}this.msgs.forEach(function(m){c=new ToggleMorph("checkbox",a,function(){a.msgs.includes(m)?
a.msgs.splice(a.msgs.indexOf(m),1):a.msgs.push(m)},null,function(){return a.msgs.includes(m)},null,null,m.fullImage());c.setPosition(new Point(g,h+(c.top()-c.toggleElement.top())));f.addContents(c);h+=c.fullBounds().height()+4});f.scrollX(4);f.scrollY(4);this.addBody(f);this.addButton("ok","OK");this.addButton("cancel","Cancel");this.setExtent(new Point(220,300));this.fixLayout()};
BlockExportDialogMorph.prototype.popUp=function(a){if(a=a||this.target.world())BlockExportDialogMorph.uber.popUp.call(this,a),this.handle=new HandleMorph(this,200,220,this.corner,this.corner)};BlockExportDialogMorph.prototype.userMenu=function(){var a=new MenuMorph(this,"select");a.addItem("all","selectAll");a.addItem("none","selectNone");return a};BlockExportDialogMorph.prototype.selectAll=function(){this.body.contents.children.forEach(function(a){a.state||a.trigger()})};
BlockExportDialogMorph.prototype.selectNone=function(){this.blocks=[];this.body.contents.children.forEach(function(a){a.refresh()})};
BlockExportDialogMorph.prototype.exportBlocks=function(a){var b=this.serializer.serialize(this.blocks,!0),c=this.world().children[0],d=c.stage,e="";c=c.room.name||localize("untitled");for(var f=0;f<this.msgs.length;f++)e+="<messageType>"+d.messageTypes.getMsgType(this.msgs[f].blockSpec).toXML(this.serializer)+"</messageType>";0<this.blocks.length||0<this.msgs.length?(b='<blocks app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+b+e+"</blocks>",a(b,c+" "+localize("blocks"))):(new DialogBoxMorph).inform("Export blocks / message types",
"no blocks or message types were selected",this.world())};BlockExportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;BlockImportDialogMorph.prototype=new DialogBoxMorph;BlockImportDialogMorph.prototype.constructor=BlockImportDialogMorph;BlockImportDialogMorph.uber=DialogBoxMorph.prototype;BlockImportDialogMorph.prototype.key="blockImport";function BlockImportDialogMorph(a,b,c){this.init(a,b,c)}
BlockImportDialogMorph.prototype.init=function(a,b,c){var d=this;this.blocks=a.slice(0);this.handle=null;BlockExportDialogMorph.uber.init.call(this,b,function(){return d.importBlocks(c)},null);this.labelString=localize("Import blocks")+(c?": ":"")+c||"";this.createLabel();this.buildContents()};BlockImportDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents;BlockImportDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp;
BlockImportDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu;BlockImportDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll;BlockImportDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone;BlockImportDialogMorph.prototype.importBlocks=function(a){(a=this.target.parentThatIsA(IDE_Morph))&&(0<this.blocks.length?a.importCustomBlocks(this.blocks):(new DialogBoxMorph).inform("Import blocks","no blocks were selected",this.world()))};
BlockImportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;BlockRemovalDialogMorph.prototype=new DialogBoxMorph;BlockRemovalDialogMorph.prototype.constructor=BlockImportDialogMorph;BlockRemovalDialogMorph.uber=DialogBoxMorph.prototype;BlockRemovalDialogMorph.prototype.key="blockRemove";function BlockRemovalDialogMorph(a,b){this.init(a,b)}
BlockRemovalDialogMorph.prototype.init=function(a,b){var c=this;this.blocks=a.slice(0);this.handle=null;BlockExportDialogMorph.uber.init.call(this,b,function(){return c.removeBlocks()},null);this.labelString=localize("Remove unused blocks")+(name?": ":"")+name||"";this.createLabel();this.buildContents()};BlockRemovalDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents;BlockRemovalDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp;
BlockRemovalDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu;BlockRemovalDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll;BlockRemovalDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone;
BlockRemovalDialogMorph.prototype.removeBlocks=function(){var a=this,b;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){if(1==c.nextAddress)return b=a.target.parentThatIsA(IDE_Morph),b?0<a.blocks.length?c.yield(SnapActions.deleteCustomBlocks(a.blocks),3):((new DialogBoxMorph).inform("Remove unused blocks","no blocks were selected",a.world()),c.jumpTo(0)):c.return();b.flushPaletteCache();b.refreshPalette();b.showMessage(a.blocks.length+" "+localize("unused block(s) removed"),2);c.jumpToEnd()})};
BlockRemovalDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;modules.tables="2020-May-18";function Table(a,b){this.colCount=+a;this.rowCount=+b;this.colNames=[];this.rowNames=[];this.contents=Array(+b);for(var c=0;c<b;c+=1)this.contents[c]=Array(+a);this.lastChanged=Date.now()}Table.prototype.demo=function(a){this.fillWithTestData();(new TableDialogMorph(this)).popUp(a)};Table.prototype.changed=function(){this.lastChanged=Date.now()};
Table.prototype.get=function(a,b){return a?b?a>this.colCount||b>this.rowCount?null:(this.contents[b-1]||[])[a-1]:this.colName(a):b?this.rowName(b):[this.rowCount]};Table.prototype.row=function(a){return this.contents[a-1]};Table.prototype.col=function(a){var b=[];--a;var c;for(c=0;c<this.rowCount;c+=1)b.push(this.contents[c][a]);return b};
Table.prototype.colName=function(a){if(a>this.colCount)return null;var b=this.colNames[a-1];return void 0!==b?b:String.fromCharCode(64+(a%26||26)).repeat(Math.floor((a-1)/26)+1)};Table.prototype.rowName=function(a){return a>this.rowCount?null:this.rowNames[a-1]||a};Table.prototype.rows=function(){return this.rowCount};Table.prototype.cols=function(){return this.colCount};Table.prototype.columnNames=function(){return this.colNames};Table.prototype.set=function(a,b,c){this.contents[c-1][b-1]=a;this.changed()};
Table.prototype.setRows=function(a,b,c){this.contents=a;b&&(this.colNames=b);c&&(this.rowNames=c);this.changed()};Table.prototype.setCols=function(a,b,c){var d,e;for(e=0;e<this.colCount;e+=1)for(d=0;d<this.rowCount;d+=1)this.contents[d][e]=a[e][d];b&&(this.colNames=b);c&&(this.rowNames=c);this.changed()};Table.prototype.setColNames=function(a){this.colNames=a||[];this.changed()};Table.prototype.setRowNames=function(a){this.rowNames=a||[];this.changed()};
Table.prototype.setColName=function(a,b){this.colNames[a+1]=b;this.changed()};Table.prototype.setRowName=function(a,b){this.rowNames[a+1]=b;this.changed()};Table.prototype.addRow=function(a,b){this.contents[this.rowCount]=a?a:Array(this.rowCount);this.rowNames[this.rowCount]=b;this.rowCount+=1;this.changed()};Table.prototype.addCol=function(a,b){var c;if(a)for(c=0;c<this.col;c+=1)this.contents[c][this.colCount]=a[c];this.colNames[this.colCount]=b;this.colCount+=1;this.changed()};
Table.prototype.toList=function(){return new List(this.contents.map(function(a){return new List(a)}))};Table.prototype.fillWithTestData=function(){var a,b;for(a=1;a<=this.colCount;a+=1)for(b=1;b<=this.rowCount;b+=1)this.set(this.colName(a)+this.rowName(b),a,b)};TableCellMorph.prototype=new Morph;TableCellMorph.prototype.constructor=TableCellMorph;TableCellMorph.uber=Morph.prototype;TableCellMorph.prototype.cachedListSymbol=null;
TableCellMorph.prototype.listSymbol=function(){this.cachedListSymbol&&this.cachedListSymbol.height()===SyntaxElementMorph.prototype.fontSize||(this.cachedListSymbol=new SymbolMorph("list",SyntaxElementMorph.prototype.fontSize,SpriteMorph.prototype.blockColor.lists.darker(50)));return this.cachedListSymbol.getImage()};function TableCellMorph(a,b,c){this.init(a,b,c)}
TableCellMorph.prototype.init=function(a,b,c){this.data=a;this.isLabel=c||!1;this.labelString=null;TableCellMorph.uber.init.call(this,!0);b&&this.bounds.setExtent(b);this.fixLayout()};TableCellMorph.prototype.setData=function(a,b){this.data=a;b&&!b.eq(this.extent())&&this.bounds.setExtent(b);this.rerender()};TableCellMorph.prototype.getData=function(){return this.data instanceof Array?this.data[0]:this.data};
TableCellMorph.prototype.render=function(a){var b=this.labelString||this.dataRepresentation(this.data),c=SyntaxElementMorph.prototype.fontSize,d=TableMorph.prototype.highContrast?"rgb(220, 220, 220)":"transparent",e=(this.isLabel?this.data instanceof Array?"italic":"":this.shouldBeList()?"bold":"")+" "+c+"px Helvetica, Arial, sans-serif",f=this.labelString?"rgb(220, 220, 250)":this.isLabel?d:this.shouldBeList()?"rgb(217, 77, 17)":this.isOvershooting()?"white":isNil(this.data)?d:"white",g=!this.isLabel&&
this.shouldBeList()?"white":"black",h=this.width();d=this.height();a.fillStyle=f;this.shouldBeList()?(BoxMorph.prototype.outlinePath.call(this,a,SyntaxElementMorph.prototype.corner+1,0),a.fill()):this.isOvershooting()?(this.raggedBoxPath(a),a.fill()):a.fillRect(0,0,h,d);b&&(b instanceof HTMLCanvasElement?(g=Math.max((h-b.width)/2,0),d=Math.max((d-b.height)/2,0),a.shadowOffsetX=4,a.shadowOffsetY=4,a.shadowBlur=4,a.shadowColor="lightgray",a.drawImage(b,g,d)):(a.font=e,a.textAlign="left",a.textBaseline=
"bottom",e=a.measureText(b).width,c=fontHeight(c),a.fillStyle=g,g=Math.max((h-e)/2,0),d=Math.max((d-c)/2,0),a.fillText(b,g,c+d)))};
TableCellMorph.prototype.dataRepresentation=function(a){return a instanceof Morph?isSnapObject(a)?a.thumbnail(new Point(40,40)):a.fullImage():isString(a)?100<a.length?a.slice(0,100)+"...":a:"number"===typeof a?a.toString():"boolean"===typeof a?SpriteMorph.prototype.booleanMorph.call(null,a).fullImage():a instanceof Array?this.dataRepresentation(a[0]):a instanceof Variable?this.dataRepresentation(a.value):a instanceof HTMLCanvasElement?a:a instanceof Context?a.image():a instanceof Costume?a.thumbnail(new Point(40,
40)):a instanceof Sound?(new SymbolMorph("notes",SyntaxElementMorph.prototype.fontSize)).getImage():a instanceof List?this.listSymbol():a?a.toString():0===a?"0":null};TableCellMorph.prototype.raggedBoxPath=function(a){var b=this.width(),c=this.height(),d=.75*b,e=c/6,f;a.beginPath();a.moveTo(0,0);a.lineTo(b,0);for(f=0;f<c;f+=2*e)a.lineTo(d,f+e),a.lineTo(b,f+2*e);a.lineTo(b,c);a.lineTo(0,c);a.closePath()};TableCellMorph.prototype.shouldBeList=function(){return this.data instanceof Array};
TableCellMorph.prototype.isOvershooting=function(){return this.data instanceof Variable};TableCellMorph.prototype.mouseDoubleClick=function(a){this.data instanceof Table||this.data instanceof List?(new TableDialogMorph(this.data)).popUp(this.world()):this.data instanceof Array&&this.data[0]instanceof List?(new TableDialogMorph(this.data[0])).popUp(this.world()):this.escalateEvent("mouseDoubleClick",a)};
TableCellMorph.prototype.mouseEnter=function(){if(this.isLabel){var a=this.parentThatIsA(TableMorph);var b=a.world().hand.left()-a.left();a=a.columnAt(b);0<a&&(this.labelString=a,this.rerender())}};TableCellMorph.prototype.mouseLeave=function(){this.isLabel&&(this.labelString=null,this.rerender())};TableMorph.prototype=new FrameMorph;TableMorph.prototype.constructor=TableMorph;TableMorph.uber=FrameMorph.prototype;TableMorph.prototype.highContrast=!1;
function TableMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}
TableMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l){this.table=a;this.scrollBarSize=b||MorphicPreferences.scrollBarSize;this.startRow=d||1;this.startCol=e||1;this.textHeight=Math.ceil(1.3*fontHeight(SyntaxElementMorph.prototype.fontSize));this.rowHeight=h||this.textHeight;this.colWidths=g||[];this.globalColWidth=f||Math.ceil(3.5*this.textHeight);this.colLabelHeight=k||this.textHeight;this.padding=l||SyntaxElementMorph.prototype.scale;this.tableVersion=this.table.lastChanged;this.vBar=this.hBar=
null;this.rowLabelWidth=0;this.columns=[];this.rows=0;this.resizeRow=this.resizeCol=this.resizeAnchor=this.dragAnchor=this.maxStartCol=this.maxStartRow=null;this.wantsUpdate=!1;Morph.prototype.init.call(this,!0);c&&this.bounds.setExtent(c);this.initScrollBars();this.fixLayout()};
TableMorph.prototype.initScrollBars=function(){var a=this;this.hBar=new SliderMorph(1,null,null,null,"horizontal");this.hBar.setHeight(this.scrollBarSize);this.hBar.action=function(b){a.showData(b,null,!0)};this.hBar.isDraggable=!1;this.add(this.hBar);this.vBar=new SliderMorph(1,null,null,null,"vertical");this.vBar.setWidth(this.scrollBarSize);this.vBar.action=function(b){a.showData(null,b,!0)};this.vBar.isDraggable=!1;this.add(this.vBar)};
TableMorph.prototype.updateScrollBars=function(){1===this.maxStartCol?this.hBar.hide():(this.hBar.show(),this.hBar.stop=this.maxStartCol,this.hBar.value=this.startCol,this.hBar.size=Math.max(this.hBar.rangeSize()*this.columns.length/this.table.cols(),this.hBar.rangeSize()/10),this.hBar.fixLayout());this.vBar.stop=this.maxStartRow;this.vBar.value=this.startRow;1===this.maxStartRow?this.vBar.hide():(this.vBar.show(),this.vBar.size=Math.max(this.vBar.rangeSize()*this.rows/this.table.rows(),this.vBar.rangeSize()/
10),this.vBar.fixLayout())};TableMorph.prototype.fixLayout=function(){TableMorph.uber.fixLayout.call(this);this.rowLabelWidth=this.rowLabelsWidth();this.columns=this.columnsLayout();this.rows=this.visibleRows();this.buildCells();this.hBar.setWidth(this.width()-this.vBar.width());this.hBar.setLeft(this.left());this.hBar.setBottom(this.bottom());this.vBar.setHeight(this.height()-this.hBar.height());this.vBar.setRight(this.right());this.vBar.setTop(this.top())};
TableMorph.prototype.render=function(a){var b;a.fillStyle="rgb(220, 220, 220)";BoxMorph.prototype.outlinePath.call(this,a,SyntaxElementMorph.prototype.corner+1,0);a.fill();if(this.highContrast&&1<this.table.cols()){var c=this.padding;for(b=this.startCol;b<=this.table.cols();b+=1)c+=this.colWidth(b)+this.padding;a.fillStyle="darkGray";a.fillRect(this.padding+this.rowLabelWidth,this.padding+this.colLabelHeight,c,(this.rowHeight+this.padding)*(this.table.rows()+1-this.startRow)+this.padding)}};
TableMorph.prototype.buildCells=function(){var a,b,c=this.position();this.children=[];for(b=0;b<=this.columns.length;b+=1)for(a=0;a<=this.rows;a+=1){var d=new TableCellMorph(this.table.get(b?b+this.startCol-1:b,a?a+this.startRow-1:a),new Point(b?this.colWidth(b+this.startCol-1):this.rowLabelWidth,a?this.rowHeight:this.colLabelHeight),!(a&&b),!1);d.setPosition((new Point(b?this.columns[b-1]:this.padding,a?2*this.padding+this.colLabelHeight+(a-1)*(this.rowHeight+this.padding):this.padding)).add(c));
this.add(d);isSnapObject(d.getData())&&(this.wantsUpdate=!0)}this.add(this.hBar);this.add(this.vBar);this.updateScrollBars()};TableMorph.prototype.drawData=function(a){var b=0,c,d;for(d=0;d<=this.columns.length;d+=1)for(c=0;c<=this.rows;c+=1){var e=this.children[b];b+=1;e.setData(this.table.get(d?d+this.startCol-1:d,c?c+this.startRow-1:c));isSnapObject(e.getData())&&(this.wantsUpdate=!0)}a||this.updateScrollBars();this.changed()};
TableMorph.prototype.scroll=function(a,b){this.showData(Math.min(this.maxStartCol,Math.max(1,this.startCol+Math.round(a))),Math.min(this.maxStartRow,Math.max(1,this.startRow+Math.round(b))));this.updateScrollBars()};
TableMorph.prototype.showData=function(a,b,c){a=a||this.startCol;b=b||this.startRow;a===this.startCol?b!==this.startRow&&(this.startRow=b,this.rows=this.visibleRows(),this.drawData(c)):(this.startCol=a,this.startRow=b,this.rows=this.visibleRows(),this.colWidths.length?(this.columns=this.columnsLayout(),this.buildCells()):this.drawData(c))};
TableMorph.prototype.step=function(){this.dragAnchor?this.shiftCells(this.world().hand.position()):this.resizeAnchor&&this.resizeCells(this.world().hand.position());this.update()};
TableMorph.prototype.update=function(){var a=this.table instanceof List?this.table.version(this.startRow,this.rows,this.startCol,this.columns.length):this.table.lastChanged;if(this.tableVersion!==a||this.wantsUpdate){this.wantsUpdate=!1;if(this.table instanceof List){var b=this.columns.length;var c=this.rows;this.rowLabelWidth=this.rowLabelsWidth();this.columns=this.columnsLayout();this.rows=this.visibleRows();this.columns.length!==b||this.rows!==c?this.buildCells():this.drawData()}else this.drawData();
this.tableVersion=a}};TableMorph.prototype.rowLabelsWidth=function(){var a=StringMorph.prototype.measureCtx;a.font="italic "+SyntaxElementMorph.prototype.fontSize+"px Helvetica, Arial, sans-serif";return Math.max(0,Math.max.apply(null,this.table.columnNames().map(function(b){return b?a.measureText(b).width:0})))||a.measureText(this.table.rows().toString()).width+6*SyntaxElementMorph.prototype.scale};
TableMorph.prototype.columnsLayout=function(){var a=[],b=2*this.padding+this.rowLabelWidth,c;var d=this.table.cols();for(c=b;c<this.width()&&0<d;)c+=this.colWidth(d),--d;0===d&&c<this.width()?this.maxStartCol=1:this.maxStartCol=Math.min(d+2,this.table.cols());for(d=this.startCol=Math.min(this.startCol,this.maxStartCol);b<this.width()&&d<this.table.cols()+this.startCol;)c=this.colWidth(d),a.push(b),b+=c,b+=this.padding,d+=1;return a};
TableMorph.prototype.colWidth=function(a){return this.colWidths[a-1]||this.globalColWidth};TableMorph.prototype.visibleRows=function(){var a=this.height()-this.colLabelHeight-this.padding;if(0>a)return 0;a=Math.ceil(a/(this.rowHeight+this.padding));this.maxStartRow=Math.max(1,this.table.rows()-a+2);this.startRow=Math.min(this.startRow,this.maxStartRow);return Math.min(this.table.rows(),a)};
TableMorph.prototype.globalExtent=function(){var a,b=this.rowLabelsWidth()+2,c=this.table.cols();for(a=0;a<c;a+=1)b+=this.colWidth(a+1),b+=this.padding;1===c&&(b+=this.scrollBarSize,b+=2*this.padding);return new Point(b+this.padding,this.colLabelHeight+2*this.padding+(this.rowHeight+this.padding)*this.table.rows())};TableMorph.prototype.mouseScroll=function(a,b){this.scroll(-(+b*MorphicPreferences.mouseScrollAmount/4),-(+a*MorphicPreferences.mouseScrollAmount))};
TableMorph.prototype.mouseDownLeft=function(a){var b=a.subtract(this.position());b.x<=this.rowLabelWidth||b.y<=this.colLabelHeight?(16===this.world().currentKey?this.resizeCol=0:this.resizeCol=this.columnAt(b.x),this.resizeRow=b.y>this.colLabelHeight,this.resizeAnchor=a):(this.resizeRow=null,this.dragAnchor=a)};TableMorph.prototype.mouseClickLeft=function(a){this.resizeRow=this.resizeAnchor=this.dragAnchor=null};
TableMorph.prototype.mouseLeaveDragging=function(a){this.resizeRow=this.resizeAnchor=this.dragAnchor=null};TableMorph.prototype.mouseDoubleClick=function(a){this.parentThatIsA(TableDialogMorph)?this.escalateEvent("mouseDoubleClick",a):(new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight)).popUp(this.world())};
TableMorph.prototype.shiftCells=function(a){var b=this.dragAnchor.subtract(a),c=Math.round(b.x/this.globalColWidth);b=Math.round(b.y/this.rowHeight);if(c||b)this.scroll(c,b),this.dragAnchor=a};
TableMorph.prototype.resizeCells=function(a){var b=a.subtract(this.resizeAnchor),c;if(this.resizeCol)this.colWidths[this.resizeCol-1]=Math.max(16,(this.colWidths[this.resizeCol-1]||this.globalColWidth)+b.x);else if(this.resizeRow)this.rowHeight=Math.max(16,this.rowHeight+b.y);else for(this.globalColWidth=Math.max(16,this.globalColWidth+b.x),c=0;c<this.colWidths.length;c+=1)this.colWidths[c]&&(this.colWidths[c]=Math.max(16,this.colWidths[c]+b.x));this.rowLabelWidth=this.rowLabelsWidth();this.columns=
this.columnsLayout();this.rows=this.visibleRows();this.buildCells();this.resizeAnchor=a;this.changed()};TableMorph.prototype.columnAt=function(a){var b=0;if(a<this.columns[0])return 0;for(;a>this.columns[b];)b+=1;return b+this.startCol-1};
TableMorph.prototype.userMenu=function(){var a=this,b=new MenuMorph(this);if(this.parentThatIsA(TableDialogMorph))return this.colWidths.length&&(b.addItem("reset columns","resetColumns"),b.addLine()),this.table instanceof List&&this.table.canBeJSON()&&b.addItem("blockify",function(){var c=a.world(),d=detect(c.children,function(e){return e instanceof IDE_Morph});a.table.blockify().pickUp(c);c.hand.grabOrigin={origin:d.palette,position:d.palette.center()}}),b.addItem("open in another dialog...","openInDialog"),
b;this.colWidths.length&&b.addItem("reset columns","resetColumns");b.addItem("list view...","showListView");this.table instanceof List&&this.table.canBeJSON()&&b.addItem("blockify",function(){var c=a.world(),d=detect(c.children,function(e){return e instanceof IDE_Morph});a.table.blockify().pickUp(c);c.hand.grabOrigin={origin:d.palette,position:d.palette.center()}});b.addLine();b.addItem("open in dialog...","openInDialog");return b};
TableMorph.prototype.resetColumns=function(){this.colWidths=[];this.rowLabelWidth=this.rowLabelsWidth();this.columns=this.columnsLayout();this.rows=this.visibleRows();this.buildCells();this.changed()};TableMorph.prototype.openInDialog=function(){(new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight)).popUp(this.world())};
TableMorph.prototype.showListView=function(){var a=this.parentThatIsA(SpriteBubbleMorph,SpeechBubbleMorph,CellMorph);a&&(a instanceof SpriteBubbleMorph?(a.changed(),a.contentsMorph.destroy(),a.contentsMorph=new ListWatcherMorph(this.table),a.contentsMorph.step=a.contents.update,a.contentsMorph.expand(this.extent()),a.parent.positionTalkBubble()):a instanceof SpeechBubbleMorph?(a.contents=new ListWatcherMorph(this.table),a.contents.step=a.contents.update,a.contents.expand(this.extent())):(a.changed(),
a.contentsMorph.destroy(),a.contentsMorph=new ListWatcherMorph(this.table),a.add(a.contentsMorph),a.contentsMorph.setPosition(this.position()),a.contentsMorph.expand(this.extent())),a.fixLayout(),a.rerender())};TableMorph.prototype.show=function(){TableMorph.uber.show.call(this);this.updateScrollBars()};TableFrameMorph.prototype=new Morph;TableFrameMorph.prototype.constructor=TableFrameMorph;TableFrameMorph.uber=Morph.prototype;function TableFrameMorph(a,b){this.init(a,b)}
TableFrameMorph.prototype.init=function(a,b){this.tableMorph=a;this.handle=null;TableFrameMorph.uber.init.call(this,!0);this.color="transparent";this.bounds=this.tableMorph.bounds.copy();this.add(this.tableMorph);b||(this.handle=new HandleMorph(this,80,25,null,null));this.fixLayout()};TableFrameMorph.prototype.fixLayout=function(){var a=this.extent();this.tableMorph.extent().eq(a)||(this.tableMorph.setExtent(this.extent()),this.parent&&(this.parent.changed(),this.parent.fixLayout(),this.parent.rerender()))};
TableFrameMorph.prototype.expand=function(a){var b=this.tableMorph.globalExtent();a&&(b=b.min(a));this.setExtent(b);this.handle.setRight(this.right());this.handle.setBottom(this.bottom())};TableDialogMorph.prototype=new DialogBoxMorph;TableDialogMorph.prototype.constructor=TableDialogMorph;TableDialogMorph.uber=DialogBoxMorph.prototype;function TableDialogMorph(a,b,c,d){this.init(a,b,c,d)}
TableDialogMorph.prototype.init=function(a,b,c,d){this.handle=null;this.data=a;this.tableView=null;TableDialogMorph.uber.init.call(this);this.labelString="Table view";this.createLabel();this.buildContents(a,b,c,d)};TableDialogMorph.prototype.buildContents=function(a,b,c,d){this.tableView=new TableMorph(a,null,null,null,null,b,c,d,null,null);this.addBody(new TableFrameMorph(this.tableView,!0));this.addButton("ok","OK")};
TableDialogMorph.prototype.setInitialDimensions=function(){var a=this.world().extent().subtract(new Point(this.padding,this.padding)),b=fontHeight(this.titleFontSize)+3*this.titlePadding,c=this.buttons.height();this.setExtent(this.tableView.globalExtent().add(new Point(2*this.padding,2*this.padding+b+c)).min(a).max(new Point(100,100)));this.setCenter(this.world().center())};
TableDialogMorph.prototype.popUp=function(a){a&&(TableDialogMorph.uber.popUp.call(this,a),this.setInitialDimensions(),this.handle=new HandleMorph(this,100,100,this.corner,this.corner))};TableDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;modules.xml="2020-April-27";function ReadStream(a){this.contents=a||"";this.index=0}ReadStream.prototype.nonSpace=/\S|$/g;ReadStream.prototype.nonWord=/[\s>\/=]|$/g;
ReadStream.prototype.next=function(a){if(void 0===a)return a=this.contents[this.index],this.index+=1,a;var b=this.index;this.index+=a;return this.contents.slice(b,this.index)};ReadStream.prototype.peek=function(){return this.contents[this.index]};ReadStream.prototype.skip=function(a){this.index+=a||1};ReadStream.prototype.atEnd=function(){return this.index>this.contents.length-1};
ReadStream.prototype.upTo=function(a){a=this.contents.indexOf(a,this.index);return-1===a?"":this.contents.slice(this.index,this.index=a)};ReadStream.prototype.peekUpTo=function(a){a=this.contents.indexOf(a,this.index);return-1===a?"":this.contents.slice(this.index,a)};ReadStream.prototype.skipSpace=function(){this.nonSpace.lastIndex=this.index;var a=this.nonSpace.exec(this.contents);a&&(this.index=a.index)};
ReadStream.prototype.word=function(){this.nonWord.lastIndex=this.index;var a=this.nonWord.exec(this.contents);return a?this.contents.slice(this.index,this.index=a.index):""};XML_Element.prototype=Object.create(Node.prototype);XML_Element.prototype.constructor=XML_Element;XML_Element.uber=Node.prototype;XML_Element.prototype.indentation="  ";function XML_Element(a,b,c){this.init(a,b,c)}
XML_Element.prototype.init=function(a,b,c){this.tag=a||"unnamed";this.attributes={};this.contents=b||"";XML_Element.uber.init.call(this);c&&c.addChild(this)};XML_Element.prototype.require=function(a,b){var c=this.childNamed(a);if(!c){if(b instanceof Function)return b();if(!isNil(b))return b;throw Error("Missing required element <"+a+">!");}return c};XML_Element.prototype.childNamed=function(a){return detect(this.children,function(b){return b.tag===a})};
XML_Element.prototype.childrenNamed=function(a){return this.children.filter(function(b){return b.tag===a})};XML_Element.prototype.parentNamed=function(a){return this.tag===a?this:this.parent?this.parent.parentNamed(a):null};
XML_Element.prototype.toString=function(a,b){var c="",d="",e=b||0,f;if(a){for(b=0;b<e;b+=1)d+=this.indentation;c+=d}if("CDATA"===this.tag)return c+="<![CDATA["+this.contents+"]]\x3e";c+="<"+this.tag;for(f in this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,f)&&this.attributes[f]&&(c+=" "+f+'="'+this.escape(this.attributes[f])+'"');this.contents.length||this.children.length?(c+=">",c+=this.escape(this.contents),this.children.forEach(function(g){a&&(c+="\n");c+=g.toString(a,e+1)}),
a&&this.children.length&&(c+="\n"+d),c+="</"+this.tag+">"):c+="/>";return c};XML_Element.prototype.escape=function(a,b){a=isNil(a)?"":a.toString();var c="",d;for(d=0;d<a.length;d+=1){var e=a[d];switch(e){case "'":c+="&apos;";break;case '"':c+=b?e:"&quot;";break;case "<":c+="&lt;";break;case ">":c+="&gt;";break;case "&":c+="&amp;";break;case "\n":c+="&#xD;";break;case "~":c+="&#126;";break;default:c+=e}}return c};
XML_Element.prototype.unescape=function(a){return a.replace(/&(amp|apos|quot|lt|gt|#xD|#126);/g,function(b,c){switch(c){case "amp":return"&";case "apos":return"'";case "quot":return'"';case "lt":return"<";case "gt":return">";case "#xD":return"\n";case "#126":return"~";default:console.warn("unreachable")}})};XML_Element.prototype.parseString=function(a){a=new ReadStream(a);a.upTo("<");a.skip();this.parseStream(a)};
XML_Element.prototype.parseStream=function(a){var b;this.tag=a.word();if(0===this.tag.indexOf("![CDATA["))this.contents=this.tag.slice(8)+a.upTo("]]\x3e"),this.tag="CDATA",a.skip(3);else{a.skipSpace();for(b=a.peek();">"!==b&&"/"!==b;){var c=a.word();a.skipSpace();if("="!==a.next())throw Error('Expected "=" after attribute name');a.skipSpace();b=a.next();if('"'!==b&&"'"!==b)throw Error("Expected single- or double-quoted attribute value");b=a.upTo(b);a.skip(1);a.skipSpace();this.attributes[c]=this.unescape(b);
b=a.peek()}if("/"===b){if(a.skip(),">"!==a.next())throw Error('Expected ">" after "/" in empty tag');}else{if(">"!==a.next())throw Error('Expected ">" after tag name and attributes');for(;!a.atEnd();)if(b=a.next(),"<"===b){if("/"===a.peek()){a.skip();if(a.word()!==this.tag)throw Error("Expected to close "+this.tag);a.upTo(">");a.skip();this.contents=this.unescape(this.contents);break}c=new XML_Element(null,null,this);c.parseStream(a)}else this.contents+=b}}};modules.store="2020-July-08";
function XML_Serializer(){this.instanceCount+=1;this.contents=[];this.media=[];this.isCollectingMedia=!1;this.dependencies=null;this.isExportingBlocksLibrary=!1;this.idProperty="serializationID_"+this.instanceCount;this.mediaIdProperty="serializationMediaID_"+this.instanceCount}XML_Serializer.prototype.instanceCount=0;XML_Serializer.prototype.idProperty="serializationID";XML_Serializer.prototype.mediaIdProperty="serializationMediaID";XML_Serializer.prototype.mediaDetectionProperty="isMedia";
XML_Serializer.prototype.version=1;XML_Serializer.prototype.serialize=function(a,b){this.flush();this.flushMedia();this.isExportingBlocksLibrary=b;a=this.store(a);this.flush();return a};
XML_Serializer.prototype.store=function(a,b){if(isNil(a)||!a.toXML)return"";if(this.isCollectingMedia&&a[this.mediaDetectionProperty])return this.addMedia(a,b),this.format('<ref mediaID="@"></ref>',a[this.mediaIdProperty]);if(a[this.idProperty])return this.format('<ref id="@"></ref>',a[this.idProperty]);this.add(a);return this.isSavingPortable&&a.toPortableXML?a.toPortableXML(this,b).replace("~",this.format('id="@"',a[this.idProperty])):a.toXML(this,b).replace("~",this.format('id="@"',a[this.idProperty]))};
XML_Serializer.prototype.mediaXML=function(){var a=this,b="<media>";this.media.forEach(function(c){c=c.toXML(a).replace("~",a.format('mediaID="@"',c[a.mediaIdProperty]));b+=c});return b+"</media>"};XML_Serializer.prototype.undoQueueXML=function(a){return this.format('<undo-queue id="@" undo-count="@">%</undo-queue>',a,SnapUndo.undoCount[a],this.undoEventsXML(SnapUndo.eventHistory[a]||[]))};
XML_Serializer.prototype.undoEventsXML=function(a,b){for(var c=[],d,e,f=a.length;f--;){d=a[f];e=[];for(var g=d.args.length;g--;)e.unshift(this.getArgumentXML("arg",d.args[g]));e=e.join("");d=b?this.format('<event id="@" type="@" replayType="@" time="@" user="@" username="@" isUserAction="@">%</event>',d.id,d.type,d.replayType||0,d.time,d.user,d.username||"",d.isUserAction||!1,e):this.format('<event id="@"/>',d.id);c.unshift(d)}return c.join("")};
XML_Serializer.prototype.getArgumentXML=function(a,b){var c=this,d=b;b instanceof Object?d=Object.keys(b).map(function(e){return b[e]instanceof Array?b[e].map(function(f){return c.getArgumentXML("_"+e,f)}).join(""):/^[^a-zA-Z].*/.test(e)?c.getArgumentXML("_"+e,b[e]):c.getArgumentXML(e,b[e])}).join(""):"string"===typeof b&&-1<b.indexOf("<")&&(d=b.replace(/</g,"&lt;"));return["<",a,">",d,"</",a,">"].join("")};
XML_Serializer.prototype.loadEventArg=function(a){var b=-1;if(a.children.length){if("CDATA"===a.children[0].tag)return a.children[0].contents.replace(/&ncdata;]>/g,"]]\x3e");var c={};var d=!0;for(var e=a.children.length;e--;){var f=a.children[e];var g="_"===f.tag[0]?f.tag.slice(1):f.tag;isNaN(+g)&&(d=!1);c[g]instanceof Array?c[g].unshift(this.loadEventArg(f)):c[g]=c[g]?[this.loadEventArg(f),c[g]]:this.loadEventArg(f);d&&(b=Math.max(b,+g))}d&&(c.length=b+1,c=Array.prototype.slice.call(c));return c}return a.contents};
XML_Serializer.prototype.historyXML=function(a){var b=this,c=a&&a+"/";return SnapUndo.allQueueIds().filter(function(d){return c?0===d.indexOf(c):-1===d.indexOf("/")}).map(function(d){return b.undoQueueXML(d)}).join("")};XML_Serializer.prototype.replayHistory=function(){return this.undoEventsXML(SnapUndo.allEvents,!0)};XML_Serializer.prototype.add=function(a){if(a[this.idProperty])return-1;this.contents.push(a);return a[this.idProperty]=this.contents.length};
XML_Serializer.prototype.addMedia=function(a,b){if(a[this.mediaIdProperty])return-1;this.media.push(a);a[this.mediaIdProperty]=b?b+"_"+a.name:this.media.length;return this.media.length};XML_Serializer.prototype.at=function(a){return this.contents[a-1]};XML_Serializer.prototype.flush=function(){var a=this;this.contents.forEach(function(b){return delete b[a.idProperty]});this.contents=[];this.dependencies=null};
XML_Serializer.prototype.flushMedia=function(){var a=this;this.media instanceof Array&&this.media.forEach(function(b){return delete b[a.mediaIdProperty]});this.media=[];this.isExportingBlocksLibrary=!1};XML_Serializer.prototype.escape=XML_Element.prototype.escape;XML_Serializer.prototype.unescape=XML_Element.prototype.unescape;
XML_Serializer.prototype.format=function(a){var b=this,c=-1,d=arguments,e;return a.replace(/[@$%]([\d]+)?/g,function(f,g){g=parseInt(g,10);isNaN(g)?(c+=1,e=d[c+1]):e=d[g+1];return"@"===f?b.escape(e):"$"===f?b.escape(e,!0):e})};XML_Serializer.prototype.load=function(a){nop(a);throw Error("loading should be implemented in heir of XML_Serializer");};XML_Serializer.prototype.parse=function(a){var b=new XML_Element;b.parseString(a);return b};SnapSerializer.prototype=new XML_Serializer;
SnapSerializer.prototype.constructor=SnapSerializer;SnapSerializer.uber=XML_Serializer.prototype;SnapSerializer.prototype.app="Snap! 6, https://snap.berkeley.edu";SnapSerializer.prototype.thumbnailSize=new Point(640,480);SnapSerializer.prototype.isSavingHistory=!1;
SnapSerializer.prototype.watcherLabels={reportRPCError:"error",xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",reportShown:"shown?",getTempo:"tempo",getVolume:"volume",getPan:"balance",getPenDown:"pen down?",getLastAnswer:"answer",getLastMessage:"message",getTimer:"timer",getCostumeIdx:"costume #",reportMouseX:"mouse x",reportMouseY:"mouse y",reportThreadCount:"processes"};function SnapSerializer(){this.init()}
SnapSerializer.prototype.init=function(){this.project={};this.objects={};this.mediaDict={};this.isSavingCustomBlockOwners=!0};XML_Serializer.prototype.mediaXML=function(a){var b=this,c='<media name="'+(a||"untitled")+'" app="'+this.app+'" version="'+this.version+'">';this.media.forEach(function(d){d=d.toXML(b).replace("~",b.format('mediaID="@"',d[b.mediaIdProperty]));c+=d});return c+"</media>"};SnapSerializer.prototype.load=function(a,b){return this.loadProjectModel(this.parse(a),b)};
SnapSerializer.prototype.getPortableXML=function(a){var b=this.isSavingPortable,c=this.isSavingHistory;this.isSavingPortable=!0;this.isSavingHistory=!1;a.getPortableDependencies&&(this.dependencies=a.getPortableDependencies());a=this.store(a);this.isSavingPortable=b;this.isSavingHistory=c;this.dependencies=null;return a};
SnapSerializer.prototype.loadProjectModel=function(a,b,c){var d=a.attributes.app;d=d?d.split(" ")[0]:null;b&&d&&d!==this.app.split(" ")[0]&&b.inform(d+" Project","This project has been created by a different app:\n\n"+d+"\n\nand may be incompatible or fail to load here.");a=this.rawLoadProjectModel(a,c);this.objects={};return a};
SnapSerializer.prototype.rawLoadProjectModel=function(a,b){var c,d,e=this,f={sprites:{},undo:{allEvents:[],eventHistory:{},undoCount:{}}};this.project=f;var g=d=d=d=d=d=d=g=c=c=void 0;if(+a.attributes.version>this.version)throw"Project uses newer version of Serializer";this.objects={};f.name=a.attributes.name;if(!f.name){for(c=1;Object.prototype.hasOwnProperty.call(localStorage,"-snap-project-Untitled "+c);)c+=1;f.name="Untitled "+c}if(c=a.childNamed("notes"))f.notes=c.contents;c=a.childNamed("variables");
f.globalVariables=new VariableFrame;f.collabStartIndex=+(a.attributes.collabStartIndex||0);f.undo.allEvents=this.loadReplayHistory(a.childNamed("replay"));g=a.require("stage");StageMorph.prototype.frameRate=0;f.stage=new StageMorph(f.globalVariables);f.stage.remixID=b;Object.prototype.hasOwnProperty.call(g.attributes,"id")&&(this.objects[g.attributes.id]=f.stage);g.attributes.name&&(f.stage.name=g.attributes.name);g.attributes.color&&(f.stage.color=this.loadColor(g.attributes.color),f.stage.cachedHSV=
f.stage.color.hsv());"true"===g.attributes.scheduled&&(f.stage.fps=30,StageMorph.prototype.frameRate=30);g.attributes.volume&&(f.stage.volume=+g.attributes.volume);g.attributes.pan&&(f.stage.pan=+g.attributes.pan);g.attributes.penlog&&(StageMorph.prototype.enablePenLogging="true"===g.attributes.penlog);if(d=g.childNamed("pentrails"))f.pentrails=new Image,f.pentrails.onload=function(){f.stage.trailsCanvas&&(normalizeCanvas(f.stage.trailsCanvas),f.stage.trailsCanvas.getContext("2d").drawImage(f.pentrails,
0,0),f.stage.changed())},f.pentrails.src=d.contents;f.stage.setTempo(g.attributes.tempo);StageMorph.prototype.dimensions=new Point(480,360);g.attributes.width&&(StageMorph.prototype.dimensions.x=Math.max(+g.attributes.width,240));g.attributes.height&&(StageMorph.prototype.dimensions.y=Math.max(+g.attributes.height,180));f.stage.id=g.attributes.collabId||null;f.stage.setExtent(StageMorph.prototype.dimensions);SpriteMorph.prototype.useFlatLineEnds="flat"===g.attributes.lines;BooleanSlotMorph.prototype.isTernary=
"false"!==g.attributes.ternary;Process.prototype.enableHyperOps="false"!==g.attributes.hyperops;f.stage.isThreadSafe="true"===g.attributes.threadsafe;StageMorph.prototype.enableCodeMapping="true"===g.attributes.codify;StageMorph.prototype.enableInheritance="false"!==g.attributes.inheritance;StageMorph.prototype.enableSublistIDs="true"===g.attributes.sublistIDs;(d=a.childNamed("hidden"))&&d.contents.split(" ").forEach(function(h){h&&(StageMorph.prototype.hiddenPrimitives[h]=!0)});(d=a.childNamed("headers"))&&
d.children.forEach(function(h){return StageMorph.prototype.codeHeaders[h.tag]=h.contents});(d=a.childNamed("code"))&&d.children.forEach(function(h){return StageMorph.prototype.codeMappings[h.tag]=h.contents});(d=g.childNamed("messageTypes"))&&d.children.forEach(this.loadMessageType.bind(this,f.stage));if(d=a.childNamed("blocks"))this.loadCustomBlocks(f.stage,d,!0),this.populateCustomBlocks(f.stage,d,!0);this.loadObject(f.stage,g);this.loadHistory(a.childNamed("history"));g=g.require("sprites");f.sprites[f.stage.name]=
f.stage;g.childrenNamed("sprite").forEach(function(h){return e.loadValue(h)});this.project.stage.children.forEach(function(h){var k;h.inheritanceInfo&&((k=e.project.sprites[h.inheritanceInfo.exemplar])&&h.setExemplar(k),h.inheritedAttributes=h.inheritanceInfo.delegated||[],h.updatePropagationCache());h.nestingInfo&&((k=e.project.sprites[h.nestingInfo.anchor])&&k.attachPart(h),h.rotatesWithAnchor="true"===h.nestingInfo.synch)});this.project.stage.children.forEach(function(h){var k;h.nestingInfo&&(h.nestingScale=
+(h.nestingInfo.scale||h.scale),delete h.nestingInfo);["scripts","costumes","sounds"].forEach(function(l){h.inheritsAttribute(l)&&h.refreshInheritedAttribute(l)});h.inheritsAttribute("costumes")&&(k=h.inheritsAttribute("costume #")?h.exemplar.costume:h.costumes.asArray()[h.inheritanceInfo.costumeNumber-1])&&(k.loaded?h.wearCostume(k,!0):k.loaded=function(){this.loaded=!0;h.wearCostume(k,!0)});delete h.inheritanceInfo});c&&this.loadVariables(f.globalVariables,c);g.childrenNamed("watcher").forEach(function(h){var k=
e.loadColor(h.attributes.color);var l=Object.prototype.hasOwnProperty.call(h.attributes,"scope")?f.sprites[h.attributes.scope]:null;var m=Object.prototype.hasOwnProperty.call(h.attributes,"hidden")&&"false"!==h.attributes.hidden;k=Object.prototype.hasOwnProperty.call(h.attributes,"var")?new WatcherMorph(h.attributes["var"],k,isNil(l)?f.globalVariables:l.variables,h.attributes["var"],m):new WatcherMorph(localize(e.watcherLabels[h.attributes.s]),k,l,h.attributes.s,m);k.setStyle(h.attributes.style||
"normal");"slider"===k.style&&(k.setSliderMin(h.attributes.min||"1",!0),k.setSliderMax(h.attributes.max||"100",!0));k.setPosition(f.stage.topLeft().add(new Point(+h.attributes.x||0,+h.attributes.y||0)));f.stage.add(k);k.onNextStep=function(){this.currentValue=null};k.currentValue instanceof List&&k.cellMorph.contentsMorph&&((l=h.attributes.extX)&&k.cellMorph.contentsMorph.setWidth(+l),(h=h.attributes.extY)&&k.cellMorph.contentsMorph.setHeight(+h),k.cellMorph.contentsMorph.handle.fixLayout())});this.project.stage.children.forEach(function(h){return h.inheritedMethodsCache=
[]});this.objects={};return f};SnapSerializer.prototype.loadReplayHistory=function(a){a=a?a.children:[];for(var b=[],c,d=a.length;d--;)c=this.parseEvent(null,a[d],!0),b.unshift(c);return b};
SnapSerializer.prototype.loadHistory=function(a){a=a?a.children:[];for(var b,c=this.project.undo,d,e,f,g=a.length;g--;){e=a[g].attributes.id;f=c.allEvents.length-1;c.undoCount[e]=+a[g].attributes["undo-count"]||0;c.eventHistory[e]=[];b=a[g].children;for(var h=b.length;h--;){for(d=+b[h].attributes.id;0<=f&&c.allEvents[f].id!==d;)f--;0<=f?(d=c.allEvents[f],d.owner=e,c.eventHistory[e].unshift(d)):console.error("Could not load historical event from replay:",b[h])}}};
SnapSerializer.prototype.parseEvent=function(a,b){for(var c=[],d=b.children.length;d--;)c.unshift(this.loadEventArg(b.children[d]));return{id:+b.attributes.id,owner:a,type:b.attributes.type,replayType:+b.attributes.replayType,time:+b.attributes.time,user:b.attributes.user,username:b.attributes.username||void 0,isUserAction:"true"===b.attributes.isUserAction,args:c}};
SnapSerializer.prototype.loadBlocks=function(a,b){var c=new StageMorph;this.project={stage:c,sprites:{},targetStage:b};a=this.parse(a);if(+a.attributes.version>this.version)throw"Module uses newer version of Serializer";this.loadCustomBlocks(c,a,!0);this.populateCustomBlocks(c,a,!0);this.objects={};c.globalBlocks.forEach(function(d){return d.receiver=null});this.objects={};this.project={};this.mediaDict={};return c.globalBlocks};
SnapSerializer.prototype.loadSprites=function(a,b){var c=this;var d=this.project={globalVariables:b.globalVariables,stage:b.stage,sprites:{}};d.sprites[d.stage.name]=d.stage;a=this.parse(a);if(+a.attributes.version>this.version)throw"Module uses newer version of Serializer";a.childrenNamed("sprite").forEach(function(e){var f=new SpriteMorph(d.globalVariables);e.attributes.id&&(c.objects[e.attributes.id]=f);e.attributes.name&&(f.name=b.newSpriteName(e.attributes.name),d.sprites[f.name]=f);e.attributes.color&&
(f.color=c.loadColor(e.attributes.color),f.cachedHSV=f.color.hsv());e.attributes.pen&&(f.penPoint=e.attributes.pen);e.attributes.collabId&&(f.id=e.attributes.collabId);e.attributes.volume&&(f.volume=+e.attributes.volume);e.attributes.pan&&(f.pan=+e.attributes.pan);d.stage.add(f);b.sprites.add(f);f.scale=parseFloat(e.attributes.scale||"1");f.rotationStyle=parseFloat(e.attributes.rotation||"1");f.isDraggable="false"!==e.attributes.draggable;f.isVisible="true"!==e.attributes.hidden;f.heading=parseFloat(e.attributes.heading)||
0;f.gotoXY(+e.attributes.x||0,+e.attributes.y||0);c.loadObject(f,e);SnapActions.loadOwner(f);f.fixLayout()});d.stage.children.forEach(function(e){var f;e.inheritanceInfo&&(f=d.sprites[e.inheritanceInfo.exemplar])&&e.setExemplar(f);e.nestingInfo&&((f=d.sprites[e.nestingInfo.anchor])&&f.attachPart(e),e.rotatesWithAnchor="true"===e.nestingInfo.synch)});d.stage.children.forEach(function(e){delete e.inheritanceInfo;e.nestingInfo&&(e.nestingScale=+(e.nestingInfo.scale||e.scale),delete e.nestingInfo)});
this.objects={};this.project={};this.mediaDict={};b.stage.fixLayout();b.stage.rerender();b.createCorral();b.fixLayout();return d.stage.children};SnapSerializer.prototype.loadMedia=function(a){return this.loadMediaModel(this.parse(a))};SnapSerializer.prototype.loadMediaModel=function(a){var b=this;this.mediaDict={};if(+a.attributes.version>this.version)throw"Module uses newer version of Serializer";a.children.forEach(function(c){return b.loadValue(c)});return this.mediaDict};
SnapSerializer.prototype.loadObject=function(a,b){var c=b.require("blocks"),d=b.childNamed("dispatches"),e;b.attributes.instrument&&(a.instrument=+b.attributes.instrument);this.loadInheritanceInfo(a,b);this.loadNestingInfo(a,b);if(e=b.childNamed("wear"))if(e=e.childNamed("costume")||e.childNamed("ref")){var f=this.loadValue(e,a);f.loaded?a.wearCostume(f,!0):f.loaded=function(){this.loaded=!0;a.wearCostume(f,!0)}}else console.log(a.name+": missing costume to wear");a.inheritanceInfo&&a.inheritanceInfo.delegated instanceof
Array&&contains(a.inheritanceInfo.delegated,"costumes")||this.loadCostumes(a,b);a.inheritanceInfo&&a.inheritanceInfo.delegated instanceof Array&&contains(a.inheritanceInfo.delegated,"sounds")||this.loadSounds(a,b);this.loadCustomBlocks(a,c);d&&this.loadCustomBlocks(a,d,!1,!0);this.populateCustomBlocks(a,c);this.loadVariables(a.variables,b.require("variables"),a);a.inheritanceInfo&&a.inheritanceInfo.delegated instanceof Array&&contains(a.inheritanceInfo.delegated,"scripts")||this.loadScripts(a,a.scripts,
b.require("scripts"))};SnapSerializer.prototype.loadInheritanceInfo=function(a,b){var c=b.childNamed("inherit");if(c){a.inheritanceInfo=c.attributes;if(c=c.childNamed("list"))a.inheritanceInfo.delegated=this.loadValue(c).asArray();a.inheritanceInfo.costumeNumber=b.attributes.costume}};SnapSerializer.prototype.loadNestingInfo=function(a,b){if(b=b.childNamed("nest"))a.nestingInfo=b.attributes};
SnapSerializer.prototype.loadCostumes=function(a,b){var c=b.childNamed("costumes"),d;c&&(a.costumes=this.loadValue(c.require("list",function(){console.log(a.name+": missing required costumes list, improvising...");return new XML_Element("list")})),a.costumes.type="costume");Object.prototype.hasOwnProperty.call(b.attributes,"costume")&&(d=a.costumes.asArray()[b.attributes.costume-1])&&(d.loaded?a.wearCostume(d,!0):d.loaded=function(){this.loaded=!0;a.wearCostume(d,!0)})};
SnapSerializer.prototype.loadSounds=function(a,b){if(b=b.childNamed("sounds"))a.sounds=this.loadValue(b.require("list",function(){console.log(a.name+": missing required sounds list, improvising...");return new XML_Element("list")})),a.sounds.type="sound"};
SnapSerializer.prototype.loadVariables=function(a,b,c){var d=this;b.children.forEach(function(e){if("variable"===e.tag){var f=e.children[0];var g=new Variable;g.isTransient="true"===e.attributes.transient;g.value=g.isTransient||!f?0:d.loadValue(f,c);a.vars[e.attributes.name]=g}})};
SnapSerializer.prototype.loadCustomBlock=function(a,b){var c=new CustomBlockDefinition(a.attributes.s||"");c.category=a.attributes.category||"other";c.type=a.attributes.type||"command";c.isGlobal=!0===b;c.id=a.attributes.collabId;var d=c.parseSpec(c.spec).filter(function(f){return"%"===f.charAt(0)&&1<f.length}).map(function(f){return f.substr(1)});c.names=d;if(b=a.childNamed("inputs")){var e=-1;b.children.forEach(function(f){var g=f.childNamed("options");"input"===f.tag&&(e+=1,c.declarations.set(d[e],
[f.attributes.type,contains(["%b","%boolUE"],f.attributes.type)?f.contents?"true"===f.contents:null:f.contents,g?g.contents:void 0,"true"===f.attributes.readonly]))})}if(b=a.childNamed("variables"))c.variableNames=this.loadValue(b.require("list")).asArray();if(b=a.childNamed("header"))c.codeHeader=b.contents;if(b=a.childNamed("code"))c.codeMapping=b.contents;(b=a.childNamed("translations"))&&c.updateTranslations(b.contents);if(a=a.childNamed("comment"))c.comment=this.loadComment(a);return c};
SnapSerializer.prototype.loadCustomBlocks=function(a,b,c,d){var e=this;b.children.forEach(function(f){"block-definition"===f.tag&&(f=e.loadCustomBlock(f,c),f.receiver=a,d?a.inheritedMethodsCache.push(f):f.isGlobal?a.globalBlocks.push(f):a.customBlocks.push(f))})};
SnapSerializer.prototype.populateCustomBlocks=function(a,b,c){var d=this;b.children.forEach(function(e,f){var g;if("block-definition"===e.tag){f=c?a.globalBlocks[f]:a.customBlocks[f];if(g=e.childNamed("script"))f.body=new Context(null,g?d.loadScript(g,a):null,null,a),f.body.inputs=f.names.slice(0);if(e=e.childNamed("scripts"))f.scripts=d.loadScriptsArray(e,a);delete f.names}})};
SnapSerializer.prototype.loadScripts=function(a,b,c){var d=this,e=SyntaxElementMorph.prototype.scale;b.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture;c.children.forEach(function(f){var g;if("script"===f.tag){if(g=d.loadScript(f,a))g.setPosition((new Point((+f.attributes.x||0)*e,(+f.attributes.y||0)*e)).add(b.topLeft())),b.add(g),g.fixBlockColor(null,!0),g.allComments().forEach(function(h){return h.align(g)})}else"comment"===f.tag&&(g=d.loadComment(f))&&(g.setPosition((new Point((+f.attributes.x||
0)*e,(+f.attributes.y||0)*e)).add(b.topLeft())),b.add(g))})};SnapSerializer.prototype.loadScriptsArray=function(a,b){var c=this,d=SyntaxElementMorph.prototype.scale,e=[];a.children.forEach(function(f){var g;if("script"===f.tag){if(g=c.loadScript(f,b))g.setPosition(new Point((+f.attributes.x||0)*d,(+f.attributes.y||0)*d)),e.push(g),g.fixBlockColor(null,!0)}else"comment"===f.tag&&(g=c.loadComment(f))&&(g.setPosition(new Point((+f.attributes.x||0)*d,(+f.attributes.y||0)*d)),e.push(g))});return e};
SnapSerializer.prototype.loadScript=function(a,b){var c=this,d,e,f;this.project.stage||(this.project.stage=b.parentThatIsA(StageMorph),this.project.targetStage=this.project.stage);a.children.forEach(function(g){if(f=c.loadBlock(g,!1,b)){if(e)if(e.nextBlock&&f instanceof CommandBlockMorph)e.nextBlock(f);else return console.log("SNAP: expecting a command but getting a reporter:\n  "+e.blockSpec+"\n  "+f.blockSpec),d;else d=f;e=f}});return d};
SnapSerializer.prototype.loadComment=function(a){var b=new CommentMorph(a.contents),c=SyntaxElementMorph.prototype.scale;b.isCollapsed="true"===a.attributes.collapsed;b.setTextWidth(+a.attributes.w*c);b.id=a.attributes.collabId;return b};
SnapSerializer.prototype.loadBlock=function(a,b,c){var d=this,e,f=0;if("block"===a.tag){if(Object.prototype.hasOwnProperty.call(a.attributes,"var")){var g=SpriteMorph.prototype.variableBlock(a.attributes["var"]);g.id=a.attributes.collabId;return g}g=SpriteMorph.prototype.blockForSelector(a.attributes.s);if(e=SpriteMorph.prototype.blockMigrations[a.attributes.s])f=e.offset}else if("custom-block"===a.tag){var h=(e=a.attributes.scope?!1:!0)?this.project.stage:c;var k=a.childNamed("receiver");k&&k.children[0]&&
"project"!==k.children[0].tag&&(h=this.loadValue(a.childNamed("receiver").children[0]));if(!h){if(e)return g=this.obsoleteBlock(b),g.id=a.attributes.collabId,g;h=this.project.stage}e?(e=detect(h.globalBlocks,function(p){return p.blockSpec()===a.attributes.s}),!e&&this.project.targetStage&&(e=detect(this.project.targetStage.globalBlocks,function(p){return p.blockSpec()===a.attributes.s}))):e=detect(h.customBlocks,function(p){return p.blockSpec()===a.attributes.s})||(h.inheritedMethodsCache?detect(h.inheritedMethodsCache,
function(p){return p.blockSpec()===a.attributes.s}):null);if(!e||!contains(SpriteMorph.prototype.categories,e.category))return g=this.obsoleteBlock(b),g.id=a.attributes.collabId,g;g="command"===e.type?new CustomCommandBlockMorph(e,!1):new CustomReporterBlockMorph(e,"predicate"===e.type,!1)}null===g&&(g=this.obsoleteBlock(b));g.isDraggable=!0;g.id=a.attributes.collabId;var l=g.inputs();e=a.children.filter(function(p){return"comment"!==p.tag}).length;h=l.length;if(h<e){var m=detect(l,function(p){return p instanceof
StructInputSlotMorph});b=l.indexOf(m);if(-1!==b){var n=this,q=e-h;l.splice(b,1);q=a.children.splice(b,b+q+1).map(function(p){return"block"===p.tag||"custom-block"===p.tag?n.loadBlock(p,!0,c):"script"===p.tag?n.loadScript(p,c):"color"===p.tag?n.loadColor(p):n.loadValue(p,c)||""})}}a.children.forEach(function(p,t){"variables"===p.tag?d.loadVariables(g.variables,p,c):"comment"===p.tag?(g.comment=d.loadComment(p),g.comment.block=g):"receiver"===p.tag?nop():d.loadInput(p,l[t+f],g,c)});g.cachedInputs=null;
m&&q&&(m instanceof MessageInputSlotMorph?(b=this.project.stage.messageTypes.getMsgType(q[0]),m.setContents(q[0],q.slice(1),b)):m.setContents(q[0],q.slice(1)));return g};SnapSerializer.prototype.obsoleteBlock=function(a){a=a?new ReporterBlockMorph:new CommandBlockMorph;a.selector="errorObsolete";a.color=new Color(200,0,20);a.setSpec("Obsolete!");a.isDraggable=!0;return a};
SnapSerializer.prototype.loadInput=function(a,b,c,d){var e=this;if(!isNil(b))if("script"===a.tag){if(a=this.loadScript(a,d))"reifyReporter"===c.selector||"reifyPredicate"===c.selector?b.replaceInput(b.children[0],a):b.add(a),b.fixLayout()}else if("autolambda"===a.tag&&a.children[0]){if(a=this.loadBlock(a.children[0],!0,d))b.replaceInput(b.children[0],a),b.fixLayout()}else if("list"===a.tag){for(;0<b.inputs().length;)b.removeInput();a.children.forEach(function(f){b.addInput();e.loadInput(f,b.children[b.children.length-
2],b,d)});b.fixLayout()}else"block"===a.tag||"custom-block"===a.tag?c.replaceInput(b,this.loadBlock(a,!0,d)):"color"===a.tag?b.setColor(this.loadColor(a.contents)):(c=this.loadValue(a),isNil(c)||isNil(b)||!b.setContents||(b instanceof MessageInputSlotMorph?(a=this.loadValue(a),c=this.project.stage.messageTypes.getMsgType(a),b.setContents(a,null,c)):b.setContents(this.loadValue(a))))};
SnapSerializer.prototype.loadValue=function(a,b){function c(){Object.prototype.hasOwnProperty.call(a.attributes,"id")&&(g.objects[a.attributes.id]=h);Object.prototype.hasOwnProperty.call(a.attributes,"mediaID")&&(g.mediaDict[a.attributes.mediaID]=h)}var d=this,e,f,g=this;switch(a.tag){case "ref":if(Object.prototype.hasOwnProperty.call(a.attributes,"id"))return this.objects[a.attributes.id];if(Object.prototype.hasOwnProperty.call(a.attributes,"mediaID"))return this.mediaDict[a.attributes.mediaID];
if(Object.prototype.hasOwnProperty.call(a.attributes,"actionID"))return SnapActions.getOwnerFromId(a.attributes.actionID);throw Error("expecting a reference id");case "l":return(e=a.childNamed("option"))?[e.contents]:(f=a.childNamed("bool"))?this.loadValue(f):(e=a.childNamed("wish"))?this.loadValue(e):a.contents;case "bool":return"true"===a.contents;case "list":if(a.attributes.hasOwnProperty("linked")){if("atomic"===a.attributes.struct){var h=Process.prototype.parseCSV(a.contents);h.becomeLinked();
c();return h}h=new List;h.isLinked=!0;c();e=h;var k=a.childrenNamed("item");k.forEach(function(q,p){q=q.children[0];h.first=q?d.loadValue(q,b):0;(q=a.childNamed("list")||a.childNamed("ref"))?h.rest=d.loadValue(q,b):p<k.length-1&&(h.rest=new List,h=h.rest,h.isLinked=!0)});return e}if("atomic"===a.attributes.struct)return h=Process.prototype.parseCSV(a.contents),c(),h;h=new List;c();h.contents=a.childrenNamed("item").map(function(q){return(q=q.children[0])?d.loadValue(q,b):0});return h;case "sprite":return h=
new SpriteMorph(this.project.globalVariables),a.attributes.id&&(this.objects[a.attributes.id]=h),a.attributes.name&&(h.name=a.attributes.name,this.project.sprites[a.attributes.name]=h),a.attributes.idx&&(h.idx=+a.attributes.idx),a.attributes.color&&(h.color=this.loadColor(a.attributes.color),h.cachedHSV=h.color.hsv()),a.attributes.pen&&(h.penPoint=a.attributes.pen),a.attributes.collabId&&(h.id=a.attributes.collabId),a.attributes.volume&&(h.volume=+a.attributes.volume),a.attributes.pan&&(h.pan=+a.attributes.pan),
this.project.stage.add(h),h.scale=parseFloat(a.attributes.scale||"1"),h.rotationStyle=parseFloat(a.attributes.rotation||"1"),h.isDraggable="false"!==a.attributes.draggable,h.isVisible="true"!==a.attributes.hidden,h.heading=parseFloat(a.attributes.heading)||0,h.gotoXY(+a.attributes.x||0,+a.attributes.y||0),this.loadObject(h,a),this.loadHistory(a.childNamed("history")),h.fixLayout(),(e=a.childNamed("messageTypes"))&&e.children.forEach(function(q){return d.loadMessageType(d.project.stage,q)}),h;case "context":h=
new Context(null);c();if(e=a.childNamed("origin"))if(e=e.childNamed("ref")||e.childNamed("sprite"))h.origin=this.loadValue(e);if(e=a.childNamed("receiver"))if(e=e.childNamed("ref")||e.childNamed("sprite"))h.receiver=this.loadValue(e);var l=h.origin||h.receiver||b;if(e=a.childNamed("script"))h.expression=this.loadScript(e,l);else if(e=a.childNamed("block")||a.childNamed("custom-block"))h.expression=this.loadBlock(e,null,l);else if(e=a.childNamed("l"))f=e.childNamed("bool"),h.expression=f?new BooleanSlotMorph(this.loadValue(f)):
new InputSlotMorph(e.contents);if(h.expression instanceof BlockMorph){var m=0;h.expression.allEmptySlots().forEach(function(q){m+=1;q.bindingID=q instanceof MultiArgMorph?["arguments"]:m});h.emptySlots=m}(e=a.childNamed("inputs"))&&e.children.forEach(function(q){"input"===q.tag&&h.inputs.push(q.contents)});(e=a.childNamed("variables"))&&this.loadVariables(h.variables,e,l);if(e=a.childNamed("context"))h.outerContext=this.loadValue(e,l);h.outerContext&&h.receiver&&!h.outerContext.variables.parentFrame&&
(h.outerContext.variables.parentFrame=h.receiver.variables);return h;case "costume":e=new Point;Object.prototype.hasOwnProperty.call(a.attributes,"center-x")&&(e.x=parseFloat(a.attributes["center-x"]));Object.prototype.hasOwnProperty.call(a.attributes,"center-y")&&(e.y=parseFloat(a.attributes["center-y"]));Object.prototype.hasOwnProperty.call(a.attributes,"name")&&(f=a.attributes.name);if(Object.prototype.hasOwnProperty.call(a.attributes,"image")){var n=new Image;0!==a.attributes.image.indexOf("data:image/svg+xml")||
MorphicPreferences.rasterizeSVGs?(h=new Costume(null,f,e),n.onload=function(){var q=newCanvas(new Point(n.width,n.height),!0);q.getContext("2d").drawImage(n,0,0);h.contents=q;h.imageSrc=null;h.version=+new Date;"function"===typeof h.loaded?h.loaded():h.loaded=!0}):(h=new SVG_Costume(null,f,e),n.onload=function(){h.contents=n;h.imageSrc=null;h.version=+new Date;"function"===typeof h.loaded?h.loaded():h.loaded=!0});n.src=a.attributes.image;h.imageSrc=a.attributes.image}h.id=a.attributes.collabId;c();
return h;case "sound":return e=new Audio,e.src=a.attributes.sound,h=new Sound(e,a.attributes.name),Object.prototype.hasOwnProperty.call(a.attributes,"mediaID")&&(this.mediaDict[a.attributes.mediaID]=h),h.id=a.attributes.collabId,c(),h;case "wish":return e=new CustomBlockDefinition(a.attributes.s),e.type=a.attributes.type,e.category=a.attributes.category,e.storedSemanticSpec=a.attributes.s,e.updateTranslations(a.contents),e.blockInstance(!0)}};
SnapSerializer.prototype.loadColor=function(a){a=(a||"").split(",");return new Color(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]))};
SnapSerializer.prototype.openProject=function(a,b){var c=b.stage,d=[];if(a&&a.stage)return b.siblings().forEach(function(e){return e.destroy()}),b.projectName=a.name,b.projectNotes=a.notes||"",b.globalVariables&&(b.globalVariables=a.globalVariables),c&&c.destroy(),b.add(a.stage),b.stage=a.stage,d=b.stage.children.filter(function(e){return e instanceof SpriteMorph}),d.sort(function(e,f){return e.idx-f.idx}),b.sprites=new List(d),c=d[0]||a.stage,0<sizeOf(this.mediaDict)?(b.hasChangedMedia=!1,this.mediaDict=
{}):b.hasChangedMedia=!0,a.stage.fixLayout(),b.createCorral(),b.selectSprite(c),b.fixLayout(),b.world().keyboardFocus=a.stage,SnapUndo.allEvents=a.undo.allEvents,SnapUndo.eventHistory=a.undo.eventHistory,SnapUndo.undoCount=a.undo.undoCount,a};Array.prototype.toXML=function(a){return this.reduce(function(b,c){return b+a.store(c)},"")};
StageMorph.prototype.toXML=function(a){function b(g){var h="";Object.keys(StageMorph.prototype[g]).forEach(function(k){h+="<"+k+">"+XML_Element.prototype.escape(StageMorph.prototype[g][k])+"</"+k+">"});return h}var c=normalizeCanvas(this.thumbnail(SnapSerializer.prototype.thumbnailSize),!0),d=this.getCostumeIdx(),e=this.parentThatIsA(IDE_Morph);if(!a.isSavingPortable){c=normalizeCanvas(this.thumbnail(SnapSerializer.prototype.thumbnailSize),!0);try{var f=c.toDataURL("image/png")}catch(g){f=null}}this.removeAllClones();
return a.format('<project collabStartIndex="@" name="@" app="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" collabId="@" costume="@" color="@,@,@,@" tempo="@" threadsafe="@" penlog="@" %volume="@" pan="@" lines="@" ternary="@" hyperops="@" codify="@" inheritance="@" sublistIDs="@" scheduled="@" ~><pentrails>$</pentrails>%<costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><messageTypes>%</messageTypes><scripts>%\x3c/scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables><history>%</history><replay>%</replay></project>',
SnapActions.lastSeen,e&&e.projectName?e.projectName:localize("Untitled"),a.app,a.version,e&&e.projectNotes?e.projectNotes:"",f,this.name,StageMorph.prototype.dimensions.x,StageMorph.prototype.dimensions.y,this.id,d,this.color.r,this.color.g,this.color.b,this.color.a,this.getTempo(),this.isThreadSafe,this.enablePenLogging,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.volume,this.pan,SpriteMorph.prototype.useFlatLineEnds?"flat":"round",BooleanSlotMorph.prototype.isTernary,!0===
Process.prototype.enableHyperOps,this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,0!==StageMorph.prototype.frameRate,normalizeCanvas(this.trailsCanvas,!0).toDataURL("image/png"),!d&&this.costume?"<wear>"+a.store(this.costume)+"</wear>":"",a.store(this.costumes,this.name+"_cst"),a.store(this.sounds,this.name+"_snd"),a.store(this.variables),a.store(this.customBlocks),a.store(this.messageTypes),a.store(this.scripts),a.store(this.children),Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(function(g,
h){return g+" "+h},""),b("codeHeaders"),b("codeMappings"),a.store(this.globalBlocks),e&&e.globalVariables?a.store(e.globalVariables):"",a.isSavingHistory?a.historyXML(this.id):"",a.isSavingHistory?a.replayHistory():"")};
StageMorph.prototype.toPortableXML=function(a,b){function c(f){var g="";Object.keys(StageMorph.prototype[f]).forEach(function(h){g+="<"+h+">"+XML_Element.prototype.escape(StageMorph.prototype[f][h])+"</"+h+">"});return g}b=this.parentThatIsA(IDE_Morph);var d=this.customBlocks,e=this.globalBlocks;a.dependencies&&(d=d.filter(function(f){return a.dependencies.customBlocks.includes(f)}),e=e.filter(function(f){return a.dependencies.customBlocks.includes(f)}));this.removeAllClones();return a.format('<project collabStartIndex="@" name="@" app="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" collabId="@" costume="@" tempo="@" threadsafe="@" lines="@" codify="@" inheritance="@" sublistIDs="@" scheduled="@" ~><pentrails>$</pentrails><costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><messageTypes>%</messageTypes><scripts>%\x3c/scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables><history>%</history><replay>%</replay></project>',
SnapActions.lastSeen,b&&b.projectName?b.projectName:localize("Untitled"),a.app,a.version,b&&b.projectNotes?b.projectNotes:"","",this.name,StageMorph.prototype.dimensions.x,StageMorph.prototype.dimensions.y,this.id,this.getCostumeIdx(),this.getTempo(),this.isThreadSafe,SpriteMorph.prototype.useFlatLineEnds?"flat":"round",this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,0!==StageMorph.prototype.frameRate,"",a.store(this.costumes,this.name+"_cst"),a.store(this.sounds,this.name+"_snd"),
a.store(this.variables),a.store(d),a.store(this.messageTypes),a.dependencies?"":a.store(this.scripts),a.store(this.children),Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(function(f,g){return f+" "+g},""),c("codeHeaders"),c("codeMappings"),a.store(e),b&&b.globalVariables?a.store(b.globalVariables):"","","")};
SpriteMorph.prototype.toXML=function(a){var b=this.parentThatIsA(StageMorph);b=(b=b?b.parentThatIsA(IDE_Morph):null)?b.sprites.asArray().indexOf(this)+1:0;var c=this.getCostumeIdx(),d=this.inheritsAttribute("costumes"),e=this.inheritsAttribute("sounds"),f=this.inheritsAttribute("scripts");return a.format('<sprite name="@" collabId="@" idx="@" x="@" y="@" heading="@" scale="@" volume="@" pan="@" rotation="@"% draggable="@"% costume="@" color="@,@,@,@" pen="@" ~>%%%'+(d?"%":"<costumes>%</costumes>")+
(e?"%":"<sounds>%</sounds>")+"<blocks>%</blocks><variables>%</variables>"+(this.exemplar?"<dispatches>%</dispatches>":"%")+(f?"%":"<scripts>%\x3c/scripts>")+"<history>%</history></sprite>",this.name,this.id,b,this.xPosition(),this.yPosition(),this.heading,this.scale,this.volume,this.pan,this.rotationStyle,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.isDraggable,this.isVisible?"":' hidden="true"',c,this.color.r,this.color.g,this.color.b,this.color.a,this.penPoint,this.exemplar?
'<inherit exemplar="'+this.exemplar.name+'">'+(this.inheritedAttributes.length?a.store(new List(this.inheritedAttributes)):"")+"</inherit>":"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'" scale="'+this.nestingScale)+'"/>':"",!c&&this.costume?"<wear>"+a.store(this.costume)+"</wear>":"",d?"":a.store(this.costumes,this.name+"_cst"),e?"":a.store(this.sounds,this.name+"_snd"),this.customBlocks?a.store(this.customBlocks):"",a.store(this.variables),
this.exemplar?a.store(this.inheritedMethods()):"",f?"":a.store(this.scripts),a.isSavingHistory?a.historyXML(this.id):"")};
SpriteMorph.prototype.toPortableXML=function(a){var b=this.parentThatIsA(StageMorph);b=(b=b?b.parentThatIsA(IDE_Morph):null)?b.sprites.asArray().indexOf(this)+1:0;var c=this.customBlocks||[],d=new MessageFrame;a.dependencies&&(c=c.filter(function(e){return a.dependencies.customBlocks.includes(e)}),a.dependencies.messageTypes.forEach(function(e){return d.addMsgType(e)}));return a.format('<sprite name="@" collabId="@" idx="@" x="@" y="@" heading="@" scale="@" rotation="@" draggable="@"% costume="@" color="@,@,@" pen="@" ~>%%<costumes>%</costumes><sounds>%</sounds><variables>%</variables><messageTypes>%</messageTypes><blocks>%</blocks><scripts>%\x3c/scripts></sprite>',this.name,
this.id,b,this.xPosition(),this.yPosition(),this.heading,this.scale,this.rotationStyle,this.isDraggable,this.isVisible?"":' hidden="true"',this.getCostumeIdx(),this.color.r,this.color.g,this.color.b,this.penPoint,this.exemplar?'<inherit exemplar="'+this.exemplar.name+'"/>':"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'" scale="'+this.nestingScale)+'"/>':"",a.dependencies?a.store(new List):a.store(this.costumes,this.name+"_cst"),
a.store(this.sounds,this.name+"_snd"),a.store(this.variables),a.store(d),this.customBlocks?a.store(c):"",a.dependencies?"":a.store(this.scripts))};Costume.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0;
Costume.prototype.toXML=function(a){var b=this.imageSrc;b||(b=this instanceof SVG_Costume?this.contents.src:normalizeCanvas(this.contents).toDataURL("image/png"));return a.format('<costume name="@" collabId="@" center-x="@" center-y="@" image="@" ~/>',this.name,this.id,this.rotationCenter.x,this.rotationCenter.y,b)};Sound.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0;Sound.prototype.toXML=function(a){return a.format('<sound collabId="@" name="@" sound="@" ~/>',this.id,this.name,this.toDataURL())};
VariableFrame.prototype.toXML=function(a){var b=this;return Object.keys(this.vars).reduce(function(c,d){var e=b.vars[d].value;d=b.vars[d].isTransient?a.format('<variable name="@" transient="true"/>',d):void 0===e||null===e?a.format('<variable name="@"/>',d):a.format('<variable name="@">%</variable>',d,"object"===typeof e?isSnapObject(e)?"":a.store(e):"boolean"===typeof e?a.format("<bool>$</bool>",e):a.format("<l>$</l>",e));return c+d},"")};
VariableFrame.prototype.toPortableXML=function(a){var b=this,c=Object.keys(this.vars);a.dependencies&&(c=c.filter(function(d){return a.dependencies.variables.includes(d)}));return c.reduce(function(d,e){var f=b.vars[e].value;e=b.vars[e].isTransient?a.format('<variable name="@" transient="true"/>',e):void 0===f||null===f?a.format('<variable name="@"/>',e):a.format('<variable name="@">%</variable>',e,"object"===typeof f?isSnapObject(f)?"":a.store(f):"boolean"===typeof f?a.format("<bool>$</bool>",f):
a.format("<l>$</l>",f));return d+e},"")};
WatcherMorph.prototype.toXML=function(a){var b=this.target instanceof VariableFrame,c=this.currentValue instanceof List,d=this.readoutColor,e=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return this.isTemporary()?"":a.format('<watcher% % style="@"% x="@" y="@" color="@,@,@"%%/>',b&&this.target.owner||!b&&this.target?a.format(' scope="@"',b?this.target.owner.name:this.target.name):"",a.format(b?'var="@"':'s="@"',this.getter),this.style,b&&"slider"===this.style?a.format(' min="@" max="@"',
this.sliderMorph.start,this.sliderMorph.stop):"",e.x,e.y,d.r,d.g,d.b,c?a.format(' extX="@" extY="@"',this.cellMorph.contentsMorph.width(),this.cellMorph.contentsMorph.height()):"",this.isVisible?"":' hidden="true"')};ScriptsMorph.prototype.toXML=function(a){return this.children.reduce(function(b,c){return c instanceof BlockMorph?b+c.toScriptXML(a,!0):c instanceof CommentMorph&&!c.block?b+c.toXML(a):b},"")};
BlockMorph.prototype.toXML=BlockMorph.prototype.toScriptXML=function(a,b){var c=SyntaxElementMorph.prototype.scale,d=this;var e=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();b=b?a.format('<script x="@" y="@">',e.x/c,e.y/c):"<script>";do b+=d.toBlockXML(a),d=d.nextBlock();while(d);return b+"\x3c/script>"};
BlockMorph.prototype.toBlockXML=function(a){return a.format('<block collabId="@" s="@">%%</block>',this.id,this.selector,a.store(this.inputs()),this.comment?this.comment.toXML(a):"")};ReporterBlockMorph.prototype.toXML=function(a){return"reportGetVar"===this.selector?this.comment?a.format('<block collabId="@" var="@">%</block>',this.id,this.blockSpec,this.comment.toXML(a)):a.format('<block collabId="@" var="@"/>',this.id,this.blockSpec):this.toBlockXML(a)};
ReporterBlockMorph.prototype.toScriptXML=function(a,b){var c=SyntaxElementMorph.prototype.scale;var d=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return b?a.format('<script x="@" y="@">%\x3c/script>',d.x/c,d.y/c,this.toXML(a)):a.format("<script>%\x3c/script>",this.toXML(a))};
CustomCommandBlockMorph.prototype.toBlockXML=function(a){var b=this.isGlobal?void 0:"local",c=this.definition||this.scriptTarget().getMethod(this.blockSpec),d="";!a.isSavingPortable&&!b||c.receiver[a.idProperty]||(d="<receiver>"+(a.isSavingCustomBlockOwners?a.store(c.receiver):'<ref actionID="'+c.receiver.id+'"/>')+"</receiver>");return a.format('<custom-block collabId="@" s="@"%>%%%%</custom-block>',this.id,this.semanticSpec,this.isGlobal?"":a.format(' scope="@"',b),a.store(this.inputs()),this.isGlobal&&
c.variableNames.length&&!a.isExportingBlocksLibrary?"<variables>"+this.variables.toXML(a)+"</variables>":"",this.comment?this.comment.toXML(a):"",d)};CustomReporterBlockMorph.prototype.toBlockXML=CustomCommandBlockMorph.prototype.toBlockXML;
CustomBlockDefinition.prototype.toXML=function(a){function b(d){return d.reduce(function(e,f){return f instanceof BlockMorph?e+f.toScriptXML(a,!0):f instanceof CommentMorph&&!f.block?e+f.toXML(a):e},"")}var c=this;return a.format('<block-definition collabId="@" s="@" type="@" category="@">%'+(this.variableNames.length?"<variables>%</variables>":"@")+"<header>@</header><code>@</code><translations>@</translations><inputs>%</inputs>%%</block-definition>",this.id,this.spec,this.type,this.category||"other",
this.comment?this.comment.toXML(a):"",this.variableNames.length?a.store(new List(this.variableNames)):"",this.codeHeader||"",this.codeMapping||"",this.translationsAsText(),Array.from(this.declarations.keys()).reduce(function(d,e){return d+a.format('<input type="@"$>$%</input>',c.declarations.get(e)[0],c.declarations.get(e)[3]?' readonly="true"':"",c.declarations.get(e)[1],c.declarations.get(e)[2]?a.format("<options>@</options>",c.declarations.get(e)[2]):"")},""),this.body?a.store(this.body.expression):
"",0<this.scripts.length?"<scripts>"+b(this.scripts)+"\x3c/scripts>":"")};ArgMorph.prototype.toXML=function(){return"<l/>"};BooleanSlotMorph.prototype.toXML=function(){return"boolean"===typeof this.value?"<l><bool>"+this.value+"</bool></l>":"<l/>"};
InputSlotMorph.prototype.toXML=function(a){return this.selectedBlock?a.format('<l><wish s="@" type="@" category="@">@</wish></l>',this.selectedBlock.semanticSpec,this.selectedBlock instanceof CommandBlockMorph?"command":this.selectedBlock.isPredicate?"predicate":"reporter",this.selectedBlock.category,this.selectedBlock.storedTranslations):this.constant?a.format("<l><option>$</option></l>",this.constant):a.format("<l>$</l>",this.contents().text)};
TemplateSlotMorph.prototype.toXML=function(a){return a.format("<l>$</l>",this.contents())};CommandSlotMorph.prototype.toXML=function(a){var b=this.nestedBlock();return b instanceof BlockMorph?b instanceof ReporterBlockMorph?a.format("<autolambda>%</autolambda>",a.store(b)):a.store(b):"<script>\x3c/script>"};FunctionSlotMorph.prototype.toXML=CommandSlotMorph.prototype.toXML;MultiArgMorph.prototype.toXML=function(a){return a.format("<list>%</list>",a.store(this.inputs()))};
ArgLabelMorph.prototype.toXML=function(a){return a.format("%",a.store(this.inputs()[0]))};ColorSlotMorph.prototype.toXML=function(a){return a.format("<color>$,$,$,$</color>",this.color.r,this.color.g,this.color.b,this.color.a)};
List.prototype.toXML=function(a,b){if(this.hasOnlyAtomicData()&&(!this.isLinked||!StageMorph.prototype.enableSublistIDs))return a.format('<list struct="atomic" '+(this.isLinked?'linked="linked" ':"")+"~>@</list>",this.asCSV());if(this.isLinked){var c='<list collabId="'+this.id+'" linked="linked" ~>';if(StageMorph.prototype.enableSublistIDs){var d=this.first;isNil(d)||(c+=a.format("<item>%</item>","object"===typeof d?isSnapObject(d)?"":a.store(d,b):"boolean"===typeof d?a.format("<bool>$</bool>",d):
a.format("<l>$</l>",d)));isNil(this.rest)||(c+=a.store(this.rest,b));return c+"</list>"}var e=this;do d=e.first,isNil(d)||(c+=a.format("<item>%</item>","object"===typeof d?isSnapObject(d)?"":a.store(d,b):"boolean"===typeof d?a.format("<bool>$</bool>",d):a.format("<l>$</l>",d))),e=e.rest;while(!isNil(e));return c+"</list>"}return a.format('<list collabId="@" ~>%</list>',this.id,this.contents.reduce(function(f,g){return f+a.format("<item>%</item>","object"===typeof g?isSnapObject(g)?"":a.store(g,b):
"boolean"===typeof g?a.format("<bool>$</bool>",g):a.format("<l>$</l>",g))},""))};
Context.prototype.toXML=function(a){return this.isContinuation?"":a.format("<context ~><inputs>%</inputs><variables>%</variables>%<receiver>%</receiver><origin>%</origin>%</context>",this.inputs.reduce(function(b,c){return b+a.format("<input>$</input>",c)},""),this.variables?a.store(this.variables):"",this.expression?a.store(this.expression):"",this.receiver?a.store(this.receiver):"",this.receiver?a.store(this.origin):"",this.outerContext?a.store(this.outerContext):"")};
Context.prototype.toPortableXML=function(a){var b=this,c=new VariableFrame,d,e;if(this.outerContext){var f=this.outerContext.variables;if(this.expression){var g=[];SnapActions.traverse(this.expression,function(h){d=h.blockSpec;"reportGetVar"!==h.selector||g.includes(d)||g.push(d)});c.vars=copy(this.outerContext.variables.vars);g.forEach(function(h){var k=[b.outerContext.variables];b.receiver&&k.push(b.receiver.variables);(e=k.reduce(function(l,m){return l||m.silentFind(h)},null))&&(c.vars[h]=e.vars[h])});
this.outerContext.variables=c}}a=this.toXML(a);this.outerContext&&(this.outerContext.variables=f||this.outerContext.variables);return a};
Context.prototype.getPortableDependencies=function(a,b){var c=this,d;var e={variables:[],customBlocks:[],messageTypes:[]};a||(a=this.expression);b||(b={});if(b[a.id])return e;b[a.id]=!0;if(a instanceof CustomCommandBlockMorph||a instanceof CustomReporterBlockMorph)e=this.getPortableDependencies(a.definition.body.expression,b);SnapActions.traverse(a,function(f){d=f.blockSpec;if("reportGetVar"===f.selector&&!e.variables.includes(d))e.variables.push(d);else if("evaluateCustomBlock"===f.selector&&!e.customBlocks.includes(f.definition)){e.customBlocks.push(f.definition);
var g=c.getPortableDependencies(f.definition.body.expression,b);e.customBlocks.push.apply(e.customBlocks,$jscomp.arrayFromIterable(g.customBlocks));e.variables.push.apply(e.variables,$jscomp.arrayFromIterable(g.variables))}else if("doSocketMessage"===f.selector||"doSocketRequest"===f.selector)g=SnapActions.ide().stage,f=$jscomp.makeIterator(f.inputs()[0].evaluate()).next().value,g=g.messageTypes.getMsgType(f),e.messageTypes.push(g)});return e};
CommentMorph.prototype.toXML=function(a){var b=SyntaxElementMorph.prototype.scale;if(this.block)return a.format('<comment collabId="@" w="@" collapsed="@">%</comment>',this.id,this.textWidth()/b,this.isCollapsed,a.escape(this.text()));var c=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return a.format('<comment collabId="@" x="@" y="@" w="@" collapsed="@">%</comment>',this.id,c.x/b,c.y/b,this.textWidth()/b,this.isCollapsed,a.escape(this.text()))};
var hex_sha512=function(a){function a(d){return c.SHA512(b(d)).toString(c.enc.Hex)}function b(d){for(var e="",f=-1,g,h;++f<d.length;)g=d.charCodeAt(f),h=f+1<d.length?d.charCodeAt(f+1):0,55296<=g&&56319>=g&&56320<=h&&57343>=h&&(g=65536+((g&1023)<<10)+(h&1023),f++),127>=g?e+=String.fromCharCode(g):2047>=g?e+=String.fromCharCode(192|g>>>6&31,128|g&63):65535>=g?e+=String.fromCharCode(224|g>>>12&15,128|g>>>6&63,128|g&63):2097151>=g&&(e+=String.fromCharCode(240|g>>>18&7,128|g>>>12&63,128|g>>>6&63,128|g&
63));return e}var c=c||function(d,e){var f={},g=f.lib={},h=g.Base=function(){function r(){}return{extend:function(u){r.prototype=this;var v=new r;u&&v.mixIn(u);v.$super=this;return v},create:function(){var u=this.extend();u.init.apply(u,arguments);return u},init:function(){},mixIn:function(u){for(var v in u)u.hasOwnProperty(v)&&(this[v]=u[v]);u.hasOwnProperty("toString")&&(this.toString=u.toString)},clone:function(){return this.$super.extend(this)}}}(),k=g.WordArray=h.extend({init:function(r,u){r=
this.words=r||[];this.sigBytes=u!=e?u:4*r.length},toString:function(r){return(r||m).stringify(this)},concat:function(r){var u=this.words,v=r.words,w=this.sigBytes;r=r.sigBytes;this.clamp();if(w%4)for(var x=0;x<r;x++)u[w+x>>>2]|=(v[x>>>2]>>>24-x%4*8&255)<<24-(w+x)%4*8;else if(65535<v.length)for(x=0;x<r;x+=4)u[w+x>>>2]=v[x>>>2];else u.push.apply(u,v);this.sigBytes+=r;return this},clamp:function(){var r=this.words,u=this.sigBytes;r[u>>>2]&=4294967295<<32-u%4*8;r.length=d.ceil(u/4)},clone:function(){var r=
h.clone.call(this);r.words=this.words.slice(0);return r},random:function(r){for(var u=[],v=0;v<r;v+=4)u.push(4294967296*d.random()|0);return k.create(u,r)}}),l=f.enc={},m=l.Hex={stringify:function(r){var u=r.words;r=r.sigBytes;for(var v=[],w=0;w<r;w++){var x=u[w>>>2]>>>24-w%4*8&255;v.push((x>>>4).toString(16));v.push((x&15).toString(16))}return v.join("")},parse:function(r){for(var u=r.length,v=[],w=0;w<u;w+=2)v[w>>>3]|=parseInt(r.substr(w,2),16)<<24-w%8*4;return k.create(v,u/2)}},n=l.Latin1={stringify:function(r){var u=
r.words;r=r.sigBytes;for(var v=[],w=0;w<r;w++)v.push(String.fromCharCode(u[w>>>2]>>>24-w%4*8&255));return v.join("")},parse:function(r){for(var u=r.length,v=[],w=0;w<u;w++)v[w>>>2]|=(r.charCodeAt(w)&255)<<24-w%4*8;return k.create(v,u)}},q=l.Utf8={stringify:function(r){try{return decodeURIComponent(escape(n.stringify(r)))}catch(u){throw Error("Malformed UTF-8 data");}},parse:function(r){return n.parse(unescape(encodeURIComponent(r)))}},p=g.BufferedBlockAlgorithm=h.extend({reset:function(){this._data=
k.create();this._nDataBytes=0},_append:function(r){"string"==typeof r&&(r=q.parse(r));this._data.concat(r);this._nDataBytes+=r.sigBytes},_process:function(r){var u=this._data,v=u.words,w=u.sigBytes,x=this.blockSize,y=w/(4*x);y=r?d.ceil(y):d.max((y|0)-this._minBufferSize,0);r=y*x;w=d.min(4*r,w);if(r){for(var B=0;B<r;B+=x)this._doProcessBlock(v,B);B=v.splice(0,r);u.sigBytes-=w}return k.create(B,w)},clone:function(){var r=h.clone.call(this);r._data=this._data.clone();return r},_minBufferSize:0});g.Hasher=
p.extend({init:function(){this.reset()},reset:function(){p.reset.call(this);this._doReset()},update:function(r){this._append(r);this._process();return this},finalize:function(r){r&&this._append(r);this._doFinalize();return this._hash},clone:function(){var r=p.clone.call(this);r._hash=this._hash.clone();return r},blockSize:16,_createHelper:function(r){return function(u,v){return r.create(v).finalize(u)}},_createHmacHelper:function(r){return function(u,v){return t.HMAC.create(r,v).finalize(u)}}});var t=
f.algo={};return f}(Math);(function(d){var e=c,f=e.lib,g=f.Base,h=f.WordArray;e=e.x64={};e.Word=g.extend({init:function(k,l){this.high=k;this.low=l}});e.WordArray=g.extend({init:function(k,l){k=this.words=k||[];this.sigBytes=l!=d?l:8*k.length},toX32:function(){for(var k=this.words,l=k.length,m=[],n=0;n<l;n++){var q=k[n];m.push(q.high);m.push(q.low)}return h.create(m,this.sigBytes)},clone:function(){for(var k=g.clone.call(this),l=k.words=this.words.slice(0),m=l.length,n=0;n<m;n++)l[n]=l[n].clone();
return k}})})();(function(){function d(){return h.create.apply(h,arguments)}var e=c,f=e.lib.Hasher,g=e.x64,h=g.Word,k=g.WordArray;g=e.algo;var l=[d(1116352408,3609767458),d(1899447441,602891725),d(3049323471,3964484399),d(3921009573,2173295548),d(961987163,4081628472),d(1508970993,3053834265),d(2453635748,2937671579),d(2870763221,3664609560),d(3624381080,2734883394),d(310598401,1164996542),d(607225278,1323610764),d(1426881987,3590304994),d(1925078388,4068182383),d(2162078206,991336113),d(2614888103,
633803317),d(3248222580,3479774868),d(3835390401,2666613458),d(4022224774,944711139),d(264347078,2341262773),d(604807628,2007800933),d(770255983,1495990901),d(1249150122,1856431235),d(1555081692,3175218132),d(1996064986,2198950837),d(2554220882,3999719339),d(2821834349,766784016),d(2952996808,2566594879),d(3210313671,3203337956),d(3336571891,1034457026),d(3584528711,2466948901),d(113926993,3758326383),d(338241895,168717936),d(666307205,1188179964),d(773529912,1546045734),d(1294757372,1522805485),
d(1396182291,2643833823),d(1695183700,2343527390),d(1986661051,1014477480),d(2177026350,1206759142),d(2456956037,344077627),d(2730485921,1290863460),d(2820302411,3158454273),d(3259730800,3505952657),d(3345764771,106217008),d(3516065817,3606008344),d(3600352804,1432725776),d(4094571909,1467031594),d(275423344,851169720),d(430227734,3100823752),d(506948616,1363258195),d(659060556,3750685593),d(883997877,3785050280),d(958139571,3318307427),d(1322822218,3812723403),d(1537002063,2003034995),d(1747873779,
3602036899),d(1955562222,1575990012),d(2024104815,1125592928),d(2227730452,2716904306),d(2361852424,442776044),d(2428436474,593698344),d(2756734187,3733110249),d(3204031479,2999351573),d(3329325298,3815920427),d(3391569614,3928383900),d(3515267271,566280711),d(3940187606,3454069534),d(4118630271,4000239992),d(116418474,1914138554),d(174292421,2731055270),d(289380356,3203993006),d(460393269,320620315),d(685471733,587496836),d(852142971,1086792851),d(1017036298,365543100),d(1126000580,2618297676),d(1288033470,
3409855158),d(1501505948,4234509866),d(1607167915,987167468),d(1816402316,1246189591)],m=[];(function(){for(var n=0;80>n;n++)m[n]=d()})();g=g.SHA512=f.extend({_doReset:function(){this._hash=k.create([d(1779033703,4089235720),d(3144134277,2227873595),d(1013904242,4271175723),d(2773480762,1595750129),d(1359893119,2917565137),d(2600822924,725511199),d(528734635,4215389547),d(1541459225,327033209)])},_doProcessBlock:function(n,q){var p=this._hash.words,t=p[0],r=p[1],u=p[2],v=p[3],w=p[4],x=p[5],y=p[6];
p=p[7];for(var B=t.high,A=t.low,C=r.high,E=r.low,I=u.high,J=u.low,K=v.high,D=v.low,G=w.high,O=w.low,P=x.high,z=x.low,F=y.high,Q=y.low,R=p.high,M=p.low,N=B,S=A,ea=C,ca=E,fa=I,da=J,na=K,ha=D,V=G,T=O,la=P,ia=z,ma=F,ja=Q,oa=R,ka=M,W=0;80>W;W++){var Z=m[W];if(16>W)var U=Z.high=n[q+2*W]|0,H=Z.low=n[q+2*W+1]|0;else{U=m[W-15];H=U.high;var X=U.low;U=(X<<31|H>>>1)^(X<<24|H>>>8)^H>>>7;X=(H<<31|X>>>1)^(H<<24|X>>>8)^(H<<25|X>>>7);var ba=m[W-2];H=ba.high;var L=ba.low;ba=(L<<13|H>>>19)^(H<<3|L>>>29)^H>>>6;L=(H<<
13|L>>>19)^(L<<3|H>>>29)^(H<<26|L>>>6);H=m[W-7];var pa=H.high,aa=m[W-16],Y=aa.high;aa=aa.low;H=X+H.low;U=U+pa+(H>>>0<X>>>0?1:0);H+=L;U=U+ba+(H>>>0<L>>>0?1:0);H+=aa;U=U+Y+(H>>>0<aa>>>0?1:0);Z.high=U;Z.low=H}pa=V&la^~V&ma;aa=T&ia^~T&ja;Z=N&ea^N&fa^ea&fa;var ra=S&ca^S&da^ca&da;X=(S<<4|N>>>28)^(N<<30|S>>>2)^(N<<25|S>>>7);ba=(N<<4|S>>>28)^(S<<30|N>>>2)^(S<<25|N>>>7);L=l[W];var sa=L.high,qa=L.low;L=ka+((V<<18|T>>>14)^(V<<14|T>>>18)^(T<<23|V>>>9));Y=oa+((T<<18|V>>>14)^(T<<14|V>>>18)^(V<<23|T>>>9))+(L>>>
0<ka>>>0?1:0);L+=aa;Y=Y+pa+(L>>>0<aa>>>0?1:0);L+=qa;Y=Y+sa+(L>>>0<qa>>>0?1:0);L+=H;Y=Y+U+(L>>>0<H>>>0?1:0);H=ba+ra;Z=X+Z+(H>>>0<ba>>>0?1:0);oa=ma;ka=ja;ma=la;ja=ia;la=V;ia=T;T=ha+L|0;V=na+Y+(T>>>0<ha>>>0?1:0)|0;na=fa;ha=da;fa=ea;da=ca;ea=N;ca=S;S=L+H|0;N=Y+Z+(S>>>0<L>>>0?1:0)|0}A=t.low=A+S|0;t.high=B+N+(A>>>0<S>>>0?1:0)|0;E=r.low=E+ca|0;r.high=C+ea+(E>>>0<ca>>>0?1:0)|0;J=u.low=J+da|0;u.high=I+fa+(J>>>0<da>>>0?1:0)|0;D=v.low=D+ha|0;v.high=K+na+(D>>>0<ha>>>0?1:0)|0;O=w.low=O+T|0;w.high=G+V+(O>>>0<T>>>
0?1:0)|0;z=x.low=z+ia|0;x.high=P+la+(z>>>0<ia>>>0?1:0)|0;Q=y.low=Q+ja|0;y.high=F+ma+(Q>>>0<ja>>>0?1:0)|0;M=p.low=M+ka|0;p.high=R+oa+(M>>>0<ka>>>0?1:0)|0},_doFinalize:function(){var n=this._data,q=n.words,p=8*this._nDataBytes,t=8*n.sigBytes;q[t>>>5]|=128<<24-t%32;q[(t+128>>>10<<5)+31]=p;n.sigBytes=4*q.length;this._process();this._hash=this._hash.toX32()},blockSize:32});e.SHA512=f._createHelper(g);e.HmacSHA512=f._createHmacHelper(g)})();return a}({}),logger={log:console.log.bind(console),debug:console.info.bind(console),
info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console)};function ActionManager(){this.id=CLIENT_ID;this.rank=null;this.isLeader=!1;this._pendingLocalActions=[];this._attemptedLocalActions=[];this.listeners=[];this.initialize()}ActionManager.prototype.configure=function(a){this.__ide=a};
ActionManager.prototype.addActions=function(){var a=this;Array.prototype.slice.call(arguments).forEach(function(b){a[b]=function(){var c=Array.prototype.slice.apply(arguments),d="_"+b;this.ide();this[d]&&(c=this[d].apply(this,c)||c);d={type:b,args:c};c=ActionManager.OwnerFor[b]?ActionManager.OwnerFor[b].apply(this,d.args):ActionManager.OwnerFor.apply(this,d.args);d.owner=c;return this.applyEvent(d)}})};
ActionManager.prototype.addUserActions=function(){var a=this;Array.prototype.slice.call(arguments).forEach(function(b){a[b]=function(){var c=Array.prototype.slice.apply(arguments),d="_"+b;this[d]&&(c=this[d].apply(this,c)||c);return this.applyEvent({isUserAction:!0,type:b,args:c})}})};ActionManager.prototype._selectTab=function(a){return[a,this.ide().currentTab]};ActionManager.prototype._selectSprite=function(a){return[a.id,this.ide().currentSprite.id]};ActionManager.prototype.isUserAction=function(a){return a.isUserAction};
ActionManager.prototype.initializeEventMethods=function(){this.addActions("setStageSize","addSprite","removeSprite","renameSprite","toggleDraggable","duplicateSprite","importSprites","setRotationStyle","attachParts","detachParts","addSound","renameSound","removeSound","addCostume","renameCostume","removeCostume","updateCostume","addVariable","deleteVariable","addCustomBlock","deleteCustomBlock","deleteCustomBlocks","setCustomBlockType","updateBlockLabel","deleteBlockLabel","addBlock","replaceBlock",
"removeBlock","setBlockPosition","setBlocksPositions","moveBlock","importBlocks","setCommentText","setSelector","setBlockSpec","addListInput","removeListInput","ringify","unringify","toggleBoolean","setColorField","setField","openProject");this.addUserActions("selectTab","selectSprite","toggleWatcher","toggleVariableWatcher","pressStart","stopAllScripts","startScript","setSpritePosition","togglePause")};
ActionManager.prototype.initializeRecords=function(){this.currentBatch=null;this.lastSeen=-1;this.lastSent=null;this.idCount=0;this.queuedActions=[];this.blockChildren={};this.blockToParent={};this.fieldValues={};this._owners={};this._blocks={};this._customBlocks={};this._customBlockOwner={};this._costumes={};this._costumeToOwner={};this._sounds={};this._soundToOwner={};this._targetOf={};this._targetFor={};this._blockToOwnerId={}};ActionManager.URL="ws://"+window.location.host;
ActionManager.prototype.enableCollaboration=function(){!1===this.supportsCollaboration&&this.ide().showMessage("Collaboration not supported");this._ws=new WebSocket(ActionManager.URL);this._enableCollaboration()};ActionManager.RECONNECT_INTERVAL=1500;
ActionManager.prototype._enableCollaboration=function(){var a=this;this._ws.readyState>WebSocket.OPEN&&(this._ws=new WebSocket(ActionManager.URL));this._ws.onopen=function(){logger.debug("websocket connected!");a.isLeader=!1;a.supportsCollaboration=!0};this._ws.onclose=function(){a.isLeader=!0;!0!==a.supportsCollaboration&&(a.supportsCollaboration=!1);a._ws&&(a.reconnectId=setTimeout(a._enableCollaboration.bind(a),ActionManager.RECONNECT_INTERVAL))};this._ws.onmessage=function(b){b=JSON.parse(b.data);
a.onMessage(b)}};ActionManager.prototype.disableCollaboration=function(){var a=this._ws;this.isCollaborating()&&(this._ws=null,a.close(),this.reconnectId&&clearTimeout(this.reconnectId),-1!==location.hash.indexOf("collaborate")&&(location.hash=""))};ActionManager.prototype.isCollaborating=function(){return null!==this._ws};
ActionManager.prototype.initialize=function(){this.serializer=new SnapSerializer;this.serializer.idProperty="actionSerializationID";this.supportsCollaboration=this._ws=null;this.isLeader=!0;this.isApplyingAction=!1;this.initializeRecords();this.initializeEventMethods()};
ActionManager.prototype.completeAction=function(a,b){var c=this.currentEvent;if(this.currentBatch){c=this.currentBatch.args.indexOf(c);if(c=this.currentBatch.args[c+1])return this._rawApplyEvent(c);c=this.currentBatch;this.currentBatch=null}this.isApplyingAction=!1;this.idCount=0;a||SnapUndo.record(c);if(this.isOwnAction(c)){var d=this.rejectPredecessorsInQueue(this._pendingLocalActions,c);d&&(a?d.reject(a):d.resolve(b))}this.afterActionApplied(c);this.currentEvent=null;this.queuedActions.length&&
this.isNextAction(this.queuedActions[0])&&setTimeout(this._applyEvent.bind(this),0,this.queuedActions.shift())};ActionManager.prototype.isOwnAction=function(a){return!a.user||a.user===this.id};ActionManager.prototype.isNextAction=function(a){return a.id===this.lastSeen+1};ActionManager.prototype.isPreviousAction=function(a){return a.id<this.lastSeen+1};ActionManager.prototype.isAlwaysAllowed=function(a){return"openProject"===a.type};
ActionManager.prototype.joinSession=function(a,b){SnapActions.id?this._joinSession(a,b):this.onconnect=this._joinSession.bind(this,a,b)};
ActionManager.prototype._joinSession=function(a,b){var c=new XMLHttpRequest;c.open("POST",window.location.origin+"/collaboration/join?id="+encodeURIComponent(SnapActions.id)+"&sessionId="+encodeURIComponent(a),!0);c.withCredentials=!0;c.onreadystatechange=function(){if(4===c.readyState&&0===c.responseText.indexOf("ERROR"))return b(c.responseText,"Collaborate")};c.send();this.onconnect=null};
function Action(a){this.id=a.id;this.data=a;this.reject=this.resolve=null;var b=this;this.promise=new Promise(function(c,d){b.resolve=c;b.reject=d})}Action.prototype.equals=function(a){var b=this;a instanceof Action&&(a=a.data);return["id","user","time"].reduce(function(c,d){return c&&a[d]===b.data[d]},!0)};
ActionManager.prototype.applyEvent=function(a){a.user=this.id;a.username=SnapCloud.username;a.id=this.lastSeen+1;a.time=a.time||Date.now();if(!a.replayType||this.lastSent!==a.id){var b=new Action(a);this.isUserAction(a)?this.submitAction(a):(this._attemptedLocalActions.push(b),this.submitIfAllowed(a));return b.promise}};
ActionManager.prototype.submitIfAllowed=function(a){var b=this,c=this.ide();if(this.isAlwaysAllowed(a))return this.submitAction(a);c.isReplayMode&&!a.isReplay?c.promptExitReplay(function(){b.submitIfAllowed(a)}):this.submitAction(a)};ActionManager.prototype._getMethodFor=function(a){return"on"+a.substring(0,1).toUpperCase()+a.substring(1)};ActionManager.prototype.acceptEvent=function(a){a.id=a.id||this.lastSeen+1;this.send(a);setTimeout(this.onReceiveAction.bind(this),0,a)};
ActionManager.prototype._isBatchEvent=function(a){return"batch"===a.type};
ActionManager.prototype.onReceiveAction=function(a){if(!this.isPreviousAction(a)||this.isAlwaysAllowed(a))if(this.isUserAction(a))SnapUndo.contains(a)||SnapUndo.record(a);else{if(this.isOwnAction(a)){var b=this.rejectPredecessorsInQueue(this._attemptedLocalActions,a);b?this._pendingLocalActions.push(b):console.error("missing local action for",a)}!this.isNextAction(a)&&!this.isAlwaysAllowed(a)||this.isApplyingAction?this.addActionToQueue(a):this._applyEvent(a)}};
ActionManager.prototype.rejectPredecessorsInQueue=function(a,b){var c=a.find(function(f){return f.equals(b)});if(c){for(var d=Error("Action Rejected (concurrent action accepted)."),e=a.shift();e!==c;)e.reject(d),e=a.shift();return c}console.error("could not find local action in queue",b)};
ActionManager.prototype.addActionToQueue=function(a){for(var b=0,c=this.queuedActions.length;b<c&&this.queuedActions[b].id<a.id;)b++;this.queuedActions[b]&&a.id===this.queuedActions[b].id||this.queuedActions.splice(b,0,a)};
ActionManager.prototype._applyEvent=function(a){logger.debug('received "'+a.type+'" event '+a.id+":",a);this.currentEvent=a;this.isApplyingAction=!0;this.lastSeen=this.currentEvent.id;this._isBatchEvent(a)?(this.currentBatch=a,this._rawApplyEvent(a.args[0])):(this.currentBatch=null,this._rawApplyEvent(a))};ActionManager.prototype._rawApplyEvent=function(a){var b=this._getMethodFor(a.type);this.currentEvent=a;try{this[b].apply(this,a.args)}catch(c){this.completeAction(c)}};
ActionManager.prototype.submitAction=function(a){this.isLeader||!this.isCollaborating()||this.isAlwaysAllowed(a)?this.acceptEvent(a):this.send(a)};ActionManager.prototype.send=function(a){var b=this._ws&&this._ws.readyState===WebSocket.OPEN;a.id=a.id||this.lastSeen+1;this.isUserAction(a)||(this.lastSent=a.id);this.isCollaborating()&&"openProject"!==a.type&&b&&this._ws.send(JSON.stringify(a))};
ActionManager.prototype.newId=function(){var a="item_"+this.lastSeen;0!==this.idCount&&(a+="_"+this.idCount);this.idCount++;return a};ActionManager.prototype.getId=function(a,b){for(var c="",d;!a.id;){d=a.parent instanceof SyntaxElementMorph;if(!d)return null;c=a.parent.inputs().indexOf(a)+"/"+c;a=a.parent;if(!a)throw Error("Cannot get id from element");}c=a.id+"/"+c;void 0!==b&&(c+=b+"/");return c};
ActionManager.prototype.serialize=function(a){a=this.serializer.serialize(a);this.serializer.flush();return a};ActionManager.prototype.serializeBlock=function(a,b,c){if(a.id&&!b)return a.id;if(a instanceof CommentMorph)return a.toXML(this.serializer);this.serializer.isSavingCustomBlockOwners=!1;a=c?"<script>"+a.toBlockXML(this.serializer)+"\x3c/script>":a.toScriptXML(this.serializer);this.serializer.flush();this.serializer.isSavingCustomBlockOwners=!0;return a};
ActionManager.prototype.deserializeBlock=function(a,b){this.serializer.project=this.ide();return"<"!==a[0]?this.getBlockFromId(a):0===a.indexOf("<script>")?this.serializer.loadScript(this.serializer.parse(a),b):this.serializer.loadComment(this.serializer.parse(a))};ActionManager.prototype.registerOwner=function(a,b){a.id=b||this.newId();this._owners[a.id]=a};ActionManager.prototype.getOwnerFromId=function(a){return this._owners[a]};
ActionManager.prototype.getBlockOwnerId=function(a){for(var b=a.id;!b&&a;)b=a.id,a=a.parent;return this._blockToOwnerId[b]};ActionManager.prototype._getStatementIds=function(a){for(var b=[];a;)b.push(a.id),a=a.nextBlock?a.nextBlock():null;return b};
ActionManager.prototype._addBlock=function(a,b,c){var d=b instanceof BlockEditorMorph?b.definition.id:b.id;b=this.convertToStandardPosition(b instanceof BlockEditorMorph?b.body.children[0]:b.scripts,c);this._idBlocks(a);c=this._getStatementIds(a);return[this.serializeBlock(a,!0),d,b.x,b.y,c]};ActionManager.prototype._replaceBlock=function(a,b){b.id=this.newId();return[this.serializeBlock(a,!0),this.serializeBlock(b,!0)]};
ActionManager.prototype._removeBlock=function(a,b){var c=this.serializeBlock(a,!0,b),d=a.parentThatIsA(ScriptsMorph)?this.getStandardPosition(a):this.getLastGrabPosition(),e=this._targetOf[a.id],f=this._blockToOwnerId[a.id];b=[a.id,b];!e||ActionManager.isWeakTarget(e)&&d?d&&b.push(d.y,d.x,f,c):b.push(this._targetOf[a.id],c);c=[];if(this._targetFor[a.id])for(d=Object.keys(this._targetFor[a.id]),e=d.length;e--;)c.push([d[e],this._targetFor[a.id][d[e]]]);b.push(c);return b};
ActionManager.isWeakTarget=function(a){return"top"===a.loc||"wrap"===a.loc};ActionManager.prototype._getBlockState=function(a,b){b=void 0===b?!0:b;var c=this._targetOf[a],d=!this._blocks[a],e=this.getStandardPosition(this.getBlockFromId(a));b=b?this.getLastGrabPosition()||e:e;c=d?[]:c&&!ActionManager.isWeakTarget(c)?[c]:[b.x,b.y];c.unshift(a);return c};ActionManager.prototype._setBlockPosition=function(a,b){var c=a.id;a=this.getStandardPosition(a,b);b=this._getBlockState(c);return[c,a.x,a.y,b]};
ActionManager.prototype._setBlocksPositions=function(a,b){var c=[],d=[],e;for(e=a.length;e--;)b[e]||(a.splice(e,1),b.splice(e,1));for(e=0;e<a.length;e++){var f=this.getBlockFromId(a[e]);var g=f.parentThatIsA(ScriptsMorph);d.push(this.getStandardPosition(f));c.push(this.convertToStandardPosition(g,b[e]))}return[a,c,d]};ActionManager.prototype._addCustomBlock=function(a,b){a.id=this.newId();var c=this.serialize(a);a.isGlobal&&(b=this.ide().stage);return[b.id,c,a.isGlobal]};
ActionManager.prototype._deleteCustomBlock=function(a){var b=this._customBlockOwner[a.id],c=this.serialize(a);return[a.id,b.id,c,a.isGlobal]};ActionManager.prototype._deleteCustomBlocks=function(a){for(var b=[],c=[],d=a.length;d--;)b.push(this.serialize(a[d])),c.push(a[d].id);b="<blocks>"+b.join("")+"</blocks>";return[c,b]};ActionManager.prototype._importBlocks=function(a,b){a=this.assignUniqueIds(a);var c=a.children.map(function(d){return d.attributes.collabId});a=a.toString();return[a,b,c]};
ActionManager.prototype._setCustomBlockType=function(a,b,c){return[a.id,b,c,a.category,a.type]};ActionManager.prototype._deleteBlockLabel=function(a,b){var c=b.parent.children.indexOf(b);return[a.id,c,b.fragment.type,b.fragment.labelString]};
ActionManager.prototype._updateBlockLabel=function(a,b,c){var d=b.parent.children.indexOf(b);console.assert(-1<d,"Cannot find the fragment!");return[a.id,d,c.type,c.labelString,c.defaultValue,c.options,c.isReadOnly,b.fragment.type,b.fragment.labelString,b.fragment.defaultValue,b.fragment.options,b.fragment.isReadOnly]};ActionManager.prototype._startScript=function(a,b){return[a.id,!b]};ActionManager.prototype._setSpritePosition=function(a){return[a.id,a.xPosition(),a.yPosition()]};
ActionManager.prototype._setStageSize=function(a,b){return[a,b,StageMorph.prototype.dimensions.y,StageMorph.prototype.dimensions.x]};ActionManager.prototype._serializeMoveTarget=function(a,b){a instanceof CommandBlockMorph?b.element=b.element.id?b.element.id:b.element instanceof PrototypeHatBlockMorph?b.element.definition.id:this.getId(b.element):b=a instanceof ReporterBlockMorph?this.getId(b):b.id;return b};
ActionManager.prototype._getSpliceEvent=function(a){if("top"===a.loc){var b=a.element.parent instanceof BlockMorph?a.element.parent:null;var c=a.element}else"bottom"===a.loc&&(b=a.element,c="slot"===a.type?a.element.nestedBlock():a.element.nextBlock());return b&&c?{type:"moveBlock",args:[c.id,a]}:null};
ActionManager.prototype._moveBlock=function(a,b,c){var d=!a.id;if(b instanceof ReporterBlockMorph)var e=[this.serializeBlock(b,b instanceof RingMorph),this._getCurrentTarget(b)];else if("top"===b.loc||"wrap"===b.loc)var f=this._getBlockState(b.element.id,!1);var g=this._getSpliceEvent(b);b=this._serializeMoveTarget(a,b);d&&this._idBlocks(a);var h=[this.serializeBlock(a,d),b];h.push(g);d?(c=this._getStatementIds(a),c=[c],a.destroy()):c?(b=a.parentThatIsA(ScriptsMorph),c=this.convertToStandardPosition(b,
c),c=[a.id,c.x,c.y]):(a="top"===b.loc?a.topBlock().id:a.id,c=this._getBlockState(a));h.push(c);e?h.push(e):f&&h.push(f);return h};ActionManager.prototype._setField=function(a,b){var c=this.getId(a);a=a.contents().text;return[c,b,a]};ActionManager.prototype._setColorField=function(a,b){a=this.getId(a);return[a,b,this.fieldValues[a]]};ActionManager.prototype._toggleBoolean=function(a,b){var c=!1,d=this.getId(a);a.isStatic?c=!b:!0===b?c=null:!1===b&&(c=!0);return[d,b,c]};
ActionManager.prototype._setCommentText=function(a,b){return[a.id,b,a.lastValue]};ActionManager.prototype._unringify=function(a){for(var b=this.getParentWithId(a),c=b.parentThatIsA(RingMorph);b!==c;)a=b,b=this.getParentWithId(a);return[a.id,c.id]};ActionManager.prototype.getParentWithId=function(a){for(;a.parent&&!a.parent.id;)a=a.parent;return a.parent};
ActionManager.prototype._ringify=function(a){for(var b=this.newId(),c=this.getParentWithId(a);c instanceof RingMorph;)a=c,c=this.getParentWithId(a);return[a.id,b]};ActionManager.prototype._setSelector=function(a,b){return[this.getId(a),b,a.selector]};ActionManager.prototype._setBlockSpec=function(a,b){return[this.getId(a),b,a.blockSpec]};ActionManager.prototype._toggleDraggable=function(a,b){return[a.id,b]};ActionManager.prototype._setRotationStyle=function(a,b){return[a.id,b,a.rotationStyle]};
ActionManager.prototype._addListInput=ActionManager.prototype._removeListInput=function(a,b){return[this.getId(a),b]};ActionManager.prototype._addSound=function(a,b,c){a.id=this.newId();10<2*a.audio.src.length/1E6&&(logger.error("audio file is too big",a),this.ide().simpleNotification("Audio file is too big."),a.audio.src=SERVER_URL+"/Sounds/Meow.wav",a.name="BigFileError");a=[a.toXML(this.serializer).replace("~",""),b.id];c&&a.push(this.id);return a};
ActionManager.prototype._removeSound=function(a){return[a.id,a.toXML(this.serializer).replace("~",""),this._soundToOwner[a.id].id]};ActionManager.prototype._renameSound=function(a,b){return[a.id,b,a.name]};ActionManager.prototype._addCostume=function(a,b,c){a.id=this.newId();a=[a.toXML(this.serializer).replace("~",""),b.id];c&&a.push(this.id);return a};ActionManager.prototype._removeCostume=function(a){return[a.id,a.toXML(this.serializer).replace("~",""),this._costumeToOwner[a.id].id]};
ActionManager.prototype._renameCostume=function(a,b){return[a.id,b,a.name]};ActionManager.prototype._updateCostume=function(a,b){return[b.id,b.toXML(this.serializer).replace("~",""),a.toXML(this.serializer).replace("~","")]};ActionManager.prototype._addSprite=function(a){var b=this.ide().stage;a.parent=b;a.id=this.newId();return["<sprites>"+this.serialize(a)+"</sprites>",this.id,a.id]};ActionManager.prototype._attachParts=function(a,b){b=b.map(function(c){return c.id});return[a.id,b]};
ActionManager.prototype._detachParts=function(a){var b=a.map(function(c){return c.id});a=a.map(function(c){return c.anchor?c.anchor.id:null});return[b,a]};ActionManager.prototype._openProject=function(a){this.initializeRecords();return[a]};ActionManager.prototype.assignUniqueIds=function(a){a=this.serializer.parse(a);for(var b=a.allChildren(),c=b.length;c--;)b[c].attributes&&(b[c].attributes.collabId=this.newId());return a};
ActionManager.prototype._removeSprite=function(a){var b="<sprites>"+this.serialize(a)+"</sprites>";return[a.id,b]};ActionManager.prototype._renameSprite=function(a,b){return[a.id,b,a.name]};
ActionManager.prototype._duplicateSprite=function(a){var b=this.newId(),c='collabId="'+b+'"',d=a.copy(),e=this.ide();d.id=b;d.setName(e.newSpriteName(a.name));d.parent=e.stage;a=this.serialize(d);a=this.assignUniqueIds(a).toString();a="<sprites>"+a.replace(/collabId="item_[0-9_]*"/,c)+"</sprites>";return[a,null,b]};ActionManager.prototype._importSprites=function(a){a=this.assignUniqueIds(a);var b=a.children.map(function(c){return c.attributes.collabId});a=a.toString();return[a,b]};
ActionManager.prototype._onSetBlockPosition=function(a,b,c,d){var e=this,f=new Point(b,c),g=this.getBlockFromId(a),h=function(){e.disconnectBlock(g,m);g.justDropped&&g.justDropped();g.changed();g.removeShadow();e.updateCommentsPositions(g);e.__updateBlockDefinitions(g);e.__updateActiveEditor(g.id);d()};this.ensureNotDragging(g);if(this._targetFor[a]){f=Object.keys(this._targetFor[a]);for(var k=f.length;k--;){var l=this._targetFor[a][f[k]];"top"===l.loc&&this.__clearTarget(this.__targetId(l))}}this.__clearTarget(a);
console.assert(g,'Block "'+a+'" does not exist! Cannot set position');f=new Point(b,c);if(a=g.parentThatIsA(BlockEditorMorph))var m=a.body.contents;m=g.parentThatIsA(ScriptsMorph);f=this.getAdjustedPosition(f,m);this.canAnimate(this.getBlockOwnerId(g))?g.glideTo(f,null,null,function(){try{h()}catch(n){d(n)}}):(g.setPosition(f),h())};
ActionManager.prototype.onSetBlocksPositions=function(a,b){for(var c=this,d=0,e=function(){d++;d===a.length&&c.completeAction()},f=a.length;f--;)this._onSetBlockPosition(a[f],b[f].x,b[f].y,e)};ActionManager.prototype.getLastGrabPosition=function(){var a=this.ide().root().hand;return a.grabOrigin&&a.grabOrigin.position};ActionManager.prototype.getStandardPosition=function(a,b){var c=a.parentThatIsA(ScriptsMorph);b=b||a.position();return this.convertToStandardPosition(c,b)};
ActionManager.prototype.convertToStandardPosition=function(a,b){var c=SyntaxElementMorph.prototype.scale;return b=b.subtract(a.topLeft()).divideBy(c)};ActionManager.prototype.getAdjustedPosition=function(a,b){return a=a.multiplyBy(SyntaxElementMorph.prototype.scale).add(b.topLeft())};ActionManager.prototype._idBlocks=function(a,b){var c=this,d=[];this.traverse(a,function(e){e.isDraggable=!0;e.isTemplate=!1;e.id=c.newId();d.push(e.id)});return b?d:a};
ActionManager.prototype.registerBlocks=function(a,b,c){var d=this;this.traverse(a,function(e){d._registerBlockState(e,c);d._blockToOwnerId[e.id]=b});return a};ActionManager.prototype.onReplaceBlock=function(a,b){var c=this;a=this.deserializeBlock(a);var d=this._blockToOwnerId[a.id];var e=this.getStandardPosition(a);this._onRemoveBlock(a.id,!0,function(f){if(f)return c.completeAction(f);c._onAddBlock(b,d,e.x,e.y,function(g,h){c.completeAction(g,h)})})};
ActionManager.prototype._onAddBlock=function(a,b,c,d,e){var f=this,g=this.ide(),h=this.getOwnerFromId(b);c=new Point(c,d);var k=function(){l.fixChildrensBlockColor&&l.fixChildrensBlockColor(!0);l.allComments&&l.allComments().forEach(function(m){m.align(l)});f.registerBlocks(l,h.id);f.__updateScriptsMorph(l);f.__updateActiveEditor(l.id);e(null,l)};var l=this.deserializeBlock(a,h);l.snapSound&&l.snapSound.play();this._customBlocks[b]?(a=this._getCustomBlockEditor(b),d=a.body.contents,c=this.getAdjustedPosition(c,
d),l.setPosition(c),d.add(l),a.updateDefinition(),h=this._customBlocks[b],k()):(c=this.getAdjustedPosition(c,h.scripts),this.canAnimate(h.id)?(b=g.palette,l.setPosition(b.position().add(new Point(b.left()-l.width(),b.height()/4))),b.add(l),l.glideTo(c,null,null,function(){try{h.scripts.add(l),k()}catch(m){e(m)}})):(l.setPosition(c),h.scripts.add(l),l.changed(),k()));"receiveCondition"===l.selector&&(b=g.stage)&&(b.enableCustomHatBlocks=!0,b.threads.pauseCustomHatBlocks=!1,g.controlBar.stopButton.refresh())};
ActionManager.prototype.onAddBlock=function(a,b,c,d){var e=this;this._onAddBlock(a,b,c,d,function(f,g){e.completeAction(f,g)})};ActionManager.prototype.world=function(){var a=Object.keys(this._owners)[0];return(a=this._owners[a])?a.parentThatIsA(WorldMorph):null};ActionManager.prototype.isEditorOpen=function(a){var b=this.world()?this.world().children:[];return!!detect(b,function(c){return c instanceof BlockEditorMorph&&c.definition.id===a})};
ActionManager.prototype._getCustomBlockEditor=function(a,b){var c=this.world()?this.world().children:[],d=this._customBlockOwner[a],e=this._customBlocks[a];c=detect(c,function(f){return f instanceof BlockEditorMorph&&f.definition.id===a});!c&&e&&(b&&(c=b.parentThatIsA(BlockEditorMorph)),c||(c=new BlockEditorMorph(e,d),c.popUp(!0),c.setInitialDimensions(!0),c.destroy()));return c};
ActionManager.prototype.getBlockFromId=function(a){a=a.split("/");var b=a.shift(),c=this._blocks[b],d;this._customBlocks[b]&&(c=this._getCustomBlockEditor(b).body.contents.children.find(function(h){return h instanceof PrototypeHatBlockMorph}));if(d=c.parentThatIsA(BlockEditorMorph)){var e=!1;var f=d.definition.id;f=this._getCustomBlockEditor(f);if(d!==f)for(d=f.body.contents.children.slice();!e&&d.length;){f=[];for(var g=d.length;g--;)if(d[g]){if(d[g].id===b){this._blocks[b]=d[g];c=this._blocks[b];
e=!0;break}d[g].inputs&&(f=f.concat(d[g].inputs()));d[g].nextBlock&&f.push(d[g].nextBlock())}d=f}}for(g=0;g<a.length;g++)a[g]&&(c=c.inputs()[a[g]]);return c};
ActionManager.prototype.onMoveBlock=function(a,b){var c=this,d=this.deserializeBlock(a),e=!this._blocks[d.id],f=null,g=copy(b),h=!1;this.ensureNotDragging(d);this.__recordTarget(d.id,b);if(d instanceof CommandBlockMorph){g.element=this.getBlockFromId(g.element);var k=g.element;f="bottom"===g.loc?k.nextBlock&&k.nextBlock():k;d.parent&&("bottom"===g.loc||"wrap"===g.loc?this.disconnectBlock(d,m):"top"!==g.loc||d.parent instanceof ScriptsMorph||this.disconnectBlock(d,m));g.point=new Point(g.point.x,g.point.y)}else d instanceof
ReporterBlockMorph||d instanceof CommentMorph?(this.disconnectBlock(d,m),k=g=this.getBlockFromId(g),g instanceof RingMorph&&this.__clearBlockRecords(g.id)):logger.error('Unsupported "onMoveBlock":',d);this.ensureNotDragging(k);var l=this.getBlockOwnerId(k);var m=k.parentThatIsA(ScriptsMorph);d instanceof ReporterBlockMorph&&g instanceof ReporterBlockMorph&&this.__recordTarget(d.id,this._getCurrentTarget(g));h=!m;m=m||this.getOwnerFromId(l).scripts;var n=function(){e&&!h?m.add(d):d.parent&&d.parent.reactToGrabOf&&
d.parent.reactToGrabOf(d);d.snap(g);h||m.rerender();e&&c.registerBlocks(d,l);g instanceof ReporterBlockMorph&&c.__clearTarget(g.id);ActionManager.isWeakTarget(g)&&d.topBlock();f&&c.__recordTarget(f.id,c._getCurrentTarget(f));d.fixChildrensBlockColor&&d.fixChildrensBlockColor(!0);c.updateCommentsPositions(d);c.__updateBlockDefinitions(d);c.__updateActiveEditor(d.id);c.__updateScriptsMorph(d);c.completeAction(null,d)};e&&(this.ide().palette.add(d),d.setPosition(this.blockInitPosition()));this.canAnimate(l)?
(a=this.computeMovePosition(d,g),d.glideTo(a,null,null,function(){try{n()}catch(q){c.completeAction(q)}})):n()};
ActionManager.prototype.computeMovePosition=function(a,b){if(a instanceof CommandBlockMorph){var c=b.element;if("bottom"===b.loc)return"slot"===b.type?c instanceof CSlotMorph?new Point(c.left()+c.inset,c.top()+c.corner):new Point(c.left()+c.edge+c.rfBorder,c.top()+c.edge+c.rfBorder):new Point(b.element.left(),b.element.bottom()-b.element.corner);if("top"===b.loc)return b=a.bottomBlock().bottom()-a.bottom(),new Point(c.left(),c.top()+a.corner-b-a.height());if("wrap"===b.loc)return c=detect(a.inputs(),
function(f){return f instanceof CSlotMorph}),a.position().add(b.point.subtract(c.slotAttachPoint()))}else{if(a instanceof ReporterBlockMorph)return b instanceof CommandSlotMorph&&(a=b.nestedBlock())?a.position().add(a.extent()):b.position();c=b.topBlock();var d=b.top()+b.corner;var e=d+a.height();a=c.allChildren().filter(function(f){return f instanceof BlockMorph&&f.bottom()>d&&f.top()<e});a=Math.max.apply(null,a.map(function(f){return f.right()}));return new Point(a+5,d)}};
ActionManager.prototype.blockInitPosition=function(){var a=this.ide().palette;return new Point(a.width()/2,a.height()/4)};
ActionManager.prototype.ensureNotDragging=function(a){var b=a.parentThatIsA(HandMorph);if(b){var c=b.grabOrigin;a=b.children[0];a.cachedFullImage=null;a.cachedFullBounds=null;a.changed();a.removeShadow();b.children=[];b.destroyTemporaries();b.contextMenuEnabled=!0;b.morphToGrab=null;b.grabPosition=null;a.justDropped(b);a.setPosition(c.origin.position().add(c.position));c.origin.add(a);a.justDropped&&a.justDropped();c.origin.reactToDropOf&&c.origin.reactToDropOf(a)}};
ActionManager.prototype._onRemoveBlock=function(a,b,c){var d=this,e=this.getBlockFromId(a),f=b&&e.userDestroy?"userDestroy":"destroy";this.ensureNotDragging(e);b=e.parentThatIsA(ScriptsMorph);var g=e.parent;if(e){e.prepareToBeGrabbed&&e.prepareToBeGrabbed(this.world().hand);var h=e;"userDestroy"===f&&(h=e.inputs().map(function(k){return!k.id&&k.children?k.children:[k]}).reduce(function(k,l){return k.concat(l)},[]),this.__clearBlockRecords(a));this.traverse(h,function(k){d.__clearBlockRecords(k.id)});
a=e.nextBlock&&e.nextBlock();!this.canAnimate(this.getBlockOwnerId(e))||"destroy"!==f&&a?(e[f](),d.__updateBlockDefinitions(e),c()):(a=this.ide().palette,delete e.id,a.add(e),e.glideTo(this.blockInitPosition(),null,null,function(){try{e[f](),d.__updateBlockDefinitions(e),c()}catch(k){c(k)}}));g&&(g.reactToGrabOf&&g.reactToGrabOf(e),g.fixLayout&&g.fixLayout(),g.changed());b&&b.rerender()}};ActionManager.prototype.onRemoveBlock=function(a,b){var c=this;this._onRemoveBlock(a,b,function(){c.completeAction()})};
ActionManager.prototype.canAnimate=function(a){return(this.getOwnerFromId(a)===this.ide().currentSprite||this.isEditorOpen(a))&&(this.ide().isReplayMode||this.currentEvent.replayType||this.currentEvent.user!==this.id)};ActionManager.prototype.__updateScriptsMorph=function(a){if(a=a.parentThatIsA(ScriptsMorph))a.adjustBounds(),a.rerender()};
ActionManager.prototype.__updateBlockDefinitions=function(a){var b=this;if(a=a.parentThatIsA(BlockEditorMorph))a.updateDefinition(),a.body.contents.children.forEach(function(c){var d=function(e){return b._blocks[e.id]=e};c instanceof PrototypeHatBlockMorph?(c=c.nextBlock())&&b.traverse(c,d):b.traverse(c,d)})};ActionManager.prototype.onSetBlockPosition=function(a,b,c){var d=this;this._onSetBlockPosition(a,b,c,function(){d.completeAction()})};
ActionManager.prototype.updateCommentsPositions=function(a){if(a.topBlock){var b=a.topBlock();b.allComments().forEach(function(c){c.align(b)})}};ActionManager.prototype.getFieldValue=function(a,b){a=this.getId(a,b);return this.fieldValues[a]instanceof StringMorph?this.fieldValues[a].text:this.fieldValues[a]};
ActionManager.prototype.disconnectBlock=function(a,b){var c=a.parent;b=b||a.parentThatIsA(ScriptsMorph);a.prepareToBeGrabbed(this.world().hand);!c||c instanceof ScriptsMorph||(b.add(a),c.reactToGrabOf&&c.reactToGrabOf(a),c.fixLayout&&c.fixLayout(),c.changed(),b&&b.rerender());a.fixBlockColor&&a.fixBlockColor()};
ActionManager.prototype.onAddListInput=function(a,b){a=this.getBlockFromId(a);this.ensureNotDragging(a);b=b||1;for(var c=0;c<b;c++)a.addInput();this.__updateScriptsMorph(a);this.__updateBlockDefinitions(a);this.completeAction()};ActionManager.prototype.onRemoveListInput=function(a,b){a=this.getBlockFromId(a);this.ensureNotDragging(a);b=b||1;for(var c=0;c<b;c++)a.removeInput();a.changed();this.__updateScriptsMorph(a);this.__updateBlockDefinitions(a);this.completeAction()};
ActionManager.prototype.onSetBlockSpec=function(a,b){a=this.getBlockFromId(a);this.ensureNotDragging(a);a.userSetSpec(b);this.__updateBlockDefinitions(a);this.completeAction()};ActionManager.prototype.onSetField=function(a,b){var c=this.getBlockFromId(a);console.assert(c instanceof InputSlotMorph,"Unexpected block type: "+c.constructor);this.ensureNotDragging(c);this.fieldValues[a]=b;c.setContents(b);this.__updateBlockDefinitions(c);this.completeAction()};
ActionManager.prototype.onSetColorField=function(a,b){var c=this.getBlockFromId(a);this.ensureNotDragging(c);b=b||{};b=new Color(b.r,b.g,b.b,b.a);c.setColor(b);this.fieldValues[a]=b;this.__updateBlockDefinitions(c);this.completeAction()};ActionManager.prototype.onSetCommentText=function(a,b){a=this.getBlockFromId(a);this.ensureNotDragging(a);a.contents.text=b;a.contents.rerender();a.layoutChanged();a.lastValue=b;this.__updateBlockDefinitions(a);this.completeAction()};
ActionManager.prototype.onSetSelector=function(a,b){a=this.getBlockFromId(a);var c=this;this.ensureNotDragging(a);a.setSelector(b);a.changed();this.traverse(a,function(d){c._blocks[d.id]=d});this.__updateBlockDefinitions(a);this.completeAction()};
ActionManager.prototype.onAddVariable=function(a,b){var c="true"===b.toString();b=c?this._owners[Object.keys(this._owners)[0]]:this._owners[b];b.addVariable(a,c);b.showingVariableWatcher(a,c)||b.toggleVariableWatcher(a,c,!0);a=b.parentThatIsA(IDE_Morph);a.flushBlocksCache("variables");a.refreshPalette();this.completeAction()};ActionManager.prototype.onDeleteVariable=function(a,b){("true"===b.toString()?this._owners[Object.keys(this._owners)[0]]:this._owners[b]).deleteVariable(a);this.completeAction()};
ActionManager.prototype.onRingify=function(a,b){a=this.getBlockFromId(a);var c=this._blockToOwnerId[a.id];if(a){this.ensureNotDragging(a);var d=a.ringify();d.parentThatIsA(ScriptsMorph);d.id=b;this._blocks[d.id]=d;this._blockToOwnerId[d.id]=c;a instanceof ReporterBlockMorph&&this._targetOf[a.id]&&(this.__recordTarget(d.id,this._targetOf[a.id]),b=this.getId(a.parent,a.parent.inputs().indexOf(a)),this.__recordTarget(a.id,b))}this.__updateBlockDefinitions(a);this.completeAction()};
ActionManager.prototype.onUnringify=function(a){if(a=this.getBlockFromId(a)){this.ensureNotDragging(a);var b=a.unringify();delete this._blocks[b.id]}this.__updateBlockDefinitions(a);this.completeAction()};ActionManager.prototype.onToggleBoolean=function(a,b){a=this.getBlockFromId(a);for("boolean"!==typeof b&&(b=null);c!==b;){var c=a.value;a.toggleValue()}isNil(a.value)||a.reactToSliderEdit();this.__updateBlockDefinitions(a);this.completeAction()};
ActionManager.prototype.onAddCustomBlock=function(a,b,c){a=this._owners[a];var d=this.ide();b=this.serializer.loadCustomBlock(this.serializer.parse(b));b.receiver=a;(b.isGlobal=c)?(a.globalBlocks.push(b),d.currentSprite.paletteCache={}):a.customBlocks.push(b);this.loadCustomBlocks([b],a);a.paletteCache={};d.refreshPalette();this.completeAction(null,b)};ActionManager.prototype.onDeleteCustomBlocks=function(a){var b=this,c=this.ide().stage.id;a.forEach(function(d){b._onDeleteCustomBlock(d,c)});this.completeAction()};
ActionManager.prototype._onDeleteCustomBlock=function(a,b){a=this._customBlocks[a];b=this._owners[b];b.deleteAllBlockInstances(a);if(a.isGlobal){var c=this.ide().stage;a=c.globalBlocks.indexOf(a);-1!==a&&c.globalBlocks.splice(a,1)}else if(a=b.customBlocks.indexOf(a),-1!==a){var d=b.customBlocks[a];c=d.blockSpec();b.allDependentInvocationsOf(c).forEach(function(e){return e.refresh(d)});b.customBlocks.splice(a,1)}if(b=b.parentThatIsA(IDE_Morph))b.flushPaletteCache(),b.refreshPalette()};
ActionManager.prototype.onDeleteCustomBlock=function(a,b){this._onDeleteCustomBlock(a,b);this.completeAction()};ActionManager.prototype._getCustomCmdBlock=function(a){a=this._getCustomBlockEditor(a).body.contents;a=detect(a.children,function(c){return c instanceof PrototypeHatBlockMorph});var b=a.inputs()[0];console.assert(1===a.inputs().length);return b};ActionManager.prototype._getFragment=function(a,b){return this._getCustomCmdBlock(a).children[b]};
ActionManager.prototype.onUpdateBlockLabel=function(a,b,c,d,e,f,g){d=new BlockLabelFragment(d);a=this._getFragment(a,b);b=a.parentThatIsA(BlockEditorMorph);d.type=c;d.options=f||"";d.defaultValue=e||"";d.isReadOnly=!!g;a.updateBlockLabel(d);b.updateDefinition();this.completeAction()};ActionManager.prototype.onDeleteBlockLabel=function(a,b){a=this._getFragment(a,b);b=a.parentThatIsA(BlockEditorMorph);a.fragment.isDeleted=!0;a.updateBlockLabel(a.fragment);b.updateDefinition();this.completeAction()};
ActionManager.prototype.onSetCustomBlockType=function(a,b,c){var d=this._getCustomCmdBlock(a),e=d.parentThatIsA(PrototypeHatBlockMorph),f=d.parentThatIsA(BlockEditorMorph);a=this._customBlocks[a];e.blockCategory=a.category=b;e.type=a.type=c;f.updateDefinition();d.refreshPrototype();this.completeAction()};ActionManager.prototype.ide=function(){return this.__ide};
ActionManager.prototype._loadCostume=function(a,b){a=this.serializer.parse(a);var c=this.serializer.loadValue(a);a=function(){c.loaded=!0;d&&d();b(c)};if(!0===c.loaded)a();else{var d=c.loaded;c.loaded=a}};ActionManager.prototype.onDuplicateSprite=ActionManager.prototype.onAddSprite=function(a,b){var c=this.ide();a=this.serializer.loadSprites(a,c);a=a[a.length-1];b===this.id&&c.selectSprite(a);this.completeAction(null,a)};
ActionManager.prototype.onAttachParts=function(a,b){var c=this,d=this.getOwnerFromId(a),e;b.forEach(function(f){e=c.getOwnerFromId(f);d.attachPart(e)});this.completeAction()};ActionManager.prototype.onDetachParts=function(a){var b=this,c;a.forEach(function(d){c=b.getOwnerFromId(d);c.detachFromAnchor()});this.completeAction()};ActionManager.prototype.onRemoveSprite=function(a){var b=this._owners[a];this.ide().removeSprite(b);this.__clearOwnerRecords(a);this.completeAction()};
ActionManager.prototype.onRenameSprite=function(a,b){a=this._owners[a];var c=this.ide();a.setName(b);c.currentSprite===a&&c.spriteBar.nameField.setContents(b);this.completeAction(null,b)};ActionManager.prototype.onToggleDraggable=function(a,b){a=this._owners[a];var c=this.ide();a.isDraggable=b;c.currentSprite===a&&c.spriteBar.padlock.refresh();this.completeAction()};ActionManager.prototype._registerCostume=function(a,b){this._costumes[a.id]=a;this._costumeToOwner[a.id]=b};
ActionManager.prototype.onAddCostume=function(a,b,c){var d=this,e=this.ide(),f=this._owners[b];this._loadCostume(a,function(g){f.addCostume(g);e.spriteEditor instanceof WardrobeMorph&&e.spriteEditor.updateList();e&&e.currentSprite===f&&e.currentSprite.wearCostume(g);d._registerCostume(g,f);c===d.id&&e.spriteBar.tabBar.tabTo("costumes");d.__updateActiveEditor();d.completeAction(null,g)})};
ActionManager.prototype.onUpdateCostume=function(a,b){var c=this.ide(),d=this._costumeToOwner[a],e=this,f=c.parentThatIsA(WorldMorph);this._loadCostume(b,function(g){var h=e._costumes[a];h.rotationCenter=g.rotationCenter;h.contents=g.contents;h.version=Date.now();f.changed();c.currentSprite===d&&c.currentSprite.wearCostume(h);c.hasChangedMedia=!0});this.__updateActiveEditor(a);this.completeAction()};
ActionManager.prototype.onRemoveCostume=function(a){var b=this._costumes[a],c=this._costumeToOwner[a],d=this.ide().spriteEditor,e=c.costumes.asArray().indexOf(b);d instanceof WardrobeMorph?d.removeCostumeAt(e+1):c.costumes.remove(e+1);c.costume===b&&c.wearCostume(null);this.__updateActiveEditor(a);this.__clearCostumeRecords(a);this.completeAction()};
ActionManager.prototype.onRenameCostume=function(a,b){var c=this._costumes[a],d=this.ide();c.name=b;c.version=Date.now();d.hasChangedMedia=!0;this.__updateActiveEditor(a);this.completeAction(null,c)};
ActionManager.prototype.onAddSound=function(a,b,c){b=this._owners[b];a=this.serializer.loadValue(this.serializer.parse(a));var d=this.ide();b.addSound(a);d.hasChangedMedia=!0;this._sounds[a.id]=a;this._soundToOwner[a.id]=b;c===this.id&&d.spriteBar.tabBar.tabTo("sounds");d.currentSprite===b&&d.spriteEditor instanceof JukeboxMorph&&d.spriteEditor.updateList();this.__updateActiveEditor(a.id);this.completeAction()};
ActionManager.prototype.onRenameSound=function(a,b){var c=this._sounds[a],d=this.ide();c.name=b;c.version=Date.now();d.spriteEditor instanceof JukeboxMorph&&d.spriteEditor.updateList();d.hasChangedMedia=!0;this.__updateActiveEditor(a);this.completeAction()};
ActionManager.prototype.onRemoveSound=function(a){var b=this._soundToOwner[a],c=this.ide(),d=b.sounds.asArray().indexOf(this._sounds[a])+1;b.sounds.remove(d);c.spriteEditor instanceof JukeboxMorph&&c.spriteEditor.updateList();this.__updateActiveEditor(a);this.__clearSoundRecords(a);this.completeAction()};ActionManager.prototype.onSetStageSize=function(a,b){this.ide().setStageExtent(new Point(a,b));this.completeAction()};
ActionManager.prototype.onSetRotationStyle=function(a,b){a=this._owners[a];a.rotationStyle=b;a.changed();a.fixLayout();a.rerender();this.ide().rotationStyleButtons.forEach(function(c){c.refresh()});this.completeAction()};ActionManager.prototype.onImportSprites=function(a){this.ide().rawOpenSpritesString(a);this.completeAction()};ActionManager.prototype.onImportBlocks=function(a,b){a=this.ide().rawOpenBlocksString(a,b,!0);this.completeAction(null,a)};
ActionManager.prototype.onOpenProject=function(a){var b=this,c,d,e,f,g,h,k;return $jscomp.asyncExecutePromiseGeneratorProgram(function(l){if(1==l.nextAddress){c=b;d=null;e=b.currentEvent;f=b.ide();SnapUndo.reset();b.initializeRecords();a?0===a.indexOf("<project")?d=b.ide().rawOpenProjectString(a):0===a.indexOf("<snapdata")&&(d=b.ide().rawOpenCloudDataString(a)):b.ide().newRole();f.sprites.asArray().concat(f.stage).forEach(function(m){return c.loadOwner(m)});b.lastSeen=e.id;b.completeAction(null,d);
if(b.ide().isReplayMode)return l.jumpTo(0);g=SnapUndo.allEvents.length;e===SnapUndo.allEvents[g-1]&&SnapUndo.allEvents.pop();d&&void 0!==d.collabStartIndex&&(b.lastSeen=d.collabStartIndex);h=b.ide().room.name;k=b.ide().projectName;return l.yield(SnapCloud.setClientState(h,k,b.lastSeen),3)}b.requestMissingActions();l.jumpToEnd()})};
ActionManager.prototype._getCurrentTarget=function(a){var b=a.parent;if(b instanceof BlockMorph||b instanceof CommandSlotMorph)if(a instanceof CommandBlockMorph){if(b.nextBlock&&b.nextBlock()===a)return this._serializeMoveTarget(a,{point:b.bottomAttachPoint(),element:b,loc:"bottom",type:"block"});if(b instanceof CommandSlotMorph)return this._serializeMoveTarget(a,{point:b.slotAttachPoint(),element:b,loc:"bottom",type:"slot"})}else{if(a instanceof ReporterBlockMorph){var c=a.id;a.id=null;b=this.getId(a);
a.id=c;return b}}else if(a instanceof CommentMorph&&a.block)return a.block.id;return null};
ActionManager.prototype._registerBlockState=function(a,b){var c=this,d,e,f;a instanceof PrototypeHatBlockMorph||a.isPrototype||(this.__assignUniqueBlockId(a,b),this._blocks[a.id]=a,b=this._getCurrentTarget(a),a.parentThatIsA(ScriptsMorph),b&&this.__recordTarget(a.id,b),a.inputs&&a.inputs().forEach(function(g){if(e=g.contents&&g.contents())f=e.value||e,g instanceof BlockMorph||void 0===f||(d=c.getId(g),c.fieldValues[d]=f),g instanceof ColorSlotMorph&&(d=c.getId(g),c.fieldValues[d]=g.color)}))};
ActionManager.prototype.__assignUniqueBlockId=function(a,b){var c;a.id=a.id||this.newId();if(this._blocks[a.id]&&this._blocks[a.id]!==a){for(c=a.id;this._blocks[a.id]&&this._blocks[a.id]!==a;)a.id=this.newId();b||console.warn("Block id "+c+" already used. Reissuing id "+a.id)}};
ActionManager.prototype.loadOwner=function(a){var b=this;this.registerOwner(a,a.id);a.scripts.children.forEach(function(d){b.traverse(d,function(e){b.__assignUniqueBlockId(e,!0);b._blocks[e.id]=e})});a.scripts.children.forEach(function(d){b.registerBlocks(d,a.id)});var c=a.customBlocks;a.globalBlocks&&(c=c.concat(a.globalBlocks));this.loadCustomBlocks(c,a);a.costumes.asArray().forEach(function(d){d.id=d.id||b.newId();b._costumes[d.id]=d;b._costumeToOwner[d.id]=a});a.sounds.asArray().forEach(function(d){d.id=
d.id||b.newId();b._sounds[d.id]=d;b._soundToOwner[d.id]=a})};ActionManager.prototype.loadCustomBlocks=function(a,b){b=b||this.ide().stage;for(var c=a.length;c--;){var d=a[c];d.id=d.id||this.newId();this._customBlocks[d.id]=d;this._customBlockOwner[d.id]=b;var e=this._getCustomBlockEditor(d.id);var f=e.body.contents;for(var g=f.children.length;g--;){var h=f.children[g];this.registerBlocks(h,d.id,!0)}e.updateDefinition(!0)}};
ActionManager.prototype.traverse=function(a,b){for(var c=a instanceof Array?a:[a],d,e,f;c.length;){d=[];for(f=c.length;f--;)a=c[f],b(a),e=this.getBlockInputs(a),d=d.concat(e),a.nextBlock&&a.nextBlock()&&d.push(a.nextBlock()),a.comment&&d.push(a.comment);c=d}};
ActionManager.prototype.getBlockInputs=function(a){var b=[];if(a.inputs){a=a.inputs();for(var c=a.length;c--;){var d=a[c];d instanceof ReporterBlockMorph?b.push(d):d instanceof ArgMorph&&!(d instanceof TemplateSlotMorph)&&(b=b.concat(this.getBlockInputs(d)));d.nestedBlock&&d.nestedBlock()&&b.push(d.nestedBlock())}}return b};
ActionManager.prototype.__updateActiveEditor=function(a){var b,c=this.ide();if(!(this.currentEvent.replayType||this.isCollaborating()&&this.currentEvent.user!==this.id)){if(b=this._blockToOwnerId[a]){if(a=this._getCustomBlockEditor(b))return c.setActiveEditor(a)}else b=this._costumeToOwner[a]?this._costumeToOwner[a].id:this._soundToOwner[a]?this._soundToOwner[a].id:null;(b=this._owners[b])&&b!==c.currentSprite||c.setActiveEditor()}};
ActionManager.prototype.__clearOwnerRecords=function(a){var b=Object.keys(this._blockToOwnerId),c=Object.keys(this._costumeToOwner),d=Object.keys(this._soundToOwner),e;for(e=b.length;e--;)this._blockToOwnerId[b[e]]===a&&this.__clearBlockRecords(b[e]);for(e=c.length;e--;)this._costumeToOwner[c[e]].id===a&&this.__clearCostumeRecords(c[e]);for(e=d.length;e--;)this._soundToOwner[d[e]].id===a&&this.__clearSoundRecords(d[e]);delete this._owners[a]};
ActionManager.prototype.__clearSoundRecords=function(a){delete this._soundToOwner[a];delete this._sounds[a]};ActionManager.prototype.__clearCostumeRecords=function(a){delete this._costumeToOwner[a];delete this._costumes[a]};ActionManager.prototype.__clearBlockRecords=function(a){delete this._blocks[a];delete this._blockToOwnerId[a];if(this._targetFor[a])for(var b=Object.keys(this._targetFor[a]),c=b.length;c--;)delete this._targetOf[b[c]];delete this._targetFor[a];this.__clearTarget(a)};
ActionManager.prototype.__recordTarget=function(a,b){var c=this.__targetId(b);this.__clearTarget(a);this._targetOf[a]=b;this._targetFor[c]||(this._targetFor[c]={});this._targetFor[c][a]=b};ActionManager.prototype.__targetId=function(a){return"object"===typeof a?a.element:a};ActionManager.prototype.__clearTarget=function(a){if(this._targetOf[a]){var b=this.__targetId(this._targetOf[a]);this._targetFor[b]&&delete this._targetFor[b][a]}delete this._targetOf[a]};
ActionManager.prototype.afterActionApplied=function(a){this.ide().activeEditor.onSetActive();this.listeners.forEach(function(b){var c=$jscomp.makeIterator(b);b=c.next().value;c=c.next().value;b.postMessage({type:"action",data:a},c)})};
ActionManager.prototype.onMessage=function(a){var b=this.ide().sockets;if("rank"===a.type)this.rank=a.value,logger.info("assigned rank of",this.rank);else if("leader-appoint"===a.type)(this.isLeader=a.value)&&logger.info("Appointed leader!");else if("uuid"===a.type){if(this.id=a.value,logger.info("assigned id of",this.id),this.onconnect)this.onconnect()}else if("session-project-request"===a.type)b=this.serialize(this.ide().stage),a.args=[b],a.id=this.lastSeen,this.send(a);else if("session-id"===a.type)this.sessionId=
a.value,location.hash="collaborate="+this.sessionId;else if(this.isLeader&&!b.inActionRequest)this.isNextAction(a)&&this.acceptEvent(a);else this.onReceiveAction(a)};ActionManager.prototype.onActionReject=function(a,b){var c=this._attemptedLocalActions,d=c.find(function(f){return f.equals(a)}),e=c.indexOf(d);-1<e&&(c.splice(e,1),d.reject(Error(b)))};ActionManager.OwnerFor=function(){return this.ide().currentSprite.id};
ActionManager.OwnerFor.toggleBoolean=ActionManager.OwnerFor.setColorField=ActionManager.OwnerFor.setField=ActionManager.OwnerFor.addListInput=ActionManager.OwnerFor.unringify=ActionManager.OwnerFor.ringify=ActionManager.OwnerFor.unringify=ActionManager.OwnerFor.setCommentText=ActionManager.OwnerFor.setSelector=ActionManager.OwnerFor.setBlockSpec=ActionManager.OwnerFor.removeBlock=ActionManager.OwnerFor.setBlockPosition=function(a){a=a.split("/").shift();return this._blockToOwnerId[a]+"/scripts"};
ActionManager.OwnerFor.replaceBlock=function(a){a=this.deserializeBlock(a);return this._blockToOwnerId[a.id]+"/scripts"};ActionManager.OwnerFor.addBlock=function(a,b){return b+"/scripts"};ActionManager.OwnerFor.setBlocksPositions=function(a){if(a.length)return this._blockToOwnerId[a[0]]+"/scripts"};ActionManager.OwnerFor.moveBlock=function(a,b){a="string"===typeof b?b:b.element;a=a.split("/")[0];return this._customBlocks[a]?a+"/scripts":this._blockToOwnerId[a]+"/scripts"};
ActionManager.OwnerFor.addCostume=function(a,b){return b+"/costumes"};ActionManager.OwnerFor.removeCostume=function(a,b,c){return c+"/costumes"};ActionManager.OwnerFor.updateCostume=ActionManager.OwnerFor.renameCostume=function(a){return this._costumeToOwner[a].id+"/costumes"};ActionManager.OwnerFor.addSound=function(a,b){return b+"/sounds"};ActionManager.OwnerFor.removeSound=function(a,b,c){return c+"/sounds"};ActionManager.OwnerFor.renameSound=function(a){return this._soundToOwner[a].id+"/sounds"};
ActionManager.OwnerFor.updateBlockLabel=ActionManager.OwnerFor.deleteBlockLabel=ActionManager.OwnerFor.setCustomBlockType=function(a){return this._customBlockOwner[a].id};
ActionManager.OwnerFor.addCustomBlock=ActionManager.OwnerFor.renameSprite=ActionManager.OwnerFor.toggleDraggable=ActionManager.OwnerFor.setRotationStyle=ActionManager.OwnerFor.addVariable=ActionManager.OwnerFor.deleteVariable=ActionManager.OwnerFor.setStageSize=ActionManager.OwnerFor.importBlocks=ActionManager.OwnerFor.importSprites=ActionManager.OwnerFor.openProject=ActionManager.OwnerFor.duplicateSprite=ActionManager.OwnerFor.addSprite=function(){return null};
ActionManager.OwnerFor.removeSprite=function(){return"corral"};ActionManager.OwnerFor.deleteCustomBlock=function(){return"palette"};var SnapActions=new ActionManager;function UndoManager(){this.reset()}UndoManager.prototype.reset=function(){this.allEvents=[];this.eventHistory={};this.undoCount={}};UndoManager.UNDO=1;UndoManager.REDO=2;
UndoManager.prototype.contains=function(a){for(var b=this.allEvents.length;b--;)if(a.id===this.allEvents[b].id&&a.user===this.allEvents[b].user&&a.type===this.allEvents[b].type&&a.time===this.allEvents[b].time)return!0;return!1};
UndoManager.prototype.record=function(a){var b=a.owner;this.allEvents.push(a);if(b){this.eventHistory[b]||(this.undoCount[b]=0,this.eventHistory[b]=[]);var c=this.undoCount[b];var d=this.eventHistory[b];a.replayType?a.replayType===UndoManager.UNDO?this.undoCount[b]++:a.replayType===UndoManager.REDO&&(this.undoCount[b]--,console.assert(0<=this.undoCount[b],"undo count is negative!")):(0!==c&&(this.eventHistory[b].splice(d.length-c-1+1,c),this.undoCount[b]=0),d.push(a))}};
UndoManager.prototype.allQueueIds=function(){return Object.keys(this.eventHistory)};UndoManager.prototype.canUndo=function(a){a=a.id||a;return this.eventHistory[a]&&this.eventHistory[a].length>this.undoCount[a]};UndoManager.prototype.canRedo=function(a){a=a.id||a;return this.eventHistory[a]&&0<this.undoCount[a]};
UndoManager.prototype.undo=function(a){var b=a.id||a;a=this.eventHistory[b]||[];b=a.length-this.undoCount[b]-1;a=a[b];if(0>b||isNaN(b))return null;console.log("undoing",a);b=this.getInverseEvent(a);b.replayType=UndoManager.UNDO;b.owner=a.owner;return SnapActions.applyEvent(b)};
UndoManager.prototype.redo=function(a){var b=a.id||a;a=this.eventHistory[b]||[];b=a.length-this.undoCount[b];var c=a[b];if(b>=a.length)return null;a={owner:c.owner,type:c.type,args:c.args.slice()};a.replayType=UndoManager.REDO;return SnapActions.applyEvent(a)};UndoManager.prototype.trim=function(a){this.eventHistory[a].splice(this.eventHistory[a].length-this.undoCount[a]);this.undoCount[a]=0};
UndoManager.prototype.getInverseEvent=function(a){var b=a.type;a=JSON.parse(JSON.stringify(a));if(a.isUserAction)return a;if(!UndoManager.Invert[b])throw Error('Cannot undo "'+b+'" event!');var c=UndoManager.Invert[b].call(this,a.args);c instanceof Array?c={type:b,args:c}:"string"===typeof c&&(c={type:c,args:a.args});return c};UndoManager.Invert={};UndoManager.Invert.setStageSize=function(a){return{type:"setStageSize",args:a.reverse()}};
UndoManager.Invert.addSprite=function(a){return{type:"removeSprite",args:[a[2]]}};UndoManager.Invert.removeSprite=function(a){return 2===a.length?(a.shift(),{type:"addSprite",args:a}):{type:"duplicateSprite",args:a}};UndoManager.Invert.duplicateSprite=function(a){return{type:"removeSprite",args:[a[2]]}};UndoManager.Invert.attachParts=function(a){return{type:"detachParts",args:[a[1]]}};
UndoManager.Invert.detachParts=function(a){var b=a[0];return{type:"batch",args:a[1].map(function(c,d){return{type:"attachParts",args:[c,[b[d]]]}}).filter(function(c){return!!c.args[0]})}};UndoManager.Invert.replaceBlock=function(a){return a.reverse()};UndoManager.Invert.toggleDraggable=function(a){return[a[0],!a[1]]};UndoManager.Invert.importSprites=function(a){return{type:"batch",args:a.pop().map(function(b){return{type:"removeSprite",args:[b]}})}};UndoManager.Invert.addVariable=function(){return"deleteVariable"};
UndoManager.Invert.deleteVariable=function(){return"addVariable"};UndoManager.Invert.addCustomBlock=function(a){return{type:"deleteCustomBlock",args:[SnapActions.serializer.loadCustomBlock(SnapActions.serializer.parse(a[1])).id,a[0]]}};UndoManager.Invert.deleteCustomBlock=function(a){return{type:"addCustomBlock",args:[a[1],a[2],a[3]]}};UndoManager.Invert.deleteCustomBlocks=function(a){return{type:"importBlocks",args:[a[1]]}};
UndoManager.Invert.importBlocks=function(a){return{type:"deleteCustomBlocks",args:[a[2]]}};UndoManager.Invert.setCustomBlockType=function(a){UndoManager.swap(a,1,3);UndoManager.swap(a,2,4);return a};UndoManager.Invert.updateBlockLabel=function(a){if(!a[8])return a[1]+=1,{type:"deleteBlockLabel",args:a};a.splice(2,(a.length-2)/2);return a};UndoManager.Invert.deleteBlockLabel=function(a){--a[1];return{type:"updateBlockLabel",args:a}};
UndoManager.Invert.addBlock=function(a){return{type:"batch",args:a.pop().map(function(b){return{type:"removeBlock",args:[b,!0]}})}};UndoManager.Invert.removeBlock=function(a){var b=a.pop(),c={type:"batch",args:[]};4===a.length?(a.splice(1,1),c.args.push({type:"moveBlock",args:a.reverse()})):c.args.push({type:"addBlock",args:a.reverse()});for(a=b.length;a--;)c.args.push({type:"moveBlock",args:b[a]});return c};
UndoManager.Invert._actionForState=function(a){return 3===a.length?{type:"setBlockPosition",args:a}:1===a.length?a[0]instanceof Array?{type:"batch",args:a[0].map(function(b){return{type:"removeBlock",args:[b,!0]}})}:{type:"removeBlock",args:[a[0],!0]}:{type:"moveBlock",args:a}};UndoManager.Invert.setBlockPosition=function(a){return UndoManager.Invert._actionForState.call(null,a[3])};UndoManager.Invert.setBlocksPositions=function(a){return{type:"setBlocksPositions",args:[a[0],a[2],a[1]]}};
UndoManager.swap=function(a,b,c){c=a.splice(c,1)[0];a.splice(b,0,c);return a};
UndoManager.Invert.moveBlock=function(a){var b=UndoManager.Invert._actionForState.call(null,a[3]),c=a[1],d=a[2],e={type:"batch",args:[]};"batch"===b.type?e.args=b.args:e.args.push(b);d&&e.args.unshift(d);"top"===c.loc||"wrap"===c.loc?(b=UndoManager.Invert._actionForState.call(null,a[4]),"moveBlock"===b.type&&"wrap"===b.args[1].loc||e.args.unshift(b)):4<a.length&&(b=UndoManager.Invert._actionForState.call(null,a[4]),e.args.push(b));return e};UndoManager.Invert.addListInput=function(){return"removeListInput"};
UndoManager.Invert.removeListInput=function(){return"addListInput"};UndoManager.Invert.ringify=function(){return"unringify"};UndoManager.Invert.unringify=function(){return"ringify"};UndoManager.Invert.addCostume=function(a){return{type:"removeCostume",args:[SnapActions.serializer.loadValue(SnapActions.serializer.parse(a[0])).id]}};UndoManager.Invert.removeCostume=function(a){a.shift();return{type:"addCostume",args:a}};UndoManager.Invert.addSound=function(a){return{type:"removeSound",args:[SnapActions.serializer.loadValue(SnapActions.serializer.parse(a[0])).id]}};
UndoManager.Invert.removeSound=function(a){a.shift();return{type:"addSound",args:a}};UndoManager.Invert.openProject=function(a){return[a[1]]};
UndoManager.Invert.renameSprite=UndoManager.Invert.updateCostume=UndoManager.Invert.renameCostume=UndoManager.Invert.renameSound=UndoManager.Invert.setRotationStyle=UndoManager.Invert.setSelector=UndoManager.Invert.setBlockSpec=UndoManager.Invert.setCommentText=UndoManager.Invert.toggleBoolean=UndoManager.Invert.setColorField=UndoManager.Invert.setField=function(a){return[a[0],a[2]]};
var SnapUndo=new UndoManager,saveAs=saveAs||function(a){if(!("undefined"===typeof a||"undefined"!==typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var b=a.document.createElementNS("http://www.w3.org/1999/xhtml","a"),c="download"in b,d=/constructor/i.test(a.HTMLElement)||a.safari,e=/CriOS\/[\d]+/.test(navigator.userAgent),f=function(m){(a.setImmediate||a.setTimeout)(function(){throw m;},0)},g=function(m){setTimeout(function(){"string"===typeof m?(a.URL||a.webkitURL||a).revokeObjectURL(m):
m.remove()},4E4)},h=function(m){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(m.type)?new Blob([String.fromCharCode(65279),m],{type:m.type}):m},k=function(m,n,q){q||(m=h(m));var p=this,t="application/octet-stream"===m.type,r=function(){var v=["writestart","progress","write","writeend"];v=[].concat(v);for(var w=v.length;w--;){var x=p["on"+v[w]];if("function"===typeof x)try{x.call(p,p)}catch(y){f(y)}}};p.readyState=p.INIT;if(c){var u=(a.URL||a.webkitURL||a).createObjectURL(m);
setTimeout(function(){b.href=u;b.download=n;var v=new MouseEvent("click");b.dispatchEvent(v);r();g(u);p.readyState=p.DONE})}else(function(){if((e||t&&d)&&a.FileReader){var v=new FileReader;v.onloadend=function(){var w=e?v.result:v.result.replace(/^data:[^;]*;/,"data:attachment/file;");a.open(w,"_blank")||(a.location.href=w);p.readyState=p.DONE;r()};v.readAsDataURL(m);p.readyState=p.INIT}else u||(u=(a.URL||a.webkitURL||a).createObjectURL(m)),t?a.location.href=u:a.open(u,"_blank")||(a.location.href=
u),p.readyState=p.DONE,r(),g(u)})()},l=k.prototype;if("undefined"!==typeof navigator&&navigator.msSaveOrOpenBlob)return function(m,n,q){n=n||m.name||"download";q||(m=h(m));return navigator.msSaveOrOpenBlob(m,n)};l.abort=function(){};l.readyState=l.INIT=0;l.WRITING=1;l.DONE=2;l.error=l.onwritestart=l.onprogress=l.onwrite=l.onabort=l.onerror=l.onwriteend=null;return function(m,n,q){return new k(m,n||m.name||"download",q)}}}("undefined"!==typeof self&&self||"undefined"!==typeof window&&window||this.content);
"undefined"!==typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!==typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs});MessageInputSlotMorph.prototype=new StructInputSlotMorph;MessageInputSlotMorph.prototype.constructor=MessageInputSlotMorph;MessageInputSlotMorph.uber=StructInputSlotMorph.prototype;function MessageInputSlotMorph(){StructInputSlotMorph.call(this,null,!1,"messageTypesMenu","getMsgFields",!0)}
MessageInputSlotMorph.prototype.setContents=function(a,b,c){this.cachedMsgType=c?c:null;MessageInputSlotMorph.uber.setContents.call(this,a,b)};MessageInputSlotMorph.prototype.getMsgFields=function(a){var b=[];a&&(b=(b=this.world())?(a=b.children[0].stage.messageTypes.getMsgType(a))&&a.fields:this.cachedMsgType&&this.cachedMsgType.fields);return b||[]};MessageOutputSlotMorph.prototype=Object.create(MessageInputSlotMorph.prototype);MessageOutputSlotMorph.prototype.constructor=MessageOutputSlotMorph;
MessageOutputSlotMorph.uber=MessageInputSlotMorph.prototype;MessageOutputSlotMorph.prototype.executeOnSliderEdit=!1;function MessageOutputSlotMorph(){MessageInputSlotMorph.call(this)}MessageOutputSlotMorph.prototype.evaluate=function(){return this.fields};MessageOutputSlotMorph.prototype.getFieldValue=function(a){return new ReadOnlyTemplateSlotMorph(a)};ReadOnlyTemplateSlotMorph.prototype=new TemplateSlotMorph;ReadOnlyTemplateSlotMorph.prototype.constructor=ReadOnlyTemplateSlotMorph;
ReadOnlyTemplateSlotMorph.uber=TemplateSlotMorph.prototype;function ReadOnlyTemplateSlotMorph(a){TemplateSlotMorph.call(this,a);detect(this.children,function(b){return b instanceof ReporterBlockMorph}).mouseClickLeft=readOnlyReporterClick}var readOnlyReporterClick=function(a){return this.parent instanceof BlockInputFragmentMorph?this.parent.mouseClickLeft():ReporterBlockMorph.uber.mouseClickLeft.call(this,a)};
SpriteMorph.prototype.allHatBlocksForSocket=function(a){"number"===typeof a&&(a=a.toString());return this.scripts.children.filter(function(b){return"receiveSocketMessage"===b.selector&&a===b.inputs()[0].contents().text})};StageMorph.prototype.allHatBlocksForSocket=SpriteMorph.prototype.allHatBlocksForSocket;
DialogBoxMorph.prototype.ask=function(a,b,c,d){var e=this;var f=new TextMorph(b,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="decide"+a+b);this.labelString=a;this.createLabel();this.addBody(f);Object.keys(d).forEach(function(g){e.addButton(d[g],g)});this.fixLayout();this.drawNew();this.fixLayout();this.popUp(c)};SpriteMorph.prototype.categories.splice(8,0,"network");
SpriteMorph.prototype.categories.splice(9,0,"custom");SpriteMorph.prototype.blockColor.network=new Color(217,77,17);SpriteMorph.prototype.blockColor.custom=new Color(120,120,120);SpriteMorph.prototype._initBlocks=SpriteMorph.prototype.initBlocks;
SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype._initBlocks();SpriteMorph.prototype.blocks.getJSFromRPC={type:"reporter",category:"network",spec:"call %s with %s",defaults:["CloudVariables"],deprecated:!0};SpriteMorph.prototype.blocks.getJSFromRPCDropdown={type:"reporter",category:"network",spec:"call %serviceNames / %rpcActions with %s",defaults:["CloudVariables"],deprecated:!0};SpriteMorph.prototype.blocks.getJSFromRPCStruct={type:"reporter",category:"network",spec:"call %serviceNames / %rpcMethod",
defaults:["CloudVariables"]};SpriteMorph.prototype.blocks.doRunRPC={type:"command",category:"network",spec:"run %serviceNames / %rpcMethod",defaults:["CloudVariables"]};SpriteMorph.prototype.blocks.getCostumeFromRPC={type:"reporter",category:"network",spec:"costume from %serviceNames / %rpcActions with %s",defaults:["CloudVariables",""],deprecated:!0};SpriteMorph.prototype.blocks.reportRPCError={type:"reporter",category:"network",spec:"error"};SpriteMorph.prototype.blocks.doSocketRequest={type:"reporter",
category:"network",spec:"send msg %msgInput to %roles and wait"};SpriteMorph.prototype.blocks.doSocketResponse={type:"command",category:"network",spec:"send response %s"};SpriteMorph.prototype.blocks.doSocketMessage={type:"command",category:"network",spec:"send msg %msgInput to %roles"};SpriteMorph.prototype.blocks.receiveSocketMessage={type:"hat",category:"network",spec:"when I receive %msgOutput"};SpriteMorph.prototype.blocks.getProjectId={type:"reporter",category:"network",spec:"role name"};SpriteMorph.prototype.blocks.getProjectIds=
{type:"reporter",category:"network",spec:"all role names"};SpriteMorph.prototype.blocks.reportLatitude={type:"reporter",category:"sensing",spec:"my latitude"};SpriteMorph.prototype.blocks.reportLongitude={type:"reporter",category:"sensing",spec:"my longitude"};SpriteMorph.prototype.blocks.reportStageWidth={type:"reporter",category:"sensing",spec:"stage width"};SpriteMorph.prototype.blocks.reportStageHeight={type:"reporter",category:"sensing",spec:"stage height"};SpriteMorph.prototype.blocks.reportImageOfObject=
{type:"reporter",category:"sensing",spec:"image of %self"};SpriteMorph.prototype.blocks.reportUsername={type:"reporter",category:"sensing",spec:"username"};NetsBloxExtensions&&NetsBloxExtensions.initBlocks()};SpriteMorph.prototype.initBlocks();SpriteMorph.prototype.getProjectId=function(){return this.parentThatIsA(IDE_Morph).projectName};SpriteMorph.prototype.getProjectIds=function(){var a=this.parentThatIsA(IDE_Morph).room.getRoleNames();return new List(a)};StageMorph.prototype.getProjectId=SpriteMorph.prototype.getProjectId;
StageMorph.prototype.getProjectIds=SpriteMorph.prototype.getProjectIds;SpriteMorph.prototype.reportUsername=function(){return SnapCloud.username||""};StageMorph.prototype.reportUsername=SpriteMorph.prototype.reportUsername;SpriteMorph.prototype._blockForSelector=SpriteMorph.prototype.blockForSelector;SpriteMorph.prototype.blockForSelector=function(a,b){b=this._blockForSelector(a,b);"receiveSocketMessage"===a&&(b.blockSequence=CommandBlockMorph.prototype.blockSequence);return b};
SpriteMorph.prototype.deletableMessageNames=function(){return this.parentThatIsA(StageMorph).deletableMessageNames()};StageMorph.prototype.deletableMessageNames=function(){return this.messageTypes.names().filter(function(a){return"message"!==a})};
SpriteMorph.prototype.deleteMessageType=function(a){var b=this.parentThatIsA(IDE_Morph);b.stage.messageTypes.deleteMsgType(a);try{b.room.parentThatIsA(RoomEditorMorph).updateRoom(),b&&"room"===b.currentTab&&b.spriteBar.tabBar.tabTo("room")}catch(c){}b.flushBlocksCache("network");b.refreshPalette()};StageMorph.prototype.deleteMessageType=SpriteMorph.prototype.deleteMessageType;StageMorph.prototype._init=StageMorph.prototype.init;
StageMorph.prototype.init=function(a){this.messageTypes=new MessageFrame;this.addMessageType({name:"message",fields:["msg"]});this._init(a)};StageMorph.prototype.addMessageType=function(a){a=new MessageType(a.name,a.fields);this.messageTypes.addMsgType(a);try{var b=this.parentThatIsA(NetsBloxMorph);b.room.parentThatIsA(RoomEditorMorph).updateRoom();b&&"room"===b.currentTab&&b.spriteBar.tabBar.tabTo("room")}catch(c){}};ReplayControls.prototype._applyEvent=ReplayControls.prototype.applyEvent;
ReplayControls.prototype.applyEvent=function(a,b){return"openProject"!==a.type?ReplayControls.prototype._applyEvent.apply(this,arguments):b()};SpriteMorph.prototype.reportRPCError=function(){return this.parentThatIsA(StageMorph).rpcError};StageMorph.prototype.reportRPCError=function(){return this.rpcError};WatcherMorph.prototype._isGlobal=WatcherMorph.prototype.isGlobal;WatcherMorph.prototype.isGlobal=function(a){return"reportRPCError"===a||WatcherMorph.prototype._isGlobal.call(this,a)};
IDE_Morph.prototype._getURL=IDE_Morph.prototype.getURL;IDE_Morph.prototype.getURL=function(a,b,c){a=ensureFullUrl(a);return this._getURL(a,b,c)};IDE_Morph.prototype._rawOpenBlocksString=IDE_Morph.prototype.rawOpenBlocksString;
IDE_Morph.prototype.rawOpenBlocksString=function(a,b,c){var d=this;if(Process.prototype.isCatchingErrors)try{var e=this.serializer.parse(a).childrenNamed("messageType")}catch(f){this.showMessage("Load failed: "+f)}else e=this.serializer.parse(a).childrenNamed("messageType");c&&(e.forEach(function(f){var g=f.childNamed("name").contents;f=f.childNamed("fields").children.map(function(h){return h.contents});d.stage.addMessageType({name:g,fields:f})}),this.flushBlocksCache(),this.flushPaletteCache(),this.refreshPalette(),
this.showMessage("Imported Blocks / Message Types Module"+(b?": "+b:"")+".",2));return this._rawOpenBlocksString(a,b,c)};IDE_Morph.prototype.loadReplayFromXml=function(a){a=this.serializer.parse(a);"room"===a.tag&&(a=a.children[0].childNamed("project"));if("project"===a.tag){var b=this.serializer.getInitialStageSpriteIds(a),c=b[0];b=b[1];var d=this.sprites.at(1);SnapActions.registerOwner(this.stage,c);SnapActions.registerOwner(d,b);a=a.childNamed("replay")}return this.droppedText(a.toString())};
IDE_Morph.prototype.openReplayString=function(a){var b=this,c=this.serializer.parse(a);b.exitReplayMode();return SnapActions.openProject().then(function(){var d=b.serializer.loadReplayHistory(c);b.replayEvents(d,!1)})};IDE_Morph.prototype.isSupportedBrowser=function(){var a=window.chrome,b=window.navigator,c=b.vendor,d="undefined"!==typeof window.opr,e=-1<b.userAgent.indexOf("Edge");return b.userAgent.match("CriOS")?!0:null!==a&&"undefined"!==typeof a&&"Google Inc."===c&&!1===d&&!1===e?!0:!1};
IDE_Morph.prototype.isMobileDevice=function(){var a=800>=screen.width&&420>=screen.height;return(420>=screen.width&&800>=screen.height||a)&&-1!==navigator.userAgent.toLowerCase().indexOf("mobile")&&"undefined"!==typeof window.orientation};IDE_Morph.prototype.mobileMode={_stackMode:"",buttons:[],btnConfig:{idealSize:30,SBRatio:.5,GBRatio:.3,symbolSize:void 0,padding:void 0,size:void 0,gap:void 0},ideMorph:void 0};
IDE_Morph.prototype.mobileMode.init=function(){this.ideMorph=world.children[0];this.hideExtra();this.btnConfig.idealSize*=window.innerHeight/window.outerHeight;this.setBtnSize(this.btnConfig.idealSize);this.fixLayout()};IDE_Morph.prototype.mobileMode.updateBtnConfig=function(){this.btnConfig.gap=this.btnConfig.size*this.btnConfig.GBRatio;this.btnConfig.symbolSize=this.btnConfig.size*this.btnConfig.SBRatio;this.btnConfig.padding=this.btnConfig.size*(1-this.btnConfig.SBRatio)};
IDE_Morph.prototype.mobileMode.setBtnSize=function(a,b){void 0===b&&(b=!0);b||(this.btnConfig.idealSize=a);this.btnConfig.size=a;this.updateBtnConfig()};IDE_Morph.prototype.mobileMode.resetBtnSize=function(){this.btnConfig.size=this.btnConfig.idealSize;this.updateBtnConfig()};
IDE_Morph.prototype.mobileMode.fixLayout=function(){this.ideMorph.controlBar.setHeight(0);var a=this._stackMode,b=this.emptySpaces();b=this.optimalRectangle(b);"h"===a&&"v"===this._stackMode&&this.setBtnSize(.6*this.btnConfig.size);this.buttons=this.createButtons();a=this.computeControlPos(b);this.positionButtons(this.buttons,a)};IDE_Morph.prototype.mobileMode.hideExtra=function(){this.ideMorph.controlBar.hide()};
IDE_Morph.prototype.mobileMode.emptySpaces=function(){var a=world.children[0].stage.bounds;return{top:a.origin.y,left:a.origin.x,right:window.innerWidth-a.corner.x,bottom:window.innerHeight-a.corner.y}};
IDE_Morph.prototype.mobileMode.optimalRectangle=function(a){var b=world.children[0].stage,c={topRight:{x:window.innerWidth,y:0},bottomLeft:{}};var d=a.top>a.right?"top":"right";if(a[d]<2*this.btnConfig.size){a=a[d]/2-10;if(10>a)throw Error("no space on the sides.");this.setBtnSize(a)}else this.resetBtnSize();switch(d){case "right":c.bottomLeft.x=b.bounds.corner.x;c.bottomLeft.y=window.innerHeight;break;case "top":c.bottomLeft.x=0,c.bottomLeft.y=b.bounds.origin.y}c.height=Math.abs(c.topRight.y-c.bottomLeft.y);
c.width=Math.abs(c.topRight.x-c.bottomLeft.x);this._stackMode=c.height>c.width?"v":"h";return c};
IDE_Morph.prototype.mobileMode.computeControlPos=function(a){var b=window.innerHeight,c=window.innerWidth,d=this.buttons.length,e=this.buttons[0].height(),f=this.buttons[0].width();if("v"===this._stackMode){var g={origin:{},height:d*e+(d-1)*this.btnConfig.gap,width:f};g.origin.y=(b-g.height)/2;g.origin.x=a.bottomLeft.x+(a.width-g.width)/2}else"h"===this._stackMode&&(g={origin:{},width:d*f+(d-1)*this.btnConfig.gap,height:e},g.origin.x=(c-g.width)/2,g.origin.y=(a.bottomLeft.y-g.height)/2);return g};
IDE_Morph.prototype.mobileMode.createButtons=function(){var a=this,b=[new Color(50,50,50),new Color(70,70,70),new Color(90,90,90)];this.buttons&&0!==this.buttons.length&&this.buttons.forEach(function(f){f.destroy()});var c=[],d=new ToggleButtonMorph(null,this.ideMorph,"stopAllScripts",[new SymbolMorph("octagon",a.btnConfig.symbolSize),new SymbolMorph("square",a.btnConfig.symbolSize)],function(){return a.ideMorph.stage?a.ideMorph.stage.enableCustomHatBlocks&&a.ideMorph.stage.threads.pauseCustomHatBlocks:
!0});d.labelColor=new Color(200,0,0);var e=new PushButtonMorph(this.ideMorph,"pressStart",new SymbolMorph("flag",a.btnConfig.symbolSize));e.labelColor=new Color(0,200,0);c.push(e);c.push(d);c.forEach(function(f){f.hide();f.fixLayout();f.rerender();a.ideMorph.add(f);f.corner=12;f.color=b[0];f.highlightColor=b[1];f.pressColor=b[2];f.labelMinExtent=new Point(36,18);f.labelShadowOffset=new Point(-1,-1);f.labelShadowColor=b[1];f.contrast=this.buttonContrast;f.padding=a.btnConfig.padding;f.fixLayout();
f.refresh&&f.refresh()});return c};IDE_Morph.prototype.mobileMode.positionButtons=function(a,b){var c=a[0].height(),d=this,e=a[0].width();a.forEach(function(f,g){if("v"===d._stackMode){var h=b.origin.x;var k=b.origin.y+g*c+g*d.btnConfig.gap}else"h"===d._stackMode&&(k=b.origin.y,h=b.origin.x+g*e+g*d.btnConfig.gap);f.setPosition(new Point(h,k));f.show()})};
IDE_Morph.prototype.initializeEmbeddedAPI=function(){var a=this,b={};window.externalVariables=b;window.addEventListener("message",function(c){var d,e,f,g,h,k,l,m;return $jscomp.asyncExecutePromiseGeneratorProgram(function(n){if(1==n.nextAddress){d=c.data;switch(d.type){case "import":a.droppedText(d.content,d.name,d.fileType);break;case "set-variable":b[d.key]=d.value;break;case "delete-variable":delete b[d.key];break;case "export-project":return n.jumpTo(2);case "get-username":e=d;f=e.id;g=SnapCloud;
h=g.username;c.source.postMessage({id:f,type:"reply",username:h},c.origin);break;case "emit-actions":SnapActions.listeners.push([c.source,c.origin])}return n.jumpTo(0)}if(4!=n.nextAddress)return k=d,l=k.id,n.yield(a.getProjectXML(),4);m=n.yieldResult;c.source.postMessage({id:l,type:"reply",xml:m},c.origin);return n.jumpTo(0)})},!1)};
IDE_Morph.prototype.extensionsMenu=function(){var a=this,b={};this.extensions.registry.filter(function(d){return d.getMenu()}).forEach(function(d){b[d.name||d.constructor.name]=d.getMenu()});var c=function(d){var e=new MenuMorph(a);Object.entries(d).forEach(function(f){var g=$jscomp.makeIterator(f);f=g.next().value;g=g.next().value;"object"===typeof g?(g=c(g),e.addMenu(f,g)):"~"===f?e.addLine():e.addItem(f,g)});return e};return c(b)};
IDE_Morph.prototype.requestProjectReload=function(a){var b=this,c,d,e,f;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){switch(g.nextAddress){case 1:return c=a+"\n\nWould you like to reload the current role?",g.yield(b.confirm(c,localize("Project Reload Required")),2);case 2:d=g.yieldResult;if(!d){g.jumpTo(0);break}return g.yield(b.cloud.exportRole(),4);case 4:return e=g.yieldResult,f=b.showMessage(localize("Opening project...")),g.yield(b.openRoleString(e),5);case 5:f.destroy(),g.jumpToEnd()}})};
IDE_Morph.prototype.openRoleString=function(a,b){b=void 0===b?!1:b;var c=this,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){b||(a=c.serializer.parse(a));d=["<snapdata>",a.childNamed("project").toString(),a.childNamed("media").toString(),"</snapdata>"].join("");return e.return(SnapActions.openProject(d))})};LibraryDialogSource.prototype=Object.create(SaveOpenDialogMorphSource.prototype);LibraryDialogSource.prototype.constructor=LibraryDialogSource;LibraryDialogSource.uber=SaveOpenDialogMorphSource.prototype;
function LibraryDialogSource(){}LibraryDialogSource.prototype.init=function(a,b,c,d){this.ide=a;LibraryDialogSource.uber.init.call(this,b,c,d)};LibraryDialogSource.prototype.open=function(a){var b=this,c,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){if(1==e.nextAddress)return c=b.ide,d=c.droppedText,e.yield(b.getContent(a),2);d.call(c,e.yieldResult);e.jumpToEnd()})};LibraryDialogSource.prototype.cacheKey=function(a){return[this.id,a.name].join("/")};
OfficialLibrarySource.prototype=Object.create(LibraryDialogSource.prototype);OfficialLibrarySource.prototype.constructor=OfficialLibrarySource;OfficialLibrarySource.uber=LibraryDialogSource.prototype;function OfficialLibrarySource(a){this.init(a,"Official","netsbloxLogo","official")}
OfficialLibrarySource.prototype.list=function(){var a=this,b=utils.defer();this.ide.getURL(this.ide.resourceURL("libraries","LIBRARIES"),function(c){c=a.ide.parseResourceFile(c).map(function(d){d.notes=d.description;return d});b.resolve(c)});return b.promise};OfficialLibrarySource.prototype.getContent=function(a){var b=this,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){c=utils.defer();b.ide.getURL(b.ide.resourceURL("libraries",a.fileName),function(e){c.resolve(e)});return d.return(c.promise)})};
CloudLibrarySource.prototype=Object.create(LibraryDialogSource.prototype);CloudLibrarySource.prototype.constructor=CloudLibrarySource;CloudLibrarySource.uber=LibraryDialogSource.prototype;function CloudLibrarySource(a){this.init(a,"Cloud","cloud","cloud")}
CloudLibrarySource.prototype.list=function(){SnapCloud.username||this.ide.showMessage(localize("You are not logged in"));var a=utils.defer();this.ide.getURL(SERVER_URL+"/api/v2/libraries/user/",function(b){b=JSON.parse(b).map(function(c){c.public=c.public||c.needsApproval;return c});a.resolve(b)});return a.promise};
CloudLibrarySource.prototype.save=function(a){var b=this,c,d,e,f,g,h,k,l;return $jscomp.asyncExecutePromiseGeneratorProgram(function(m){if(1==m.nextAddress)return c=a,d=c.name,e=c.blocks,f=c.notes,g=new XMLHttpRequest,h=SnapCloud.username,g.open("POST",SERVER_URL+"/api/v2/libraries/user/"+h+"/"+d,!0),g.withCredentials=!0,m.yield(utils.requestPromise(g,{blocks:e,notes:f}),2);k=JSON.parse(g.responseText);(l=k.needsApproval)&&b.ide.inform("Approval Required","Approval is required to re-publish the given library.\n\nIt will be publicly available again\nfollowing a successful approval!");
m.jumpToEnd()})};CloudLibrarySource.prototype.getContent=function(a){var b=this,c,d,e,f,g;return $jscomp.asyncExecutePromiseGeneratorProgram(function(h){c=utils.defer();d=a;e=d.owner;f=d.name;g=SERVER_URL+"/api/v2/libraries/user/"+e+"/"+f;b.ide.getURL(g,function(k){c.resolve(k)});return h.return(c.promise)})};
CloudLibrarySource.prototype.delete=function(a){var b,c,d,e;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){b=a;c=b.name;d=new XMLHttpRequest;e=SnapCloud.username;d.open("DELETE",SERVER_URL+"/api/v2/libraries/user/"+e+"/"+c,!0);d.withCredentials=!0;return f.yield(utils.requestPromise(d),0)})};
CloudLibrarySource.prototype.publish=function(a,b){var c=this,d,e,f,g,h,k,l,m;return $jscomp.asyncExecutePromiseGeneratorProgram(function(n){if(1==n.nextAddress)return d=b?"unpublish":"publish",e=SnapCloud.username,f=a,g=f.name,h=SERVER_URL+"/api/v2/libraries/user/"+e+"/"+g+"/"+d,k=new XMLHttpRequest,k.open("POST",h,!0),k.withCredentials=!0,n.yield(utils.requestPromise(k),2);b||(l=JSON.parse(k.responseText),(m=l.needsApproval)&&c.ide.inform("Approval Required","Approval is required to publish the given library.\n\nIt will be publicly available automatically\nfollowing a successful approval!"));
n.jumpToEnd()})};CommunityLibrarySource.prototype=Object.create(LibraryDialogSource.prototype);CommunityLibrarySource.prototype.constructor=CommunityLibrarySource;CommunityLibrarySource.uber=LibraryDialogSource.prototype;function CommunityLibrarySource(a){this.init(a,"Community","cloud","community")}
CommunityLibrarySource.prototype.list=function(){var a=utils.defer();this.ide.getURL(SERVER_URL+"/api/v2/libraries/community/",function(b){b=JSON.parse(b);b.forEach(function(c){c.libraryName=c.name;c.name=c.name+" (author: "+c.owner+")"});a.resolve(b)});return a.promise};CommunityLibrarySource.prototype.getContent=function(a){return CloudLibrarySource.prototype.getContent.call(this,{name:a.libraryName,owner:a.owner})};LibraryDialogMorph.prototype=new SaveOpenDialogMorph;
LibraryDialogMorph.prototype.constructor=LibraryDialogMorph;LibraryDialogMorph.uber=SaveOpenDialogMorph.prototype;function LibraryDialogMorph(a,b,c,d){this.init(a,b,c,d)}
LibraryDialogMorph.prototype.init=function(a,b,c,d){var e=[new OfficialLibrarySource(a),new CloudLibrarySource(a),new CommunityLibrarySource(a)],f=c?"save":"open";this.ide=a;this.libraryXML=c;this.libraryCache={};LibraryDialogMorph.uber.init.call(this,f,"Library",e,null,{name:b,notes:d});"open"===f&&(this.labelString="Import Library",this.createLabel())};
LibraryDialogMorph.prototype.saveItem=function(a){var b=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){a.blocks=b.libraryXML;return c.yield(b.source.save(a),0)})};
LibraryDialogMorph.prototype.buildContents=function(){LibraryDialogMorph.uber.buildContents.apply(this,arguments);if("open"===this.task){var a=this.buttons.children.find(function(b){return"openItem"===b.action});a.labelString="  "+localize("Import")+"  ";a.rerender();a.fixLayout()}else this.cacheLibrary("current-library",this.ide.serializer.loadBlocks(this.libraryXML)),this.displayBlocks("current-library"),this.fixLayout()};
LibraryDialogMorph.prototype.setPreview=function(a){var b=this,c,d;return $jscomp.asyncExecutePromiseGeneratorProgram(function(e){if(1==e.nextAddress){c=b.source.cacheKey(a);if(b.hasCached(c))return b.displayBlocks(c),e.jumpTo(2);b.showMessage(localize("Loading")+"\n"+localize(a.name));return e.yield(b.source.getContent(a),3)}2!=e.nextAddress&&(d=e.yieldResult,b.cacheLibrary(c,b.ide.serializer.loadBlocks(d)),b.displayBlocks(c));b.notesText.text=a.notes||"";b.notesText.rerender();e.jumpToEnd()})};
LibraryDialogMorph.prototype.initPreview=function(){this.initializePalette();this.preview=this.palette};LibraryDialogMorph.prototype.initializePalette=function(){this.palette&&this.palette.destroy();this.palette=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor);this.palette.color=SpriteMorph.prototype.paletteColor;this.palette.padding=4;this.palette.isDraggable=!1;this.palette.acceptsDrops=!1;this.palette.contents.acceptsDrops=!1;this.body.add(this.palette)};
LibraryDialogMorph.prototype.initializeLibraryDescription=function(){this.notesField&&this.notesField.destroy();this.notesField=new ScrollFrameMorph;this.notesField.fixLayout=nop;this.notesField.edge=InputFieldMorph.prototype.edge;this.notesField.fontSize=InputFieldMorph.prototype.fontSize;this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.notesField.contrast=InputFieldMorph.prototype.contrast;this.notesField.render=InputFieldMorph.prototype.render;this.notesField.drawRectBorder=
InputFieldMorph.prototype.drawRectBorder;this.notesField.acceptsDrops=!1;this.notesField.contents.acceptsDrops=!1;this.notesText=new TextMorph("");this.notesField.isTextLineWrapping=!0;this.notesField.padding=3;this.notesField.setContents(this.notesText);this.notesField.setHeight(100);this.body.add(this.notesField)};
LibraryDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding,b=this.padding/2,c=this.nameField||this.filterField,d=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout();this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-a-this.buttons.height())),
this.srcBar.setPosition(this.body.position()),c.setWidth(this.body.width()-this.srcBar.width()-6*this.padding),c.setLeft(this.srcBar.right()+3*this.padding),c.setTop(this.srcBar.top()),c.rerender(),this.listField.setLeft(this.srcBar.right()+this.padding),this.listField.setWidth(200),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(c.bottom()+this.padding),this.listField.setHeight(this.body.height()-c.height()-this.padding),this.magnifyingGlass&&(this.magnifyingGlass.setTop(c.top()),
this.magnifyingGlass.setLeft(this.listField.left())),this.notesField.setExtent(new Point(this.body.right()-this.listField.right()-b,100)),this.palette.setRight(this.body.right()),this.palette.setTop(c.bottom()+this.padding),this.palette.setExtent(new Point(this.notesField.width(),this.listField.height()-this.notesField.height()-b)),this.notesField.setPosition(this.palette.bottomLeft().add(new Point(0,b))),this.notesField.setTop(this.palette.bottom()+b),this.notesField.setLeft(this.palette.left()));
this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&0<this.buttons.children.length&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding));Morph.prototype.trackChanges=d;this.changed()};LibraryDialogMorph.prototype.hasCached=function(a){return this.libraryCache.hasOwnProperty(a)};LibraryDialogMorph.prototype.cacheLibrary=function(a,b){this.libraryCache[a]=b};
LibraryDialogMorph.prototype.cachedLibrary=function(a){return this.libraryCache[a]};
LibraryDialogMorph.prototype.displayBlocks=function(a){var b=this,c,d,e,f=this.cachedLibrary(a);if(f.length){this.initializePalette();var g=this.palette.left()+4;var h=this.palette.top();SpriteMorph.prototype.categories.forEach(function(k){f.forEach(function(l){l.category===k&&(k!==d&&(h+=4),d=k,c=l.templateInstance().fullImage(),e=new Morph,e.isCachingImage=!0,e.bounds.setWidth(c.width),e.bounds.setHeight(c.height),e.cachedImage=c,e.setPosition(new Point(g,h)),b.palette.addContents(e),h+=e.fullBounds().height()+
4)})});this.palette.scrollX(4);this.palette.scrollY(4);this.fixLayout()}};LibraryDialogMorph.prototype.showMessage=function(a){(new MenuMorph(null,a)).popUpCenteredInWorld(this.palette.contents)};
Process.prototype.doSocketMessage=function(a){var b=this.homeContext.receiver.parentThatIsA(IDE_Morph),c=arguments[arguments.length-1],d=[b.projectName,b.room.name,b.room.ownerId].join("@"),e=a[0],f=a[1],g=Array.prototype.slice.call(arguments,1,f.length+1);if(SnapActions.isCollaborating()&&!SnapActions.isLeader&&!b.allowMsgsWhileCollaborating)null===b.allowMsgsWhileCollaborating&&(c=localize("Message sending blocked while collaborating"),f=localize("By default, message sending is disabled when collaborating because it can make\ndebugging distributed applications difficult.\n\n")+
localize("When multiple users collaborate, each collaborating user may send his/her own response\nto a received message. ")+localize('This is problematic when using the "send msg and wait"\nblock as well as for applications like turn-based games.\n\n')+localize("Would you like to enable message sending while collaborating?"),b.confirm(f,c).then(function(m){return b.allowMsgsWhileCollaborating=m})),this.topBlock.showBubble("Cannot send message when collaborating");else if(e){var h={};for(var k=f.length;k--;)h[f[k]]=
g[k]||"";var l=c instanceof List?c.asArray():c;c=function(){b.sockets.sendMessage({type:"message",dstId:l,srcId:d,msgType:e,content:h})};f=1E3/90;if(!this.reportIsFastTracking())return c();if(!this["asyncFn-sendMsg"])this["asyncFn-sendMsg"]={},this["asyncFn-sendMsg"].endTime=(new Date).getTime()+f,c(),this["asyncFn-sendMsg"].onerror=function(m){this["asyncFn-sendMsg"].error=m};else if((new Date).getTime()>this["asyncFn-sendMsg"].endTime){this["asyncFn-sendMsg"]=null;return}this.pushContext("doYield");
this.pushContext()}};Process.prototype.MESSAGE_REPLY_TIMEOUT=1500;
Process.prototype.doSocketRequest=function(a){var b=this.homeContext.receiver.parentThatIsA(IDE_Morph),c=arguments[arguments.length-1],d=b.projectName,e=b.room.name,f=b.room.ownerId,g=a[0],h=a[1],k=Array.prototype.slice.call(arguments,1,h.length+1);if(SnapActions.isCollaborating()&&!SnapActions.isLeader)this.topBlock.showBubble("Cannot send message when collaborating");else if(g){if(this.requestId){if(this.reply){var l=this.requestId;b=this.reply;this.requestId===l&&(this.messageSentAt=this.reply=
this.requestId=null);return b.content.body}if(Date.now()-this.messageSentAt>this.MESSAGE_REPLY_TIMEOUT)return this.homeContext.receiver.parentThatIsA(StageMorph).rpcError="Timeout Exceeded",null}else{this.requestId=l="__REQ"+Date.now();var m={};for(var n=h.length;n--;)m[h[n]]=k[n]||"";b.sockets.sendMessage({type:"message",dstId:c,srcId:d+"@"+e+"@"+f,msgType:g,requestId:l,content:m});this.messageSentAt=Date.now()}this.pushContext("doYield");this.pushContext()}};
Process.prototype.doSocketResponse=function(a){var b=this.homeContext.receiver.parentThatIsA(IDE_Morph);try{var c=this.context.variables.getVar("__requestId__");var d=this.context.variables.getVar("__srcId__")}catch(e){throw Error(localize("Cannot find message to which to respond!"));}b.sockets.sendMessage({type:"message",dstId:d,msgType:"__reply__",requestId:c,content:{body:a}})};
Process.prototype.receiveSocketMessage=function(a){var b=this.context.outerContext.variables;if(-1!==b.names().indexOf("__message__")){var c=this.context.variables.getVar("__message__");a.length||(a=Object.keys(c));for(var d=a.length;d--;)b.addVar(a[d],c[a[d]]);b.deleteVar("__message__")}};
Process.prototype.createRPCUrl=function(a){var b=this.homeContext.receiver.parentThatIsA(IDE_Morph).sockets.uuid,c=encodeURIComponent(SnapCloud.projectId),d=encodeURIComponent(SnapCloud.roleId);a+="?uuid="+b+"&projectId="+c+"&roleId="+d;SnapCloud.username&&(a+="&username="+SnapCloud.username);return a};
Process.prototype.callRPC=function(a,b,c){var d=this.createRPCUrl(a);c&&(d+="&t="+Date.now());"string"===typeof b&&(c=b.split("&").map(function(e){return e.split("=")}),b={},c.forEach(function(e){b[e[0]]=e[1]}));if(this.rpcRequest){if(4===this.rpcRequest.readyState){if(0===this.rpcRequest.status){d=this.homeContext.receiver.parentThatIsA(StageMorph);d.rpcError="Request too large";return}if(404===this.rpcRequest.status)return d=$jscomp.makeIterator(a.split("/").filter(function(e){return e}).reverse()),
a=d.next().value,d=d.next().value,this.errorRPCNotAvailable(d,a);if((d=this.rpcRequest.getResponseHeader("content-type"))&&0===d.indexOf("image")){if(a=this.getCostumeFromRPC(a,b))this.rpcRequest=null;return a}a=(new TextDecoder("utf-8")).decode(new Uint8Array(this.rpcRequest.response));a=decodeURIComponent(encodeURIComponent(a));d=this.homeContext.receiver.parentThatIsA(StageMorph);d.rpcError=200>this.rpcRequest.status||299<this.rpcRequest.status?a:null;this.rpcRequest=null;return a}this.readyToTerminate&&
(this.rpcRequest.abort(),this.rpcRequest=null)}else this.rpcRequest=new XMLHttpRequest,this.rpcRequest.responseType="arraybuffer",this.rpcRequest.open("POST",d,!0),this.rpcRequest.setRequestHeader("Content-Type","application/json"),this.rpcRequest.send(JSON.stringify(b));this.pushContext("doYield");this.pushContext()};
Process.prototype.getCostumeFromRPC=function(a,b){if(!this.rpcRequest||4!==this.rpcRequest.readyState)return this.callRPC(a,b,!0);if(!this.requestedImage)a=this.rpcRequest.response,b=this.rpcRequest.getResponseHeader("content-type"),a=new Blob([a],{type:b}),a=(window.URL||window.webkitURL).createObjectURL(a),this.requestedImage=new Image,this.requestedImage.crossOrigin="Anonymous",this.requestedImage.src=a;else if(this.requestedImage.complete&&this.requestedImage.naturalWidth)return a=this.requestedImage,
this.requestedImage=null,b=newCanvas(new Point(a.width,a.height),!0),b.getContext("2d").drawImage(a,0,0),new Costume(b);this.pushContext("doYield");this.pushContext()};Process.prototype.getJSFromRPC=function(a,b){if("string"===typeof b){var c=b;b={};c.split("&").forEach(function(d){var e=d.split("=");d=e[0];e=e[1];d&&(b[d]=e)})}if(a=this.callRPC(a,b,!0))try{a=JSON.parse(a)}catch(d){}return a=this.parseRPCResult(a)};
Process.prototype.parseRPCResult=function(a){return a instanceof Array?new List(a.map(this.parseRPCResult.bind(this))):"string"===typeof a&&"<"===a[0]?this.homeContext.receiver.parentThatIsA(IDE_Morph).sockets.deserializeData([a])[0]:a};function listToArray(a){if(!(a instanceof List))return a;var b=[];a=a.asArray();for(var c,d=0;d<a.length;d++)c=a[d],c instanceof List?c=listToArray(c):isObject(c)&&(SnapActions.serializer.flush(),c=SnapActions.serializer.getPortableXML(c)),b.push(c);return b}
Process.prototype.errorRPCNotAvailable=function(a,b){throw Error('Cannot invoke "'+b+'" from "'+a+'". Service or RPC is not available.');};
Process.prototype.doRunRPC=Process.prototype.getJSFromRPCStruct=function(a,b){var c=b[0],d=b[1],e=Array.prototype.slice.call(arguments,2,d.length+2),f={};SnapActions.serializer.flush();d.forEach(function(g,h){e[h]instanceof List?f[g]=listToArray(e[h]):isObject(e[h])?f[g]=SnapActions.serializer.getPortableXML(e[h]):f[g]=e[h]});SnapActions.serializer.flush();return this.getJSFromRPCDropdown(a,c,f)};
Process.prototype.getJSFromRPCDropdown=function(a,b,c){if(a&&b){a=a instanceof Array?a[0]:Services.defaultHost.url+"/"+a;if(!Services.isRegisteredServiceURL(a))throw c=a.split("/").pop(),Error('Service "'+c+'" is not available');b=[a,encodeURIComponent(b)].join("/");return this.getJSFromRPC(b,c)}};
Process.prototype.getLocation=function(){var a=this,b=void 0!==this.location,c=null===this.locationError;if(!b&&!c)this.locationError=null,navigator.geolocation.getCurrentPosition(function(d){a.location=d},function(d){a.locationError=d;a.location=null});else if(b){b=this.location;if(this.locationError=this.location=void 0,!b)throw this.locationError=this.locationError||Error("Could not determine location"),b=this.locationError.name||this.locationError.constructor&&this.locationError.constructor.name,
this.locationError.name=b||"Error",this.locationError;return b.coords}this.pushContext("doYield");this.pushContext()};Process.prototype.reportLatitude=function(){var a=this.getLocation();if(a)return a.latitude};Process.prototype.reportLongitude=function(){var a=this.getLocation();if(a)return a.longitude};Process.prototype.reportStageWidth=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).dimensions.x};Process.prototype.reportStageHeight=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).dimensions.y};
Process.prototype.reportImageOfObject=function(a){a=this.reportObject(a);if(void 0!==a)return new Costume(a.fullImage())};
Process.prototype.runAsyncFn=function(a,b){b=b||{};b={timeout:b.timeout||2E3,args:b.args||[]};var c="_asyncFunc"+a.name,d=this;if(!(c&&a instanceof Function))throw Error("id or asyncFn input missing");if(this[c]){if(d[c].complete){var e=d[c];d[c]=null;return e.response}if(d[c].error)throw e=d[c],d[c]=null,console.error(e.response),Error(e.response);}else this[c]={},this[c].startTime=(new Date).getTime(),e=new Promise(function(f,g){setTimeout(g,b.timeout,"timeout")}),a=a.apply(this,b.args),e=Promise.race([a,
e]).then(function(f){d[c].complete=!0;d[c].response=f}).catch(function(f){d[c].error=!0;d[c].response=f}),d[c].onerror=function(f){d[c].error=f},d[c].promise=e;this.pushContext("doYield");this.pushContext()};
var WebSocketManager=function(a){this.ide=a;this.uuid=SnapCloud.clientId;this.websocket=null;this.messages=[];this.msgHandlerQueues=[];this._protocol="https"===SERVER_URL.substring(0,5)?"wss:":"ws:";this.url=this._protocol+"//"+SERVER_ADDRESS;this.lastSocketActivity=Date.now();this._connectWebSocket();this.version=Date.now();this.serverVersion=null;this.inActionRequest=this.connected=this.hasConnected=this.errored=!1;this.serializer=new NetsBloxSerializer};WebSocketManager.HEARTBEAT_INTERVAL=25E3;
WebSocketManager.MessageHandlers={"request-actions-complete":function(){this.inActionRequest=!1},"reload-project":function(a){this.ide.requestProjectReload(a.message)},"report-version":function(a){a=a.body;this.serverVersion||(this.serverVersion=a);this.serverVersion!==a&&this.ide.showUpdateNotification()},connected:function(){this.onConnect()},message:function(a){var b=a.dstId,c=a.msgType;if(this.ide.room.isReplayingTrace())this.ide.room.trace.notified||(this.ide.showMessage(localize("Ignoring messages received while\nviewing network trace")),
this.ide.room.trace.notified=!0);else if(b===this.ide.projectName||"others in room"===b||"everyone in room"===b)b=this.deserializeMessage(a),this.onMessageReceived(c,b,a)},"room-roles":function(a){this.ide.room.onRoomStateUpdate(a)},"close-invite":function(a){(a=DialogBoxMorph.prototype.instances[a.id])&&a.destroy()},"room-invitation":function(a){this.ide.room.promptInvite(a.id,a.role,a.roomName,a.inviter)},"collab-invitation":function(a){this.ide.promptCollabInvite(a)},"project-closed":function(){var a=
this.ide.room.ownerId;this.ide.showMessage(a+" closed the room. You can ask to join again once "+a+" opens the project again");this.ide.newProject()},evicted:function(a){a=a.state;this.ide.showMessage("You have been evicted from the project.");this.ide.cloud.setLocalState(a.projectId,a.roleId);this.ide.newProjectFromInfo(a)},"permission-elevation-request":function(a){var b=this,c=a.guest;this.ide.confirm(c+localize(" would like to be made a collaborator on ")+b.ide.room.name+"\n\n"+localize("Would you like to make ")+
c+localize(" a collaborator?"),"Collaboration Request",function(){b.sendMessage({type:"elevate-permissions",projectId:a.projectId,username:c})})},"project-request":function(a){var b=this.getSerializedProject();a.type="project-response";a.project=b;this.sendMessage(a)},"rename-role":function(a){a.roleId===this.ide.projectName&&this.ide.silentSetProjectName(a.name)},notification:function(a){this.ide.showMessage(a.message)},"share-msg-type":function(a){if(this.ide.projectName===a.roleId){var b=this,
c=new DialogBoxMorph;this.ide.stage.messageTypes.msgTypes[a.name]?this.ide.showMessage(a.from+" tried sending you message type '"+a.name+"' when you already have it!",2):(c.askYesNo("Message Share Request",a.from+" requested to send you a message type:\n'"+a.name+"' with "+a.fields.length+(1!==a.fields.length?" fields.":" field.")+"\nWould you like to accept?",b.ide.root()),c.ok=function(){var d=b.ide.root().children[0].parentThatIsA(IDE_Morph);SnapActions.addMessageType(a.name,a.fields).then(function(){for(var e=
[],f=0;f<a.fields.length;f++)e.push(" '"+a.fields[f]+"'");b.ide.showMessage("Received message type '"+a.name+"' with "+a.fields.length+(0===a.fields.length?" fields.":1===a.fields.length?" field: "+a.fields:" fields: "+a.fields),2);d&&"room"===d.currentTab&&d.spriteBar.tabBar.tabTo("room")});c.destroy()})}},ping:function(){this.sendMessage({type:"pong"})},"user-action":function(a){SnapActions.onMessage(a.action)},"action-rejected":function(a){SnapActions.onActionReject(a.action,a.error.message)}};
WebSocketManager.prototype.isConnected=function(){return this.websocket.readyState===this.websocket.OPEN};WebSocketManager.prototype.isStale=function(){return Date.now()-this.lastSocketActivity>2*WebSocketManager.HEARTBEAT_INTERVAL};WebSocketManager.prototype.checkAlive=function(){return this.isStale()?(this.websocket.readyState!==this.websocket.CONNECTING&&(this.lastSocketActivity=Date.now(),this.disconnect()),!1):!0};WebSocketManager.prototype.disconnect=function(){this.websocket.close();this.onClose()};
WebSocketManager.prototype._connectWebSocket=function(){var a=this;if(null!==this.websocket){if(this.isConnected())return;if(this.websocket.readyState===this.websocket.CONNECTING){setTimeout(a._connectWebSocket.bind(a),500);return}}this.websocket=new WebSocket(this.url);this.websocket.onopen=function(){!0===a.errored&&(a.ide.showMessage((a.hasConnected?"re":"")+"connected!",2),a.errored=!1);a.hasConnected||setInterval(a.checkAlive.bind(a),WebSocketManager.HEARTBEAT_INTERVAL);a.lastSocketActivity=
Date.now();a.connected=!0;a.sendMessage({type:"set-uuid",clientId:SnapCloud.clientId});a.hasConnected=!0};this.websocket.onmessage=function(b){b=JSON.parse(b.data);var c=b.type;a.lastSocketActivity=Date.now();WebSocketManager.MessageHandlers[c]?WebSocketManager.MessageHandlers[c].call(a,b):console.error("Unknown message:",b)};this.websocket.onclose=function(){a.onClose()}};
WebSocketManager.prototype.onClose=function(){this.connected&&(this.version=Date.now(),this.connected=!1);if(!this.errored&&5E3<Date.now()-this.version){var a=this.hasConnected?"Temporarily disconnected.\nSome network functionality may be nonfunctional.\nTrying to reconnect...":"Could not fully connect to NetsBlox.\nPlease try refreshing your browser or try a different browser";this.ide.showMessage(a);this.errored=!0}setTimeout(this._connectWebSocket.bind(this),500)};
WebSocketManager.prototype.sendJSON=function(a){return this.send(JSON.stringify(a))};WebSocketManager.prototype.send=function(a){this.checkAlive();this.isConnected()?this.websocket.send(a):this.messages.push(a)};WebSocketManager.prototype.sendMessage=function(a){a.projectId=SnapCloud.projectId;a=this.serializeMessage(a);this.send(a)};
WebSocketManager.prototype.serializeMessage=function(a){if(a.content){var b=Object.keys(a.content);this.serializer.flush();for(var c=b.length;c--;){var d=a.content[b[c]];isObject(d)&&(a.content[b[c]]=this.serializer.getPortableXML(d))}this.serializer.flush()}return JSON.stringify(a)};WebSocketManager.prototype.deserializeMessage=function(a){var b=a.content,c=Object.keys(b),d=c.map(function(e){return b[e]});this.deserializeData(d).forEach(function(e,f){a.content[c[f]]=e});return a.content};
WebSocketManager.prototype.deserializeData=function(a){var b,c;SnapActions.serializer.project={stage:new StageMorph,sprites:{}};return a.map(function(d){if("<"===d[0])try{return console.log("Received serialized format:",d.length),c=SnapActions.serializer.parse(d),(b=c.allChildren().find(function(e){return"project"===e.tag}))&&SnapActions.serializer.rawLoadProjectModel(b),SnapActions.serializer.loadValue(c)}catch(e){console.error("Could not deserialize!",e)}return d})};
WebSocketManager.prototype.onConnect=function(){var a=this;SnapActions.requestMissingActions(!0);return this.updateRoomInfo().then(function(){for(;a.messages.length;)a.websocket.send(a.messages.shift())})};WebSocketManager.prototype.getClientState=function(){var a=this.ide.room.ownerId,b={room:this.ide.room.name||"__new_project__",role:this.ide.projectName||"myRole"};a&&(b.owner=a,b.actionId=SnapActions.lastSeen);return b};
WebSocketManager.prototype.updateRoomInfo=function(){var a=this,b=this.getClientState();return SnapCloud.setClientState(b.room,b.role,b.actionId).catch(function(){a.ide.cloudError().apply(null,arguments)})};
WebSocketManager.prototype.onMessageReceived=function(a,b,c){var d=this,e=!this.msgHandlerQueues.length,f=this.ide.stage;b=b||[];if(""!==a){var g="__reply__"===a;f.threads.processes.forEach(function(h){g&&h.requestId===c.requestId&&(h.reply=c)});f.children.concat(f).forEach(function(h){isSnapObject(h)&&h.allHatBlocksForSocket(a).forEach(function(k){var l=new VariableFrame;l.addVar("__message__",b);l.addVar("__requestId__",c.requestId);l.addVar("__srcId__",c.srcId);d.addMsgToQueue(h,k,a,l)})});e&&
setTimeout(this.tryStartQueuedMsgs.bind(this),50)}};WebSocketManager.prototype.addMsgToQueue=function(a,b,c,d){var e=this.getMessageQueue(b);e||(e=new MessageHandlerQueue(this.ide.stage,b,a),this.msgHandlerQueues.push(e));e.addMessage({variables:d,messageType:c})};WebSocketManager.prototype.getMessageQueue=function(a){return this.msgHandlerQueues.find(function(b){return b.handler===a})};
WebSocketManager.prototype.tryStartQueuedMsgs=function(){for(var a=this,b=0;b<this.msgHandlerQueues.length;b++){var c=this.msgHandlerQueues[b];c.tryHandleNextMessage();c.isEmpty()&&(this.msgHandlerQueues.splice(b,1),b--)}this.msgHandlerQueues.length&&setTimeout(function(){return a.tryStartQueuedMsgs()},5)};
WebSocketManager.prototype.getSerializedProject=function(){var a=this.ide;a.serializer.flush();a.serializer.isCollectingMedia=!0;var b=a.serializer.serialize(a.stage);var c=a.serializer.mediaXML(a.projectName);a.serializer.isCollectingMedia=!1;a.serializer.flushMedia();try{a.serializer.parse(b)}catch(d){throw a.showMessage("Serialization of program data failed:\n"+d),Error("Serialization of program data failed:\n"+d);}if(null!==c)try{a.serializer.parse(c)}catch(d){throw a.showMessage("Serialization of media failed:\n"+
d),Error("Serialization of media failed:\n"+d);}a.serializer.isCollectingMedia=!1;a.serializer.flushMedia();a.serializer.flush();return{ProjectName:a.projectName,SourceCode:b,Media:c,SourceSize:b.length,MediaSize:c?c.length:0,RoomName:this.ide.room.name}};WebSocketManager.prototype.destroy=function(){this.websocket.readyState===this.websocket.OPEN?this._destroy():this.websocket.onopen=this._destroy.bind(this)};WebSocketManager.prototype._destroy=function(){this.websocket.onclose=nop;this.websocket.close()};
var MessageHandlerQueue=function(a,b,c){this.stage=a;this.receiver=c;this.handler=b;this.contents=[]};MessageHandlerQueue.prototype.addMessage=function(a){this.contents.push(a)};MessageHandlerQueue.prototype.tryHandleNextMessage=function(){if(this.isHandlerIdle()){var a=this.getNextMessage();this.handler.updateReadout();a&&this.handleMessage(a)}};
MessageHandlerQueue.prototype.handleMessage=function(a){this.stage.threads.startProcess(this.handler,this.receiver,this.stage.isThreadSafe,null,null,null,!1,null,a.variables)};MessageHandlerQueue.prototype.isEmpty=function(){return 0===this.contents.length};MessageHandlerQueue.prototype.empty=function(){this.contents=[]};MessageHandlerQueue.prototype.isHandlerIdle=function(){return!this.stage.threads.findProcess(this.handler,this.receiver)};MessageHandlerQueue.prototype.getExpectedMsgType=function(){return this.handler.inputs()[0].contents().text};
MessageHandlerQueue.prototype.getNextMessage=function(){for(var a=this.getExpectedMsgType(),b=this.contents.shift();b&&b.messageType!==a;)b=this.contents.shift();return b};WebSocketManager.MessageHandlerQueue=MessageHandlerQueue;modules.messages="2015-October-02";function MessageType(a,b){this.name=a;this.fields=b}function Message(a){this.type=a;this.contents={};this.init()}Message.prototype.init=function(){for(var a=this.type.fields.length;a--;)this.set(this.type.fields[a],0)};
Message.prototype.set=function(a,b){this.contents[a]=b};Message.prototype.get=function(a){return this.contents[a]};Message.prototype.getFieldNames=function(){return this.type.fields.slice()};Message.prototype.toString=function(){return this.type.name+" Message"};function MessageFrame(){this.msgTypes={};this.version=Date.now()}MessageFrame.prototype.addMsgType=function(a){this.msgTypes[a.name]=a;this.version=Date.now()};MessageFrame.prototype.getMsgType=function(a){return this.msgTypes[a]};
MessageFrame.prototype.deleteMsgType=function(a){delete this.msgTypes[a];this.version=Date.now()};MessageFrame.prototype.names=function(){return Object.keys(this.msgTypes)};MessageCreatorMorph.prototype=new DialogBoxMorph;MessageCreatorMorph.prototype.constructor=MessageCreatorMorph;MessageCreatorMorph.uber=DialogBoxMorph.prototype;function MessageCreatorMorph(a,b){this.init(a,b)}
MessageCreatorMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;if(this.body){this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding)));this.minWidth=this.minWidth||0;var b=this.body.width()+2*this.padding;this.bounds.setWidth(Math.max(b,this.minWidth));this.bounds.setHeight(this.body.height()+2*this.padding+a);this.body.setLeft(this.left()+Math.round((this.width()-this.body.width())/2))}this.label&&(this.label.setCenter(this.center()),
this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.bounds.setHeight(this.height()+this.buttons.height()+this.padding),this.bounds.setWidth(Math.max(this.width(),this.buttons.width()+2*this.padding)),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))};
MessageCreatorMorph.prototype.init=function(a,b){var c=this;this.minWidth=0;MessageCreatorMorph.uber.init.call(this,a);this.key="createNewMsgType";this.labelString="Create Message Type";this.createLabel();var d=new MessageDefinitionBlock;this.addBody(d);var e=d.fixLayout;d.fixLayout=function(){this.parent.rerender();e.call(this);c.fixLayout();c.handle.rerender();c.rerender()};this.accept=function(){var f={name:d.messageName(),fields:d.fields()};f.name&&b(f);this.destroy()};this.addButton("ok","OK");
this.addButton("cancel","Cancel");this.fixLayout();this.rerender();this.minWidth=this.width()};MessageCreatorMorph.prototype.popUp=function(){var a=this.target.world();a&&(BlockEditorMorph.uber.popUp.call(this,a),this.handle=new HandleMorph(this,280,220,this.corner,this.corner))};MessageDefinitionBlock.prototype=new ReporterBlockMorph;MessageDefinitionBlock.prototype.constructor=MessageDefinitionBlock;MessageDefinitionBlock.uber=ReporterBlockMorph.prototype;
function MessageDefinitionBlock(){this.init()}MessageDefinitionBlock.prototype.init=function(){MessageDefinitionBlock.uber.init.call(this);this.color=SpriteMorph.prototype.blockColor.network;this.category="network";this.setSpec("name: %hintname fields: %mhintfield");this.rerender()};MessageDefinitionBlock.prototype.messageName=function(){return this.inputs()[0].evaluate()};MessageDefinitionBlock.prototype.fields=function(){return this.inputs()[1].evaluate()};RoomMorph.prototype=new Morph;
RoomMorph.prototype.constructor=RoomMorph;RoomMorph.uber=Morph.prototype;RoomMorph.SIZE=300;RoomMorph.DEFAULT_ROLE="myRole";RoomMorph.DEFAULT_ROOM="untitled";RoomMorph.isSocketUuid=function(a){return a&&"_"===a[0]};RoomMorph.isValidName=function(a){return!/[@\.]+/.test(a)};RoomMorph.isEmptyName=function(a){return 0===a.trim().length};function RoomMorph(a){this.init(a)}
RoomMorph.prototype.init=function(a){var b=this;this.version=-1;this.isReadOnly=!1;this.ide=a;this.displayedMsgMorphs=[];this.trace={};this.ownerId=null;this.collaborators=[];RoomMorph.uber.init.call(this,!0);this.name=localize(RoomMorph.DEFAULT_ROOM);this.roomName=new StringMorph(this.name,18,null,!0,!1,!1,null,null,WHITE);this.roomName.mouseClickLeft=function(){return b.editRoomName()};this.ownerLabel=new StringMorph(localize("Owner: myself"),!1,!1,!0,!0,!1,null,null,WHITE);this.collabList=new StringMorph(localize("No collaborators"),
!1,!1,!0,!0,!1,null,null,WHITE);this.nextRoom=null;this.ide.projectName||(this.ide.projectName=RoomMorph.DEFAULT_ROLE);RoomMorph.uber.init.call(this);this.updateRoles(this.getDefaultRoles());this.add(this.roomName);this.add(this.ownerLabel);this.add(this.collabList);this.isDraggable=!1;this.sharedMsgs=[];this.blockHighlights=[]};RoomMorph.prototype.setReadOnly=function(a){a!==this.isReadOnly&&(this.isReadOnly=a,this.render())};
RoomMorph.prototype.silentSetRoomName=function(a){this.name=a;this.roomName.text=a;this.roomName.changed();this.roomName.fixLayout();this.roomName.rerender();this.ide.controlBar.updateLabel();return a};RoomMorph.prototype.setRoomName=function(a){var b=this;return this.name!==a?SnapCloud.setProjectName(a).then(function(c){return b.onRoomStateUpdate(c)}).catch(this.ide.cloudError()):Promise.resolve(a)};
RoomMorph.prototype.getDefaultRoles=function(){var a={},b=this.getCurrentRoleName(),c={uuid:this.myUuid(),username:SnapCloud.username||"me"};a[b]={name:b,occupants:[c]};return a};RoomMorph.prototype.getCurrentRoleName=function(){var a=this,b=this.getRoleNames(),c=a.ide.sockets.uuid;return b.find(function(d){return a.getCurrentOccupants(d).find(function(e){return e.uuid===c})})||this.ide.projectName};RoomMorph.prototype.getRoleCount=function(){return this.getRoles().length};
RoomMorph.prototype.hasMultipleRoles=function(){return 1<this.getRoleCount()};RoomMorph.prototype.getCurrentOccupants=function(a){a=a||this.getCurrentRoleName();return(a=this.getRole(a))?a.users.slice():[]};RoomMorph.prototype.isLeader=function(){return 1===this.getCurrentOccupants().length};RoomMorph.prototype.myUuid=function(){return this.ide.sockets.uuid};RoomMorph.prototype.myUserId=function(){return SnapCloud.username||localize("guest")};
RoomMorph.prototype.isOwner=function(a){if(RoomMorph.isSocketUuid(this.ownerId)&&!a)return this.ide.sockets.uuid===this.ownerId;if(!a&&null===this.ownerId)return!0;a=a||SnapCloud.username;return this.ownerId&&this.ownerId===a};RoomMorph.prototype.isCollaborator=function(a){a=a||SnapCloud.username;return-1<this.collaborators.indexOf(a)};RoomMorph.prototype.isGuest=function(a){return!(this.isOwner(a)||this.isCollaborator(a))};
RoomMorph.prototype.isEditable=function(){return!this.isReadOnly&&(this.isOwner()||this.isCollaborator())};RoomMorph.sameOccupants=function(a,b){var c=function(f){return f.uuid};var d=function(f){return f.username};var e=a.map(c);c=b.map(c);if(!RoomMorph.equalLists(e,c))return!1;a=a.map(d);b=b.map(d);return RoomMorph.equalLists(a,b)?!0:!1};RoomMorph.equalLists=function(a,b){if(a.length!==b.length)return!1;for(var c=a.length;c--;)if(a[c]!==b[c])return!1;return!0};
RoomMorph.prototype.onRoomStateUpdate=function(a){this.version<a.version&&(this.update(a.owner,a.name,a.roles,a.collaborators),this.version=a.version)};
RoomMorph.prototype.update=function(a,b,c,d){var e=this.isEditable(),f;(f=b&&this.name!==b)&&this.silentSetRoomName(b);f=f||e!==this.isEditable();c&&(f=this.updateRoles(c)||f);d&&(f=f||!RoomMorph.equalLists(d,this.collaborators),this.setCollaborators(d||this.collaborators));a&&(f=f||a!==this.ownerId,this.ownerId=a);this.ide.silentSetProjectName(this.getCurrentRoleName());f&&(this.rerender(),this.fixLayout());SnapActions.isLeader=this.isLeader()};RoomMorph.prototype.getRoleNames=function(){return this.getRoles().map(function(a){return a.name})};
RoomMorph.prototype.getRoles=function(){return this.children.filter(function(a){return a instanceof RoleMorph})};RoomMorph.prototype.getRole=function(a){return this.getRoles().find(function(b){return b.name===a})};
RoomMorph.prototype.updateRoles=function(a){var b=this,c=!1,d;this.getRoles().forEach(function(e){a[e.id]?(d=a[e.id].occupants,RoomMorph.sameOccupants(e.users,d)||e.setOccupants(d),e.setName(a[e.id].name),delete a[e.id]):(e.destroy(),c=!0)});Object.keys(a).forEach(function(e){e=new RoleMorph(e,a[e].name,a[e].occupants);b.add(e);c=!0});return c};RoomMorph.prototype.getInnerHeight=function(){return this.ownerLabel.top()-10-this.top()};
RoomMorph.prototype.getRadius=function(){var a=this.getInnerHeight();return Math.min(this.width(),a)/2};RoomMorph.prototype.getRoleSize=function(){var a=this.getRoles().length;a=2*Math.PI/a;var b=this.getRadius();var c=new Point(b/2,0);var d=(new Point(Math.cos(a),Math.sin(a))).multiplyBy(b/2);d=c.distanceTo(d)-10;b=c.distanceTo(new Point(0,b/2));a<Math.PI/2&&(b=d);return Math.min(b,150)};
RoomMorph.prototype.fixLayout=function(){var a=this,b=this.getRoles(),c=2*Math.PI/b.length,d=-Math.PI/2+this.index*c,e=RoleMorph.COLORS.length;this.collabList.setCenter(this.center());this.collabList.setBottom(this.bottom()-25);this.ownerLabel.setCenter(this.center());this.ownerLabel.setBottom(this.collabList.top()-10);var f=new Point(this.center().x,this.top()+this.getInnerHeight()/2);this.roomName.setCenter(f);var g=this.getRadius();var h=this.getRoleSize();for(var k=0;k<b.length;k++){var l=b[k];
d=-Math.PI/2+k*c;var m=.65*g*Math.cos(d);d=.65*g*Math.sin(d);m=f.add(new Point(m,d));d=RoleMorph.COLORS[k%e];l.setExtent(new Point(h,h));l.setCenter(m);l.setColor(d)}this.displayedMsgMorphs.forEach(function(n){a.updateDisplayedMsg(n)})};RoomMorph.prototype.render=function(a){this.isReadOnly?this.roomName.hide():this.roomName.show()};RoomMorph.prototype.setOwner=function(a){this.ownerId=a;this.ownerLabel.text=RoomMorph.isSocketUuid(this.ownerId)?localize("myself"):this.ownerId;this.ownerLabel.rerender()};
RoomMorph.prototype.setCollaborators=function(a){this.collaborators=a;this.collabList.text=this.collaborators.length?localize("Collaborators")+":\n"+this.collaborators.join(",\n"):"No collaborators";this.collabList.rerender()};RoomMorph.prototype.mouseClickLeft=function(){this.isEditable()||this.isReadOnly||(SnapCloud.username?this.ide.confirm(localize('would you like to leave "'+this.name+'"?'),localize("Leave Room"),this.ide.newProject.bind(this.ide)):this.ide.showMessage(localize("Please login before editing the room")))};
RoomMorph.prototype.editRoomName=function(){var a=this;this.isEditable()&&this.ide.prompt("New Room Name",function(b){RoomMorph.isEmptyName(b)||(RoomMorph.isValidName(b)?a.setRoomName(b):(new DialogBoxMorph).inform("Invalid Project Name","Could not set the project name because\nthe provided name is invalid",a.world()))},null,"editRoomName")};
RoomMorph.prototype.validateRoleName=function(a,b){RoomMorph.isEmptyName(a)||(this.getRole(a)?(new DialogBoxMorph).inform("Existing Role Name","Could not rename role because\nthe provided name already exists.",this.world()):RoomMorph.isValidName(a)?b():(new DialogBoxMorph).inform("Invalid Role Name","Could not change the role name because\nthe provided name is invalid",this.world()))};
RoomMorph.prototype.createNewRole=function(){var a=this;this.ide.prompt("New Role Name",function(b){a.validateRoleName(b,function(){SnapCloud.addRole(b,function(c){a.onRoomStateUpdate(c)},a.ide.cloudError())})},null,"createNewRole")};RoomMorph.prototype.editRole=function(a){a=new EditRoleMorph(this,a);var b=this.world();a.fixLayout();a.rerender();a.popUp(b);a.setCenter(b.center())};
RoomMorph.prototype.editRoleName=function(a){var b=this;this.ide.prompt("New Role Name",function(c){b.setRoleName(a,c)},null,"editRoleName")};
RoomMorph.prototype.moveToRole=function(a){var b=this;b.ide.showMessage("moving to "+a.name);SnapCloud.getProject(SnapCloud.projectId,function(c){b.ide.showMessage("moved to "+a.name+"!");b.ide.silentSetProjectName(a.name);b.ide.source="cloud";c?("true"===c.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(c.ProjectName)),c.SourceCode?b.ide.droppedText(c.SourceCode):SnapActions.openProject()):SnapActions.openProject()},function(c,
d){b.ide.cloudError().call(null,c,d)},a.id)};RoomMorph.prototype.deleteRole=function(a){var b=this;SnapCloud.deleteRole(a.id,function(c){b.onRoomStateUpdate(c);b.ide.showMessage("deleted "+a.name+"!")},function(c,d){b.ide.cloudError().call(null,c,d)})};RoomMorph.prototype.createRoleClone=function(a){var b=this,c=this.getRoles().find(function(d){return d.id===a}).name;SnapCloud.cloneRole(a,function(d){b.onRoomStateUpdate(d);b.ide.showMessage("created copy of "+c)},b.ide.cloudError())};
RoomMorph.prototype.role=function(){return this.ide.projectName};RoomMorph.prototype.setRoleName=function(a,b){var c=this;b&&(-1!==c.getRoleNames().indexOf(b)?c.ide.showMessage(localize("Role name already exists.")):c.validateRoleName(b,function(){SnapCloud.renameRole(a,b,function(d){c.onRoomStateUpdate(d)},c.ide.cloudError())}))};
RoomMorph.prototype.evictUser=function(a){var b=this;SnapCloud.evictUser(a.uuid,function(c){b.onRoomStateUpdate(c);b.ide.showMessage("evicted "+a.username+"!")},function(c,d){b.ide.cloudError().call(null,c,d)})};
RoomMorph.prototype.inviteUser=function(a){var b=this,c=this;var d=function(e){e.unshift("myself");var f=b.world();e=new UserDialogMorph(b,function(g){g&&b.inviteGuest(g,a.id)},e);e.popUp(f);e.setCenter(f.center());e.filterField.edit()};this.isOwner()||this.isCollaborator()?SnapCloud.getFriendList(d,function(e,f){c.ide.cloudError().call(null,e,f)}):d([])};
RoomMorph.prototype.promptShare=function(a){var b=this.getRoleNames(),c={},d=this.world(),e=this;b.splice(b.indexOf(this.ide.projectName),1);for(var f=0;f<b.length;f++)c[b[f]]=b[f];if(Object.keys(b).length){var g=new DialogBoxMorph;g.prompt("Send to...","",d,!1,c);g.accept=function(){var h=g.getInput();-1!==b.indexOf(h)?e.getRole(h)?(e.ide.sockets.sendMessage({type:"share-msg-type",roleId:h,from:e.ide.projectName,name:a,fields:e.ide.stage.messageTypes.getMsgType(a).fields}),e.ide.showMessage("Successfully sent!",
2)):(e.sharedMsgs.push({roleId:h,msg:{name:a,fields:e.ide.stage.messageTypes.getMsgType(a).fields},from:e.ide.projectName}),e.ide.showMessage("The role will receive this message type on next occupation.",2)):e.ide.showMessage("There is no role by the name of '"+h+"'!",2);this.destroy()}}else e.ide.showMessage("There are no other roles in the room!",2)};RoomMorph.prototype.inviteGuest=function(a,b){"myself"===a&&(a=SnapCloud.username);SnapCloud.inviteGuest(a,b)};
RoomMorph.prototype.promptInvite=function(a,b,c,d){var e=this,f=(new DialogBoxMorph(null,function(){return e.respondToInvitation(a,b,!0)})).withKey(a);c=d===SnapCloud.username?'Would you like to move to "'+c+'"?':d+' has invited you to join\nhim/her at "'+c+'"';var g=f.cancel;f.cancel=function(){e.respondToInvitation(a,b,!1);g.call(f)};f.askYesNo("Room Invitation",localize(c),this.ide.world());setTimeout(function(){return f.destroy()},3E4)};
RoomMorph.prototype.respondToInvitation=function(a,b,c){var d=this;SnapCloud.respondToInvitation(a,c,function(e){var f;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){if(1==g.nextAddress){if(!c)return g.return();d.ide.source="cloud";"true"===e.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(e.ProjectName));f=d.ide.showMessage(localize("Opening ")+b+localize(" at ")+e.RoomName);if(e.SourceCode)return g.yield(d.ide.droppedText(e.SourceCode),
3);d.ide.newRole(b);return g.yield(SnapActions.openProject(),3)}f.destroy();d.ide.silentSetProjectName(b);SnapCloud.disconnect();g.jumpToEnd()})},function(e){return d.ide.showMessage(e,2)})};
RoomMorph.prototype.checkForSharedMsgs=function(a){for(var b=0;b<this.sharedMsgs.length;b++)this.sharedMsgs[b].roleId===a&&(this.ide.sockets.sendMessage({type:"share-msg-type",name:this.sharedMsgs[b].msg.name,fields:this.sharedMsgs[b].msg.fields,from:this.sharedMsgs[b].from,roleId:a}),this.sharedMsgs.splice(b,1),b--)};
RoomMorph.prototype.showMessage=function(a,b){var c=this,d=a.srcId.split("@"),e=d.shift(),f=d.join("@");d=a.recipients.filter(function(g){var h=g.split("@");g=h.shift();h=h.join("@")===f;g=!!c.getRole(g);return h&&g}).map(function(g){return g.split("@").shift()});this.getRole(e)&&d.forEach(function(g){c.showSentMsg(a,e,g,b)})};
RoomMorph.prototype.showSentMsg=function(a,b,c,d){var e=this.getRole(b);e=this.getRole(c).center().subtract(e.center());b=new SentMessageMorph(a,b,c,e,d);this.addBack(b);this.displayedMsgMorphs.push(b);this.updateDisplayedMsg(b);this.clearBlockHighlights();c===this.getCurrentRoleName()&&(c=this.ide.stage,this.blockHighlights=c.children.concat(c).map(function(f){var g=[];if(f instanceof SpriteMorph||f instanceof StageMorph)g=f.allHatBlocksForSocket(a.msgType);return g}).reduce(function(f,g){return f.concat(g)},
[]).map(function(f){return f.addHighlight()}));this.messageInspector&&(d?(this.messageInspector.destroy(),this.messageInspector=null):this.messageInspector.setMessage(b.message))};
RoomMorph.prototype.updateDisplayedMsg=function(a){var b=this.getRole(a.srcRoleName),c=this.getRole(a.dstRoleName),d=b.center();c=c.center();var e=c.subtract(d),f=this.getRoleSize()/2,g=c.distanceTo(d);e=e.scaleBy((g-2*f)/g);f=e.abs().add(2*a.padding);a.setExtent(f);a.setCenter(c.add(d).divideBy(2));a.endpoint=e;a.setMessageColor(b.color.darker());a.rerender()};
RoomMorph.prototype.clearBlockHighlights=function(){this.blockHighlights.forEach(function(a){var b=a.parent;b&&b.getHighlight()===a&&b.removeHighlight()});this.blockHighlights=[]};RoomMorph.prototype.hideSentMsgs=function(){this.displayedMsgMorphs.forEach(function(a){a.destroy()});this.displayedMsgMorphs=[]};RoomMorph.prototype.isCapturingTrace=function(){return this.trace.startTime&&!this.trace.endTime};RoomMorph.prototype.isReplayingTrace=function(){return!!this.trace.replayer};
RoomMorph.prototype.startTraceReplay=function(a){this.setReadOnly(!0);a.setMessages(this.trace.messages);this.trace.replayer=a};RoomMorph.prototype.stopTraceReplay=function(){this.hideSentMsgs();this.clearBlockHighlights();this.setReadOnly(!1);this.trace.replayer=null;this.messageInspector&&(this.messageInspector.destroy(),this.messageInspector=null)};RoomMorph.prototype.resetTrace=function(){this.trace={}};
RoomMorph.prototype.startTrace=function(){var a=this.ide,b=a.resourceURL("api","trace","start",SnapCloud.projectId,SnapCloud.clientId);this.trace={startTime:+a.getURL(b)}};RoomMorph.prototype.endTrace=function(){this.trace.endTime=Date.now();this.trace.messages=this.getMessagesForTrace();0===this.trace.messages.length&&(this.ide.showMessage("No messages captured",2),this.resetTrace())};
RoomMorph.prototype.getMessagesForTrace=function(){var a=this.ide,b=a.resourceURL("api","trace","end",SnapCloud.projectId,SnapCloud.clientId),c=[];try{c=JSON.parse(a.getURL(b))}catch(d){throw a.showMessage("Failed to retrieve messages",2),this.resetTrace(),d;}return c};RoomMorph.prototype.inspectMessage=function(a){this.messageInspector=new MessageInspectorMorph(a);this.messageInspector.popUp(this.world())};SentMessageMorph.prototype=new Morph;SentMessageMorph.prototype.constructor=SentMessageMorph;
SentMessageMorph.uber=Morph.prototype;function SentMessageMorph(a,b,c,d,e){this.init(a,b,c,d,e)}SentMessageMorph.prototype.init=function(a,b,c,d,e){this.srcRoleName=b;this.dstRoleName=c;this.padding=10;this.endpoint=d;this.message=new MessageMorph(a.msgType,a.content);SentMessageMorph.uber.init.call(this);this.label=null;e&&(this.label=new StringMorph(e.toString(),18,null,null,!0),this.label.color=WHITE,this.label.rerender(),this.add(this.label));this.color=WHITE;this.add(this.message)};
SentMessageMorph.prototype.render=function(a){var b=new Point(0<this.endpoint.x?0:-this.endpoint.x,0<this.endpoint.y?0:-this.endpoint.y);b=b.add(this.padding);var c=b.add(this.endpoint);a.strokeStyle=this.color.toString();a.fillStyle=this.color.toString();a.lineWidth=2.5;a.beginPath();a.setLineDash([5,5]);a.moveTo(b.x,b.y);a.lineTo(c.x,c.y);a.stroke();a.beginPath();a.setLineDash([]);var d=Math.PI/6,e=Math.atan2(this.endpoint.y,this.endpoint.x)+Math.PI;b=(new Point(Math.cos(e-d),Math.sin(e-d))).multiplyBy(7.5);
d=(new Point(Math.cos(e+d),Math.sin(e+d))).multiplyBy(7.5);b=c.add(b);d=c.add(d);a.moveTo(c.x,c.y);a.lineTo(b.x,b.y);a.lineTo(d.x,d.y);a.lineTo(c.x,c.y);a.stroke();a.fill();this.fixLayout()};SentMessageMorph.prototype.fixLayout=function(){this.message.setCenter(this.center());this.label&&(this.label.setCenter(this.message.center()),this.label.setRight(this.message.left()-5))};SentMessageMorph.prototype.setMessageColor=function(a){this.message.icon.setColor(a)};MessageMorph.prototype=new Morph;
MessageMorph.prototype.constructor=MessageMorph;MessageMorph.uber=Morph.prototype;function MessageMorph(a,b){this.init(a,b)}MessageMorph.prototype.init=function(a,b){this.msgType=a;this.contents=b;MessageMorph.uber.init.call(this);this.setColor(IDE_Morph.prototype.groupColor);this.icon=new SymbolMorph("mail",25);this.icon.setHeight(25);this.icon.rerender();this.label=new StringMorph(a,12,null,null,!0);this.label.color=WHITE;this.label.rerender();this.add(this.label);this.add(this.icon);this.fixLayout()};
MessageMorph.prototype.fixLayout=function(){this.icon.setCenter(this.center());this.icon.setTop(this.top());this.label.setCenter(this.center());this.label.setBottom(this.bottom())};MessageMorph.prototype.getTableContents=function(){var a=this,b=Object.keys(this.contents),c=new Table(2,b.length);b.forEach(function(d,e){c.contents[e][0]=d;c.contents[e][1]=a.deserializeData([a.contents[d]])[0]});c.colNames.push("field");c.colNames.push("value");return c};MessageMorph.prototype.deserializeData=WebSocketManager.prototype.deserializeData;
MessageMorph.prototype.mouseClickLeft=function(){this.parentThatIsA(RoomMorph).inspectMessage(this)};MessageInspectorMorph.prototype=Object.create(TableDialogMorph.prototype);MessageInspectorMorph.prototype.constructor=MessageInspectorMorph;MessageInspectorMorph.uber=TableDialogMorph.prototype;function MessageInspectorMorph(a){this.init(a)}
MessageInspectorMorph.prototype.init=function(a){MessageInspectorMorph.uber.init.call(this,a.getTableContents());this.key="inspectNetworkMessage";this.labelString=localize("Contents of")+' "'+a.msgType+'"';this.createLabel()};
MessageInspectorMorph.prototype.setInitialDimensions=function(){var a=this.world().extent().subtract(new Point(this.padding,this.padding)),b=fontHeight(this.titleFontSize)+3*this.titlePadding,c=Math.max(100,this.label.width()+2*e),d=this.buttons.height(),e=10;this.setExtent(this.tableView.globalExtent().add(new Point(2*this.padding,2*this.padding+b+d)).min(a).max(new Point(c,100)));this.setCenter(this.world().center())};
MessageInspectorMorph.prototype.setMessage=function(a){this.tableView=new TableMorph(a.getTableContents());this.labelString=localize("Contents of")+' "'+a.msgType+'"';this.createLabel();this.addBody(new TableFrameMorph(this.tableView,!0));this.fixLayout();this.rerender()};NetworkReplayControls.prototype=Object.create(ReplayControls.prototype);NetworkReplayControls.prototype.constructor=NetworkReplayControls;NetworkReplayControls.uber=ReplayControls.prototype;
function NetworkReplayControls(){this.init()}NetworkReplayControls.prototype.init=function(){NetworkReplayControls.uber.init.call(this);this.displayedMsgCount=1};NetworkReplayControls.prototype.displayCaption=function(){};NetworkReplayControls.prototype.setMessages=function(a){return this.setActions(a)};NetworkReplayControls.prototype.applyEvent=function(a,b){this.updateDisplayedMessages();b()};
NetworkReplayControls.prototype.updateDisplayedMessages=function(){var a=this.parentThatIsA(IDE_Morph).room,b=this.actions[this.actionIndex];a.hideSentMsgs();if(b){var c=this.getSliderPosition(b);this.slider.button.setLeft(this.getSliderLeftFromValue(c));this.slider.updateValue();if(1<this.displayedMsgCount){c=Math.min(this.displayedMsgCount,this.actionIndex+1);for(var d=this.actionIndex-c+1,e=0;e<c;e++)b=this.actions[d+e],a.showMessage(b,e+1)}else a.showMessage(b)}};
NetworkReplayControls.prototype.settingsMenu=function(){var a=this,b=NetworkReplayControls.uber.settingsMenu.call(this),c=new MenuMorph(a);[1,2,3,4,5].forEach(function(d){c.addItem(d+" "+localize(1===d?"message":"messages"),function(){a.displayedMsgCount=d;a.updateDisplayedMessages()},null,null,a.displayedMsgCount===d)});b.addMenu("Displayed Message Count...",c);b.rerender();return b};
NetworkReplayControls.prototype.getColorForTick=function(a){var b=this.parentThatIsA(IDE_Morph).room;a=a.srcId.split("@").shift();if(b=b.getRole(a))return b.color};NetworkReplayControls.prototype.getInverseEvent=function(a){a=copy(a);a.isInverse=!0;return a};RoleMorph.prototype=new Morph;RoleMorph.prototype.constructor=RoleMorph;RoleMorph.uber=Morph.prototype;
RoleMorph.COLORS=[new Color(74,108,212),(new Color(217,77,17)).lighter(),new Color(207,74,217),new Color(0,161,120),new Color(143,86,227),new Color(230,168,34),new Color(4,148,220),new Color(98,194,19),new Color(243,118,29),new Color(150,150,150)].map(function(a){return a.darker()});function RoleMorph(a,b,c){this.init(a,b,c)}
RoleMorph.prototype.init=function(a,b,c){RoleMorph.uber.init.call(this,!0);this.id=a;this.name=b;this.users=[];this.label=new StringMorph(this.name,15,null,!0,!1,!1,null,null,WHITE);this.label.mouseClickLeft=function(){var d=this.parentThatIsA(RoomMorph);d.isEditable()&&d.editRoleName(a)};this.label.mouseEnter=function(){this.parentThatIsA(RoomMorph).isEditable()&&this.setFontSize(17)};this.label.mouseLeave=function(){this.setFontSize(15)};this.caption=new StringMorph("",14,null,!1,!0,!1,null,null,
WHITE);this.add(this.label);this.add(this.caption);this.acceptsDrops=!0;this.setOccupants(c);this.rerender()};RoleMorph.prototype.setName=function(a){this.name=a;this.label.text=a;this.label.rerender()};RoleMorph.prototype.wantsDropOf=function(a){return a instanceof ReporterBlockMorph&&a.forMsg};
RoleMorph.prototype.setOccupants=function(a){this.users=a;a="<empty>";this.users.length&&(a=this.users.map(function(b){return b.username||localize("guest")}).join(", "));this.caption.text=a;this.caption.changed();this.caption.fixLayout();this.caption.rerender()};RoleMorph.prototype.setName=function(a){this.name=a;this.label.text=a;this.label.changed();this.label.fixLayout();this.label.rerender()};
RoleMorph.prototype.render=function(a){var b=this.parentThatIsA(RoomMorph);b&&b.isReadOnly?this.caption.hide():this.caption.show();this.fixLayout();var c=Math.max(this.height()-this.caption.height(),0);b=Math.min(this.width(),c)/2;c=(new Point(this.width()/2-b,c/2-b)).add(b);a.beginPath();a.fillStyle=this.color.toString();a.arc(c.x,c.y,b,0,2*Math.PI,!1);a.closePath();a.fill();a.strokeStyle=this.color.darker(50).toString();a.stroke();this.changed()};
RoleMorph.prototype.fixLayout=function(){var a=this.center();this.label.setCenter(new Point(a.x,a.y-this.caption.height()/2));this.caption.setCenter(a);this.caption.setBottom(this.bottom())};RoleMorph.prototype.mouseClickLeft=function(){var a=this.parentThatIsA(RoomMorph);a.isEditable()?a.editRole(this):this.escalateEvent("mouseClickLeft")};
RoleMorph.prototype.reactToDropOf=function(a){function b(e,f,g){e.users.length&&e.parent.ide.projectName===e.name?e.parent.ide.showMessage("Can't send a message type to yourself!",2):e.users&&e.parent.ide.projectName!==e.name?(e.parent.ide.sockets.sendMessage({type:"share-msg-type",roleId:e.name,from:e.parent.ide.projectName,name:f,fields:g}),e.parent.ide.showMessage("Successfully sent!",2)):(e.parent.sharedMsgs.push({roleId:e.name,msg:{name:f,fields:g},from:e.parent.ide.projectName}),e.parent.ide.showMessage("The role will receive this message type on next occupation.",
2))}a instanceof ReporterBlockMorph&&a.forMsg&&b(this,a.blockSpec,this.parent.ide.stage.messageTypes.getMsgType(a.blockSpec).fields);if("receiveSocketMessage"===a.selector||"doSocketMessage"===a.selector){for(var c,d=0;d<a.children.length;d++)if(a.children[d]instanceof MessageOutputSlotMorph||a.children[d]instanceof MessageInputSlotMorph){c=a.children[d];break}""!==c.children[0].text&&b(this,c.children[0].text,c.msgFields)}a.destroy()};EditRoleMorph.prototype=new DialogBoxMorph;
EditRoleMorph.prototype.constructor=EditRoleMorph;EditRoleMorph.uber=DialogBoxMorph.prototype;function EditRoleMorph(a,b){this.init(a,b)}
EditRoleMorph.prototype.init=function(a,b){var c=b.name;EditRoleMorph.uber.init.call(this);this.room=a;this.role=b;this.users=b.users;a=new TextMorph("What would you like to do?",null,null,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),WHITE);this.labelString=localize("Edit")+" "+c;this.createLabel();this.addBody(a);this.addButton("createRoleClone","Duplicate");b.users.length?(c!==this.room.role()&&this.addButton("moveToRole","Move to"),this.addButton("inviteUser","Invite User"),
b=this.role.users.filter(function(d){return d.uuid!==SnapCloud.clientId}).length,this.room.isOwner()&&b&&this.addButton("evictUser","Evict User")):(this.addButton("moveToRole","Move to"),this.addButton("inviteUser","Invite User"),this.addButton("deleteRole","Delete role"));this.addButton("cancel","Cancel");this.fixLayout()};EditRoleMorph.prototype.inviteUser=function(){this.room.inviteUser(this.role);this.destroy()};
EditRoleMorph.prototype.fixLayout=function(){var a=this.center();EditRoleMorph.uber.fixLayout.call(this);this.label&&this.label.setLeft(a.x-this.label.width()/2);this.body&&this.body.setLeft(a.x-this.body.width()/2)};EditRoleMorph.prototype.editRoleName=function(){this.room.editRoleName(this.role.name);this.destroy()};EditRoleMorph.prototype.createRoleClone=function(){this.room.createRoleClone(this.role.id);this.destroy()};
EditRoleMorph.prototype.deleteRole=function(){this.room.deleteRole(this.role);this.destroy()};
EditRoleMorph.prototype.moveToRole=function(){var a=this,b=this.room.ide,c=this.room.getCurrentRoleName(),d=function(){a.room.moveToRole(a.role)};a.destroy();if(0<SnapActions.lastSeen){var e=new DialogBoxMorph(null);e.accept=function(){SnapCloud.saveProject(b,function(){b.showMessage("Saved "+c+" to cloud!",2);d()},b.cloudError());e.destroy()};e.cancel=function(){d();e.destroy()};e.askYesNo(localize("Save Current Role"),localize("Would you like to save changes to")+" "+c+" "+localize("before moving to")+
" "+a.role.name+"?",a.world())}else d()};EditRoleMorph.prototype.evictUser=function(){var a=this.role.users.find(function(b){return b.uuid!==SnapCloud.clientId});this.room.evictUser(a);this.destroy()};RoomEditorMorph.prototype=new ScrollFrameMorph;RoomEditorMorph.prototype.constructor=RoomEditorMorph;RoomEditorMorph.uber=ScrollFrameMorph.prototype;function RoomEditorMorph(a,b){this.init(a,b)}
RoomEditorMorph.prototype.init=function(a,b){RoomEditorMorph.uber.init.call(this,null,null,b);this.room=a;this.add(a);this.palette=this.createMsgPalette();this.add(this.palette);this.room.checkForSharedMsgs(this.room.getCurrentRoleName());this.room.isReplayingTrace()?this.replayControls=this.room.trace.replayer:(this.replayControls=new NetworkReplayControls(this),this.replayControls.hide());this.add(this.replayControls);this.replayControls.rerender();a=new PushButtonMorph(this.room,"createNewRole",
new SymbolMorph("cross",12));a.padding=0;a.corner=12;a.color=IDE_Morph.prototype.groupColor;a.highlightColor=IDE_Morph.prototype.frameColor.darker(50);a.pressColor=a.highlightColor;a.labelMinExtent=new Point(36,18);a.labelShadowOffset=new Point(-1,-1);a.labelShadowColor=a.highlightColor;a.labelColor=TurtleIconMorph.prototype.labelColor;a.contrast=this.buttonContrast;a.rerender();a.hint="Add a role to the room";a.fixLayout();this.add(a);this.addRoleBtn=a;this.room.rerender();this.updateToolbar();this.acceptsDrops=
!1;this.contents.acceptsDrops=!1};RoomEditorMorph.prototype.step=function(){this.version!==this.room.version&&(this.updateToolbar(),this.version=this.room.version);this.palette.version!==this.room.ide.stage.messageTypes.version&&this.updateMsgPalette()};RoomEditorMorph.prototype.show=function(){RoomEditorMorph.uber.show.call(this);this.isReplayMode()||this.replayControls.hide()};
RoomEditorMorph.prototype.updateToolbar=function(){var a=this.parentThatIsA(ScrollFrameMorph);a&&(a.toolBar&&(a.removeChild(a.toolBar),this.changed()),a.toolBar=this.addToolbar(),a.add(a.toolBar),a.toolBar.fixLayout(),a.toolBar.rerender(),a.adjustToolBar(),this.updateRoomControls())};
RoomEditorMorph.prototype.addToolbar=function(){var a=this,b=new AlignmentMorph,c=new Color(140,140,140),d=new SymbolMorph("circleSolid",14),e=new SymbolMorph("square",14),f=new SymbolMorph("pointRight",14),g=new SymbolMorph("square",14);this.hasNetworkRecording()&&(f=new PushButtonMorph(this,function(){this.isReplayMode()?a.exitReplayMode():a.enterReplayMode();a.updateToolbar()},this.isReplayMode()?g:f,null,this.isReplayMode()?localize("Exit network trace replayer"):localize("View last network trace")),
f.alpha=.2,f.labelShadowColor=c,f.rerender(),f.fixLayout(),b.replayButton=f,b.add(f));d=new PushButtonMorph(this,function(){this.isReplayMode()&&a.exitReplayMode();a.toggleRecordMode();a.updateToolbar()},this.isRecording()?e:d,null,this.isRecording()?localize("Stop capturing network trace"):localize("Start capturing network trace"));d.labelColor=new Color(125,0,0);d.alpha=.2;d.labelShadowColor=c;d.rerender();d.fixLayout();b.recordButton=d;b.add(d);return b};
RoomEditorMorph.prototype.fixLayout=function(){var a=this.extent();a.y-=115;this.room.setExtent(a);this.room.setCenter(this.center().subtract(40));this.room.fixLayout();this.updateMsgPalette();this.addRoleBtn.setCenter(this.room.center());this.addRoleBtn.setTop(this.room.roomName.bottom()+5);this.replayControls.setWidth(this.width()-40);this.replayControls.setHeight(80);this.replayControls.setCenter(new Point(this.center().x,0));this.replayControls.setBottom(this.bottom());this.replayControls.fixLayout()};
RoomEditorMorph.prototype.setExtent=function(a){RoomEditorMorph.uber.setExtent.call(this,a);this.fixLayout()};RoomEditorMorph.prototype.isRecording=function(){return this.room.isCapturingTrace()};RoomEditorMorph.prototype.hasNetworkRecording=function(){var a=this.room.trace;return!(!a.startTime||!a.endTime)};RoomEditorMorph.prototype.toggleRecordMode=function(){this.isRecording()?this.exitRecordMode():this.enterRecordMode()};
RoomEditorMorph.prototype.enterRecordMode=function(){SnapActions.isCollaborating()?this.room.ide.showMessage(localize("Cannot trace network actions while collaborating")):this.room.startTrace()};RoomEditorMorph.prototype.exitRecordMode=function(){this.room.endTrace()};RoomEditorMorph.prototype.isReplayMode=function(){return this.replayControls.enabled};RoomEditorMorph.prototype.exitReplayMode=function(){this.replayControls.disable();this.room.stopTraceReplay()};
RoomEditorMorph.prototype.enterReplayMode=function(){SnapActions.isCollaborating()?this.room.ide.showMessage(localize("Cannot replay network actions while collaborating")):(this.replayControls.enable(),this.room.startTraceReplay(this.replayControls),this.updateRoomControls())};RoomEditorMorph.prototype.updateRoomControls=function(){this.room.rerender();this.room.isEditable()&&!this.isReplayMode()?this.addRoleBtn.show():this.addRoleBtn.hide()};
RoomEditorMorph.prototype.createMsgPalette=function(){var a=new ScrollFrameMorph;a.setColor(new Color(0,0,0,0));a.acceptsDrops=!1;a.contents.acceptsDrops=!1;return a};
RoomEditorMorph.prototype.updateMsgPalette=function(){var a=this.room.ide.stage,b=this.palette,c=a.deletableMessageNames();b.contents.children.forEach(function(k){b.contents.removeChild(k)});var d=new Point(b.bounds.origin.x+10,b.bounds.origin.y+10),e=new Rectangle;e.origin=b.bounds.origin.copy();e.setExtent(ZERO);for(var f=0;f<c.length;f++){var g=new ReporterBlockMorph;g.category="network";g.blockSpec=c[f];g.setSpec(c[f]);g.forMsg=!0;g.isTemplate=!0;g.setColor(new Color(217,77,17));g.setPosition(d);
d.y+=g.height()+10;e.mergeWith(g.bounds);g.justDropped=function(){this.destroy()};g.mouseClickLeft=function(){var k=new SpeechBubbleMorph(0===a.messageTypes.msgTypes[this.blockSpec].fields.length?"This message type has no fields.":a.messageTypes.msgTypes[this.blockSpec].fields,null,null,2),l=(new Point(0,0)).add(this.bounds.corner);k.popUp(this.world(),l)};var h=new MenuMorph(this,null);h.addItem("Send to...",function(){this.room.promptShare(g.blockSpec)});g.children[0].customContextMenu=h;g.customContextMenu=
h;b.contents.add(g)}c=this.room.getRoles().map(function(k){return k.left()}).reduce(function(k,l){return Math.min(l,k)},Infinity)-this.left();d=this.room.height();b.bounds.setWidth(Math.min(e.width()+10,c));b.bounds.setHeight(Math.min(e.height()+10,d));e=b.contents.children.reduce(function(k,l){return k.max(l.bounds.extent())},b.bounds.extent());b.contents.bounds.setExtent(e);b.contents.adjustBounds();b.fixLayout();b.rerender();b.version=a.messageTypes.version};UserDialogMorph.prototype=new DialogBoxMorph;
UserDialogMorph.prototype.constructor=UserDialogMorph;UserDialogMorph.uber=DialogBoxMorph.prototype;function UserDialogMorph(a,b,c){this.init(a,b,c)}UserDialogMorph.prototype.init=function(a,b,c){this.key="inviteGuest";this.userList=c;UserDialogMorph.uber.init.call(this,a,b,null);this.buildContents()};
UserDialogMorph.prototype.buildContents=function(){this.addBody(new Morph);this.body.color=this.color;this.buildFilterField();this.listField=new ListMorph(this.userList);this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.render=InputFieldMorph.prototype.render;
this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.body.add(this.listField);this.labelString="Invite a Friend to the Room";this.createLabel();this.addButton("ok","OK");this.addButton("cancel","Cancel");this.setHeight(300);this.fixLayout()};
UserDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding,b=this.filterField,c=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout();this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-a-this.buttons.height())),b.setWidth(this.body.width()-6*this.padding),
b.setLeft(this.body.left()+3*this.padding),b.rerender(),this.listField.setLeft(this.body.left()+this.padding),this.listField.setWidth(this.body.width()-this.padding),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(b.bottom()+this.padding),this.listField.setHeight(this.body.height()-b.height()-this.padding),this.magnifyingGlass&&(this.magnifyingGlass.setTop(b.top()),this.magnifyingGlass.setLeft(this.listField.left())));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+
(a-this.label.height())/2));this.buttons&&0<this.buttons.children.length&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding));Morph.prototype.trackChanges=c;this.changed()};UserDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors;UserDialogMorph.prototype.buildFilterField=ProjectDialogMorph.prototype.buildFilterField;UserDialogMorph.prototype.getInput=function(){return this.listField.selected};
UserDialogMorph.prototype.buildFilterField=function(){var a=this;this.filterField=new InputFieldMorph("");this.magnifyingGlass=new SymbolMorph("magnifyingGlass",this.filterField.height(),this.titleBarColor.darker(50));this.body.add(this.magnifyingGlass);this.body.add(this.filterField);this.filterField.reactToKeystroke=function(){var b=this.getValue();a.listField.elements=a.userList.filter(function(c){return-1<c.toLowerCase().indexOf(b.toLowerCase())});0===a.listField.elements.length&&a.listField.elements.push("(no matches)");
a.listField.buildListContents();a.fixListFieldItemColors();a.listField.adjustScrollBars();a.listField.scrollY(a.listField.top());a.fixLayout()}};UserDialogMorph.prototype.popUp=function(a){if(a=a||this.target.world())UserDialogMorph.uber.popUp.call(this,a),this.handle=new HandleMorph(this,200,100,this.corner,this.corner)};CollaboratorDialogMorph.prototype=new UserDialogMorph;CollaboratorDialogMorph.prototype.constructor=CollaboratorDialogMorph;CollaboratorDialogMorph.uber=UserDialogMorph.prototype;
function CollaboratorDialogMorph(a,b,c){this.init(a,b,c)}
CollaboratorDialogMorph.prototype.buildContents=function(){var a=this;this.addBody(new Morph);this.body.color=this.color;this.buildFilterField();this.listField=new ListMorph(this.userList,0<this.userList.length?function(b){return b.username||b}:null,[["bold",function(b){return b.collaborating}]]);this.listField.action=function(b){void 0!==b&&(b.collaborating?(a.collaborateButton.hide(),a.uncollaborateButton.show()):(a.uncollaborateButton.hide(),a.collaborateButton.show()),a.buttons.fixLayout(),a.fixLayout(),
a.edit())};this.filterField.reactToKeystroke=function(){var b=this.getValue();a.listField.elements=a.userList.filter(function(c){return-1<c.username.toLowerCase().indexOf(b.toLowerCase())});0===a.listField.elements.length&&a.listField.elements.push("(no matches)");a.listField.buildListContents();a.fixListFieldItemColors();a.listField.adjustScrollBars();a.listField.scrollY(a.listField.top());a.fixLayout()};this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;
this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.render=InputFieldMorph.prototype.render;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.body.add(this.listField);this.labelString="Invite a Friend to Collaborate";this.createLabel();this.uncollaborateButton=this.addButton(function(){SnapCloud.evictCollaborator(a.listField.selected.username);
a.destroy()},"Remove");this.collaborateButton=this.addButton("ok","Invite");this.uncollaborateButton.hide();this.collaborateButton.hide();this.addButton("cancel","Cancel");this.setHeight(300);this.fixLayout()};NetsBloxMorph.prototype=Object.create(IDE_Morph.prototype);NetsBloxMorph.prototype.constructor=NetsBloxMorph;NetsBloxMorph.uber=IDE_Morph.prototype;function NetsBloxMorph(a){this.init(a)}
NetsBloxMorph.prototype.init=function(a){this.sockets=new WebSocketManager(this);Services.onInvalidHosts=this.onInvalidHosts.bind(this);this.room=null;NetsBloxMorph.uber.init.call(this,a);this.serializer=new NetsBloxSerializer;var b=this;window.addEventListener("ideLoaded",function(){b.isSupportedBrowser()||b.showBrowserNotification()})};
NetsBloxMorph.prototype.onInvalidHosts=function(a){a=a.map(function(b){var c=b.categories[0];return c?c+" ("+b.url+")":b.url}).join("\n");this.inform("Invalid Services Hosts","The following have been registered to provide additional\nNetsBlox services but are unavailable:\n\n"+a,this.world())};NetsBloxMorph.prototype.buildPanes=function(){this.createRoom();NetsBloxMorph.uber.buildPanes.call(this)};
NetsBloxMorph.prototype.clearProject=function(){this.source=SnapCloud.username?"cloud":"local";this.stage&&this.stage.destroy();"#lang:"!==location.hash.substr(0,6)&&(location.hash="");this.globalVariables=new VariableFrame;this.currentSprite=new SpriteMorph(this.globalVariables);this.sprites=new List([this.currentSprite]);StageMorph.prototype.dimensions=new Point(480,360);StageMorph.prototype.hiddenPrimitives={};StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=
!1;StageMorph.prototype.enableInheritance=!1;StageMorph.prototype.enableSublistIDs=!1;SpriteMorph.prototype.useFlatLineEnds=!1;Process.prototype.enableLiveCoding=!1;this.silentSetProjectName("");this.projectNotes="";this.createStage();this.add(this.stage);this.createCorral();this.selectSprite(this.stage.children[0]);this.fixLayout()};
NetsBloxMorph.prototype.cloudMenu=function(){var a=this,b,c,d,e;return $jscomp.asyncExecutePromiseGeneratorProgram(function(f){if(1==f.nextAddress)return b=NetsBloxMorph.uber.cloudMenu.call(a),(c=a.cloud.username)?f.yield(a.cloud.getUserData(),3):f.jumpTo(2);2!=f.nextAddress&&(e=(d=f.yieldResult)?d.linkedAccounts:[],0===e.length?b.addItem("Link to Snap! account...","linkAccount"):b.addItem(localize("Unlink Snap! account..."),function(){return a.unlinkAccount(d.linkedAccounts[0])}));a.cloud.username&&
a.room.isOwner()&&(b.addLine(),b.addItem("Collaborators...","manageCollaborators"));return f.return(b)})};NetsBloxMorph.prototype.settingsMenu=function(){var a=NetsBloxMorph.uber.settingsMenu.call(this);a.items=a.items.filter(function(b){return"toggleCollaborativeEditing"!==b[1].toString()});return a};
NetsBloxMorph.prototype.newProject=function(a){var b=this,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){switch(d.nextAddress){case 1:return d.setCatchFinallyBlocks(2),d.yield(SnapCloud.newProject(a),4);case 4:c=d.yieldResult;d.leaveTryBlock(3);break;case 2:d.enterCatchBlock(),c={name:a||"untitled",roleName:"myRole",projectId:b.cloud.projectId,roleId:b.cloud.roleId};case 3:return d.yield(b.newProjectFromInfo(c,!a),0)}})};
NetsBloxMorph.prototype.newProjectFromInfo=function(a,b){var c=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){if(1==d.nextAddress)return c.createRoom(),c.room.silentSetRoomName(a.name),b&&c.updateUrlQueryString(),d.yield(SnapActions.openProject(),2);c.silentSetProjectName(a.roleName);d.jumpToEnd()})};NetsBloxMorph.prototype.newRole=function(a){this.clearProject();a&&this.silentSetProjectName(a)};NetsBloxMorph.prototype.createRoom=function(){this.room=new RoomMorph(this)};
NetsBloxMorph.prototype.createSpriteEditor=function(){"room"===this.currentTab?(this.spriteEditor&&this.spriteEditor.destroy(),this.spriteEditor=new RoomEditorMorph(this.room,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor)):NetsBloxMorph.uber.createSpriteEditor.call(this)};
NetsBloxMorph.prototype.promptExitTraceReplay=function(a){var b=this;this.confirm("The given action cannot be applied while replaying network trace. \nWould you like to stop replaying the network trace?","Stop replaying network trace?",function(){"room"===this.currentTab?this.spriteEditor.exitReplayMode():b.room.stopTraceReplay();a()})};
NetsBloxMorph.prototype.promptExitTraceCapture=function(a){var b=this;this.confirm("The given action cannot be applied while capturing network trace. \nWould you like to stop capturing the network trace?","Stop capturing network trace?",function(){b.room.endTrace();a()})};NetsBloxMorph.prototype.setProjectName=function(a){this.room.setRoleName(a)};NetsBloxMorph.prototype.silentSetProjectName=function(a){return NetsBloxMorph.uber.setProjectName.call(this,a)};
NetsBloxMorph.prototype.createControlBar=function(){var a=this;NetsBloxMorph.uber.createControlBar.call(this);this.controlBar.updateLabel=function(){var b=a.room.name,c="";1<a.room.getRoleNames().length&&(b=a.projectName||localize("untitled"),c=" @ "+a.room.name);c+=a.world().isDevMode?" - "+localize("development mode"):"";this.label&&this.label.destroy();a.isAppMode||(document.title=b+c+" - "+a.serializer.appName,this.label=new StringMorph(b+c,14,"sans-serif",!0,!1,!1,MorphicPreferences.isFlat?null:
new Point(2,1),a.frameColor.darker(a.buttonContrast)),this.label.color=a.buttonLabelColor,this.label.rerender(),this.add(this.label),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+5))}};
NetsBloxMorph.prototype.rawOpenCloudDataString=function(a,b){StageMorph.prototype.hiddenPrimitives={};StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=!1;StageMorph.prototype.enableInheritance=!1;StageMorph.prototype.enableSublistIDs=!1;Process.prototype.enableLiveCoding=!1;SnapActions.disableCollaboration();SnapUndo.reset();if(Process.prototype.isCatchingErrors)try{a=b?a:this.serializer.parse(a);this.serializer.loadMediaModel(a.childNamed("media"));
var c=this.serializer.openProject(this.serializer.loadProjectModel(a.childNamed("project"),this),this)}catch(d){this.showMessage("Load failed: "+d)}else a=b?a:this.serializer.parse(a),this.serializer.loadMediaModel(a.childNamed("media")),c=this.serializer.openProject(this.serializer.loadProjectModel(a.childNamed("project"),this),this);this.stopFastTracking();return c};
NetsBloxMorph.prototype.createSpriteBar=function(){NetsBloxMorph.uber.createSpriteBar.call(this);var a=this,b=this.spriteBar.tabBar,c=this.tabColors,d=["Scripts","Costumes","Backgrounds","Sounds"];b.children.sort(function(f,g){f=d.indexOf(f.labelString);g=d.indexOf(g.labelString);f=-1===f?Infinity:f;g=-1===g?Infinity:g;return f<g?-1:1});var e=new TabMorph(c,null,function(){SnapActions.selectTab("room");b.tabTo("room")},localize("Room"),function(){return"room"===a.currentTab});e.padding=3;e.corner=
15;e.edge=1;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=this.buttonLabelColor;e.rerender();e.fixLayout();b.add(e);b.fixLayout();b.children.forEach(function(f){f.refresh()})};
NetsBloxMorph.prototype.projectMenu=function(){var a=this,b=NetsBloxMorph.uber.projectMenu.call(this),c=16===this.world().currentKey;c&&(b.items.splice(10,0,[localize("Export role..."),function(){a.projectName?a.exportRole(a.projectName,c):a.prompt("Export Project As...",function(f){a.exportRole(f,!1,!0)},null,"exportRole")},'save "'+a.projectName+'" as XML\nto your downloads folder',new Color(100,0,0)]),b.items.splice(10,0,[localize("Export to Snap! project..."),function(){var f=a.getSnapXml(),g=
1===this.room.getRoleCount()?this.room.name:this.projectName;a.saveXMLAs(f,g);a.showMessage("Exported!",1)},'export "'+a.projectName+'" as Snap!-compatible XML',new Color(100,0,0)]));this.stage.deletableMessageNames().length&&!this.stage.globalBlocks.length&&b.items.splice(10,0,["Export blocks/msgs...","exportGlobalBlocks","show global custom block definitions/message types as XML\nin a new browser window"]);var d=-1<this.source.indexOf("cloud");if(SnapCloud.username&&!this.room.isOwner()){d=["Save a Copy",
"saveACopy"];var e=b.items.map(function(f){return f[1]}).indexOf("save");b.items.splice(e+2,0,d)}else d&&this.room.hasMultipleRoles()&&(b.items.find(function(f){return"save"===f[1]})[0]=localize("Save Role"));a.room.isGuest()&&(d=b.items.map(function(f){return f[1]}).indexOf("save"),b.items.splice(d,2));d=["Services...",function(){var f=a.serviceURL("servicelibs","SERVICELIBS");f=this.getMediaListFromURL(f);var g=localize("Import")+" "+localize("Service"),h=new MenuMorph(a,g);f.forEach(function(k){h.addItem(k.name,
function(){var l=a.serviceURL("servicelibs",k.fileName);a.droppedText(a.getURL(l),name)},k.help)});h.popup(a.world(),a.controlBar.projectButton.bottomLeft())},"Select services to include in this project."];b.items.splice(b.items.length-2,0,d);return b};NetsBloxMorph.prototype.serviceURL=function(){var a=Array.prototype.slice.call(arguments,0);return Services.defaultHost.url+"/"+a.join("/")};NetsBloxMorph.prototype.exportRole=NetsBloxMorph.prototype.exportProject;
NetsBloxMorph.prototype.exportProject=function(){this.showMessage("Exporting...",3);1===this.room.getRoleCount()?this.exportSingleRoleXml():this.exportMultiRoleXml()};NetsBloxMorph.prototype.exportMultiRoleXml=function(){var a=this,b;return $jscomp.asyncExecutePromiseGeneratorProgram(function(c){if(1==c.nextAddress)return c.yield(a.cloud.exportProject(),2);b=c.yieldResult;a.exportRoom(b);c.jumpToEnd()})};
NetsBloxMorph.prototype.getSnapXml=function(){var a=SnapSerializer.prototype.isSavingHistory;1<this.room.getRoleCount()&&this.inform("Multiple Roles Detected","As a Snap! project is equivalent to a role in NetsBlox,\nwe can only export a single role to a Snap! project at\na time.\n\nTo migrate the remaining roles, please export\nthem all individually.",this.world());var b=detect(this.stage.children,function(e){return e instanceof WatcherMorph&&"reportRPCError"===e.getter});if(b){var c=this.stage.children.indexOf(b);
this.stage.children.splice(c,1)}SnapSerializer.prototype.isSavingHistory=!1;var d=this.serializer.serialize(this.stage);SnapSerializer.prototype.isSavingHistory=a;b&&this.stage.children.splice(c,0,b);return d};NetsBloxMorph.prototype.getSerializedRole=function(){var a=this.sockets.getSerializedProject();return this.serializer.format('<role name="@">%</role>',this.room.getCurrentRoleName(),a.SourceCode+a.Media)};
NetsBloxMorph.prototype.exportSingleRoleXml=function(){try{var a=this.serializer.format('<room name="@" app="@">%</room>',this.room.name,this.serializer.app,this.getSerializedRole());this.exportRoom(a)}catch(b){if(Process.prototype.isCatchingErrors)this.showMessage("Export failed: "+b);else throw b;}};
NetsBloxMorph.prototype.exportRoom=function(a){var b=this.room.name;try{this.saveXMLAs(a,b),this.showMessage("Exported!",1)}catch(c){if(Process.prototype.isCatchingErrors)this.showMessage("Export failed: "+c);else throw c;}};
NetsBloxMorph.prototype.openRoomString=function(a){var b=this,c,d,e,f,g,h,k,l,m;return $jscomp.asyncExecutePromiseGeneratorProgram(function(n){if(1==n.nextAddress){c=b.serializer.parse(a);if(0===c.children.length)return b.showMessage("Malformed project - No roles found."),n.return();d=c.children.map(function(q){return{ProjectName:q.attributes.name,SourceCode:(q.children[0]||"").toString(),Media:(q.children[1]||"").toString()}});e=c.children[0].attributes.name;f=b.showMessage("Opening project...");
g=c.attributes;h=g.name;return n.yield(SnapCloud.importProject(h,e,d),2)}if(3!=n.nextAddress)return k=n.yieldResult,b.room.onRoomStateUpdate(k),l=$jscomp.makeIterator(c.children),m=l.next().value,n.yield(b.openRoleString(m,!0),3);f.destroy();b.sockets.updateRoomInfo();n.jumpToEnd()})};NetsBloxMorph.prototype.openCloudDataString=function(a,b){var c=this;return IDE_Morph.prototype.openCloudDataString.call(this,b?a.toString():a).then(function(){c.sockets.updateRoomInfo()})};
NetsBloxMorph.prototype.rawSaveProject=function(a){var b=this,c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){if(1==d.nextAddress)return b.showMessage("Saving",3),a&&(b.room.name=a),d.yield(b.cloud.exportProject(),2);c=d.yieldResult;b.saveRoomLocal(c);d.jumpToEnd()})};NetsBloxMorph.prototype.getProjectXML=function(){var a=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(b){return 1==b.nextAddress?b.yield(a.cloud.exportProject(),2):b.return(b.yieldResult)})};
NetsBloxMorph.prototype.saveRoomLocal=function(a){var b=this.room.name;if(Process.prototype.isCatchingErrors)try{localStorage["-snap-project-"+b]=a,this.setURL("#open:"+a),this.showMessage("Saved to the browser.",1)}catch(c){this.showMessage("Save failed: "+c)}else localStorage["-snap-project-"+b]=a,this.setURL("#open:"+a),this.showMessage("Saved to the browser.",1)};
NetsBloxMorph.prototype.openProject=function(a){a&&(this.showMessage("opening project\n"+a),a=localStorage["-snap-project-"+a],this.openRoomString(a),this.setURL("#open:"+a))};NetsBloxMorph.prototype.saveACopy=function(){var a=this;if(this.isPreviousVersion())return this.showMessage("Please exit replay mode before saving");SnapCloud.saveProjectCopy(function(b){b.name&&a.room.silentSetRoomName(b.name);a.showMessage("Made your own copy and saved it to the cloud!",2)},this.cloudError())};
NetsBloxMorph.prototype.cloudSaveError=function(){var a=this;return function(b,c){a.shield&&(a.shield.destroy(),a.shield=null);50<b.length&&(b=b.substring(0,50)+"...");(new DialogBoxMorph).inform("NetsBlox Cloud",(c?c+"\n":"")+b,a.world(),a.cloudIcon(null,new Color(180,0,0)));a.showMessage("Unable to save. Please export project if the problem persists.")}};
NetsBloxMorph.prototype.saveProjectToCloud=function(a){var b=this;if(SnapCloud.username!==this.room.ownerId)return IDE_Morph.prototype.saveProjectToCloud.call(b,a);var c=function(d){var e=b.room.hasMultipleRoles()?b.room.getCurrentRoleName():b.room.name;a&&(b.showMessage("Saving "+e+"\nto the cloud..."),SnapCloud.saveProject(b,function(f){f.name&&b.room.silentSetRoomName(f.name);d?b.showMessage("Saved "+e+" to cloud!",2):b.showMessage("Saved as "+b.room.name,2)},b.cloudSaveError(),d,a))};SnapCloud.hasConflictingStoredProject(a,
function(d){if(d){var e=new DialogBoxMorph(null,function(){c(!0)});e.cancel=function(){c();e.destroy()};e.askYesNo(localize("Overwrite Existing Project"),localize("A project with the given name already exists.\nWould you like to overwrite it?"),b.world())}else return b.updateUrlQueryString(),IDE_Morph.prototype.saveProjectToCloud.call(b,a)},this.cloudSaveError())};
NetsBloxMorph.prototype.droppedText=function(a,b){if(a.startsWith("<rpc"))return this.openBlocksMsgTypeString(a);if(a.startsWith("<room"))return location.hash="",this.openRoomString(a);if(a.startsWith("<role"))return this.openRoleString(a);if(a.startsWith("<project")){this.exitReplayMode();var c=this,d=this.showMessage("Opening role..."),e=a.split('app="')[1].split(" ")[0];return SnapActions.openProject(a).then(function(f){f=f.name;e===c.serializer.appName&&1<c.room.getRoleCount()?c.room.setRoleName(f):
c.room.setRoomName(f);d.destroy();c.sockets.updateRoomInfo()})}return IDE_Morph.prototype.droppedText.apply(this,arguments)};NetsBloxMorph.prototype.openBlocksMsgTypeString=function(a){var b,c=this;this.nextSteps([function(){b=c.showMessage("Opening...")},function(){nop()},function(){if(Process.prototype.isCatchingErrors)try{c.rawOpenBlocksMsgTypeString(a)}catch(d){c.showMessage("Load failed: "+d)}else c.rawOpenBlocksMsgTypeString(a)},function(){b.destroy()}])};
NetsBloxMorph.prototype.rawOpenBlocksMsgTypeString=function(a){var b=this.serializer.parse(a);a=b.childNamed("messageTypes");b=b.childNamed("blocks").toString();a&&(a=a.children,a.forEach(this.serializer.loadMessageType.bind(this,this.stage)));this.rawOpenBlocksString(b,"",!0)};
NetsBloxMorph.prototype.rawLoadCloudProject=function(a,b){var c=this,d=a.RoomName,e=a.ProjectName,f=a.ProjectID;this.source="cloud";a.Owner=a.Owner||SnapCloud.username;this.updateUrlQueryString(d,b);var g=this.showMessage("Opening project...");return SnapActions.openProject(a.SourceCode).then(function(){SnapCloud.projectId=f;c.room.silentSetRoomName(d);c.room.ownerId=a.Owner;c.silentSetProjectName(e);c.sockets.updateRoomInfo();g.destroy()})};
NetsBloxMorph.prototype.updateUrlQueryString=function(a,b,c){var d=location.href.replace(/^.*\?/,"").replace("#"+location.hash,"");d=this.cloud.parseDict(d);var e=location.pathname+"?";a=a||this.room.name;c?e+="action=example&ProjectName="+encodeURIComponent(a)+"&":b&&(e+="action=present&Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(a)+"&");d.extensions&&(e+="extensions="+d.extensions);window.history.pushState(a,a,e)};
NetsBloxMorph.prototype.aboutNetsBlox=function(){var a=this.world();var b="NetsBlox v"+NetsBloxSerializer.prototype.app.split(",")[0].replace(/NetsBlox /,"")+"\n\nNetsBlox is developed by Vanderbilt University with support\n          from the National Science Foundation (NSF)\n\nNetsBlox extends Snap!, from the University of California, Berkeley and \nis influenced and inspired by Scratch, from the Lifelong Kindergarten\ngroup at the MIT Media Lab\n\nfor more information see https://netsblox.org,\nhttp://snap.berkeley.edu and http://scratch.mit.edu";
(new DialogBoxMorph).inform("About NetsBlox",b,a)};
NetsBloxMorph.prototype.reportBug=function(){var a=(new DialogBoxMorph).withKey("bugReport"),b=new ScrollFrameMorph,c=new TextMorph(""),d=a.ok,e=this,f=this.world();b.padding=6;b.setWidth(250);b.acceptsDrops=!1;b.contents.acceptsDrops=!1;c.setWidth(250-2*b.padding);c.setPosition(b.topLeft().add(b.padding));c.enableSelecting();c.isEditable=!0;b.setHeight(250);b.fixLayout=nop;b.edge=InputFieldMorph.prototype.edge;b.fontSize=InputFieldMorph.prototype.fontSize;b.typeInPadding=InputFieldMorph.prototype.typeInPadding;
b.contrast=InputFieldMorph.prototype.contrast;b.render=InputFieldMorph.prototype.render;b.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;b.addContents(c);c.rerender();a.ok=function(){e.submitBugReport(c.text);d.call(this)};a.justDropped=function(){c.edit()};a.labelString=localize("What went wrong?");a.createLabel();a.addBody(b);a.addButton("ok","OK");a.addButton("cancel","Cancel");a.fixLayout();a.popUp(f);a.setCenter(f.center());c.edit()};
NetsBloxMorph.prototype.submitBugReport=function(a,b){var c=this,d=this.world().worldCanvas,e=!!b,f={};var g=NetsBloxSerializer.prototype.app.replace("NetsBlox ","").replace(/,.*$/,"");f.description=a;f.timestamp=new Date;f.userAgent=navigator.userAgent;f.version=g;f.clientUuid=this.sockets.uuid;try{f.screenshot=d.toDataURL("image/png")}catch(l){console.warn("Unable to capture screenshot for bug report",l)}f.project=this.serializer.serialize(this.stage);f.undoState=SnapUndo;f.user=SnapCloud.username;
f.isAutoReport=!!b;f.isAutoReport&&(a=SnapActions.currentEvent,f.description=["## Auto-report\nError:",b.stack,"---\nFailing Event:",JSON.stringify(a,null,2)].join("\n"),f.error=b,f.event=a);var h=new XMLHttpRequest,k=SnapCloud.url+"/BugReport";h.open("post",k);h.setRequestHeader("Content-Type","application/json; charset=UTF-8");h.onreadystatechange=function(){4!==h.readyState||e||(199<h.status&&400>h.status?c.showMessage(localize("Bug has been reported!"),2):c.cloudError()(k,localize("bug could not be reported:")+
h.responseText))};h.send(JSON.stringify(f))};NetsBloxMorph.prototype.showBugReportScreenshot=function(a){var b=this,c=new Image;c.onload=function(){var d=b.extent().divideBy(1.5);d=Math.min(d.x/c.width,d.y/c.height);d=(new Point(c.width,c.height)).multiplyBy(d);var e=newCanvas(d);e.getContext("2d").drawImage(c,0,0,c.width,c.height,0,0,d.x,d.y);(new DialogBoxMorph).inform("Screenshot",null,b.world(),e)};c.src=a.screenshot};
NetsBloxMorph.prototype.loadBugReport=function(){var a=this,b=document.createElement("input");a.filePicker&&(document.body.removeChild(a.filePicker),a.filePicker=null);b.type="file";b.style.color="transparent";b.style.backgroundColor="transparent";b.style.border="none";b.style.outline="none";b.style.position="absolute";b.style.top="0px";b.style.left="0px";b.style.width="0px";b.style.height="0px";b.addEventListener("change",function(){var c=new FileReader;document.body.removeChild(b);a.filePicker=
null;c.onloadend=function(d){var e=JSON.parse(d.target.result),f=e.undoState.allEvents,g=new DialogBoxMorph(null,nop);d={"Show Screenshot":function(){a.showBugReportScreenshot(e)},"Replay All Events":function(){f.push(e.event);a.replayEvents(f);g.destroy()},"Replay Some Events":function(){var k=new Point(0,f.length);(new DialogBoxMorph(a,function(l){a.replayEvents(f.slice(l.x,l.y))},a)).promptVector("Which events?",k,k,"Start (inclusive)","End (exclusive)",this.world(),null,null);g.destroy()},"Load Project":function(){a.droppedText(e.project);
setTimeout(function(){for(var k=Object.keys(e.undoState),l=k.length;l--;)SnapUndo[k[l]]=e.undoState[k[l]];a.confirm("Would you like to apply the failing event?","Apply Failing Event?",function(){SnapActions.applyEvent(e.event)});a.showMessage("Loaded bug report!")},100);g.destroy()}};var h=new Date(e.timestamp);h=["User: "+e.user,"Date: "+h.toDateString()+" "+h.toLocaleTimeString(),"Version: "+e.version,"Browser: "+e.userAgent,"Event Count: "+f.length,"Description:\n\n"+e.description].join("\n");
d.Cancel="cancel";g.ask(localize("Bug Report"),h,a.world(),d)};c.readAsText(b.files[0])},!1);document.body.appendChild(b);a.filePicker=b;b.click()};
NetsBloxMorph.prototype.manageCollaborators=function(){var a=this,b=this.room.ownerId,c=this.room.name;SnapCloud.getCollaboratorList(function(d){d.sort(function(e,f){return e.username.toLowerCase()<f.username.toLowerCase()?-1:1});(new CollaboratorDialogMorph(a,function(e){e&&SnapCloud.inviteToCollaborate(SnapCloud.clientId,e.username,b,c)},d,"Invite a Collaborator to the Project")).popUp()},function(d,e){a.cloudError().call(null,d,e)})};
NetsBloxMorph.prototype.promptCollabInvite=function(a){var b=this,c=a.roomName,d=!1;SnapActions.isCollaborating()||(SnapActions.enableCollaboration(),d=!0);c=a.inviter===SnapCloud.username?'Would you like to collaborate at "'+c+'"?':a.inviter+' has invited you to collaborate with\nhim/her at "'+c+'"\nAccept?';var e=new DialogBoxMorph(null,function(){b.collabResponse(a,!0);e.destroy()});e.cancel=function(){b.collabResponse(a,!1);d&&SnapActions.disableCollaboration();e.destroy()};e.askYesNo("Collaboration Invitation",
localize(c),this.world())};NetsBloxMorph.prototype.collabResponse=function(a,b){var c=this;SnapCloud.collabResponse(a.id,b,function(){if(b){var d=new DialogBoxMorph(null,function(){SnapCloud.reconnect(function(){SnapCloud.joinActiveProject(a.projectId,function(e){c.rawLoadCloudProject(e)},c.cloudError())},c.cloudError());d.destroy()});d.askYesNo(localize("Open Shared Project?"),localize("Would you like to open the shared project now?"),c.world())}},function(d){c.showMessage(d,2)})};
NetsBloxMorph.prototype.logout=function(){var a=this;delete localStorage["-snap-user"];SnapCloud.logout(function(){Services.reset();SnapCloud.clear();a.controlBar.cloudButton.refresh();a.showMessage("disconnected.",2);a.newProject()},function(){SnapCloud.clear();a.controlBar.cloudButton.refresh();a.showMessage("disconnected.",2);a.newProject()})};
NetsBloxMorph.prototype.createCloudAccount=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(c){SnapCloud.signup(c.username,c.email,function(d,e){(new DialogBoxMorph).inform(e,d+".\n\nAn e-mail with your password\nhas been sent to the address provided",b,a.cloudIcon(null,new Color(0,180,0)))},a.cloudError())})).withKey("cloudsignup").promptCredentials("Sign up","signup","/tos.html","Terms of Service...","/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",
b,a.cloudIcon(),a.cloudMsg)};NetsBloxMorph.prototype.simpleNotification=function(a,b){a=localize(a);a=new MenuMorph(null,a);var c=this.world();a.fixLayout();a.mouseClickLeft=b?nop:a.destroy;b=this.spriteBar.center().subtract(new Point(a.width()/2,a.height()/2));a.popup(c,b)};
NetsBloxMorph.prototype.findBlocks=function(a){a=a||{};var b=this.stage.children.filter(function(g){return g instanceof SpriteMorph});b.push(this.stage);for(var c=function(g,h){g.upperLevel=h;return g},d=b.map(function(g){return g.scripts}).map(function(g,h){return g.children.map(function(k){return c(k,b[h])})}).reduce(function(g,h){return g.concat(h)}),e=[];0!==d.length;){var f=d.shift();SnapActions.traverse(f,function(g){if(g.definition){g!==f&&c(g,f);var h=g.definition.scriptsModel();h=h.children[0];
1<h.children.length&&(h=h.children[1],c(h,g),d.push(h))}var k=!1;a.selectors&&a.selectors.includes(g.selector)?k=!0:a.specs&&a.specs.forEach(function(l){try{g.blockSpec&&-1!==g.blockSpec.toLowerCase().indexOf(l)&&(k=!0)}catch(m){console.error("error when searching for blocks",m)}});k&&(g!==f&&c(g,f),e.push(g))})}return e};
NetsBloxMorph.prototype.blockAddress=function(a){for(var b=[],c=function(d){return void 0!==d.name&&d instanceof SpriteMorph?""===d.name?"S: Sprite":"S: "+d.name:void 0!==d.name?d.name:"evaluateCustomBlock"===d.selector?"CB: ["+(d.blockSpec.replace(/%/g,"")+"]"):"["+d.blockSpec.replace(/%/g,"")+"]"};a.upperLevel;)a=a.upperLevel,b.unshift(c(a));return b};
NetsBloxMorph.prototype.showUpdateNotification=function(){this.simpleNotification("Newer Version of NetsBlox Available: Please Save and Refresh",!0)};NetsBloxMorph.prototype.showBrowserNotification=function(){this.simpleNotification("It seems you're using an unsupported browser. \n Use an up-to-date Chrome browser for the best experience.")};
NetsBloxMorph.prototype.linkAccount=function(){var a=this;(new DialogBoxMorph(null,function(b){var c;return $jscomp.asyncExecutePromiseGeneratorProgram(function(d){if(1==d.nextAddress)return d.setCatchFinallyBlocks(2),d.yield(a.cloud.linkAccount(b.username.toLowerCase(),b.password,"Snap!"),4);if(2!=d.nextAddress)return a.showMessage(localize("Linked account!"),2),d.leaveTryBlock(0);c=d.enterCatchBlock();a.showMessage(localize("Unable to link account:")+" "+c.message,2);d.jumpToEnd()})})).withKey("cloudlogin").promptCredentials("Sign in with Snap!",
"login",null,null,null,null,"stay signed in on this computer\nuntil logging out",this.world(),this.cloudIcon(),this.cloudMsg)};
NetsBloxMorph.prototype.unlinkAccount=function(a){var b=this,c,d,e,f;return $jscomp.asyncExecutePromiseGeneratorProgram(function(g){switch(g.nextAddress){case 1:return c=a,d=c.username,g.yield(b.confirm(localize("Are you sure you would like to unlink ")+d+"?",localize("Unlink Account?")),2);case 2:e=g.yieldResult;if(!e){g.jumpTo(0);break}g.setCatchFinallyBlocks(4);return g.yield(b.cloud.unlinkAccount(a),6);case 6:b.showMessage(localize("Unlinked ")+d,2);g.leaveTryBlock(0);break;case 4:f=g.enterCatchBlock(),
b.showMessage(localize("Unable to unlink account: ")+f.responseText,2),g.jumpToEnd()}})};NetsBloxSerializer.prototype=new SnapSerializer;NetsBloxSerializer.prototype.constructor=NetsBloxSerializer;NetsBloxSerializer.uber=SnapSerializer.prototype;SnapSerializer.prototype.isSavingHistory=!0;NetsBloxSerializer.prototype.appName="NetsBlox";NetsBloxSerializer.prototype.version="1.28.1";NetsBloxSerializer.prototype.app=NetsBloxSerializer.prototype.appName+" "+NetsBloxSerializer.prototype.version+", http://netsblox.org";
function NetsBloxSerializer(){this.init()}NetsBloxSerializer.prototype.loadMessageType=function(a,b){var c=b.childNamed("name").contents;b=b.childNamed("fields").children.map(function(d){return d.contents});a.addMessageType({name:c,fields:b})};NetsBloxSerializer.prototype.loadCustomBlock=function(a,b){"services"===a.attributes.category&&(a.attributes.category="network");return NetsBloxSerializer.uber.loadCustomBlock.call(this,a,b)};
SnapSerializer.prototype.getInitialStageSpriteIds=function(a){a=a.childNamed("stage").attributes.collabId;var b=a.split("_").slice(0,2).join("_");return[a,b]};MessageFrame.prototype.toXML=function(a){var b=this;return this.names().map(function(c){return b.getMsgType(c)}).map(function(c){return a.format("<messageType>%</messageType>",a.store(c))}).join("")};
MessageType.prototype.toXML=function(a){var b=this.fields.map(function(c){return a.format("<field>%</field>",a.escape(c))}).join("");return a.format("<name>%</name><fields>%</fields>",a.escape(this.name),b)};HintInputSlotMorph.prototype.toXML=function(a){return this.empty?a.format("<l>$</l>",""):InputSlotMorph.prototype.toXML.call(this,a)};SnapActions.addActions("addMessageType","deleteMessageType");ActionManager.URL="ws://"+SERVER_ADDRESS+"/collaboration";
ActionManager.prototype._deleteMessageType=function(a){var b=this.ide().stage.messageTypes.getMsgType(a).fields;return[a,b]};ActionManager.prototype.onAddMessageType=function(a,b){var c=this.ide();c.stage.addMessageType({name:a,fields:b});c.flushBlocksCache("network");c.refreshPalette();this.completeAction()};ActionManager.prototype.onDeleteMessageType=function(a){var b=this.ide();b.stage.deleteMessageType(a);b.flushBlocksCache("network");b.refreshPalette();this.completeAction()};
ActionManager.prototype._setField=function(a,b){var c=this.getId(a),d=a.contents().text;a instanceof HintInputSlotMorph&&a.empty&&(d="");return[c,b,d]};UndoManager.Invert.addMessageType=function(){return"deleteMessageType"};UndoManager.Invert.deleteMessageType=function(){return"addMessageType"};SnapActions.serializer=new NetsBloxSerializer;SnapActions.enableCollaboration=SnapActions.disableCollaboration=function(){};SnapActions.isCollaborating=function(){return 1<this.ide().room.getCurrentOccupants().length};
SnapActions.send=function(a){var b=this.ide().sockets;this._ws=b.websocket;a.id=a.id||this.lastSeen+1;this.isUserAction(a)||(this.lastSent=a.id);var c=this.ide().cloud;b.send(JSON.stringify({type:"user-action",projectId:c.projectId,roleId:c.roleId,action:a}))};SnapActions.onMessage=function(a){ActionManager.prototype.onMessage.apply(this,arguments);-1!==location.hash.indexOf("collaborate")&&(location.hash="");"session-user-count"===a.type&&(this.sessionUsersCount=a.value)};
SnapActions.requestMissingActions=function(a){var b=this.ide(),c=b.sockets;b=b.cloud;if(!c.inActionRequest)return c.inActionRequest=!0,c.sendJSON({type:"request-actions",projectId:b.projectId,roleId:b.roleId,actionId:this.lastSeen,silent:a})};SnapActions.onReceiveAction=function(a){var b=this.lastSeen;this.queuedActions.length&&(b=this.queuedActions[this.queuedActions.length-1].id);if(b<a.id-1)return this.requestMissingActions(!1);ActionManager.prototype.onReceiveAction.apply(this,arguments)};
SnapActions.completeAction=function(a){if(a)try{this.ide().submitBugReport(null,a)}catch(b){console.error("Unable to submit bug report:",b)}return ActionManager.prototype.completeAction.apply(this,arguments)};
SnapActions.submitIfAllowed=function(a){var b=this,c=this.ide(),d=c.room;"openProject"===a.type?this.submitAction(a):d.isCapturingTrace()?c.promptExitTraceCapture(function(){b.submitIfAllowed(a)}):d.isReplayingTrace()?c.promptExitTraceReplay(function(){b.submitIfAllowed(a)}):d.isEditable()?ActionManager.prototype.submitIfAllowed.call(this,a):c.confirm("Edits cannot be made on projects by guests.\n\nWould you like to request to be made a collaborator?","Request Collaborator Priviledges?",function(){c.sockets.sendMessage({type:"permission-elevation-request",
projectId:SnapCloud.projectId,guest:SnapCloud.username})})};SnapActions.isReadOnly=function(){var a=this.ide().room;return!(a.isEditable()&&!a.isCapturingTrace()&&!a.isReplayingTrace()&&!this.ide().isReplayMode)};
